<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت پلن‌های فروشندگان خدماتی</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            color-scheme: light;
            --bg: #f5f7fb;
            --surface: rgba(255, 255, 255, 0.88);
            --surface-strong: rgba(255, 255, 255, 0.96);
            --text-strong: #1f2433;
            --text-muted: #5d6470;
            --primary: #3d73ff;
            --primary-strong: #1a3e9a;
            --success: #37b26c;
            --danger: #f25764;
            --warning: #ffb547;
            --border: rgba(102, 112, 140, 0.14);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #e7eeff 0%, #f5f7fb 40%, #ffffff 100%);
            font-family: "Vazirmatn", "Segoe UI", sans-serif;
            color: var(--text-strong);
            display: flex;
            flex-direction: column;
        }

        header {
            backdrop-filter: blur(16px);
            background: var(--surface-strong);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px clamp(16px, 4vw, 40px);
            gap: 20px;
        }

        .topbar-title {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .topbar-title h1 {
            margin: 0;
            font-size: clamp(22px, 2.6vw, 30px);
            font-weight: 700;
            color: var(--primary-strong);
        }

        .topbar-title p {
            margin: 0;
            color: var(--text-muted);
            font-size: 14px;
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            border: none;
            border-radius: 12px;
            font-weight: 600;
            padding: 12px 18px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-strong));
            color: #fff;
            box-shadow: 0 16px 30px rgba(61, 115, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(61, 115, 255, 0.12);
            color: var(--primary-strong);
        }

        .btn-tertiary {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-strong);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(26, 62, 154, 0.18);
        }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.2fr);
            gap: 24px;
            padding: 24px clamp(16px, 4vw, 40px) 40px;
        }

        .content-card {
            background: var(--surface);
            border-radius: 22px;
            padding: clamp(20px, 2.5vw, 28px);
            box-shadow: 0 30px 60px rgba(18, 38, 63, 0.1);
            border: 1px solid var(--border);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .content-card h2 {
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .content-card h2 span {
            font-size: 13px;
            background: rgba(61, 115, 255, 0.12);
            color: var(--primary-strong);
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 600;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .metric-item {
            background: var(--surface-strong);
            border-radius: 18px;
            padding: 16px;
            border: 1px solid rgba(61, 115, 255, 0.16);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-muted);
        }

        .metric-value {
            font-size: 22px;
            font-weight: 700;
        }

        .metric-trend {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .metric-trend.success {
            color: var(--success);
        }

        .metric-trend.danger {
            color: var(--danger);
        }

        .table-wrapper {
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-strong);
        }

        thead {
            background: rgba(61, 115, 255, 0.08);
        }

        th, td {
            text-align: right;
            padding: 14px 16px;
            font-size: 14px;
            border-bottom: 1px solid rgba(112, 128, 176, 0.12);
        }

        tbody tr:hover {
            background: rgba(61, 115, 255, 0.05);
        }

        .status-chip {
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-chip.active {
            background: rgba(55, 178, 108, 0.16);
            color: var(--success);
        }

        .status-chip.inactive {
            background: rgba(242, 87, 100, 0.14);
            color: var(--danger);
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            background: rgba(61, 115, 255, 0.12);
            color: var(--primary-strong);
            border-radius: 10px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .table-actions button {
            border: none;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .table-actions button:hover {
            transform: translateY(-2px);
        }

        .btn-ghost {
            background: rgba(61, 115, 255, 0.12);
            color: var(--primary-strong);
        }

        .btn-outline-danger {
            background: rgba(242, 87, 100, 0.12);
            color: var(--danger);
        }

        form {
            display: grid;
            gap: 18px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px 20px;
        }

        label {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
        }

        input, textarea, select {
            border-radius: 12px;
            border: 1px solid rgba(112, 128, 176, 0.22);
            padding: 12px 14px;
            font-family: inherit;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: rgba(61, 115, 255, 0.6);
            box-shadow: 0 0 0 4px rgba(61, 115, 255, 0.12);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .section-divider {
            border: none;
            border-top: 1px dashed rgba(112, 128, 176, 0.18);
            margin: 0;
        }

        .audit-log {
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-height: 320px;
            overflow: hidden;
        }

        .audit-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 14px;
            align-items: start;
            padding: 12px 0;
            border-bottom: 1px solid rgba(112, 128, 176, 0.12);
        }

        .audit-item:last-child {
            border-bottom: none;
        }

        .audit-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(61, 115, 255, 0.12);
            color: var(--primary-strong);
            font-size: 18px;
        }

        .audit-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .audit-content strong {
            font-size: 14px;
        }

        .audit-content span {
            font-size: 12px;
            color: var(--text-muted);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.38);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 200;
        }

        .modal {
            background: var(--surface-strong);
            border-radius: 24px;
            width: min(720px, 100%);
            max-height: calc(100vh - 80px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 40px 80px rgba(15, 23, 42, 0.35);
            border: 1px solid rgba(61, 115, 255, 0.18);
        }

        .modal header {
            position: relative;
            background: transparent;
            border-bottom: 1px solid rgba(112, 128, 176, 0.12);
        }

        .modal main {
            padding: 0;
        }

        .modal-content {
            padding: 24px;
            overflow-y: auto;
        }

        .modal footer {
            padding: 18px 24px;
            border-top: 1px solid rgba(112, 128, 176, 0.12);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: rgba(249, 250, 255, 0.8);
        }

        .empty-placeholder {
            border-radius: 16px;
            padding: 28px;
            background: rgba(61, 115, 255, 0.08);
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
        }

        .plan-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .preview-item {
            background: rgba(61, 115, 255, 0.08);
            border-radius: 14px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .preview-label {
            font-size: 12px;
            color: var(--primary-strong);
        }

        .preview-value {
            font-size: 14px;
            font-weight: 600;
        }

        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .chip {
            background: rgba(26, 62, 154, 0.1);
            color: var(--primary-strong);
            border-radius: 12px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .plan-status-toggle {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(112, 128, 176, 0.3);
            border-radius: 999px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .switch::after {
            content: "";
            position: absolute;
            inset: 3px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 3px 8px rgba(15, 23, 42, 0.2);
            transition: transform 0.2s ease;
        }

        .switch[data-active="true"] {
            background: rgba(55, 178, 108, 0.45);
        }

        .switch[data-active="true"]::after {
            transform: translateX(-24px);
        }

        [dir="rtl"] .switch::after {
            transform: translateX(0);
        }

        [dir="rtl"] .switch[data-active="true"]::after {
            transform: translateX(24px);
        }

        @media (max-width: 1024px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 720px) {
            .topbar {
                flex-direction: column;
                align-items: flex-start;
            }

            .topbar-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 540px) {
            .table-actions {
                flex-wrap: wrap;
            }

            th, td {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="topbar">
        <div class="topbar-title">
            <h1>مرکز کنترل پلن‌های فروشندگان</h1>
            <p>نظارت، بروزرسانی و مدیریت کامل پلن‌های اشتراکی فروشندگان خدماتی</p>
        </div>
        <div class="topbar-actions">
            <button class="btn btn-secondary" id="refreshDashboard" type="button">
                <i class="ri-refresh-line"></i>
                همگام‌سازی با بک‌اند
            </button>
            <button class="btn btn-primary" id="openPlanModal" type="button">
                <i class="ri-add-line"></i>
                ایجاد پلن جدید
            </button>
        </div>
    </div>
</header>
<main>
    <section class="content-card" aria-labelledby="plansOverviewHeading">
        <div>
            <h2 id="plansOverviewHeading">
                <i class="ri-dashboard-2-line"></i>
                داشبورد پلن‌ها
                <span>اطلاعات لحظه‌ای</span>
            </h2>
        </div>
        <div class="metrics-grid" id="plansMetrics">
            <article class="metric-item">
                <span class="metric-label">تعداد کل پلن‌های فعال</span>
                <strong class="metric-value" data-metric="activePlans">۰</strong>
                <span class="metric-trend success" data-metric="activeTrend">
                    <i class="ri-arrow-up-line"></i>
                    +۰٪ نسبت به ماه قبل
                </span>
            </article>
            <article class="metric-item">
                <span class="metric-label">میانگین قیمت پلن‌ها</span>
                <strong class="metric-value" data-metric="avgPrice">۰ تومان</strong>
                <span class="metric-trend" data-metric="avgPriceTrend">—</span>
            </article>
            <article class="metric-item">
                <span class="metric-label">میانگین مدت زمان اشتراک</span>
                <strong class="metric-value" data-metric="avgDuration">۰ روز</strong>
                <span class="metric-trend" data-metric="avgDurationTrend">—</span>
            </article>
            <article class="metric-item">
                <span class="metric-label">پلن‌های نیازمند بازبینی</span>
                <strong class="metric-value" data-metric="reviewCount">۰</strong>
                <span class="metric-trend danger" data-metric="reviewTrend">
                    <i class="ri-alert-line"></i>
                    اقدام فوری مورد نیاز
                </span>
            </article>
        </div>
        <div class="table-wrapper" role="region" aria-label="جدول پلن‌ها">
            <table>
                <thead>
                    <tr>
                        <th>عنوان پلن</th>
                        <th>قیمت (تومان)</th>
                        <th>مدت زمان</th>
                        <th>برچسب‌ها</th>
                        <th>وضعیت</th>
                        <th>اقدامات</th>
                    </tr>
                </thead>
                <tbody id="plansTableBody" data-empty="true">
                    <tr>
                        <td colspan="6">
                            <div class="empty-placeholder">
                                هنوز هیچ پلنی ثبت نشده است. از گزینه «ایجاد پلن جدید» استفاده کنید یا اطلاعات را همگام‌سازی نمایید.
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
    <section class="content-card" aria-labelledby="planDetailsHeading">
        <div>
            <h2 id="planDetailsHeading">
                <i class="ri-edit-box-line"></i>
                تنظیمات پلن انتخابی
                <span>قابل اتصال به بک‌اند</span>
            </h2>
        </div>
        <form id="planForm">
            <input type="hidden" name="planId" id="planId">
            <div class="form-grid">
                <label>
                    عنوان پلن
                    <input type="text" name="title" id="planTitle" placeholder="مثلاً پلن حرفه‌ای" required>
                </label>
                <label>
                    اسلاگ پلن
                    <input type="text" name="slug" id="planSlug" placeholder="professional" required>
                </label>
                <label>
                    قیمت (تومان)
                    <input type="number" name="price" id="planPrice" min="0" step="1000" placeholder="1500000" required>
                </label>
                <label>
                    مدت زمان اشتراک (روز)
                    <input type="number" name="duration" id="planDuration" min="1" step="1" placeholder="30" required>
                </label>
                <label>
                    وضعیت نمایش
                    <select name="status" id="planStatus">
                        <option value="active">فعال</option>
                        <option value="inactive">غیرفعال</option>
                        <option value="draft">پیش‌نویس</option>
                    </select>
                </label>
                <label>
                    دسته‌بندی پلن
                    <input type="text" name="category" id="planCategory" placeholder="پلن ویژه خدمات">
                </label>
            </div>
            <label>
                برچسب‌ها (با «,» جدا کنید)
                <input type="text" name="tags" id="planTags" placeholder="ویژه, تخفیف, محبوب">
            </label>
            <label>
                ویژگی‌ها و امکانات پلن
                <textarea name="features" id="planFeatures" placeholder="هر خط یک ویژگی جدید"></textarea>
            </label>
            <label>
                توضیحات کامل پلن
                <textarea name="description" id="planDescription" placeholder="تشریح ارزش‌ها و مزایای پلن برای فروشنده"></textarea>
            </label>
            <div class="section-divider"></div>
            <div class="plan-preview" aria-live="polite" id="planPreview">
                <div class="preview-item">
                    <span class="preview-label">عنوان پلن</span>
                    <span class="preview-value" data-preview="title">—</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">قیمت پلن</span>
                    <span class="preview-value" data-preview="price">—</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">مدت اشتراک</span>
                    <span class="preview-value" data-preview="duration">—</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">برچسب‌ها</span>
                    <span class="preview-value" data-preview="tags">—</span>
                </div>
            </div>
            <div class="form-footer">
                <button class="btn btn-tertiary" type="reset" id="resetForm">
                    <i class="ri-refresh-line"></i>
                    بازنشانی فرم
                </button>
                <button class="btn btn-primary" type="submit">
                    <i class="ri-save-3-line"></i>
                    ذخیره‌سازی در دیتابیس
                </button>
            </div>
        </form>
        <div class="section-divider"></div>
        <div>
            <h3 style="margin: 0 0 12px; font-size: 16px;">گزارش اقدامات اخیر</h3>
            <div class="audit-log" id="auditLog">
                <div class="audit-item">
                    <div class="audit-icon"><i class="ri-upload-cloud-2-line"></i></div>
                    <div class="audit-content">
                        <strong>اتصال موفق به سرویس پلن‌ها</strong>
                        <span>با API داخلی هماهنگ شده و داده‌ها در انتظار بارگذاری هستند.</span>
                    </div>
                </div>
                <div class="audit-item">
                    <div class="audit-icon"><i class="ri-shield-check-line"></i></div>
                    <div class="audit-content">
                        <strong>بررسی امنیتی تکمیل شد</strong>
                        <span>تمامی تغییرات فرم برای اعتبارسنجی بک‌اند آماده هستند.</span>
                    </div>
                </div>
                <div class="audit-item">
                    <div class="audit-icon"><i class="ri-timer-line"></i></div>
                    <div class="audit-content">
                        <strong>آخرین بروزرسانی</strong>
                        <span>چند لحظه پیش توسط مدیر سیستم</span>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
<div class="modal-backdrop" id="planModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
        <header>
            <div class="topbar" style="padding: 18px 24px;">
                <div class="topbar-title">
                    <h1 style="font-size: 20px; margin: 0;">پلن جدید فروشنده</h1>
                    <p style="font-size: 13px;">اطلاعات دقیق پلن را وارد کنید تا برای ثبت در دیتابیس آماده شود.</p>
                </div>
                <button class="btn btn-tertiary" type="button" id="closePlanModal">
                    <i class="ri-close-line"></i>
                    بستن
                </button>
            </div>
        </header>
        <main>
            <div class="modal-content">
                <form id="modalPlanForm">
                    <div class="form-grid">
                        <label>
                            عنوان پلن
                            <input type="text" name="title" placeholder="پلن ویژه" required>
                        </label>
                        <label>
                            قیمت (تومان)
                            <input type="number" name="price" min="0" step="1000" placeholder="750000" required>
                        </label>
                        <label>
                            مدت (روز)
                            <input type="number" name="duration" min="1" step="1" placeholder="30" required>
                        </label>
                        <label>
                            برچسب‌ها
                            <input type="text" name="tags" placeholder="ویژه, محبوب">
                        </label>
                    </div>
                    <label>
                        ویژگی‌ها
                        <textarea name="features" placeholder="هر خط یک ویژگی"></textarea>
                    </label>
                    <label>
                        توضیحات تکمیلی
                        <textarea name="description" placeholder="جزئیات کامل پلن"></textarea>
                    </label>
                </form>
            </div>
        </main>
        <footer>
            <button class="btn btn-tertiary" type="button" id="cancelPlanCreation">انصراف</button>
            <button class="btn btn-primary" type="submit" form="modalPlanForm">ثبت اولیه پلن</button>
        </footer>
    </div>
</div>
<script>
    const API_ENDPOINT = '/api/admin/service-plans';
    const plansTableBody = document.getElementById('plansTableBody');
    const planForm = document.getElementById('planForm');
    const modalPlanForm = document.getElementById('modalPlanForm');
    const planModal = document.getElementById('planModal');
    const refreshDashboard = document.getElementById('refreshDashboard');
    const openPlanModal = document.getElementById('openPlanModal');
    const closePlanModal = document.getElementById('closePlanModal');
    const cancelPlanCreation = document.getElementById('cancelPlanCreation');
    const planPreviewFields = document.querySelectorAll('[data-preview]');

    const state = {
        plans: [],
        selectedPlanId: null
    };

    function toggleModal(open) {
        if (open) {
            planModal.style.display = 'flex';
            planModal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        } else {
            planModal.style.display = 'none';
            planModal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
            modalPlanForm.reset();
        }
    }

    function formatPrice(value) {
        if (value === undefined || value === null || value === '') return '—';
        return new Intl.NumberFormat('fa-IR').format(Number(value)) + ' تومان';
    }

    function formatDuration(days) {
        if (!days) return '—';
        const months = (days / 30).toFixed(1);
        return `${days} روز / ${months} ماه`;
    }

    function renderPlansTable() {
        if (!state.plans.length) {
            plansTableBody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-placeholder">
                            هنوز هیچ پلنی ثبت نشده است. از گزینه «ایجاد پلن جدید» استفاده کنید یا اطلاعات را همگام‌سازی نمایید.
                        </div>
                    </td>
                </tr>
            `;
            plansTableBody.dataset.empty = 'true';
            return;
        }

        plansTableBody.dataset.empty = 'false';
        plansTableBody.innerHTML = state.plans.map((plan) => {
            const tags = Array.isArray(plan.tags) ? plan.tags : (plan.tags ? plan.tags.split(',').map(tag => tag.trim()) : []);
            return `
                <tr data-plan-id="${plan.id}">
                    <td>
                        <strong>${plan.title}</strong>
                        <div style="color: var(--text-muted); font-size: 12px;">${plan.slug || ''}</div>
                    </td>
                    <td>${formatPrice(plan.price)}</td>
                    <td>${formatDuration(plan.durationDays)}</td>
                    <td>
                        <div class="tags">
                            ${tags.length ? tags.map(tag => `<span class="tag">${tag}</span>`).join('') : '<span style="color: var(--text-muted); font-size: 12px;">بدون برچسب</span>'}
                        </div>
                    </td>
                    <td>
                        <span class="status-chip ${plan.status === 'active' ? 'active' : 'inactive'}">
                            <i class="ri-${plan.status === 'active' ? 'checkbox-circle-line' : 'pause-circle-line'}"></i>
                            ${plan.status === 'active' ? 'فعال' : 'غیرفعال'}
                        </span>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-ghost" type="button" data-action="edit" data-plan-id="${plan.id}">
                                <i class="ri-edit-line"></i>
                                ویرایش
                            </button>
                            <button class="btn-outline-danger" type="button" data-action="deactivate" data-plan-id="${plan.id}">
                                <i class="ri-power-off-line"></i>
                                غیرفعال
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function updatePreview() {
        const title = planForm.planTitle.value.trim();
        const price = planForm.planPrice.value;
        const duration = planForm.planDuration.value;
        const tags = planForm.planTags.value.trim();

        planPreviewFields.forEach((field) => {
            const type = field.dataset.preview;
            if (type === 'title') {
                field.textContent = title || '—';
            } else if (type === 'price') {
                field.textContent = price ? formatPrice(price) : '—';
            } else if (type === 'duration') {
                field.textContent = duration ? formatDuration(duration) : '—';
            } else if (type === 'tags') {
                field.textContent = tags ? tags.split(',').map(tag => tag.trim()).filter(Boolean).join('، ') : '—';
            }
        });
    }

    function fillForm(plan) {
        planForm.planId.value = plan.id || '';
        planForm.planTitle.value = plan.title || '';
        planForm.planSlug.value = plan.slug || '';
        planForm.planPrice.value = plan.price ?? '';
        planForm.planDuration.value = plan.durationDays ?? '';
        planForm.planStatus.value = plan.status || 'active';
        planForm.planCategory.value = plan.category || '';
        planForm.planTags.value = Array.isArray(plan.tags) ? plan.tags.join(', ') : (plan.tags || '');
        planForm.planFeatures.value = Array.isArray(plan.features) ? plan.features.join('\n') : (plan.features || '');
        planForm.planDescription.value = plan.description || '';
        updatePreview();
    }

    async function fetchPlans() {
        try {
            const response = await fetch(API_ENDPOINT, { credentials: 'include' });
            if (!response.ok) throw new Error('خطا در دریافت اطلاعات پلن‌ها');
            const data = await response.json();
            state.plans = Array.isArray(data) ? data : data?.plans || [];
            renderPlansTable();
            updateMetrics();
        } catch (error) {
            console.error(error);
        }
    }

    function updateMetrics() {
        const activePlans = state.plans.filter(plan => plan.status === 'active');
        const activeCount = activePlans.length;
        const avgPrice = activePlans.reduce((sum, plan) => sum + (Number(plan.price) || 0), 0) / (activeCount || 1);
        const avgDuration = activePlans.reduce((sum, plan) => sum + (Number(plan.durationDays) || 0), 0) / (activeCount || 1);

        document.querySelector('[data-metric="activePlans"]').textContent = activeCount.toLocaleString('fa-IR');
        document.querySelector('[data-metric="avgPrice"]').textContent = `${Math.round(avgPrice).toLocaleString('fa-IR')} تومان`;
        document.querySelector('[data-metric="avgDuration"]').textContent = `${Math.round(avgDuration).toLocaleString('fa-IR')} روز`;
        document.querySelector('[data-metric="reviewCount"]').textContent = state.plans.filter(plan => plan.requiresReview).length.toLocaleString('fa-IR');
    }

    async function submitPlanForm(event) {
        event.preventDefault();
        const formData = new FormData(planForm);
        const payload = Object.fromEntries(formData.entries());
        payload.price = Number(payload.price);
        payload.duration = Number(payload.duration);
        payload.tags = payload.tags ? payload.tags.split(',').map(tag => tag.trim()).filter(Boolean) : [];
        payload.features = payload.features ? payload.features.split('\n').map(line => line.trim()).filter(Boolean) : [];

        try {
            const method = payload.planId ? 'PUT' : 'POST';
            const url = payload.planId ? `${API_ENDPOINT}/${payload.planId}` : API_ENDPOINT;
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('ذخیره‌سازی پلن با خطا مواجه شد.');
            await fetchPlans();
        } catch (error) {
            console.error(error);
        }
    }

    async function submitModalForm(event) {
        event.preventDefault();
        const formData = new FormData(modalPlanForm);
        const payload = Object.fromEntries(formData.entries());
        payload.price = Number(payload.price);
        payload.duration = Number(payload.duration);
        payload.tags = payload.tags ? payload.tags.split(',').map(tag => tag.trim()).filter(Boolean) : [];
        payload.features = payload.features ? payload.features.split('\n').map(line => line.trim()).filter(Boolean) : [];

        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('ثبت اولیه پلن با خطا روبرو شد.');
            toggleModal(false);
            await fetchPlans();
        } catch (error) {
            console.error(error);
        }
    }

    plansTableBody.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const planId = button.dataset.planId;
        const plan = state.plans.find((item) => String(item.id) === String(planId));
        if (!plan) return;

        if (button.dataset.action === 'edit') {
            state.selectedPlanId = plan.id;
            fillForm(plan);
        } else if (button.dataset.action === 'deactivate') {
            fetch(`${API_ENDPOINT}/${plan.id}/deactivate`, {
                method: 'POST',
                credentials: 'include'
            }).then(fetchPlans).catch(console.error);
        }
    });

    planForm.addEventListener('input', updatePreview);
    planForm.addEventListener('reset', () => {
        state.selectedPlanId = null;
        setTimeout(updatePreview, 0);
    });
    planForm.addEventListener('submit', submitPlanForm);

    modalPlanForm.addEventListener('submit', submitModalForm);
    openPlanModal.addEventListener('click', () => toggleModal(true));
    closePlanModal.addEventListener('click', () => toggleModal(false));
    cancelPlanCreation.addEventListener('click', () => toggleModal(false));
    planModal.addEventListener('click', (event) => {
        if (event.target === planModal) {
            toggleModal(false);
        }
    });

    refreshDashboard.addEventListener('click', fetchPlans);

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && planModal.getAttribute('aria-hidden') === 'false') {
            toggleModal(false);
        }
    });

    updatePreview();
    fetchPlans();
</script>
</body>
</html>
