<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>داشبورد درآمدها | ویترینت</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
    }

    .income-dashboard {
      font-family: 'Vazirmatn', sans-serif;
      background: #ffffff;
      color: #0f172a;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.16);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
      padding: 1.6rem 1.8rem;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 1.4rem;
      min-height: 100%;
    }

    .income-dashboard::before {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(360px circle at top 12% left 16%, rgba(14, 165, 233, 0.06), transparent 60%),
        radial-gradient(320px circle at bottom 10% right 12%, rgba(16, 185, 129, 0.06), transparent 65%);
      opacity: 0.55;
      z-index: 0;
    }

    .income-dashboard * {
      position: relative;
      z-index: 1;
    }

    .income-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.9rem;
    }

    .income-header h1 {
      font-size: 1.55rem;
      margin: 0 0 0.5rem;
      font-weight: 800;
      color: #0f172a;
    }

    .income-header p {
      margin: 0;
      color: #475569;
      line-height: 1.6;
      max-width: 34rem;
    }

    .income-header-meta {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: flex-end;
    }

    .meta-item {
      background: rgba(15, 23, 42, 0.04);
      color: #1e293b;
      padding: 0.5rem 0.85rem;
      border-radius: 14px;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.88rem;
      font-weight: 500;
    }

    .meta-item i {
      font-size: 1.1rem;
      color: #10b981;
    }

    .ghost-btn,
    .primary-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: 14px;
      padding: 0.7rem 1.3rem;
      border: none;
      cursor: pointer;
      font-family: 'Vazirmatn', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .ghost-btn {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.06) 0%, rgba(15, 23, 42, 0.08) 100%);
      color: #334155;
      box-shadow:
        0 2px 4px rgba(15, 23, 42, 0.04),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(15, 23, 42, 0.1);
    }

    .ghost-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(16, 185, 129, 0.1);
      transform: translate(-50%, -50%);
      transition: width 0.4s ease, height 0.4s ease;
    }

    .ghost-btn:hover {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.1) 0%, rgba(15, 23, 42, 0.14) 100%);
      color: #0f172a;
      transform: translateY(-2px);
      box-shadow:
        0 4px 8px rgba(15, 23, 42, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .ghost-btn:hover::before {
      width: 200%;
      height: 200%;
    }

    .primary-btn {
      background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
      color: #fff;
      border: none;
      box-shadow:
        0 4px 8px rgba(16, 185, 129, 0.2),
        0 8px 16px rgba(14, 165, 233, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .primary-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
    }

    .primary-btn:hover {
      box-shadow:
        0 6px 12px rgba(16, 185, 129, 0.3),
        0 12px 24px rgba(14, 165, 233, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
      transform: translateY(-2px);
    }

    .primary-btn:hover::before {
      left: 100%;
    }

    .income-filter {
      background: rgba(255, 255, 255, 0.85);
      border-radius: 16px;
      backdrop-filter: blur(6px);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
      padding: 0.9rem 1.1rem;
    }

    #income-filter-form {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    #income-filter-form label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      color: #0f172a;
      gap: 0.4rem;
      font-size: 0.9rem;
    }

    #income-filter-form input[type="date"] {
      border: 1.5px solid rgba(15, 23, 42, 0.12);
      border-radius: 12px;
      padding: 0.55rem 0.75rem;
      font-family: inherit;
      font-size: 0.9rem;
      color: #1e293b;
      background: #fff;
      min-width: 12rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    #income-filter-form input[type="date"]:focus {
      outline: none;
      border-color: rgba(16, 185, 129, 0.55);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.12);
    }

    .income-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.1rem;
    }

    .summary-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
      border-radius: 20px;
      padding: 1.4rem 1.6rem;
      box-shadow:
        0 4px 6px rgba(15, 23, 42, 0.04),
        0 10px 20px rgba(15, 23, 42, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      border: 1px solid rgba(226, 232, 240, 0.8);
      position: relative;
      overflow: hidden;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    .summary-card:hover {
      transform: translateY(-4px);
      box-shadow:
        0 8px 12px rgba(15, 23, 42, 0.08),
        0 20px 32px rgba(15, 23, 42, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 1);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #10b981 0%, #0ea5e9 100%);
      opacity: 0;
      transition: opacity 0.35s ease;
    }

    .summary-card:hover::before {
      opacity: 1;
    }

    .summary-card::after {
      content: '';
      position: absolute;
      inset: auto auto -60px -60px;
      width: 180px;
      height: 180px;
      border-radius: 100%;
      background: radial-gradient(circle, rgba(16, 185, 129, 0.15) 0%, transparent 70%);
      opacity: 0.7;
      z-index: 0;
      transform: rotate(25deg);
      transition: all 0.5s ease;
    }

    .summary-card:hover::after {
      transform: rotate(45deg) scale(1.1);
      opacity: 1;
    }

    .summary-card[data-card="ads"]::after {
      background: radial-gradient(circle, rgba(14, 165, 233, 0.18) 0%, transparent 70%);
    }

    .summary-card[data-card="total"]::after {
      background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, transparent 70%);
    }

    .summary-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
    }

    .summary-card-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      color: #0f172a;
    }

    .summary-card-title i {
      font-size: 1.35rem;
      color: #10b981;
    }

    .summary-card[data-card="ads"] .summary-card-title i {
      color: #0ea5e9;
    }

    .summary-card-value {
      font-size: 1.65rem;
      font-weight: 800;
      color: #0f172a;
      background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }

    .summary-card-subtext {
      margin: 0;
      color: #475569;
      font-weight: 500;
      font-size: 0.85rem;
    }

    .summary-chip {
      background: rgba(16, 185, 129, 0.12);
      color: #047857;
      padding: 0.35rem 0.65rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .summary-chip.positive {
      background: rgba(16, 185, 129, 0.16);
      color: #047857;
    }

    .summary-chip.negative {
      background: rgba(239, 68, 68, 0.12);
      color: #b91c1c;
    }

    .summary-chip.neutral {
      background: rgba(148, 163, 184, 0.2);
      color: #475569;
    }

    .income-period-insights {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
      border-radius: 20px;
      padding: 1.5rem 1.6rem;
      border: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow:
        0 4px 6px rgba(15, 23, 42, 0.04),
        0 10px 20px rgba(15, 23, 42, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .income-period-insights:hover {
      box-shadow:
        0 8px 12px rgba(15, 23, 42, 0.08),
        0 20px 32px rgba(15, 23, 42, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 1);
    }

    .period-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
    }

    .period-header h3 {
      margin: 0;
      font-size: 1.02rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.45rem;
      color: #0f172a;
    }

    .period-header h3 i {
      color: #10b981;
      font-size: 1.2rem;
    }

    .period-header span {
      color: #64748b;
      font-size: 0.85rem;
    }

    .period-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .period-btn {
      border: 2px solid rgba(15, 23, 42, 0.1);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
      color: #475569;
      border-radius: 999px;
      padding: 0.5rem 1.2rem;
      font-family: 'Vazirmatn', sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(15, 23, 42, 0.04);
    }

    .period-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(16, 185, 129, 0.1);
      transform: translate(-50%, -50%);
      transition: width 0.4s ease, height 0.4s ease;
    }

    .period-btn:hover {
      border-color: rgba(16, 185, 129, 0.5);
      color: #047857;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.15);
    }

    .period-btn:hover::before {
      width: 200%;
      height: 200%;
    }

    .period-btn.active {
      background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
      color: #ffffff;
      border-color: transparent;
      box-shadow:
        0 4px 8px rgba(16, 185, 129, 0.25),
        0 8px 16px rgba(14, 165, 233, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .period-btn.active::before {
      display: none;
    }

    .period-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
    }

    .period-card {
      background: linear-gradient(135deg, rgba(248, 250, 252, 0.95) 0%, rgba(241, 245, 249, 0.9) 100%);
      border-radius: 16px;
      padding: 1rem 1.2rem;
      border: 1px solid rgba(226, 232, 240, 0.6);
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .period-card::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #10b981 0%, #0ea5e9 100%);
      transform: scaleY(0);
      transform-origin: top;
      transition: transform 0.3s ease;
    }

    .period-card:hover {
      transform: translateX(-3px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.12);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .period-card:hover::after {
      transform: scaleY(1);
    }

    .period-card span {
      font-size: 0.78rem;
      font-weight: 600;
      color: #64748b;
    }

    .period-card strong {
      font-size: 1.1rem;
      font-weight: 700;
      color: #0f172a;
    }

    .period-card em {
      font-style: normal;
      font-size: 0.78rem;
      color: #475569;
    }

    .period-change-positive {
      color: #047857;
    }

    .period-change-negative {
      color: #b91c1c;
    }

    .income-chart-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      gap: 1.2rem;
      align-items: stretch;
    }

    .income-side-column {
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }

    .income-chart-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
      border-radius: 20px;
      padding: 1.5rem 1.8rem 1.8rem;
      box-shadow:
        0 4px 6px rgba(15, 23, 42, 0.04),
        0 10px 20px rgba(15, 23, 42, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(226, 232, 240, 0.8);
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      position: relative;
      overflow: hidden;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    .income-chart-card:hover {
      box-shadow:
        0 8px 12px rgba(15, 23, 42, 0.08),
        0 20px 32px rgba(15, 23, 42, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 1);
      border-color: rgba(16, 185, 129, 0.25);
    }

    .income-chart-card--wide {
      min-height: 280px;
    }

    .income-chart-card--compact {
      min-height: 230px;
    }

    .income-side-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 0.85rem;
    }

    .side-metric {
      background: linear-gradient(135deg, rgba(248, 250, 252, 0.95) 0%, rgba(241, 245, 249, 0.9) 100%);
      border-radius: 16px;
      padding: 1rem 1.2rem;
      border: 1px solid rgba(226, 232, 240, 0.6);
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      min-height: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .side-metric::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #10b981 0%, #0ea5e9 100%);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
    }

    .side-metric:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.12);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .side-metric:hover::after {
      transform: scaleX(1);
    }

    .side-metric-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #64748b;
    }

    .side-metric-value {
      font-size: 1.2rem;
      font-weight: 800;
      color: #0f172a;
    }

    .side-metric-hint {
      font-size: 0.8rem;
      color: #475569;
    }

    .chart-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
    }

    .chart-card-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }

    .chart-card-header h3 i {
      color: #10b981;
      font-size: 1.2rem;
    }

    .chart-chip {
      font-size: 0.8rem;
      font-weight: 600;
      color: #0f172a;
      background: rgba(15, 23, 42, 0.08);
      border-radius: 999px;
      padding: 0.3rem 0.65rem;
    }

    .chart-chip.status-success {
      background: rgba(16, 185, 129, 0.16);
      color: #047857;
    }

    .chart-chip.status-warning {
      background: rgba(249, 115, 22, 0.16);
      color: #b45309;
    }

    .chart-chip.status-error {
      background: rgba(248, 113, 113, 0.18);
      color: #b91c1c;
    }

    .plan-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .plan-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
      border-radius: 18px;
      padding: 1.3rem 1.5rem;
      box-shadow:
        0 4px 6px rgba(15, 23, 42, 0.04),
        0 10px 20px rgba(15, 23, 42, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(226, 232, 240, 0.8);
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .plan-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #10b981 0%, #0ea5e9 100%);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
    }

    .plan-card:hover {
      transform: translateY(-3px);
      box-shadow:
        0 8px 12px rgba(15, 23, 42, 0.08),
        0 20px 32px rgba(15, 23, 42, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 1);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .plan-card:hover::before {
      transform: scaleX(1);
    }

    .plan-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .plan-card h4 {
      margin: 0;
      font-size: 0.98rem;
      font-weight: 700;
      color: #0f172a;
    }

    .plan-card-value {
      font-size: 1.15rem;
      font-weight: 700;
      color: #0f172a;
    }

    .plan-change {
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.14);
      color: #047857;
    }

    .plan-change.negative {
      background: rgba(239, 68, 68, 0.14);
      color: #b91c1c;
    }

    .plan-progress {
      height: 6px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(148, 163, 184, 0.24);
    }

    .plan-progress span {
      display: block;
      height: 100%;
      background: linear-gradient(135deg, #10b981, #0ea5e9);
      border-radius: inherit;
      transition: width 0.4s ease;
    }

    .plan-change.negative + .plan-progress span {
      background: linear-gradient(135deg, #f87171, #facc15);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      margin-bottom: 0.85rem;
    }

    .section-header h3 {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.45rem;
      color: #0f172a;
    }

    .section-header h3 i {
      color: #10b981;
      font-size: 1.2rem;
    }

    .section-header span {
      color: #475569;
      font-weight: 500;
    }

    .income-table-section {
      background: rgba(255, 255, 255, 0.94);
      border-radius: 16px;
      padding: 1.2rem 1.3rem 1.5rem;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 760px;
    }

    thead th {
      text-align: right;
      padding: 0.75rem 0.7rem;
      font-weight: 700;
      font-size: 0.85rem;
      color: #0f172a;
      border-bottom: 1px solid rgba(226, 232, 240, 0.9);
      background: rgba(226, 232, 240, 0.32);
    }

    tbody td {
      padding: 0.7rem 0.7rem;
      border-bottom: 1px solid rgba(226, 232, 240, 0.6);
      color: #475569;
      font-weight: 500;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: rgba(16, 185, 129, 0.08);
    }

    .seller-name {
      font-weight: 700;
      color: #0f172a;
    }

    .amount {
      font-variant-numeric: tabular-nums;
    }

    #income-error[hidden] {
      display: none;
    }

    #income-error {
      padding: 0.75rem 1rem;
      border-radius: 14px;
      background: rgba(249, 115, 22, 0.12);
      color: #b45309;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .loading-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      background: rgba(255, 255, 255, 0.78);
      backdrop-filter: blur(6px);
      z-index: 5;
      font-weight: 600;
      color: #0f172a;
    }

    .loading-overlay[hidden] {
      display: none;
    }

    .loading-overlay .spinner {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 4px solid rgba(226, 232, 240, 0.3);
      border-top-color: #10b981;
      border-right-color: #0ea5e9;
      animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.15);
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .income-toast {
      position: fixed;
      bottom: 24px;
      left: 24px;
      padding: 0.65rem 1rem;
      border-radius: 12px;
      background: rgba(16, 185, 129, 0.92);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 14px 24px rgba(16, 185, 129, 0.3);
      z-index: 9999;
      opacity: 0;
      transform: translateY(12px);
      animation: toast-in 0.25s forwards;
    }

    @keyframes toast-in {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 1024px) {
      .income-dashboard {
        padding: 1.4rem;
      }

      .income-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .income-header-meta {
        justify-content: flex-start;
      }

      .income-chart-grid {
        grid-template-columns: 1fr;
      }

      .income-side-column {
        gap: 1rem;
      }
    }

    @media (max-width: 640px) {
      .income-dashboard {
        padding: 1.3rem;
        border-radius: 18px;
      }

      .income-header h1 {
        font-size: 1.6rem;
      }

      #income-filter-form {
        flex-direction: column;
        align-items: stretch;
      }

      #income-filter-form input[type="date"] {
        width: 100%;
        min-width: 0;
      }

      .income-side-metrics {
        grid-template-columns: 1fr;
      }

      table {
        min-width: 100%;
      }
    }
  </style>
  <script src="/nav-active.js" defer></script>
</head>
<body>
  <div class="income-dashboard">
    <header class="income-header">
      <div>
        <h1>داشبورد درآمدها</h1>
        <p>نمایی جامع از درآمدهای تبلیغات، اشتراک‌های فروشندگان و عملکرد مالی برتر ویترینت در بازه‌های زمانی دلخواه.</p>
      </div>
      <div class="income-header-meta">
        <div class="meta-item">
          <i class="ri-calendar-check-line"></i>
          <span data-income-field="range">۳۰ روز اخیر</span>
        </div>
        <div class="meta-item">
          <i class="ri-time-line"></i>
          <span>آخرین بروزرسانی: <span data-income-field="updated">—</span></span>
        </div>
        <button type="button" class="ghost-btn" id="income-refresh-btn">
          <i class="ri-refresh-line"></i>
          بروزرسانی داده‌ها
        </button>
      </div>
    </header>

    <div id="income-error" hidden>در حال حاضر اتصال به سرویس آمار درآمد برقرار نیست؛ تا زمان برقراری ارتباط داده‌ای نمایش داده نمی‌شود.</div>

    <section class="income-filter">
      <form id="income-filter-form">
        <label for="income-start-date">از تاریخ
          <input type="date" id="income-start-date" name="start">
        </label>
        <label for="income-end-date">تا تاریخ
          <input type="date" id="income-end-date" name="end">
        </label>
        <button type="submit" class="primary-btn">
          <i class="ri-filter-3-line"></i>
          اعمال فیلتر
        </button>
      </form>
    </section>

    <section class="income-summary-grid">
      <article class="summary-card" data-card="total">
        <div class="summary-card-header">
          <div class="summary-card-title">
            <i class="ri-line-chart-line"></i>
            درآمد کل
          </div>
          <span class="summary-chip neutral" data-role="change">0%</span>
        </div>
        <div class="summary-card-value" data-role="value">۰ تومان</div>
        <p class="summary-card-subtext" data-role="delta">—</p>
      </article>
      <article class="summary-card" data-card="plans">
        <div class="summary-card-header">
          <div class="summary-card-title">
            <i class="ri-vip-diamond-line"></i>
            درآمد اشتراک فروشندگان
          </div>
          <span class="summary-chip neutral" data-role="change">0%</span>
        </div>
        <div class="summary-card-value" data-role="value">۰ تومان</div>
        <p class="summary-card-subtext" data-role="delta">—</p>
      </article>
      <article class="summary-card" data-card="ads">
        <div class="summary-card-header">
          <div class="summary-card-title">
            <i class="ri-megaphone-line"></i>
            درآمد تبلیغات اختصاصی
          </div>
          <span class="summary-chip neutral" data-role="change">0%</span>
        </div>
        <div class="summary-card-value" data-role="value">۰ تومان</div>
        <p class="summary-card-subtext" data-role="delta">—</p>
      </article>
    </section>

    <section class="income-period-insights">
      <div class="period-header">
        <h3><i class="ri-timer-line"></i> درآمد بر اساس دوره</h3>
        <span data-period-range>داده‌ای موجود نیست</span>
      </div>
      <div class="period-controls" role="tablist">
        <button type="button" class="period-btn active" data-period-btn data-period="daily">روزانه</button>
        <button type="button" class="period-btn" data-period-btn data-period="weekly">هفتگی</button>
        <button type="button" class="period-btn" data-period-btn data-period="monthly">ماهانه</button>
        <button type="button" class="period-btn" data-period-btn data-period="yearly">سالانه</button>
      </div>
      <div class="period-metrics">
        <article class="period-card">
          <span>مجموع درآمد</span>
          <strong data-period-value>۰ تومان</strong>
          <em data-period-length>—</em>
        </article>
        <article class="period-card">
          <span>میانگین روزانه</span>
          <strong data-period-average>۰ تومان</strong>
          <em>بر مبنای بازه فعال</em>
        </article>
        <article class="period-card">
          <span>تغییر نسبت به دوره قبل</span>
          <strong data-period-change>—</strong>
          <em data-period-prev>دوره قبل: —</em>
        </article>
        <article class="period-card">
          <span>اختلاف مبلغ</span>
          <strong data-period-delta>۰ تومان</strong>
          <em>نسبت به دوره قبل</em>
        </article>
      </div>
    </section>

    <section class="income-chart-grid">
      <article class="income-chart-card income-chart-card--wide">
        <div class="chart-card-header">
          <h3><i class="ri-line-chart-line"></i> روند درآمد ترکیبی</h3>
          <span class="chart-chip status-warning" data-income-field="status">در انتظار داده</span>
        </div>
        <canvas id="incomeTrendChart" height="240"></canvas>
      </article>
      <div class="income-side-column">
        <article class="income-chart-card income-chart-card--compact">
          <div class="chart-card-header">
            <h3><i class="ri-donut-chart-line"></i> سهم هر منبع درآمد</h3>
          </div>
          <canvas id="incomeDistributionChart" height="220"></canvas>
        </article>
        <div class="income-side-metrics">
          <div class="side-metric" data-income-metric="plansShare">
            <span class="side-metric-label">سهم اشتراک‌ها</span>
            <strong class="side-metric-value">۰٪</strong>
            <span class="side-metric-hint">از کل درآمد این بازه</span>
          </div>
          <div class="side-metric" data-income-metric="adsShare">
            <span class="side-metric-label">سهم تبلیغات</span>
            <strong class="side-metric-value">۰٪</strong>
            <span class="side-metric-hint">از کل درآمد این بازه</span>
          </div>
          <div class="side-metric" data-income-metric="averageTicket">
            <span class="side-metric-label">میانگین هر پرداخت</span>
            <strong class="side-metric-value">۰ تومان</strong>
            <span class="side-metric-hint">بدون تراکنش تکمیل‌شده</span>
          </div>
          <div class="side-metric" data-income-metric="perSeller">
            <span class="side-metric-label">میانگین درآمد هر فروشنده</span>
            <strong class="side-metric-value">۰ تومان</strong>
            <span class="side-metric-hint">بدون فروشنده فعال</span>
          </div>
          <div class="side-metric" data-income-metric="bestDay">
            <span class="side-metric-label">پربازده‌ترین روز</span>
            <strong class="side-metric-value">—</strong>
            <span class="side-metric-hint">داده‌ای موجود نیست</span>
          </div>
        </div>
      </div>
    </section>

    <section>
      <div class="section-header">
        <h3><i class="ri-vip-crown-line"></i> جزئیات عملکرد پلن‌ها و تبلیغات</h3>
        <span>بیشترین فروش: <strong data-income-field="top-seller">—</strong></span>
      </div>
      <div class="plan-grid" id="income-plan-breakdown"></div>
    </section>

    <section class="income-table-section">
      <div class="section-header">
        <h3><i class="ri-team-line"></i> فروشندگان برتر بر اساس درآمد</h3>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>نام فروشنده</th>
              <th>درآمد از اشتراک‌ها</th>
              <th>درآمد از تبلیغات</th>
              <th>کل درآمد</th>
              <th>پلن ۱ ماهه</th>
              <th>پلن ۳ ماهه</th>
              <th>پلن ۱۲ ماهه</th>
            </tr>
          </thead>
          <tbody id="income-sellers-body">
            <tr>
              <td colspan="7" style="text-align:center;padding:1.5rem;color:#94a3b8;">در حال بارگیری اطلاعات...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <div class="loading-overlay" id="income-loading" hidden>
      <div class="spinner"></div>
      <span>در حال دریافت داده‌ها...</span>
    </div>
  </div>

  <script>
    (function () {
      const panel = document.getElementById('income-insights-panel');
      if (!panel) return;
      const root = panel.querySelector('.income-dashboard');
      if (!root) return;

      const form = root.querySelector('#income-filter-form');
      const startInput = root.querySelector('#income-start-date');
      const endInput = root.querySelector('#income-end-date');
      const refreshBtn = root.querySelector('#income-refresh-btn');
      const loadingOverlay = root.querySelector('#income-loading');
      const errorBanner = root.querySelector('#income-error');
      const rangeLabel = root.querySelector('[data-income-field="range"]');
      const updatedLabel = root.querySelector('[data-income-field="updated"]');
      const statusChip = root.querySelector('[data-income-field="status"]');
      const topSellerLabel = root.querySelector('[data-income-field="top-seller"]');
      const planContainer = root.querySelector('#income-plan-breakdown');
      const sellersBody = root.querySelector('#income-sellers-body');

      const summaryCards = {
        total: root.querySelector('.summary-card[data-card="total"]'),
        plans: root.querySelector('.summary-card[data-card="plans"]'),
        ads: root.querySelector('.summary-card[data-card="ads"]')
      };

      const trendCanvas = root.querySelector('#incomeTrendChart');
      const distributionCanvas = root.querySelector('#incomeDistributionChart');

      const metricElements = {};
      ['plansShare', 'adsShare', 'averageTicket', 'perSeller', 'bestDay'].forEach((key) => {
        const wrapper = root.querySelector(`[data-income-metric="${key}"]`);
        if (!wrapper) return;
        metricElements[key] = {
          value: wrapper.querySelector('.side-metric-value'),
          hint: wrapper.querySelector('.side-metric-hint')
        };
      });

      const periodSection = root.querySelector('.income-period-insights');
      const periodButtons = periodSection ? Array.from(periodSection.querySelectorAll('[data-period-btn]')) : [];
      const periodRangeLabel = periodSection ? periodSection.querySelector('[data-period-range]') : null;
      const periodValueEl = periodSection ? periodSection.querySelector('[data-period-value]') : null;
      const periodAverageEl = periodSection ? periodSection.querySelector('[data-period-average]') : null;
      const periodChangeEl = periodSection ? periodSection.querySelector('[data-period-change]') : null;
      const periodPrevEl = periodSection ? periodSection.querySelector('[data-period-prev]') : null;
      const periodLengthEl = periodSection ? periodSection.querySelector('[data-period-length]') : null;
      const periodDeltaEl = periodSection ? periodSection.querySelector('[data-period-delta]') : null;

      const numberFormatter = new Intl.NumberFormat('fa-IR');
      const percentFormatter = new Intl.NumberFormat('fa-IR', { style: 'percent', maximumFractionDigits: 1, signDisplay: 'always' });
      const shareFormatter = new Intl.NumberFormat('fa-IR', { style: 'percent', maximumFractionDigits: 1 });

      const PERIOD_CONFIG = {
        daily: { label: 'روزانه', days: 1 },
        weekly: { label: 'هفتگی', days: 7 },
        monthly: { label: 'ماهانه', days: 30 },
        yearly: { label: 'سالانه', days: 365 }
      };

      const ensureNumber = (value, fallback = 0) => {
        const num = Number(value);
        return Number.isFinite(num) ? num : fallback;
      };

      const toInputDate = (date) => {
        const iso = date.toISOString();
        return iso.slice(0, 10);
      };

      const toPersianDate = (value) => {
        if (!value) return '—';
        try {
          return new Date(value).toLocaleDateString('fa-IR');
        } catch (e) {
          return value;
        }
      };

      const toPersianDateTime = (value) => {
        if (!value) return '—';
        try {
          return new Date(value).toLocaleString('fa-IR', {
            hour12: false,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch (e) {
          return value;
        }
      };

      const formatCurrency = (value) => `${numberFormatter.format(Math.round(ensureNumber(value, 0)))} تومان`;

      const formatPercent = (value) => {
        const num = ensureNumber(value, 0);
        if (!Number.isFinite(num)) return '0%';
        try {
          return percentFormatter.format(num);
        } catch (e) {
          const sign = num > 0 ? '+' : '';
          return `${sign}${(num * 100).toFixed(1)}%`;
        }
      };

      const createEmptyDataset = () => ({
        generatedAt: null,
        range: { start: null, end: null },
        summary: {
          total: { value: 0, change: 0, delta: 0 },
          plans: { value: 0, change: 0, delta: 0 },
          ads: { value: 0, change: 0, delta: 0 },
          topSeller: ''
        },
        planBreakdown: [],
        trend: { labels: [], plans: [], ads: [] },
        distribution: { labels: [], values: [] },
        sellers: [],
        meta: {
          totalPayments: 0,
          plansCount: 0,
          adsCount: 0,
          sellerCount: 0,
          rangeDays: 0,
          bestDay: null
        }
      });

      const toNumberArray = (input) => Array.isArray(input)
        ? input.map((value) => ensureNumber(value, 0))
        : [];

      const normaliseMetric = (metric, fallbackMetric = { value: 0, change: 0, delta: 0 }) => {
        const baseMetric = fallbackMetric || { value: 0, change: 0, delta: 0 };
        if (metric == null) return { ...baseMetric };
        if (typeof metric === 'number') {
          return {
            value: ensureNumber(metric, baseMetric.value),
            change: baseMetric.change,
            delta: baseMetric.delta
          };
        }
        return {
          value: ensureNumber(metric.value ?? metric.amount ?? metric.total ?? baseMetric.value, baseMetric.value),
          change: ensureNumber(metric.change ?? metric.growth ?? metric.percent ?? baseMetric.change, baseMetric.change),
          delta: ensureNumber(metric.delta ?? metric.diff ?? metric.absolute ?? baseMetric.delta, baseMetric.delta)
        };
      };

      const normaliseData = (raw) => {
        const base = createEmptyDataset();
        if (!raw || typeof raw !== 'object') {
          return base;
        }

        const dataset = createEmptyDataset();

        const summary = raw.summary || {};
        const totalMetric = normaliseMetric(summary.total ?? raw.totalIncome, base.summary.total);
        const plansMetric = normaliseMetric(summary.plans ?? raw.plansIncome, base.summary.plans);
        const adsMetric = normaliseMetric(summary.ads ?? raw.adsIncome, base.summary.ads);
        const topSeller = summary.topSeller || raw.topSeller || '';

        dataset.summary = {
          total: totalMetric,
          plans: plansMetric,
          ads: adsMetric,
          topSeller
        };

        const planBreakdown = Array.isArray(raw.planBreakdown)
          ? raw.planBreakdown.map((item) => ({
              key: item.key || item.slug || item.code || item.name,
              name: item.name || item.title || '—',
              value: ensureNumber(item.value ?? item.amount ?? 0, 0),
              change: ensureNumber(item.change ?? item.growth ?? item.percent ?? 0, 0)
            }))
          : [];

        dataset.planBreakdown = planBreakdown;

        const trendSource = raw.trend || {};
        const trendLabels = Array.isArray(trendSource.labels) ? trendSource.labels : [];
        const trendPlansRaw = toNumberArray(trendSource.plans ?? trendSource.planIncome);
        const trendAdsRaw = toNumberArray(trendSource.ads ?? trendSource.adsIncome);
        const alignWithLabels = (list) => (trendLabels.length ? list.slice(0, trendLabels.length) : list);
        dataset.trend = {
          labels: trendLabels,
          plans: alignWithLabels(trendPlansRaw),
          ads: alignWithLabels(trendAdsRaw)
        };

        const distributionSource = raw.distribution || {};
        const distributionLabels = Array.isArray(distributionSource.labels)
          ? distributionSource.labels
          : planBreakdown.map((item) => item.name);
        const distributionValuesRaw = distributionSource.values ?? distributionSource.data;
        const distributionValues = toNumberArray(distributionValuesRaw);
        dataset.distribution = {
          labels: distributionLabels,
          values: distributionValues.length
            ? distributionValues.slice(0, distributionLabels.length)
            : planBreakdown.map((item) => item.value)
        };

        const sellers = Array.isArray(raw.sellers)
          ? raw.sellers.map((item) => ({
              name: item.name || item.sellerName || item.shopName || '—',
              plans: ensureNumber(item.plans ?? item.planIncome ?? item.subscriptionIncome ?? 0, 0),
              ads: ensureNumber(item.ads ?? item.adsIncome ?? item.adIncome ?? 0, 0),
              total: ensureNumber(
                item.total ?? item.totalIncome ?? (
                  ensureNumber(item.plans ?? item.planIncome ?? 0, 0) +
                  ensureNumber(item.ads ?? item.adsIncome ?? 0, 0)
                ),
                0
              ),
              plan1: ensureNumber(item.plan1 ?? item.planOne ?? item.month1 ?? item.monthly ?? 0, 0),
              plan3: ensureNumber(item.plan3 ?? item.planThree ?? item.quarterly ?? 0, 0),
              plan12: ensureNumber(item.plan12 ?? item.planTwelve ?? item.yearly ?? item.annual ?? 0, 0)
            }))
          : [];

        dataset.sellers = sellers;

        const metaSource = raw.meta || {};
        const bestDayMeta = metaSource.bestDay || metaSource.topDay || null;
        dataset.meta = {
          totalPayments: ensureNumber(metaSource.totalPayments ?? metaSource.payments ?? 0, 0),
          plansCount: ensureNumber(metaSource.plansCount ?? 0, 0),
          adsCount: ensureNumber(metaSource.adsCount ?? 0, 0),
          sellerCount: ensureNumber(metaSource.sellerCount ?? (Array.isArray(sellers) ? sellers.length : 0), 0),
          rangeDays: ensureNumber(metaSource.rangeDays ?? metaSource.days ?? 0, 0),
          bestDay: bestDayMeta && (bestDayMeta.date || bestDayMeta.day) ? {
            date: bestDayMeta.date || bestDayMeta.day || null,
            total: ensureNumber(bestDayMeta.total ?? bestDayMeta.amount ?? 0, 0)
          } : null
        };

        const range = raw.range || {};
        dataset.range = {
          start: range.start || raw.startDate || raw.start || null,
          end: range.end || raw.endDate || raw.end || null
        };

        dataset.generatedAt = raw.generatedAt || raw.updatedAt || raw.updated || raw.timestamp || null;

        return dataset;
      };

      const buildTrendEntries = (dataset) => {
        if (!dataset || !dataset.trend) return [];
        const labels = Array.isArray(dataset.trend.labels) ? dataset.trend.labels : [];
        const plans = toNumberArray(dataset.trend.plans);
        const ads = toNumberArray(dataset.trend.ads);
        return labels.map((label, index) => ({
          label,
          total: ensureNumber(plans[index], 0) + ensureNumber(ads[index], 0)
        }));
      };

      const formatTrendRange = (entries) => {
        if (!entries.length) return 'داده‌ای موجود نیست';
        const firstLabel = entries[0]?.label;
        const lastLabel = entries[entries.length - 1]?.label;
        if (!firstLabel && !lastLabel) return '—';
        if (!lastLabel || firstLabel === lastLabel) {
          return toPersianDate(firstLabel || lastLabel);
        }
        return `${toPersianDate(firstLabel)} تا ${toPersianDate(lastLabel)}`;
      };

      const computePeriodStats = (dataset, periodKey) => {
        const config = PERIOD_CONFIG[periodKey];
        const entries = buildTrendEntries(dataset);
        if (!config || !entries.length) {
          return {
            total: 0,
            average: 0,
            prevTotal: 0,
            delta: 0,
            change: null,
            count: 0,
            rangeText: 'داده‌ای موجود نیست',
            hasPrev: false
          };
        }

        const required = config.days;
        const available = Math.min(required, entries.length);
        const currentStart = entries.length - available;
        const currentEntries = entries.slice(currentStart);
        const total = currentEntries.reduce((sum, entry) => sum + ensureNumber(entry.total, 0), 0);

        const prevStart = Math.max(0, currentStart - required);
        const prevEntries = entries.slice(prevStart, currentStart);
        const prevTotal = prevEntries.reduce((sum, entry) => sum + ensureNumber(entry.total, 0), 0);
        const hasPrev = prevEntries.length > 0;

        let change = null;
        if (hasPrev) {
          if (prevTotal > 0) {
            change = (total - prevTotal) / prevTotal;
          } else if (total > 0) {
            change = 1;
          } else {
            change = 0;
          }
        }

        return {
          total,
          average: available ? total / available : 0,
          prevTotal,
          delta: total - prevTotal,
          change,
          count: available,
          rangeText: formatTrendRange(currentEntries),
          hasPrev
        };
      };

      const state = {
        charts: {
          trend: null,
          distribution: null
        },
        data: null,
        period: 'daily'
      };

      const setActivePeriodButton = (periodKey) => {
        if (!periodButtons.length) return;
        periodButtons.forEach((button) => {
          button.classList.toggle('active', button.dataset.period === periodKey);
        });
      };

      const updatePeriodView = (dataset) => {
        if (!periodSection) return;
        const selected = PERIOD_CONFIG[state.period] ? state.period : 'daily';
        setActivePeriodButton(selected);
        const stats = computePeriodStats(dataset, selected);

        if (periodRangeLabel) {
          periodRangeLabel.textContent = stats.rangeText;
        }

        if (periodValueEl) {
          periodValueEl.textContent = formatCurrency(stats.total);
        }

        if (periodAverageEl) {
          periodAverageEl.textContent = stats.count
            ? formatCurrency(stats.average)
            : formatCurrency(0);
        }

        if (periodLengthEl) {
          periodLengthEl.textContent = stats.count
            ? `پوشش ${numberFormatter.format(stats.count)} روز`
            : '—';
        }

        if (periodPrevEl) {
          periodPrevEl.textContent = stats.hasPrev
            ? `دوره قبل: ${formatCurrency(stats.prevTotal)}`
            : 'دوره قبل: —';
        }

        if (periodDeltaEl) {
          periodDeltaEl.textContent = stats.hasPrev
            ? formatCurrency(stats.delta)
            : '—';
        }

        if (periodChangeEl) {
          periodChangeEl.classList.remove('period-change-positive', 'period-change-negative');
          if (stats.change == null) {
            periodChangeEl.textContent = '—';
          } else {
            periodChangeEl.textContent = formatPercent(stats.change);
            if (stats.change > 0) {
              periodChangeEl.classList.add('period-change-positive');
            } else if (stats.change < 0) {
              periodChangeEl.classList.add('period-change-negative');
            }
          }
        }
      };

      const ensureCharts = () => {
        if (!window.Chart) return;

        if (!state.charts.trend) {
          const baseTrend = createEmptyDataset().trend;
          const ctx = trendCanvas.getContext('2d');
          const plansGradient = ctx.createLinearGradient(0, 0, 0, 400);
          plansGradient.addColorStop(0, 'rgba(16, 185, 129, 0.35)');
          plansGradient.addColorStop(0.5, 'rgba(16, 185, 129, 0.15)');
          plansGradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

          const adsGradient = ctx.createLinearGradient(0, 0, 0, 400);
          adsGradient.addColorStop(0, 'rgba(14, 165, 233, 0.35)');
          adsGradient.addColorStop(0.5, 'rgba(14, 165, 233, 0.15)');
          adsGradient.addColorStop(1, 'rgba(14, 165, 233, 0.0)');

          state.charts.trend = new Chart(ctx, {
            type: 'line',
            data: {
              labels: baseTrend.labels,
              datasets: [
                {
                  label: 'اشتراک‌ها',
                  data: baseTrend.plans,
                  borderColor: '#10b981',
                  backgroundColor: plansGradient,
                  borderWidth: 3.5,
                  tension: 0.4,
                  fill: true,
                  pointRadius: 5,
                  pointHoverRadius: 8,
                  pointBackgroundColor: '#fff',
                  pointBorderColor: '#10b981',
                  pointBorderWidth: 3,
                  pointHoverBackgroundColor: '#10b981',
                  pointHoverBorderColor: '#fff',
                  pointHoverBorderWidth: 3,
                  segment: {
                    borderColor: ctx => {
                      const gradient = ctx.p0.parsed.y > ctx.p1.parsed.y
                        ? '#fbbf24'
                        : '#10b981';
                      return gradient;
                    }
                  }
                },
                {
                  label: 'تبلیغات',
                  data: baseTrend.ads,
                  borderColor: '#0ea5e9',
                  backgroundColor: adsGradient,
                  borderWidth: 3.5,
                  tension: 0.4,
                  fill: true,
                  pointRadius: 5,
                  pointHoverRadius: 8,
                  pointBackgroundColor: '#fff',
                  pointBorderColor: '#0ea5e9',
                  pointBorderWidth: 3,
                  pointHoverBackgroundColor: '#0ea5e9',
                  pointHoverBorderColor: '#fff',
                  pointHoverBorderWidth: 3
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false,
                axis: 'x'
              },
              animation: {
                duration: 1500,
                easing: 'easeInOutQuart',
                delay: (context) => {
                  let delay = 0;
                  if (context.type === 'data' && context.mode === 'default') {
                    delay = context.dataIndex * 50 + context.datasetIndex * 100;
                  }
                  return delay;
                }
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  align: 'end',
                  labels: {
                    font: {
                      family: 'Vazirmatn',
                      weight: '700',
                      size: 13
                    },
                    color: '#1e293b',
                    padding: 15,
                    usePointStyle: true,
                    pointStyle: 'circle',
                    boxWidth: 10,
                    boxHeight: 10
                  }
                },
                tooltip: {
                  enabled: true,
                  backgroundColor: 'rgba(255, 255, 255, 0.98)',
                  borderColor: 'rgba(148, 163, 184, 0.3)',
                  borderWidth: 2,
                  titleColor: '#0f172a',
                  bodyColor: '#475569',
                  titleFont: {
                    family: 'Vazirmatn',
                    weight: '700',
                    size: 14
                  },
                  bodyFont: {
                    family: 'Vazirmatn',
                    weight: '600',
                    size: 13
                  },
                  padding: 15,
                  cornerRadius: 12,
                  displayColors: true,
                  boxWidth: 12,
                  boxHeight: 12,
                  boxPadding: 6,
                  usePointStyle: true,
                  callbacks: {
                    title: (context) => {
                      return toPersianDate(context[0].label);
                    },
                    label: (context) => {
                      const label = context.dataset.label || '';
                      const value = formatCurrency(context.parsed.y);
                      return `  ${label}: ${value}`;
                    },
                    afterBody: (context) => {
                      const total = context.reduce((sum, item) => sum + item.parsed.y, 0);
                      return `\n  جمع کل: ${formatCurrency(total)}`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: {
                    display: true,
                    color: 'rgba(226, 232, 240, 0.5)',
                    drawBorder: false,
                    drawTicks: false
                  },
                  ticks: {
                    color: '#64748b',
                    font: {
                      family: 'Vazirmatn',
                      weight: '600',
                      size: 11
                    },
                    padding: 8,
                    callback: function(value, index) {
                      const label = this.getLabelForValue(value);
                      try {
                        return new Date(label).toLocaleDateString('fa-IR', {
                          month: 'short',
                          day: 'numeric'
                        });
                      } catch {
                        return label;
                      }
                    }
                  }
                },
                y: {
                  beginAtZero: true,
                  grid: {
                    color: 'rgba(226, 232, 240, 0.4)',
                    drawBorder: false,
                    drawTicks: false
                  },
                  border: {
                    display: false
                  },
                  ticks: {
                    color: '#64748b',
                    font: {
                      family: 'Vazirmatn',
                      weight: '600',
                      size: 11
                    },
                    padding: 10,
                    callback: (value) => {
                      if (value >= 1000000) {
                        return `${(value / 1000000).toFixed(1)}M`;
                      } else if (value >= 1000) {
                        return `${(value / 1000).toFixed(0)}K`;
                      }
                      return numberFormatter.format(value);
                    }
                  }
                }
              }
            }
          });
        }

        if (!state.charts.distribution) {
          const baseDistribution = createEmptyDataset().distribution;
          state.charts.distribution = new Chart(distributionCanvas.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: baseDistribution.labels,
              datasets: [
                {
                  data: baseDistribution.values,
                  backgroundColor: [
                    '#10b981',
                    '#0ea5e9',
                    '#8b5cf6',
                    '#f59e0b',
                    '#ec4899',
                    '#06b6d4',
                    '#84cc16',
                    '#f97316'
                  ],
                  borderColor: '#ffffff',
                  borderWidth: 4,
                  hoverOffset: 15,
                  hoverBorderWidth: 5,
                  spacing: 2
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: {
                animateRotate: true,
                animateScale: true,
                duration: 1500,
                easing: 'easeInOutQuart'
              },
              plugins: {
                legend: {
                  position: 'bottom',
                  align: 'center',
                  labels: {
                    usePointStyle: true,
                    pointStyle: 'circle',
                    font: {
                      family: 'Vazirmatn',
                      weight: '700',
                      size: 12
                    },
                    color: '#1e293b',
                    padding: 15,
                    boxWidth: 12,
                    boxHeight: 12,
                    generateLabels: (chart) => {
                      const data = chart.data;
                      if (data.labels.length && data.datasets.length) {
                        const dataset = data.datasets[0];
                        const total = dataset.data.reduce((sum, value) => sum + ensureNumber(value, 0), 0);
                        return data.labels.map((label, i) => {
                          const value = dataset.data[i];
                          const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                          return {
                            text: `${label} (${percent}%)`,
                            fillStyle: dataset.backgroundColor[i],
                            hidden: false,
                            index: i
                          };
                        });
                      }
                      return [];
                    }
                  }
                },
                tooltip: {
                  enabled: true,
                  backgroundColor: 'rgba(255, 255, 255, 0.98)',
                  borderColor: 'rgba(148, 163, 184, 0.3)',
                  borderWidth: 2,
                  titleColor: '#0f172a',
                  bodyColor: '#475569',
                  titleFont: {
                    family: 'Vazirmatn',
                    weight: '700',
                    size: 14
                  },
                  bodyFont: {
                    family: 'Vazirmatn',
                    weight: '600',
                    size: 13
                  },
                  padding: 15,
                  cornerRadius: 12,
                  displayColors: true,
                  boxWidth: 15,
                  boxHeight: 15,
                  boxPadding: 6,
                  usePointStyle: true,
                  callbacks: {
                    title: (context) => {
                      return context[0].label;
                    },
                    label: (context) => {
                      const dataset = context.dataset.data || [];
                      const total = dataset.reduce((sum, n) => sum + ensureNumber(n, 0), 0) || 1;
                      const value = context.parsed;
                      const percent = ((value / total) * 100).toFixed(1);
                      return `  مقدار: ${formatCurrency(value)}`;
                    },
                    afterLabel: (context) => {
                      const dataset = context.dataset.data || [];
                      const total = dataset.reduce((sum, n) => sum + ensureNumber(n, 0), 0) || 1;
                      const value = context.parsed;
                      const percent = ((value / total) * 100).toFixed(1);
                      return `  سهم: ${percent}%`;
                    },
                    footer: (context) => {
                      const dataset = context[0].dataset.data || [];
                      const total = dataset.reduce((sum, n) => sum + ensureNumber(n, 0), 0);
                      return `\nجمع کل: ${formatCurrency(total)}`;
                    }
                  }
                }
              },
              cutout: '65%',
              radius: '90%'
            }
          });
        }
      };

      const updateSummary = (summary) => {
        const applyToCard = (key, metric) => {
          const card = summaryCards[key];
          if (!card) return;
          const valueEl = card.querySelector('[data-role="value"]');
          const changeEl = card.querySelector('[data-role="change"]');
          const deltaEl = card.querySelector('[data-role="delta"]');
          const safeMetric = normaliseMetric(metric);
          const changeValue = ensureNumber(safeMetric.change, 0);

          if (valueEl) {
            valueEl.textContent = formatCurrency(safeMetric.value);
          }

          if (deltaEl) {
            deltaEl.textContent = safeMetric.delta
              ? `${formatCurrency(Math.abs(safeMetric.delta))} ${changeValue >= 0 ? 'افزایش' : 'کاهش'} نسبت به ماه قبل`
              : 'بدون تغییر نسبت به ماه قبل';
          }

          if (changeEl) {
            changeEl.textContent = formatPercent(changeValue);
            changeEl.classList.remove('negative', 'neutral', 'positive');
            if (changeValue > 0) {
              changeEl.classList.add('positive');
            } else if (changeValue < 0) {
              changeEl.classList.add('negative');
            } else {
              changeEl.classList.add('neutral');
            }
          }
        };

        applyToCard('total', summary.total);
        applyToCard('plans', summary.plans);
        applyToCard('ads', summary.ads);

        if (topSellerLabel) {
          topSellerLabel.textContent = summary.topSeller || '—';
        }
      };

      const updatePlanBreakdown = (items) => {
        planContainer.innerHTML = '';
        if (!Array.isArray(items) || !items.length) {
          planContainer.innerHTML = '<div style="padding:1.5rem;text-align:center;color:#94a3b8;">داده‌ای برای نمایش وجود ندارد.</div>';
          return;
        }

        const maxValue = Math.max(...items.map(item => ensureNumber(item.value, 0))) || 1;
        items.forEach((item) => {
          const value = ensureNumber(item.value, 0);
          const change = ensureNumber(item.change, 0);
          const card = document.createElement('article');
          card.className = 'plan-card';
          card.innerHTML = `
            <div class="plan-card-header">
              <h4>${item.name || '—'}</h4>
              <span class="plan-change">${formatPercent(change)}</span>
            </div>
            <div class="plan-card-value">${formatCurrency(value)}</div>
            <div class="plan-progress"><span></span></div>
          `;

          const changeBadge = card.querySelector('.plan-change');
          const progressSpan = card.querySelector('.plan-progress span');
          if (changeBadge) {
            if (change < 0) {
              changeBadge.classList.add('negative');
            } else {
              changeBadge.classList.remove('negative');
            }
          }

          if (progressSpan) {
            const progressPercent = maxValue ? (value / maxValue) * 100 : 0;
            const width = value <= 0 ? 0 : Math.min(100, Math.max(progressPercent, 10));
            progressSpan.style.width = `${width}%`;
            progressSpan.style.background = change < 0
              ? 'linear-gradient(135deg, #f87171, #facc15)'
              : 'linear-gradient(135deg, #10b981, #0ea5e9)';
          }

          planContainer.appendChild(card);
        });
      };

      const updateTrendChart = (trend) => {
        if (!state.charts.trend || !trend) return;
        state.charts.trend.data.labels = trend.labels || [];
        state.charts.trend.data.datasets[0].data = trend.plans || [];
        state.charts.trend.data.datasets[1].data = trend.ads || [];
        state.charts.trend.update();
      };

      const updateDistributionChart = (distribution) => {
        if (!state.charts.distribution || !distribution) return;
        state.charts.distribution.data.labels = distribution.labels || [];
        state.charts.distribution.data.datasets[0].data = distribution.values || [];
        state.charts.distribution.update();
      };

      const updateSideMetrics = (dataset) => {
        const summary = dataset?.summary || {};
        const meta = dataset?.meta || {};
        const totalValue = ensureNumber(summary.total?.value, 0);
        const plansValue = ensureNumber(summary.plans?.value, 0);
        const adsValue = ensureNumber(summary.ads?.value, 0);
        const paymentCount = ensureNumber(meta.totalPayments, 0);
        const sellerCount = ensureNumber(meta.sellerCount, Array.isArray(dataset?.sellers) ? dataset.sellers.length : 0);
        const bestDay = meta.bestDay;

        const setMetric = (key, value, hint) => {
          const target = metricElements[key];
          if (!target) return;
          if (target.value) target.value.textContent = value;
          if (target.hint) target.hint.textContent = hint;
        };

        const shareHint = 'از کل درآمد این بازه';
        setMetric('plansShare', shareFormatter.format(totalValue > 0 ? plansValue / totalValue : 0), shareHint);
        setMetric('adsShare', shareFormatter.format(totalValue > 0 ? adsValue / totalValue : 0), shareHint);

        if (paymentCount > 0 && totalValue > 0) {
          setMetric('averageTicket', formatCurrency(totalValue / paymentCount), `${numberFormatter.format(paymentCount)} پرداخت تکمیل‌شده`);
        } else {
          setMetric('averageTicket', formatCurrency(0), 'بدون تراکنش تکمیل‌شده');
        }

        if (sellerCount > 0 && totalValue > 0) {
          setMetric('perSeller', formatCurrency(totalValue / sellerCount), `${numberFormatter.format(sellerCount)} فروشنده فعال`);
        } else {
          setMetric('perSeller', formatCurrency(0), 'بدون فروشنده فعال');
        }

        if (bestDay && bestDay.date) {
          setMetric('bestDay', toPersianDate(bestDay.date), `${formatCurrency(bestDay.total || 0)} مجموع تراکنش`);
        } else {
          setMetric('bestDay', '—', 'داده‌ای برای این بازه وجود ندارد');
        }
      };

      const updateSellersTable = (sellers) => {
        sellersBody.innerHTML = '';
        if (!Array.isArray(sellers) || !sellers.length) {
          sellersBody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:1.4rem;color:#94a3b8;">اطلاعاتی برای این بازه زمانی ثبت نشده است.</td></tr>';
          return;
        }

        sellers.forEach((seller) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="seller-name">${seller.name || '—'}</td>
            <td class="amount">${formatCurrency(seller.plans)}</td>
            <td class="amount">${formatCurrency(seller.ads)}</td>
            <td class="amount">${formatCurrency(seller.total)}</td>
            <td class="amount">${formatCurrency(seller.plan1)}</td>
            <td class="amount">${formatCurrency(seller.plan3)}</td>
            <td class="amount">${formatCurrency(seller.plan12)}</td>
          `;
          sellersBody.appendChild(row);
        });
      };

      const showToast = (message) => {
        const toast = document.createElement('div');
        toast.className = 'income-toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(12px)';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 400);
        }, 2800);
      };

      const setLoading = (isLoading) => {
        if (!loadingOverlay) return;
        loadingOverlay.hidden = !isLoading;
      };

      const updateStatus = ({ hasError, isEmpty }) => {
        if (!statusChip) return;
        statusChip.classList.remove('status-success', 'status-warning', 'status-error');
        if (hasError) {
          statusChip.textContent = 'خطای اتصال';
          statusChip.classList.add('status-error');
          return;
        }
        if (isEmpty) {
          statusChip.textContent = 'داده‌ای برای این بازه ثبت نشده';
          statusChip.classList.add('status-warning');
          return;
        }
        statusChip.textContent = 'متصل به سرویس';
        statusChip.classList.add('status-success');
      };

      const applyData = (dataset, { usingFallback } = {}) => {
        state.data = dataset;
        updateSummary(dataset.summary);
        updatePlanBreakdown(dataset.planBreakdown);
        updateTrendChart(dataset.trend);
        updateDistributionChart(dataset.distribution);
        updateSellersTable(dataset.sellers);
        updateSideMetrics(dataset);
        updatePeriodView(dataset);

        const range = dataset.range || {};
        if (rangeLabel) {
          if (range.start && range.end) {
            rangeLabel.textContent = `${toPersianDate(range.start)} تا ${toPersianDate(range.end)}`;
          } else if (range.start || range.end) {
            const singleDate = range.start || range.end;
            rangeLabel.textContent = toPersianDate(singleDate);
          } else {
            rangeLabel.textContent = 'بدون فیلتر زمانی فعال';
          }
        }

        if (updatedLabel) {
          updatedLabel.textContent = dataset.generatedAt
            ? toPersianDateTime(dataset.generatedAt)
            : '—';
        }

        const totalValue = ensureNumber(dataset.summary?.total?.value, 0);
        updateStatus({ hasError: Boolean(usingFallback), isEmpty: totalValue <= 0 });
        if (errorBanner) {
          errorBanner.hidden = !usingFallback;
        }
      };

      const fetchIncomeData = async ({ start, end }) => {
        const base = (window.ADMIN_API_BASE || '').replace(/\/$/, '');
        const endpoint = base ? `${base}/admin/dashboard/income` : '/api/admin/dashboard/income';
        const params = new URLSearchParams();
        if (start) params.set('start', start);
        if (end) params.set('end', end);
        const url = params.toString() ? `${endpoint}?${params.toString()}` : endpoint;

        const response = await fetch(url, { credentials: 'include' });
        if (!response.ok) {
          const error = await response.text();
          throw new Error(error || 'خطا در دریافت داده‌های درآمد');
        }
        const payload = await response.json();
        return payload?.data || payload;
      };

      const loadData = async ({ reason } = {}) => {
        setLoading(true);
        const selectedStart = startInput?.value || null;
        const selectedEnd = endInput?.value || null;
        let dataset = createEmptyDataset();
        let usingFallback = false;

        try {
          const remoteData = await fetchIncomeData({ start: selectedStart, end: selectedEnd });
          dataset = normaliseData(remoteData);
        } catch (error) {
          console.warn('load income insights failed; no data will be displayed.', error);
          usingFallback = true;
        }

        if (!dataset.range) {
          dataset.range = { start: null, end: null };
        }
        if (!dataset.range.start && selectedStart) {
          dataset.range.start = selectedStart;
        }
        if (!dataset.range.end && selectedEnd) {
          dataset.range.end = selectedEnd;
        }

        applyData(dataset, { usingFallback });
        setLoading(false);

        if (usingFallback) {
          showToast('خطا در دریافت داده‌های درآمد. لطفاً اتصال را بررسی کنید.');
          return;
        }

        if (reason === 'filter') {
          showToast('فیلتر زمانی با موفقیت اعمال شد.');
        } else if (reason === 'refresh') {
          showToast('داشبورد درآمد بروزرسانی شد.');
        }
      };

      const init = () => {
        ensureCharts();

        updatePeriodView(createEmptyDataset());

        const now = new Date();
        const start = new Date(now);
        start.setDate(start.getDate() - 29);
        if (startInput) startInput.value = toInputDate(start);
        if (endInput) endInput.value = toInputDate(now);

        if (periodButtons.length) {
          periodButtons.forEach((button) => {
            button.addEventListener('click', () => {
              const periodKey = button.dataset.period;
              if (!periodKey || !PERIOD_CONFIG[periodKey] || state.period === periodKey) {
                return;
              }
              state.period = periodKey;
              updatePeriodView(state.data || createEmptyDataset());
            });
          });
        }

        if (form) {
          form.addEventListener('submit', (event) => {
            event.preventDefault();
            loadData({ reason: 'filter' });
          });
        }

        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => {
            loadData({ reason: 'refresh' });
          });
        }

        loadData({ reason: 'initial' });
      };

      init();
    })();
  </script>
</body>
</html>
