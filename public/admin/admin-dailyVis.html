<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta http-equiv="Strict-Transport-Security" content="max-age=63072000; includeSubDomains; preload">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="Referrer-Policy" content="no-referrer">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta name="referrer" content="no-referrer">
<meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>پنل مدیریت آمار بازدید روزانه | ویترینت</title>

  <!-- فونت -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: "Vazirmatn", sans-serif; }

    /* —— کارت‌های آمار —— */
    .stat-card {
      position: relative; display: flex; flex-direction: column; align-items: center;
      padding: 34px 20px 24px; background: #fff; border-radius: 1.3rem;
      box-shadow: 0 4px 16px rgba(16,185,129,.08); transition: .2s;
    }
    .stat-card:hover { box-shadow: 0 8px 34px rgba(14,165,233,.1); transform: translateY(-2px) scale(1.018); }
    .stat-card .icon {
      position: absolute; top: -30px; display: flex; align-items: center; justify-content: center;
      width: 56px; height: 56px; border-radius: 50%; padding: 12px; font-size: 30px;
      box-shadow: 0 2px 8px rgba(16,185,129,.08);
    }
    .stat-label { margin-top: 30px; font-size: 13px; font-weight: 700; color: #666; }
    .stat-value { direction: ltr; font-size: 2rem; font-weight: 700; margin-top: 4px; color: #1b2e26; letter-spacing: 1px; }
    .stat-growth { margin-top: 6px; font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 4px; color: #10b981; }
    .stat-growth.negative { color: #ef4444; }

    /* —— پنل فرم —— */
    .panel-card {
      background: #fff; border-radius: 1.3rem; width: 100% !important;
      max-width: none !important; min-width: 0 !important;
      box-shadow: 0 2px 18px rgba(14,165,233,.1);
      padding: 32px 26px; transition: .2s;
    }
    .panel-card:hover { box-shadow: 0 8px 24px rgba(14,165,233,.16); transform: translateY(-3px); }

    /* —— جدول —— */
    .product-table { width: 100%; background: #fff; border-radius: 1.3rem;
      box-shadow: 0 8px 32px rgba(16,185,129,.1); overflow: hidden; }
    .product-table table { width: 100%; border-collapse: collapse; }
    .product-table th, .product-table td { text-align: center; padding: 12px; font-size: 15px; }
    .product-table th { background: #d1fae5; color: #047857; font-weight: 800; }
    .product-table td { color: #333; border-bottom: 1px solid rgba(16,185,129,.1); }
    .product-table tr:hover { background: #e0fdfa; }
    @media(max-width:600px) { .product-table th, .product-table td { font-size: 13px; padding: 8px; } }

    /* —— FadeIn —— */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn .45s cubic-bezier(.36,1.32,.3,1) both; }

    /* —— جستجو و رتبه‌بندی —— */
    .search-input { transition: all 0.3s; }
    .search-input:focus { box-shadow: 0 0 0 3px rgba(16,185,129,.2); }
    .rank-badge { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: #10b981; color: white; font-weight: bold; font-size: 14px; }
    .rank-badge.silver { background: #a0a0a0; }
    .rank-badge.bronze { background: #cd7f32; }
    
    /* پاپ‌آپ آمار */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-container {
      background: #fff;
      border-radius: 1.5rem;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      max-width: 95%;
      width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(30px);
      transition: transform 0.4s ease, opacity 0.4s ease;
      opacity: 0;
    }
    
    .modal-overlay.active .modal-container {
      transform: translateY(0);
      opacity: 1;
    }
    
    .modal-header {
      background: linear-gradient(to right, #10b981, #0ea5e9);
      padding: 25px 30px;
      border-top-left-radius: 1.5rem;
      border-top-right-radius: 1.5rem;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    
    .close-modal {
      background: none;
      border: none;
      color: white;
      font-size: 1.8rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .close-modal:hover {
      transform: scale(1.2);
    }
    
    .modal-body {
      padding: 30px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .modal-stat-card {
      background: #f8fafc;
      border-radius: 1rem;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    
    .modal-stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
    }
    
    .modal-stat-label {
      font-size: 0.9rem;
      color: #64748b;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .modal-stat-value {
      font-size: 1.8rem;
      font-weight: 800;
      color: #1e293b;
      direction: ltr;
    }
    
    .tabs {
      display: flex;
      border-bottom: 2px solid #e2e8f0;
      margin-bottom: 20px;
    }
    
    .tab-btn {
      padding: 12px 24px;
      background: none;
      border: none;
      font-size: 1rem;
      font-weight: 700;
      color: #64748b;
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
    }
    
    .tab-btn.active {
      color: #10b981;
    }
    
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: #10b981;
      border-radius: 3px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .modal-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 1rem;
      overflow: hidden;
    }
    
    .modal-table th {
      background: #d1fae5;
      color: #047857;
      padding: 14px 16px;
      font-weight: 700;
      text-align: center;
    }
    
    .modal-table td {
      padding: 12px 16px;
      text-align: center;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .modal-table tr:hover {
      background-color: #f0fdf9;
    }
    
    .modal-footer {
      padding: 20px 30px;
      background: #f8fafc;
      border-bottom-left-radius: 1.5rem;
      border-bottom-right-radius: 1.5rem;
      text-align: center;
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .modal-header {
        padding: 20px;
      }
      
      .modal-header h2 {
        font-size: 1.3rem;
      }
      
      .modal-body {
        padding: 20px;
      }
      
      .tab-btn {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
    }
  </style>
  <script src="/nav-active.js" defer></script>

<!-- TODO: فعال‌سازی پست‌هاگ را هنگام انتشار فراموش نکنید | TODO: Enable PostHog analytics when going live -->
<!--
<script>
  (function () {
    var config = window.POSTHOG_CONFIG || { enabled: false, apiKey: 'phc_YOUR_KEY_HERE', apiHost: 'https://analytics.vitreenet.ir' };
    if (!config.enabled) {
      return; // فعال نیست | Not enabled yet
    }
    try {
      (function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")),p.type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js";(r=t.getElementsByTagName("script")[0]),r.parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:u=e,u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==u._i&&(e+="."+u._i),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"};n="capture identify alias people.set people.set_once people.unset people.increment people.append people.union people.remove people.clear_opt_out_outcome register register_once unregister opt_out_capturing opt_in_capturing has_opted_out_capturing reset isFeatureEnabled onFeatureFlags reloadFeatureFlags group".split(" ");for(o=0;o<n.length;o++)g(u,n[o]);e._i.push([i,s,a])},e.__SV=1.1)})(document, window.posthog || []);
      window.posthog.init(config.apiKey, { api_host: config.apiHost, capture_pageview: true, advanced_disable_decide: true });
    } catch (error) {
      console.warn('PostHog init failed (preview mode):', error);
    }
  })();
</script>
-->

</head>

<body class="bg-gradient-to-br from-[#e0fdfa] to-[#d4fbe8] min-h-screen pb-6 px-4 md:px-8">

  <div class="max-w-6xl mx-auto space-y-8 pt-6 md:pt-8 animate-fadeIn">

    <!-- هدر -->
    <header class="text-center">
      <h1 class="text-3xl md:text-4xl font-extrabold text-[#10b981] mb-3">
        پنل مدیریت حرفه‌ای آمار بازدید فروشندگان
      </h1>
      <p class="text-gray-600 text-base md:text-lg">
        جستجو، فیلتر، رتبه‌بندی و تحلیل دقیق آمار بازدید روزانه، هفتگی، ماهانه و سالانه
      </p>
    </header>

    <!-- بخش جستجو و فیلترها -->
    <div class="panel-card flex flex-col md:flex-row items-start gap-6">
      <!-- جستجو -->
      <div class="flex-1 flex flex-col gap-4">
        <h2 class="text-xl font-bold text-[#10b981] mb-6 text-center">
          جستجوی فروشنده یا فروشگاه
        </h2>
        <input id="searchInput" type="text" placeholder="نام فروشنده یا فروشگاه را وارد کنید..." 
               class="w-full p-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-[#10b981] text-lg search-input">
        <button id="searchBtn" class="w-full bg-[#10b981] hover:bg-[#0ea5e9] text-white rounded-2xl py-3 font-extrabold text-lg transition shadow-lg">
          جستجو
        </button>
      </div>

      <!-- فیلترها -->
      <div class="flex-1">
        <h2 class="text-xl font-bold text-[#10b981] mb-6 text-center">
          فیلترینگ پیشرفته
        </h2>
        <form id="filterForm" class="space-y-4">
          <div>
            <label for="periodSelect" class="block font-bold mb-2 text-[#10b981]">دوره زمانی:</label>
            <select id="periodSelect" class="w-full p-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-[#10b981] text-lg">
              <option value="week">هفته جاری</option>
              <option value="month">ماه جاری</option>
              <option value="year">سال جاری</option>
              <option value="custom">سفارشی (تاریخ از/تا)</option>
              <option value="">کل آمار</option>
            </select>
          </div>

          <div id="customDateFields" class="hidden space-y-4">
            <div>
              <label for="fromDate" class="block font-bold mb-2 text-[#10b981]">از تاریخ:</label>
              <input id="fromDate" type="date" class="w-full p-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-[#10b981] text-lg">
            </div>
            <div>
              <label for="toDate" class="block font-bold mb-2 text-[#10b981]">تا تاریخ:</label>
              <input id="toDate" type="date" class="w-full p-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-[#10b981] text-lg">
            </div>
          </div>

          <button type="submit" class="w-full bg-[#10b981] hover:bg-[#0ea5e9] text-white rounded-2xl py-3 font-extrabold text-lg transition shadow-lg">
            اعمال فیلتر
          </button>
        </form>
      </div>
    </div>

    <!-- رتبه‌بندی فروشندگان -->
    <div class="product-table">
      <h2 class="text-xl font-bold text-[#10b981] mb-4 text-center">
        رتبه‌بندی فروشندگان بر اساس مجموع بازدیدها (از بیشترین به کمترین)
      </h2>
      <table>
        <thead><tr><th>رتبه</th><th>نام فروشنده</th><th>نام فروشگاه</th><th>مجموع بازدیدها</th><th>عملیات</th></tr></thead>
        <tbody id="rankingTableBody">
          <!-- داده‌ها با اسکریپت پر می‌شوند -->
        </tbody>
      </table>
    </div>
    
    <!-- پاپ‌آپ نمایش آمار -->
    <div class="modal-overlay" id="statsModal">
      <div class="modal-container">
        <div class="modal-header">
          <h2 id="modalTitle">آمار بازدید فروشنده</h2>
          <button class="close-modal">&times;</button>
        </div>
        
        <div class="modal-body">
          <div class="stats-grid">
            <div class="modal-stat-card">
              <div class="modal-stat-label">بازدید امروز</div>
              <div class="modal-stat-value" id="modalToday">0</div>
            </div>
            
            <div class="modal-stat-card">
              <div class="modal-stat-label">بازدید این هفته</div>
              <div class="modal-stat-value" id="modalWeek">0</div>
            </div>
            
            <div class="modal-stat-card">
              <div class="modal-stat-label">بازدید این ماه</div>
              <div class="modal-stat-value" id="modalMonth">0</div>
            </div>
            
            <div class="modal-stat-card">
              <div class="modal-stat-label">بازدید این سال</div>
              <div class="modal-stat-value" id="modalYear">0</div>
            </div>
            
            <div class="modal-stat-card">
              <div class="modal-stat-label">کل بازدیدها</div>
              <div class="modal-stat-value" id="modalTotal">0</div>
            </div>
          </div>
          
          <div class="tabs">
            <button class="tab-btn active" data-tab="daily">روزانه</button>
            <button class="tab-btn" data-tab="monthly">ماهانه</button>
            <button class="tab-btn" data-tab="yearly">سالانه</button>
          </div>
          
          <div class="tab-content active" id="dailyTab">
            <table class="modal-table">
              <thead>
                <tr>
                  <th>تاریخ</th>
                  <th>تعداد بازدید</th>
                </tr>
              </thead>
              <tbody id="modalDailyBody">
                <!-- داده‌ها با اسکریپت پر می‌شوند -->
              </tbody>
            </table>
          </div>
          
          <div class="tab-content" id="monthlyTab">
            <table class="modal-table">
              <thead>
                <tr>
                  <th>ماه</th>
                  <th>مجموع بازدید</th>
                </tr>
              </thead>
              <tbody id="modalMonthlyBody">
                <!-- داده‌ها با اسکریپت پر می‌شوند -->
              </tbody>
            </table>
          </div>
          
          <div class="tab-content" id="yearlyTab">
            <table class="modal-table">
              <thead>
                <tr>
                  <th>سال</th>
                  <th>مجموع بازدید</th>
                </tr>
              </thead>
              <tbody id="modalYearlyBody">
                <!-- داده‌ها با اسکریپت پر می‌شوند -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="bg-[#10b981] hover:bg-[#0ea5e9] text-white rounded-xl py-2 px-6 font-bold transition">
            دانلود گزارش کامل
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- اسکریپت -->
  <script>
    /* admin-dailyVis.js – پنل مدیریت حرفه‌ای با جستجو، رتبه‌بندی و فیلترینگ */
    (() => {
      /* ─── ثابت‌ها ─── */
      const VISITS_API = '/api/daily-visits';
      const SELLERS_API = '/api/daily-visits/sellers';
      const LS_KEY_VISITS = 'adminVisits';
      const LS_KEY_SELLERS = 'adminSellers';

      /* ─── ابزارک‌ها ─── */
      const $ = id => document.getElementById(id);
      const toFa = n => (+n || 0).toLocaleString('fa-IR');

      /* تاریخ محلی به ‎YYYY‑MM‑DD */
      const localISO = d => {
        const z = new Date(d.getTime() - d.getTimezoneOffset() * 6e4);
        return z.toISOString().split('T')[0];
      };
      const todayStr = () => localISO(new Date());
      const monthKey = dStr => dStr.slice(0, 7);  /* YYYY-MM */
      const yearKey = dStr => dStr.slice(0, 4);   /* YYYY */

      let allVisits = [];
      let sellers = [];
      let selectedSellerId = null;
      let currentFilters = {};

      /* ─── لود فروشندگان ─── */
      async function loadSellers() {
        try {
          const res = await fetch(SELLERS_API, { credentials: 'include' });
          if (!res.ok) {
            const errMsg = await res.json();
            console.error('خطا در لود فروشندگان:', errMsg.message);
            throw new Error(res.status);
          }
          sellers = await res.json();
          localStorage.setItem(LS_KEY_SELLERS, JSON.stringify(sellers));
        } catch (err) {
          console.warn('خطا در لود فروشندگان', err);
          sellers = JSON.parse(localStorage.getItem(LS_KEY_SELLERS) || '[]');
          alert('خطا در بارگیری لیست فروشندگان. لطفاً لاگین کنید یا اتصال را چک کنید.');
        }
      }

      /* ─── لود بازدیدها ─── */
      async function loadVisits(filters = {}) {
        try {
          const params = new URLSearchParams(filters);
          const res = await fetch(`${VISITS_API}?${params}`, { credentials: 'include' });
          if (!res.ok) {
            const errMsg = await res.json();
            console.error('خطا در لود بازدیدها:', errMsg.message);
            throw new Error(res.status);
          }
          const data = await res.json();
          allVisits = data.map(v => ({
            date: localISO(new Date(v.date)),
            count: v.count,
            sellerId: v.sellerId
          }));
          localStorage.setItem(LS_KEY_VISITS, JSON.stringify(allVisits));
        } catch (err) {
          console.warn('⏯️  استفاده از localStorage', err);
          allVisits = JSON.parse(localStorage.getItem(LS_KEY_VISITS) || '[]');
          alert('خطا در بارگیری آمار بازدید. ممکن است مجوز کافی نداشته باشید.');
        }
      }

      /* ─── محاسبه مجموع بازدید هر فروشنده ─── */
      function calculateSellerTotals(visits) {
        const totals = {};
        visits.forEach(v => {
          totals[v.sellerId] = (totals[v.sellerId] || 0) + v.count;
        });
        return sellers.map(s => ({
          ...s,
          totalVisits: totals[s.id] || 0
        })).sort((a, b) => b.totalVisits - a.totalVisits);  // سورت از بیشترین به کمترین
      }

      /* ─── رندر رتبه‌بندی ─── */
      function renderRanking(sellerTotals, searchTerm = '') {
        const tbody = $('rankingTableBody');
        tbody.innerHTML = '';

        const filtered = sellerTotals.filter(s =>
          (s.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
          (s.storeName || '').toLowerCase().includes(searchTerm.toLowerCase())
        );

        filtered.forEach((s, index) => {
          const rank = index + 1;

          /* کلاس مدال‌ها */
          let badgeClass = 'rank-badge bg-gray-400';
          if (rank === 1) badgeClass = 'rank-badge';
          else if (rank === 2) badgeClass = 'rank-badge silver';
          else if (rank === 3) badgeClass = 'rank-badge bronze';

          /* ساخت ردیف */
          const tr       = document.createElement('tr');
          tr.innerHTML = `
            <td><span class="${badgeClass}">${toFa(rank)}</span></td>
            <td>${s.name || 'نامشخص'}</td>
            <td>${s.storeName || 'نامشخص'}</td>
            <td>${toFa(s.totalVisits)}</td>
            <td>
              <button class="view-btn bg-[#10b981] text-white px-4 py-2 rounded-lg hover:bg-[#0ea5e9] transition"
                      data-seller="${s.id}" data-name="${s.name || ''}" data-store="${s.storeName || ''}">
                مشاهده آمار
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        /* ─── وصل کردن کلیک بعد از اضافه شدن ردیف‌ها ─── */
        tbody.querySelectorAll('.view-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-seller');
            const name = btn.getAttribute('data-name');
            const store = btn.getAttribute('data-store');
            showSellerStats(id, name, store);
          });
        });
      }

      /* ─── نمایش پاپ‌آپ آمار فروشنده ─── */
      function showSellerStats(sellerId, name, store) {
        selectedSellerId = sellerId;
        
        // تنظیم عنوان پاپ‌آپ
        const title = `آمار بازدید ${name || 'فروشنده'}${store ? ` (${store})` : ''}`;
        $('modalTitle').textContent = title;
        
        // محاسبه آمار فروشنده
        const sellerVisits = allVisits.filter(v => v.sellerId === sellerId);
        
        // محاسبه آمار کلی
        const total = sellerVisits.reduce((s, v) => s + v.count, 0);
        const today = sellerVisits.find(v => v.date === todayStr())?.count || 0;
        
        const weekAgo = localISO(new Date(Date.now() - 7 * 864e5));
        const weekSum = sellerVisits.filter(v => v.date >= weekAgo).reduce((s, v) => s + v.count, 0);
        
        const monthStart = localISO(new Date(new Date().getFullYear(), new Date().getMonth(), 1));
        const monthSum = sellerVisits.filter(v => v.date >= monthStart).reduce((s, v) => s + v.count, 0);
        
        const yearStart = localISO(new Date(new Date().getFullYear(), 0, 1));
        const yearSum = sellerVisits.filter(v => v.date >= yearStart).reduce((s, v) => s + v.count, 0);
        
        // نمایش آمار در پاپ‌آپ
        $('modalToday').textContent = toFa(today);
        $('modalWeek').textContent = toFa(weekSum);
        $('modalMonth').textContent = toFa(monthSum);
        $('modalYear').textContent = toFa(yearSum);
        $('modalTotal').textContent = toFa(total);
        
        // پر کردن جداول
        renderModalDailyTable(sellerVisits);
        renderModalMonthlyTable(sellerVisits);
        renderModalYearlyTable(sellerVisits);
        
        // نمایش پاپ‌آپ
        $('statsModal').classList.add('active');
      }
      
      /* ─── رندر جدول روزانه در پاپ‌آپ ─── */
      function renderModalDailyTable(visits) {
        const tbody = $('modalDailyBody');
        tbody.innerHTML = '';
        visits.sort((a, b) => b.date.localeCompare(a.date)).forEach(v => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${new Date(v.date).toLocaleDateString('fa-IR')}</td><td>${toFa(v.count)}</td>`;
          tbody.appendChild(tr);
        });
      }
      
      /* ─── رندر جدول ماهانه در پاپ‌آپ ─── */
      function renderModalMonthlyTable(visits) {
        const tbody = $('modalMonthlyBody');
        tbody.innerHTML = '';
        const groups = {};
        visits.forEach(v => {
          const k = monthKey(v.date);
          groups[k] = (groups[k] || 0) + v.count;
        });
        Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0])).forEach(([m, cnt]) => {
          const [y, mon] = m.split('-');
          const faDate = new Intl.DateTimeFormat('fa-IR', { year: 'numeric', month: 'long' }).format(new Date(y, mon - 1, 1));
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${faDate}</td><td>${toFa(cnt)}</td>`;
          tbody.appendChild(tr);
        });
      }
      
      /* ─── رندر جدول سالانه در پاپ‌آپ ─── */
      function renderModalYearlyTable(visits) {
        const tbody = $('modalYearlyBody');
        tbody.innerHTML = '';
        const groups = {};
        visits.forEach(v => {
          const k = yearKey(v.date);
          groups[k] = (groups[k] || 0) + v.count;
        });
        Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0])).forEach(([y, cnt]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${toFa(y)}</td><td>${toFa(cnt)}</td>`;
          tbody.appendChild(tr);
        });
      }

      /* ─── هندلر جستجو ─── */
      $('searchBtn').addEventListener('click', () => {
        const searchTerm = $('searchInput').value.trim();
        const sellerTotals = calculateSellerTotals(allVisits);
        renderRanking(sellerTotals, searchTerm);
      });

      /* ─── هندلر فیلتر ─── */
      $('filterForm').addEventListener('submit', async e => {
        e.preventDefault();
        const period = $('periodSelect').value;
        let from, to;

        if (period === 'week') {
          from = localISO(new Date(Date.now() - 7 * 864e5));
          to = todayStr();
        } else if (period === 'month') {
          const d = new Date();
          from = localISO(new Date(d.getFullYear(), d.getMonth(), 1));
          to = todayStr();
        } else if (period === 'year') {
          const d = new Date();
          from = localISO(new Date(d.getFullYear(), 0, 1));
          to = todayStr();
        } else if (period === 'custom') {
          from = $('fromDate').value;
          to = $('toDate').value;
          if (!from || !to) return alert('تاریخ‌ها را وارد کنید!');
        }

        currentFilters = { from, to };
        await loadVisits(currentFilters);
        const sellerTotals = calculateSellerTotals(allVisits);
        renderRanking(sellerTotals);
      });

      /* ─── هندلر نمایش فیلدهای سفارشی ─── */
      $('periodSelect').addEventListener('change', e => {
        $('customDateFields').classList.toggle('hidden', e.target.value !== 'custom');
      });
      
      /* ─── مدیریت تب‌های پاپ‌آپ ─── */
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // حذف کلاس active از همه تب‌ها
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // اضافه کردن کلاس active به تب انتخاب شده
          btn.classList.add('active');
          const tabId = btn.getAttribute('data-tab') + 'Tab';
          $(tabId).classList.add('active');
        });
      });
      
      /* ─── بستن پاپ‌آپ ─── */
      $('statsModal').addEventListener('click', (e) => {
        if (e.target === $('statsModal') || e.target.classList.contains('close-modal')) {
          $('statsModal').classList.remove('active');
        }
      });

      /* ─── شروع ─── */
      (async () => {
        await loadSellers();
        await loadVisits();
        const sellerTotals = calculateSellerTotals(allVisits);
        renderRanking(sellerTotals);
        
        // ایجاد داده‌های نمونه برای نمایش
        setTimeout(() => {
          if (sellers.length === 0) {
            sellers = [
              {id: '1', name: 'رضا محمدی', storeName: 'فروشگاه الکترونیک رضوان'},
              {id: '2', name: 'سارا احمدی', storeName: 'لوازم خانگی سارینا'},
              {id: '3', name: 'علی کریمی', storeName: 'پوشاک مدرن'},
              {id: '4', name: 'زهرا حسینی', storeName: 'آرایشی بهداشتی زهرا'},
              {id: '5', name: 'محمدرضا فلاحی', storeName: 'کتابفروشی دانش'}
            ];
            
            const now = new Date();
            allVisits = [];
            
            // ایجاد داده‌های نمونه برای بازدیدها
            for (let i = 0; i < 180; i++) {
              const date = new Date(now.getTime() - i * 86400000);
              const dateStr = localISO(date);
              
              sellers.forEach(seller => {
                // بازدید تصادفی بین 10 تا 200
                const count = Math.floor(Math.random() * 190) + 10;
                allVisits.push({
                  date: dateStr,
                  count: count,
                  sellerId: seller.id
                });
              });
            }
            
            const sellerTotals = calculateSellerTotals(allVisits);
            renderRanking(sellerTotals);
          }
        }, 500);
      })();
    })();
  </script>

<!-- TODO: افزودن رویدادهای PostHog پس از فعال‌سازی | TODO: Enable PostHog events after activation -->
<!--
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const safeCapture = window.safePosthogCapture || function () {};
    // safeCapture('event_name', { /* داده‌های تکمیلی */ });
  });
</script>
-->

</body>
</html>
