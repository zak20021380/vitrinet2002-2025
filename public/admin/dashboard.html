<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>داشبورد مدیریت | ویترینت</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
:root {
  --primary: #10b981;
  --secondary: #0ea5e9;
  --warning: #eab308;
  --bg: #f6faf9;
  --card: #fff;
  --text: #20262d;
  --border: #e5e7eb;
  --shadow: 0 6px 30px #10b98116;
  --sidebar-width: 220px;
  --radius: 20px;
  --transition: .18s cubic-bezier(.45,.8,.4,1);
}

html, body {
  font-family: 'Vazirmatn', Tahoma, sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  height: 100%;
  scroll-behavior: smooth;
  font-size: 16px;
}

body { 
  min-height: 100vh;
  overflow-x: hidden;
}

.dashboard-container { 
  display: flex; 
  min-height: 100vh; 
}

/* Sidebar - بهبود یافته */
.sidebar {
  width: var(--sidebar-width);
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow);
  display: flex; 
  flex-direction: column;
  min-height: 100vh; 
  padding: 0;
  z-index: 100; 
  position: relative;
  transition: transform var(--transition), width var(--transition);
  border-left: 1px solid var(--border);
}

.sidebar-header {
  font-weight: bold; 
  font-size: 1.27rem;
  color: var(--primary); 
  padding: 1.7rem 1.3rem 0.9rem 1.3rem;
  border-bottom: 1px solid var(--border);
  letter-spacing: 1px;
}

.sidebar-menu { 
  display: flex; 
  flex-direction: column; 
  gap: 0.3rem; 
  padding: 1.1rem 0; 
  flex: 1; 
}

.sidebar-menu a {
  display: flex; 
  align-items: center; 
  gap: 0.7rem;
  padding: 0.8rem 1.4rem 0.8rem 1rem;
  text-decoration: none; 
  color: var(--text);
  border-radius: 0 var(--radius) var(--radius) 0;
  font-size: 1rem; 
  font-weight: 500; 
  background: none;
  cursor: pointer; 
  transition: background var(--transition), color var(--transition);
  border-right: 4px solid transparent; 
  position: relative;
}

.sidebar-menu a .count {
  background: var(--primary); 
  color: #fff;
  border-radius: 10px; 
  font-size: 0.85rem; 
  padding: 0.2rem 0.6rem;
  margin-right: 0.5rem; 
  font-weight: bold; 
  min-width: 1.8rem;
  text-align: center; 
  display: inline-block; 
  box-shadow: 0 2px 8px #10b98113;
}

.sidebar-menu a.active,
.sidebar-menu a:hover {
  background: var(--primary);
  color: #fff;
  border-right: 4px solid var(--secondary);
}

.sidebar-menu a.active .count,
.sidebar-menu a:hover .count {
  background: #fff; 
  color: var(--primary);
}

.sidebar-menu a i { 
  font-size: 1.25em; 
  opacity: .8; 
  min-width: 1.8rem;
}

.sidebar-footer {
  font-size: 0.85rem; 
  color: #aaa;
  padding: 1rem 0.6rem; 
  border-top: 1px solid var(--border);
  text-align: center; 
  background: inherit;
}

/* Main Content */
.main-content {
  flex: 1; 
  padding: 2rem 1.9rem 1.6rem 0.8rem;
  background: var(--bg);
  display: flex; 
  flex-direction: column;
  min-height: 100vh;
  transition: padding var(--transition);
}

.content-header {
  font-size: 1.25rem; 
  font-weight: bold;
  color: var(--primary); 
  margin-bottom: 1.2rem;
  text-align: right; 
  letter-spacing: .4px;
  display: flex; 
  align-items: center; 
  gap: 0.8rem;
  flex-wrap: wrap;
}

.header-count {
  color: #888; 
  font-size: 1em; 
  font-weight: normal;
  background: #eafaf4; 
  border-radius: 8px; 
  padding: 0.1rem 0.8rem; 
  margin-right: 0.1rem;
}

/* Cards - بهبود یافته برای موبایل */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 0.9rem; 
  margin-bottom: 1.6rem;
}

.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 1.2rem;
  min-height: 95px;
  display: flex; 
  align-items: center; 
  gap: 0.8rem;
  font-size: 1rem;
  border: 1px solid var(--border);
  transition: box-shadow var(--transition), border var(--transition), background var(--transition);
  position: relative;
  user-select: none;
  cursor: pointer;
}

.card .icon {
  font-size: 1.4rem;
  color: var(--primary);
  background: #e6fff7;
  border-radius: 12px;
  padding: 0.45rem; 
  margin-left: 0.4rem;
  box-shadow: 0 2px 6px #10b98113;
  display: flex; 
  align-items: center; 
  justify-content: center;
  min-width: 2.5rem; 
  min-height: 2.5rem;
  transition: background var(--transition);
}

.card .num {
  font-size: 1.2rem; 
  font-weight: bold; 
  color: var(--text);
}

.card .label {
  font-size: 0.92rem; 
  color: #888; 
  margin-top: 0.1rem;
}

.card:hover { 
  background: #e6fff7; 
  box-shadow: 0 8px 25px #10b9811a;
}

/* Dashboard charts grid */
.dashboard-charts {
  display: grid; 
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem; 
  margin-bottom: 1.5rem;
}

.dashboard-charts .chart-card {
  background: var(--card); 
  border-radius: var(--radius); 
  box-shadow: var(--shadow);
  padding: 1.2rem 0.6rem 0.5rem 0.6rem; 
  border: 1px solid var(--border);
  min-height: 11rem; 
  direction: ltr;
  user-select: none; 
  cursor: pointer;
  transition: background .12s;
}

.dashboard-charts .chart-card:hover { 
  background: #f6fffa; 
  box-shadow: 0 8px 25px #10b9811a;
}

.chart-title {
  color: var(--primary); 
  font-size: 0.95rem; 
  margin-bottom: 0.5rem;
  direction: rtl; 
  text-align: right; 
  font-weight: bold; 
  letter-spacing: .3px;
  padding: 0 0.5rem;
}

/* Table - بهبود یافته */
.table-wrap {
  background: var(--card); 
  border-radius: var(--radius); 
  box-shadow: var(--shadow);
  padding: 0.9rem 0.2rem 0.4rem 0.2rem; 
  margin-bottom: 1.5rem; 
  overflow-x: auto; 
  border: 1px solid var(--border);
}

table {
  border-collapse: collapse; 
  width: 100%; 
  min-width: 350px; 
  background: inherit; 
  color: inherit; 
  font-size: 0.88rem; 
  direction: rtl;
}

th, td { 
  text-align: right; 
  padding: 0.5rem 0.6rem; 
  border-bottom: 1px solid #f3f4f6; 
}

th { 
  background: #f3f4f6; 
  font-weight: bold; 
  color: #444; 
  font-size: 0.92rem;
}

tr:last-child td { 
  border-bottom: none; 
}

.action-btn {
  border: none; 
  outline: none; 
  cursor: pointer; 
  border-radius: 8px;
  padding: 0.3rem 0.8rem; 
  margin-left: 0.2rem; 
  font-size: 0.92rem;
  background: #f4f4f4; 
  color: var(--primary);
  transition: background .14s, color .14s;
  min-height: 2.4rem;
  min-width: 4rem;
}

.action-btn.edit { 
  background: #e0f2fe; 
  color: var(--secondary); 
}

.action-btn.delete { 
  background: #ffe4e6; 
  color: #ef4444; 
}

.action-btn.delete:hover { 
  background: #ef4444; 
  color: #fff; 
}

.action-btn.edit:hover { 
  background: #0ea5e9; 
  color: #fff; 
}

/* Card view for tables on mobile - بهبود یافته */
.table-cards {
  display: none;
  flex-direction: column;
  gap: 1rem;
  margin-bottom: 1.6rem;
}

.table-card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 1.3rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.table-card-row {
  display: flex;
  justify-content: space-between;
  padding: 0.6rem 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.95rem;
}

.table-card-row:last-child {
  border-bottom: none;
}

.table-card-label {
  font-weight: bold;
  color: #555;
  min-width: 7rem;
}

.table-card-value {
  text-align: left;
  flex: 1;
}

.table-card-actions {
  display: flex;
  gap: 0.6rem;
  margin-top: 1rem;
  justify-content: flex-end;
}

/* Ad orders management */
.ad-orders-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1rem;
  margin-bottom: 1.4rem;
}

.ad-overview-card {
  background: #fff;
  border-radius: 16px;
  padding: 1rem 1.2rem;
  box-shadow: 0 10px 25px rgba(16, 185, 129, 0.08);
  border: 1px solid rgba(16, 185, 129, 0.12);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.ad-overview-card .label {
  font-size: 0.85rem;
  color: #64748b;
  font-weight: 600;
  margin-bottom: 0.4rem;
}

.ad-overview-card .value {
  font-size: 1.6rem;
  font-weight: 900;
  color: #0f172a;
}

.ad-overview-card.pending {
  background: linear-gradient(135deg, #fef3c7, #fff);
  border-color: #facc15;
}

.ad-overview-card.pending .value {
  color: #d97706;
}

.ad-overview-card.approved {
  background: linear-gradient(135deg, #dcfce7, #fff);
  border-color: #34d399;
}

.ad-overview-card.approved .value {
  color: #059669;
}

.ad-orders-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
}

.ad-orders-toolbar .filters {
  display: flex;
  gap: 0.6rem;
  flex-wrap: wrap;
}

.ad-filter-btn {
  border: none;
  padding: 0.55rem 1.1rem;
  border-radius: 999px;
  background: #f1f5f9;
  color: #475569;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
}

.ad-filter-btn i {
  font-size: 1.1rem;
}

.ad-filter-btn:hover {
  background: #e2e8f0;
  color: #0ea5e9;
}

.ad-filter-btn.active {
  background: linear-gradient(135deg, #10b981, #0ea5e9);
  color: #fff;
  box-shadow: 0 6px 20px rgba(14, 165, 233, 0.2);
}

.ad-orders-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  align-items: center;
  justify-content: flex-end;
}

#adOrdersPlanFilter {
  border: 1px solid #dbeafe;
  background: #eff6ff;
  color: #0f172a;
  border-radius: 12px;
  padding: 0.55rem 1rem;
  font-weight: 600;
  min-width: 160px;
}

.ad-orders-search {
  border: 1px solid #e2e8f0;
  border-radius: 14px;
  padding: 0.55rem 1rem;
  min-width: 220px;
  font-size: 0.95rem;
  background: #fff;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

.ad-orders-search:focus {
  border-color: #0ea5e9;
  box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15);
  outline: none;
}

#adOrdersRefresh {
  background: linear-gradient(135deg, #10b981, #0ea5e9);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 0.55rem 1.1rem;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  cursor: pointer;
  box-shadow: 0 10px 20px rgba(16, 185, 129, 0.18);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

#adOrdersRefresh:hover {
  transform: translateY(-1px);
  box-shadow: 0 12px 24px rgba(14, 165, 233, 0.25);
}

#adOrdersRefresh:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  box-shadow: none;
}

.ad-orders-status {
  display: none;
  padding: 0.75rem 1rem;
  border-radius: 12px;
  font-weight: 600;
  margin-bottom: 1rem;
}

.ad-orders-status.info {
  background: #eff6ff;
  color: #2563eb;
}

.ad-orders-status.success {
  background: #dcfce7;
  color: #047857;
}

.ad-orders-status.error {
  background: #fee2e2;
  color: #b91c1c;
}

.ad-orders-table table thead th {
  background: #f8fafc;
  font-weight: 800;
  color: #0f172a;
  font-size: 0.92rem;
}

.ad-orders-table table tbody td {
  vertical-align: top;
  padding: 0.95rem 0.75rem;
  font-size: 0.92rem;
  color: #475569;
}

.ad-orders-table .ad-cell-primary {
  font-weight: 800;
  color: #0f172a;
  margin-bottom: 0.2rem;
}

.ad-orders-table .ad-cell-secondary {
  font-size: 0.82rem;
  color: #94a3b8;
  display: flex;
  gap: 0.6rem;
  flex-wrap: wrap;
}

.ad-orders-table .ad-plan-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  background: linear-gradient(135deg, #ecfeff, #f0fdf4);
  color: #0f766e;
  font-weight: 700;
  padding: 0.3rem 0.75rem;
  border-radius: 999px;
  margin-bottom: 0.35rem;
  border: 1px solid rgba(16, 185, 129, 0.25);
}

.ad-orders-table .ad-plan-location {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  font-size: 0.82rem;
  color: #0284c7;
  background: rgba(14, 165, 233, 0.08);
  padding: 0.25rem 0.6rem;
  border-radius: 999px;
  border: 1px solid rgba(14, 165, 233, 0.18);
  margin-bottom: 0.35rem;
}

.ad-orders-table .ad-plan-location i {
  font-size: 1rem;
}

.ad-orders-table .ad-title {
  font-weight: 700;
  color: #0f172a;
  margin-bottom: 0.2rem;
}

.ad-orders-table .ad-text {
  font-size: 0.85rem;
  color: #64748b;
}

.ad-orders-table .ad-price {
  font-weight: 800;
  color: #047857;
  font-size: 1.05rem;
}

.ad-orders-table .ad-date {
  font-size: 0.84rem;
  color: #64748b;
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
}

.ad-orders-table .ad-date span {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
}

.ad-orders-table .ad-date span i {
  color: #0ea5e9;
}

.ad-orders-table .ad-date .ad-date-live i {
  color: #10b981;
}

.ad-orders-table .ad-date .ad-date-pending {
  color: #94a3b8;
}

.ad-orders-table .ad-date .ad-date-pending i {
  color: #f59e0b;
}

.ad-orders-table .ad-status-cell {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}

.ad-status-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  border-radius: 999px;
  padding: 0.35rem 0.9rem;
  font-weight: 800;
  font-size: 0.82rem;
}

.ad-status-badge i {
  font-size: 1rem;
}

.ad-status-badge.pending {
  background: #fff7ed;
  color: #d97706;
  border: 1px solid rgba(245, 158, 11, 0.35);
}

.ad-status-badge.approved {
  background: #dcfce7;
  color: #047857;
  border: 1px solid rgba(22, 163, 74, 0.35);
}

.ad-status-badge.rejected {
  background: #fee2e2;
  color: #b91c1c;
  border: 1px solid rgba(239, 68, 68, 0.35);
}

.ad-status-badge.paid {
  background: #e0f2fe;
  color: #0369a1;
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.ad-status-badge.expired {
  background: #f1f5f9;
  color: #475569;
  border: 1px solid rgba(148, 163, 184, 0.35);
}

.ad-status-note {
  font-size: 0.78rem;
  color: #94a3b8;
}

.ad-status-note strong {
  color: #475569;
}

.ad-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: flex-start;
}

.ad-action-btn {
  border: none;
  border-radius: 10px;
  padding: 0.45rem 0.85rem;
  font-weight: 700;
  font-size: 0.85rem;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  text-decoration: none;
}

.ad-action-btn i {
  font-size: 1rem;
}

.ad-action-btn.ghost {
  background: #f8fafc;
  color: #0f172a;
  border: 1px solid rgba(15, 23, 42, 0.08);
}

.ad-action-btn.ghost:hover {
  background: #e2e8f0;
}

.ad-action-btn.approve {
  background: linear-gradient(135deg, #10b981, #0ea5e9);
  color: #fff;
  box-shadow: 0 10px 24px rgba(14, 165, 233, 0.25);
}

.ad-action-btn.approve:hover {
  transform: translateY(-1px);
}

.ad-action-btn.reject {
  background: #fee2e2;
  color: #b91c1c;
}

.ad-action-btn.reject:hover {
  background: #fecaca;
}

.ad-action-btn.link {
  background: #e0f2fe;
  color: #0369a1;
  border: 1px solid rgba(14, 165, 233, 0.2);
}

.ad-action-btn.link:hover {
  background: #bae6fd;
}

.ad-orders-table table tbody tr.ad-order-row {
  cursor: pointer;
  transition: background 0.2s ease;
}

.ad-orders-table table tbody tr.ad-order-row:hover {
  background: #f8fafc;
}

.ad-orders-table table tbody tr.ad-order-row:hover .ad-title {
  color: #0ea5e9;
}

.ad-action-btn.is-loading {
  opacity: 0.7;
  pointer-events: none;
}

.ad-action-btn.is-loading i {
  animation: spin 1s linear infinite;
}

.ad-orders-table .empty-row {
  text-align: center;
  color: #94a3b8;
  font-weight: 600;
}

.ad-orders-table .loading-row {
  text-align: center;
  color: #0ea5e9;
  font-weight: 700;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

@media (max-width: 1024px) {
  .ad-orders-toolbar {
    flex-direction: column;
    align-items: flex-start;
  }

  .ad-orders-controls {
    width: 100%;
    justify-content: space-between;
  }

  .ad-orders-search {
    flex: 1;
    min-width: 0;
    width: 100%;
  }

  #adOrdersPlanFilter {
    flex: 1;
    min-width: 0;
  }
}

@media (max-width: 640px) {
  .ad-orders-controls {
    flex-direction: column;
    align-items: stretch;
  }

  #adOrdersPlanFilter,
  .ad-orders-search,
  #adOrdersRefresh {
    width: 100%;
  }

  .ad-actions {
    flex-direction: column;
    align-items: stretch;
  }

  .ad-action-btn {
    justify-content: center;
  }

  .ad-modal-visit {
    justify-content: center;
  }
}

.ad-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.52);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(6px);
  padding: 1.5rem;
}

.ad-modal {
  background: #fff;
  border-radius: 20px;
  width: min(720px, 96vw);
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 24px 70px rgba(15, 118, 110, 0.25);
  animation: fadeIn 0.3s ease;
  padding: 1.8rem;
  position: relative;
}

.ad-modal-close {
  position: absolute;
  top: 1.1rem;
  left: 1.1rem;
  border: none;
  background: #ecfeff;
  color: #0ea5e9;
  border-radius: 12px;
  font-size: 1.4rem;
  width: 40px;
  height: 40px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s ease, color 0.2s ease;
}

.ad-modal-close:hover {
  background: #0ea5e9;
  color: #fff;
}

.ad-modal-title {
  font-size: 1.4rem;
  font-weight: 900;
  color: #0f172a;
  margin-bottom: 1.2rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.ad-modal-title .badge {
  background: #ecfeff;
  color: #0ea5e9;
  padding: 0.25rem 0.75rem;
  border-radius: 999px;
  font-size: 0.85rem;
  font-weight: 700;
}

.ad-modal-visit {
  margin: -0.4rem 0 1.2rem;
  display: flex;
  justify-content: flex-start;
}

.ad-modal-visit a {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  background: #e0f2fe;
  color: #0369a1;
  padding: 0.4rem 0.95rem;
  border-radius: 999px;
  font-weight: 700;
  text-decoration: none;
  border: 1px solid rgba(14, 165, 233, 0.2);
  transition: background 0.2s ease;
}

.ad-modal-visit a:hover {
  background: #bae6fd;
}

.ad-modal-visit i {
  font-size: 1.1rem;
}

.ad-modal-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1.2rem;
  margin-bottom: 1.4rem;
}

.ad-modal-section {
  background: #f8fafc;
  border-radius: 16px;
  padding: 1rem 1.2rem;
  border: 1px solid rgba(148, 163, 184, 0.2);
}

.ad-modal-section h4 {
  margin: 0 0 0.6rem;
  font-size: 0.95rem;
  color: #0f172a;
  font-weight: 800;
}

.ad-modal-meta {
  display: grid;
  gap: 0.55rem;
  font-size: 0.9rem;
  color: #475569;
}

.ad-modal-meta span {
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

.ad-modal-meta .label {
  font-weight: 700;
  color: #0f172a;
}

.ad-modal-meta span a {
  color: #0ea5e9;
  text-decoration: none;
  font-weight: 700;
}

.ad-modal-meta span a:hover {
  text-decoration: underline;
}

.ad-modal-preview {
  background: #fff;
  border: 1px solid rgba(15, 118, 110, 0.14);
  border-radius: 16px;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  box-shadow: 0 12px 30px rgba(16, 185, 129, 0.12);
}

.ad-modal-preview .banner {
  width: 100%;
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid rgba(14, 165, 233, 0.15);
  background: #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 160px;
}

.ad-modal-preview .banner img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.ad-modal-preview .ad-text {
  font-size: 0.95rem;
  color: #475569;
  line-height: 1.9;
}

.ad-modal-edit {
  margin-top: 1.2rem;
  background: #f8fafc;
  border: 1px solid rgba(14, 165, 233, 0.18);
  border-radius: 16px;
  padding: 1rem 1.2rem;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.ad-modal-edit h4 {
  margin: 0;
  font-size: 0.95rem;
  color: #0369a1;
  font-weight: 800;
}

.ad-edit-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 0.8rem 1rem;
  align-items: flex-start;
}

.ad-edit-grid label {
  font-weight: 700;
  color: #0f172a;
}

.ad-edit-grid input,
.ad-edit-grid textarea {
  width: 100%;
  border: 1.5px solid rgba(14, 165, 233, 0.25);
  border-radius: 12px;
  padding: 0.55rem 0.75rem;
  font-family: inherit;
  font-size: 0.95rem;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

.ad-edit-grid textarea {
  min-height: 90px;
  resize: vertical;
}

.ad-edit-grid input:focus,
.ad-edit-grid textarea:focus {
  outline: none;
  border-color: #10b981;
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
}

.ad-edit-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
}

.ad-edit-actions .ad-action-btn {
  flex: 0 1 auto;
}

.ad-modal-edit-status {
  margin: 0;
  font-size: 0.85rem;
  font-weight: 600;
}

.ad-modal-edit-status.info {
  color: #0284c7;
}

.ad-modal-edit-status.success {
  color: #047857;
}

.ad-modal-edit-status.error {
  color: #dc2626;
}

.ad-modal-note {
  margin-top: 1.2rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.ad-modal-note label {
  font-weight: 800;
  color: #0f172a;
}

#adModalNote {
  border-radius: 14px;
  border: 1.5px solid rgba(14, 165, 233, 0.2);
  padding: 0.75rem 1rem;
  min-height: 90px;
  font-family: inherit;
  font-size: 0.95rem;
  resize: vertical;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

#adModalNote:focus {
  border-color: #10b981;
  box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
  outline: none;
}

.ad-modal-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.7rem;
  margin-top: 1.1rem;
}

.ad-modal-actions button {
  flex: 1;
  min-width: 150px;
  border: none;
  border-radius: 14px;
  padding: 0.7rem 1.1rem;
  font-weight: 800;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.ad-modal-actions button[data-action="approve"] {
  background: linear-gradient(135deg, #22c55e, #0ea5e9);
  color: #fff;
  box-shadow: 0 12px 26px rgba(34, 197, 94, 0.25);
}

.ad-modal-actions button[data-action="reject"] {
  background: #fee2e2;
  color: #b91c1c;
}

.ad-modal-actions button[data-action="pending"] {
  background: #f8fafc;
  color: #475569;
  border: 1px solid rgba(148, 163, 184, 0.4);
}

.ad-modal-actions button.is-loading {
  opacity: 0.7;
  pointer-events: none;
}

.ad-modal-actions button i {
  font-size: 1.1rem;
}

.ad-modal-timestamps {
  margin-top: 1rem;
  font-size: 0.85rem;
  color: #94a3b8;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.ad-modal-status {
  margin-top: 0.8rem;
  padding: 0.7rem 1rem;
  border-radius: 14px;
  background: #f0fdf4;
  color: #0f766e;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.ad-modal-status i {
  font-size: 1.2rem;
}

@media (max-width: 640px) {
  .ad-modal {
    padding: 1.4rem;
  }

  .ad-modal-actions button {
    width: 100%;
  }
}

/* Shopping centers admin */
.shopping-centers-grid {
  display: grid;
  grid-template-columns: minmax(0, 360px) minmax(0, 1fr);
  gap: 1.6rem;
  align-items: flex-start;
}

.shopping-center-form {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  padding: 1.4rem 1.6rem;
  display: flex;
  flex-direction: column;
  gap: 0.85rem;
}

.shopping-center-form h3 {
  margin: 0;
  font-size: 1.05rem;
  color: var(--primary);
}

.shopping-center-form label {
  display: block;
  font-weight: 600;
  font-size: 0.92rem;
  color: #0f9a8b;
  margin-bottom: 0.35rem;
}

.shopping-center-form input,
.shopping-center-form textarea,
.shopping-center-form select {
  width: 100%;
  padding: 0.65rem 0.9rem;
  border-radius: 12px;
  border: 1.5px solid #10b98133;
  font-size: 0.95rem;
  font-family: inherit;
  outline: none;
  transition: border var(--transition), box-shadow var(--transition);
  background: #f8fafc;
}

.shopping-center-form input:focus,
.shopping-center-form textarea:focus,
.shopping-center-form select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px #10b9811c;
}

.shopping-center-form textarea {
  resize: vertical;
  min-height: 110px;
}

.shopping-center-form button[type="submit"] {
  align-self: flex-start;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 0.7rem 1.5rem;
  font-size: 0.95rem;
  cursor: pointer;
  transition: transform var(--transition), box-shadow var(--transition);
  box-shadow: 0 8px 20px #10b9811f;
}

.shopping-center-form button[type="submit"]:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 28px #0ea5e91f;
}

.shopping-center-form .form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 0.8rem;
}

.shopping-centers-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 1rem;
}

.shopping-center-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 280px;
}

.shopping-center-card img {
  width: 100%;
  height: 160px;
  object-fit: cover;
}

.shopping-center-card .shopping-center-body {
  padding: 1rem 1.1rem 0.9rem 1.1rem;
  display: flex;
  flex-direction: column;
  gap: 0.55rem;
  flex: 1;
}

.shopping-center-card h4 {
  margin: 0;
  font-size: 1.05rem;
  color: var(--primary);
}

.shopping-center-desc {
  margin: 0;
  font-size: 0.86rem;
  color: #475569;
  line-height: 1.6;
}

.shopping-center-meta {
  display: grid;
  gap: 0.35rem;
  font-size: 0.85rem;
  color: #4b5563;
}

.shopping-center-meta span {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
}

.shopping-center-tag {
  display: inline-flex;
  align-items: center;
  width: fit-content;
  background: #ecfdf5;
  color: var(--primary);
  font-weight: 700;
  font-size: 0.78rem;
  border-radius: 999px;
  padding: 0.25rem 0.75rem;
}

.shopping-center-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
  margin-top: auto;
}

.shopping-center-actions button {
  border: none;
  border-radius: 10px;
  padding: 0.45rem 0.9rem;
  font-size: 0.85rem;
  cursor: pointer;
  transition: background var(--transition), color var(--transition);
}

.shopping-center-actions .delete {
  background: #ffe4e6;
  color: #ef4444;
}

.shopping-center-actions .delete:hover {
  background: #ef4444;
  color: #fff;
}

.shopping-centers-empty {
  background: #f9fafb;
  border: 2px dashed #d1fae5;
  border-radius: 16px;
  padding: 2.4rem 1.6rem;
  text-align: center;
  color: #6b7280;
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.shopping-centers-refresh {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  background: #ecfeff;
  border-radius: 10px;
  border: 1px solid #22d3ee44;
  padding: 0.5rem 0.9rem;
  color: #0891b2;
  font-size: 0.85rem;
  cursor: pointer;
}

.shopping-centers-refresh:hover {
  background: #cffafe;
}

@media (max-width: 980px) {
  .shopping-centers-grid {
    grid-template-columns: 1fr;
  }

  .shopping-center-form {
    order: 2;
  }
}

/* Responsive - بهینه‌سازی موبایل */
@media (max-width: 1050px) { 
  .main-content { 
    padding: 1.3rem 2vw 1.5rem 2vw; 
  } 
  
  .dashboard-charts { 
    gap: 0.7rem; 
  } 
}

@media (max-width: 850px) {
  .main-content { 
    padding: 1.7rem 2vw 1.7rem 2vw; 
  }
  
  .dashboard-charts { 
    grid-template-columns: 1fr; 
  }

  .sidebar-menu a {
    padding: 0.8rem 1.3rem;
  }
}

@media (max-width: 700px) {
  .sidebar { 
    position: fixed; 
    top: 0; 
    right: 0;
    height: 100%; 
    width: 260px;
    box-shadow: 0 0 30px rgba(0,0,0,0.15); 
    z-index: 200; 
    transform: translateX(100%);
    border-left: 1px solid var(--border);
    backdrop-filter: blur(12px);
  }
  
  .sidebar.open { 
    transform: translateX(0); 
  }
  
  .main-content { 
    padding: 1.7rem 4vw; 
  }
  
  .sidebar-toggle-btn { 
    display: flex; 
  }
  
  .table-wrap { 
    display: none; 
  }
  
  .table-cards { 
    display: flex; 
  }
  
  .cards {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.8rem;
  }

  .card {
    padding: 1.1rem;
    min-height: 90px;
  }

  .table-card {
    padding: 1.2rem;
  }
}

@media (max-width: 600px) {
  .cards {
    grid-template-columns: 1fr;
  }
  
  .action-btn {
    width: 100%;
    margin: 0.3rem 0;
    padding: 0.5rem;
  }
  
  .table-card-actions {
    flex-direction: column;
    gap: 0.5rem;
  }

  .table-card-row {
    flex-direction: column;
    gap: 0.3rem;
    padding: 0.7rem 0;
  }

  .table-card-label {
    min-width: auto;
    font-size: 0.9rem;
  }

  .table-card-value {
    font-size: 1rem;
  }

  .main-content {
    padding: 1.5rem 4vw;
  }
}

@media (max-width: 480px) {
  html {
    font-size: 15px;
  }
  
  .main-content { 
    padding: 1.3rem 4vw; 
  }
  
  .sidebar-header { 
    padding: 1rem 1rem 0.8rem; 
    font-size: 1.3rem;
  }
  
  .sidebar { 
    width: 85vw; 
  }

  .sidebar-menu a {
    padding: 0.9rem 1.4rem;
    font-size: 1.05rem;
  }

  .card {
    flex-direction: column;
    text-align: center;
    padding: 1.3rem 0.8rem;
  }

  .card .icon {
    margin: 0 auto 0.5rem;
  }

  .content-header {
    font-size: 1.3rem;
  }
}

@media (max-width: 390px) { 
  .action-btn {
    padding: 0.6rem;
    font-size: 0.95rem;
  }

  .sidebar {
    width: 90vw;
  }

  .table-card {
    padding: 1.1rem;
  }
}

::-webkit-scrollbar { 
  width: 8px; 
  height: 8px;
}

::-webkit-scrollbar-thumb { 
  background: #10b98130; 
  border-radius: 8px; 
}

::-webkit-scrollbar-thumb:hover {
  background: #10b98160; 
}

.sidebar-toggle-btn {
  display: none; 
  position: fixed; 
  top: 1.3rem; 
  right: 1rem;
  background: var(--primary); 
  color: #fff; 
  border: none;
  border-radius: 10px; 
  font-size: 1.4rem; 
  width: 2.8rem; 
  height: 2.8rem;
  align-items: center; 
  justify-content: center; 
  cursor: pointer; 
  z-index: 150;
  transition: background var(--transition);
  box-shadow: 0 3px 12px rgba(0,0,0,0.15);
}

.sidebar-toggle-btn:hover { 
  background: var(--secondary); 
  transform: scale(1.05);
}

/* Dynamic chart improvements */
.dynamic-chart-box-pro {
  background: linear-gradient(135deg, #eafaf4 0%, #fff 80%);
  box-shadow: 0 8px 44px #10b98111, 0 4px 20px #0002;
  border-radius: 1.8rem;
  margin: 0 auto 2rem auto;
  max-width: 950px;
  width: 97%;
  padding: 2rem 1.6rem 1.5rem 1.6rem;
  position: relative;
  z-index: 11;
  min-height: 21rem;
  display: flex;
  flex-direction: column;
  gap: 0.9rem;
  animation: fadeIn .35s;
  transition: box-shadow .16s;
  border: 1.5px solid #10b98122;
}

.dynamic-chart-box-pro:hover {
  box-shadow: 0 14px 60px #10b98125, 0 8px 26px #0ea5e91c;
}

.dynamic-chart-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.2rem;
}

#chartBox-title {
  font-weight: 800;
  color: #10b981;
  font-size: 1.15rem;
  letter-spacing: .15px;
}

.close-dash-chart-btn {
  background: linear-gradient(135deg,#10b981 0%,#0ea5e9 100%);
  color: #fff;
  border: none;
  font-size: 1.5rem;
  border-radius: 15px;
  width: 2.8rem;
  height: 2.8rem;
  cursor: pointer;
  transition: background .13s, color .13s;
  margin-right: 0.1rem;
  margin-left: 0.3rem;
  box-shadow: 0 2px 12px #10b98133;
  display: flex; 
  align-items: center; 
  justify-content: center;
}

.close-dash-chart-btn:hover {
  background: #eab308;
  color: #fff;
}

.dynamic-chart-filters {
  display: flex;
  gap: 0.8rem;
  justify-content: flex-end;
  margin-bottom: 0.6rem;
  flex-wrap: wrap;
  user-select: none;
}

.dash-filter-btn {
  background: #eafaf4;
  color: #10b981;
  font-weight: 700;
  padding: 0.45rem 1.2rem;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-size: 0.95rem;
  transition: .13s;
  margin-bottom: 0.1rem;
  outline: none;
  box-shadow: 0 1px 8px #10b98113;
  letter-spacing: .15px;
  min-height: 2.5rem;
}

.dash-filter-btn.active,
.dash-filter-btn:hover {
  background: linear-gradient(135deg,#10b98144 0%,#0ea5e932 100%);
  color: #111;
}

.dynamic-chart-canvas-wrap {
  width: 100%;
  min-width: 0;
  height: 18rem;
  padding-top: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 0.75rem;
  position: relative;
}

.dynamic-chart-empty {
  display: none;
  width: 100%;
  height: 100%;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: #6b7280;
  font-weight: 600;
  background: #f8fafc;
  border-radius: 1.2rem;
  border: 1.5px dashed #0ea5e942;
  padding: 1.2rem;
  line-height: 1.9;
}

@media (max-width: 1200px) {
  .dynamic-chart-box-pro {
    max-width: 99vw;
    padding: 1.5rem 2.5vw 1.2rem;
    min-height: 17rem;
  }
}

@media (max-width: 800px) {
  .dynamic-chart-box-pro {
    max-width: 99vw;
    min-height: 15rem;
    padding: 1.2rem 2vw;
    border-radius: 1.3rem;
  }
  
  .dynamic-chart-canvas-wrap {
    height: 13rem;
  }
  
  .close-dash-chart-btn { 
    width:2.5rem; 
    height:2.5rem; 
    font-size:1.3rem;
  }
}

@media (max-width: 500px) {
  .dynamic-chart-box-pro {
    padding: 1rem 3vw;
    min-height: 13rem;
    border-radius: 1rem;
  }
  
  .dynamic-chart-top { 
    font-size: .95em; 
  }
  
  .dynamic-chart-canvas-wrap { 
    height: 10rem; 
  }
  
  .close-dash-chart-btn { 
    width:2.2rem; 
    height:2.2rem; 
    font-size:1.1rem;
  }
  
  .dash-filter-btn { 
    font-size:0.9rem; 
    padding:0.4rem 0.9rem;
    min-height: 2.3rem;
  }
}

/* Animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(1.9rem); }
  to { opacity: 1; transform: none; }
}

/* بهبود overlay برای موبایل */
@media (max-width: 700px) {
  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.4);
    z-index: 190;
    backdrop-filter: blur(2px);
  }
  
  .sidebar.open ~ .sidebar-overlay {
    display: block;
  }
}




.seller-filter-btn {
  background: #fff;
  color: #10b981;
  border: 1.3px solid #10b98142;
  border-radius: 9px;
  padding: 0.43rem 1.3rem;
  font-size: 1rem;
  cursor: pointer;
  font-family: inherit;
  font-weight: bold;
  transition: all .15s;
  box-shadow: 0 2px 8px #10b98113;
}
.seller-filter-btn.active,
.seller-filter-btn:hover {
  background: linear-gradient(135deg,#10b98122 0%,#0ea5e930 100%);
  color: #0ea5e9;
  border-color: #0ea5e9;
}






/* --- Seller Modal Popup --- */
.seller-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(40,60,50,0.25);
  z-index: 9998;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn .35s;
  padding: 1.5rem;
  overflow-y: auto;
}
.seller-modal {
  background: #fff;
  border-radius: 1.5rem;
  box-shadow: 0 12px 50px #10b98144;
  width: min(520px, 100%);
  max-width: 100%;
  min-width: 0;
  padding: 2.2rem 1.7rem 1.2rem;
  direction: rtl;
  position: relative;
  z-index: 9999;
  animation: fadeIn .33s;
  max-height: min(90vh, 720px);
  overflow-y: auto;
}
.seller-modal-close {
  position: absolute; top: 1.2rem; right: 1.2rem;
  background: #eafaf4;
  border-radius: 10px;
  border: none; color: #16a34a;
  font-size: 1.6rem;
  cursor: pointer; padding: 0.25rem 1rem;
  transition: background .15s, color .15s;
}
.seller-modal-close:hover { background: #10b981; color: #fff; }
.seller-modal-title { color: #10b981; font-weight: bold; font-size: 1.1rem; margin-bottom: 1.3rem;}
.seller-modal-row { margin-bottom: .85rem; font-size: 1.01rem;}
.seller-modal-label { color: #333; font-weight: 700; min-width: 5rem; display: inline-block;}
.seller-modal-value { color: #0ea5e9; font-weight: 500;}
.seller-modal-form label { font-size: 0.96rem; font-weight: 500; color: #666;}
.seller-modal-form textarea {
  width: 100%; min-height: 66px; border-radius: 9px;
  border: 1.2px solid #10b98144; margin-top: 0.2rem;
  font-family: inherit; font-size: 1.01rem; padding: 0.4rem 0.6rem; outline: none; transition: border .13s;
}
.seller-modal-form textarea:focus { border-color: #10b981; }
.seller-modal-form button {
  margin-top: 0.7rem; padding: 0.41rem 1.4rem;
  border-radius: 9px; border: none; color: #fff;
  background: linear-gradient(135deg,#10b981 0%,#0ea5e9 100%);
  font-weight: bold; font-size: 1.08rem; cursor: pointer;
  transition: background .15s;
}
.seller-modal-form button:active { background: #0ea5e9; }
.seller-modal-success {
  color: #10b981; background: #eafaf4; border-radius: 9px;
  padding: 0.6rem 1rem; margin-top: 1rem; font-weight: 500; text-align: center;
}

.seller-score-block {
  margin-top: 1.5rem;
  padding: 1.2rem 1.4rem 1.35rem;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 1.1rem;
}
.seller-score-block .seller-modal-label {
  display: block;
  margin-bottom: 0.85rem;
  color: #0f172a;
}
.seller-score-range {
  display: flex;
  align-items: center;
  gap: 1rem;
}
.seller-score-range input[type=range] {
  flex: 1 1 auto;
  accent-color: #10b981;
}
.seller-score-value {
  min-width: 4.5rem;
  text-align: center;
  font-weight: 800;
  font-size: 1.25rem;
  color: #0ea5e9;
  background: #ecfdf5;
  border-radius: 0.9rem;
  padding: 0.4rem 0.7rem;
}
.seller-score-note {
  margin-top: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.45rem;
}
.seller-score-note label {
  font-size: 0.88rem;
  font-weight: 600;
  color: #0f172a;
}
.seller-score-note textarea {
  width: 100%;
  min-height: 72px;
  border-radius: 0.9rem;
  border: 1px solid #cbd5f5;
  background: #fff;
  font-family: inherit;
  font-size: 0.92rem;
  padding: 0.55rem 0.75rem;
  transition: border-color .15s ease, box-shadow .15s ease;
  resize: vertical;
}
.seller-score-note textarea:focus {
  border-color: #0ea5e9;
  box-shadow: 0 0 0 3px rgba(14,165,233,.1);
  outline: none;
}
.seller-score-note-hint {
  font-size: 0.75rem;
  color: #64748b;
  line-height: 1.6;
}
.seller-score-message {
  margin-top: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.45rem;
}
.seller-score-message label {
  font-size: 0.88rem;
  font-weight: 600;
  color: #0f172a;
}
.seller-score-message textarea {
  width: 100%;
  min-height: 88px;
  border-radius: 0.9rem;
  border: 1px solid #bae6fd;
  background: #fff;
  font-family: inherit;
  font-size: 0.95rem;
  padding: 0.6rem 0.8rem;
  transition: border-color .15s ease, box-shadow .15s ease;
  resize: vertical;
}
.seller-score-message textarea:focus {
  border-color: #0ea5e9;
  box-shadow: 0 0 0 3px rgba(14,165,233,.1);
  outline: none;
}
.seller-score-message-hint {
  font-size: 0.75rem;
  color: #475569;
  line-height: 1.7;
}
.seller-score-note-display {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}
.seller-score-message-display {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
  margin-top: 0.9rem;
  padding: 0.85rem 1rem;
  border-radius: 0.9rem;
  background: #ecfeff;
  border: 1px solid #bae6fd;
}
.seller-score-message-display.is-empty {
  background: #f8fafc;
  border-style: dashed;
  color: #64748b;
}
.seller-score-message-display.is-empty .seller-score-message-title,
.seller-score-message-display.is-empty .seller-message-text {
  color: #64748b;
}
.seller-score-message-title {
  font-size: 0.78rem;
  font-weight: 700;
  color: #0f172a;
}
.seller-message-text {
  font-size: 0.9rem;
  color: #0f172a;
  line-height: 1.7;
}
.seller-score-note-title {
  font-size: 0.78rem;
  font-weight: 700;
  color: #0f172a;
}
.seller-score-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 1rem;
  flex-wrap: wrap;
}
.seller-score-actions button {
  flex: 1 1 140px;
  padding: 0.6rem 1rem;
  border-radius: 0.9rem;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: background .18s ease, color .18s ease, transform .18s ease;
}
.seller-score-actions .score-save-btn {
  background: linear-gradient(135deg,#10b981 0%,#0ea5e9 100%);
  color: #fff;
}
.seller-score-actions .score-save-btn:hover {
  transform: translateY(-1px);
  background: linear-gradient(135deg,#059669 0%,#0284c7 100%);
}
.seller-score-actions .score-clear-btn {
  background: #f1f5f9;
  color: #475569;
}
.seller-score-actions .score-clear-btn:hover {
  background: #e2e8f0;
}
.seller-score-actions .score-clear-btn:disabled {
  opacity: .55;
  cursor: not-allowed;
  transform: none;
}
.seller-score-hint {
  font-size: 0.82rem;
  color: #64748b;
  margin-top: 0.85rem;
  line-height: 1.7;
}
.seller-score-alert {
  margin-top: 0.9rem;
  border-radius: 0.95rem;
  padding: 0.65rem 0.95rem;
  font-size: 0.85rem;
  font-weight: 600;
  display: none;
}
.seller-score-alert.is-success {
  background: #ecfdf5;
  color: #047857;
  border: 1px solid #bbf7d0;
}
.seller-score-alert.is-error {
  background: #fee2e2;
  color: #b91c1c;
  border: 1px solid #fecaca;
}

.seller-score-cell-wrap {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0.35rem;
}

.seller-status-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.28rem 0.75rem;
  border-radius: 999px;
  font-size: 0.78rem;
  font-weight: 700;
  background: #e2e8f0;
  color: #475569;
  transition: background .18s ease, color .18s ease;
}
.seller-status-pill.status-success {
  background: #dcfce7;
  color: #047857;
}
.seller-status-pill.status-warning {
  background: #fef3c7;
  color: #b45309;
}
.seller-status-pill.status-danger {
  background: #fee2e2;
  color: #b91c1c;
}
.seller-status-pill.status-neutral {
  background: #e2e8f0;
  color: #475569;
}

.seller-status-note {
  font-size: 0.78rem;
  font-weight: 600;
}
.seller-status-note.status-eligible {
  color: #047857;
}
.seller-status-note.status-ineligible {
  color: #b91c1c;
}
.seller-status-note.status-neutral {
  color: #475569;
}
.seller-note-text {
  font-size: 0.8rem;
  color: #334155;
  line-height: 1.7;
  background: #f1f5f9;
  border-radius: 0.75rem;
  padding: 0.65rem 0.75rem;
  border: 1px dashed #cbd5f5;
  word-break: break-word;
}

.seller-score-status {
  margin-top: 1.1rem;
  padding-top: 0.9rem;
  border-top: 1px dashed #cbd5f5;
  display: flex;
  flex-direction: column;
  gap: 0.55rem;
}
.seller-score-status-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.seller-status-text {
  font-size: 0.85rem;
  color: #475569;
  line-height: 1.7;
}
.seller-status-updated {
  font-size: 0.76rem;
  color: #64748b;
}

.seller-score-actions button.is-loading {
  opacity: .65;
  cursor: wait;
}

.seller-score-cell {
  text-align: center;
}
.seller-score-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.35rem;
  min-width: 102px;
  padding: 0.38rem 0.85rem;
  border-radius: 9999px;
  font-size: 0.86rem;
  font-weight: 600;
  background: #f8fafc;
  color: #475569;
  border: 1px solid #e2e8f0;
  transition: transform .18s ease, box-shadow .18s ease;
}
.seller-score-badge.has-score {
  background: #ecfdf5;
  border-color: #bbf7d0;
  color: #047857;
}
.seller-score-badge.has-score strong {
  font-weight: 800;
  font-size: 1.02rem;
}
.seller-score-badge span.score-suffix {
  font-size: 0.75rem;
  opacity: .75;
}
.seller-score-badge.no-score {
  background: #f1f5f9;
  border-color: #e2e8f0;
  color: #64748b;
}
.seller-score-badge:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 26px rgba(15,118,110,.18);
}

@media (max-width: 640px) {
  .seller-modal-overlay {
    padding: 1rem;
    align-items: flex-start;
  }
  .seller-modal {
    width: 100%;
    max-width: 100%;
    border-radius: 1.25rem 1.25rem 0 0;
    padding: 1.6rem 1.2rem 1rem;
    max-height: none;
  }
  .seller-modal-row {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.35rem;
  }
  .seller-modal-label {
    min-width: 0;
  }
  .seller-score-range {
    flex-direction: column;
    align-items: stretch;
    gap: 0.65rem;
  }
  .seller-score-value {
    align-self: flex-start;
  }
}

@media (max-width: 400px) {
  .seller-score-actions {
    flex-direction: column;
  }
  .seller-score-actions button {
    flex: 1 1 auto;
    width: 100%;
  }
  .seller-modal {
    padding: 1.4rem 1rem 0.9rem;
  }
}






/* === مدیریت قیمت پلن‌ها  (Plans)  ================================ */
#plans-panel{
  /* ستونِ وسط‌چین در کل عرضِ Main-Content */
  display:flex;
  flex-direction:column;
  align-items:center;       /* محور افقی */
  justify-content:center;   /* محور عمودی – اگر فقط بالا می‌خواهی بگذار flex-start */
  gap:2rem;
  min-height:calc(100vh - 120px); /* قد نسبى براى وسط شدن */
  padding:2rem 1rem;
}

#plans-panel .content-header{
  width:100%;
  text-align:center;
  font-size:2rem;
  font-weight:900;
  color:var(--primary);
  letter-spacing:.5px;
}

/* ظرفی که فرم را دقیقاً وسط نگه مى‌دارد */
.plans-center{
  width:100%;
  max-width:1000px;
  display:flex;
  justify-content:center;   /* وسط افقی */
  align-items:center;       /* وسط عمودی */
}

/* فرم زیبا */
#plansForm{
  width:100%;
  max-width:430px;
  background:linear-gradient(135deg,#e0fdfa 0%,#f8fafc 100%);
  border:1.6px solid #e0fdfa;
  border-radius:28px;
  box-shadow:0 6px 36px #10b98122;
  padding:2.5rem 2rem 2rem;
  display:flex;
  flex-direction:column;
  animation:fadeIn .4s;
}

/* لیبل + ورودی‌ها */
#plansForm label{
  width:100%;
  margin-bottom:1.1rem;
  font-size:1.05rem;
  font-weight:700;
  color:#0ea5e9;
}
#plansForm input[type="number"]{
  width:100%;
  margin-top:.4rem;
  padding:.9rem 1.2rem;
  font-size:1.15rem;
  font-weight:700;
  background:#f8fafc;
  border:1.8px solid #e0fdfa;
  border-radius:16px;
  outline:none;
  transition:border .15s,box-shadow .15s;
}
#plansForm input[type="number"]:focus{
  border-color:#10b981;
  box-shadow:0 4px 24px #10b98133;
  background:#e6fff7;
}

/* دکمهٔ ذخیره */
#plansForm button[type="submit"]{
  align-self:center;
  margin-top:.6rem;
  background:linear-gradient(90deg,#10b981 0%,#0ea5e9 100%);
  color:#fff;
  padding:1rem 2.6rem;
  font-size:1.15rem;
  font-weight:900;
  border:none;
  border-radius:14px;
  cursor:pointer;
  box-shadow:0 3px 18px #10b98135;
  transition:transform .1s,box-shadow .15s,background .15s;
}
#plansForm button[type="submit"]:hover{
  background:linear-gradient(90deg,#0ea5e9 0%,#10b981 100%);
  box-shadow:0 6px 28px #0ea5e955;
  transform:translateY(-3px) scale(1.04);
}

/* پیام موفقیت */
#plansMsg{
  display:none;
  width:100%;
  margin-top:1.2rem;
  padding:.9rem 1.2rem;
  text-align:center;
  font-weight:800;
  font-size:1.05rem;
  color:#10b981;
  background:#e0fdfa;
  border-radius:13px;
  box-shadow:0 2px 12px #10b98112;
}

/* ریسپانسیو سریع */
@media(max-width:600px){
  #plansForm{
    padding:1.6rem 1rem;
    border-radius:20px;
  }
  .plans-center{
    min-height:50vh;
  }
}

/* --- هِدِر «مدیریت قیمت پلن‌ها» را وسط‌چین کن --- */
#plans-panel .content-header{
  /* استایل‌های قبلى – می‌توانى نگه دارى یا همین را کامل جایگزین کن */
  width:100%;
  font-size:2rem;
  font-weight:900;
  color:var(--primary);
  letter-spacing:.5px;

  /* مهم‌ترین خط‌ها براى وسط‌چینى */
  display:flex;            /* هِدِر همچنان فلکس است */
  justify-content:center;  /* محتوایش در محور افقى وسط قرار مى‌گیرد */
  text-align:center;       /* و متن داخلش هم وسط مى‌شود */
}







/* ---- فرم‌های قیمت‌گذاری (پلن + تبلیغات) ---- */
.priceForm{
  width:100%;
  max-width:430px;
  background:linear-gradient(135deg,#e0fdfa 0%,#f8fafc 100%);
  border:1.6px solid #e0fdfa;
  border-radius:28px;
  box-shadow:0 6px 36px #10b98122;
  padding:2.5rem 2rem 2rem;
  display:flex;
  flex-direction:column;
  animation:fadeIn .4s;
}
.priceForm label{
  width:100%;
  margin-bottom:1.1rem;
  font-size:1.05rem;
  font-weight:700;
  color:#0ea5e9;
}
.priceForm input[type="number"]{
  width:100%;
  margin-top:.4rem;
  padding:.9rem 1.2rem;
  font-size:1.15rem;
  font-weight:700;
  background:#f8fafc;
  border:1.8px solid #e0fdfa;
  border-radius:16px;
  outline:none;
  transition:border .15s,box-shadow .15s;
}
.priceForm input[type="number"]:focus{
  border-color:#10b981;
  box-shadow:0 4px 24px #10b98133;
  background:#e6fff7;
}
.priceForm button[type="submit"]{
  align-self:center;
  margin-top:.6rem;
  background:linear-gradient(90deg,#10b981 0%,#0ea5e9 100%);
  color:#fff;
  padding:1rem 2.6rem;
  font-size:1.15rem;
  font-weight:900;
  border:none;
  border-radius:14px;
  cursor:pointer;
  box-shadow:0 3px 18px #10b98135;
  transition:transform .1s,box-shadow .15s,background .15s;
}
.priceForm button[type="submit"]:hover{
  background:linear-gradient(90deg,#0ea5e9 0%,#10b981 100%);
  box-shadow:0 6px 28px #0ea5e955;
  transform:translateY(-3px) scale(1.04);
}

/* پیام موفقیت/خطا داخل هر فرم */
#plansMsg, #adsMsg{
  display:none;
  width:100%;
  margin-top:1.2rem;
  padding:.9rem 1.2rem;
  text-align:center;
  font-weight:800;
  font-size:1.05rem;
  color:#10b981;
  background:#e0fdfa;
  border-radius:13px;
  box-shadow:0 2px 12px #10b98112;
}






#chatModal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 9999;
  backdrop-filter: blur(2.5px);
  direction: rtl;
  font-family: 'Vazirmatn', Tahoma, sans-serif;
}
#chatModal.show { display: block; }
.modal-overlay {
  position: absolute; inset: 0;
  background: rgba(34,41,47,0.24);
  z-index: 0;
}
.modal-content {
  position: absolute;
  top: 50%; left: 50%;
  width: 99%; max-width: 700px; /* بزرگ‌تر شد */
  min-width: 340px;
  max-height: 88vh;             /* بزرگ‌تر شد */
  min-height: 380px;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 32px;
  padding: 0;
  box-shadow: 0 12px 70px #10b98130, 0 4px 28px #0ea5e920;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  z-index: 2;
  animation: fadeIn .38s;
}
.modal-content h3 {
  background: linear-gradient(90deg,#10b981 0%,#0ea5e9 100%);
  color: #fff;
  font-size: 1.25rem;
  font-weight: bold;
  padding: 1.18rem 1.3rem 1rem 1.3rem;
  margin: 0;
  text-align: right;
  letter-spacing: .2px;
  border-bottom: 2px solid #eafaf4;
}
.chat-messages {
  flex: 1 1 0;
  overflow-y: auto;
  background: linear-gradient(135deg,#eafaf4 0%,#fff 70%);
  padding: 1.6rem 2.1rem 0.9rem 2.1rem;
  min-height: 200px;
  max-height: 54vh;
  display: flex;
  flex-direction: column;
  gap: 0.95rem;
  scroll-behavior: smooth;
  font-size: 1.05rem;
  /* این خط باید حذف بشه 👇 */
  /* justify-content: flex-end; */
}




.chat-bubble {
  display: flex;
  flex-direction: column;
  max-width: 65%;
  min-width: 70px;
  margin: 0.5rem 0;
  padding: 0.95rem 1.3rem 0.95rem 1.2rem;
  background: #f5f5f5;
  border-radius: 17px 17px 17px 8px;
  box-shadow: 0 2px 14px #10b98113;
  font-size: 1.09rem;
  word-break: break-word;
  position: relative;
  animation: fadeIn .24s;
  border: 1.5px solid #10b98118;
  align-self: flex-start;  /* پیش‌فرض (پیام فروشنده/مشتری) سمت راست */
  direction: rtl;
  transition: box-shadow .17s;
}

/* ادمین بیاد سمت چپ، بقیه راست */
.chat-bubble.admin {
  align-self: flex-end !important;
  background: linear-gradient(90deg,#e0fdfa 0%,#f8fafc 100%);
  border-radius: 21px 11px 22px 22px;
  border: 1.6px solid #10b98155;
  color: #16706b;
  margin-left: 0;
  margin-right: auto;
  box-shadow: 0 2px 18px #10b98111;
  direction: rtl;
}
.chat-bubble.seller {
  align-self: flex-start !important;
  background: linear-gradient(90deg,#eafaf4 0%,#fff 80%);
  border-radius: 19px 22px 12px 22px;
  border: 1.5px solid #0ea5e933;
  color: #066e41;
  margin-right: 0;
  margin-left: auto;
}
.chat-bubble.customer {
  align-self: flex-start !important;
  background: #fffde7;
  border-radius: 15px 18px 13px 22px;
  border: 1.4px solid #eab30842;
  color: #ba7604;
}

.chat-bubble .sender {
  font-size: 0.95em;
  font-weight: 700;
  margin-bottom: 0.13em;
  color: #0ea5e9;
  opacity: 0.86;
  letter-spacing: .2px;
}
.chat-bubble.admin .sender { color: #10b981; }
.chat-bubble.customer .sender { color: #ba7604; }
.chat-bubble.seller .sender { color: #0ea5e9; }
.chat-bubble .text {
  font-size: 1.15em;
  font-weight: 500;
  line-height: 2.12;
  margin-bottom: 0.15em;
}
.chat-bubble .time {
  font-size: 0.87em;
  color: #8ca0a8;
  margin-top: 0.25em;
  text-align: left;
  font-weight: 400;
}

.chat-input-area {
  border-top: 1.7px solid #eafaf4;
  background: #f8fafc;
  padding: 1.1rem 2rem;
  display: flex;
  gap: 0.75rem;
  align-items: flex-end;
}



.chat-input-area {
  /* اضافه کردن این خط برای اجازه‌ی چندخطی شدن دکمه‌ها */
  flex-wrap: wrap;
}

.chat-input-area .action-btn.delete {
  /* اگر می‌خواهید دکمه‌ی مسدودسازی دوباره قرمز شود */
  background: #ef4444 !important;
  color: #fff !important;
}

.chat-input-area .action-btn.delete:hover {
  background: #dc2626 !important;
}



.chat-input-area textarea {
  flex: 1;
  padding: 0.73rem 1rem;
  border-radius: 15px;
  border: 1.7px solid #10b98122;
  font-size: 1.14rem;
  font-family: inherit;
  resize: none;
  outline: none;
  transition: border .15s, background .13s;
  background: #fff;
  min-height: 58px;
  max-height: 120px;
  font-weight: 500;
}
.chat-input-area textarea:focus {
  border-color: #0ea5e9;
  background: #eafaf4;
}
.chat-input-area button {
  padding: 0.87rem 2.1rem;
  border-radius: 13px;
  background: linear-gradient(90deg,#10b981 0%,#0ea5e9 100%);
  color: #fff;
  border: none;
  font-weight: bold;
  font-size: 1.17rem;
  cursor: pointer;
  transition: background .12s, box-shadow .14s, transform .11s;
  box-shadow: 0 2px 12px #10b98114;
  letter-spacing: .4px;
}
.chat-input-area button:hover {
  background: linear-gradient(90deg,#0ea5e9 0%,#10b981 100%);
  transform: scale(1.05);
}
.modal-close {
  background: none;
  color: #10b981;
  border: none;
  font-size: 1.18rem;
  font-weight: bold;
  cursor: pointer;
  margin: 1.2rem 2.1rem 0.7rem 0;
  align-self: flex-start;
  transition: color .14s;
  border-radius: 9px;
  padding: 0.21rem 1rem;
}
.modal-close:hover { color: #0ea5e9; background: #eafaf4; }

@media (max-width: 900px) {
  .modal-content { max-width: 97vw; padding: 0; }
  .chat-messages { padding: 1.25rem 0.5rem 0.6rem 0.7rem; }
  .chat-bubble { padding: 0.72rem 0.9rem 0.75rem 0.9rem; font-size: 1em; }
  .chat-input-area { padding: 0.9rem 0.7rem; }
  .modal-close { margin: 0.9rem 1rem 0.5rem 0; }
}
@media (max-width: 540px) {
  .modal-content { max-width: 99vw; border-radius: 12px; }
  .chat-messages { font-size: 0.95em; }
  .chat-input-area textarea { min-height: 38px; font-size: 0.96em; }
}


/* اگر درون .count متنی نباشد، کامل display:none شود */
.sidebar-menu a .count:empty {
  display: none;
}



/* —— کارت ارسال پیام همگانی —— */
/* —— کارت ارسال پیام همگانی (فشرده) —— */
.broadcast-card {
  background: var(--card);
  border-radius: 17px;
  box-shadow: 0 8px 32px #10b98112, 0 1.5px 16px #0ea5e930;
  margin: 1.3rem 0;
  overflow: hidden;
  width: 100%;
  max-width: 100%;
  min-width: 0;
  font-family: 'Vazirmatn', Tahoma, sans-serif;
  font-size: 1.04rem;
  letter-spacing: .01em;
  transition: transform .17s, box-shadow .18s;
  /* فشرده */
}

.broadcast-card:hover {
  transform: translateY(-3px) scale(1.01);
  box-shadow: 0 16px 44px #0ea5e91c, 0 4px 18px #10b9811a;
}

/* حالت جمع‌شده */
.broadcast-card.collapsed .broadcast-body {
  display: none;
}

/* هدر */
.broadcast-header {
  display: flex;
  align-items: center;
  gap: .7rem;
  background: linear-gradient(90deg, var(--primary) 70%, var(--secondary) 100%);
  color: #fff;
  padding: .77rem 2rem .77rem 1.2rem;
  cursor: pointer;
  font-size: 1.08rem;
  font-weight: 900;
  border-bottom: 1px solid #e0fdfa;
  letter-spacing: .02em;
  user-select: none;
  min-height: 56px;
}
.broadcast-header i {
  font-size: 1.33em;
  opacity: .92;
}
.broadcast-header h4 {
  margin: 0;
  font-size: 1.07em;
  font-weight: 900;
  letter-spacing: .02em;
}
.toggle-icon {
  margin-left: auto;
  font-size: 1.55em !important;
  transition: transform .24s cubic-bezier(.45,.7,.3,1.2);
}
.broadcast-card:not(.collapsed) .toggle-icon {
  transform: rotate(180deg);
}

/* فرم */
.broadcast-body {
  padding: .99rem 2.2rem .82rem 2.2rem;
  background: #fcfcfd;
  display: flex;
  flex-direction: row;
  gap: 1.5rem;
  align-items: flex-end;
  max-height: 230px;
}
.broadcast-row {
  display: flex;
  flex-direction: column;
  gap: 0.38rem;
  flex: 1;
  min-width: 0;
}
.broadcast-row label {
  font-weight: 800;
  color: #0ea5e9;
  font-size: .97rem;
  margin-bottom: 0.03rem;
}
.broadcast-row select,
.broadcast-row textarea {
  width: 100%;
  border: 1.3px solid #e0fdfa;
  border-radius: 9px;
  padding: .6rem .85rem;
  font-size: .99rem;
  font-family: inherit;
  background: #f8fafc;
  outline: none;
  resize: none;
  transition: border .13s, box-shadow .14s;
  font-weight: 500;
  color: #2e3743;
  box-shadow: 0 1px 7px #10b98109;
}
.broadcast-row select:focus,
.broadcast-row textarea:focus {
  border-color: #10b981;
  box-shadow: 0 0 0 2px #0ea5e91a;
}
.broadcast-row textarea {
  min-height: 45px;
  max-height: 100px;
  line-height: 1.85;
}

.broadcast-actions {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  min-width: 105px;
  margin-right: 1rem;
  gap: 0.55rem;
}
.broadcast-actions button {
  background: linear-gradient(90deg, var(--primary) 30%, var(--secondary) 90%);
  color: #fff;
  border: none;
  border-radius: 9px;
  padding: .65rem 1.4rem;
  font-size: 1.04rem;
  font-weight: 900;
  box-shadow: 0 3px 14px #10b98116;
  transition: transform .09s, box-shadow .13s, background .11s;
  letter-spacing: .01em;
  cursor: pointer;
  width: 100%;
}
.broadcast-actions button:hover {
  background: linear-gradient(90deg, var(--secondary) 10%, var(--primary) 85%);
  transform: translateY(-1px) scale(1.03);
  box-shadow: 0 7px 22px #10b98118, 0 2px 8px #0ea5e911;
}

.broadcast-status {
  margin-top: .12rem;
  font-size: .97rem;
  min-height: 1.2em;
  text-align: right;
  font-weight: 700;
  letter-spacing: .01em;
  color: #0ea5e9;
  transition: color .16s;
}

/* ریسپانسیو: موبایل */
@media (max-width: 900px) {
  .broadcast-body {
    padding: .88rem 1.1rem .7rem 1.1rem;
    gap: 1.1rem;
    max-height: 260px;
  }
}
@media (max-width: 600px) {
  .broadcast-card {
    border-radius: 10px;
    font-size: .98rem;
    margin: 1rem 0 .8rem 0;
  }
  .broadcast-header {
    padding: .66rem .85rem .66rem .7rem;
    font-size: 1.01rem;
    min-height: 46px;
  }
  .broadcast-body {
    flex-direction: column;
    align-items: stretch;
    gap: .67rem;
    max-height: none;
    padding: .88rem .7rem .5rem .7rem;
  }
  .broadcast-actions {
    margin: 0;
    width: 100%;
    align-items: stretch;
  }
  .broadcast-actions button {
    border-radius: 8px;
    font-size: .97rem;
    padding: .73rem 0;
    width: 100%;
  }
}

@media (max-width: 370px) {
  .broadcast-card {
    font-size: .94rem;
    border-radius: 8px;
  }
  .broadcast-header {
    padding: .48rem .4rem;
    font-size: .93rem;
  }
  .broadcast-body {
    padding: .58rem .2rem .4rem .2rem;
    gap: .43rem;
  }
  .broadcast-row label {
    font-size: .93rem;
  }
}






/* ============ Sender-Info Modal ============ */
.sender-modal-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.35);
  backdrop-filter:blur(3px);
  display:none; align-items:center; justify-content:center;
  z-index:10000; animation:fadeIn .32s;
}
.sender-modal{
  width:380px; max-width:95vw; background:#fff;
  border-radius:24px; padding:2rem 1.6rem 1.4rem;
  box-shadow:0 12px 40px #00000030;
  direction:rtl; position:relative; animation:fadeIn .35s;
}
.sender-modal-close{
  position:absolute; top:1rem; left:1rem;
  background:#eafaf4; border:none; border-radius:40px;
  color:#10b981; font-size:1.55rem; cursor:pointer;
  width:2.6rem; height:2.6rem;
  transition:background .15s,color .15s;
}
.sender-modal-close:hover{background:#10b981;color:#fff;}
.sender-modal h4{
  margin:0 0 1.1rem 0; font-size:1.15rem;
  font-weight:900; color:#0ea5e9; letter-spacing:.3px;
}
.sender-info-row{margin:.55rem 0; font-size:1rem;}
.sender-info-label{font-weight:700; color:#444; min-width:6rem; display:inline-block;}
.sender-info-value{color:#10b981; font-weight:500;}







.action-btn.block {
  background: #ef4444;
  color: #fff;
}
.action-btn.block:hover {
  background: #dc2626;
}
.action-btn.unblock {
  background: #22c55e;
  color: #fff;
}
.action-btn.unblock:hover {
  background: #16a34a;
}

.blocked-badge {
  display: inline-block;
  color: #dc2626;
  font-weight: bold;
  margin-right: 0.5rem;
}







/* --- User Modal Popup --- */
.user-modal-overlay {
  position: fixed; inset: 0; background: rgba(40,60,50,0.25); z-index: 9998;
  display: flex; align-items: center; justify-content: center; animation: fadeIn .35s;
}
.user-modal {
  background: #fff;
  border-radius: 1.5rem;
  box-shadow: 0 12px 50px #10b98144;
  min-width: 350px; max-width: 98vw; width: 420px;
  padding: 2.3rem 1.7rem 1.1rem;
  direction: rtl;
  position: relative;
  z-index: 9999;
  animation: fadeIn .33s;
}
.user-modal-close {
  position: absolute; top: 1.2rem; left: 1.2rem;
  background: #eafaf4;
  border-radius: 10px;
  border: none; color: #16a34a;
  font-size: 1.6rem;
  cursor: pointer; padding: 0.25rem 1rem;
  transition: background .15s, color .15s;
}
.user-modal-close:hover { background: #10b981; color: #fff; }
.user-modal-title { color: #10b981; font-weight: bold; font-size: 1.1rem; margin-bottom: 1.3rem;}
.user-modal-row { margin-bottom: .85rem; font-size: 1.01rem;}
.user-modal-label { color: #333; font-weight: 700; min-width: 5rem; display: inline-block;}
.user-modal-value { color: #0ea5e9; font-weight: 500;}
.user-modal-form label { font-size: 0.96rem; font-weight: 500; color: #666;}
.user-modal-form textarea {
  width: 100%; min-height: 66px; border-radius: 9px;
  border: 1.2px solid #10b98144; margin-top: 0.2rem;
  font-family: inherit; font-size: 1.01rem; padding: 0.4rem 0.6rem; outline: none; transition: border .13s;
}
.user-modal-form textarea:focus { border-color: #10b981; }
.user-modal-form button {
  margin-top: 0.7rem; padding: 0.41rem 1.4rem;
  border-radius: 9px; border: none; color: #fff;
  background: linear-gradient(135deg,#10b981 0%,#0ea5e9 100%);
  font-weight: bold; font-size: 1.08rem; cursor: pointer;
  transition: background .15s;
}
.user-modal-form button:active { background: #0ea5e9; }
.user-modal-success {
  color: #10b981; background: #eafaf4; border-radius: 9px;
  padding: 0.6rem 1rem; margin-top: 1rem; font-weight: 500; text-align: center;
}
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">ویترینت</div>
      <div class="sidebar-menu">
        <a href="#" class="active" data-section="dashboard"><i class="ri-dashboard-line"></i> داشبورد</a>
        <a href="#" data-section="daily-visits"><i class="ri-eye-line"></i> آمار روزانه بازدید</a>
        <a href="#" data-section="users"><i class="ri-user-3-line"></i> کاربران <span class="count" id="count-users">0</span></a>
        <a href="#" data-section="sellers"><i class="ri-store-2-line"></i> فروشنده‌ها <span class="count" id="count-sellers">0</span></a>
        <a href="service-shops.html" id="service-shops-link"><i class="ri-scissors-2-line"></i> مغازه‌های خدماتی <span class="count" id="count-service-shops"></span></a>
        <a href="#" data-section="products"><i class="ri-box-3-line"></i> محصولات <span class="count" id="count-products">0</span></a>
        <a href="#" data-section="shopping-centers"><i class="ri-building-2-line"></i> مراکز خرید <span class="count" id="count-shopping-centers">0</span></a>
        <a href="#" data-section="plans"><i class="ri-money-dollar-circle-line"></i> مدیریت قیمت پلن‌ها</a>
        <a href="#" data-section="ads"><i class="ri-megaphone-line"></i> مدیریت قیمت تبلیغات</a>
        <a href="#" data-section="ad-orders"><i class="ri-advertisement-line"></i> تایید تبلیغات ویژه <span class="count" id="count-ad-orders">0</span></a>
        <a href="#" data-section="home-section"><i class="ri-layout-grid-line"></i> کارت‌های صفحه اصلی</a>
        <a href="#" data-section="messages">
          <i class="ri-chat-1-line"></i> پیام‌ها
          <span class="count" id="count-messages">0</span>
        </a>
<a href="#" data-section="reports"><i class="ri-file-list-line"></i> گزارشات <span class="count" id="count-reports">0</span></a>


      </div>
      <div class="sidebar-footer">
        <span>© 2025 vitrinNet Panel</span>
      </div>
    </nav>
 <!-- Main Content
–––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––– -->
<div class="main-content">
  <!-- دکمهٔ باز/بستن سایدبار در موبایل -->
  <button class="sidebar-toggle-btn" id="sidebarToggle">
    <i class="ri-menu-3-line"></i>
  </button>

  <!-- ۱) داشبورد -->
  <div class="section-panel" id="dashboard-panel">
    <div class="content-header">داشبورد آماری</div>
    <div class="cards">
      <div class="card" id="card-visits">
        <span class="icon"><i class="ri-eye-line"></i></span>
        <div><div class="num" id="visit-today">0</div><div class="label">بازدید امروز</div></div>
      </div>
      <div class="card" id="card-users">
        <span class="icon"><i class="ri-user-add-line"></i></span>
        <div><div class="num" id="register-user-today">0</div><div class="label">ثبت‌نام کاربران امروز</div></div>
      </div>
      <div class="card" id="card-sellers">
        <span class="icon"><i class="ri-store-2-line"></i></span>
        <div><div class="num" id="register-seller-today">0</div><div class="label">ثبت‌نام فروشنده امروز</div></div>
      </div>
      <div class="card" id="card-service-shops">
        <span class="icon"><i class="ri-scissors-2-line"></i></span>
        <div><div class="num" id="service-shops-total">0</div><div class="label">مغازه‌های خدماتی فعال</div></div>
      </div>
      <div class="card" id="card-products">
        <span class="icon"><i class="ri-box-3-line"></i></span>
        <div><div class="num" id="products-total">0</div><div class="label">تعداد محصولات</div></div>
      </div>
    </div>
    <div id="dashboard-dynamic-chart-wrap"></div>
  </div>

  <!-- پنل جدید برای آمار روزانه بازدید -->
  <div class="section-panel" id="daily-visits-panel" style="display:none;">
    <p style="text-align:center">در حال بارگیری...</p>
  </div>

  <!-- ۲) کاربران -->
<!-- ۲) کاربران -->
<div class="section-panel" id="users-panel" style="display:none;">
  <div class="content-header">کاربران <span class="header-count" id="header-users-count"></span></div>
  <div style="margin-bottom:1rem;display:flex;gap:0.5rem;align-items:center;">
    <input type="text" id="userSearch" placeholder="جستجو نام، نام خانوادگی یا تلفن..." 
           style="width:100%;max-width:400px;padding:0.7rem 1rem;border-radius:12px;border:1.5px solid #10b98144;font-size:1rem;font-family:inherit;outline:none;transition:border .15s;">
  </div>
  <div class="table-wrap">
    <table id="usersTable">
      <thead><tr><th>نام</th><th>ایمیل</th><th>عملیات</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

  <!-- ۳) فروشنده‌ها -->
  <div class="section-panel" id="sellers-panel" style="display:none;">
    <div class="content-header">فروشنده‌ها <span class="header-count" id="header-sellers-count"></span></div>
    <div style="margin-bottom:1rem;display:flex;gap:0.5rem;align-items:center;">
  <input type="text" id="sellerSearch" placeholder="جستجو نام فروشگاه، فروشنده یا آدرس..." 
         style="width:100%;max-width:400px;padding:0.7rem 1rem;border-radius:12px;border:1.5px solid #10b98144;font-size:1rem;font-family:inherit;outline:none;transition:border .15s;">
</div>
    <div class="sellers-filters" style="display:flex;gap:.7rem;margin-bottom:1.1rem;flex-wrap:wrap">
      <button class="seller-filter-btn active" data-sort="newest">جدیدترین</button>
      <button class="seller-filter-btn" data-sort="oldest">قدیمی‌ترین</button>
      <button class="seller-filter-btn" data-sort="mostvisited">پربازدیدترین</button>
      <button class="seller-filter-btn" data-sort="mostproducts">پرمحصول‌ترین</button>
    </div>

    <div class="table-wrap">
      <table id="sellersTable">
        <thead>
          <tr>
            <th>نام فروشگاه</th><th>نام صاحب فروشگاه</th><th>آدرس فروشگاه</th>
            <th>لینک فروشگاه</th><th>تعداد محصولات</th><th>بازدید</th><th>نمره ادمین</th><th>عملیات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ۴) محصولات -->
  <div class="section-panel" id="products-panel" style="display:none;">
    <div class="content-header">محصولات <span class="header-count" id="header-products-count"></span></div>

<!-- جستجوی محصولات -->
<div style="margin-bottom:1rem;display:flex;gap:0.5rem;align-items:center;">
  <input type="text" id="productSearch" placeholder="جستجو نام محصول، فروشنده یا فروشگاه..." 
         style="width:100%;max-width:400px;padding:0.7rem 1rem;border-radius:12px;border:1.5px solid #10b98144;font-size:1rem;font-family:inherit;outline:none;transition:border .15s;">
</div>

<!-- فیلتر مرتب‌سازی محصولات -->
<div class="products-filters" style="display:flex;gap:.7rem;margin-bottom:1.1rem;flex-wrap:wrap">
  <button class="seller-filter-btn active" data-sort="newest">جدیدترین</button>
  <button class="seller-filter-btn" data-sort="oldest">قدیمی‌ترین</button>
</div>

    <div class="table-wrap">
      <table id="productsTable">
    <!-- productsTable – header AFTER the change -->
<thead>
  <tr>
    <th>نام محصول</th>  <!-- ستون جدید برای نام محصول -->
    <th>نام فروشگاه</th>
    <th>نام صاحب فروشگاه</th>
    <th>آدرس فروشگاه</th>
    <th>لینک فروشگاه</th>
    <th>عملیات</th>
  </tr>
</thead>

        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ۵) مراکز خرید -->
  <div class="section-panel" id="shopping-centers-panel" style="display:none;">
    <div class="content-header">مراکز خرید <span class="header-count" id="header-shopping-centers-count"></span></div>
    <div class="shopping-centers-grid">
      <form id="shoppingCenterForm" class="shopping-center-form" enctype="multipart/form-data">
        <h3>افزودن مرکز خرید جدید</h3>
        <div>
          <label for="shoppingCenterTitle">نام مرکز خرید *</label>
          <input type="text" id="shoppingCenterTitle" name="title" placeholder="مثلاً تاناکورا" required />
        </div>
        <div class="form-row">
          <div>
            <label for="shoppingCenterTag">تگ کوتاه</label>
            <input type="text" id="shoppingCenterTag" name="tag" placeholder="مثلاً محبوب" />
          </div>
          <div>
            <label for="shoppingCenterOrder">ترتیب نمایش</label>
            <input type="number" id="shoppingCenterOrder" name="order" min="0" step="1" placeholder="0" />
          </div>
        </div>
        <div>
          <label for="shoppingCenterLocation">آدرس/موقعیت</label>
          <input type="text" id="shoppingCenterLocation" name="location" placeholder="سنندج، خیابان ..." />
        </div>
        <div class="form-row">
          <div>
            <label for="shoppingCenterHours">ساعات کاری</label>
            <input type="text" id="shoppingCenterHours" name="hours" placeholder="۱۰ الی ۲۲" />
          </div>
          <div>
            <label for="shoppingCenterHolidays">روزهای تعطیل</label>
            <input type="text" id="shoppingCenterHolidays" name="holidays" placeholder="جمعه‌ها" />
          </div>
        </div>
        <div>
          <label for="shoppingCenterDescription">توضیحات</label>
          <textarea id="shoppingCenterDescription" name="description" placeholder="معرفی کوتاه مرکز خرید"></textarea>
        </div>
        <div>
          <label for="shoppingCenterImage">تصویر شاخص *</label>
          <input type="file" id="shoppingCenterImage" name="image" accept="image/*" required />
          <small style="display:block;margin-top:0.4rem;color:#6b7280;font-size:0.78rem;">فرمت JPG یا PNG با حجم حداکثر ۲ مگابایت.</small>
        </div>
        <button type="submit"><i class="ri-add-circle-line" style="margin-left:0.3rem;"></i>افزودن مرکز خرید</button>
        <div id="shoppingCenterFormMessage" style="display:none;font-size:0.85rem;padding:0.65rem 0.9rem;border-radius:12px;"></div>
      </form>
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.6rem;">
          <div style="font-weight:600;color:#0f9a8b;font-size:0.95rem;">لیست مراکز خرید فعال</div>
          <button type="button" class="shopping-centers-refresh" id="shoppingCentersRefresh">
            <i class="ri-refresh-line"></i>
            بروزرسانی لیست
          </button>
        </div>
        <div id="shoppingCentersCards" class="shopping-centers-cards"></div>
        <div id="shoppingCentersEmpty" class="shopping-centers-empty" style="display:none;">
          هنوز هیچ مرکز خریدی ثبت نشده است.
        </div>
      </div>
    </div>
  </div>

  <!-- ۶) مدیریت قیمت پلن‌ها -->
  <div class="section-panel" id="plans-panel" style="display:none;">
    <div class="content-header">مدیریت قیمت پلن‌ها</div>
    <div class="plans-center" style="flex-direction:column;gap:2.5rem;width:100%;max-width:1000px;">
      <form id="plansForm">
        <div>
          <input id="seller-phone-plans" type="text" placeholder="شماره موبایل فروشنده (اختیاری برای قیمت اختصاصی)" style="width:100%;margin-bottom:1rem;padding:0.9rem 1.2rem;font-size:1.15rem;background:#f8fafc;border:1.8px solid #e0fdfa;border-radius:16px;outline:none;"/>
        </div>
        <div>
          <label for="plan-1month">اشتراک ۱ ماهه</label>
          <input id="plan-1month" type="number" />
        </div>
        <div>
          <label for="plan-3month">اشتراک ۳ ماهه</label>
          <input id="plan-3month" type="number" />
        </div>
        <div>
          <label for="plan-12month">اشتراک ۱۲ ماهه</label>
          <input id="plan-12month" type="number" />
        </div>
        <!-- VitriPlus Price Input -->
        <div class="mb-4">
          <label class="block text-right text-sm text-green-900 mb-1">قیمت امکانات ویژه (ویتری‌پلاس)</label>
          <input type="number" id="vitriPlusPrice" name="vitriPlusPrice"
                 placeholder="مثلاً 30000"
                 class="w-full p-2 rounded-xl bg-green-100 text-green-800 text-sm text-right outline-none focus:ring-2 focus:ring-green-500"
                 dir="rtl">
        </div>
        <button type="submit">ذخیره قیمت پلن‌ها</button>
        <div id="plansMsg" style="display:none;"></div>
      </form>
    </div>
  </div>

  <!-- ۷) مدیریت قیمت تبلیغات (جداسازی‌شده) -->
  <div class="section-panel" id="ads-panel" style="display:none;">
    <div class="content-header">مدیریت قیمت تبلیغات</div>
    <div class="plans-center" style="flex-direction:column;gap:2.5rem;width:100%;max-width:1000px;">
      <form id="adsForm" class="priceForm">
        <div>
          <input id="seller-phone-ads" type="text" placeholder="شماره موبایل فروشنده (اختیاری برای قیمت اختصاصی)" style="width:100%;margin-bottom:1rem;padding:0.9rem 1.2rem;font-size:1.15rem;background:#f8fafc;border:1.8px solid #e0fdfa;border-radius:16px;outline:none;"/>
        </div>
        <div>
          <label for="ad_search">تبلیغ جستجو</label>
          <input id="ad_search" type="number" />
        </div>
        <div>
          <label for="ad_home">تبلیغ صفحه اول</label>
          <input id="ad_home" type="number" />
        </div>
        <div>
          <label for="ad_products">تبلیغ بین محصولات</label>
          <input id="ad_products" type="number" />
        </div>
        <button type="submit">ذخیره قیمت تبلیغات</button>
        <div id="adsMsg" style="display:none;"></div>
      </form>
    </div>
  </div>


  <!-- ۸) مدیریت تبلیغات ویژه -->
  <div class="section-panel" id="ad-orders-panel" style="display:none;">
    <div class="content-header">تبلیغات ویژه ثبت شده <span class="header-count" id="header-ad-orders-count"></span></div>

    <div class="ad-orders-overview">
      <div class="ad-overview-card">
        <span class="label">کل تبلیغات</span>
        <span class="value" id="adTotalCount">0</span>
      </div>
      <div class="ad-overview-card pending">
        <span class="label">در انتظار تایید</span>
        <span class="value" id="adPendingCount">0</span>
      </div>
      <div class="ad-overview-card approved">
        <span class="label">تایید شده</span>
        <span class="value" id="adApprovedCount">0</span>
      </div>
    </div>

    <div class="ad-orders-toolbar">
      <div class="filters">
        <button class="ad-filter-btn active" data-filter="all"><i class="ri-list-unordered"></i> همه</button>
        <button class="ad-filter-btn" data-filter="pending"><i class="ri-timer-line"></i> در انتظار</button>
        <button class="ad-filter-btn" data-filter="approved"><i class="ri-checkbox-circle-line"></i> تایید شده</button>
        <button class="ad-filter-btn" data-filter="rejected"><i class="ri-close-circle-line"></i> رد شده</button>
      </div>
      <div class="ad-orders-controls">
        <select id="adOrdersPlanFilter">
          <option value="all">همه پلن‌ها</option>
          <option value="ad_home">صفحه اصلی</option>
          <option value="ad_search">جستجو</option>
          <option value="ad_products">بین محصولات</option>
        </select>
        <input type="search" id="adOrdersSearch" class="ad-orders-search" placeholder="جستجو نام فروشنده، عنوان یا شماره" />
        <button id="adOrdersRefresh"><i class="ri-refresh-line"></i> بروزرسانی</button>
      </div>
    </div>

    <div class="ad-orders-status" id="adOrdersStatus" style="display:none;"></div>

    <div class="table-wrap ad-orders-table">
      <table id="adOrdersTable">
        <thead>
          <tr>
            <th>فروشنده</th>
            <th>پلن / جزئیات</th>
            <th>مبلغ</th>
            <th>ثبت درخواست</th>
            <th>آخرین وضعیت</th>
            <th>عملیات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>



  <!-- ۸) کارت‌های صفحه اصلی -->
  <div class="section-panel" id="home-section-panel" style="display:none;">
    <p style="text-align:center;color:#888">در حال بارگیری...</p>
  </div>



<!-- ۹) پیام‌ها -->
<div class="section-panel" id="messages-panel" style="display:none;">
  <div class="content-header">پیام‌ها <span class="header-count" id="header-messages-count"></span></div>


<!-- فیلتر پیام‌ها -->
<!-- فیلتر پیام‌ها -->
<div class="messages-filters" style="display:flex;gap:0.7rem;margin-bottom:1.1rem;flex-wrap:wrap;">
  <button class="seller-filter-btn active" data-filter="seller">پیام‌های فروشنده</button>
  <button class="seller-filter-btn" data-filter="customer">پیام‌های مشتری</button>
  <button class="seller-filter-btn" data-filter="newest">جدیدترین</button>
  <button class="seller-filter-btn" data-filter="oldest">قدیمی‌ترین</button>
  <button class="seller-filter-btn" data-filter="unanswered">پاسخ‌نداده‌ها</button>
</div>



<!-- 📢 کارت ارسال پیام همگانی -->
<!-- 📢 کارت ارسال پیام همگانی -->
<div class="broadcast-card collapsed" id="broadcastCard">
  <div class="broadcast-header" id="broadcastHeader">
    <i class="ri-mail-send-line"></i>
    <h4>ارسال پیام همگانی</h4>
    <i class="ri-arrow-down-s-line toggle-icon" id="broadcastToggleIcon"></i>
  </div>
  <div class="broadcast-body" id="broadcastBody">
    <!-- بقیه فرم بدون تغییر -->
    <div class="broadcast-row">
      <label for="broadcastTarget">ارسال به:</label>
      <select id="broadcastTarget">
        <option value="sellers">👩‍💼 همه فروشنده‌ها</option>
        <option value="customers">🛒 همه مشتری‌ها</option>
      </select>
    </div>
    <div class="broadcast-row">
      <label for="broadcastText">متن پیام:</label>
      <textarea id="broadcastText" placeholder="متن پیام خود را بنویسید…"></textarea>
    </div>
    <div class="broadcast-actions">
      <button onclick="sendBroadcastMessage()">ارسال پیام</button>
    </div>
    <p id="broadcastStatus" class="broadcast-status"></p>
  </div>
</div>




  <div class="table-wrap">
    <table id="messagesTable">
<thead>
  <tr>
    <th>پیام جدید</th>
    <th>آخرین پیام</th>
    <th>فرستنده</th>
    <th>تاریخ</th>
    <th>عملیات</th>
  </tr>
</thead>




      <tbody></tbody>
    </table>
  </div>
</div>



<!-- پنل جدید برای گزارش‌ها -->
<div class="section-panel" id="reports-panel" style="display:none;">
  <p style="text-align:center">در حال بارگیری...</p>
</div>


</div><!-- /main-content -->










<script>
const ADMIN_API_BASE = "http://localhost:5000/api";
const ADMIN_API_ORIGIN = "http://localhost:5000";
const SHOPPING_CENTER_PLACEHOLDER =
  'data:image/svg+xml;utf8,' +
  encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="640" height="360">' +
    '<defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">' +
    '<stop offset="0%" stop-color="#ecfdf5"/><stop offset="100%" stop-color="#e0f2fe"/>' +
    '</linearGradient></defs>' +
    '<rect width="640" height="360" fill="url(#g)"/>' +
    '<text x="50%" y="52%" font-family="Vazirmatn,Arial" font-size="36" fill="#0ea5e9"' +
    ' text-anchor="middle">Shopping Center</text>' +
    '</svg>'
  );
// اگر admin_token ست نشده، از کلید token هم استفاده کن

let messagesInterval = null;
let badgeInterval = null; // ⬅️ تایمر مجزا برای بج

/**
 * شروع polling پیام‌ها هر 5 ثانیه
 */
function startMessagesPolling() {
  // اگر قبلاً یک polling فعال است، آن را متوقف کن
  if (messagesInterval) clearInterval(messagesInterval);
  // فوراً یک‌بار پیام‌ها را بگیر
  fetchMessages().catch(console.error);
  // سپس هر 5 ثانیه یک‌بار
  messagesInterval = setInterval(() => {
    fetchMessages().catch(console.error);
  }, 5000);
}

/**
 * متوقف کردن polling
 */
function stopMessagesPolling() {
  if (messagesInterval) {
    clearInterval(messagesInterval);
    messagesInterval = null;
  }
}




/* بعد از const token = … این را اضافه کن */
function toIdString(raw) {
  if (!raw) return '';

  if (typeof raw === 'string') return raw;

  if (typeof raw === 'object') {
    if (raw.$oid) return String(raw.$oid);
    if (raw._id) return String(raw._id);
    if (raw.id) return String(raw.id);

    if (typeof raw.toString === 'function') {
      return raw.toString();
    }
  }

  return String(raw);
}

function formatNumber(value) {
  const num = Number(value);
  if (!Number.isFinite(num)) return numberFormatter.format(0);
  return numberFormatter.format(num);
}

function toAbsoluteMediaUrl(path, fallback = SHOPPING_CENTER_PLACEHOLDER) {
  if (!path) return fallback;
  const str = String(path);
  if (str.startsWith('http://') || str.startsWith('https://') || str.startsWith('data:')) {
    return str;
  }
  if (str.startsWith('/')) {
    return `${ADMIN_API_ORIGIN}${str}`;
  }
  return `${ADMIN_API_ORIGIN}/${str.replace(/^\/+/, '')}`;
}

function getShoppingCenterId(center) {
  if (!center) return '';
  return toIdString(center.centerId || center._id || center.id || center._id?.$oid || '');
}

function normalizeShoppingCenter(center = {}) {
  if (!center || typeof center !== 'object') return null;
  const normalised = { ...center };
  normalised.centerId = getShoppingCenterId(center);
  normalised.title = normalised.title || normalised.name || 'بدون نام';
  const orderNum = Number(normalised.order);
  normalised.order = Number.isFinite(orderNum) ? orderNum : 0;
  const storesNum = Number(normalised.stores);
  normalised.stores = Number.isFinite(storesNum) ? storesNum : 0;
  return normalised;
}

function sortShoppingCenters(list = []) {
  return [...list].sort((a, b) => {
    const orderA = Number.isFinite(a?.order) ? a.order : 0;
    const orderB = Number.isFinite(b?.order) ? b.order : 0;
    if (orderA !== orderB) return orderA - orderB;
    const dateA = new Date(a?.createdAt || 0).getTime();
    const dateB = new Date(b?.createdAt || 0).getTime();
    return dateB - dateA;
  });
}

function upsertShoppingCenterLocal(center) {
  const normalised = normalizeShoppingCenter(center);
  if (!normalised) return;
  const id = getShoppingCenterId(normalised);
  let updated = false;
  shoppingCentersList = shoppingCentersList.map(existing => {
    if (getShoppingCenterId(existing) === id) {
      updated = true;
      return { ...existing, ...normalised };
    }
    return existing;
  });
  if (!updated) {
    shoppingCentersList.push(normalised);
  }
  shoppingCentersList = sortShoppingCenters(shoppingCentersList);
}

function removeShoppingCenterLocal(id) {
  const normalisedId = toIdString(id);
  if (!normalisedId) return;
  shoppingCentersList = shoppingCentersList.filter(center => getShoppingCenterId(center) !== normalisedId);
}

async function fetchShoppingCenters() {
  try {
    const res = await fetch(`${ADMIN_API_BASE}/shopping-centers`, { credentials: 'include' });
    if (!res.ok) {
      console.error('fetchShoppingCenters – HTTP-', res.status, await res.text());
      return [];
    }
    const data = await res.json();
    if (!Array.isArray(data)) return [];
    const list = data
      .map(normalizeShoppingCenter)
      .filter(Boolean);
    return sortShoppingCenters(list);
  } catch (err) {
    console.error('fetchShoppingCenters – EXCEPTION', err);
    return [];
  }
}

function createShoppingCenterMetaRow(iconClass, text) {
  if (!text) return null;
  const span = document.createElement('span');
  const icon = document.createElement('i');
  icon.className = iconClass;
  span.appendChild(icon);
  span.appendChild(document.createTextNode(` ${text}`));
  return span;
}

function renderShoppingCenters() {
  const cardsWrap = document.getElementById('shoppingCentersCards');
  const emptyState = document.getElementById('shoppingCentersEmpty');
  if (!cardsWrap || !emptyState) return;

  cardsWrap.innerHTML = '';

  if (!shoppingCentersList.length) {
    cardsWrap.style.display = 'none';
    emptyState.style.display = 'flex';
    return;
  }

  cardsWrap.style.display = 'grid';
  emptyState.style.display = 'none';

  shoppingCentersList.forEach(center => {
    const card = document.createElement('div');
    card.className = 'shopping-center-card';

    const img = document.createElement('img');
    img.src = toAbsoluteMediaUrl(center.image, SHOPPING_CENTER_PLACEHOLDER);
    img.alt = center.title || 'مرکز خرید';
    card.appendChild(img);

    const body = document.createElement('div');
    body.className = 'shopping-center-body';

    const title = document.createElement('h4');
    title.textContent = center.title || 'مرکز خرید';
    body.appendChild(title);

    if (center.tag) {
      const tag = document.createElement('span');
      tag.className = 'shopping-center-tag';
      tag.textContent = center.tag;
      body.appendChild(tag);
    }

    if (center.description) {
      const desc = document.createElement('p');
      desc.className = 'shopping-center-desc';
      desc.textContent = center.description;
      body.appendChild(desc);
    }

    const meta = document.createElement('div');
    meta.className = 'shopping-center-meta';
    const storesRow = createShoppingCenterMetaRow('ri-store-2-line', `${formatNumber(center.stores)} فروشگاه`);
    if (storesRow) meta.appendChild(storesRow);
    const locationRow = createShoppingCenterMetaRow('ri-map-pin-2-line', center.location);
    if (locationRow) meta.appendChild(locationRow);
    const hoursRow = createShoppingCenterMetaRow('ri-time-line', center.hours);
    if (hoursRow) meta.appendChild(hoursRow);
    const holidayRow = createShoppingCenterMetaRow('ri-calendar-event-line', center.holidays);
    if (holidayRow) meta.appendChild(holidayRow);
    if (meta.childNodes.length) {
      body.appendChild(meta);
    }

    const actions = document.createElement('div');
    actions.className = 'shopping-center-actions';
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete';
    deleteBtn.innerHTML = '<i class="ri-delete-bin-line"></i> حذف';
    const id = getShoppingCenterId(center);
    deleteBtn.addEventListener('click', () => window.deleteShoppingCenter(id));
    actions.appendChild(deleteBtn);
    body.appendChild(actions);

    card.appendChild(body);
    cardsWrap.appendChild(card);
  });
}

function setShoppingCenterFormMessage(message, type = 'success', timeout = 3500) {
  const box = document.getElementById('shoppingCenterFormMessage');
  if (!box) return;

  if (shoppingCenterFormMessageTimer) {
    clearTimeout(shoppingCenterFormMessageTimer);
    shoppingCenterFormMessageTimer = null;
  }

  if (!message) {
    box.style.display = 'none';
    return;
  }

  const styles = {
    success: { bg: '#ecfdf5', color: '#047857' },
    error:   { bg: '#fee2e2', color: '#dc2626' },
    info:    { bg: '#e0f2fe', color: '#0369a1' }
  };
  const palette = styles[type] || styles.success;
  box.textContent = message;
  box.style.background = palette.bg;
  box.style.color = palette.color;
  box.style.display = 'block';

  if (timeout > 0) {
    shoppingCenterFormMessageTimer = setTimeout(() => {
      box.style.display = 'none';
      shoppingCenterFormMessageTimer = null;
    }, timeout);
  }
}

async function ensureShoppingCentersLoaded(force = false) {
  if (force) {
    shoppingCentersLoaded = false;
    shoppingCentersLoadingPromise = null;
  }

  if (shoppingCentersLoaded && !force) {
    return shoppingCentersList;
  }

  if (!shoppingCentersLoadingPromise) {
    shoppingCentersLoadingPromise = (async () => {
      const list = await fetchShoppingCenters();
      shoppingCentersList = list;
      shoppingCentersLoaded = true;
      renderShoppingCenters();
      updateSidebarCounts();
      updateHeaderCounts();
      return list;
    })().finally(() => {
      shoppingCentersLoadingPromise = null;
    });
  }

  return shoppingCentersLoadingPromise;
}

async function handleShoppingCenterSubmit(event) {
  event.preventDefault();
  const form = event.currentTarget;
  const formData = new FormData(form);

  const title = String(formData.get('title') || '').trim();
  if (!title) {
    setShoppingCenterFormMessage('لطفاً نام مرکز خرید را وارد کنید.', 'error');
    return;
  }

  try {
    setShoppingCenterFormMessage('در حال ثبت مرکز خرید...', 'info', 0);
    const res = await fetch(`${ADMIN_API_BASE}/shopping-centers`, {
      method: 'POST',
      credentials: 'include',
      body: formData
    });
    let data = {};
    try {
      data = await res.json();
    } catch (err) {
      data = {};
    }
    if (!res.ok) {
      throw new Error(data?.error || data?.message || 'خطا در ذخیره مرکز خرید');
    }

    upsertShoppingCenterLocal(data);
    renderShoppingCenters();
    updateSidebarCounts();
    updateHeaderCounts();
    form.reset();
    setShoppingCenterFormMessage('مرکز خرید با موفقیت افزوده شد.', 'success');
  } catch (err) {
    console.error('handleShoppingCenterSubmit error:', err);
    setShoppingCenterFormMessage(`خطا: ${err.message}`, 'error', 6000);
  }
}

window.deleteShoppingCenter = async function(id) {
  const normalisedId = toIdString(id);
  if (!normalisedId) {
    alert('شناسه مرکز خرید معتبر نیست.');
    return;
  }

  if (!confirm('آیا از حذف این مرکز خرید مطمئن هستید؟')) return;

  try {
    const res = await fetch(`${ADMIN_API_BASE}/shopping-centers/${normalisedId}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    let data = {};
    try {
      data = await res.json();
    } catch (err) {
      data = {};
    }
    if (!res.ok) {
      throw new Error(data?.error || data?.message || 'خطا در حذف مرکز خرید');
    }

    removeShoppingCenterLocal(normalisedId);
    renderShoppingCenters();
    updateSidebarCounts();
    updateHeaderCounts();
    alert('✅ مرکز خرید با موفقیت حذف شد.');
  } catch (err) {
    console.error('deleteShoppingCenter error:', err);
    alert('❌ ' + err.message);
  }
};

function escapeHtml(value) {
  if (value === null || value === undefined) return '';
  return String(value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function formatNoteForDisplay(note) {
  if (!note) return '';
  return escapeHtml(note).replace(/\n/g, '<br>');
}

function formatDateTime(value) {
  if (!value) return '';
  try {
    return new Date(value).toLocaleString('fa-IR', {
      dateStyle: 'medium',
      timeStyle: 'short'
    });
  } catch (err) {
    return '';
  }
}

function toDatetimeLocalValue(value) {
  if (!value) return '';
  try {
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) {
      return '';
    }
    const offset = date.getTimezoneOffset();
    const local = new Date(date.getTime() - offset * 60000);
    return local.toISOString().slice(0, 16);
  } catch (err) {
    return '';
  }
}







const numberFormatter = new Intl.NumberFormat('fa-IR');
const persianDateFormatter = new Intl.DateTimeFormat('fa-IR', { month: 'numeric', day: 'numeric' });

let dashboardSummary = {
  visitsToday: 0,
  newUsersToday: 0,
  newSellersToday: 0,
  newProductsToday: 0,
  newServiceShopsToday: 0,
  totalUsers: 0,
  totalSellers: 0,
  totalProducts: 0,
  totalServiceShops: 0,
  activeServiceShops: 0,
  pendingServiceShops: 0,
  premiumServiceShops: 0,
  generatedAt: null,
  range: null
};

let dashboardTrend = [];
let trendLabels = [];
let visitsPerDay = [];
let usersPerDay = [];
let sellersPerDay = [];
let productsPerDay = [];
let serviceShopsPerDay = [];

let usersList = [];
let shopsList = [];
let productsList = [];
let shoppingCentersList = [];
let shoppingCentersLoaded = false;
let shoppingCentersLoadingPromise = null;
let shoppingCenterFormMessageTimer = null;
let productsSortMode = 'newest';  // حالت پیش‌فرض مرتب‌سازی
let productSearchQuery = '';      // کوئری جستجو (برای فیلتر)

let adOrdersList = [];
let adOrdersLoaded = false;
let adOrdersLoadingPromise = null;
let adOrdersFilter = 'all';
let adOrdersSearchTerm = '';
let adOrdersPlanFilter = 'all';
let currentAdOrderId = null;
let adModalOverlayHandler = null;

let sellerPerformanceMap = {};
let sellerPerformanceLoaded = false;

const AD_PLAN_META = {
  ad_home: {
    label: 'تبلیغ صفحه اصلی',
    location: 'بخش ویژه صفحه اصلی ویترینت',
    icon: 'ri-home-smile-line',
    url: '/index.html#drag-scroll-cards'
  },
  ad_search: {
    label: 'تبلیغ جستجو',
    location: 'پاپ‌آپ جستجوی سریع صفحه اصلی',
    icon: 'ri-search-2-line',
    url: '/index.html#searchForm'
  },
  ad_products: {
    label: 'تبلیغ بین محصولات',
    location: 'صفحه لیست محصولات و نتایج جستجو',
    icon: 'ri-store-3-line',
    url: '/all-products.html'
  }
};

const AD_STATUS_META = {
  pending:  { label: 'در انتظار تایید', icon: 'ri-timer-line', className: 'pending' },
  approved: { label: 'تایید شده',      icon: 'ri-checkbox-circle-line', className: 'approved' },
  rejected: { label: 'رد شده',          icon: 'ri-close-circle-line', className: 'rejected' },
  paid:     { label: 'پرداخت شده',      icon: 'ri-bank-card-line', className: 'paid' },
  expired:  { label: 'منقضی شده',       icon: 'ri-time-line', className: 'expired' }
};

function normaliseSlug(value) {
  return String(value || '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, '_')
    .replace(/-+/g, '_');
}

const AD_PLAN_LABELS = Object.keys(AD_PLAN_META).reduce((acc, key) => {
  acc[key] = AD_PLAN_META[key].label;
  return acc;
}, {});

function getAdPlanMeta(slug, fallback = 'تبلیغ ویژه') {
  const normalisedSlug = normaliseSlug(slug);
  if (normalisedSlug && AD_PLAN_META[normalisedSlug]) {
    return AD_PLAN_META[normalisedSlug];
  }
  return {
    label: fallback || 'تبلیغ ویژه',
    location: 'محل نمایش نامشخص',
    icon: 'ri-information-line',
    url: null
  };
}

function getAdPlanLabel(slug, fallback = 'تبلیغ ویژه') {
  return getAdPlanMeta(slug, fallback).label;
}

function getAdStatusMeta(status) {
  const key = normaliseSlug(status);
  if (key && AD_STATUS_META[key]) {
    return AD_STATUS_META[key];
  }
  return { label: 'نامشخص', icon: 'ri-question-line', className: 'unknown' };
}

const adOrdersTableBody = document.querySelector('#adOrdersTable tbody');
const adOrdersStatusEl = document.getElementById('adOrdersStatus');
const adOrdersPlanFilterEl = document.getElementById('adOrdersPlanFilter');
const adOrdersSearchEl = document.getElementById('adOrdersSearch');
const adOrdersRefreshBtn = document.getElementById('adOrdersRefresh');
const adOrdersHeaderCountEl = document.getElementById('header-ad-orders-count');
const adSidebarCountEl = document.getElementById('count-ad-orders');
const adTotalCountEl = document.getElementById('adTotalCount');
const adPendingCountEl = document.getElementById('adPendingCount');
const adApprovedCountEl = document.getElementById('adApprovedCount');

const currencyFormatter = new Intl.NumberFormat('fa-IR', { maximumFractionDigits: 0 });

function formatCurrency(amount) {
  if (amount === null || amount === undefined || Number.isNaN(Number(amount))) {
    return '—';
  }
  return `${currencyFormatter.format(Math.round(Number(amount)))} تومان`;
}

function formatDateTime(value) {
  if (!value) return '—';
  try {
    return new Date(value).toLocaleString('fa-IR', { dateStyle: 'medium', timeStyle: 'short' });
  } catch (err) {
    return '—';
  }
}

function buildUploadsUrl(path) {
  if (!path) return '';
  if (/^https?:/i.test(path)) return path;
  const base = ADMIN_API_BASE.replace(/\/api$/, '');
  return `${base}/uploads/${path.replace(/^\/?uploads\//, '')}`;
}

function setAdOrdersStatus(message = '', type = 'info') {
  if (!adOrdersStatusEl) return;
  adOrdersStatusEl.classList.remove('info', 'success', 'error');
  if (!message) {
    adOrdersStatusEl.style.display = 'none';
    adOrdersStatusEl.textContent = '';
    return;
  }
  adOrdersStatusEl.textContent = message;
  adOrdersStatusEl.classList.add(type);
  adOrdersStatusEl.style.display = 'block';
}

function setAdOrdersLoading(isLoading) {
  if (!adOrdersTableBody) return;
  if (isLoading) {
    adOrdersTableBody.innerHTML = `<tr><td colspan="6" class="loading-row"><i class="ri-loader-4-line ri-spin"></i> در حال بارگذاری تبلیغات...</td></tr>`;
  }
}

function getOrderId(order) {
  return order ? (order._id || order.id || order.orderId || '') : '';
}

function updateAdOrdersSummary() {
  const total = adOrdersList.length;
  const pending = adOrdersList.filter(order => order.status === 'pending').length;
  const approved = adOrdersList.filter(order => order.status === 'approved').length;

  if (adTotalCountEl) adTotalCountEl.textContent = formatNumber(total);
  if (adPendingCountEl) adPendingCountEl.textContent = formatNumber(pending);
  if (adApprovedCountEl) adApprovedCountEl.textContent = formatNumber(approved);
  if (adSidebarCountEl) adSidebarCountEl.textContent = formatNumber(pending);

  if (adOrdersHeaderCountEl) {
    adOrdersHeaderCountEl.textContent = total
      ? `(${formatNumber(total)} تبلیغ | ${formatNumber(pending)} در انتظار | ${formatNumber(approved)} تایید شده)`
      : '(هیچ تبلیغی ثبت نشده)';
  }
}

function renderAdOrders() {
  if (!adOrdersTableBody) return;

  let rows = [...adOrdersList];

  if (adOrdersFilter && adOrdersFilter !== 'all') {
    rows = rows.filter(order => order.status === adOrdersFilter);
  }

  if (adOrdersPlanFilter && adOrdersPlanFilter !== 'all') {
    rows = rows.filter(order => (order.planSlug || '') === adOrdersPlanFilter);
  }

  if (adOrdersSearchTerm) {
    const term = adOrdersSearchTerm;
    rows = rows.filter(order => {
      const seller = order && typeof order.sellerId === 'object' && order.sellerId !== null ? order.sellerId : {};
      const sellerName = ((seller.storename || order.shopTitle || '')).toLowerCase();
      const sellerPhone = ((seller.phone || order.sellerPhone || '')).toLowerCase();
      const adTitle = (order.adTitle || order.planTitle || '').toLowerCase();
      const planLabel = getAdPlanLabel(order.planSlug || '', order.planTitle || '').toLowerCase();
      return (
        sellerName.includes(term) ||
        sellerPhone.includes(term) ||
        adTitle.includes(term) ||
        planLabel.includes(term)
      );
    });
  }

  rows.sort((a, b) => {
    const aTime = a && a.createdAt ? new Date(a.createdAt).getTime() : 0;
    const bTime = b && b.createdAt ? new Date(b.createdAt).getTime() : 0;
    return bTime - aTime;
  });

  if (!rows.length) {
    if (!adOrdersList.length) {
      adOrdersTableBody.innerHTML = `<tr><td colspan="6" class="empty-row">هنوز تبلیغی ثبت نشده است.</td></tr>`;
    } else {
      adOrdersTableBody.innerHTML = `<tr><td colspan="6" class="empty-row">هیچ تبلیغی مطابق فیلترهای انتخابی یافت نشد.</td></tr>`;
    }
    return;
  }

  const rowsHtml = rows.map(order => {
    const seller = order && typeof order.sellerId === 'object' && order.sellerId !== null ? order.sellerId : {};
    const sellerName = seller.storename || order.shopTitle || 'بدون نام';
    const sellerPhone = seller.phone || order.sellerPhone || '';
    const sellerAddress = seller.address || seller.city || '';
    const planMeta = getAdPlanMeta(order.planSlug || '', order.planTitle || 'تبلیغ ویژه');
    const planLabel = planMeta.label;
    const planIcon = planMeta.icon || 'ri-compass-3-line';
    const planLocationBadge = planMeta.location
      ? `<span class="ad-plan-location"><i class="${planIcon}"></i>${escapeHtml(planMeta.location)}</span>`
      : '';
    const statusMeta = getAdStatusMeta(order.status);
    const createdAt = formatDateTime(order.createdAt);
    const reviewedAt = order.reviewedAt ? formatDateTime(order.reviewedAt) : '';
    const reviewedBy = order.reviewedBy && order.reviewedBy.name ? order.reviewedBy.name : '';
    const displayedAt = order.displayedAt
      ? formatDateTime(order.displayedAt)
      : (order.approvedAt ? formatDateTime(order.approvedAt) : '');
    const orderId = escapeHtml(getOrderId(order));

    const product = order && typeof order.productId === 'object' && order.productId !== null ? order.productId : null;
    const productBadge = product
      ? `<span class="ad-cell-secondary"><i class="ri-shopping-bag-3-line"></i>${escapeHtml(product.title || 'محصول ویژه')}</span>`
      : '';

    const sellerMetaParts = [];
    if (sellerPhone) sellerMetaParts.push(`<span><i class="ri-phone-line"></i>${escapeHtml(sellerPhone)}</span>`);
    if (sellerAddress) sellerMetaParts.push(`<span><i class="ri-map-pin-line"></i>${escapeHtml(sellerAddress)}</span>`);

    const reviewNoteParts = [];
    if (reviewedAt) reviewNoteParts.push(`بررسی: ${reviewedAt}`);
    if (reviewedBy) reviewNoteParts.push(`توسط ${escapeHtml(reviewedBy)}`);
    const reviewText = reviewNoteParts.length ? reviewNoteParts.join(' | ') : 'در انتظار بررسی ادمین';

    const adText = order.adText ? `<div class="ad-text">${escapeHtml(order.adText)}</div>` : '';

    let quickActions = '';
    if (order.status === 'pending') {
      quickActions = `
        <button class="ad-action-btn approve" data-action="quick-approve" data-id="${orderId}">
          <i class="ri-checkbox-circle-line"></i> تایید سریع
        </button>
        <button class="ad-action-btn reject" data-action="quick-reject" data-id="${orderId}">
          <i class="ri-close-circle-line"></i> رد
        </button>
      `;
    } else if (order.status === 'approved') {
      quickActions = `
        <button class="ad-action-btn ghost" data-action="quick-edit" data-id="${orderId}">
          <i class="ri-edit-line"></i> ویرایش
        </button>
        <button class="ad-action-btn reject" data-action="quick-delete" data-id="${orderId}">
          <i class="ri-delete-bin-line"></i> حذف
        </button>
      `;
    }

    const displayDateHtml = displayedAt
      ? `<span class="ad-date-live"><i class="ri-calendar-check-line"></i> نمایش: ${displayedAt}</span>`
      : `<span class="ad-date-pending"><i class="ri-time-line"></i> در انتظار نمایش</span>`;

    const viewLocationButton = planMeta.url
      ? `<a class="ad-action-btn link" href="${escapeHtml(planMeta.url)}" target="_blank" rel="noopener"><i class="ri-external-link-line"></i> مشاهده صفحه</a>`
      : '';

    return `
      <tr class="ad-order-row" data-order-id="${orderId}">
        <td>
          <div class="ad-cell-primary">${escapeHtml(sellerName)}</div>
          ${sellerMetaParts.length ? `<div class="ad-cell-secondary">${sellerMetaParts.join('')}</div>` : ''}
        </td>
        <td>
          <span class="ad-plan-pill"><i class="ri-megaphone-line"></i>${escapeHtml(planLabel)}</span>
          ${planLocationBadge}
          ${productBadge}
          <div class="ad-title">${escapeHtml(order.adTitle || order.planTitle || 'بدون عنوان')}</div>
          ${adText}
        </td>
        <td><div class="ad-price">${formatCurrency(order.price)}</div></td>
        <td>
          <div class="ad-date">
            <span><i class="ri-calendar-line"></i> ثبت: ${createdAt}</span>
            ${displayDateHtml}
          </div>
        </td>
        <td>
          <div class="ad-status-cell">
            <span class="ad-status-badge ${statusMeta.className}"><i class="${statusMeta.icon}"></i>${statusMeta.label}</span>
            <div class="ad-status-note">${reviewText}</div>
          </div>
        </td>
        <td>
          <div class="ad-actions">
            ${viewLocationButton}
            <button class="ad-action-btn ghost" data-action="view" data-id="${orderId}"><i class="ri-eye-line"></i> جزئیات</button>
            ${quickActions}
          </div>
        </td>
      </tr>
    `;
  }).join('');

  adOrdersTableBody.innerHTML = rowsHtml;
  attachAdOrdersRowActions();
}

function attachAdOrdersRowActions() {
  if (!adOrdersTableBody) return;

  adOrdersTableBody.querySelectorAll('tr.ad-order-row').forEach(row => {
    row.addEventListener('click', event => {
      const interactive = event.target.closest('button, a, .ad-actions, [data-action]');
      if (interactive) {
        return;
      }
      const id = row.dataset.orderId;
      if (id) {
        openAdOrderModal(id);
      }
    });
  });

  adOrdersTableBody.querySelectorAll('button[data-action="view"]').forEach(btn => {
    btn.addEventListener('click', () => openAdOrderModal(btn.dataset.id));
  });

  adOrdersTableBody.querySelectorAll('button[data-action="quick-edit"]').forEach(btn => {
    btn.addEventListener('click', () => openAdOrderModal(btn.dataset.id));
  });

  adOrdersTableBody.querySelectorAll('button[data-action="quick-approve"]').forEach(btn => {
    btn.addEventListener('click', () => handleQuickAdAction(btn, 'approved'));
  });

  adOrdersTableBody.querySelectorAll('button[data-action="quick-reject"]').forEach(btn => {
    btn.addEventListener('click', () => handleQuickAdAction(btn, 'rejected'));
  });

  adOrdersTableBody.querySelectorAll('button[data-action="quick-delete"]').forEach(btn => {
    btn.addEventListener('click', () => handleQuickDelete(btn));
  });
}

function setButtonLoading(button, isLoading) {
  if (!button) return;
  if (isLoading) {
    button.dataset.originalHtml = button.innerHTML;
    button.classList.add('is-loading');
    button.innerHTML = '<i class="ri-loader-4-line ri-spin"></i>';
    button.disabled = true;
  } else {
    if (!document.body.contains(button)) return;
    button.classList.remove('is-loading');
    button.disabled = false;
    if (button.dataset.originalHtml !== undefined) {
      button.innerHTML = button.dataset.originalHtml;
      delete button.dataset.originalHtml;
    }
  }
}

function handleQuickAdAction(button, status) {
  const orderId = button?.dataset?.id;
  if (!orderId) return;
  const actionLabel = status === 'approved' ? 'تایید' : 'رد';
  if (!confirm(`آیا از ${actionLabel} این تبلیغ مطمئن هستید؟`)) {
    return;
  }
  setButtonLoading(button, true);
  updateAdOrderStatus(orderId, status, undefined, { silent: false })
    .catch(() => {})
    .finally(() => setButtonLoading(button, false));
}

function handleQuickDelete(button) {
  const orderId = button?.dataset?.id;
  if (!orderId) return;
  if (!confirm('آیا از حذف این تبلیغ مطمئن هستید؟')) {
    return;
  }
  setButtonLoading(button, true);
  removeAdOrder(orderId, { silent: false })
    .catch(() => {})
    .finally(() => setButtonLoading(button, false));
}

async function updateAdOrderStatus(orderId, status, note, { silent = false } = {}) {
  if (!orderId || !status) return null;
  const payload = { status };
  if (note !== undefined) payload.adminNote = note;

  try {
    const res = await fetch(`${ADMIN_API_BASE}/adOrder/${encodeURIComponent(orderId)}/status`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.error || data.message || 'خطا در بروزرسانی تبلیغ.');
    }

    const updated = data.adOrder || data.order || null;
    if (updated) {
      const updatedId = getOrderId(updated);
      const idx = adOrdersList.findIndex(order => getOrderId(order) === updatedId);
      if (idx !== -1) {
        adOrdersList[idx] = updated;
      } else {
        adOrdersList.push(updated);
      }
      updateAdOrdersSummary();
      renderAdOrders();
    }

    if (!silent) {
      setAdOrdersStatus(data.message || 'وضعیت تبلیغ بروزرسانی شد.', 'success');
    }

    return updated;
  } catch (err) {
    console.error('updateAdOrderStatus error:', err);
    if (!silent) {
      setAdOrdersStatus(err.message || 'خطا در بروزرسانی تبلیغ.', 'error');
    }
    throw err;
  }
}

async function removeAdOrder(orderId, { silent = false } = {}) {
  if (!orderId) return false;

  try {
    const res = await fetch(`${ADMIN_API_BASE}/adOrder/${encodeURIComponent(orderId)}`, {
      method: 'DELETE',
      credentials: 'include'
    });

    let data = {};
    try {
      data = await res.json();
    } catch (err) {
      data = {};
    }

    if (!res.ok) {
      throw new Error(data.error || data.message || 'خطا در حذف تبلیغ.');
    }

    const idx = adOrdersList.findIndex(order => getOrderId(order) === orderId);
    if (idx !== -1) {
      adOrdersList.splice(idx, 1);
    }
    updateAdOrdersSummary();
    renderAdOrders();

    if (!silent) {
      setAdOrdersStatus(data.message || 'تبلیغ حذف شد.', 'success');
    }

    return true;
  } catch (err) {
    console.error('removeAdOrder error:', err);
    if (!silent) {
      setAdOrdersStatus(err.message || 'خطا در حذف تبلیغ.', 'error');
    }
    throw err;
  }
}

async function updateAdOrderDetails(orderId, updates, { silent = false } = {}) {
  if (!orderId || !updates || typeof updates !== 'object') return null;

  try {
    const res = await fetch(`${ADMIN_API_BASE}/adOrder/${encodeURIComponent(orderId)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(updates)
    });

    let data = {};
    try {
      data = await res.json();
    } catch (err) {
      data = {};
    }

    if (!res.ok) {
      throw new Error(data.error || data.message || 'خطا در بروزرسانی تبلیغ.');
    }

    const updated = data.adOrder || data.order || null;
    if (updated) {
      const updatedId = getOrderId(updated);
      const idx = adOrdersList.findIndex(item => getOrderId(item) === updatedId);
      if (idx !== -1) {
        adOrdersList[idx] = updated;
      } else {
        adOrdersList.push(updated);
      }
      updateAdOrdersSummary();
      renderAdOrders();
    }

    if (!silent) {
      setAdOrdersStatus(data.message || 'تبلیغ بروزرسانی شد.', 'success');
    }

    return updated;
  } catch (err) {
    console.error('updateAdOrderDetails error:', err);
    if (!silent) {
      setAdOrdersStatus(err.message || 'خطا در بروزرسانی تبلیغ.', 'error');
    }
    throw err;
  }
}

async function loadAdOrders(force = false) {
  if (force) {
    adOrdersLoaded = false;
  }

  if (adOrdersLoadingPromise) {
    return adOrdersLoadingPromise;
  }

  if (adOrdersLoaded) {
    renderAdOrders();
    return adOrdersList;
  }

  setAdOrdersLoading(true);
  setAdOrdersStatus('');

  adOrdersLoadingPromise = (async () => {
    try {
      const res = await fetch(`${ADMIN_API_BASE}/adOrder`, { credentials: 'include' });
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || data.message || 'خطا در دریافت تبلیغات.');
      }

      const list = Array.isArray(data.adOrders) ? data.adOrders : [];
      adOrdersList = list;
      adOrdersLoaded = true;
      updateAdOrdersSummary();
      renderAdOrders();
      if (!list.length) {
        setAdOrdersStatus('هنوز تبلیغی ثبت نشده است.', 'info');
      }
      return list;
    } catch (err) {
      adOrdersLoaded = false;
      console.error('loadAdOrders error:', err);
      setAdOrdersStatus(err.message || 'خطا در دریافت تبلیغات.', 'error');
      if (adOrdersTableBody) {
        adOrdersTableBody.innerHTML = `<tr><td colspan="6" class="empty-row">خطا در دریافت تبلیغات.</td></tr>`;
      }
      throw err;
    } finally {
      adOrdersLoadingPromise = null;
    }
  })();

  return adOrdersLoadingPromise;
}

function openAdOrderModal(orderId) {
  const overlay = document.getElementById('ad-order-modal');
  if (!overlay || !orderId) return;

  const order = adOrdersList.find(item => getOrderId(item) === orderId);
  if (!order) {
    setAdOrdersStatus('تبلیغ مورد نظر یافت نشد.', 'error');
    return;
  }

  currentAdOrderId = orderId;
  renderAdOrderModal(order);
  overlay.style.display = 'flex';

  if (adModalOverlayHandler) {
    overlay.removeEventListener('click', adModalOverlayHandler);
  }
  adModalOverlayHandler = event => {
    if (event.target === overlay) {
      closeAdOrderModal();
    }
  };
  overlay.addEventListener('click', adModalOverlayHandler);
}

function renderAdOrderModal(order) {
  const overlay = document.getElementById('ad-order-modal');
  if (!overlay || !order) return;

  const seller = typeof order.sellerId === 'object' && order.sellerId !== null ? order.sellerId : {};
  const product = typeof order.productId === 'object' && order.productId !== null ? order.productId : null;
  const planMeta = getAdPlanMeta(order.planSlug || '', order.planTitle || 'تبلیغ ویژه');
  const planLabel = planMeta.label;
  const planIcon = planMeta.icon || 'ri-compass-3-line';
  const planLocationRow = planMeta.location
    ? `<span><span class="label">محل نمایش:</span> <i class="${planIcon}"></i> ${escapeHtml(planMeta.location)}${planMeta.url ? ` <a href="${escapeHtml(planMeta.url)}" target="_blank" rel="noopener">(مشاهده)</a>` : ''}</span>`
    : '';
  const planVisitLink = planMeta.url
    ? `<div class="ad-modal-visit"><a href="${escapeHtml(planMeta.url)}" target="_blank" rel="noopener"><i class="ri-external-link-line"></i> مشاهده محل نمایش در سایت</a></div>`
    : '';
  const statusMeta = getAdStatusMeta(order.status);
  const sellerName = seller.storename || order.shopTitle || 'بدون نام';
  const sellerPhone = seller.phone || order.sellerPhone || '';
  const sellerAddress = seller.address || seller.city || '';
  const shopurl = seller.shopurl || '';
  const createdAt = formatDateTime(order.createdAt);
  const reviewedAt = order.reviewedAt ? formatDateTime(order.reviewedAt) : '';
  const approvedAt = order.approvedAt ? formatDateTime(order.approvedAt) : '';
  const reviewedBy = order.reviewedBy && order.reviewedBy.name ? order.reviewedBy.name : '';
  const bannerUrl = order.bannerImage ? buildUploadsUrl(order.bannerImage) : '';
  const adminNoteValue = order.adminNote || '';
  const orderId = getOrderId(order);
  currentAdOrderId = orderId || currentAdOrderId;

  const displayDateValue = order.displayedAt || order.approvedAt || null;
  const displayedAt = displayDateValue ? formatDateTime(displayDateValue) : '';
  const displayedAtInputValue = toDatetimeLocalValue(displayDateValue);
  const titleValue = order.adTitle || '';
  const previewTitle = order.adTitle || order.planTitle || planLabel;
  const textValue = order.adText || '';
  const priceInputValue = order.price !== undefined && order.price !== null ? String(order.price) : '';

  overlay.innerHTML = `
    <div class="ad-modal" role="dialog" aria-modal="true">
      <button type="button" class="ad-modal-close" onclick="closeAdOrderModal()" aria-label="بستن پنجره">×</button>
      <div class="ad-modal-title">
        <i class="ri-megaphone-line"></i>
        بررسی تبلیغ ویژه
        <span class="badge">${escapeHtml(planLabel)}</span>
      </div>
      ${planVisitLink}

      <div class="ad-modal-grid">
        <div class="ad-modal-section">
          <h4>اطلاعات فروشنده</h4>
          <div class="ad-modal-meta">
            <span><span class="label">نام فروشگاه:</span> ${escapeHtml(sellerName)}</span>
            ${sellerPhone ? `<span><span class="label">شماره تماس:</span> ${escapeHtml(sellerPhone)}</span>` : ''}
            ${sellerAddress ? `<span><span class="label">آدرس:</span> ${escapeHtml(sellerAddress)}</span>` : ''}
            ${shopurl ? `<span><span class="label">آدرس اینترنتی:</span> <a href="/shop.html?shopurl=${encodeURIComponent(shopurl)}" target="_blank" rel="noopener">مشاهده فروشگاه</a></span>` : ''}
          </div>
        </div>
        <div class="ad-modal-section">
          <h4>جزئیات سفارش</h4>
          <div class="ad-modal-meta">
            <span><span class="label">مبلغ:</span> ${formatCurrency(order.price)}</span>
            <span><span class="label">تاریخ ثبت:</span> ${createdAt}</span>
            <span><span class="label">وضعیت فعلی:</span> ${statusMeta.label}</span>
            <span><span class="label">آخرین بررسی:</span> ${reviewedAt ? `${reviewedAt}${reviewedBy ? ` توسط ${escapeHtml(reviewedBy)}` : ''}` : 'در انتظار بررسی'}</span>
            ${approvedAt ? `<span><span class="label">تاریخ تایید:</span> ${approvedAt}</span>` : ''}
            ${displayedAt ? `<span><span class="label">تاریخ نمایش:</span> ${displayedAt}</span>` : '<span><span class="label">تاریخ نمایش:</span> در انتظار تعیین</span>'}
            ${planLocationRow}
          </div>
        </div>
      </div>

      <div class="ad-modal-preview">
        <div class="banner">
          ${bannerUrl ? `<img src="${bannerUrl}" alt="بنر تبلیغ">` : '<span class="ad-status-note">بنری بارگذاری نشده است.</span>'}
        </div>
        <div class="ad-title">${escapeHtml(previewTitle)}</div>
        ${textValue ? `<div class="ad-text">${escapeHtml(textValue)}</div>` : ''}
        ${product ? `<div class="ad-modal-meta"><span><span class="label">محصول هدف:</span> ${escapeHtml(product.title || '')}</span>${product.price != null ? `<span><span class="label">قیمت محصول:</span> ${formatCurrency(product.price)}</span>` : ''}</div>` : ''}
      </div>

      <div class="ad-modal-edit">
        <h4>ویرایش تبلیغ</h4>
        <div class="ad-edit-grid">
          <label for="adModalTitle">عنوان نمایشی</label>
          <input type="text" id="adModalTitle" value="${escapeHtml(titleValue)}" placeholder="عنوان نمایش تبلیغ" />
          <label for="adModalText">متن تبلیغ</label>
          <textarea id="adModalText" placeholder="متن تبلیغ">${escapeHtml(textValue)}</textarea>
          <label for="adModalPrice">مبلغ (ریال)</label>
          <input type="number" id="adModalPrice" min="0" step="1000" value="${escapeHtml(priceInputValue)}" />
          <label for="adModalDisplayedAt">تاریخ نمایش در سایت</label>
          <input type="datetime-local" id="adModalDisplayedAt" value="${escapeHtml(displayedAtInputValue)}" />
        </div>
        <div class="ad-edit-actions">
          <button type="button" id="adModalSave" class="ad-action-btn ghost"><i class="ri-save-3-line"></i> ذخیره تغییرات</button>
          <button type="button" id="adModalDelete" class="ad-action-btn reject"><i class="ri-delete-bin-line"></i> حذف تبلیغ</button>
        </div>
        <p id="adModalEditStatus" class="ad-modal-edit-status" style="display:none;"></p>
      </div>

      <div class="ad-modal-note">
        <label for="adModalNote">یادداشت داخلی ادمین</label>
        <textarea id="adModalNote" placeholder="یادداشت خود را وارد کنید...">${escapeHtml(adminNoteValue)}</textarea>
      </div>

      <div class="ad-modal-actions">
        <button data-action="approve" data-id="${escapeHtml(orderId)}"><i class="ri-checkbox-circle-line"></i> تایید تبلیغ</button>
        <button data-action="reject" data-id="${escapeHtml(orderId)}"><i class="ri-close-circle-line"></i> رد تبلیغ</button>
        <button data-action="pending" data-id="${escapeHtml(orderId)}"><i class="ri-time-line"></i> بازگشت به انتظار</button>
      </div>

      <div class="ad-modal-timestamps">
        <span>ثبت درخواست: ${createdAt}</span>
        ${reviewedAt ? `<span>آخرین بررسی: ${reviewedAt}${reviewedBy ? ` توسط ${escapeHtml(reviewedBy)}` : ''}</span>` : ''}
        ${approvedAt ? `<span>تایید نهایی: ${approvedAt}</span>` : ''}
        ${displayedAt ? `<span>نمایش در سایت: ${displayedAt}</span>` : '<span>نمایش در سایت: در انتظار نمایش</span>'}
      </div>

      <div class="ad-modal-status">
        <i class="${statusMeta.icon}"></i>
        <span>${statusMeta.label}</span>
      </div>
    </div>
  `;

  const noteInput = overlay.querySelector('#adModalNote');
  const titleInput = overlay.querySelector('#adModalTitle');
  const textInput = overlay.querySelector('#adModalText');
  const priceInput = overlay.querySelector('#adModalPrice');
  const displayedAtInput = overlay.querySelector('#adModalDisplayedAt');
  const saveButton = overlay.querySelector('#adModalSave');
  const deleteButton = overlay.querySelector('#adModalDelete');

  overlay.querySelectorAll('.ad-modal-actions button').forEach(button => {
    button.addEventListener('click', () => {
      const action = button.dataset.action;
      if (!action) return;
      const noteValue = noteInput ? noteInput.value : undefined;
      if (action === 'pending' && order.status === 'pending' && (!noteValue || noteValue.trim() === (order.adminNote || ''))) {
        closeAdOrderModal();
        return;
      }
      handleAdModalAction(getOrderId(order), action === 'pending' ? 'pending' : action, noteValue !== undefined ? noteValue : undefined, button);
    });
  });

  if (saveButton) {
    saveButton.addEventListener('click', () => {
      const payload = {};
      let hasChanges = false;

      const originalTitle = (order.adTitle || '').trim();
      const newTitle = titleInput ? titleInput.value.trim() : '';
      if (newTitle !== originalTitle) {
        payload.adTitle = newTitle;
        hasChanges = true;
      }

      const originalText = (order.adText || '').trim();
      const newText = textInput ? textInput.value.trim() : '';
      if (newText !== originalText) {
        payload.adText = newText;
        hasChanges = true;
      }

      const originalPriceStr = priceInputValue;
      const newPriceStr = priceInput ? priceInput.value : '';
      if (newPriceStr !== originalPriceStr) {
        if (!newPriceStr.length) {
          setAdModalEditStatus('مبلغ تبلیغ را وارد کنید.', 'error');
          return;
        }
        const priceNumber = Number(newPriceStr);
        if (!Number.isFinite(priceNumber) || priceNumber < 0) {
          setAdModalEditStatus('مبلغ وارد شده معتبر نیست.', 'error');
          return;
        }
        payload.price = priceNumber;
        hasChanges = true;
      }

      const originalDisplay = displayedAtInputValue || '';
      const newDisplay = displayedAtInput ? displayedAtInput.value : '';
      if (newDisplay !== originalDisplay) {
        if (newDisplay) {
          const parsed = new Date(newDisplay);
          if (Number.isNaN(parsed.getTime())) {
            setAdModalEditStatus('تاریخ نمایش معتبر نیست.', 'error');
            return;
          }
          payload.displayedAt = parsed.toISOString();
        } else {
          payload.displayedAt = null;
        }
        hasChanges = true;
      }

      const currentNote = noteInput ? noteInput.value : '';
      if ((currentNote || '').trim() !== (adminNoteValue || '').trim()) {
        payload.adminNote = currentNote;
        hasChanges = true;
      }

      if (!hasChanges) {
        setAdModalEditStatus('تغییری برای ذخیره وجود ندارد.', 'info');
        return;
      }

      setAdModalEditStatus('در حال ذخیره تغییرات...', 'info');
      setButtonLoading(saveButton, true);
      updateAdOrderDetails(orderId, payload, { silent: true })
        .then(updated => {
          if (updated) {
            renderAdOrderModal(updated);
            setTimeout(() => setAdModalEditStatus('تغییرات با موفقیت ذخیره شد.', 'success'), 0);
          }
          setAdOrdersStatus('جزئیات تبلیغ بروزرسانی شد.', 'success');
        })
        .catch(err => {
          console.error('ad-modal save error:', err);
          setAdModalEditStatus(err.message || 'خطا در ذخیره تغییرات.', 'error');
        })
        .finally(() => setButtonLoading(saveButton, false));
    });
  }

  if (deleteButton) {
    deleteButton.addEventListener('click', () => {
      if (!confirm('آیا از حذف این تبلیغ مطمئن هستید؟')) {
        return;
      }
      setAdModalEditStatus('در حال حذف تبلیغ...', 'info');
      setButtonLoading(deleteButton, true);
      removeAdOrder(orderId, { silent: true })
        .then(() => {
          closeAdOrderModal();
          setAdOrdersStatus('تبلیغ با موفقیت حذف شد.', 'success');
        })
        .catch(err => {
          console.error('ad-modal delete error:', err);
          setAdModalEditStatus(err.message || 'خطا در حذف تبلیغ.', 'error');
        })
        .finally(() => setButtonLoading(deleteButton, false));
    });
  }
}

function setAdModalEditStatus(message = '', type = 'info') {
  const statusEl = document.getElementById('adModalEditStatus');
  if (!statusEl) return;

  statusEl.classList.remove('info', 'success', 'error');
  if (!message) {
    statusEl.textContent = '';
    statusEl.style.display = 'none';
    return;
  }

  statusEl.textContent = message;
  statusEl.classList.add(type);
  statusEl.style.display = 'block';
}

function handleAdModalAction(orderId, status, note, button) {
  if (!orderId || !status) return;
  const trimmedNote = note !== undefined ? note.trim() : undefined;

  if (status === 'rejected' && !confirm('آیا از رد این تبلیغ مطمئن هستید؟')) {
    return;
  }

  if (status === 'pending' && !confirm('تبلیغ به حالت در انتظار بازگردد؟')) {
    return;
  }

  setButtonLoading(button, true);
  updateAdOrderStatus(orderId, status, trimmedNote, { silent: true })
    .then(updated => {
      if (updated) {
        renderAdOrderModal(updated);
        setAdOrdersStatus('وضعیت تبلیغ بروزرسانی شد.', 'success');
      }
    })
    .catch(err => {
      console.error('handleAdModalAction error:', err);
      setAdOrdersStatus(err.message || 'خطا در بروزرسانی تبلیغ.', 'error');
    })
    .finally(() => setButtonLoading(button, false));
}

function closeAdOrderModal() {
  const overlay = document.getElementById('ad-order-modal');
  if (!overlay) return;
  overlay.style.display = 'none';
  overlay.innerHTML = '';
  currentAdOrderId = null;
  if (adModalOverlayHandler) {
    overlay.removeEventListener('click', adModalOverlayHandler);
    adModalOverlayHandler = null;
  }
}

window.closeAdOrderModal = closeAdOrderModal;

function initAdOrdersUI() {
  if (adOrdersPlanFilterEl) {
    adOrdersPlanFilterEl.addEventListener('change', event => {
      adOrdersPlanFilter = event.target.value;
      renderAdOrders();
    });
  }

  if (adOrdersSearchEl) {
    adOrdersSearchEl.addEventListener('input', event => {
      adOrdersSearchTerm = event.target.value.trim().toLowerCase();
      renderAdOrders();
    });
  }

  if (adOrdersRefreshBtn) {
    adOrdersRefreshBtn.addEventListener('click', async () => {
      if (adOrdersRefreshBtn.disabled) return;
      const original = adOrdersRefreshBtn.innerHTML;
      adOrdersRefreshBtn.disabled = true;
      adOrdersRefreshBtn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> بروزرسانی...';
      try {
        await loadAdOrders(true);
        setAdOrdersStatus('لیست تبلیغات بروزرسانی شد.', 'success');
      } catch (err) {
        console.error('adOrdersRefresh error:', err);
      } finally {
        adOrdersRefreshBtn.disabled = false;
        adOrdersRefreshBtn.innerHTML = original;
      }
    });
  }

  document.querySelectorAll('.ad-filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.ad-filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      adOrdersFilter = btn.dataset.filter || 'all';
      renderAdOrders();
    });
  });
}

updateAdOrdersSummary();
renderAdOrders();
initAdOrdersUI();

function normaliseScoreKey(id) {
  if (!id) return '';
  return toIdString(id);
}

function resolveSellerKeyFromShop(shop) {
  if (!shop) return '';
  const candidate =
    shop._sid ||
    shop.sellerId ||
    shop.seller_id ||
    (shop.shopurl ? `shopurl:${shop.shopurl}` : '') ||
    shop._id;
  return normaliseScoreKey(candidate);
}

function parsePerformancePayload(payload) {
  if (!payload || typeof payload !== 'object') return null;

  const sellerId = payload.sellerId ? toIdString(payload.sellerId) : '';
  const shopurl = payload.shopurl || '';
  const note = typeof payload.adminScoreNote === 'string'
    ? payload.adminScoreNote
    : (typeof payload.note === 'string' ? payload.note : '');
  const publicMessage = typeof payload.adminScoreMessage === 'string'
    ? payload.adminScoreMessage
    : (typeof payload.publicMessage === 'string' ? payload.publicMessage : '');
  const meta = {
    sellerId,
    shopurl,
    storename: payload.storename || '',
    adminScore: payload.adminScore != null ? Number(payload.adminScore) : null,
    updatedAt: payload.updatedAt || null,
    status: payload.status || 'unset',
    statusLabel: payload.statusLabel || 'منتظر ارزیابی',
    statusMessage: payload.statusMessage || '',
    severity: payload.severity || 'neutral',
    canStay: payload.canStay !== false,
    message: payload.message || '',
    adminScoreNote: note,
    note,
    adminScoreMessage: publicMessage,
    publicMessage
  };

  const aliasKeys = [];
  const addAlias = (value) => {
    const normalised = normaliseScoreKey(value);
    if (normalised && !aliasKeys.includes(normalised)) {
      aliasKeys.push(normalised);
    }
  };

  addAlias(payload.sellerKey);
  addAlias(sellerId);
  addAlias(payload._id);
  if (payload.seller && typeof payload.seller === 'object') {
    addAlias(payload.seller._id || payload.seller.id);
  }
  if (shopurl) addAlias(`shopurl:${shopurl}`);
  if (Array.isArray(payload.aliases)) {
    payload.aliases.forEach(addAlias);
  }

  const keyCandidate = payload.sellerKey || sellerId || (shopurl ? `shopurl:${shopurl}` : '');
  addAlias(keyCandidate);

  meta.sellerKey = aliasKeys.length ? aliasKeys[0] : '';
  meta.aliasKeys = aliasKeys;

  if (meta.sellerKey && !meta.aliasKeys.includes(meta.sellerKey)) {
    meta.aliasKeys.unshift(meta.sellerKey);
  }
  if (!meta.aliasKeys.length && meta.sellerKey) {
    meta.aliasKeys = [meta.sellerKey];
  }

  return meta;
}

function getSellerPerformanceByKey(key) {
  const normalised = normaliseScoreKey(key);
  if (!normalised) return null;
  return Object.prototype.hasOwnProperty.call(sellerPerformanceMap, normalised)
    ? sellerPerformanceMap[normalised]
    : null;
}

function getSellerScoreByKey(key) {
  const meta = getSellerPerformanceByKey(key);
  return meta && meta.adminScore != null ? meta.adminScore : null;
}

function getSellerScoreForShop(shop) {
  const key = resolveSellerKeyFromShop(shop);
  return key ? getSellerScoreByKey(key) : null;
}

async function refreshSellerPerformanceMap() {
  try {
    const res = await fetch(`${ADMIN_API_BASE}/sellers/performance`, {
      credentials: 'include'
    });

    let payload = null;
    try {
      payload = await res.json();
    } catch (err) {
      payload = null;
    }

    if (!res.ok) {
      const message = payload && payload.message ? payload.message : 'خطا در دریافت وضعیت عملکرد فروشنده‌ها.';
      throw new Error(message);
    }

    const records = Array.isArray(payload)
      ? payload
      : (Array.isArray(payload?.data) ? payload.data : []);

    const nextMap = {};
    records.forEach(item => {
      const meta = parsePerformancePayload(item);
      if (!meta) return;
      const keys = Array.isArray(meta.aliasKeys) && meta.aliasKeys.length
        ? meta.aliasKeys
        : (meta.sellerKey ? [meta.sellerKey] : []);
      keys.forEach(alias => {
        const normalised = normaliseScoreKey(alias);
        if (normalised) {
          nextMap[normalised] = meta;
        }
      });
    });

    sellerPerformanceMap = nextMap;
    sellerPerformanceLoaded = true;
    return true;
  } catch (err) {
    console.error('⚠️ خطا در دریافت وضعیت عملکرد فروشنده‌ها:', err);
    sellerPerformanceLoaded = false;
    return false;
  }
}

async function setSellerScoreByKey(key, value, note, message) {
  const normalised = normaliseScoreKey(key);
  if (!normalised) throw new Error('شناسه فروشنده برای ثبت نمره معتبر نیست.');

  const body = { score: value };
  if (typeof note === 'string') {
    body.note = note;
  }
  if (typeof message === 'string') {
    body.message = message;
  }

  const res = await fetch(`${ADMIN_API_BASE}/sellers/performance/${encodeURIComponent(normalised)}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify(body)
  });

  let payload = null;
  try {
    payload = await res.json();
  } catch (err) {
    payload = null;
  }

  if (!res.ok) {
    const message = payload && payload.message ? payload.message : 'خطا در ثبت نمره فروشنده.';
    throw new Error(message);
  }

  const meta = parsePerformancePayload(payload);
  if (meta) {
    const keys = new Set([
      normalised,
      ...(Array.isArray(meta.aliasKeys) ? meta.aliasKeys : []),
      meta.sellerKey
    ]);
    keys.forEach(alias => {
      const keyAlias = normaliseScoreKey(alias);
      if (keyAlias) {
        sellerPerformanceMap[keyAlias] = meta;
      }
    });
  }
  sellerPerformanceLoaded = true;
  return meta;
}

async function setSellerScoreForShop(shop, value, note, message) {
  const key = resolveSellerKeyFromShop(shop);
  return key ? setSellerScoreByKey(key, value, note, message) : null;
}

async function clearSellerScoreByKey(key) {
  const normalised = normaliseScoreKey(key);
  if (!normalised) throw new Error('شناسه فروشنده معتبر نیست.');

  const res = await fetch(`${ADMIN_API_BASE}/sellers/performance/${encodeURIComponent(normalised)}`, {
    method: 'DELETE',
    credentials: 'include'
  });

  let payload = null;
  try {
    payload = await res.json();
  } catch (err) {
    payload = null;
  }

  if (!res.ok) {
    const message = payload && payload.message ? payload.message : 'خطا در حذف نمره فروشنده.';
    throw new Error(message);
  }

  const meta = parsePerformancePayload(payload);
  if (meta) {
    const keys = new Set([
      normalised,
      ...(Array.isArray(meta.aliasKeys) ? meta.aliasKeys : []),
      meta.sellerKey
    ]);
    keys.forEach(alias => {
      const keyAlias = normaliseScoreKey(alias);
      if (keyAlias) {
        sellerPerformanceMap[keyAlias] = meta;
      }
    });
  } else {
    delete sellerPerformanceMap[normalised];
  }
  sellerPerformanceLoaded = true;
  return meta;
}

async function clearSellerScoreForShop(shop) {
  const key = resolveSellerKeyFromShop(shop);
  return key ? clearSellerScoreByKey(key) : null;
}

let messagesList = [];




/* --- global name-maps ------------------------------------ */
/* --- global name-maps -------------------------------- */
let sellerNameById = {};   // { sellerId : "نام فروشنده / فروشگاه" }
let userNameById   = {};   // { userId   : "نام کاربر" }

/* -------------------- buildNameMaps (FIXED) -------------------- */
/**
 * تمام شناسه‌های ممکن فروشنده و کاربر را به «قابل‌نمایش‌ترین» نامشان نگاشت می‌کند.
 * اولویت نام‌ها، از صریح‌ترین (همراه چت) تا محاسبه‌شده از دیتابیس است.
 */
function normSellerId(id) {
  // اگر رشته خالی یا undefined بود
  if (!id) return '';
  // اگر همین الان هم shopurl: بود
  if (typeof id !== 'string') id = String(id);
  if (id.startsWith('shopurl:')) return id;
  // اگر فقط اسلاگ هست
  return 'shopurl:' + id;
}

function buildNameMaps() {
  sellerNameById = {};

  // فروشگاه‌ها
  shopsList.forEach(shop => {
    const ids = [
      shop._id, shop._sid, shop.id,
      shop.sellerId, shop.seller_id,
      shop.shopurl
    ].filter(Boolean).map(toIdString);

    const label = (shop.ownerName || '').trim() ||
      (`${shop.ownerFirstname || ''} ${shop.ownerLastname || ''}`).trim() ||
      shop.storename || shop.storeName || shop.shopLogoText || 'فروشنده';

    ids.forEach(id => { 
      if (id) sellerNameById[normSellerId(id)] = label; 
    });
  });

  // پیام‌ها - نام صریح فروشنده
  messagesList.forEach(chat => {
    const ids = [
      chat.sellerId,
      chat.shopurl,
      chat.seller?._id,
      chat.seller?.id
    ].filter(Boolean).map(toIdString);

    const label =
      (chat.sellerName || chat.storeName ||
        chat.seller?.storename || chat.seller?.ownerName || '').trim();

    if (label)
      ids.forEach(id => { 
        if (id) sellerNameById[normSellerId(id)] = label; 
      });
  });

  // Patch: shopurl → sellerId
  messagesList.forEach(chat => {
    const sid  = normSellerId(toIdString(chat.sellerId));
    const surl = normSellerId(toIdString(chat.shopurl));
    if (!sid || !surl) return;
    // پیدا کردن فروشگاه مطابق shopurl
    const shop = shopsList.find(s => normSellerId(toIdString(s.shopurl)) === surl);
    if (!shop) return;
    // برچسب فروشگاه
    const label =
      (shop.ownerName || '').trim() ||
      (`${shop.ownerFirstname||''} ${shop.ownerLastname||''}`).trim() ||
      shop.storename || shop.storeName || shop.shopLogoText || 'فروشنده';
    // غنی‌سازی نقشه
    sellerNameById[sid] = label;
  });

  // مشتری‌ها
  userNameById = {};
  usersList.forEach(u => {
    const ids = [
      u._id, u.id, u.userId, u.user_id, u.customerId
    ].filter(Boolean).map(toIdString);

    const label =
      (u.fullName || u.fullname || '').trim() ||
      (`${u.firstName || u.firstname || ''} ${u.lastName || u.lastname || ''}`).trim() ||
      u.name || u.username || u.phone || 'مشتری';

    ids.forEach(id => { 
      if (id) userNameById[id] = label; 
    });
  });

  // پیام‌ها - نام صریح مشتری
  messagesList.forEach(chat => {
    const id = toIdString(chat.customerId || chat.userId);
    const name = (chat.customerName || chat.userName || '').trim();
    if (id && name) userNameById[id] = name;
  });
}







// ← همینجا، درست بعد از let messagesList = [];
/* ------------------------------- fetchMessages (FIXED) ------------------------------ */
async function fetchMessages() {
  console.log('⚙️ fetchMessages called');

const res = await fetch(`${ADMIN_API_BASE}/chats/all`, { credentials: 'include' });

  const data = await res.json();

  if (!res.ok) {
    console.error('❌ خطا در واکشی پیام‌ها:', data);
    throw new Error(data.error || 'خطا در واکشی پیام‌ها');
  }

  /* ۱) ذخیره لیست چت‌ها */
  messagesList = Array.isArray(data) ? data : (data.chats || []);

  /* ۲) نرمال‌سازی شناسه‌ها در خود چت (برای سازگاری کامل) */
  messagesList.forEach(c => {
    if (c.sellerId)   c.sellerId   = toIdString(c.sellerId);
    if (!c.sellerId && c.shopurl)
  c.sellerId = 'shopurl:' + c.shopurl;     // ← اضافه کنید

    if (c.customerId) c.customerId = toIdString(c.customerId);
  });

  /* ۳) مپ نام‌ها را «بعد از» داشتن پیام‌ها بسازیم */
  buildNameMaps();

  /* ۴) آپدیت شمارنده‌ها */
  updateSidebarCounts();
  updateHeaderCounts();

  /* ۵) اگر پنل پیام‌ها همین حالا باز است، جدول را فوراً رندر کن */
  if (panels.messages.style.display !== 'none') {
    renderMessages();
  }
}




function getTotalUnreadMessages() {
  let total = 0;
  messagesList.forEach(chat => {
    if (Array.isArray(chat.messages)) {
      total += chat.messages.filter(
        m => (m.from === 'seller' || m.from === 'user') && !m.read
      ).length;
    }
  });
  return total;
}








/* ------------------ helpers/name-utils.js ------------------ */

/**
 * یک رشته را نرمالایز می‌کند (حذف فاصله‌های دوطرف و چند space پیاپی)
 */
function clean(str = '') {
  return String(str).replace(/\s+/g, ' ').trim();
}

/**
 * از یک شیء (یا حتی رشته) سعی می‌کند نام قابل‌نمایش استخراج کند.
 * کلیدهای متداول + کلیدهای اضافی (آرگومان دوم) بررسی می‌شوند.
 */
function extractName(obj, extraKeys = []) {
  if (!obj) return '';

  // اگر خودِ ورودی رشته باشد
  if (typeof obj === 'string') return clean(obj);

  // کلیدهای رایج
  const commonKeys = [
    'fullName', 'fullname', 'name', 'username',      // عمومی
    'storename', 'storeName',                        // فروشنده
    'ownerName',                                     // فروشنده
    'firstName', 'firstname', 'lastName', 'lastname' // جداگانه
  ];

  for (const k of [...commonKeys, ...extraKeys]) {
    if (obj[k]) return clean(obj[k]);
  }

  // حالت first/last جدا
  if (obj.firstName || obj.firstname || obj.lastName || obj.lastname) {
    return clean(
      `${obj.firstName || obj.firstname || ''} ${obj.lastName || obj.lastname || ''}`
    );
  }

  return '';
}

/* --------------- core/getSenderName.js ---------------- */

/**
 * با درنظرگرفتن انواع ساختارهای ممکن پیام، نام نمایش‌داده‌شدهٔ فرستنده را برمی‌گرداند.
 * همیشه یک مقدار «غیرفالسـی» (حداقل عنوان پیش‌فرض) برمی‌گردد.
 */
/* --------------- core/getSenderName.js ---------------- */
/**
 * براى هر پیام برچسب «فرستنده» را برمى‌گرداند.
 * اولویت: نام صریح در خود پیام → نام صریح در شیء chat → mapها → لیست‌ها → پیش‌فرض
/* -------------------- getSenderName (FIXED) -------------------- */
/**
 * نام قابل‌نمایش فرستندهٔ یک پیام را برمی‌گرداند.
 * اولویت: ۱) نام صریح در خود پیام، ۲) نام صریح در شیء chat،
 * ۳) مپ‌های ازپیش‌ساخته، ۴) جست‌وجو در لیست‌ها، ۵) برچسب پیش‌فرض.
 */
function getSenderName (chat = {}, msg = {}) {

  /* ---------- 1) نام صریح داخل خود پیام ---------- */
  const explicitMsg =
    extractName(msg,         ['fromName', 'senderName', 'displayName']) ||
    extractName(msg.sender || {}, ['fromName', 'senderName', 'displayName']);
  if (explicitMsg) return explicitMsg;

  /* ---------- 2) نام صریح داخل شیء Chat ---------- */
  const explicitChat =
    extractName(chat, ['sellerName',   'seller_name',
                       'storeName',    'store_name',
                       'customerName', 'customer_name',
                       'userName',     'user_name',
                       'username']);
  if (explicitChat) return explicitChat;

  /* ---------- 3) تشخیص «نقش» فرستنده ---------- */
  let role = String(msg.from || chat.role || '').toLowerCase().trim();

  /* اگر نقش صریح نیست، با وجود شناسه حدس بزنیم */
  if (!role) {
    if (msg.sellerId   || chat.sellerId   || chat.seller_id || chat.shopurl)
      role = 'seller';
    else if (msg.customerId || chat.customerId || chat.userId ||
             chat.customer_id || chat.user_id)
      role = 'customer';
    else if (msg.fromId === 'admin' || chat.admin)
      role = 'admin';
  }

  /* ---------- 4) فروشنده ---------- */
  if (role === 'seller') {
    const sid = toIdString(
      msg.sellerId || chat.sellerId || chat.seller_id ||
      msg.shopurl  || chat.shopurl  || ''
    );

    if (sellerNameById[sid]) return sellerNameById[sid];

    /* جست‌وجو در shopsList برای اطلاعات بیشتر */
    const shop = shopsList.find(s =>
      s._sid === sid || toIdString(s.shopurl) === sid
    );
    if (shop) {
      const name =
        (shop.ownerName || '').trim() ||
        (`${shop.ownerFirstname || ''} ${shop.ownerLastname || ''}`).trim() ||
        shop.storename || shop.storeName || '';
      if (name) return name;
    }
    return 'فروشنده';
  }

  /* ---------- 5) مشتری / کاربر ---------- */
  if (role === 'customer' || role === 'user') {
    const uid = toIdString(
      msg.customerId   || chat.customerId   ||
      chat.customer_id || chat.userId       ||
      chat.user_id     || ''
    );

    if (userNameById[uid]) return userNameById[uid];

    /* fallback → جست‌وجو در usersList */
    const user = usersList.find(u =>
      toIdString(u._id || u.id || u.userId || u.user_id) === uid
    );
    if (user) {
      const name =
        (user.fullName || user.fullname || '').trim() ||
        (`${user.firstName || user.firstname || ''} ${user.lastName || user.lastname || ''}`).trim() ||
        user.name || user.username || '';
      if (name) return name;
    }
    return 'مشتری';
  }

  /* ---------- 6) ادمین یا فرستندهٔ ناشناس ---------- */
  return 'ادمین';
}






/* ───── 2) نسخهٔ نهاییِ تابع renderMessages ───── */
/* ───── نسخهٔ اصلاح‌شده‌ی تابع renderMessages ───── */
function renderMessages() {
  const tbody = document.querySelector('#messagesTable tbody');
  tbody.innerHTML = '';

  // 1. کپی لیست پیام‌ها برای فیلتر و مرتب‌سازی
  let chats = [...messagesList];
  
  // 2. اعمال فیلترها
  if (messagesFilterMode === 'seller') {
    chats = chats.filter(chat => chat.sellerId);
  } else if (messagesFilterMode === 'customer') {
    chats = chats.filter(chat => !chat.sellerId);
  } else if (messagesFilterMode === 'unanswered') {
    chats = chats.filter(chat => {
      const msgs = chat.messages || [];
      return msgs.length > 0 && msgs[msgs.length - 1].from !== 'admin';
    });
  }

  // 3. مرتب‌سازی بر اساس تاریخ
  chats.sort((a, b) => {
    const aLastMsg = a.messages[a.messages.length - 1];
    const bLastMsg = b.messages[b.messages.length - 1];
    const aTime = aLastMsg ? new Date(aLastMsg.createdAt || aLastMsg.date).getTime() : 0;
    const bTime = bLastMsg ? new Date(bLastMsg.createdAt || bLastMsg.date).getTime() : 0;
    
    return messagesFilterMode === 'oldest' ? aTime - bTime : bTime - aTime;
  });

  // 4. بررسی خالی بودن لیست پس از فیلتر
  if (chats.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align:center;color:#888;padding:1.5rem">
          ${getEmptyFilterMessage()}
        </td>
      </tr>`;
    return;
  }

  // 5. رندر پیام‌های فیلتر شده
  chats.forEach(chat => {
    const msgs = chat.messages || [];
    const lastMsg = msgs[msgs.length - 1];
    const senderMsg = msgs.slice().reverse().find(m => m.from !== 'admin') || lastMsg;

    const senderLabel = getSenderName(chat, senderMsg);
    const unreadCount = msgs.filter(m => (m.from === 'seller' || m.from === 'user') && !m.read).length;

    const fullText = lastMsg && lastMsg.text ? lastMsg.text : '-';
    const shortText = fullText.length > 36 ? fullText.slice(0, 36) + '…' : fullText;

    const raw = lastMsg && (lastMsg.createdAt || lastMsg.date);
    const dt = raw ? new Date(raw) : null;
    const faDate = (dt && !isNaN(dt.valueOf()))
      ? dt.toLocaleString('fa-IR', {
          hour12: false,
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        })
      : '—';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:center;color:#10b981;font-weight:bold">
        ${unreadCount
          ? `<span style="background:#eafaf4;border-radius:8px;padding:2px 10px">${unreadCount}</span>`
          : '۰'
        }
      </td>
      <td>${shortText}</td>
      <td class="msg-sender-cell"
          style="cursor:pointer;color:#0ea5e9;font-weight:bold">
        ${senderLabel}
      </td>
      <td>${faDate}</td>
        <td>
          <button class="action-btn delete" onclick="deleteMessage('${chat._id}')">حذف</button>
          <button class="action-btn view" onclick="openChatModal('${chat._id}')">مشاهده</button>
          ${chat.blockedByAdmin
            ? `<button class="action-btn unblock" onclick="unblockSender('${chat._id}')">آزاد کردن</button>`
            : `<button class="action-btn block" onclick="blockSender('${chat._id}')">مسدودسازی</button>`}

        </td>`;
    
    tbody.appendChild(tr);

    // افزودن کلیک برای نمایش اطلاعات فرستنده
    tr.querySelector('.msg-sender-cell').addEventListener('click', () => {
      openSenderModal(chat);
    });
  });
}

// تابع کمکی برای ایجاد پیام مناسب بر اساس فیلتر
function getEmptyFilterMessage() {
  switch(messagesFilterMode) {
    case 'seller':
      return 'هیچ پیامی از فروشنده‌ها وجود ندارد.';
    case 'customer':
      return 'هیچ پیامی از مشتری‌ها وجود ندارد.';
    case 'unanswered':
      return 'هیچ پیام پاسخ داده نشده‌ای وجود ندارد.';
    case 'oldest':
      return 'هیچ پیام قدیمی‌ای وجود ندارد.';
    default:
      return 'هیچ پیامی وجود ندارد.';
  }
}









// ----------------- فیلتر پیام‌ها -----------------
// ----------------- فیلتر پیام‌ها -----------------
// ——— کد یکپارچهٔ فیلتر و رندر پیام‌ها ———
let messagesFilterMode = 'seller'; // پیش‌فرض: پیام‌های فروشنده

// تنظیم دکمه‌های فیلتر
document.querySelectorAll('.messages-filters button').forEach(btn => {
  btn.addEventListener('click', () => {
    // حذف active از همه و اضافه کردن به کلیک‌شده
    document.querySelectorAll('.messages-filters button')
      .forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // تعیین حالت فیلتر
    messagesFilterMode = btn.getAttribute('data-filter');
    renderMessages();
  });
});


// ————————————————————————————————





// هندل کلیک روی فرستنده (می‌تونه باکس یا مودال باز کنه)
function showSenderDetails(sellerId, label) {
  if (label !== 'فروشنده') return;
  alert(`مشخصات فروشنده (ID: ${sellerId})`);
}


async function deleteMessage(chatId) {
  if (!confirm('آیا مطمئن هستید که می‌خواهید این چت را حذف کنید؟')) return;

  try {
    const res = await fetch(`${ADMIN_API_BASE}/chats/${chatId}`, {
      method: 'DELETE',
      credentials: 'include'
    });

    if (!res.ok) {
      const data = await res.json();
      throw new Error(data.error || 'خطا در حذف چت');
    }

    // بروزرسانی لیست
    messagesList = messagesList.filter(c => c._id !== chatId);
    renderMessages();
    updateSidebarCounts();

  } catch (err) {
    alert('❌ ' + (err.message || 'خطا در حذف چت'));
    console.error(err);
  }
}




// مسدودسازی فرستنده مستقیماً از جدول
async function blockSender(chatId) {
  const chat = messagesList.find(c => c._id === chatId) || {};
  
  // استخراج targetId و targetRole از participants
  let targetRole = 'user'; // پیش‌فرض مشتری
  let targetId = null;
  
  if (chat.participants && chat.participants.length > 1) {
    const nonAdmin = chat.participants.find(p => p.role !== 'admin');
    if (nonAdmin) {
      targetId = nonAdmin._id;
      targetRole = nonAdmin.role === 'seller' ? 'seller' : 'user';
    }
  } else if (chat.sellerId) {
    targetId = chat.sellerId;
    targetRole = 'seller';
  } else if (chat.customerId || chat.userId) {
    targetId = chat.customerId || chat.userId;
    targetRole = 'user';
  }

  const label = targetRole === 'seller' ? 'فروشنده' : 'مشتری';
  if (!targetId) return alert('شناسه کاربر پیدا نشد.');

  if (!confirm(`آیا مطمئن هستید که می‌خواهید این ${label} را مسدود کنید؟`)) return;

  try {
    console.log('blockSender ->', { targetId, targetRole });
    const res = await fetch(`${ADMIN_API_BASE}/chats/block-target`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targetId, targetRole })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'خطا در مسدودسازی');

    alert('✅ ' + (data.message || 'کاربر با موفقیت مسدود شد.'));
    await fetchMessages();
  } catch (err) {
    console.error('❌ blockSender error:', err);
    alert('❌ ' + err.message);
  }
}

async function unblockSender(chatId) {
  const chat = messagesList.find(c => c._id === chatId) || {};
  
  // استخراج targetId و targetRole از participants
  let targetRole = 'user';
  let targetId = null;
  
  if (chat.participants && chat.participants.length > 1) {
    const nonAdmin = chat.participants.find(p => p.role !== 'admin');
    if (nonAdmin) {
      targetId = nonAdmin._id;
      targetRole = nonAdmin.role === 'seller' ? 'seller' : 'user';
    }
  } else if (chat.sellerId) {
    targetId = chat.sellerId;
    targetRole = 'seller';
  } else if (chat.customerId || chat.userId) {
    targetId = chat.customerId || chat.userId;
    targetRole = 'user';
  }

  const label = targetRole === 'seller' ? 'فروشنده' : 'مشتری';
  if (!targetId) return alert('شناسه کاربر پیدا نشد.');

  if (!confirm(`آیا مطمئن هستید که می‌خواهید این ${label} را آزاد کنید؟`)) return;

  try {
    console.log('unblockSender ->', { targetId, targetRole });
    const res = await fetch(`${ADMIN_API_BASE}/chats/unblock-target`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targetId, targetRole })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'خطا در رفع مسدودی');

    alert('✅ ' + (data.message || 'کاربر آزاد شد.'));
    await fetchMessages();
  } catch (err) {
    console.error('❌ unblockSender error:', err);
    alert('❌ ' + err.message);
  }
}



// -------- fetchers --------
// ← این بخش را پیدا کنید (جایی که تابع fetchUsers تعریف شده است)
// بهتره این خطاگیری رو هم به تابع اضافه کنید
// ← این بخش را پیدا کنید (جایی که تابع fetchUsers تعریف شده است)
// ─── اصلاح تابع fetchUsers ───
// جایگزین کل تابع قبلی کنید
const DASHBOARD_TREND_DAYS = 90;

async function fetchDashboardStats(days = DASHBOARD_TREND_DAYS) {
  try {
    const res = await fetch(`${ADMIN_API_BASE}/admin/dashboard/stats?days=${encodeURIComponent(days)}`, {
      credentials: 'include'
    });

    if (!res.ok) {
      console.error('fetchDashboardStats – HTTP‑', res.status, await res.text());
      return null;
    }

    const data = await res.json();
    return data;
  } catch (err) {
    console.error('fetchDashboardStats – EXCEPTION', err);
    return null;
  }
}

function applyDashboardStats(stats, { usersFallback = 0, sellersFallback = 0, productsFallback = 0 } = {}) {
  const safeNumber = (value, fallback = 0) => {
    const num = Number(value);
    return Number.isFinite(num) ? num : fallback;
  };

  dashboardSummary = {
    visitsToday: safeNumber(stats?.summary?.visitsToday),
    newUsersToday: safeNumber(stats?.summary?.newUsersToday),
    newSellersToday: safeNumber(stats?.summary?.newSellersToday),
    newProductsToday: safeNumber(stats?.summary?.newProductsToday),
    newServiceShopsToday: safeNumber(stats?.summary?.newServiceShopsToday),
    totalUsers: safeNumber(stats?.summary?.totalUsers, safeNumber(usersFallback)),
    totalSellers: safeNumber(stats?.summary?.totalSellers, safeNumber(sellersFallback)),
    totalProducts: safeNumber(stats?.summary?.totalProducts, safeNumber(productsFallback)),
    totalServiceShops: safeNumber(stats?.summary?.totalServiceShops),
    activeServiceShops: safeNumber(stats?.summary?.activeServiceShops),
    pendingServiceShops: safeNumber(stats?.summary?.pendingServiceShops),
    premiumServiceShops: safeNumber(stats?.summary?.premiumServiceShops),
    generatedAt: stats?.generatedAt || null,
    range: stats?.range || null
  };

  const trendsPayload = Array.isArray(stats?.trends) ? stats.trends : [];

  const normalisedTrend = trendsPayload
    .map((item) => {
      const iso = typeof item.date === 'string'
        ? item.date.slice(0, 10)
        : (item.date ? new Date(item.date).toISOString().slice(0, 10) : null);

      if (!iso) return null;

      const dateObj = new Date(iso);
      const label = Number.isNaN(dateObj.getTime())
        ? iso
        : persianDateFormatter.format(dateObj);

      return {
        date: iso,
        label,
        visits: safeNumber(item.visits),
        users: safeNumber(item.newUsers),
        sellers: safeNumber(item.newSellers),
        products: safeNumber(item.newProducts),
        serviceShops: safeNumber(item.newServiceShops)
      };
    })
    .filter(Boolean)
    .sort((a, b) => a.date.localeCompare(b.date));

  dashboardTrend = normalisedTrend;
  trendLabels = dashboardTrend.map((item) => item.label);
  visitsPerDay = dashboardTrend.map((item) => item.visits);
  usersPerDay = dashboardTrend.map((item) => item.users);
  sellersPerDay = dashboardTrend.map((item) => item.sellers);
  productsPerDay = dashboardTrend.map((item) => item.products);
  serviceShopsPerDay = dashboardTrend.map((item) => item.serviceShops);
}

async function fetchUsers() {
  try {
    const res = await fetch(`${ADMIN_API_BASE}/user`, {   // ← مسیر مفرد
      credentials: 'include'
      });
    if (!res.ok) {
      console.error('Error fetching users:', res.status, await res.text());
      return [];
    }
    const data = await res.json();
    console.log('fetchUsers returned:', data);      // ← برای دیباگ بنویسید ببینید زیر چه کلیدی آبجکتِ کاربرهاست
    // اگر مستقیماً آرایه است:
    if (Array.isArray(data)) return data;
    // اگر زیر فیلد users یا data قرار گرفته:
    if (Array.isArray(data.users)) return data.users;
    if (Array.isArray(data.data))  return data.data;
    return [];
  } catch (err) {
    console.error('Exception in fetchUsers:', err);
    return [];
  }
}


async function fetchShops() {
  const res = await fetch(ADMIN_API_BASE + '/shops', {
    credentials: 'include'
  });
  const data = await res.json();
  return Array.isArray(data) ? data : (data.shops || data.data || []);
}

async function ensureShopsLoaded() {
  if (!shopsList.length) {
    shopsList = await fetchShops();
  }
}

async function sellerExists(phone) {
  await ensureShopsLoaded();
  return shopsList.some(s => normalizePhone(s.ownerPhone || s.phone || s.shopPhone) === phone);
}
/* -------- fetchProducts (FIXED & ROBUST) -------- */
async function fetchProducts () {
  try {
    const res = await fetch(`${ADMIN_API_BASE}/products`, { credentials: 'include' });

    /* اگر پاسخ خطاست یک آرایهٔ خالی برگردانیم */
    if (!res.ok) {
      console.error('fetchProducts – HTTP‑', res.status, await res.text());
      return [];
    }

    const data = await res.json();

    /* در بسیاری از بک‑اِندها دادهٔ واقعی زیر کلیدهای متفاوت است */
    const productsArr =
          (Array.isArray(data)                    ? data                     :
          Array.isArray(data.products)            ? data.products            :
          Array.isArray(data.items)               ? data.items               :
          Array.isArray(data.allProducts)         ? data.allProducts         :
          Array.isArray(data.data?.products)      ? data.data.products       :
          Array.isArray(data.data?.items)         ? data.data.items          :
          []);

    return productsArr;
  } catch (err) {
    console.error('fetchProducts – EXCEPTION', err);
    return [];
  }
}


// -------- نمایش کارت‌ها و جداول --------
function updateDashboardCards() {
  document.getElementById('visit-today').textContent = formatNumber(dashboardSummary.visitsToday);
  document.getElementById('register-user-today').textContent = formatNumber(dashboardSummary.newUsersToday);
  document.getElementById('register-seller-today').textContent = formatNumber(dashboardSummary.newSellersToday);
  document.getElementById('products-total').textContent = formatNumber(dashboardSummary.totalProducts);
  const serviceCardValue = document.getElementById('service-shops-total');
  if (serviceCardValue) {
    serviceCardValue.textContent = formatNumber(dashboardSummary.activeServiceShops);
  }
}
function updateSidebarCounts() {
  document.getElementById('count-users').textContent    = formatNumber(usersList.length);
  document.getElementById('count-sellers').textContent  = formatNumber(shopsList.length);
  document.getElementById('count-products').textContent = formatNumber(productsList.length);
  const serviceCountEl = document.getElementById('count-service-shops');
  if (serviceCountEl) {
    serviceCountEl.textContent = formatNumber(dashboardSummary.totalServiceShops || 0);
  }
  const centersCountEl = document.getElementById('count-shopping-centers');
  if (centersCountEl) centersCountEl.textContent = formatNumber(shoppingCentersList.length);

  const unread = getTotalUnreadMessages();
  // فقط اگر عدد بزرگ‌تر از صفر باشد نمایش بده
  document.getElementById('count-messages').textContent = unread > 0 ? formatNumber(unread) : '';
  updateAdOrdersSummary();
}
function updateHeaderCounts() {
  document.getElementById('header-users-count').textContent    = `(${formatNumber(usersList.length)} کاربر)`;
  document.getElementById('header-sellers-count').textContent  = `(${formatNumber(shopsList.length)} فروشگاه)`;
  document.getElementById('header-products-count').textContent = `(${formatNumber(productsList.length)} محصول)`;
  const centersHeaderEl = document.getElementById('header-shopping-centers-count');
  if (centersHeaderEl) centersHeaderEl.textContent = `(${formatNumber(shoppingCentersList.length)} مرکز خرید)`;

  const unread = getTotalUnreadMessages();
  // اگر صفر بود خالی بنویس
  document.getElementById('header-messages-count').textContent =
    unread > 0 ? `(${formatNumber(unread)} پیام جدید)` : '';
}




// -------- نمایش کاربران --------
// -------- نمایش کاربران --------
function renderUsers(filteredUsers = usersList) {
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  filteredUsers.forEach((user, i) => {
    const fullName = `${user.firstname || user.name || ''} ${user.lastname || ''}`.trim();
    const contact = user.email || user.phone || '';
    let tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="user-cell user-modal-trigger" style="cursor:pointer;color:#10b981;font-weight:bold">${fullName}</td>
      <td class="user-cell user-modal-trigger" style="cursor:pointer">${contact}</td>
      <td>
        <button class="action-btn delete" onclick="deleteUser(${i})"><i class="ri-delete-bin-line"></i> حذف</button>
        ${user.blockedByAdmin
          ? `<button class="action-btn unblock" onclick="unblockUser('${user._id || user.id}', ${i})">آزاد کردن</button>`
          : `<button class="action-btn block" onclick="blockUser('${user._id || user.id}', ${i})">مسدودسازی</button>`}
      </td>
    `;
    // اتصال ایندکس کاربر به هر سلول قابل کلیک
    Array.from(tr.querySelectorAll('.user-modal-trigger')).forEach(td=>{
      td.onclick = () => showUserModal(user);
    });
    tbody.appendChild(tr);
  });
  if (!filteredUsers.length) {
    tbody.innerHTML = `<tr><td colspan="3" style="color:#888;text-align:center">هیچ کاربری یافت نشد.</td></tr>`;
  }
}

// پاپ‌آپ اطلاعات کاربر
function showUserModal(user) {
  const overlay = document.getElementById('user-modal-overlay');
  const uid = toIdString(user._id || user.id || '');
  const fullName = `${user.firstname || ''} ${user.lastname || ''}`.trim() || user.name || '-';
  const fDate = d => d ? new Date(d).toLocaleDateString('fa-IR',{year:'numeric',month:'long',day:'numeric'}) : '—';

  const modalHtml = `
    <div class="user-modal">
      <button class="user-modal-close" onclick="closeUserModal()">×</button>
      <div class="user-modal-title">
        مشخصات کاربر:
        <span style="color:#0ea5e9">${fullName}</span>
      </div>
      <div class="user-modal-row">
        <span class="user-modal-label">نام:</span>
        <span class="user-modal-value">${user.firstname || '-'}</span>
      </div>
      <div class="user-modal-row">
        <span class="user-modal-label">نام خانوادگی:</span>
        <span class="user-modal-value">${user.lastname || '-'}</span>
      </div>
      <div class="user-modal-row">
        <span class="user-modal-label">ایمیل:</span>
        <span class="user-modal-value">${user.email || '-'}</span>
      </div>
      <div class="user-modal-row">
        <span class="user-modal-label">تلفن:</span>
        <span class="user-modal-value">${user.phone || '-'}</span>
      </div>
      <div class="user-modal-row">
        <span class="user-modal-label">ثبت‌نام:</span>
        <span class="user-modal-value">${fDate(user.createdAt)}</span>
      </div>
      <form id="userMessageForm" class="user-modal-form" data-user-id="${uid}">
        <label for="userMessage">ارسال پیام به این کاربر:</label>
        <textarea id="userMessage" name="msg" placeholder="پیام خود را بنویسید…" required></textarea>
        <button type="submit">ارسال پیام</button>
        <div id="user-modal-success" class="user-modal-success" style="display:none"></div>
      </form>
    </div>`;

  overlay.innerHTML = modalHtml;
  overlay.style.display = 'flex';

  document.getElementById('userMessageForm').addEventListener('submit', sendUserMessage);
}

function closeUserModal() {
  document.getElementById('user-modal-overlay').style.display = "none";
  document.getElementById('user-modal-overlay').innerHTML = "";
}

async function sendUserMessage(e) {
  e.preventDefault();
  const form = e.currentTarget;
  const uid = form.dataset.userId;
  const text = form.querySelector('textarea').value.trim();

  if (!text) return alert('متن پیام نمی‌تواند خالی باشد.');
  if (!uid) return alert('شناسه کاربر پیدا نشد!');

  try {
    // ابتدا اطمینان حاصل کن که چت بین ادمین و کاربر وجود دارد
    const ensureRes = await fetch(`${ADMIN_API_BASE}/chats/ensure`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ recipientId: uid, recipientRole: 'user' })
    });
    const chat = await ensureRes.json();
    if (!ensureRes.ok) throw new Error(chat.error || 'خطا در ایجاد گفتگو');

    // سپس پیام را به عنوان ادمین در آن چت ارسال کن
    const res = await fetch(`${ADMIN_API_BASE}/chats/${chat._id}/admin-reply`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ text })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'خطا در ارسال پیام');

    form.querySelector('textarea').value = '';
    const okBox = document.getElementById('user-modal-success');
    okBox.textContent = '✅ پیام با موفقیت ارسال شد!';
    okBox.style.display = 'block';
    setTimeout(() => okBox.style.display = 'none', 2500);
  } catch (err) {
    console.error('sendUserMessage error:', err);
    alert('❌ خطا در ارسال پیام:\n' + err.message);
  }
}
// جستجو کاربران
document.getElementById('userSearch').addEventListener('input', e => {
  const q = e.target.value.trim().toLowerCase();
  const filtered = usersList.filter(u => {
    return (
      (u.firstname || '').toLowerCase().includes(q) ||
      (u.lastname || '').toLowerCase().includes(q) ||
      (u.name || '').toLowerCase().includes(q) ||
      (u.phone || '').toLowerCase().includes(q)
    );
  });
  renderUsers(filtered);
});


// جستجو محصولات
document.getElementById('productSearch').addEventListener('input', e => {
  productSearchQuery = e.target.value.trim().toLowerCase();
  renderProducts();
});

// فیلتر مرتب‌سازی محصولات
document.querySelectorAll('.products-filters button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.products-filters button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    productsSortMode = btn.getAttribute('data-sort');
    renderProducts();
  });
});

// -------- نمایش فروشگاه‌ها --------







window.deleteSeller = async function(id) {
  const idx = shopsList.findIndex(s =>
    toIdString(s.sellerId) === id ||
    toIdString(s.seller_id) === id ||
    toIdString(s._id) === id ||
    toIdString(s._sid) === id ||
    toIdString(s.shopurl) === id
  );
  const shop = shopsList[idx];
  if (!shop) return alert('فروشگاه پیدا نشد!');
  const name = shop.storename || shop.shopLogoText || 'بدون‌نام';

  if (!confirm(`آیا از حذف «${name}» مطمئن هستید؟`)) return;

  const sid = shop.sellerId || shop.seller_id || shop._id || shop._sid || null;
  if (!sid) return alert('شناسه فروشنده نامعتبر است.');

  console.log('Deleting seller:', sid, name);

  try {
    const res = await fetch(`${ADMIN_API_BASE}/sellers/${encodeURIComponent(sid)}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'خطا در حذف فروشنده');

    shopsList.splice(idx, 1);
    renderSellers();
    updateSidebarCounts();
    updateHeaderCounts();
    alert('✅ فروشنده با موفقیت حذف شد.');
  } catch (err) {
    console.error('deleteSeller error:', err);
    alert('❌ ' + err.message);
  }
};




/* ---------- helper : پیدا کردن فروشگاه یک محصول ---------- */
function findShopForProduct(prod) {
  if (!prod) return null;

  /* 1) بر اساس shopurl */
  if (prod.shopurl) {
    return shopsList.find(s => String(s.shopurl) === String(prod.shopurl));
  }

  /* 2) بر اساس شناسهٔ فروشنده */
  const sid = toIdString(prod.sellerId || prod.seller_id);
  if (sid) {
    return shopsList.find(s =>
      toIdString(s.sellerId || s.seller_id || s._sid) === sid
    );
  }
  return null;
}


// -------- نمایش محصولات --------
/* ---------- renderProducts (نسخهٔ جدید) ---------- */
/* -------- renderProducts (NO product‑count column) -------- */
// -------- نمایش محصولات --------
function renderProducts() {
  const tbody = document.querySelector('#productsTable tbody');
  tbody.innerHTML = '';

  // ۱) کپی لیست و اعمال فیلتر جستجو
  let list = [...productsList];
  if (productSearchQuery) {
    list = list.filter(prod => {
      let shop = prod.seller || findShopForProduct(prod);
      return (
        (prod.title || prod.name || '').toLowerCase().includes(productSearchQuery) ||
        (shop?.storename || shop?.shopLogoText || '').toLowerCase().includes(productSearchQuery) ||
        (shop?.ownerName || `${shop?.ownerFirstname || ''} ${shop?.ownerLastname || ''}`.trim().toLowerCase()).includes(productSearchQuery)
      );
    });
  }

  // ۲) اعمال مرتب‌سازی (فرض: فیلد createdAt در هر محصول وجود دارد)
  list.forEach(prod => {
    prod._createdAt = prod.createdAt ? new Date(prod.createdAt).getTime() : 0;
  });
  if (productsSortMode === 'newest') {
    list.sort((a, b) => b._createdAt - a._createdAt);
  } else if (productsSortMode === 'oldest') {
    list.sort((a, b) => a._createdAt - b._createdAt);
  }

  // ۳) اگر لیست خالی بود
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#888;padding:1.5rem">هیچ محصولی یافت نشد.</td></tr>`;
    return;
  }

  // ۴) رندر لیست فیلترشده/مرتب‌شده
  list.forEach((prod, i) => {
    let shop = prod.seller || findShopForProduct(prod);
    const productName = prod.title || prod.name || '-';
    const storeName = shop ? (shop.storename || shop.shopLogoText || '-') : '-';
    const ownerName = shop ? (shop.ownerName || `${shop.ownerFirstname || ''} ${shop.ownerLastname || ''}`.trim() || '-') : '-';
    const storeAddr = shop ? (shop.address || shop.shopAddress || '-') : '-';
    const shopUrl = (shop ? shop.shopurl : (prod.shopurl || prod.shopUrl || '')) || '';
    const linkHTML = shopUrl ? `<a href="/shop.html?shopurl=${encodeURIComponent(shopUrl)}" target="_blank" style="color:#0ea5e9;text-decoration:underline">${shopUrl}</a>` : '-';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${productName}</td>
      <td>${storeName}</td>
      <td>${ownerName}</td>
      <td>${storeAddr}</td>
      <td>${linkHTML}</td>
      <td>
        <button class="action-btn edit" onclick="editProduct(${i})"><i class="ri-pencil-line"></i> ویرایش</button>
        <button class="action-btn delete" onclick="deleteProduct(${i})"><i class="ri-delete-bin-line"></i> حذف</button>
      </td>`;
    tbody.appendChild(tr);
  });
}



// -------- حذف محصول --------
window.deleteProduct = async function (idx) {
  const prod = productsList[idx];
  if (!prod) return alert('محصول پیدا نشد!');
  
  if (!confirm(`آیا مطمئن هستید که می‌خواهید محصول "${prod.title || prod.name || 'نامشخص'}" را حذف کنید؟`)) return;

  try {
    const res = await fetch(`${ADMIN_API_BASE}/products/${prod._id || prod.id}`, {
      method: 'DELETE',
      credentials: 'include'  // برای ارسال کوکی‌های احراز هویت (مثل admin_token)
    });

    if (!res.ok) {
      const data = await res.json();
      throw new Error(data.message || 'خطا در حذف محصول');
    }

    // حذف از لیست محلی و رندر مجدد
    productsList.splice(idx, 1);
    renderProducts();
    updateSidebarCounts();
    updateHeaderCounts();
    alert('✅ محصول با موفقیت حذف شد.');

  } catch (err) {
    console.error('❌ deleteProduct error:', err);
    alert('❌ ' + err.message);
  }
};




window.deleteUser = async function (idx) {
  const user = usersList[idx];
  if (!user)        return alert('کاربر پیدا نشد!');
  const name = `${user.firstname || ''} ${user.lastname || ''}`.trim()
               || user.name || user.phone || 'بدون‌نام';

  if (!confirm(`آیا از حذف «${name}» مطمئن هستید؟
پس از حذف، این شماره دیگر قادر به ورود یا ثبت‌نام نخواهد بود.`)) return;

  try {
    const res  = await fetch(`${ADMIN_API_BASE}/user/${user._id || user.id}`, {
      method      : 'DELETE',
      credentials : 'include'
    });
    const data  = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'خطا در حذف کاربر');

    /* پاک‌کردن از آرایهٔ محلی و رندر مجدد رابط */
    usersList.splice(idx, 1);
    renderUsers();
    updateSidebarCounts();
    updateHeaderCounts();

    alert('✅ کاربر با موفقیت حذف و مسدود شد.');
  } catch (err) {
    console.error('deleteUser error:', err);
    alert('❌ ' + err.message);
  }
};

window.blockUser = async function(id, idx) {
  if (!id) return alert('شناسه معتبر یافت نشد');
  if (!confirm('آیا مطمئن هستید که می‌خواهید این مشتری را مسدود کنید؟')) return;
  try {
    console.log('blockUser ->', { targetId: id, targetRole: 'user' });
    const res = await fetch(`${ADMIN_API_BASE}/chats/block-target`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targetId: id, targetRole: 'user' })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'خطا در مسدودسازی');
    usersList[idx].blockedByAdmin = true;
    renderUsers();
    alert('✅ کاربر با موفقیت مسدود شد.');
  } catch (err) {
    console.error('blockUser error:', err);
    alert('❌ ' + err.message);
  }
};

window.unblockUser = async function(id, idx) {
  if (!id) return alert('شناسه معتبر یافت نشد');
  if (!confirm('آیا مطمئن هستید که می‌خواهید این مشتری را آزاد کنید؟')) return;
  try {
    console.log('unblockUser ->', { targetId: id, targetRole: 'user' });
    const res = await fetch(`${ADMIN_API_BASE}/chats/unblock-target`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targetId: id, targetRole: 'user' })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'خطا در رفع مسدودی');
    usersList[idx].blockedByAdmin = false;
    renderUsers();
    alert('✅ کاربر آزاد شد.');
  } catch (err) {
    console.error('unblockUser error:', err);
    alert('❌ ' + err.message);
  }
};








// -------- Nav & Responsive (FIXED) --------
// -------- Nav & Responsive (FIXED) --------
const sidebar       = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');
const menuLinks     = document.querySelectorAll('.sidebar-menu a');

// آبجکت پنل‌ها را قبلاً تعریف کرده‌اید:
const panels = {
  dashboard: document.getElementById('dashboard-panel'),
  users:     document.getElementById('users-panel'),
  sellers:   document.getElementById('sellers-panel'),
  products:  document.getElementById('products-panel'),
  'shopping-centers': document.getElementById('shopping-centers-panel'),
  plans:     document.getElementById('plans-panel'),
  ads:       document.getElementById('ads-panel'),
  'ad-orders': document.getElementById('ad-orders-panel'),
  'home-section': document.getElementById('home-section-panel'),
  messages:  document.getElementById('messages-panel'),
  'daily-visits': document.getElementById('daily-visits-panel')
};

menuLinks.forEach(link => {
  link.addEventListener('click', async e => {
    const section = link.dataset.section;

    if (!section) {
      return;
    }

    e.preventDefault();

    // 1) استایلِ active در منو
    menuLinks.forEach(l => l.classList.remove('active'));
    link.classList.add('active');

    // 2) مخفی/نمایشِ پنل‌ها
    Object.values(panels).forEach(p => p.style.display = 'none');
    if (!panels[section]) return;
    panels[section].style.display = 'block';

    // 3) به‌روزرسانی شمارندهٔ هدر
    updateHeaderCounts();

    // 4) وقتی وارد بخش پیام‌ها شدیم، polling را استارت کن؛
    //    وقتی خارج شدیم، polling را متوقف کن.
    if (section === 'messages') {
      startMessagesPolling();
    } else {
      stopMessagesPolling();
    }

    if (section === 'shopping-centers') {
      await ensureShoppingCentersLoaded();
    }

    if (section === 'ad-orders') {
      await loadAdOrders();
    }

    // لود محتوای AJAX برای آمار روزانه بازدید
    if (section === 'daily-visits') {
      loadDailyVisContent();
    }

    // لود محتوای کارت‌های صفحه اصلی
    if (section === 'home-section') {
      loadHomeSectionContent();
    }

    // 5) بستن سایدبار در موبایل
    if (window.innerWidth < 700) sidebar.classList.remove('open');
  });
});

// دکمهٔ برگر در موبایل
sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
document.body.addEventListener('click', e => {
  if (
    window.innerWidth < 700 &&
    sidebar.classList.contains('open') &&
    !sidebar.contains(e.target) &&
    e.target !== sidebarToggle
  ) {
    sidebar.classList.remove('open');
  }
});
window.addEventListener('resize', () => {
  if (window.innerWidth > 700) sidebar.classList.remove('open');
});


// -------- نمودار داینامیک داشبورد --------
let chartObj;
let filterBtns = [
  {label: 'امروز', value: 'today'},
  {label: 'دیروز', value: 'yesterday'},
  {label: '۷ روز اخیر', value: 'week'},
  {label: '۳۰ روز اخیر', value: 'month'},
];

function showDashboardChart(type, title) {
  let wrap = document.getElementById('dashboard-dynamic-chart-wrap');
  wrap.innerHTML = `
    <div class="dynamic-chart-box-pro">
      <div class="dynamic-chart-top">
        <span id="chartBox-title">${title}</span>
        <button id="close-dash-chart" class="close-dash-chart-btn">×</button>
      </div>
      <div class="dynamic-chart-filters">
        ${filterBtns.map(b => `<button class="dash-filter-btn" data-v="${b.value}">${b.label}</button>`).join('')}
      </div>
      <div class="dynamic-chart-canvas-wrap">
        <canvas id="chartBox-canvas"></canvas>
        <div id="chartBox-empty" class="dynamic-chart-empty">
          داده‌ای برای این بازه زمانی ثبت نشده است.
        </div>
      </div>
    </div>
  `;

  document.getElementById('close-dash-chart').onclick = () => {
    wrap.innerHTML = "";
    if (chartObj) chartObj.destroy();
  };

  const arrs = {
    visits: visitsPerDay,
    users: usersPerDay,
    sellers: sellersPerDay,
    products: productsPerDay,
    serviceShops: serviceShopsPerDay
  };

  function getData(period) {
    const arr = arrs[type] || [];
    const labels = trendLabels;
    const count = arr.length;

    if (!count) {
      return { data: [], labels: [] };
    }

    if (period === 'today') {
      const idx = count - 1;
      return {
        data: [arr[idx]],
        labels: [labels[idx] || 'امروز']
      };
    }

    if (period === 'yesterday') {
      const idx = count - 2;
      if (idx < 0) return { data: [], labels: [] };
      return {
        data: [arr[idx]],
        labels: [labels[idx] || 'دیروز']
      };
    }

    if (period === 'week') {
      const sliceStart = Math.max(count - 7, 0);
      const dataSlice = arr.slice(sliceStart);
      const labelSlice = labels.slice(sliceStart, sliceStart + dataSlice.length);
      return { data: dataSlice, labels: labelSlice };
    }

    if (period === 'month') {
      const limit = window.innerWidth < 700 ? 10 : 30;
      const sliceStart = Math.max(count - limit, 0);
      const dataSlice = arr.slice(sliceStart);
      const labelSlice = labels.slice(sliceStart, sliceStart + dataSlice.length);
      return { data: dataSlice, labels: labelSlice };
    }

    return { data: arr, labels };
  }

  function getColor() {
    if (type === "visits") return "rgba(16,185,129,1)";
    if (type === "users") return "rgba(14,165,233,1)";
    if (type === "sellers") return "rgba(22,163,74,1)";
    if (type === "products") return "rgba(234,179,8,1)";
    return "#666";
  }
  function getGradient(ctx) {
    let grad = ctx.createLinearGradient(0,0,0,260);
    grad.addColorStop(0,"rgba(14,165,233,0.25)");
    grad.addColorStop(1,"rgba(16,185,129,0.04)");
    return grad;
  }
  function getType(period) {
    return (period === "today" || period === "yesterday") ? "bar" : "line";
  }
  const canvas = document.getElementById('chartBox-canvas');
  const emptyBox = document.getElementById('chartBox-empty');

  wrap.querySelectorAll(".dash-filter-btn").forEach(btn => {
    btn.onclick = () => {
      wrap.querySelectorAll(".dash-filter-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      let period = btn.getAttribute("data-v");
      let { data, labels } = getData(period);
      if (chartObj) {
        chartObj.destroy();
        chartObj = null;
      }

      if (!data.length) {
        canvas.style.display = 'none';
        emptyBox.style.display = 'flex';
        return;
      }

      emptyBox.style.display = 'none';
      canvas.style.display = 'block';

      let parW = Math.max(canvas.parentElement.offsetWidth, 360);
      canvas.width = Math.min(900, parW - 0 + 1);
      canvas.height = window.innerWidth < 600 ? 240 : 340;

      let color = getColor();
      let typeC = getType(period);

      chartObj = new Chart(canvas.getContext('2d'), {
        type: typeC,
        data: {
          labels: labels,
          datasets: [{
            label: title,
            data: data,
            backgroundColor: (ctx) =>
              typeC === "bar"
                ? color + "B0"
                : getGradient(ctx.chart.ctx),
            borderColor: color,
            borderWidth: 4,
            fill: true,
            tension: 0.5,
            pointRadius: 8,
            pointBackgroundColor: color,
            pointBorderColor: "#fff",
            pointHoverRadius: 12,
            pointHoverBorderWidth: 2,
            barPercentage: 0.45,
            categoryPercentage: 0.7,
            borderCapStyle: 'round'
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              rtl: true,
              padding: 15,
              backgroundColor: "#fff",
              borderColor: "#10b98122",
              borderWidth: 1.2,
              titleColor: "#16a34a",
              bodyColor: "#0ea5e9",
              bodyFont: { family: "Vazirmatn" },
              titleFont: { family: "Vazirmatn", weight: "bold", size:16 },
              displayColors: false,
              callbacks: {
                title: (ctx) => ctx[0].label,
                label: (ctx) => " " + ctx.dataset.label + ": " + ctx.formattedValue
              }
            }
          },
          layout: { padding: { left: 5, right: 5, top: 0, bottom: 5 } },
          scales: {
            y: {
              beginAtZero: true,
              border: { color: "#e5e7eb" },
              grid: { color: "#e5e7eb2b", drawTicks: false, borderDash: [3,5] },
              ticks: { color: '#999', font: { size: 15, weight:'bold' } }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#555', font: { size: 15, weight: 700 } }
            }
          }
        }
      });
    };
  });
  wrap.querySelector('.dash-filter-btn[data-v="week"]').click();
}

// کلیک روی کارت‌های آمار
document.getElementById('card-visits').onclick = ()=> showDashboardChart("visits", "آمار بازدید سایت");
document.getElementById('card-users').onclick = ()=> showDashboardChart("users", "آمار ثبت‌نام کاربران");
document.getElementById('card-sellers').onclick = ()=> showDashboardChart("sellers", "آمار فروشگاه‌ها");
document.getElementById('card-products').onclick = ()=> showDashboardChart("products", "آمار محصولات جدید");
const cardServiceShops = document.getElementById('card-service-shops');
if (cardServiceShops) {
  cardServiceShops.onclick = ()=> showDashboardChart("serviceShops", "آمار مغازه‌های خدماتی جدید");
}

const shoppingCenterFormEl = document.getElementById('shoppingCenterForm');
if (shoppingCenterFormEl) {
  shoppingCenterFormEl.addEventListener('submit', handleShoppingCenterSubmit);
}

const shoppingCentersRefreshBtn = document.getElementById('shoppingCentersRefresh');
if (shoppingCentersRefreshBtn) {
  shoppingCentersRefreshBtn.addEventListener('click', async () => {
    const original = shoppingCentersRefreshBtn.innerHTML;
    shoppingCentersRefreshBtn.disabled = true;
    shoppingCentersRefreshBtn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> در حال بروزرسانی';
    try {
      await ensureShoppingCentersLoaded(true);
      setShoppingCenterFormMessage('لیست مراکز خرید بروزرسانی شد.', 'info');
    } catch (err) {
      console.error('shoppingCentersRefresh error:', err);
      setShoppingCenterFormMessage('خطا در بروزرسانی مراکز خرید.', 'error', 6000);
    } finally {
      shoppingCentersRefreshBtn.disabled = false;
      shoppingCentersRefreshBtn.innerHTML = original;
    }
  });
}

// -------- لود اولیه دیتا و بروزرسانی --------
// نسخهٔ اصلاح‌شده‌ی updateAll — فقط همین تابع را جایگزین کن
async function updateAll() {
  try {
    // ۱) واکشی هم‌زمان داده‌ها و آمار داشبورد
    const [users, shops, products, centers, stats] = await Promise.all([
      fetchUsers(),
      fetchShops(),
      fetchProducts(),
      fetchShoppingCenters(),
      fetchDashboardStats()
    ]);

    // ۲) ست‌کردن آرایه‌های سراسری
    usersList    = users;
    shopsList    = shops;
    shoppingCentersList = centers;
    shoppingCentersLoaded = true;
    renderShoppingCenters();
    await refreshSellerPerformanceMap();
    console.group('🟢 shopsList snapshot');
shopsList.slice(0, 10).forEach((s, i) => {
  console.log(i,
    'sid:',   s._sid,
    '_id:',   toIdString(s._id),
    'sellerId:', toIdString(s.sellerId ?? s.seller_id),
    'shopurl:', toIdString(s.shopurl)
  );
});
console.groupEnd();

    productsList = products;
    updateSidebarCounts();
    updateHeaderCounts();
    await loadAdOrders();

    // ۳) به‌روزرسانی آمار داشبورد
    applyDashboardStats(stats, {
      usersFallback: usersList.length,
      sellersFallback: shopsList.length,
      productsFallback: productsList.length
    });

    // ۴) تعیین شناسهٔ یکتا برای هر فروشنده
   // ۳) تعیین شناسهٔ یکتا برای هر فروشنده (نسخه‌ی جدید)
/* ─── STEP 1 : ساخت شناسه یکتا برای هر فروشنده ───────── */
shopsList.forEach(s => {
  // محاسبه‌ی شناسه یکتا
  const uniqueId = toIdString(
    s.sellerId   || s.seller_id ||
    s._id        || s.id        ||
    (s.shopurl ? 'shopurl:' + s.shopurl : '')
  );
  s._sid     = uniqueId;
  s.sellerId = uniqueId;   // ← این خط را اضافه کن
});


/* 🆕  لاگ تحلیلی – فقط برای دیباگ. خواستی بعداً حذف کن. */
console.table(
  shopsList.map(({_sid, _id, sellerId, shopurl}) => ({ _sid, _id, sellerId, shopurl }))
);
/* ─────────────────────────────────────────────────────── */



    // ۵) پس از داشتن _sidها، مپ نام‌ها را بساز
    buildNameMaps();

    // ۶) واکشی پیام‌ها (برای شمارنده و نمایش)
    await fetchMessages();

    // حتماً جدول پیام‌ها را هم رندر کن
    renderMessages();

    // ۷) رندر رابط کاربری
    updateDashboardCards();
    updateSidebarCounts();
    updateHeaderCounts();
    renderUsers();
    renderSellers();
    renderProducts();

  } catch (err) {
    alert('خطا در دریافت داده‌های پنل ادمین!\n' + (err.message || err));
  }
}



/* اجرای اولیه */
updateAll();


let style = document.createElement('style');
style.innerHTML = `@keyframes fadeIn{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:none;}}`;
document.head.appendChild(style);







// --- فیلتر و مرتب‌سازی فروشگاه‌ها ---
let sellersSortMode = 'newest'; // حالت پیش‌فرض
document.querySelectorAll('.seller-filter-btn').forEach(btn => {
  btn.onclick = function() {
    document.querySelectorAll('.seller-filter-btn').forEach(b=>b.classList.remove('active'));
    this.classList.add('active');
    sellersSortMode = this.getAttribute('data-sort');
    renderSellers();
  }
});


let sellerSearchQuery = '';  // متغیر برای ذخیره کوئری جستجو

// جستجو فروشگاه‌ها
document.getElementById('sellerSearch').addEventListener('input', e => {
  sellerSearchQuery = e.target.value.trim().toLowerCase();
  renderSellers();
});

function renderSellers() {
  const tbody = document.querySelector('#sellersTable tbody');
  tbody.innerHTML = '';

  if (!shopsList.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="color:#888;text-align:center">هیچ فروشگاهی ثبت نشده است.</td></tr>`;
    return;
  }

  // فیلتر جستجو (نام فروشگاه، نام صاحب، آدرس)
  let sellers = shopsList.filter(shop => {
    const storeName = (shop.storename || shop.shopLogoText || '').toLowerCase();
    const ownerName = (shop.ownerName || `${shop.ownerFirstname || ''} ${shop.ownerLastname || ''}`.trim()).toLowerCase();
    const storeAddr = (shop.address || shop.shopAddress || '').toLowerCase();
    const phone = (shop.phone || shop.mobile || shop.ownerPhone || shop.ownerMobile || '').toLowerCase();
    return (
      storeName.includes(sellerSearchQuery) ||
      ownerName.includes(sellerSearchQuery) ||
      storeAddr.includes(sellerSearchQuery) ||
      phone.includes(sellerSearchQuery)
    );
  });

  sellers.forEach(shop => {
    shop._productsCount = shop.productsCount ?? shop.productCount ?? 0;
    shop._visits = shop.visits || shop.shopVisits || 0;
    shop._createdAt = shop.createdAt ? new Date(shop.createdAt).getTime() : 0;
    shop._subStart = shop.subscriptionStart ? new Date(shop.subscriptionStart) : null;
    shop._subEnd = shop.subscriptionEnd ? new Date(shop.subscriptionEnd) : null;
  });

  // مرتب‌سازی
  if (sellersSortMode === 'newest') {
    sellers.sort((a, b) => b._createdAt - a._createdAt);
  } else if (sellersSortMode === 'oldest') {
    sellers.sort((a, b) => a._createdAt - b._createdAt);
  } else if (sellersSortMode === 'mostvisited') {
    sellers.sort((a, b) => b._visits - a._visits);
  } else if (sellersSortMode === 'mostproducts') {
    sellers.sort((a, b) => b._productsCount - a._productsCount);
  }

  sellers.forEach((shop, i) => {
    let countProducts = shop._productsCount;
    let ownerName = shop.ownerName || `${shop.ownerFirstname || ''} ${shop.ownerLastname || ''}`.trim() || "-";
    let shopLink = shop.shopurl
      ? `<a href="/shop.html?shopurl=${shop.shopurl}" target="_blank" style="color:#0ea5e9;text-decoration:underline">${shop.shopurl}</a>`
      : '-';

    const sellerKey = resolveSellerKeyFromShop(shop);
    const performance = sellerKey ? getSellerPerformanceByKey(sellerKey) : null;
    const adminScore = performance && performance.adminScore != null ? performance.adminScore : null;
    const scoreBadge = adminScore != null
      ? `<span class="seller-score-badge has-score"><strong>${adminScore}</strong><span class="score-suffix">/100</span></span>`
      : '<span class="seller-score-badge no-score">ثبت نشده</span>';
    const statusSeverity = performance ? performance.severity || 'neutral' : 'neutral';
    const statusLabel = performance ? performance.statusLabel : 'در انتظار ارزیابی';
    const statusBadge = `<span class="seller-status-pill status-${statusSeverity}">${statusLabel}</span>`;
    const eligibilityClass = performance
      ? (performance.canStay ? 'status-eligible' : 'status-ineligible')
      : 'status-neutral';
    const eligibilityText = performance
      ? (performance.canStay ? '✅ مجاز به ادامه فعالیت' : '⛔ امکان ادامه فعالیت در ویترینت وجود ندارد')
      : 'در انتظار ارزیابی ادمین';
    const combinedStatus = `<div class="seller-score-cell-wrap">${scoreBadge}${statusBadge}<span class="seller-status-note ${eligibilityClass}">${eligibilityText}</span></div>`;
    const sid = toIdString(shop.sellerId || shop.seller_id || shop._id || shop._sid || shop.shopurl);
    let tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="seller-cell seller-modal-trigger" style="cursor:pointer;color:#10b981;font-weight:bold">${shop.storename || shop.shopLogoText || '-'}</td>
      <td class="seller-cell seller-modal-trigger" style="cursor:pointer">${ownerName}</td>
      <td class="seller-cell seller-modal-trigger" style="cursor:pointer">${shop.address || shop.shopAddress || '-'}</td>
      <td>${shopLink}</td>
      <td>${countProducts}</td>
      <td>${shop._visits}</td>
      <td class="seller-cell seller-modal-trigger seller-score-cell" data-score-key="${sellerKey || ''}">${combinedStatus}</td>
      <td>
        <button class="action-btn delete">
          <i class="ri-delete-bin-line"></i> حذف
        </button>
      </td>
    `;
    // اتصال ایندکس فروشنده به هر سلول قابل کلیک
    Array.from(tr.querySelectorAll('.seller-cell')).forEach(td=>{
      td.onclick = () => showSellerModal(shop);
    });
    const delBtn = tr.querySelector('.action-btn.delete');
    if (delBtn) {
      delBtn.addEventListener('click', () => deleteSeller(sid));
    }
    tbody.appendChild(tr);
  });

  if (!sellers.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="color:#888;text-align:center">هیچ فروشگاهی یافت نشد.</td></tr>`;
  }
}

// پاپ‌آپ اطلاعات فروشنده
// ← این تابع را جایگزین کنید
/* ===== نسخهٔ جدید تابع showSellerModal (همراه شماره موبایل) ===== */
/* ------------------------------------------------------------------
/* ─────────────── showSellerModal ───────────────── */
let sellerModalOverlayClickHandler = null;
let sellerModalKeydownHandler = null;
async function showSellerModal (shop) {
  const overlay = document.getElementById('seller-modal-overlay');

  /* تبدیل تاریخ میلادی به شمسی */
  const fDate = d =>
    d
      ? new Date(d).toLocaleDateString('fa-IR', {
          year: 'numeric', month: 'long', day: 'numeric'
        })
      : '—';

  /* شناسهٔ مطمئن فروشنده */
  const sellerId =
        (shop._id && shop._id.toString())              ||
        (shop.sellerId && String(shop.sellerId))       ||
        (shop._sid && !String(shop._sid).startsWith('shopurl:')
          ? String(shop._sid)
          : '')                                        ||
        (shop.shopurl ? `shopurl:${shop.shopurl}` : '');

  const storeName = shop.storename || shop.shopLogoText || '-';
  const url       = shop.shopurl  || '';
  const phone     =
        shop.phone || shop.mobile ||
        shop.ownerPhone || shop.ownerMobile || '-';
  const sellerScoreKey = resolveSellerKeyFromShop(shop);

  if (sellerScoreKey && !sellerPerformanceLoaded) {
    await refreshSellerPerformanceMap();
  }

  let performanceMeta = sellerScoreKey ? getSellerPerformanceByKey(sellerScoreKey) : null;

  const existingAdminScore = performanceMeta && performanceMeta.adminScore != null
    ? performanceMeta.adminScore
    : null;
  const defaultAdminScore = 75;
  let hasExistingScore = existingAdminScore != null;
  const initialAdminScore = hasExistingScore ? existingAdminScore : defaultAdminScore;
  const statusSeverity = performanceMeta ? performanceMeta.severity || 'neutral' : 'neutral';
  const statusLabel = performanceMeta ? performanceMeta.statusLabel : 'در انتظار ارزیابی';
  const statusMessage = performanceMeta && performanceMeta.statusMessage
    ? performanceMeta.statusMessage
    : 'پس از ثبت نمره، وضعیت عملکرد نمایش داده می‌شود.';
  const eligibilityNote = performanceMeta
    ? (performanceMeta.canStay ? '✅ این فروشنده مجاز به ادامه همکاری است.' : '⛔ با این نمره فروشنده قادر به ماندن در ویترینت نیست.')
    : 'برای تعیین وضعیت همکاری، ابتدا نمره را ثبت کنید.';
  const statusUpdatedText = performanceMeta && performanceMeta.updatedAt
    ? `آخرین بروزرسانی: ${formatDateTime(performanceMeta.updatedAt)}`
    : 'هنوز نمره‌ای ثبت نشده است.';
  const existingAdminNote = performanceMeta && typeof performanceMeta.note === 'string'
    ? performanceMeta.note
    : (performanceMeta && typeof performanceMeta.adminScoreNote === 'string'
      ? performanceMeta.adminScoreNote
      : '');
  const existingAdminMessage = performanceMeta && typeof performanceMeta.adminScoreMessage === 'string'
    ? performanceMeta.adminScoreMessage
    : (performanceMeta && typeof performanceMeta.publicMessage === 'string'
      ? performanceMeta.publicMessage
      : '');
  const defaultNoteMessage = 'یادداشتی ثبت نشده است.';
  const defaultMessageText = 'پیامی برای فروشنده ثبت نشده است.';
  const noteDisplayHtml = existingAdminNote
    ? formatNoteForDisplay(existingAdminNote)
    : escapeHtml(defaultNoteMessage);
  const noteValueForInput = escapeHtml(existingAdminNote);
  const messageDisplayHtml = existingAdminMessage
    ? formatNoteForDisplay(existingAdminMessage)
    : escapeHtml(defaultMessageText);
  const messageValueForInput = escapeHtml(existingAdminMessage);

  /* ---------- رندر اولیه ---------- */
  overlay.innerHTML = `
    <div class="seller-modal" role="dialog" aria-modal="true">
      <button type="button" class="seller-modal-close" onclick="closeSellerModal()" aria-label="بستن پنجره">×</button>

      <div class="seller-modal-title">
        مشخصات فروشگاه:
        <span style="color:#0ea5e9">${storeName}</span>
      </div>

      <div class="seller-modal-row">
        <span class="seller-modal-label">ثبت‌نام:</span>
        <span class="seller-modal-value">${fDate(shop.createdAt)}</span>
      </div>

      <div class="seller-modal-row">
        <span class="seller-modal-label">شماره موبایل:</span>
        <span class="seller-modal-value">${phone}</span>
      </div>

      <div class="seller-modal-row">
        <span class="seller-modal-label">نوع اشتراک:</span>
        <span class="seller-modal-value">${shop.subscriptionType || '-'}</span>
      </div>

      <div class="seller-modal-row">
        <span class="seller-modal-label">تاریخ خرید:</span>
        <span class="seller-modal-value">${fDate(shop.subscriptionStart)}</span>
      </div>

      <div class="seller-modal-row">
        <span class="seller-modal-label">تاریخ پایان:</span>
        <span class="seller-modal-value">${fDate(shop.subscriptionEnd)}</span>
      </div>

      <!-- ردیف پسورد حذف شد -->

      <div class="seller-score-block" data-score-key="${sellerScoreKey || ''}">
        <span class="seller-modal-label">نمره ارزیابی ادمین</span>
        <div class="seller-score-range">
          <input type="range" id="sellerScoreInput" min="0" max="100" step="1" value="${initialAdminScore}" aria-label="امتیاز عملکرد فروشنده">
          <div class="seller-score-value" id="sellerScoreValue">${initialAdminScore}</div>
        </div>
        <div class="seller-score-actions">
          <button type="button" class="score-save-btn" id="saveSellerScoreBtn">ثبت نمره</button>
          <button type="button" class="score-clear-btn" id="clearSellerScoreBtn" ${hasExistingScore ? '' : 'disabled'}>حذف نمره</button>
        </div>
        <p class="seller-score-hint">نمره ۰ تا ۱۰۰ کیفیت همکاری فروشنده را از نگاه تیم ادمین نشان می‌دهد. پس از انتخاب مقدار، دکمه «ثبت نمره» را بزن.</p>
        <div class="seller-score-note">
          <label for="sellerScoreNote">یادداشت داخلی ادمین</label>
          <textarea id="sellerScoreNote" placeholder="نکات ارزیابی را وارد کنید…">${noteValueForInput}</textarea>
          <p class="seller-score-note-hint">این یادداشت فقط برای تیم ادمین نمایش داده می‌شود و به فروشنده ارسال نخواهد شد.</p>
        </div>
        <div class="seller-score-message">
          <label for="sellerScoreMessage">پیام قابل نمایش برای فروشنده</label>
          <textarea id="sellerScoreMessage" placeholder="این پیام همراه با نمره برای فروشنده ارسال می‌شود…">${messageValueForInput}</textarea>
          <p class="seller-score-message-hint">فروشنده متن این پیام را در بخش وضعیت عملکرد پنل خود مشاهده می‌کند.</p>
        </div>
        <div class="seller-score-alert" id="sellerScoreAlert" style="display:none;"></div>
        <div class="seller-score-status" id="sellerScoreStatus">
          <div class="seller-score-status-header">
            <span class="seller-status-pill status-${statusSeverity}" id="sellerStatusBadge">${statusLabel}</span>
            <span class="seller-status-updated" id="sellerStatusUpdated">${statusUpdatedText}</span>
          </div>
          <p class="seller-status-text" id="sellerStatusText">${statusMessage}</p>
          <p class="seller-status-note ${performanceMeta ? (performanceMeta.canStay ? 'status-eligible' : 'status-ineligible') : 'status-neutral'}" id="sellerStatusNote">${eligibilityNote}</p>
          <div class="seller-score-message-display" id="sellerMessageDisplay">
            <span class="seller-score-message-title">آخرین پیام برای فروشنده</span>
            <p class="seller-message-text" id="sellerMessageText">${messageDisplayHtml}</p>
          </div>
          <div class="seller-score-note-display" id="sellerNoteDisplay">
            <span class="seller-score-note-title">آخرین یادداشت ثبت‌شده</span>
            <p class="seller-note-text" id="sellerNoteText">${noteDisplayHtml}</p>
          </div>
        </div>
      </div>

      <form id="sellerMessageForm"
            class="seller-modal-form"
            data-seller-id="${sellerId}"
            data-shopurl="${url}">
        <label for="sellerMessage">ارسال پیام به این فروشنده:</label>
        <textarea id="sellerMessage" name="msg"
                  placeholder="پیام خود را بنویسید…" required></textarea>
        <button type="submit">ارسال پیام</button>
        <div id="seller-modal-success"
             class="seller-modal-success"
             style="display:none"></div>
      </form>
    </div>`;

  overlay.style.display = 'flex';

  if (sellerModalOverlayClickHandler) {
    overlay.removeEventListener('click', sellerModalOverlayClickHandler);
  }
  sellerModalOverlayClickHandler = (event) => {
    if (event.target === overlay) {
      closeSellerModal();
    }
  };
  overlay.addEventListener('click', sellerModalOverlayClickHandler);

  if (sellerModalKeydownHandler) {
    document.removeEventListener('keydown', sellerModalKeydownHandler);
  }
  sellerModalKeydownHandler = (event) => {
    if (event.key === 'Escape') {
      closeSellerModal();
    }
  };
  document.addEventListener('keydown', sellerModalKeydownHandler);

  const scoreInputEl = document.getElementById('sellerScoreInput');
  const scoreValueEl = document.getElementById('sellerScoreValue');
  const scoreSaveBtn = document.getElementById('saveSellerScoreBtn');
  const scoreClearBtn = document.getElementById('clearSellerScoreBtn');
  const scoreAlertEl = document.getElementById('sellerScoreAlert');
  const sellerScoreNoteEl = document.getElementById('sellerScoreNote');
  const sellerScoreMessageEl = document.getElementById('sellerScoreMessage');
  const statusElements = {
    badge: document.getElementById('sellerStatusBadge'),
    text: document.getElementById('sellerStatusText'),
    note: document.getElementById('sellerStatusNote'),
    updated: document.getElementById('sellerStatusUpdated'),
    noteText: document.getElementById('sellerNoteText'),
    noteContainer: document.getElementById('sellerNoteDisplay'),
    messageText: document.getElementById('sellerMessageText'),
    messageContainer: document.getElementById('sellerMessageDisplay')
  };

  if (scoreInputEl && scoreValueEl) {
    scoreInputEl.value = String(initialAdminScore);
    scoreValueEl.textContent = String(initialAdminScore);
  }

  const resolveNoteValue = (info) => {
    if (!info) return '';
    if (typeof info.note === 'string') return info.note;
    if (typeof info.adminScoreNote === 'string') return info.adminScoreNote;
    return '';
  };

  const resolveMessageValue = (info) => {
    if (!info) return '';
    if (typeof info.adminScoreMessage === 'string') return info.adminScoreMessage;
    if (typeof info.publicMessage === 'string') return info.publicMessage;
    return '';
  };

  const updateNoteUI = (value) => {
    const noteValue = typeof value === 'string' ? value : '';
    if (sellerScoreNoteEl) sellerScoreNoteEl.value = noteValue;
    if (statusElements.noteText) {
      statusElements.noteText.innerHTML = noteValue
        ? formatNoteForDisplay(noteValue)
        : escapeHtml(defaultNoteMessage);
    }
    if (statusElements.noteContainer) {
      statusElements.noteContainer.style.display = 'flex';
    }
  };

  const updateMessageUI = (value) => {
    const messageValue = typeof value === 'string' ? value : '';
    if (sellerScoreMessageEl) sellerScoreMessageEl.value = messageValue;
    if (statusElements.messageText) {
      statusElements.messageText.innerHTML = messageValue
        ? formatNoteForDisplay(messageValue)
        : escapeHtml(defaultMessageText);
    }
    if (statusElements.messageContainer) {
      statusElements.messageContainer.style.display = 'flex';
      if (messageValue) {
        statusElements.messageContainer.classList.remove('is-empty');
      } else {
        statusElements.messageContainer.classList.add('is-empty');
      }
    }
  };

  updateNoteUI(existingAdminNote);
  updateMessageUI(existingAdminMessage);

  const applyStatusMeta = (meta) => {
    const info = meta || null;
    const severity = info ? info.severity || 'neutral' : 'neutral';
    if (statusElements.badge) {
      statusElements.badge.textContent = info ? info.statusLabel : 'در انتظار ارزیابی';
      statusElements.badge.className = `seller-status-pill status-${severity}`;
    }
    if (statusElements.text) {
      statusElements.text.textContent = info && info.statusMessage
        ? info.statusMessage
        : 'پس از ثبت نمره، وضعیت عملکرد نمایش داده می‌شود.';
    }
    if (statusElements.note) {
      const canStay = info ? !!info.canStay : null;
      statusElements.note.textContent = info
        ? (canStay ? '✅ این فروشنده مجاز به ادامه همکاری است.' : '⛔ با این نمره فروشنده قادر به ماندن در ویترینت نیست.')
        : 'برای تعیین وضعیت همکاری، ابتدا نمره را ثبت کنید.';
      statusElements.note.className = `seller-status-note ${info ? (canStay ? 'status-eligible' : 'status-ineligible') : 'status-neutral'}`;
    }
    if (statusElements.updated) {
      statusElements.updated.textContent = info && info.updatedAt
        ? `آخرین بروزرسانی: ${formatDateTime(info.updatedAt)}`
        : 'هنوز نمره‌ای ثبت نشده است.';
    }
    updateNoteUI(resolveNoteValue(info));
    updateMessageUI(resolveMessageValue(info));
  };

  applyStatusMeta(performanceMeta);

  const showScoreAlert = (message, type = 'success') => {
    if (!scoreAlertEl) return;
    scoreAlertEl.textContent = message;
    scoreAlertEl.classList.remove('is-success', 'is-error');
    scoreAlertEl.classList.add(type === 'error' ? 'is-error' : 'is-success');
    scoreAlertEl.style.display = 'block';
    setTimeout(() => {
      if (scoreAlertEl) scoreAlertEl.style.display = 'none';
    }, 2800);
  };

  if (scoreInputEl) {
    scoreInputEl.addEventListener('input', () => {
      if (scoreValueEl) scoreValueEl.textContent = scoreInputEl.value;
    });
  }

  if (scoreSaveBtn) {
    scoreSaveBtn.addEventListener('click', async () => {
      if (!sellerScoreKey) {
        showScoreAlert('شناسه فروشنده برای ثبت نمره یافت نشد.', 'error');
        return;
      }
      const sourceValue = scoreInputEl ? scoreInputEl.value : initialAdminScore;
      const noteValue = sellerScoreNoteEl ? sellerScoreNoteEl.value : '';
      const messageValue = sellerScoreMessageEl ? sellerScoreMessageEl.value : '';
      if (!messageValue.trim()) {
        showScoreAlert('لطفاً دلیل نمره را برای فروشنده بنویسید.', 'error');
        return;
      }
      scoreSaveBtn.disabled = true;
      scoreSaveBtn.classList.add('is-loading');
      try {
        const meta = await setSellerScoreByKey(sellerScoreKey, sourceValue, noteValue, messageValue);
        performanceMeta = meta || performanceMeta;
        const finalScore = meta && meta.adminScore != null
          ? meta.adminScore
          : Math.max(0, Math.min(100, Math.round(Number(sourceValue) || 0)));
        if (scoreValueEl) scoreValueEl.textContent = String(finalScore);
        if (scoreInputEl) scoreInputEl.value = String(finalScore);
        hasExistingScore = finalScore != null;
        if (scoreClearBtn) scoreClearBtn.disabled = !hasExistingScore;
        if (meta) {
          applyStatusMeta(meta);
        } else {
          updateNoteUI(noteValue);
          updateMessageUI(messageValue);
        }
        renderSellers();
        showScoreAlert((meta && meta.message) || 'نمره ثبت شد.');
      } catch (err) {
        console.error('saveSellerScore error:', err);
        showScoreAlert(err.message || 'خطا در ثبت نمره.', 'error');
      } finally {
        scoreSaveBtn.disabled = false;
        scoreSaveBtn.classList.remove('is-loading');
      }
    });
  }

  if (scoreClearBtn) {
    scoreClearBtn.addEventListener('click', async () => {
      if (!sellerScoreKey) {
        showScoreAlert('شناسه فروشنده یافت نشد.', 'error');
        return;
      }
      scoreClearBtn.disabled = true;
      scoreClearBtn.classList.add('is-loading');
      try {
        const meta = await clearSellerScoreByKey(sellerScoreKey);
        performanceMeta = meta || null;
        if (scoreInputEl) scoreInputEl.value = String(defaultAdminScore);
        if (scoreValueEl) scoreValueEl.textContent = String(defaultAdminScore);
        hasExistingScore = false;
        if (meta) {
          applyStatusMeta(meta);
        } else {
          updateNoteUI('');
          updateMessageUI('');
        }
        renderSellers();
        showScoreAlert((meta && meta.message) || 'نمره حذف شد.');
      } catch (err) {
        console.error('clearSellerScore error:', err);
        showScoreAlert(err.message || 'خطا در حذف نمره.', 'error');
        scoreClearBtn.disabled = false;
      } finally {
        scoreClearBtn.classList.remove('is-loading');
      }
    });
  }

  /* ارسال پیام */
  document
    .getElementById('sellerMessageForm')
    .addEventListener('submit', sendSellerMessage);

  // تابع fetchSellerPassword دیگر نیازی نیست و حذف می‌شود
}









function closeSellerModal() {
  const overlay = document.getElementById('seller-modal-overlay');
  if (!overlay) return;
  overlay.style.display = "none";
  overlay.innerHTML = "";
  if (sellerModalOverlayClickHandler) {
    overlay.removeEventListener('click', sellerModalOverlayClickHandler);
    sellerModalOverlayClickHandler = null;
  }
  if (sellerModalKeydownHandler) {
    document.removeEventListener('keydown', sellerModalKeydownHandler);
    sellerModalKeydownHandler = null;
  }
}

// ← این تابع را جایگزین کنید
async function sendSellerMessage(e) {
  e.preventDefault();
  const form  = e.currentTarget;
  let   rawId = form.dataset.sellerId;  // "shopurl:slug" یا ObjectId
  const text  = form.querySelector('textarea').value.trim();

  if (!text) {
    return alert('متن پیام نمی‌تواند خالی باشد.');
  }
  if (!rawId) {
    return alert('شناسه فروشنده پیدا نشد!');
  }

  // آماده‌سازی payload
  const body = { text, from: 'admin' };
  if (rawId.startsWith('shopurl:')) {
    body.shopurl = rawId.replace(/^shopurl:/, '');
  } else {
    body.sellerId = rawId;
  }

  try {
    const res = await fetch(`${ADMIN_API_BASE}/chats`, {
      method: 'POST',
      headers: {
        'Content-Type':  'application/json'
        // هدر Authorization لازم نیست چون با کوکی کار می‌کنی
      },
      credentials: 'include',
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.error || data.message || 'خطا در ارسال پیام');
    }

    // موفقیت
    form.querySelector('textarea').value = '';
    const okBox = document.getElementById('seller-modal-success');
    okBox.textContent = '✅ پیام با موفقیت ارسال شد!';
    okBox.style.display = 'block';
    setTimeout(() => okBox.style.display = 'none', 2500);

  } catch (err) {
    console.error('sendSellerMessage error:', err, body);
    alert('❌ خطا در ارسال پیام:\n' + err.message);
  }
}











/**
 * اگر chat.seller پر نشده باشد، با شناسه یا shopurl در shopsList جست‌وجو کن
 */
// 1) تابع کمکی برای یافتن شیء فروشنده
/** پیدا کردن شیء فروشنده با sellerId یا shopurl */
// تابع کمکی برای یافتن شیء فروشنده
// پیدا کردن شیء فروشنده با sellerId یا shopurl
// تابع اصلاح شده برای یافتن فروشگاه
function findShopBySellerId(sellerId, shopUrl) {
  const sid = toIdString(sellerId);
  const url = toIdString(shopUrl);
  
  // جستجوی اولیه با استفاده از شناسه فروشنده
  const bySellerId = shopsList.find(shop => {
    const shopIds = [
      toIdString(shop._id),
      toIdString(shop.id),
      toIdString(shop.sellerId),
      toIdString(shop.seller_id),
      shop._sid ? toIdString(shop._sid) : null
    ].filter(Boolean);
    
    return shopIds.includes(sid);
  });
  
  if (bySellerId) return bySellerId;
  
  // جستجوی ثانویه با استفاده از آدرس فروشگاه
  const byShopUrl = shopsList.find(shop => 
    toIdString(shop.shopurl) === url
  );
  
  return byShopUrl || null;
}
// تابع اصلاح شده برای نمایش مدال فرستنده
// تابع اصلاح شده برای دریافت اطلاعات فروشنده
async function getSellerDetails(sellerId) {
  try {
    const res = await fetch(`${ADMIN_API_BASE}/sellers/${encodeURIComponent(sellerId)}`, {
      credentials: 'include'
    });
    
    if (!res.ok) {
      throw new Error('فروشنده یافت نشد');
    }
    
    return await res.json();
  } catch (err) {
    console.error('خطا در دریافت اطلاعات فروشنده:', err);
    return null;
  }
}

// تابع اصلاح شده برای نمایش مدال
async function openSenderModal(chat) {
  const ov = document.getElementById('sender-modal-overlay');
  if (!ov) return;

  ov.innerHTML = `
    <div class="sender-modal">
      <button class="sender-modal-close" onclick="closeSenderModal()">×</button>
      <h4>دریافت اطلاعات فروشنده...</h4>
    </div>
  `;
  ov.style.display = 'flex';

  try {
    // استفاده از شناسه فروشنده از چت
    const sellerId = chat.sellerId || '';
    
    // دریافت اطلاعات فروشنده از بک‌اند
    const seller = await getSellerDetails(sellerId);
    
    if (!seller) {
      ov.innerHTML = `
        <div class="sender-modal">
          <button class="sender-modal-close" onclick="closeSenderModal()">×</button>
          <h4>خطا در دریافت اطلاعات</h4>
          <p>فروشنده با شناسه ${sellerId} یافت نشد</p>
        </div>
      `;
      return;
    }

    // نمایش اطلاعات فروشنده
    ov.innerHTML = `
      <div class="sender-modal">
        <button class="sender-modal-close" onclick="closeSenderModal()">×</button>
        <h4>مشخصات فروشنده</h4>
        
        <div class="sender-info-row">
          <span class="sender-info-label">نام فروشگاه:</span>
          <span class="sender-info-value">${seller.storename || '-'}</span>
        </div>
        
        <div class="sender-info-row">
          <span class="sender-info-label">نام صاحب فروشگاه:</span>
          <span class="sender-info-value">${seller.firstname || ''} ${seller.lastname || ''}</span>
        </div>
        
        <div class="sender-info-row">
          <span class="sender-info-label">آدرس فروشگاه:</span>
          <span class="sender-info-value">${seller.address || '-'}</span>
        </div>
        
        <div class="sender-info-row">
          <span class="sender-info-label">شماره تماس:</span>
          <span class="sender-info-value">${seller.phone || '-'}</span>
        </div>
        
        <div class="sender-info-row">
          <span class="sender-info-label">آدرس اینترنتی:</span>
          <span class="sender-info-value">${seller.shopurl || '-'}</span>
        </div>
        
        <div class="sender-info-row">
          <span class="sender-info-label">دسته‌بندی:</span>
          <span class="sender-info-value">${seller.category || '-'}</span>
        </div>
      </div>
    `;
  } catch (err) {
    ov.innerHTML = `
      <div class="sender-modal">
        <button class="sender-modal-close" onclick="closeSenderModal()">×</button>
        <h4>خطا در دریافت اطلاعات</h4>
        <p>${err.message || 'خطای نامشخص'}</p>
      </div>
    `;
  }
}
/* بستن مدال */
function closeSenderModal() {
  const ov = document.getElementById('sender-modal-overlay');
  ov.style.display = 'none';
  ov.innerHTML = '';
}




// تابع کمکی برای استانداردسازی ID




// ————————————————————————————






// ثبت پنل مدیریت پلن‌ها به panels
// ثبت پنل مدیریت پلن‌ها به panels
// ثبت پنل مدیریت پلن‌ها به panels
panels['plans'] = document.getElementById('plans-panel');

panels['ads'] = document.getElementById('ads-panel');
panels['messages'] = document.getElementById('messages-panel');
panels['home-section'] = document.getElementById('home-section-panel');


/* المان‌های ورودی */
const planInputs = {
  "1month":  document.getElementById('plan-1month'),
  "3month":  document.getElementById('plan-3month'),
  "12month": document.getElementById('plan-12month'),
  "vitriPlus": document.getElementById('vitriPlusPrice')
};
const plansMsg  = document.getElementById('plansMsg');





// تابع debounce برای جلوگیری از درخواست‌های مکرر موقع تایپ (۵۰۰ میلی‌ثانیه)
function debounce(fn, delay = 500) {
  let timeout;
  return (...args) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => fn(...args), delay);
  };
}


// تابع normalize phone (مشترک برای فرانت)
function normalizePhone(p) {
  if (!p) return null;
  p = p.replace(/\D/g, '');  // حذف غیرعددی
  if (p.length === 10 && p.startsWith('9')) p = '0' + p;
  return (p.length === 11 && p.startsWith('09')) ? p : null;
}


/* ---------- 1) خواندن قیمت‌ها از سرور ---------- */
async function loadPlanPrices() {
  try {
    let phone = document.getElementById('seller-phone-plans').value.trim();
    phone = normalizePhone(phone);
    let url = `${ADMIN_API_BASE}/plans`;
    if (phone) {
      url += `?sellerPhone=${encodeURIComponent(phone)}`;
    }

    const res = await fetch(url, { credentials: 'include' });
    if (!res.ok) throw new Error(await res.text());

    const { plans } = await res.json();  // { "1month": ..., "3month": ..., ... }

    // پر کردن فیلدها
    planInputs['1month'].value  = plans['1month']  ?? '';
    planInputs['3month'].value  = plans['3month']  ?? '';
    planInputs['12month'].value = plans['12month'] ?? '';
    planInputs['vitriPlus'].value = plans['vitriPlus'] ?? '';

    // اگر همه خالی (یعنی override نداره)، پیام بدید
    if (phone && !Object.values(plans).some(p => p !== null)) {
      showPlansMsg('قیمت اختصاصی برای این فروشنده تعریف نشده؛ از قیمت عمومی استفاده می‌شود.', true, phone);
    }
  } catch (err) {
    console.error('خطا در دریافت قیمت پلن‌ها:', err);
    showPlansMsg('❌ خطا در دریافت قیمت‌ها!', false);
  }
}

/* ---------- 2) ذخیره قیمت‌ها روی سرور ---------- */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return '';
}

async function savePlanPrices(e) {
  e.preventDefault();

  // آماده‌سازی payload
  const prices = {
    '1month':  Number(planInputs['1month'].value),
    '3month':  Number(planInputs['3month'].value),
    '12month': Number(planInputs['12month'].value),
    'vitriPlus': Number(planInputs['vitriPlus'].value)
  };

  const validPrices = {};
  Object.keys(prices).forEach(k => {
    const val = prices[k];
    if (!Number.isNaN(val) && val > 0) validPrices[k] = val;
  });

  if (!Object.keys(validPrices).length) {
    showPlansMsg('هیچ قیمت معتبری ارسال نشد', false);
    return;
  }

  const body = { prices: validPrices };


  const rawPhone = document.getElementById('seller-phone-plans').value.trim();
  const phone    = normalizePhone(rawPhone);
  if (rawPhone && !phone) {
    showPlansMsg('شماره موبایل نامعتبر است.', false);
    return;
  }

  if (phone && !(await sellerExists(phone))) {
    showPlansMsg('فروشنده‌ای با این شماره وجود ندارد.', false);
    return;
  }

  if (phone) body.sellerPhone = phone;

  try {
    const token = getCookie('admin_token') || getCookie('access_token');

    const res = await fetch(`${ADMIN_API_BASE}/plans/admin`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': 'Bearer ' + token })
      },
      credentials: 'include',
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (!res.ok || data.success === false) {
      throw new Error(data.message || await res.text());
    }

    await loadPlanPrices();
    showPlansMsg('✅ ' + (data.message || 'قیمت‌ها با موفقیت ذخیره شدند.'), true, phone);
  } catch (err) {
    console.error('خطا در ذخیره قیمت‌ها:', err);
    showPlansMsg('❌ ' + err.message, false, phone);
  }
}


/* ---------- 3) نمایش پیام موفقیت / خطا ---------- */
function showPlansMsg(txt, ok, phone = '') {
  const plansMsg = document.getElementById('plansMsg');
  plansMsg.textContent      = txt + (phone ? ` (اختصاصی برای ${phone})` : ' (عمومی)');
  plansMsg.style.display    = 'block';
  plansMsg.style.background = ok ? '#e0fdfa' : '#fee2e2';
  plansMsg.style.color      = ok ? '#10b981' : '#b91c1c';
  setTimeout(() => plansMsg.style.display = 'none', 3000);
}

/* ---------- 4) اتصال رویدادها ---------- */
if (document.getElementById('plansForm')) {
  loadPlanPrices();                                   // بارگذاری اولیه
  document.getElementById('plansForm')
          .addEventListener('submit', savePlanPrices); // ذخیره روی بک‌اند
  
  // listener روی input شماره تلفن برای reload موقع تغییر
  document.getElementById('seller-phone-plans')
          .addEventListener('input', debounce(loadPlanPrices));
}







const adInputs = {
  'ad_search'   : document.getElementById('ad_search'),
  'ad_home'     : document.getElementById('ad_home'),
  'ad_products' : document.getElementById('ad_products')
};
const adsMsg = document.getElementById('adsMsg');

// ---------- 2) خواندن قیمت‌ تبلیغات ----------
async function loadAdsPrices() {
  try {
    let phone = document.getElementById('seller-phone-ads').value.trim();
    phone = normalizePhone(phone);
    let url = `${ADMIN_API_BASE}/adplans`;
    if (phone) {
      url += `?sellerPhone=${encodeURIComponent(phone)}`;
    }
    const res  = await fetch(url, { credentials: 'include' });
    const json = await res.json();              // { adplans: { search:12000, … } }
    const prices = json.adplans || {};
    Object.keys(adInputs).forEach(k => {
      adInputs[k].value = prices[k] ?? '';
    });

    // اگر همه خالی (یعنی override نداره)، پیام بدید
    if (phone && !Object.values(prices).some(p => p !== null)) {
      showAdsMsg('قیمت اختصاصی برای این فروشنده تعریف نشده؛ از قیمت عمومی استفاده می‌شود.', true, phone);
    }
  } catch (err) {
    console.error('❌ خطا در دریافت قیمت تبلیغات', err);
    showAdsMsg('خطا در دریافت قیمت تبلیغات!', false);
  }
}

// ---------- 3) ذخیره قیمت تبلیغات ----------
async function saveAdsPrices(e) {
  e.preventDefault();
  // ۱) payload
  const prices = {};
  Object.keys(adInputs).forEach(k => {
    const val = Number(adInputs[k].value);
    if (!Number.isNaN(val) && val > 0) prices[k] = val;
  });

  if (!Object.keys(prices).length) {
    showAdsMsg('هیچ قیمت معتبری ارسال نشد', false);
    return;
  }

  const body = { prices };


  const rawPhone   = document.getElementById('seller-phone-ads').value.trim();
  let sellerPhone  = normalizePhone(rawPhone);
  if (rawPhone && !sellerPhone) {
    showAdsMsg('شماره موبایل نامعتبر است.', false);
    return;
  }

  if (sellerPhone && !(await sellerExists(sellerPhone))) {
    showAdsMsg('فروشنده‌ای با این شماره وجود ندارد.', false);
    return;
  }


  if (sellerPhone) body.sellerPhone = sellerPhone;

  // ۲) توکن
  const token = getCookie('admin_token') || getCookie('access_token');

  try {
    // ۳) PUT
    const res = await fetch(`${ADMIN_API_BASE}/adplans/admin`, {
      method: 'PUT',
      headers: {
        'Content-Type':  'application/json',
        'Authorization': token ? 'Bearer ' + token : ''
      },
      credentials: 'include',
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!res.ok || data.success === false) {
      throw new Error(data.message || await res.text());
    }

    // بعد از ذخیره موفق، قیمت‌ها رو reload کن
    await loadAdsPrices();
    showAdsMsg('✅ ' + (data.message || 'قیمت تبلیغات با موفقیت ذخیره شد.'), true, sellerPhone);
  } catch (err) {
    console.error('❌ خطا در ذخیره قیمت تبلیغات', err);
    showAdsMsg('❌ ' + err.message, false, sellerPhone);
  }
}

// ---------- 4) نمایش پیام ----------
function showAdsMsg (txt, ok, phone = '') {
  adsMsg.textContent      = txt + (phone ? ` (اختصاصی برای ${phone})` : ' (عمومی)');
  adsMsg.style.display    = 'block';
  adsMsg.style.background = ok ? '#e0fdfa' : '#fee2e2';
  adsMsg.style.color      = ok ? '#10b981' : '#b91c1c';
  setTimeout(() => adsMsg.style.display = 'none', 3000);
}

/* ---------- 5) اتصال رویدادها ---------- */
if (document.getElementById('adsForm')) {
  loadAdsPrices();                                   // بارگذاری اولیه
  document.getElementById('adsForm')
          .addEventListener('submit', saveAdsPrices);// ذخیره روی بک‌اند
  
  // listener روی input شماره تلفن برای reload موقع تغییر
  document.getElementById('seller-phone-ads')
          .addEventListener('input', debounce(loadAdsPrices));
}







// ─── بالای بخش "نمایش کارت‌ها و جداول" ───
// ─── بالای بخش "نمایش کارت‌ها و جداول" ───
// ─── در ابتدای <script> (جایی که پیام‌ها خالی تعریف شده‌اند) ───
// ─── مدیریت پیام‌ها در پنل ادمین ───

// ───────────────────────────────────────


// ایجاد مدال HTML
const modalWrapper = document.createElement('div');
modalWrapper.id = 'chatModal';
modalWrapper.innerHTML = `
  <div class="modal-overlay" onclick="closeModal()"></div>
  <div class="modal-content">
    <h3>گفتگو</h3>
    <div id="chatMessages" class="chat-messages"></div>
    
    <div class="chat-input-area">
      <textarea id="chatReplyInput" rows="2" placeholder="پیام خود را بنویسید..."></textarea>
      <button onclick="sendAdminMessage()">ارسال</button>
      <!-- ↓ دکمهٔ مسدودسازی ↓ -->
      <button class="action-btn block" onclick="blockCurrentSender()">مسدودسازی فرستنده</button>
      <button class="action-btn unblock" id="unblockBtn" onclick="unblockCurrentSender()" style="display:none">آزاد کردن</button>
      <span id="blockedBadge" class="blocked-badge" style="display:none">مسدود شده</span>
    </div>

    <button class="modal-close" onclick="closeModal()">بستن</button>
  </div>
`;

document.body.appendChild(modalWrapper);

// متغیر کمکی
let currentChatId = null;

// باز کردن مدال
window.openChatModal = async function (chatId) {
  currentChatId = chatId;
  const chat = messagesList.find(c => c._id === chatId);
  const container = document.getElementById('chatMessages');
  container.innerHTML = '';
  document.getElementById('chatReplyInput').disabled = false;
  document.getElementById('blockedBadge').style.display = 'none';
  document.getElementById('unblockBtn').style.display = 'none';
  const blockBtn = document.querySelector('#chatModal .action-btn.block');
  if (blockBtn) blockBtn.style.display = 'inline-block';

  if (chat && chat.blockedByAdmin) {
    document.getElementById('chatReplyInput').disabled = true;
    document.getElementById('blockedBadge').style.display = 'inline-block';
    document.getElementById('unblockBtn').style.display = 'inline-block';
    if (blockBtn) blockBtn.style.display = 'none';
  }

  // 🟢 اگر پیام فروشنده یا کاربری نخونده وجود داره، به سرور اطلاع بده که خوانده شدند
  if (chat) {
    const unreadMsgIds = (chat.messages || [])
      .filter(m => (m.from === 'seller' || m.from === 'user') && !m.read)
      .map(m => m._id)
      .filter(Boolean);

    if (unreadMsgIds.length > 0) {
      try {
        const token = getCookie('admin_token') || getCookie('access_token');
        await fetch(`${ADMIN_API_BASE}/chats/${chatId}/mark-read`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token && { Authorization: 'Bearer ' + token })
          },
          credentials: 'include',
          body: JSON.stringify({ messageIds: unreadMsgIds })
        });
        // توی لیست محلی هم برو پیام‌ها رو خوانده‌شده کن
        chat.messages.forEach(m => {
          if (unreadMsgIds.includes(m._id)) m.readByAdmin = true;
          if (unreadMsgIds.includes(m._id)) m.read = true;
        });
        updateSidebarCounts(); // شمارنده پیام آپدیت شه
        renderMessages();      // جدول پیام‌ها رفرش شه
      } catch (e) {
        console.warn('خطا در خواندن پیام‌ها:', e);
      }
    }
  }

  if (!chat || !chat.messages?.length) {
    container.innerHTML = '<p style="text-align:center;color:#888">پیامی وجود ندارد.</p>';
  } else {
    chat.messages.forEach(msg => {
     const sender = getSenderName(chat, msg);


      const date = new Date(msg.createdAt || msg.date).toLocaleString('fa-IR', {
        hour12: false,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });

      const div = document.createElement('div');
      div.className = 'chat-bubble ' + msg.from;
      div.innerHTML = `
        <div class="sender">${sender}</div>
        <div class="text">${msg.text || '-'}</div>
        <div class="time">${date}</div>`;
      container.appendChild(div);
    });
  }

  document.getElementById('chatModal').classList.add('show');
  document.getElementById('chatReplyInput').focus();

  setTimeout(() => {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
  }, 100);
};


// بستن مدال
window.closeModal = function () {
  document.getElementById('chatModal').classList.remove('show');
  document.getElementById('chatReplyInput').value = '';
  currentChatId = null;
};

// ارسال پیام از طرف ادمین
// ارسال پیام از طرف ادمین در مودال گفتگو
// ─── در بخش <script> پنل ادمین ───
// ارسال پیام از طرف ادمین در مودال گفتگو
// در فایل JS فرانت-ند (مثلاً public/js/main.js یا داخل تگ <script> در HTML)
// ارسال پیام از طرف ادمین در مودال گفتگو
window.sendAdminMessage = async function () {
  const text = document.getElementById('chatReplyInput').value.trim();
  if (!text)          return alert('متن پیام را وارد کنید.');
  if (!currentChatId) return alert('چت انتخاب نشده است.');

  try {
    const res = await fetch(`${ADMIN_API_BASE}/chats/${currentChatId}/admin-reply`, {
      method: 'POST',
      credentials: 'include', // ارسال کوکی‌های HttpOnly مثل admin_token
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ text })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'خطا در ارسال پیام.');

    // بروزرسانی رابط کاربری بعد از ارسال موفق
    const idx = messagesList.findIndex(c => c._id === currentChatId);
    if (idx !== -1) messagesList[idx] = data;

    openChatModal(currentChatId); // مودال را رفرش کن
    document.getElementById('chatReplyInput').value = '';
    updateSidebarCounts();

  } catch (err) {
    console.error('❌ sendAdminMessage error:', err);
    alert('❌ ' + err.message);
  }
};








// بستن مدال با کلید ESC
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeModal();
    closeSellerModal();
    closeAdOrderModal();
  }
});



document.addEventListener('DOMContentLoaded', () => {
  const header = document.getElementById('broadcastHeader');
  const card   = document.getElementById('broadcastCard');

  header.addEventListener('click', () => {
    card.classList.toggle('collapsed');
  });
});





/**
 * مسدودسازی فرستندهٔ آخرین پیام در چت جاری
 */
async function blockCurrentSender() {
  if (!currentChatId) return alert('شناسهٔ چت پیدا نشد.');
  const chat = messagesList.find(c => c._id === currentChatId) || {};
  const targetRole = chat.sellerId ? 'seller' : 'user';
  const targetId   = chat.sellerId || chat.customerId || chat.userId;
  const label      = targetRole === 'seller' ? 'فروشنده' : 'مشتری';

  if (!targetId) return alert('شناسه کاربر پیدا نشد.');
  if (!confirm(`آیا مطمئن هستید که می‌خواهید این ${label} را مسدود کنید؟`)) return;

  try {
    console.log('blockCurrentSender ->', { targetId, targetRole });
    const res = await fetch(`${ADMIN_API_BASE}/chats/block-target`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({ targetId, targetRole })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'خطا در مسدودسازی');

    alert('✅ ' + (data.message || 'کاربر با موفقیت مسدود شد.'));
    document.getElementById('chatReplyInput').disabled = true;
    document.getElementById('blockedBadge').style.display = 'inline-block';
    await fetchMessages();
  } catch (err) {
    console.error('❌ blockCurrentSender error:', err);
    alert('❌ ' + err.message);
  }
}

async function unblockCurrentSender() {
  if (!currentChatId) return alert('شناسهٔ چت پیدا نشد.');
  const chat = messagesList.find(c => c._id === currentChatId) || {};
  const targetRole = chat.sellerId ? 'seller' : 'user';
  const targetId   = chat.sellerId || chat.customerId || chat.userId;
  const label      = targetRole === 'seller' ? 'فروشنده' : 'مشتری';

  if (!targetId) return alert('شناسه کاربر پیدا نشد.');
  if (!confirm(`آیا مطمئن هستید که می‌خواهید این ${label} را آزاد کنید؟`)) return;

  try {
    console.log('unblockCurrentSender ->', { targetId, targetRole });
    const res = await fetch(`${ADMIN_API_BASE}/chats/unblock-target`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({ targetId, targetRole })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'خطا در رفع مسدودی');

    alert('✅ ' + (data.message || 'کاربر آزاد شد.'));
    await fetchMessages();
    openChatModal(currentChatId);
  } catch (err) {
    console.error('❌ unblockCurrentSender error:', err);
    alert('❌ ' + err.message);
  }
}



async function sendBroadcastMessage() {
  const target = document.querySelector('#broadcastTarget').value;
  const text   = document.querySelector('#broadcastText').value.trim();
  const status = document.querySelector('#broadcastStatus');

  if (!text) {
    status.style.color = '#f43f5e';
    status.textContent = 'متن پیام نمی‌تواند خالی باشد.';
    return;
  }
  status.style.color = '#888';
  status.textContent = '⏳ در حال ارسال...';

  try {
    const res = await fetch(`${ADMIN_API_BASE}/chats/broadcast`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({ target, text })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'خطا در ارسال پیام همگانی');
    status.style.color = '#10b981';
    status.textContent = `✅ پیام با موفقیت به ${data.sent || 0} نفر ارسال شد.`;
    document.querySelector('#broadcastText').value = '';
  } catch (err) {
    console.error('❌ sendBroadcastMessage error:', err);
    status.style.color = '#f43f5e';
    status.textContent = '❌ ' + err.message;
  }
}




async function fetchUnreadCountAndUpdateBadge() {
  try {
   const res = await fetch(`${ADMIN_API_BASE}/chats/all`, {
  credentials: 'include'
});
    if (!res.ok) throw new Error("خطا در شمارش پیام‌ها");
    const data = await res.json();
    const chats = Array.isArray(data) ? data : (data.chats || []);
    let total = 0;
    chats.forEach(chat => {
      if (Array.isArray(chat.messages)) {
        total += chat.messages.filter(
          m => (m.from === 'seller' || m.from === 'user') && !m.read
        ).length;
      }
    });
    document.getElementById('count-messages').textContent = total > 0 ? total : '';
    document.getElementById('header-messages-count').textContent = total > 0 ? `(${total} پیام جدید)` : '';
  } catch (e) {
    document.getElementById('count-messages').textContent = '';
    document.getElementById('header-messages-count').textContent = '';
  }
}

function startBadgePolling() {
  if (badgeInterval) clearInterval(badgeInterval);
  fetchUnreadCountAndUpdateBadge();
  badgeInterval = setInterval(fetchUnreadCountAndUpdateBadge, 7000); // هر ۷ ثانیه یکبار
}
startBadgePolling();

function loadExternalPanel(panelId, url, {
  loadingMessage = 'در حال بارگیری محتوا...',
  errorMessage = 'خطا در بارگیری محتوا.',
  scriptKey
} = {}) {
  const panel = document.getElementById(panelId);
  if (!panel) return;

  panel.innerHTML = `<p style="text-align:center;color:#888">${loadingMessage}</p>`;

  const xhr = new XMLHttpRequest();
  xhr.open('GET', url, true);

  xhr.onreadystatechange = function() {
    if (xhr.readyState !== 4) return;

    if (xhr.status === 200) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xhr.responseText, 'text/html');

      const headElements = doc.querySelectorAll('head > *');
      headElements.forEach(el => {
        if (el.tagName === 'LINK' || el.tagName === 'STYLE' || el.tagName === 'SCRIPT') {
          const href = el.getAttribute('href');
          const src = el.getAttribute('src');
          const selectors = [];
          if (href) selectors.push(`[href="${href}"]`);
          if (src) selectors.push(`[src="${src}"]`);

          if (!selectors.length) {
            document.head.appendChild(el.cloneNode(true));
          } else if (!document.querySelector(selectors.join(', '))) {
            document.head.appendChild(el.cloneNode(true));
          }
        }
      });

      panel.innerHTML = doc.body.innerHTML;

      if (scriptKey) {
        document.querySelectorAll(`script[data-external-section="${scriptKey}"]`).forEach(s => s.remove());
      }

      const scripts = doc.querySelectorAll('script');
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        if (scriptKey) {
          newScript.dataset.externalSection = scriptKey;
        }
        document.body.appendChild(newScript);
      });
    } else {
      panel.innerHTML = `<p style="text-align:center;color:#ef4444">${errorMessage}</p>`;
    }
  };

  xhr.send();
}

// لود محتوای آمار روزانه با AJAX
function loadDailyVisContent() {
  loadExternalPanel('daily-visits-panel', 'admin-dailyVis.html', {
    loadingMessage: 'در حال بارگیری محتوا...',
    errorMessage: 'خطا در بارگیری محتوا. مسیر فایل رو چک کن یا صفحه رو رفرش کن.',
    scriptKey: 'daily-visits'
  });
}

// لود محتوای کارت‌های صفحه اصلی با AJAX
function loadHomeSectionContent() {
  loadExternalPanel('home-section-panel', 'home-section.html', {
    loadingMessage: 'در حال بارگیری محتوا...',
    errorMessage: 'خطا در بارگیری محتوای کارت‌های صفحه اصلی.',
    scriptKey: 'home-section'
  });
}

// لود محتوای گزارش‌ها با AJAX
// ─── تابع بهبودیافته برای لود محتوای گزارشات ───
// ─── ۱) تابع بارگذاری AJAX گزارش‌ها ───
// ─── 1) تابع AJAX برای لود گزارش‌ها ─────────────────────────
/* ──────────────────────────────────────────────────────────────
   گزارش‌ها (reports.html) – بارگذاری داینامیک با AJAX
   این بلوک را در همان <script> اصلی داشبورد قرار بده و
   نسخه‌های قدیمی loadReportsContent / loadDefaultReportsContent
   را کاملاً حذف کن.                                          
──────────────────────────────────────────────────────────────── */

function loadReportsContent () {
  const panel = panels['reports'];

  /* 1) پیام «در حال بارگیری…» */
  panel.innerHTML =
    '<p style="text-align:center;color:#888">در حال بارگیری گزارش‌ها…</p>';

  const xhr = new XMLHttpRequest();
  /* فایل reports.html در همان پوشهٔ داشبورد است */
  xhr.open('GET', 'reports.html', true);
  xhr.timeout = 5000;                   // ۵ ثانیه مهلت

  xhr.onreadystatechange = () => {
    if (xhr.readyState !== 4) return;

    if (xhr.status === 200) {
      /* 2) Parse و تزریق محتواى فایل */
      const doc = new DOMParser()
        .parseFromString(xhr.responseText, 'text/html');

      /* 3) افزودن CSS / لینک‌ها به <head> (اگر قبلاً نبودند) */
      doc.head.querySelectorAll('link,style').forEach(el => {
        if (el.tagName === 'LINK') {
          if (!document.querySelector(`link[href="${el.href}"]`)) {
            document.head.appendChild(el.cloneNode(true));
          }
        } else {
          document.head.appendChild(el.cloneNode(true));
        }
      });

      /* 4) قرار دادن بدنهٔ فایل در پنل «reports» */
      panel.innerHTML = doc.body.innerHTML;

      /* 5) اجرای تمام <script>‌های reports.html */
      doc.querySelectorAll('script').forEach(old => {
        const s = document.createElement('script');
        if (old.src) s.src = old.src;
        else         s.textContent = old.textContent;
        document.body.appendChild(s);
      });

    } else {
      loadDefaultReportsContent();   // فایل پیدا نشد یا خطای HTTP
    }
  };

  xhr.onerror   = loadDefaultReportsContent;
  xhr.ontimeout = loadDefaultReportsContent;
  xhr.send();
}

/* 2) محتوای پیش‌فرض در صورت عدم دسترسی به reports.html */
function loadDefaultReportsContent () {
  const panel = panels['reports'];
  panel.innerHTML = `
    <div style="text-align:center;padding:2rem;">
      <h2 style="color:#10b981;font-weight:900">گزارشی یافت نشد</h2>
      <p style="color:#666">
        نتوانستم <code>reports.html</code> را بارگیری کنم؛
        لطفاً مسیر یا اتصال را بررسی کنید.
      </p>
    </div>`;
}

/* 3) اتصال تب «گزارشات» به این منطق */
panels['reports'] = document.getElementById('reports-panel');

menuLinks.forEach(link => {
  if (link.dataset.section !== 'reports') return;

  let loaded = false;        // فقط اولین بار AJAX بزن
  link.addEventListener('click', () => {
    if (!loaded) {
      loadReportsContent();
      loaded = true;
    }
  });
});




</script>

<div id="ad-order-modal" class="ad-modal-overlay" style="display:none"></div>

<div id="seller-modal-overlay" class="seller-modal-overlay" style="display:none"></div>



<div id="sender-modal-overlay" class="sender-modal-overlay"></div>

<div id="user-modal-overlay" class="user-modal-overlay" style="display:none"></div>
</body>
</html>