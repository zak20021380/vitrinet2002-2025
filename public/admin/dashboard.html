<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª | ÙˆÛŒØªØ±ÛŒÙ†Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
:root {
  --primary: #10b981;
  --secondary: #0ea5e9;
  --warning: #eab308;
  --bg: #f6faf9;
  --card: #fff;
  --text: #20262d;
  --border: #e5e7eb;
  --shadow: 0 6px 30px #10b98116;
  --sidebar-width: 220px;
  --radius: 20px;
  --transition: .18s cubic-bezier(.45,.8,.4,1);
}

html, body {
  font-family: 'Vazirmatn', Tahoma, sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  height: 100%;
  scroll-behavior: smooth;
  font-size: 16px;
}

body { 
  min-height: 100vh;
  overflow-x: hidden;
}

.dashboard-container { 
  display: flex; 
  min-height: 100vh; 
}

/* Sidebar - Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ */
.sidebar {
  width: var(--sidebar-width);
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow);
  display: flex; 
  flex-direction: column;
  min-height: 100vh; 
  padding: 0;
  z-index: 100; 
  position: relative;
  transition: transform var(--transition), width var(--transition);
  border-left: 1px solid var(--border);
}

.sidebar-header {
  font-weight: bold; 
  font-size: 1.27rem;
  color: var(--primary); 
  padding: 1.7rem 1.3rem 0.9rem 1.3rem;
  border-bottom: 1px solid var(--border);
  letter-spacing: 1px;
}

.sidebar-menu { 
  display: flex; 
  flex-direction: column; 
  gap: 0.3rem; 
  padding: 1.1rem 0; 
  flex: 1; 
}

.sidebar-menu a {
  display: flex; 
  align-items: center; 
  gap: 0.7rem;
  padding: 0.8rem 1.4rem 0.8rem 1rem;
  text-decoration: none; 
  color: var(--text);
  border-radius: 0 var(--radius) var(--radius) 0;
  font-size: 1rem; 
  font-weight: 500; 
  background: none;
  cursor: pointer; 
  transition: background var(--transition), color var(--transition);
  border-right: 4px solid transparent; 
  position: relative;
}

.sidebar-menu a .count {
  background: var(--primary); 
  color: #fff;
  border-radius: 10px; 
  font-size: 0.85rem; 
  padding: 0.2rem 0.6rem;
  margin-right: 0.5rem; 
  font-weight: bold; 
  min-width: 1.8rem;
  text-align: center; 
  display: inline-block; 
  box-shadow: 0 2px 8px #10b98113;
}

.sidebar-menu a.active,
.sidebar-menu a:hover {
  background: var(--primary);
  color: #fff;
  border-right: 4px solid var(--secondary);
}

.sidebar-menu a.active .count,
.sidebar-menu a:hover .count {
  background: #fff; 
  color: var(--primary);
}

.sidebar-menu a i { 
  font-size: 1.25em; 
  opacity: .8; 
  min-width: 1.8rem;
}

.sidebar-footer {
  font-size: 0.85rem; 
  color: #aaa;
  padding: 1rem 0.6rem; 
  border-top: 1px solid var(--border);
  text-align: center; 
  background: inherit;
}

/* Main Content */
.main-content {
  flex: 1; 
  padding: 2rem 1.9rem 1.6rem 0.8rem;
  background: var(--bg);
  display: flex; 
  flex-direction: column;
  min-height: 100vh;
  transition: padding var(--transition);
}

.content-header {
  font-size: 1.25rem; 
  font-weight: bold;
  color: var(--primary); 
  margin-bottom: 1.2rem;
  text-align: right; 
  letter-spacing: .4px;
  display: flex; 
  align-items: center; 
  gap: 0.8rem;
  flex-wrap: wrap;
}

.header-count {
  color: #888; 
  font-size: 1em; 
  font-weight: normal;
  background: #eafaf4; 
  border-radius: 8px; 
  padding: 0.1rem 0.8rem; 
  margin-right: 0.1rem;
}

/* Cards - Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 0.9rem; 
  margin-bottom: 1.6rem;
}

.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 1.2rem;
  min-height: 95px;
  display: flex; 
  align-items: center; 
  gap: 0.8rem;
  font-size: 1rem;
  border: 1px solid var(--border);
  transition: box-shadow var(--transition), border var(--transition), background var(--transition);
  position: relative;
  user-select: none;
  cursor: pointer;
}

.card .icon {
  font-size: 1.4rem;
  color: var(--primary);
  background: #e6fff7;
  border-radius: 12px;
  padding: 0.45rem; 
  margin-left: 0.4rem;
  box-shadow: 0 2px 6px #10b98113;
  display: flex; 
  align-items: center; 
  justify-content: center;
  min-width: 2.5rem; 
  min-height: 2.5rem;
  transition: background var(--transition);
}

.card .num {
  font-size: 1.2rem; 
  font-weight: bold; 
  color: var(--text);
}

.card .label {
  font-size: 0.92rem; 
  color: #888; 
  margin-top: 0.1rem;
}

.card:hover { 
  background: #e6fff7; 
  box-shadow: 0 8px 25px #10b9811a;
}

/* Dashboard charts grid */
.dashboard-charts {
  display: grid; 
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem; 
  margin-bottom: 1.5rem;
}

.dashboard-charts .chart-card {
  background: var(--card); 
  border-radius: var(--radius); 
  box-shadow: var(--shadow);
  padding: 1.2rem 0.6rem 0.5rem 0.6rem; 
  border: 1px solid var(--border);
  min-height: 11rem; 
  direction: ltr;
  user-select: none; 
  cursor: pointer;
  transition: background .12s;
}

.dashboard-charts .chart-card:hover { 
  background: #f6fffa; 
  box-shadow: 0 8px 25px #10b9811a;
}

.chart-title {
  color: var(--primary); 
  font-size: 0.95rem; 
  margin-bottom: 0.5rem;
  direction: rtl; 
  text-align: right; 
  font-weight: bold; 
  letter-spacing: .3px;
  padding: 0 0.5rem;
}

/* Table - Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ */
.table-wrap {
  background: var(--card); 
  border-radius: var(--radius); 
  box-shadow: var(--shadow);
  padding: 0.9rem 0.2rem 0.4rem 0.2rem; 
  margin-bottom: 1.5rem; 
  overflow-x: auto; 
  border: 1px solid var(--border);
}

table {
  border-collapse: collapse; 
  width: 100%; 
  min-width: 350px; 
  background: inherit; 
  color: inherit; 
  font-size: 0.88rem; 
  direction: rtl;
}

th, td { 
  text-align: right; 
  padding: 0.5rem 0.6rem; 
  border-bottom: 1px solid #f3f4f6; 
}

th { 
  background: #f3f4f6; 
  font-weight: bold; 
  color: #444; 
  font-size: 0.92rem;
}

tr:last-child td { 
  border-bottom: none; 
}

.action-btn {
  border: none; 
  outline: none; 
  cursor: pointer; 
  border-radius: 8px;
  padding: 0.3rem 0.8rem; 
  margin-left: 0.2rem; 
  font-size: 0.92rem;
  background: #f4f4f4; 
  color: var(--primary);
  transition: background .14s, color .14s;
  min-height: 2.4rem;
  min-width: 4rem;
}

.action-btn.edit { 
  background: #e0f2fe; 
  color: var(--secondary); 
}

.action-btn.delete { 
  background: #ffe4e6; 
  color: #ef4444; 
}

.action-btn.delete:hover { 
  background: #ef4444; 
  color: #fff; 
}

.action-btn.edit:hover { 
  background: #0ea5e9; 
  color: #fff; 
}

/* Card view for tables on mobile - Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ */
.table-cards {
  display: none;
  flex-direction: column;
  gap: 1rem;
  margin-bottom: 1.6rem;
}

.table-card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 1.3rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.table-card-row {
  display: flex;
  justify-content: space-between;
  padding: 0.6rem 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.95rem;
}

.table-card-row:last-child {
  border-bottom: none;
}

.table-card-label {
  font-weight: bold;
  color: #555;
  min-width: 7rem;
}

.table-card-value {
  text-align: left;
  flex: 1;
}

.table-card-actions {
  display: flex;
  gap: 0.6rem;
  margin-top: 1rem;
  justify-content: flex-end;
}

/* Responsive - Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
@media (max-width: 1050px) { 
  .main-content { 
    padding: 1.3rem 2vw 1.5rem 2vw; 
  } 
  
  .dashboard-charts { 
    gap: 0.7rem; 
  } 
}

@media (max-width: 850px) {
  .main-content { 
    padding: 1.7rem 2vw 1.7rem 2vw; 
  }
  
  .dashboard-charts { 
    grid-template-columns: 1fr; 
  }

  .sidebar-menu a {
    padding: 0.8rem 1.3rem;
  }
}

@media (max-width: 700px) {
  .sidebar { 
    position: fixed; 
    top: 0; 
    right: 0;
    height: 100%; 
    width: 260px;
    box-shadow: 0 0 30px rgba(0,0,0,0.15); 
    z-index: 200; 
    transform: translateX(100%);
    border-left: 1px solid var(--border);
    backdrop-filter: blur(12px);
  }
  
  .sidebar.open { 
    transform: translateX(0); 
  }
  
  .main-content { 
    padding: 1.7rem 4vw; 
  }
  
  .sidebar-toggle-btn { 
    display: flex; 
  }
  
  .table-wrap { 
    display: none; 
  }
  
  .table-cards { 
    display: flex; 
  }
  
  .cards {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.8rem;
  }

  .card {
    padding: 1.1rem;
    min-height: 90px;
  }

  .table-card {
    padding: 1.2rem;
  }
}

@media (max-width: 600px) {
  .cards {
    grid-template-columns: 1fr;
  }
  
  .action-btn {
    width: 100%;
    margin: 0.3rem 0;
    padding: 0.5rem;
  }
  
  .table-card-actions {
    flex-direction: column;
    gap: 0.5rem;
  }

  .table-card-row {
    flex-direction: column;
    gap: 0.3rem;
    padding: 0.7rem 0;
  }

  .table-card-label {
    min-width: auto;
    font-size: 0.9rem;
  }

  .table-card-value {
    font-size: 1rem;
  }

  .main-content {
    padding: 1.5rem 4vw;
  }
}

@media (max-width: 480px) {
  html {
    font-size: 15px;
  }
  
  .main-content { 
    padding: 1.3rem 4vw; 
  }
  
  .sidebar-header { 
    padding: 1rem 1rem 0.8rem; 
    font-size: 1.3rem;
  }
  
  .sidebar { 
    width: 85vw; 
  }

  .sidebar-menu a {
    padding: 0.9rem 1.4rem;
    font-size: 1.05rem;
  }

  .card {
    flex-direction: column;
    text-align: center;
    padding: 1.3rem 0.8rem;
  }

  .card .icon {
    margin: 0 auto 0.5rem;
  }

  .content-header {
    font-size: 1.3rem;
  }
}

@media (max-width: 390px) { 
  .action-btn {
    padding: 0.6rem;
    font-size: 0.95rem;
  }

  .sidebar {
    width: 90vw;
  }

  .table-card {
    padding: 1.1rem;
  }
}

::-webkit-scrollbar { 
  width: 8px; 
  height: 8px;
}

::-webkit-scrollbar-thumb { 
  background: #10b98130; 
  border-radius: 8px; 
}

::-webkit-scrollbar-thumb:hover {
  background: #10b98160; 
}

.sidebar-toggle-btn {
  display: none; 
  position: fixed; 
  top: 1.3rem; 
  right: 1rem;
  background: var(--primary); 
  color: #fff; 
  border: none;
  border-radius: 10px; 
  font-size: 1.4rem; 
  width: 2.8rem; 
  height: 2.8rem;
  align-items: center; 
  justify-content: center; 
  cursor: pointer; 
  z-index: 150;
  transition: background var(--transition);
  box-shadow: 0 3px 12px rgba(0,0,0,0.15);
}

.sidebar-toggle-btn:hover { 
  background: var(--secondary); 
  transform: scale(1.05);
}

/* Dynamic chart improvements */
.dynamic-chart-box-pro {
  background: linear-gradient(135deg, #eafaf4 0%, #fff 80%);
  box-shadow: 0 8px 44px #10b98111, 0 4px 20px #0002;
  border-radius: 1.8rem;
  margin: 0 auto 2rem auto;
  max-width: 950px;
  width: 97%;
  padding: 2rem 1.6rem 1.5rem 1.6rem;
  position: relative;
  z-index: 11;
  min-height: 21rem;
  display: flex;
  flex-direction: column;
  gap: 0.9rem;
  animation: fadeIn .35s;
  transition: box-shadow .16s;
  border: 1.5px solid #10b98122;
}

.dynamic-chart-box-pro:hover {
  box-shadow: 0 14px 60px #10b98125, 0 8px 26px #0ea5e91c;
}

.dynamic-chart-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.2rem;
}

#chartBox-title {
  font-weight: 800;
  color: #10b981;
  font-size: 1.15rem;
  letter-spacing: .15px;
}

.close-dash-chart-btn {
  background: linear-gradient(135deg,#10b981 0%,#0ea5e9 100%);
  color: #fff;
  border: none;
  font-size: 1.5rem;
  border-radius: 15px;
  width: 2.8rem;
  height: 2.8rem;
  cursor: pointer;
  transition: background .13s, color .13s;
  margin-right: 0.1rem;
  margin-left: 0.3rem;
  box-shadow: 0 2px 12px #10b98133;
  display: flex; 
  align-items: center; 
  justify-content: center;
}

.close-dash-chart-btn:hover {
  background: #eab308;
  color: #fff;
}

.dynamic-chart-filters {
  display: flex;
  gap: 0.8rem;
  justify-content: flex-end;
  margin-bottom: 0.6rem;
  flex-wrap: wrap;
  user-select: none;
}

.dash-filter-btn {
  background: #eafaf4;
  color: #10b981;
  font-weight: 700;
  padding: 0.45rem 1.2rem;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-size: 0.95rem;
  transition: .13s;
  margin-bottom: 0.1rem;
  outline: none;
  box-shadow: 0 1px 8px #10b98113;
  letter-spacing: .15px;
  min-height: 2.5rem;
}

.dash-filter-btn.active,
.dash-filter-btn:hover {
  background: linear-gradient(135deg,#10b98144 0%,#0ea5e932 100%);
  color: #111;
}

.dynamic-chart-canvas-wrap {
  width: 100%;
  min-width: 0;
  height: 18rem;
  padding-top: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

@media (max-width: 1200px) {
  .dynamic-chart-box-pro {
    max-width: 99vw;
    padding: 1.5rem 2.5vw 1.2rem;
    min-height: 17rem;
  }
}

@media (max-width: 800px) {
  .dynamic-chart-box-pro {
    max-width: 99vw;
    min-height: 15rem;
    padding: 1.2rem 2vw;
    border-radius: 1.3rem;
  }
  
  .dynamic-chart-canvas-wrap {
    height: 13rem;
  }
  
  .close-dash-chart-btn { 
    width:2.5rem; 
    height:2.5rem; 
    font-size:1.3rem;
  }
}

@media (max-width: 500px) {
  .dynamic-chart-box-pro {
    padding: 1rem 3vw;
    min-height: 13rem;
    border-radius: 1rem;
  }
  
  .dynamic-chart-top { 
    font-size: .95em; 
  }
  
  .dynamic-chart-canvas-wrap { 
    height: 10rem; 
  }
  
  .close-dash-chart-btn { 
    width:2.2rem; 
    height:2.2rem; 
    font-size:1.1rem;
  }
  
  .dash-filter-btn { 
    font-size:0.9rem; 
    padding:0.4rem 0.9rem;
    min-height: 2.3rem;
  }
}

/* Animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(1.9rem); }
  to { opacity: 1; transform: none; }
}

/* Ø¨Ù‡Ø¨ÙˆØ¯ overlay Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
@media (max-width: 700px) {
  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.4);
    z-index: 190;
    backdrop-filter: blur(2px);
  }
  
  .sidebar.open ~ .sidebar-overlay {
    display: block;
  }
}




.seller-filter-btn {
  background: #fff;
  color: #10b981;
  border: 1.3px solid #10b98142;
  border-radius: 9px;
  padding: 0.43rem 1.3rem;
  font-size: 1rem;
  cursor: pointer;
  font-family: inherit;
  font-weight: bold;
  transition: all .15s;
  box-shadow: 0 2px 8px #10b98113;
}
.seller-filter-btn.active,
.seller-filter-btn:hover {
  background: linear-gradient(135deg,#10b98122 0%,#0ea5e930 100%);
  color: #0ea5e9;
  border-color: #0ea5e9;
}






/* --- Seller Modal Popup --- */
.seller-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(40,60,50,0.25);
  z-index: 9998;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn .35s;
  padding: 1.5rem;
  overflow-y: auto;
}
.seller-modal {
  background: #fff;
  border-radius: 1.5rem;
  box-shadow: 0 12px 50px #10b98144;
  width: min(520px, 100%);
  max-width: 100%;
  min-width: 0;
  padding: 2.2rem 1.7rem 1.2rem;
  direction: rtl;
  position: relative;
  z-index: 9999;
  animation: fadeIn .33s;
  max-height: min(90vh, 720px);
  overflow-y: auto;
}
.seller-modal-close {
  position: absolute; top: 1.2rem; right: 1.2rem;
  background: #eafaf4;
  border-radius: 10px;
  border: none; color: #16a34a;
  font-size: 1.6rem;
  cursor: pointer; padding: 0.25rem 1rem;
  transition: background .15s, color .15s;
}
.seller-modal-close:hover { background: #10b981; color: #fff; }
.seller-modal-title { color: #10b981; font-weight: bold; font-size: 1.1rem; margin-bottom: 1.3rem;}
.seller-modal-row { margin-bottom: .85rem; font-size: 1.01rem;}
.seller-modal-label { color: #333; font-weight: 700; min-width: 5rem; display: inline-block;}
.seller-modal-value { color: #0ea5e9; font-weight: 500;}
.seller-modal-form label { font-size: 0.96rem; font-weight: 500; color: #666;}
.seller-modal-form textarea {
  width: 100%; min-height: 66px; border-radius: 9px;
  border: 1.2px solid #10b98144; margin-top: 0.2rem;
  font-family: inherit; font-size: 1.01rem; padding: 0.4rem 0.6rem; outline: none; transition: border .13s;
}
.seller-modal-form textarea:focus { border-color: #10b981; }
.seller-modal-form button {
  margin-top: 0.7rem; padding: 0.41rem 1.4rem;
  border-radius: 9px; border: none; color: #fff;
  background: linear-gradient(135deg,#10b981 0%,#0ea5e9 100%);
  font-weight: bold; font-size: 1.08rem; cursor: pointer;
  transition: background .15s;
}
.seller-modal-form button:active { background: #0ea5e9; }
.seller-modal-success {
  color: #10b981; background: #eafaf4; border-radius: 9px;
  padding: 0.6rem 1rem; margin-top: 1rem; font-weight: 500; text-align: center;
}

.seller-score-block {
  margin-top: 1.5rem;
  padding: 1.2rem 1.4rem 1.35rem;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 1.1rem;
}
.seller-score-block .seller-modal-label {
  display: block;
  margin-bottom: 0.85rem;
  color: #0f172a;
}
.seller-score-range {
  display: flex;
  align-items: center;
  gap: 1rem;
}
.seller-score-range input[type=range] {
  flex: 1 1 auto;
  accent-color: #10b981;
}
.seller-score-value {
  min-width: 4.5rem;
  text-align: center;
  font-weight: 800;
  font-size: 1.25rem;
  color: #0ea5e9;
  background: #ecfdf5;
  border-radius: 0.9rem;
  padding: 0.4rem 0.7rem;
}
.seller-score-note {
  margin-top: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.45rem;
}
.seller-score-note label {
  font-size: 0.88rem;
  font-weight: 600;
  color: #0f172a;
}
.seller-score-note textarea {
  width: 100%;
  min-height: 72px;
  border-radius: 0.9rem;
  border: 1px solid #cbd5f5;
  background: #fff;
  font-family: inherit;
  font-size: 0.92rem;
  padding: 0.55rem 0.75rem;
  transition: border-color .15s ease, box-shadow .15s ease;
  resize: vertical;
}
.seller-score-note textarea:focus {
  border-color: #0ea5e9;
  box-shadow: 0 0 0 3px rgba(14,165,233,.1);
  outline: none;
}
.seller-score-note-hint {
  font-size: 0.75rem;
  color: #64748b;
  line-height: 1.6;
}
.seller-score-message {
  margin-top: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.45rem;
}
.seller-score-message label {
  font-size: 0.88rem;
  font-weight: 600;
  color: #0f172a;
}
.seller-score-message textarea {
  width: 100%;
  min-height: 88px;
  border-radius: 0.9rem;
  border: 1px solid #bae6fd;
  background: #fff;
  font-family: inherit;
  font-size: 0.95rem;
  padding: 0.6rem 0.8rem;
  transition: border-color .15s ease, box-shadow .15s ease;
  resize: vertical;
}
.seller-score-message textarea:focus {
  border-color: #0ea5e9;
  box-shadow: 0 0 0 3px rgba(14,165,233,.1);
  outline: none;
}
.seller-score-message-hint {
  font-size: 0.75rem;
  color: #475569;
  line-height: 1.7;
}
.seller-score-note-display {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}
.seller-score-message-display {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
  margin-top: 0.9rem;
  padding: 0.85rem 1rem;
  border-radius: 0.9rem;
  background: #ecfeff;
  border: 1px solid #bae6fd;
}
.seller-score-message-display.is-empty {
  background: #f8fafc;
  border-style: dashed;
  color: #64748b;
}
.seller-score-message-display.is-empty .seller-score-message-title,
.seller-score-message-display.is-empty .seller-message-text {
  color: #64748b;
}
.seller-score-message-title {
  font-size: 0.78rem;
  font-weight: 700;
  color: #0f172a;
}
.seller-message-text {
  font-size: 0.9rem;
  color: #0f172a;
  line-height: 1.7;
}
.seller-score-note-title {
  font-size: 0.78rem;
  font-weight: 700;
  color: #0f172a;
}
.seller-score-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 1rem;
  flex-wrap: wrap;
}
.seller-score-actions button {
  flex: 1 1 140px;
  padding: 0.6rem 1rem;
  border-radius: 0.9rem;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: background .18s ease, color .18s ease, transform .18s ease;
}
.seller-score-actions .score-save-btn {
  background: linear-gradient(135deg,#10b981 0%,#0ea5e9 100%);
  color: #fff;
}
.seller-score-actions .score-save-btn:hover {
  transform: translateY(-1px);
  background: linear-gradient(135deg,#059669 0%,#0284c7 100%);
}
.seller-score-actions .score-clear-btn {
  background: #f1f5f9;
  color: #475569;
}
.seller-score-actions .score-clear-btn:hover {
  background: #e2e8f0;
}
.seller-score-actions .score-clear-btn:disabled {
  opacity: .55;
  cursor: not-allowed;
  transform: none;
}
.seller-score-hint {
  font-size: 0.82rem;
  color: #64748b;
  margin-top: 0.85rem;
  line-height: 1.7;
}
.seller-score-alert {
  margin-top: 0.9rem;
  border-radius: 0.95rem;
  padding: 0.65rem 0.95rem;
  font-size: 0.85rem;
  font-weight: 600;
  display: none;
}
.seller-score-alert.is-success {
  background: #ecfdf5;
  color: #047857;
  border: 1px solid #bbf7d0;
}
.seller-score-alert.is-error {
  background: #fee2e2;
  color: #b91c1c;
  border: 1px solid #fecaca;
}

.seller-score-cell-wrap {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0.35rem;
}

.seller-status-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.28rem 0.75rem;
  border-radius: 999px;
  font-size: 0.78rem;
  font-weight: 700;
  background: #e2e8f0;
  color: #475569;
  transition: background .18s ease, color .18s ease;
}
.seller-status-pill.status-success {
  background: #dcfce7;
  color: #047857;
}
.seller-status-pill.status-warning {
  background: #fef3c7;
  color: #b45309;
}
.seller-status-pill.status-danger {
  background: #fee2e2;
  color: #b91c1c;
}
.seller-status-pill.status-neutral {
  background: #e2e8f0;
  color: #475569;
}

.seller-status-note {
  font-size: 0.78rem;
  font-weight: 600;
}
.seller-status-note.status-eligible {
  color: #047857;
}
.seller-status-note.status-ineligible {
  color: #b91c1c;
}
.seller-status-note.status-neutral {
  color: #475569;
}
.seller-note-text {
  font-size: 0.8rem;
  color: #334155;
  line-height: 1.7;
  background: #f1f5f9;
  border-radius: 0.75rem;
  padding: 0.65rem 0.75rem;
  border: 1px dashed #cbd5f5;
  word-break: break-word;
}

.seller-score-status {
  margin-top: 1.1rem;
  padding-top: 0.9rem;
  border-top: 1px dashed #cbd5f5;
  display: flex;
  flex-direction: column;
  gap: 0.55rem;
}
.seller-score-status-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.seller-status-text {
  font-size: 0.85rem;
  color: #475569;
  line-height: 1.7;
}
.seller-status-updated {
  font-size: 0.76rem;
  color: #64748b;
}

.seller-score-actions button.is-loading {
  opacity: .65;
  cursor: wait;
}

.seller-score-cell {
  text-align: center;
}
.seller-score-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.35rem;
  min-width: 102px;
  padding: 0.38rem 0.85rem;
  border-radius: 9999px;
  font-size: 0.86rem;
  font-weight: 600;
  background: #f8fafc;
  color: #475569;
  border: 1px solid #e2e8f0;
  transition: transform .18s ease, box-shadow .18s ease;
}
.seller-score-badge.has-score {
  background: #ecfdf5;
  border-color: #bbf7d0;
  color: #047857;
}
.seller-score-badge.has-score strong {
  font-weight: 800;
  font-size: 1.02rem;
}
.seller-score-badge span.score-suffix {
  font-size: 0.75rem;
  opacity: .75;
}
.seller-score-badge.no-score {
  background: #f1f5f9;
  border-color: #e2e8f0;
  color: #64748b;
}
.seller-score-badge:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 26px rgba(15,118,110,.18);
}

@media (max-width: 640px) {
  .seller-modal-overlay {
    padding: 1rem;
    align-items: flex-start;
  }
  .seller-modal {
    width: 100%;
    max-width: 100%;
    border-radius: 1.25rem 1.25rem 0 0;
    padding: 1.6rem 1.2rem 1rem;
    max-height: none;
  }
  .seller-modal-row {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.35rem;
  }
  .seller-modal-label {
    min-width: 0;
  }
  .seller-score-range {
    flex-direction: column;
    align-items: stretch;
    gap: 0.65rem;
  }
  .seller-score-value {
    align-self: flex-start;
  }
}

@media (max-width: 400px) {
  .seller-score-actions {
    flex-direction: column;
  }
  .seller-score-actions button {
    flex: 1 1 auto;
    width: 100%;
  }
  .seller-modal {
    padding: 1.4rem 1rem 0.9rem;
  }
}






/* === Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§  (Plans)  ================================ */
#plans-panel{
  /* Ø³ØªÙˆÙ†Ù ÙˆØ³Ø·â€ŒÚ†ÛŒÙ† Ø¯Ø± Ú©Ù„ Ø¹Ø±Ø¶Ù Main-Content */
  display:flex;
  flex-direction:column;
  align-items:center;       /* Ù…Ø­ÙˆØ± Ø§ÙÙ‚ÛŒ */
  justify-content:center;   /* Ù…Ø­ÙˆØ± Ø¹Ù…ÙˆØ¯ÛŒ â€“ Ø§Ú¯Ø± ÙÙ‚Ø· Ø¨Ø§Ù„Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø¨Ú¯Ø°Ø§Ø± flex-start */
  gap:2rem;
  min-height:calc(100vh - 120px); /* Ù‚Ø¯ Ù†Ø³Ø¨Ù‰ Ø¨Ø±Ø§Ù‰ ÙˆØ³Ø· Ø´Ø¯Ù† */
  padding:2rem 1rem;
}

#plans-panel .content-header{
  width:100%;
  text-align:center;
  font-size:2rem;
  font-weight:900;
  color:var(--primary);
  letter-spacing:.5px;
}

/* Ø¸Ø±ÙÛŒ Ú©Ù‡ ÙØ±Ù… Ø±Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ ÙˆØ³Ø· Ù†Ú¯Ù‡ Ù…Ù‰â€ŒØ¯Ø§Ø±Ø¯ */
.plans-center{
  width:100%;
  max-width:1000px;
  display:flex;
  justify-content:center;   /* ÙˆØ³Ø· Ø§ÙÙ‚ÛŒ */
  align-items:center;       /* ÙˆØ³Ø· Ø¹Ù…ÙˆØ¯ÛŒ */
}

/* ÙØ±Ù… Ø²ÛŒØ¨Ø§ */
#plansForm{
  width:100%;
  max-width:430px;
  background:linear-gradient(135deg,#e0fdfa 0%,#f8fafc 100%);
  border:1.6px solid #e0fdfa;
  border-radius:28px;
  box-shadow:0 6px 36px #10b98122;
  padding:2.5rem 2rem 2rem;
  display:flex;
  flex-direction:column;
  animation:fadeIn .4s;
}

/* Ù„ÛŒØ¨Ù„ + ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ */
#plansForm label{
  width:100%;
  margin-bottom:1.1rem;
  font-size:1.05rem;
  font-weight:700;
  color:#0ea5e9;
}
#plansForm input[type="number"]{
  width:100%;
  margin-top:.4rem;
  padding:.9rem 1.2rem;
  font-size:1.15rem;
  font-weight:700;
  background:#f8fafc;
  border:1.8px solid #e0fdfa;
  border-radius:16px;
  outline:none;
  transition:border .15s,box-shadow .15s;
}
#plansForm input[type="number"]:focus{
  border-color:#10b981;
  box-shadow:0 4px 24px #10b98133;
  background:#e6fff7;
}

/* Ø¯Ú©Ù…Ù‡Ù” Ø°Ø®ÛŒØ±Ù‡ */
#plansForm button[type="submit"]{
  align-self:center;
  margin-top:.6rem;
  background:linear-gradient(90deg,#10b981 0%,#0ea5e9 100%);
  color:#fff;
  padding:1rem 2.6rem;
  font-size:1.15rem;
  font-weight:900;
  border:none;
  border-radius:14px;
  cursor:pointer;
  box-shadow:0 3px 18px #10b98135;
  transition:transform .1s,box-shadow .15s,background .15s;
}
#plansForm button[type="submit"]:hover{
  background:linear-gradient(90deg,#0ea5e9 0%,#10b981 100%);
  box-shadow:0 6px 28px #0ea5e955;
  transform:translateY(-3px) scale(1.04);
}

/* Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª */
#plansMsg{
  display:none;
  width:100%;
  margin-top:1.2rem;
  padding:.9rem 1.2rem;
  text-align:center;
  font-weight:800;
  font-size:1.05rem;
  color:#10b981;
  background:#e0fdfa;
  border-radius:13px;
  box-shadow:0 2px 12px #10b98112;
}

/* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ø³Ø±ÛŒØ¹ */
@media(max-width:600px){
  #plansForm{
    padding:1.6rem 1rem;
    border-radius:20px;
  }
  .plans-center{
    min-height:50vh;
  }
}

/* --- Ù‡ÙØ¯ÙØ± Â«Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§Â» Ø±Ø§ ÙˆØ³Ø·â€ŒÚ†ÛŒÙ† Ú©Ù† --- */
#plans-panel .content-header{
  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„Ù‰ â€“ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù‰ Ù†Ú¯Ù‡ Ø¯Ø§Ø±Ù‰ ÛŒØ§ Ù‡Ù…ÛŒÙ† Ø±Ø§ Ú©Ø§Ù…Ù„ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù† */
  width:100%;
  font-size:2rem;
  font-weight:900;
  color:var(--primary);
  letter-spacing:.5px;

  /* Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ø®Ø·â€ŒÙ‡Ø§ Ø¨Ø±Ø§Ù‰ ÙˆØ³Ø·â€ŒÚ†ÛŒÙ†Ù‰ */
  display:flex;            /* Ù‡ÙØ¯ÙØ± Ù‡Ù…Ú†Ù†Ø§Ù† ÙÙ„Ú©Ø³ Ø§Ø³Øª */
  justify-content:center;  /* Ù…Ø­ØªÙˆØ§ÛŒØ´ Ø¯Ø± Ù…Ø­ÙˆØ± Ø§ÙÙ‚Ù‰ ÙˆØ³Ø· Ù‚Ø±Ø§Ø± Ù…Ù‰â€ŒÚ¯ÛŒØ±Ø¯ */
  text-align:center;       /* Ùˆ Ù…ØªÙ† Ø¯Ø§Ø®Ù„Ø´ Ù‡Ù… ÙˆØ³Ø· Ù…Ù‰â€ŒØ´ÙˆØ¯ */
}







/* ---- ÙØ±Ù…â€ŒÙ‡Ø§ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ (Ù¾Ù„Ù† + ØªØ¨Ù„ÛŒØºØ§Øª) ---- */
.priceForm{
  width:100%;
  max-width:430px;
  background:linear-gradient(135deg,#e0fdfa 0%,#f8fafc 100%);
  border:1.6px solid #e0fdfa;
  border-radius:28px;
  box-shadow:0 6px 36px #10b98122;
  padding:2.5rem 2rem 2rem;
  display:flex;
  flex-direction:column;
  animation:fadeIn .4s;
}
.priceForm label{
  width:100%;
  margin-bottom:1.1rem;
  font-size:1.05rem;
  font-weight:700;
  color:#0ea5e9;
}
.priceForm input[type="number"]{
  width:100%;
  margin-top:.4rem;
  padding:.9rem 1.2rem;
  font-size:1.15rem;
  font-weight:700;
  background:#f8fafc;
  border:1.8px solid #e0fdfa;
  border-radius:16px;
  outline:none;
  transition:border .15s,box-shadow .15s;
}
.priceForm input[type="number"]:focus{
  border-color:#10b981;
  box-shadow:0 4px 24px #10b98133;
  background:#e6fff7;
}
.priceForm button[type="submit"]{
  align-self:center;
  margin-top:.6rem;
  background:linear-gradient(90deg,#10b981 0%,#0ea5e9 100%);
  color:#fff;
  padding:1rem 2.6rem;
  font-size:1.15rem;
  font-weight:900;
  border:none;
  border-radius:14px;
  cursor:pointer;
  box-shadow:0 3px 18px #10b98135;
  transition:transform .1s,box-shadow .15s,background .15s;
}
.priceForm button[type="submit"]:hover{
  background:linear-gradient(90deg,#0ea5e9 0%,#10b981 100%);
  box-shadow:0 6px 28px #0ea5e955;
  transform:translateY(-3px) scale(1.04);
}

/* Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª/Ø®Ø·Ø§ Ø¯Ø§Ø®Ù„ Ù‡Ø± ÙØ±Ù… */
#plansMsg, #adsMsg{
  display:none;
  width:100%;
  margin-top:1.2rem;
  padding:.9rem 1.2rem;
  text-align:center;
  font-weight:800;
  font-size:1.05rem;
  color:#10b981;
  background:#e0fdfa;
  border-radius:13px;
  box-shadow:0 2px 12px #10b98112;
}






#chatModal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 9999;
  backdrop-filter: blur(2.5px);
  direction: rtl;
  font-family: 'Vazirmatn', Tahoma, sans-serif;
}
#chatModal.show { display: block; }
.modal-overlay {
  position: absolute; inset: 0;
  background: rgba(34,41,47,0.24);
  z-index: 0;
}
.modal-content {
  position: absolute;
  top: 50%; left: 50%;
  width: 99%; max-width: 700px; /* Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø´Ø¯ */
  min-width: 340px;
  max-height: 88vh;             /* Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø´Ø¯ */
  min-height: 380px;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 32px;
  padding: 0;
  box-shadow: 0 12px 70px #10b98130, 0 4px 28px #0ea5e920;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  z-index: 2;
  animation: fadeIn .38s;
}
.modal-content h3 {
  background: linear-gradient(90deg,#10b981 0%,#0ea5e9 100%);
  color: #fff;
  font-size: 1.25rem;
  font-weight: bold;
  padding: 1.18rem 1.3rem 1rem 1.3rem;
  margin: 0;
  text-align: right;
  letter-spacing: .2px;
  border-bottom: 2px solid #eafaf4;
}
.chat-messages {
  flex: 1 1 0;
  overflow-y: auto;
  background: linear-gradient(135deg,#eafaf4 0%,#fff 70%);
  padding: 1.6rem 2.1rem 0.9rem 2.1rem;
  min-height: 200px;
  max-height: 54vh;
  display: flex;
  flex-direction: column;
  gap: 0.95rem;
  scroll-behavior: smooth;
  font-size: 1.05rem;
  /* Ø§ÛŒÙ† Ø®Ø· Ø¨Ø§ÛŒØ¯ Ø­Ø°Ù Ø¨Ø´Ù‡ ğŸ‘‡ */
  /* justify-content: flex-end; */
}




.chat-bubble {
  display: flex;
  flex-direction: column;
  max-width: 65%;
  min-width: 70px;
  margin: 0.5rem 0;
  padding: 0.95rem 1.3rem 0.95rem 1.2rem;
  background: #f5f5f5;
  border-radius: 17px 17px 17px 8px;
  box-shadow: 0 2px 14px #10b98113;
  font-size: 1.09rem;
  word-break: break-word;
  position: relative;
  animation: fadeIn .24s;
  border: 1.5px solid #10b98118;
  align-self: flex-start;  /* Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ù¾ÛŒØ§Ù… ÙØ±ÙˆØ´Ù†Ø¯Ù‡/Ù…Ø´ØªØ±ÛŒ) Ø³Ù…Øª Ø±Ø§Ø³Øª */
  direction: rtl;
  transition: box-shadow .17s;
}

/* Ø§Ø¯Ù…ÛŒÙ† Ø¨ÛŒØ§Ø¯ Ø³Ù…Øª Ú†Ù¾ØŒ Ø¨Ù‚ÛŒÙ‡ Ø±Ø§Ø³Øª */
.chat-bubble.admin {
  align-self: flex-end !important;
  background: linear-gradient(90deg,#e0fdfa 0%,#f8fafc 100%);
  border-radius: 21px 11px 22px 22px;
  border: 1.6px solid #10b98155;
  color: #16706b;
  margin-left: 0;
  margin-right: auto;
  box-shadow: 0 2px 18px #10b98111;
  direction: rtl;
}
.chat-bubble.seller {
  align-self: flex-start !important;
  background: linear-gradient(90deg,#eafaf4 0%,#fff 80%);
  border-radius: 19px 22px 12px 22px;
  border: 1.5px solid #0ea5e933;
  color: #066e41;
  margin-right: 0;
  margin-left: auto;
}
.chat-bubble.customer {
  align-self: flex-start !important;
  background: #fffde7;
  border-radius: 15px 18px 13px 22px;
  border: 1.4px solid #eab30842;
  color: #ba7604;
}

.chat-bubble .sender {
  font-size: 0.95em;
  font-weight: 700;
  margin-bottom: 0.13em;
  color: #0ea5e9;
  opacity: 0.86;
  letter-spacing: .2px;
}
.chat-bubble.admin .sender { color: #10b981; }
.chat-bubble.customer .sender { color: #ba7604; }
.chat-bubble.seller .sender { color: #0ea5e9; }
.chat-bubble .text {
  font-size: 1.15em;
  font-weight: 500;
  line-height: 2.12;
  margin-bottom: 0.15em;
}
.chat-bubble .time {
  font-size: 0.87em;
  color: #8ca0a8;
  margin-top: 0.25em;
  text-align: left;
  font-weight: 400;
}

.chat-input-area {
  border-top: 1.7px solid #eafaf4;
  background: #f8fafc;
  padding: 1.1rem 2rem;
  display: flex;
  gap: 0.75rem;
  align-items: flex-end;
}



.chat-input-area {
  /* Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ø®Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø§Ø²Ù‡â€ŒÛŒ Ú†Ù†Ø¯Ø®Ø·ÛŒ Ø´Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
  flex-wrap: wrap;
}

.chat-input-area .action-btn.delete {
  /* Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù‚Ø±Ù…Ø² Ø´ÙˆØ¯ */
  background: #ef4444 !important;
  color: #fff !important;
}

.chat-input-area .action-btn.delete:hover {
  background: #dc2626 !important;
}



.chat-input-area textarea {
  flex: 1;
  padding: 0.73rem 1rem;
  border-radius: 15px;
  border: 1.7px solid #10b98122;
  font-size: 1.14rem;
  font-family: inherit;
  resize: none;
  outline: none;
  transition: border .15s, background .13s;
  background: #fff;
  min-height: 58px;
  max-height: 120px;
  font-weight: 500;
}
.chat-input-area textarea:focus {
  border-color: #0ea5e9;
  background: #eafaf4;
}
.chat-input-area button {
  padding: 0.87rem 2.1rem;
  border-radius: 13px;
  background: linear-gradient(90deg,#10b981 0%,#0ea5e9 100%);
  color: #fff;
  border: none;
  font-weight: bold;
  font-size: 1.17rem;
  cursor: pointer;
  transition: background .12s, box-shadow .14s, transform .11s;
  box-shadow: 0 2px 12px #10b98114;
  letter-spacing: .4px;
}
.chat-input-area button:hover {
  background: linear-gradient(90deg,#0ea5e9 0%,#10b981 100%);
  transform: scale(1.05);
}
.modal-close {
  background: none;
  color: #10b981;
  border: none;
  font-size: 1.18rem;
  font-weight: bold;
  cursor: pointer;
  margin: 1.2rem 2.1rem 0.7rem 0;
  align-self: flex-start;
  transition: color .14s;
  border-radius: 9px;
  padding: 0.21rem 1rem;
}
.modal-close:hover { color: #0ea5e9; background: #eafaf4; }

@media (max-width: 900px) {
  .modal-content { max-width: 97vw; padding: 0; }
  .chat-messages { padding: 1.25rem 0.5rem 0.6rem 0.7rem; }
  .chat-bubble { padding: 0.72rem 0.9rem 0.75rem 0.9rem; font-size: 1em; }
  .chat-input-area { padding: 0.9rem 0.7rem; }
  .modal-close { margin: 0.9rem 1rem 0.5rem 0; }
}
@media (max-width: 540px) {
  .modal-content { max-width: 99vw; border-radius: 12px; }
  .chat-messages { font-size: 0.95em; }
  .chat-input-area textarea { min-height: 38px; font-size: 0.96em; }
}


/* Ø§Ú¯Ø± Ø¯Ø±ÙˆÙ† .count Ù…ØªÙ†ÛŒ Ù†Ø¨Ø§Ø´Ø¯ØŒ Ú©Ø§Ù…Ù„ display:none Ø´ÙˆØ¯ */
.sidebar-menu a .count:empty {
  display: none;
}



/* â€”â€” Ú©Ø§Ø±Øª Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ â€”â€” */
/* â€”â€” Ú©Ø§Ø±Øª Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ (ÙØ´Ø±Ø¯Ù‡) â€”â€” */
.broadcast-card {
  background: var(--card);
  border-radius: 17px;
  box-shadow: 0 8px 32px #10b98112, 0 1.5px 16px #0ea5e930;
  margin: 1.3rem 0;
  overflow: hidden;
  width: 100%;
  max-width: 100%;
  min-width: 0;
  font-family: 'Vazirmatn', Tahoma, sans-serif;
  font-size: 1.04rem;
  letter-spacing: .01em;
  transition: transform .17s, box-shadow .18s;
  /* ÙØ´Ø±Ø¯Ù‡ */
}

.broadcast-card:hover {
  transform: translateY(-3px) scale(1.01);
  box-shadow: 0 16px 44px #0ea5e91c, 0 4px 18px #10b9811a;
}

/* Ø­Ø§Ù„Øª Ø¬Ù…Ø¹â€ŒØ´Ø¯Ù‡ */
.broadcast-card.collapsed .broadcast-body {
  display: none;
}

/* Ù‡Ø¯Ø± */
.broadcast-header {
  display: flex;
  align-items: center;
  gap: .7rem;
  background: linear-gradient(90deg, var(--primary) 70%, var(--secondary) 100%);
  color: #fff;
  padding: .77rem 2rem .77rem 1.2rem;
  cursor: pointer;
  font-size: 1.08rem;
  font-weight: 900;
  border-bottom: 1px solid #e0fdfa;
  letter-spacing: .02em;
  user-select: none;
  min-height: 56px;
}
.broadcast-header i {
  font-size: 1.33em;
  opacity: .92;
}
.broadcast-header h4 {
  margin: 0;
  font-size: 1.07em;
  font-weight: 900;
  letter-spacing: .02em;
}
.toggle-icon {
  margin-left: auto;
  font-size: 1.55em !important;
  transition: transform .24s cubic-bezier(.45,.7,.3,1.2);
}
.broadcast-card:not(.collapsed) .toggle-icon {
  transform: rotate(180deg);
}

/* ÙØ±Ù… */
.broadcast-body {
  padding: .99rem 2.2rem .82rem 2.2rem;
  background: #fcfcfd;
  display: flex;
  flex-direction: row;
  gap: 1.5rem;
  align-items: flex-end;
  max-height: 230px;
}
.broadcast-row {
  display: flex;
  flex-direction: column;
  gap: 0.38rem;
  flex: 1;
  min-width: 0;
}
.broadcast-row label {
  font-weight: 800;
  color: #0ea5e9;
  font-size: .97rem;
  margin-bottom: 0.03rem;
}
.broadcast-row select,
.broadcast-row textarea {
  width: 100%;
  border: 1.3px solid #e0fdfa;
  border-radius: 9px;
  padding: .6rem .85rem;
  font-size: .99rem;
  font-family: inherit;
  background: #f8fafc;
  outline: none;
  resize: none;
  transition: border .13s, box-shadow .14s;
  font-weight: 500;
  color: #2e3743;
  box-shadow: 0 1px 7px #10b98109;
}
.broadcast-row select:focus,
.broadcast-row textarea:focus {
  border-color: #10b981;
  box-shadow: 0 0 0 2px #0ea5e91a;
}
.broadcast-row textarea {
  min-height: 45px;
  max-height: 100px;
  line-height: 1.85;
}

.broadcast-actions {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  min-width: 105px;
  margin-right: 1rem;
  gap: 0.55rem;
}
.broadcast-actions button {
  background: linear-gradient(90deg, var(--primary) 30%, var(--secondary) 90%);
  color: #fff;
  border: none;
  border-radius: 9px;
  padding: .65rem 1.4rem;
  font-size: 1.04rem;
  font-weight: 900;
  box-shadow: 0 3px 14px #10b98116;
  transition: transform .09s, box-shadow .13s, background .11s;
  letter-spacing: .01em;
  cursor: pointer;
  width: 100%;
}
.broadcast-actions button:hover {
  background: linear-gradient(90deg, var(--secondary) 10%, var(--primary) 85%);
  transform: translateY(-1px) scale(1.03);
  box-shadow: 0 7px 22px #10b98118, 0 2px 8px #0ea5e911;
}

.broadcast-status {
  margin-top: .12rem;
  font-size: .97rem;
  min-height: 1.2em;
  text-align: right;
  font-weight: 700;
  letter-spacing: .01em;
  color: #0ea5e9;
  transition: color .16s;
}

/* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ: Ù…ÙˆØ¨Ø§ÛŒÙ„ */
@media (max-width: 900px) {
  .broadcast-body {
    padding: .88rem 1.1rem .7rem 1.1rem;
    gap: 1.1rem;
    max-height: 260px;
  }
}
@media (max-width: 600px) {
  .broadcast-card {
    border-radius: 10px;
    font-size: .98rem;
    margin: 1rem 0 .8rem 0;
  }
  .broadcast-header {
    padding: .66rem .85rem .66rem .7rem;
    font-size: 1.01rem;
    min-height: 46px;
  }
  .broadcast-body {
    flex-direction: column;
    align-items: stretch;
    gap: .67rem;
    max-height: none;
    padding: .88rem .7rem .5rem .7rem;
  }
  .broadcast-actions {
    margin: 0;
    width: 100%;
    align-items: stretch;
  }
  .broadcast-actions button {
    border-radius: 8px;
    font-size: .97rem;
    padding: .73rem 0;
    width: 100%;
  }
}

@media (max-width: 370px) {
  .broadcast-card {
    font-size: .94rem;
    border-radius: 8px;
  }
  .broadcast-header {
    padding: .48rem .4rem;
    font-size: .93rem;
  }
  .broadcast-body {
    padding: .58rem .2rem .4rem .2rem;
    gap: .43rem;
  }
  .broadcast-row label {
    font-size: .93rem;
  }
}






/* ============ Sender-Info Modal ============ */
.sender-modal-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.35);
  backdrop-filter:blur(3px);
  display:none; align-items:center; justify-content:center;
  z-index:10000; animation:fadeIn .32s;
}
.sender-modal{
  width:380px; max-width:95vw; background:#fff;
  border-radius:24px; padding:2rem 1.6rem 1.4rem;
  box-shadow:0 12px 40px #00000030;
  direction:rtl; position:relative; animation:fadeIn .35s;
}
.sender-modal-close{
  position:absolute; top:1rem; left:1rem;
  background:#eafaf4; border:none; border-radius:40px;
  color:#10b981; font-size:1.55rem; cursor:pointer;
  width:2.6rem; height:2.6rem;
  transition:background .15s,color .15s;
}
.sender-modal-close:hover{background:#10b981;color:#fff;}
.sender-modal h4{
  margin:0 0 1.1rem 0; font-size:1.15rem;
  font-weight:900; color:#0ea5e9; letter-spacing:.3px;
}
.sender-info-row{margin:.55rem 0; font-size:1rem;}
.sender-info-label{font-weight:700; color:#444; min-width:6rem; display:inline-block;}
.sender-info-value{color:#10b981; font-weight:500;}







.action-btn.block {
  background: #ef4444;
  color: #fff;
}
.action-btn.block:hover {
  background: #dc2626;
}
.action-btn.unblock {
  background: #22c55e;
  color: #fff;
}
.action-btn.unblock:hover {
  background: #16a34a;
}

.blocked-badge {
  display: inline-block;
  color: #dc2626;
  font-weight: bold;
  margin-right: 0.5rem;
}







/* --- User Modal Popup --- */
.user-modal-overlay {
  position: fixed; inset: 0; background: rgba(40,60,50,0.25); z-index: 9998;
  display: flex; align-items: center; justify-content: center; animation: fadeIn .35s;
}
.user-modal {
  background: #fff;
  border-radius: 1.5rem;
  box-shadow: 0 12px 50px #10b98144;
  min-width: 350px; max-width: 98vw; width: 420px;
  padding: 2.3rem 1.7rem 1.1rem;
  direction: rtl;
  position: relative;
  z-index: 9999;
  animation: fadeIn .33s;
}
.user-modal-close {
  position: absolute; top: 1.2rem; left: 1.2rem;
  background: #eafaf4;
  border-radius: 10px;
  border: none; color: #16a34a;
  font-size: 1.6rem;
  cursor: pointer; padding: 0.25rem 1rem;
  transition: background .15s, color .15s;
}
.user-modal-close:hover { background: #10b981; color: #fff; }
.user-modal-title { color: #10b981; font-weight: bold; font-size: 1.1rem; margin-bottom: 1.3rem;}
.user-modal-row { margin-bottom: .85rem; font-size: 1.01rem;}
.user-modal-label { color: #333; font-weight: 700; min-width: 5rem; display: inline-block;}
.user-modal-value { color: #0ea5e9; font-weight: 500;}
.user-modal-form label { font-size: 0.96rem; font-weight: 500; color: #666;}
.user-modal-form textarea {
  width: 100%; min-height: 66px; border-radius: 9px;
  border: 1.2px solid #10b98144; margin-top: 0.2rem;
  font-family: inherit; font-size: 1.01rem; padding: 0.4rem 0.6rem; outline: none; transition: border .13s;
}
.user-modal-form textarea:focus { border-color: #10b981; }
.user-modal-form button {
  margin-top: 0.7rem; padding: 0.41rem 1.4rem;
  border-radius: 9px; border: none; color: #fff;
  background: linear-gradient(135deg,#10b981 0%,#0ea5e9 100%);
  font-weight: bold; font-size: 1.08rem; cursor: pointer;
  transition: background .15s;
}
.user-modal-form button:active { background: #0ea5e9; }
.user-modal-success {
  color: #10b981; background: #eafaf4; border-radius: 9px;
  padding: 0.6rem 1rem; margin-top: 1rem; font-weight: 500; text-align: center;
}
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">ÙˆÛŒØªØ±ÛŒÙ†Øª</div>
      <div class="sidebar-menu">
        <a href="#" class="active" data-section="dashboard"><i class="ri-dashboard-line"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
        <a href="#" data-section="daily-visits"><i class="ri-eye-line"></i> Ø¢Ù…Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ø§Ø²Ø¯ÛŒØ¯</a>
        <a href="#" data-section="users"><i class="ri-user-3-line"></i> Ú©Ø§Ø±Ø¨Ø±Ø§Ù† <span class="count" id="count-users">0</span></a>
        <a href="#" data-section="sellers"><i class="ri-store-2-line"></i> ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€ŒÙ‡Ø§ <span class="count" id="count-sellers">0</span></a>
        <a href="#" data-section="products"><i class="ri-box-3-line"></i> Ù…Ø­ØµÙˆÙ„Ø§Øª <span class="count" id="count-products">0</span></a>
        <a href="#" data-section="plans"><i class="ri-money-dollar-circle-line"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§</a>
        <a href="#" data-section="ads"><i class="ri-megaphone-line"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª ØªØ¨Ù„ÛŒØºØ§Øª</a>
<a href="#" data-section="messages">
  <i class="ri-chat-1-line"></i> Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
  <span class="count" id="count-messages">0</span>
</a>
<a href="#" data-section="reports"><i class="ri-file-list-line"></i> Ú¯Ø²Ø§Ø±Ø´Ø§Øª <span class="count" id="count-reports">0</span></a>


      </div>
      <div class="sidebar-footer">
        <span>Â© 2025 vitrinNet Panel</span>
      </div>
    </nav>
 <!-- Main Content
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
<div class="main-content">
  <!-- Ø¯Ú©Ù…Ù‡Ù” Ø¨Ø§Ø²/Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
  <button class="sidebar-toggle-btn" id="sidebarToggle">
    <i class="ri-menu-3-line"></i>
  </button>

  <!-- Û±) Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
  <div class="section-panel" id="dashboard-panel">
    <div class="content-header">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¢Ù…Ø§Ø±ÛŒ</div>
    <div class="cards">
      <div class="card" id="card-visits">
        <span class="icon"><i class="ri-eye-line"></i></span>
        <div><div class="num" id="visit-today">0</div><div class="label">Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ø§Ù…Ø±ÙˆØ²</div></div>
      </div>
      <div class="card" id="card-users">
        <span class="icon"><i class="ri-user-add-line"></i></span>
        <div><div class="num" id="register-user-today">0</div><div class="label">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ù…Ø±ÙˆØ²</div></div>
      </div>
      <div class="card" id="card-sellers">
        <span class="icon"><i class="ri-store-2-line"></i></span>
        <div><div class="num" id="register-seller-today">0</div><div class="label">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø§Ù…Ø±ÙˆØ²</div></div>
      </div>
      <div class="card" id="card-products">
        <span class="icon"><i class="ri-box-3-line"></i></span>
        <div><div class="num" id="products-total">0</div><div class="label">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­ØµÙˆÙ„Ø§Øª</div></div>
      </div>
    </div>
    <div id="dashboard-dynamic-chart-wrap"></div>
  </div>

  <!-- Ù¾Ù†Ù„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ø§Ø²Ø¯ÛŒØ¯ -->
  <div class="section-panel" id="daily-visits-panel" style="display:none;">
    <p style="text-align:center">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ...</p>
  </div>

  <!-- Û²) Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
<!-- Û²) Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
<div class="section-panel" id="users-panel" style="display:none;">
  <div class="content-header">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† <span class="header-count" id="header-users-count"></span></div>
  <div style="margin-bottom:1rem;display:flex;gap:0.5rem;align-items:center;">
    <input type="text" id="userSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù†Ø§Ù…ØŒ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ ÛŒØ§ ØªÙ„ÙÙ†..." 
           style="width:100%;max-width:400px;padding:0.7rem 1rem;border-radius:12px;border:1.5px solid #10b98144;font-size:1rem;font-family:inherit;outline:none;transition:border .15s;">
  </div>
  <div class="table-wrap">
    <table id="usersTable">
      <thead><tr><th>Ù†Ø§Ù…</th><th>Ø§ÛŒÙ…ÛŒÙ„</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

  <!-- Û³) ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€ŒÙ‡Ø§ -->
  <div class="section-panel" id="sellers-panel" style="display:none;">
    <div class="content-header">ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€ŒÙ‡Ø§ <span class="header-count" id="header-sellers-count"></span></div>
    <div style="margin-bottom:1rem;display:flex;gap:0.5rem;align-items:center;">
  <input type="text" id="sellerSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù†Ø§Ù… ÙØ±ÙˆØ´Ú¯Ø§Ù‡ØŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ ÛŒØ§ Ø¢Ø¯Ø±Ø³..." 
         style="width:100%;max-width:400px;padding:0.7rem 1rem;border-radius:12px;border:1.5px solid #10b98144;font-size:1rem;font-family:inherit;outline:none;transition:border .15s;">
</div>
    <div class="sellers-filters" style="display:flex;gap:.7rem;margin-bottom:1.1rem;flex-wrap:wrap">
      <button class="seller-filter-btn active" data-sort="newest">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</button>
      <button class="seller-filter-btn" data-sort="oldest">Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ†</button>
      <button class="seller-filter-btn" data-sort="mostvisited">Ù¾Ø±Ø¨Ø§Ø²Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</button>
      <button class="seller-filter-btn" data-sort="mostproducts">Ù¾Ø±Ù…Ø­ØµÙˆÙ„â€ŒØªØ±ÛŒÙ†</button>
    </div>

    <div class="table-wrap">
      <table id="sellersTable">
        <thead>
          <tr>
            <th>Ù†Ø§Ù… ÙØ±ÙˆØ´Ú¯Ø§Ù‡</th><th>Ù†Ø§Ù… ØµØ§Ø­Ø¨ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</th><th>Ø¢Ø¯Ø±Ø³ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</th>
            <th>Ù„ÛŒÙ†Ú© ÙØ±ÙˆØ´Ú¯Ø§Ù‡</th><th>ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­ØµÙˆÙ„Ø§Øª</th><th>Ø¨Ø§Ø²Ø¯ÛŒØ¯</th><th>Ù†Ù…Ø±Ù‡ Ø§Ø¯Ù…ÛŒÙ†</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Û´) Ù…Ø­ØµÙˆÙ„Ø§Øª -->
  <div class="section-panel" id="products-panel" style="display:none;">
    <div class="content-header">Ù…Ø­ØµÙˆÙ„Ø§Øª <span class="header-count" id="header-products-count"></span></div>

<!-- Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª -->
<div style="margin-bottom:1rem;display:flex;gap:0.5rem;align-items:center;">
  <input type="text" id="productSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ØŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ ÛŒØ§ ÙØ±ÙˆØ´Ú¯Ø§Ù‡..." 
         style="width:100%;max-width:400px;padding:0.7rem 1rem;border-radius:12px;border:1.5px solid #10b98144;font-size:1rem;font-family:inherit;outline:none;transition:border .15s;">
</div>

<!-- ÙÛŒÙ„ØªØ± Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª -->
<div class="products-filters" style="display:flex;gap:.7rem;margin-bottom:1.1rem;flex-wrap:wrap">
  <button class="seller-filter-btn active" data-sort="newest">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</button>
  <button class="seller-filter-btn" data-sort="oldest">Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ†</button>
</div>

    <div class="table-wrap">
      <table id="productsTable">
    <!-- productsTable â€“ header AFTER the change -->
<thead>
  <tr>
    <th>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</th>  <!-- Ø³ØªÙˆÙ† Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ -->
    <th>Ù†Ø§Ù… ÙØ±ÙˆØ´Ú¯Ø§Ù‡</th>
    <th>Ù†Ø§Ù… ØµØ§Ø­Ø¨ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</th>
    <th>Ø¢Ø¯Ø±Ø³ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</th>
    <th>Ù„ÛŒÙ†Ú© ÙØ±ÙˆØ´Ú¯Ø§Ù‡</th>
    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
  </tr>
</thead>

        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Ûµ) Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§ -->
  <div class="section-panel" id="plans-panel" style="display:none;">
    <div class="content-header">Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§</div>
    <div class="plans-center" style="flex-direction:column;gap:2.5rem;width:100%;max-width:1000px;">
      <form id="plansForm">
        <div>
          <input id="seller-phone-plans" type="text" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù‚ÛŒÙ…Øª Ø§Ø®ØªØµØ§ØµÛŒ)" style="width:100%;margin-bottom:1rem;padding:0.9rem 1.2rem;font-size:1.15rem;background:#f8fafc;border:1.8px solid #e0fdfa;border-radius:16px;outline:none;"/>
        </div>
        <div>
          <label for="plan-1month">Ø§Ø´ØªØ±Ø§Ú© Û± Ù…Ø§Ù‡Ù‡</label>
          <input id="plan-1month" type="number" />
        </div>
        <div>
          <label for="plan-3month">Ø§Ø´ØªØ±Ø§Ú© Û³ Ù…Ø§Ù‡Ù‡</label>
          <input id="plan-3month" type="number" />
        </div>
        <div>
          <label for="plan-12month">Ø§Ø´ØªØ±Ø§Ú© Û±Û² Ù…Ø§Ù‡Ù‡</label>
          <input id="plan-12month" type="number" />
        </div>
        <!-- VitriPlus Price Input -->
        <div class="mb-4">
          <label class="block text-right text-sm text-green-900 mb-1">Ù‚ÛŒÙ…Øª Ø§Ù…Ú©Ø§Ù†Ø§Øª ÙˆÛŒÚ˜Ù‡ (ÙˆÛŒØªØ±ÛŒâ€ŒÙ¾Ù„Ø§Ø³)</label>
          <input type="number" id="vitriPlusPrice" name="vitriPlusPrice"
                 placeholder="Ù…Ø«Ù„Ø§Ù‹ 30000"
                 class="w-full p-2 rounded-xl bg-green-100 text-green-800 text-sm text-right outline-none focus:ring-2 focus:ring-green-500"
                 dir="rtl">
        </div>
        <button type="submit">Ø°Ø®ÛŒØ±Ù‡ Ù‚ÛŒÙ…Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§</button>
        <div id="plansMsg" style="display:none;"></div>
      </form>
    </div>
  </div>

  <!-- Û¶) Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª ØªØ¨Ù„ÛŒØºØ§Øª (Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡) -->
  <div class="section-panel" id="ads-panel" style="display:none;">
    <div class="content-header">Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª ØªØ¨Ù„ÛŒØºØ§Øª</div>
    <div class="plans-center" style="flex-direction:column;gap:2.5rem;width:100%;max-width:1000px;">
      <form id="adsForm" class="priceForm">
        <div>
          <input id="seller-phone-ads" type="text" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù‚ÛŒÙ…Øª Ø§Ø®ØªØµØ§ØµÛŒ)" style="width:100%;margin-bottom:1rem;padding:0.9rem 1.2rem;font-size:1.15rem;background:#f8fafc;border:1.8px solid #e0fdfa;border-radius:16px;outline:none;"/>
        </div>
        <div>
          <label for="ad_search">ØªØ¨Ù„ÛŒØº Ø¬Ø³ØªØ¬Ùˆ</label>
          <input id="ad_search" type="number" />
        </div>
        <div>
          <label for="ad_home">ØªØ¨Ù„ÛŒØº ØµÙØ­Ù‡ Ø§ÙˆÙ„</label>
          <input id="ad_home" type="number" />
        </div>
        <div>
          <label for="ad_products">ØªØ¨Ù„ÛŒØº Ø¨ÛŒÙ† Ù…Ø­ØµÙˆÙ„Ø§Øª</label>
          <input id="ad_products" type="number" />
        </div>
        <button type="submit">Ø°Ø®ÛŒØ±Ù‡ Ù‚ÛŒÙ…Øª ØªØ¨Ù„ÛŒØºØ§Øª</button>
        <div id="adsMsg" style="display:none;"></div>
      </form>
    </div>
  </div>



<!-- Û·) Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
<div class="section-panel" id="messages-panel" style="display:none;">
  <div class="content-header">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ <span class="header-count" id="header-messages-count"></span></div>


<!-- ÙÛŒÙ„ØªØ± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
<!-- ÙÛŒÙ„ØªØ± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
<div class="messages-filters" style="display:flex;gap:0.7rem;margin-bottom:1.1rem;flex-wrap:wrap;">
  <button class="seller-filter-btn active" data-filter="seller">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</button>
  <button class="seller-filter-btn" data-filter="customer">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ</button>
  <button class="seller-filter-btn" data-filter="newest">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</button>
  <button class="seller-filter-btn" data-filter="oldest">Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ†</button>
  <button class="seller-filter-btn" data-filter="unanswered">Ù¾Ø§Ø³Ø®â€ŒÙ†Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
</div>



<!-- ğŸ“¢ Ú©Ø§Ø±Øª Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ -->
<!-- ğŸ“¢ Ú©Ø§Ø±Øª Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ -->
<div class="broadcast-card collapsed" id="broadcastCard">
  <div class="broadcast-header" id="broadcastHeader">
    <i class="ri-mail-send-line"></i>
    <h4>Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ</h4>
    <i class="ri-arrow-down-s-line toggle-icon" id="broadcastToggleIcon"></i>
  </div>
  <div class="broadcast-body" id="broadcastBody">
    <!-- Ø¨Ù‚ÛŒÙ‡ ÙØ±Ù… Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± -->
    <div class="broadcast-row">
      <label for="broadcastTarget">Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡:</label>
      <select id="broadcastTarget">
        <option value="sellers">ğŸ‘©â€ğŸ’¼ Ù‡Ù…Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€ŒÙ‡Ø§</option>
        <option value="customers">ğŸ›’ Ù‡Ù…Ù‡ Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§</option>
      </select>
    </div>
    <div class="broadcast-row">
      <label for="broadcastText">Ù…ØªÙ† Ù¾ÛŒØ§Ù…:</label>
      <textarea id="broadcastText" placeholder="Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯â€¦"></textarea>
    </div>
    <div class="broadcast-actions">
      <button onclick="sendBroadcastMessage()">Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…</button>
    </div>
    <p id="broadcastStatus" class="broadcast-status"></p>
  </div>
</div>




  <div class="table-wrap">
    <table id="messagesTable">
<thead>
  <tr>
    <th>Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯</th>
    <th>Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù…</th>
    <th>ÙØ±Ø³ØªÙ†Ø¯Ù‡</th>
    <th>ØªØ§Ø±ÛŒØ®</th>
    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
  </tr>
</thead>




      <tbody></tbody>
    </table>
  </div>
</div>



<!-- Ù¾Ù†Ù„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ -->
<div class="section-panel" id="reports-panel" style="display:none;">
  <p style="text-align:center">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ...</p>
</div>


</div><!-- /main-content -->










<script>
const API_BASE = "http://localhost:5000/api";
// Ø§Ú¯Ø± admin_token Ø³Øª Ù†Ø´Ø¯Ù‡ØŒ Ø§Ø² Ú©Ù„ÛŒØ¯ token Ù‡Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†

let messagesInterval = null;
let badgeInterval = null; // â¬…ï¸ ØªØ§ÛŒÙ…Ø± Ù…Ø¬Ø²Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ø¬

/**
 * Ø´Ø±ÙˆØ¹ polling Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù‡Ø± 5 Ø«Ø§Ù†ÛŒÙ‡
 */
function startMessagesPolling() {
  // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ ÛŒÚ© polling ÙØ¹Ø§Ù„ Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ù…ØªÙˆÙ‚Ù Ú©Ù†
  if (messagesInterval) clearInterval(messagesInterval);
  // ÙÙˆØ±Ø§Ù‹ ÛŒÚ©â€ŒØ¨Ø§Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ú¯ÛŒØ±
  fetchMessages().catch(console.error);
  // Ø³Ù¾Ø³ Ù‡Ø± 5 Ø«Ø§Ù†ÛŒÙ‡ ÛŒÚ©â€ŒØ¨Ø§Ø±
  messagesInterval = setInterval(() => {
    fetchMessages().catch(console.error);
  }, 5000);
}

/**
 * Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† polling
 */
function stopMessagesPolling() {
  if (messagesInterval) {
    clearInterval(messagesInterval);
    messagesInterval = null;
  }
}




/* Ø¨Ø¹Ø¯ Ø§Ø² const token = â€¦ Ø§ÛŒÙ† Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† */
function toIdString(raw) {
  if (!raw) return '';

  if (typeof raw === 'string') return raw;

  if (typeof raw === 'object') {
    if (raw.$oid) return String(raw.$oid);
    if (raw._id) return String(raw._id);
    if (raw.id) return String(raw.id);

    if (typeof raw.toString === 'function') {
      return raw.toString();
    }
  }

  return String(raw);
}

function escapeHtml(value) {
  if (value === null || value === undefined) return '';
  return String(value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function formatNoteForDisplay(note) {
  if (!note) return '';
  return escapeHtml(note).replace(/\n/g, '<br>');
}

function formatDateTime(value) {
  if (!value) return '';
  try {
    return new Date(value).toLocaleString('fa-IR', {
      dateStyle: 'medium',
      timeStyle: 'short'
    });
  } catch (err) {
    return '';
  }
}







// -------- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³ØªÛŒ Ø¢Ù…Ø§Ø± Ø¨Ø§Ø²Ø¯ÛŒØ¯ (ÙÛŒÚ©) --------
let days30 = Array.from({length: 30}, (_,i) => {
  let d = new Date();
  d.setDate(d.getDate() - (29-i));
  return d.toLocaleDateString('fa-IR', {month:'numeric', day:'numeric'});
});
let weekDays = ['Ø´Ù†Ø¨Ù‡', 'ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡'];
let last7daysIdx = (new Date().getDay() + 6) % 7;
let weekLabels = [];
for (let i=6;i>=0;i--) weekLabels.push(weekDays[(last7daysIdx-i+7)%7]);

let visitsPerDay = Array.from({length: 30}, (_,i)=> Math.round(60+Math.sin(i/3)*40+Math.random()*25));
let usersPerDay = Array(30).fill(0);
let sellersPerDay = Array(30).fill(0);
let productsPerDay = Array(30).fill(0);

let usersList = [];
let shopsList = [];
let productsList = [];
let productsSortMode = 'newest';  // Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ
let productSearchQuery = '';      // Ú©ÙˆØ¦Ø±ÛŒ Ø¬Ø³ØªØ¬Ùˆ (Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ±)

let sellerPerformanceMap = {};
let sellerPerformanceLoaded = false;

function normaliseScoreKey(id) {
  if (!id) return '';
  return toIdString(id);
}

function resolveSellerKeyFromShop(shop) {
  if (!shop) return '';
  const candidate =
    shop._sid ||
    shop.sellerId ||
    shop.seller_id ||
    (shop.shopurl ? `shopurl:${shop.shopurl}` : '') ||
    shop._id;
  return normaliseScoreKey(candidate);
}

function parsePerformancePayload(payload) {
  if (!payload || typeof payload !== 'object') return null;

  const sellerId = payload.sellerId ? toIdString(payload.sellerId) : '';
  const shopurl = payload.shopurl || '';
  const note = typeof payload.adminScoreNote === 'string'
    ? payload.adminScoreNote
    : (typeof payload.note === 'string' ? payload.note : '');
  const publicMessage = typeof payload.adminScoreMessage === 'string'
    ? payload.adminScoreMessage
    : (typeof payload.publicMessage === 'string' ? payload.publicMessage : '');
  const meta = {
    sellerId,
    shopurl,
    storename: payload.storename || '',
    adminScore: payload.adminScore != null ? Number(payload.adminScore) : null,
    updatedAt: payload.updatedAt || null,
    status: payload.status || 'unset',
    statusLabel: payload.statusLabel || 'Ù…Ù†ØªØ¸Ø± Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ',
    statusMessage: payload.statusMessage || '',
    severity: payload.severity || 'neutral',
    canStay: payload.canStay !== false,
    message: payload.message || '',
    adminScoreNote: note,
    note,
    adminScoreMessage: publicMessage,
    publicMessage
  };

  const aliasKeys = [];
  const addAlias = (value) => {
    const normalised = normaliseScoreKey(value);
    if (normalised && !aliasKeys.includes(normalised)) {
      aliasKeys.push(normalised);
    }
  };

  addAlias(payload.sellerKey);
  addAlias(sellerId);
  addAlias(payload._id);
  if (payload.seller && typeof payload.seller === 'object') {
    addAlias(payload.seller._id || payload.seller.id);
  }
  if (shopurl) addAlias(`shopurl:${shopurl}`);
  if (Array.isArray(payload.aliases)) {
    payload.aliases.forEach(addAlias);
  }

  const keyCandidate = payload.sellerKey || sellerId || (shopurl ? `shopurl:${shopurl}` : '');
  addAlias(keyCandidate);

  meta.sellerKey = aliasKeys.length ? aliasKeys[0] : '';
  meta.aliasKeys = aliasKeys;

  if (meta.sellerKey && !meta.aliasKeys.includes(meta.sellerKey)) {
    meta.aliasKeys.unshift(meta.sellerKey);
  }
  if (!meta.aliasKeys.length && meta.sellerKey) {
    meta.aliasKeys = [meta.sellerKey];
  }

  return meta;
}

function getSellerPerformanceByKey(key) {
  const normalised = normaliseScoreKey(key);
  if (!normalised) return null;
  return Object.prototype.hasOwnProperty.call(sellerPerformanceMap, normalised)
    ? sellerPerformanceMap[normalised]
    : null;
}

function getSellerScoreByKey(key) {
  const meta = getSellerPerformanceByKey(key);
  return meta && meta.adminScore != null ? meta.adminScore : null;
}

function getSellerScoreForShop(shop) {
  const key = resolveSellerKeyFromShop(shop);
  return key ? getSellerScoreByKey(key) : null;
}

async function refreshSellerPerformanceMap() {
  try {
    const res = await fetch(`${API_BASE}/sellers/performance`, {
      credentials: 'include'
    });

    let payload = null;
    try {
      payload = await res.json();
    } catch (err) {
      payload = null;
    }

    if (!res.ok) {
      const message = payload && payload.message ? payload.message : 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€ŒÙ‡Ø§.';
      throw new Error(message);
    }

    const records = Array.isArray(payload)
      ? payload
      : (Array.isArray(payload?.data) ? payload.data : []);

    const nextMap = {};
    records.forEach(item => {
      const meta = parsePerformancePayload(item);
      if (!meta) return;
      const keys = Array.isArray(meta.aliasKeys) && meta.aliasKeys.length
        ? meta.aliasKeys
        : (meta.sellerKey ? [meta.sellerKey] : []);
      keys.forEach(alias => {
        const normalised = normaliseScoreKey(alias);
        if (normalised) {
          nextMap[normalised] = meta;
        }
      });
    });

    sellerPerformanceMap = nextMap;
    sellerPerformanceLoaded = true;
    return true;
  } catch (err) {
    console.error('âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€ŒÙ‡Ø§:', err);
    sellerPerformanceLoaded = false;
    return false;
  }
}

async function setSellerScoreByKey(key, value, note, message) {
  const normalised = normaliseScoreKey(key);
  if (!normalised) throw new Error('Ø´Ù†Ø§Ø³Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ù…Ø±Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.');

  const body = { score: value };
  if (typeof note === 'string') {
    body.note = note;
  }
  if (typeof message === 'string') {
    body.message = message;
  }

  const res = await fetch(`${API_BASE}/sellers/performance/${encodeURIComponent(normalised)}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify(body)
  });

  let payload = null;
  try {
    payload = await res.json();
  } catch (err) {
    payload = null;
  }

  if (!res.ok) {
    const message = payload && payload.message ? payload.message : 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ù…Ø±Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡.';
    throw new Error(message);
  }

  const meta = parsePerformancePayload(payload);
  if (meta) {
    const keys = new Set([
      normalised,
      ...(Array.isArray(meta.aliasKeys) ? meta.aliasKeys : []),
      meta.sellerKey
    ]);
    keys.forEach(alias => {
      const keyAlias = normaliseScoreKey(alias);
      if (keyAlias) {
        sellerPerformanceMap[keyAlias] = meta;
      }
    });
  }
  sellerPerformanceLoaded = true;
  return meta;
}

async function setSellerScoreForShop(shop, value, note, message) {
  const key = resolveSellerKeyFromShop(shop);
  return key ? setSellerScoreByKey(key, value, note, message) : null;
}

async function clearSellerScoreByKey(key) {
  const normalised = normaliseScoreKey(key);
  if (!normalised) throw new Error('Ø´Ù†Ø§Ø³Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.');

  const res = await fetch(`${API_BASE}/sellers/performance/${encodeURIComponent(normalised)}`, {
    method: 'DELETE',
    credentials: 'include'
  });

  let payload = null;
  try {
    payload = await res.json();
  } catch (err) {
    payload = null;
  }

  if (!res.ok) {
    const message = payload && payload.message ? payload.message : 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù†Ù…Ø±Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡.';
    throw new Error(message);
  }

  const meta = parsePerformancePayload(payload);
  if (meta) {
    const keys = new Set([
      normalised,
      ...(Array.isArray(meta.aliasKeys) ? meta.aliasKeys : []),
      meta.sellerKey
    ]);
    keys.forEach(alias => {
      const keyAlias = normaliseScoreKey(alias);
      if (keyAlias) {
        sellerPerformanceMap[keyAlias] = meta;
      }
    });
  } else {
    delete sellerPerformanceMap[normalised];
  }
  sellerPerformanceLoaded = true;
  return meta;
}

async function clearSellerScoreForShop(shop) {
  const key = resolveSellerKeyFromShop(shop);
  return key ? clearSellerScoreByKey(key) : null;
}

let messagesList = [];




/* --- global name-maps ------------------------------------ */
/* --- global name-maps -------------------------------- */
let sellerNameById = {};   // { sellerId : "Ù†Ø§Ù… ÙØ±ÙˆØ´Ù†Ø¯Ù‡ / ÙØ±ÙˆØ´Ú¯Ø§Ù‡" }
let userNameById   = {};   // { userId   : "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±" }

/* -------------------- buildNameMaps (FIXED) -------------------- */
/**
 * ØªÙ…Ø§Ù… Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù…Ú©Ù† ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ù‡ Â«Ù‚Ø§Ø¨Ù„â€ŒÙ†Ù…Ø§ÛŒØ´â€ŒØªØ±ÛŒÙ†Â» Ù†Ø§Ù…Ø´Ø§Ù† Ù†Ú¯Ø§Ø´Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
 * Ø§ÙˆÙ„ÙˆÛŒØª Ù†Ø§Ù…â€ŒÙ‡Ø§ØŒ Ø§Ø² ØµØ±ÛŒØ­â€ŒØªØ±ÛŒÙ† (Ù‡Ù…Ø±Ø§Ù‡ Ú†Øª) ØªØ§ Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒØ´Ø¯Ù‡ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§Ø³Øª.
 */
function normSellerId(id) {
  // Ø§Ú¯Ø± Ø±Ø´ØªÙ‡ Ø®Ø§Ù„ÛŒ ÛŒØ§ undefined Ø¨ÙˆØ¯
  if (!id) return '';
  // Ø§Ú¯Ø± Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ù‡Ù… shopurl: Ø¨ÙˆØ¯
  if (typeof id !== 'string') id = String(id);
  if (id.startsWith('shopurl:')) return id;
  // Ø§Ú¯Ø± ÙÙ‚Ø· Ø§Ø³Ù„Ø§Ú¯ Ù‡Ø³Øª
  return 'shopurl:' + id;
}

function buildNameMaps() {
  sellerNameById = {};

  // ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§
  shopsList.forEach(shop => {
    const ids = [
      shop._id, shop._sid, shop.id,
      shop.sellerId, shop.seller_id,
      shop.shopurl
    ].filter(Boolean).map(toIdString);

    const label = (shop.ownerName || '').trim() ||
      (`${shop.ownerFirstname || ''} ${shop.ownerLastname || ''}`).trim() ||
      shop.storename || shop.storeName || shop.shopLogoText || 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';

    ids.forEach(id => { 
      if (id) sellerNameById[normSellerId(id)] = label; 
    });
  });

  // Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ - Ù†Ø§Ù… ØµØ±ÛŒØ­ ÙØ±ÙˆØ´Ù†Ø¯Ù‡
  messagesList.forEach(chat => {
    const ids = [
      chat.sellerId,
      chat.shopurl,
      chat.seller?._id,
      chat.seller?.id
    ].filter(Boolean).map(toIdString);

    const label =
      (chat.sellerName || chat.storeName ||
        chat.seller?.storename || chat.seller?.ownerName || '').trim();

    if (label)
      ids.forEach(id => { 
        if (id) sellerNameById[normSellerId(id)] = label; 
      });
  });

  // Patch: shopurl â†’ sellerId
  messagesList.forEach(chat => {
    const sid  = normSellerId(toIdString(chat.sellerId));
    const surl = normSellerId(toIdString(chat.shopurl));
    if (!sid || !surl) return;
    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…Ø·Ø§Ø¨Ù‚ shopurl
    const shop = shopsList.find(s => normSellerId(toIdString(s.shopurl)) === surl);
    if (!shop) return;
    // Ø¨Ø±Ú†Ø³Ø¨ ÙØ±ÙˆØ´Ú¯Ø§Ù‡
    const label =
      (shop.ownerName || '').trim() ||
      (`${shop.ownerFirstname||''} ${shop.ownerLastname||''}`).trim() ||
      shop.storename || shop.storeName || shop.shopLogoText || 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
    // ØºÙ†ÛŒâ€ŒØ³Ø§Ø²ÛŒ Ù†Ù‚Ø´Ù‡
    sellerNameById[sid] = label;
  });

  // Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§
  userNameById = {};
  usersList.forEach(u => {
    const ids = [
      u._id, u.id, u.userId, u.user_id, u.customerId
    ].filter(Boolean).map(toIdString);

    const label =
      (u.fullName || u.fullname || '').trim() ||
      (`${u.firstName || u.firstname || ''} ${u.lastName || u.lastname || ''}`).trim() ||
      u.name || u.username || u.phone || 'Ù…Ø´ØªØ±ÛŒ';

    ids.forEach(id => { 
      if (id) userNameById[id] = label; 
    });
  });

  // Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ - Ù†Ø§Ù… ØµØ±ÛŒØ­ Ù…Ø´ØªØ±ÛŒ
  messagesList.forEach(chat => {
    const id = toIdString(chat.customerId || chat.userId);
    const name = (chat.customerName || chat.userName || '').trim();
    if (id && name) userNameById[id] = name;
  });
}







// â† Ù‡Ù…ÛŒÙ†Ø¬Ø§ØŒ Ø¯Ø±Ø³Øª Ø¨Ø¹Ø¯ Ø§Ø² let messagesList = [];
/* ------------------------------- fetchMessages (FIXED) ------------------------------ */
async function fetchMessages() {
  console.log('âš™ï¸ fetchMessages called');

const res = await fetch(`${API_BASE}/chats/all`, { credentials: 'include' });

  const data = await res.json();

  if (!res.ok) {
    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ú©Ø´ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§:', data);
    throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ú©Ø´ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§');
  }

  /* Û±) Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ */
  messagesList = Array.isArray(data) ? data : (data.chats || []);

  /* Û²) Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø®ÙˆØ¯ Ú†Øª (Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„) */
  messagesList.forEach(c => {
    if (c.sellerId)   c.sellerId   = toIdString(c.sellerId);
    if (!c.sellerId && c.shopurl)
  c.sellerId = 'shopurl:' + c.shopurl;     // â† Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯

    if (c.customerId) c.customerId = toIdString(c.customerId);
  });

  /* Û³) Ù…Ù¾ Ù†Ø§Ù…â€ŒÙ‡Ø§ Ø±Ø§ Â«Ø¨Ø¹Ø¯ Ø§Ø²Â» Ø¯Ø§Ø´ØªÙ† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø³Ø§Ø²ÛŒÙ… */
  buildNameMaps();

  /* Û´) Ø¢Ù¾Ø¯ÛŒØª Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡â€ŒÙ‡Ø§ */
  updateSidebarCounts();
  updateHeaderCounts();

  /* Ûµ) Ø§Ú¯Ø± Ù¾Ù†Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù‡Ù…ÛŒÙ† Ø­Ø§Ù„Ø§ Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ø¬Ø¯ÙˆÙ„ Ø±Ø§ ÙÙˆØ±Ø§Ù‹ Ø±Ù†Ø¯Ø± Ú©Ù† */
  if (panels.messages.style.display !== 'none') {
    renderMessages();
  }
}




function getTotalUnreadMessages() {
  let total = 0;
  messagesList.forEach(chat => {
    if (Array.isArray(chat.messages)) {
      total += chat.messages.filter(
        m => (m.from === 'seller' || m.from === 'user') && !m.read
      ).length;
    }
  });
  return total;
}








/* ------------------ helpers/name-utils.js ------------------ */

/**
 * ÛŒÚ© Ø±Ø´ØªÙ‡ Ø±Ø§ Ù†Ø±Ù…Ø§Ù„Ø§ÛŒØ² Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Ø­Ø°Ù ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ·Ø±Ù Ùˆ Ú†Ù†Ø¯ space Ù¾ÛŒØ§Ù¾ÛŒ)
 */
function clean(str = '') {
  return String(str).replace(/\s+/g, ' ').trim();
}

/**
 * Ø§Ø² ÛŒÚ© Ø´ÛŒØ¡ (ÛŒØ§ Ø­ØªÛŒ Ø±Ø´ØªÙ‡) Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ù†Ø§Ù… Ù‚Ø§Ø¨Ù„â€ŒÙ†Ù…Ø§ÛŒØ´ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù†Ø¯.
 * Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…ØªØ¯Ø§ÙˆÙ„ + Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ (Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù† Ø¯ÙˆÙ…) Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
 */
function extractName(obj, extraKeys = []) {
  if (!obj) return '';

  // Ø§Ú¯Ø± Ø®ÙˆØ¯Ù ÙˆØ±ÙˆØ¯ÛŒ Ø±Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
  if (typeof obj === 'string') return clean(obj);

  // Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø±Ø§ÛŒØ¬
  const commonKeys = [
    'fullName', 'fullname', 'name', 'username',      // Ø¹Ù…ÙˆÙ…ÛŒ
    'storename', 'storeName',                        // ÙØ±ÙˆØ´Ù†Ø¯Ù‡
    'ownerName',                                     // ÙØ±ÙˆØ´Ù†Ø¯Ù‡
    'firstName', 'firstname', 'lastName', 'lastname' // Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
  ];

  for (const k of [...commonKeys, ...extraKeys]) {
    if (obj[k]) return clean(obj[k]);
  }

  // Ø­Ø§Ù„Øª first/last Ø¬Ø¯Ø§
  if (obj.firstName || obj.firstname || obj.lastName || obj.lastname) {
    return clean(
      `${obj.firstName || obj.firstname || ''} ${obj.lastName || obj.lastname || ''}`
    );
  }

  return '';
}

/* --------------- core/getSenderName.js ---------------- */

/**
 * Ø¨Ø§ Ø¯Ø±Ù†Ø¸Ø±Ú¯Ø±ÙØªÙ† Ø§Ù†ÙˆØ§Ø¹ Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ù…Ù…Ú©Ù† Ù¾ÛŒØ§Ù…ØŒ Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´â€ŒØ¯Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡Ù” ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯.
 * Ù‡Ù…ÛŒØ´Ù‡ ÛŒÚ© Ù…Ù‚Ø¯Ø§Ø± Â«ØºÛŒØ±ÙØ§Ù„Ø³Ù€ÛŒÂ» (Ø­Ø¯Ø§Ù‚Ù„ Ø¹Ù†ÙˆØ§Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶) Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.
 */
/* --------------- core/getSenderName.js ---------------- */
/**
 * Ø¨Ø±Ø§Ù‰ Ù‡Ø± Ù¾ÛŒØ§Ù… Ø¨Ø±Ú†Ø³Ø¨ Â«ÙØ±Ø³ØªÙ†Ø¯Ù‡Â» Ø±Ø§ Ø¨Ø±Ù…Ù‰â€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯.
 * Ø§ÙˆÙ„ÙˆÛŒØª: Ù†Ø§Ù… ØµØ±ÛŒØ­ Ø¯Ø± Ø®ÙˆØ¯ Ù¾ÛŒØ§Ù… â†’ Ù†Ø§Ù… ØµØ±ÛŒØ­ Ø¯Ø± Ø´ÛŒØ¡ chat â†’ mapÙ‡Ø§ â†’ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ â†’ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
/* -------------------- getSenderName (FIXED) -------------------- */
/**
 * Ù†Ø§Ù… Ù‚Ø§Ø¨Ù„â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ±Ø³ØªÙ†Ø¯Ù‡Ù” ÛŒÚ© Ù¾ÛŒØ§Ù… Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯.
 * Ø§ÙˆÙ„ÙˆÛŒØª: Û±) Ù†Ø§Ù… ØµØ±ÛŒØ­ Ø¯Ø± Ø®ÙˆØ¯ Ù¾ÛŒØ§Ù…ØŒ Û²) Ù†Ø§Ù… ØµØ±ÛŒØ­ Ø¯Ø± Ø´ÛŒØ¡ chatØŒ
 * Û³) Ù…Ù¾â€ŒÙ‡Ø§ÛŒ Ø§Ø²Ù¾ÛŒØ´â€ŒØ³Ø§Ø®ØªÙ‡ØŒ Û´) Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ø¯Ø± Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ØŒ Ûµ) Ø¨Ø±Ú†Ø³Ø¨ Ù¾ÛŒØ´â€ŒÙØ±Ø¶.
 */
function getSenderName (chat = {}, msg = {}) {

  /* ---------- 1) Ù†Ø§Ù… ØµØ±ÛŒØ­ Ø¯Ø§Ø®Ù„ Ø®ÙˆØ¯ Ù¾ÛŒØ§Ù… ---------- */
  const explicitMsg =
    extractName(msg,         ['fromName', 'senderName', 'displayName']) ||
    extractName(msg.sender || {}, ['fromName', 'senderName', 'displayName']);
  if (explicitMsg) return explicitMsg;

  /* ---------- 2) Ù†Ø§Ù… ØµØ±ÛŒØ­ Ø¯Ø§Ø®Ù„ Ø´ÛŒØ¡ Chat ---------- */
  const explicitChat =
    extractName(chat, ['sellerName',   'seller_name',
                       'storeName',    'store_name',
                       'customerName', 'customer_name',
                       'userName',     'user_name',
                       'username']);
  if (explicitChat) return explicitChat;

  /* ---------- 3) ØªØ´Ø®ÛŒØµ Â«Ù†Ù‚Ø´Â» ÙØ±Ø³ØªÙ†Ø¯Ù‡ ---------- */
  let role = String(msg.from || chat.role || '').toLowerCase().trim();

  /* Ø§Ú¯Ø± Ù†Ù‚Ø´ ØµØ±ÛŒØ­ Ù†ÛŒØ³ØªØŒ Ø¨Ø§ ÙˆØ¬ÙˆØ¯ Ø´Ù†Ø§Ø³Ù‡ Ø­Ø¯Ø³ Ø¨Ø²Ù†ÛŒÙ… */
  if (!role) {
    if (msg.sellerId   || chat.sellerId   || chat.seller_id || chat.shopurl)
      role = 'seller';
    else if (msg.customerId || chat.customerId || chat.userId ||
             chat.customer_id || chat.user_id)
      role = 'customer';
    else if (msg.fromId === 'admin' || chat.admin)
      role = 'admin';
  }

  /* ---------- 4) ÙØ±ÙˆØ´Ù†Ø¯Ù‡ ---------- */
  if (role === 'seller') {
    const sid = toIdString(
      msg.sellerId || chat.sellerId || chat.seller_id ||
      msg.shopurl  || chat.shopurl  || ''
    );

    if (sellerNameById[sid]) return sellerNameById[sid];

    /* Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ø¯Ø± shopsList Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± */
    const shop = shopsList.find(s =>
      s._sid === sid || toIdString(s.shopurl) === sid
    );
    if (shop) {
      const name =
        (shop.ownerName || '').trim() ||
        (`${shop.ownerFirstname || ''} ${shop.ownerLastname || ''}`).trim() ||
        shop.storename || shop.storeName || '';
      if (name) return name;
    }
    return 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
  }

  /* ---------- 5) Ù…Ø´ØªØ±ÛŒ / Ú©Ø§Ø±Ø¨Ø± ---------- */
  if (role === 'customer' || role === 'user') {
    const uid = toIdString(
      msg.customerId   || chat.customerId   ||
      chat.customer_id || chat.userId       ||
      chat.user_id     || ''
    );

    if (userNameById[uid]) return userNameById[uid];

    /* fallback â†’ Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ø¯Ø± usersList */
    const user = usersList.find(u =>
      toIdString(u._id || u.id || u.userId || u.user_id) === uid
    );
    if (user) {
      const name =
        (user.fullName || user.fullname || '').trim() ||
        (`${user.firstName || user.firstname || ''} ${user.lastName || user.lastname || ''}`).trim() ||
        user.name || user.username || '';
      if (name) return name;
    }
    return 'Ù…Ø´ØªØ±ÛŒ';
  }

  /* ---------- 6) Ø§Ø¯Ù…ÛŒÙ† ÛŒØ§ ÙØ±Ø³ØªÙ†Ø¯Ù‡Ù” Ù†Ø§Ø´Ù†Ø§Ø³ ---------- */
  return 'Ø§Ø¯Ù…ÛŒÙ†';
}






/* â”€â”€â”€â”€â”€ 2) Ù†Ø³Ø®Ù‡Ù” Ù†Ù‡Ø§ÛŒÛŒÙ ØªØ§Ø¨Ø¹ renderMessages â”€â”€â”€â”€â”€ */
/* â”€â”€â”€â”€â”€ Ù†Ø³Ø®Ù‡Ù” Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡â€ŒÛŒ ØªØ§Ø¨Ø¹ renderMessages â”€â”€â”€â”€â”€ */
function renderMessages() {
  const tbody = document.querySelector('#messagesTable tbody');
  tbody.innerHTML = '';

  // 1. Ú©Ù¾ÛŒ Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ùˆ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ
  let chats = [...messagesList];
  
  // 2. Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±Ù‡Ø§
  if (messagesFilterMode === 'seller') {
    chats = chats.filter(chat => chat.sellerId);
  } else if (messagesFilterMode === 'customer') {
    chats = chats.filter(chat => !chat.sellerId);
  } else if (messagesFilterMode === 'unanswered') {
    chats = chats.filter(chat => {
      const msgs = chat.messages || [];
      return msgs.length > 0 && msgs[msgs.length - 1].from !== 'admin';
    });
  }

  // 3. Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ®
  chats.sort((a, b) => {
    const aLastMsg = a.messages[a.messages.length - 1];
    const bLastMsg = b.messages[b.messages.length - 1];
    const aTime = aLastMsg ? new Date(aLastMsg.createdAt || aLastMsg.date).getTime() : 0;
    const bTime = bLastMsg ? new Date(bLastMsg.createdAt || bLastMsg.date).getTime() : 0;
    
    return messagesFilterMode === 'oldest' ? aTime - bTime : bTime - aTime;
  });

  // 4. Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯Ù† Ù„ÛŒØ³Øª Ù¾Ø³ Ø§Ø² ÙÛŒÙ„ØªØ±
  if (chats.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align:center;color:#888;padding:1.5rem">
          ${getEmptyFilterMessage()}
        </td>
      </tr>`;
    return;
  }

  // 5. Ø±Ù†Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡
  chats.forEach(chat => {
    const msgs = chat.messages || [];
    const lastMsg = msgs[msgs.length - 1];
    const senderMsg = msgs.slice().reverse().find(m => m.from !== 'admin') || lastMsg;

    const senderLabel = getSenderName(chat, senderMsg);
    const unreadCount = msgs.filter(m => (m.from === 'seller' || m.from === 'user') && !m.read).length;

    const fullText = lastMsg && lastMsg.text ? lastMsg.text : '-';
    const shortText = fullText.length > 36 ? fullText.slice(0, 36) + 'â€¦' : fullText;

    const raw = lastMsg && (lastMsg.createdAt || lastMsg.date);
    const dt = raw ? new Date(raw) : null;
    const faDate = (dt && !isNaN(dt.valueOf()))
      ? dt.toLocaleString('fa-IR', {
          hour12: false,
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        })
      : 'â€”';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:center;color:#10b981;font-weight:bold">
        ${unreadCount
          ? `<span style="background:#eafaf4;border-radius:8px;padding:2px 10px">${unreadCount}</span>`
          : 'Û°'
        }
      </td>
      <td>${shortText}</td>
      <td class="msg-sender-cell"
          style="cursor:pointer;color:#0ea5e9;font-weight:bold">
        ${senderLabel}
      </td>
      <td>${faDate}</td>
        <td>
          <button class="action-btn delete" onclick="deleteMessage('${chat._id}')">Ø­Ø°Ù</button>
          <button class="action-btn view" onclick="openChatModal('${chat._id}')">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>
          ${chat.blockedByAdmin
            ? `<button class="action-btn unblock" onclick="unblockSender('${chat._id}')">Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù†</button>`
            : `<button class="action-btn block" onclick="blockSender('${chat._id}')">Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ</button>`}

        </td>`;
    
    tbody.appendChild(tr);

    // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ø³ØªÙ†Ø¯Ù‡
    tr.querySelector('.msg-sender-cell').addEventListener('click', () => {
      openSenderModal(chat);
    });
  });
}

// ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ§Ù… Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙÛŒÙ„ØªØ±
function getEmptyFilterMessage() {
  switch(messagesFilterMode) {
    case 'seller':
      return 'Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ Ø§Ø² ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€ŒÙ‡Ø§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
    case 'customer':
      return 'Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ Ø§Ø² Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
    case 'unanswered':
      return 'Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù… Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
    case 'oldest':
      return 'Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù… Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
    default:
      return 'Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
  }
}









// ----------------- ÙÛŒÙ„ØªØ± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -----------------
// ----------------- ÙÛŒÙ„ØªØ± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -----------------
// â€”â€”â€” Ú©Ø¯ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡Ù” ÙÛŒÙ„ØªØ± Ùˆ Ø±Ù†Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ â€”â€”â€”
let messagesFilterMode = 'seller'; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡

// ØªÙ†Ø¸ÛŒÙ… Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ÙÛŒÙ„ØªØ±
document.querySelectorAll('.messages-filters button').forEach(btn => {
  btn.addEventListener('click', () => {
    // Ø­Ø°Ù active Ø§Ø² Ù‡Ù…Ù‡ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ú©Ù„ÛŒÚ©â€ŒØ´Ø¯Ù‡
    document.querySelectorAll('.messages-filters button')
      .forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // ØªØ¹ÛŒÛŒÙ† Ø­Ø§Ù„Øª ÙÛŒÙ„ØªØ±
    messagesFilterMode = btn.getAttribute('data-filter');
    renderMessages();
  });
});


// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”





// Ù‡Ù†Ø¯Ù„ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ ÙØ±Ø³ØªÙ†Ø¯Ù‡ (Ù…ÛŒâ€ŒØªÙˆÙ†Ù‡ Ø¨Ø§Ú©Ø³ ÛŒØ§ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ø² Ú©Ù†Ù‡)
function showSenderDetails(sellerId, label) {
  if (label !== 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡') return;
  alert(`Ù…Ø´Ø®ØµØ§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (ID: ${sellerId})`);
}


async function deleteMessage(chatId) {
  if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú†Øª Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) return;

  try {
    const res = await fetch(`${API_BASE}/chats/${chatId}`, {
      method: 'DELETE',
      credentials: 'include'
    });

    if (!res.ok) {
      const data = await res.json();
      throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú†Øª');
    }

    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª
    messagesList = messagesList.filter(c => c._id !== chatId);
    renderMessages();
    updateSidebarCounts();

  } catch (err) {
    alert('âŒ ' + (err.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú†Øª'));
    console.error(err);
  }
}




// Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø§Ø² Ø¬Ø¯ÙˆÙ„
async function blockSender(chatId) {
  const chat = messagesList.find(c => c._id === chatId) || {};
  
  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ targetId Ùˆ targetRole Ø§Ø² participants
  let targetRole = 'user'; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ø´ØªØ±ÛŒ
  let targetId = null;
  
  if (chat.participants && chat.participants.length > 1) {
    const nonAdmin = chat.participants.find(p => p.role !== 'admin');
    if (nonAdmin) {
      targetId = nonAdmin._id;
      targetRole = nonAdmin.role === 'seller' ? 'seller' : 'user';
    }
  } else if (chat.sellerId) {
    targetId = chat.sellerId;
    targetRole = 'seller';
  } else if (chat.customerId || chat.userId) {
    targetId = chat.customerId || chat.userId;
    targetRole = 'user';
  }

  const label = targetRole === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : 'Ù…Ø´ØªØ±ÛŒ';
  if (!targetId) return alert('Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.');

  if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† ${label} Ø±Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ù†ÛŒØ¯ØŸ`)) return;

  try {
    console.log('blockSender ->', { targetId, targetRole });
    const res = await fetch(`${API_BASE}/chats/block-target`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targetId, targetRole })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ');

    alert('âœ… ' + (data.message || 'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯.'));
    await fetchMessages();
  } catch (err) {
    console.error('âŒ blockSender error:', err);
    alert('âŒ ' + err.message);
  }
}

async function unblockSender(chatId) {
  const chat = messagesList.find(c => c._id === chatId) || {};
  
  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ targetId Ùˆ targetRole Ø§Ø² participants
  let targetRole = 'user';
  let targetId = null;
  
  if (chat.participants && chat.participants.length > 1) {
    const nonAdmin = chat.participants.find(p => p.role !== 'admin');
    if (nonAdmin) {
      targetId = nonAdmin._id;
      targetRole = nonAdmin.role === 'seller' ? 'seller' : 'user';
    }
  } else if (chat.sellerId) {
    targetId = chat.sellerId;
    targetRole = 'seller';
  } else if (chat.customerId || chat.userId) {
    targetId = chat.customerId || chat.userId;
    targetRole = 'user';
  }

  const label = targetRole === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : 'Ù…Ø´ØªØ±ÛŒ';
  if (!targetId) return alert('Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.');

  if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† ${label} Ø±Ø§ Ø¢Ø²Ø§Ø¯ Ú©Ù†ÛŒØ¯ØŸ`)) return;

  try {
    console.log('unblockSender ->', { targetId, targetRole });
    const res = await fetch(`${API_BASE}/chats/unblock-target`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targetId, targetRole })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒ');

    alert('âœ… ' + (data.message || 'Ú©Ø§Ø±Ø¨Ø± Ø¢Ø²Ø§Ø¯ Ø´Ø¯.'));
    await fetchMessages();
  } catch (err) {
    console.error('âŒ unblockSender error:', err);
    alert('âŒ ' + err.message);
  }
}



// -------- fetchers --------
// â† Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯ (Ø¬Ø§ÛŒÛŒ Ú©Ù‡ ØªØ§Ø¨Ø¹ fetchUsers ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª)
// Ø¨Ù‡ØªØ±Ù‡ Ø§ÛŒÙ† Ø®Ø·Ø§Ú¯ÛŒØ±ÛŒ Ø±Ùˆ Ù‡Ù… Ø¨Ù‡ ØªØ§Ø¨Ø¹ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯
// â† Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯ (Ø¬Ø§ÛŒÛŒ Ú©Ù‡ ØªØ§Ø¨Ø¹ fetchUsers ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª)
// â”€â”€â”€ Ø§ØµÙ„Ø§Ø­ ØªØ§Ø¨Ø¹ fetchUsers â”€â”€â”€
// Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù„ ØªØ§Ø¨Ø¹ Ù‚Ø¨Ù„ÛŒ Ú©Ù†ÛŒØ¯
async function fetchUsers() {
  try {
    const res = await fetch(`${API_BASE}/user`, {   // â† Ù…Ø³ÛŒØ± Ù…ÙØ±Ø¯
      credentials: 'include'
      });
    if (!res.ok) {
      console.error('Error fetching users:', res.status, await res.text());
      return [];
    }
    const data = await res.json();
    console.log('fetchUsers returned:', data);      // â† Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Ø¨Ø¨ÛŒÙ†ÛŒØ¯ Ø²ÛŒØ± Ú†Ù‡ Ú©Ù„ÛŒØ¯ÛŒ Ø¢Ø¨Ø¬Ú©ØªÙ Ú©Ø§Ø±Ø¨Ø±Ù‡Ø§Ø³Øª
    // Ø§Ú¯Ø± Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø³Øª:
    if (Array.isArray(data)) return data;
    // Ø§Ú¯Ø± Ø²ÛŒØ± ÙÛŒÙ„Ø¯ users ÛŒØ§ data Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØªÙ‡:
    if (Array.isArray(data.users)) return data.users;
    if (Array.isArray(data.data))  return data.data;
    return [];
  } catch (err) {
    console.error('Exception in fetchUsers:', err);
    return [];
  }
}


async function fetchShops() {
  const res = await fetch(API_BASE + '/shops', {
    credentials: 'include'
  });
  const data = await res.json();
  return Array.isArray(data) ? data : (data.shops || data.data || []);
}

async function ensureShopsLoaded() {
  if (!shopsList.length) {
    shopsList = await fetchShops();
  }
}

async function sellerExists(phone) {
  await ensureShopsLoaded();
  return shopsList.some(s => normalizePhone(s.ownerPhone || s.phone || s.shopPhone) === phone);
}
/* -------- fetchProducts (FIXED & ROBUST) -------- */
async function fetchProducts () {
  try {
    const res = await fetch(`${API_BASE}/products`, { credentials: 'include' });

    /* Ø§Ú¯Ø± Ù¾Ø§Ø³Ø® Ø®Ø·Ø§Ø³Øª ÛŒÚ© Ø¢Ø±Ø§ÛŒÙ‡Ù” Ø®Ø§Ù„ÛŒ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒÙ… */
    if (!res.ok) {
      console.error('fetchProducts â€“ HTTPâ€‘', res.status, await res.text());
      return [];
    }

    const data = await res.json();

    /* Ø¯Ø± Ø¨Ø³ÛŒØ§Ø±ÛŒ Ø§Ø² Ø¨Ú©â€‘Ø§ÙÙ†Ø¯Ù‡Ø§ Ø¯Ø§Ø¯Ù‡Ù” ÙˆØ§Ù‚Ø¹ÛŒ Ø²ÛŒØ± Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…ØªÙØ§ÙˆØª Ø§Ø³Øª */
    const productsArr =
          (Array.isArray(data)                    ? data                     :
          Array.isArray(data.products)            ? data.products            :
          Array.isArray(data.items)               ? data.items               :
          Array.isArray(data.allProducts)         ? data.allProducts         :
          Array.isArray(data.data?.products)      ? data.data.products       :
          Array.isArray(data.data?.items)         ? data.data.items          :
          []);

    return productsArr;
  } catch (err) {
    console.error('fetchProducts â€“ EXCEPTION', err);
    return [];
  }
}


// -------- Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ Ø¬Ø¯Ø§ÙˆÙ„ --------
function updateDashboardCards() {
  document.getElementById('visit-today').textContent = visitsPerDay[visitsPerDay.length-1];
  document.getElementById('register-user-today').textContent = usersPerDay[usersPerDay.length-1];
  document.getElementById('register-seller-today').textContent = shopsList.length;
  document.getElementById('products-total').textContent = productsList.length;
}
function updateSidebarCounts() {
  document.getElementById('count-users').textContent    = usersList.length;
  document.getElementById('count-sellers').textContent  = shopsList.length;
  document.getElementById('count-products').textContent = productsList.length;

  const unread = getTotalUnreadMessages();
  // ÙÙ‚Ø· Ø§Ú¯Ø± Ø¹Ø¯Ø¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
  document.getElementById('count-messages').textContent = unread > 0 ? unread : '';
}
function updateHeaderCounts() {
  document.getElementById('header-users-count').textContent    = `(${usersList.length} Ú©Ø§Ø±Ø¨Ø±)`;
  document.getElementById('header-sellers-count').textContent  = `(${shopsList.length} ÙØ±ÙˆØ´Ú¯Ø§Ù‡)`;
  document.getElementById('header-products-count').textContent = `(${productsList.length} Ù…Ø­ØµÙˆÙ„)`;

  const unread = getTotalUnreadMessages();
  // Ø§Ú¯Ø± ØµÙØ± Ø¨ÙˆØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ù†ÙˆÛŒØ³
  document.getElementById('header-messages-count').textContent =
    unread > 0 ? `(${unread} Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯)` : '';
}




// -------- Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† --------
// -------- Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† --------
function renderUsers(filteredUsers = usersList) {
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  filteredUsers.forEach((user, i) => {
    const fullName = `${user.firstname || user.name || ''} ${user.lastname || ''}`.trim();
    const contact = user.email || user.phone || '';
    let tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="user-cell user-modal-trigger" style="cursor:pointer;color:#10b981;font-weight:bold">${fullName}</td>
      <td class="user-cell user-modal-trigger" style="cursor:pointer">${contact}</td>
      <td>
        <button class="action-btn delete" onclick="deleteUser(${i})"><i class="ri-delete-bin-line"></i> Ø­Ø°Ù</button>
        ${user.blockedByAdmin
          ? `<button class="action-btn unblock" onclick="unblockUser('${user._id || user.id}', ${i})">Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù†</button>`
          : `<button class="action-btn block" onclick="blockUser('${user._id || user.id}', ${i})">Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ</button>`}
      </td>
    `;
    // Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù‡Ø± Ø³Ù„ÙˆÙ„ Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ©
    Array.from(tr.querySelectorAll('.user-modal-trigger')).forEach(td=>{
      td.onclick = () => showUserModal(user);
    });
    tbody.appendChild(tr);
  });
  if (!filteredUsers.length) {
    tbody.innerHTML = `<tr><td colspan="3" style="color:#888;text-align:center">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>`;
  }
}

// Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
function showUserModal(user) {
  const overlay = document.getElementById('user-modal-overlay');
  const uid = toIdString(user._id || user.id || '');
  const fullName = `${user.firstname || ''} ${user.lastname || ''}`.trim() || user.name || '-';
  const fDate = d => d ? new Date(d).toLocaleDateString('fa-IR',{year:'numeric',month:'long',day:'numeric'}) : 'â€”';

  const modalHtml = `
    <div class="user-modal">
      <button class="user-modal-close" onclick="closeUserModal()">Ã—</button>
      <div class="user-modal-title">
        Ù…Ø´Ø®ØµØ§Øª Ú©Ø§Ø±Ø¨Ø±:
        <span style="color:#0ea5e9">${fullName}</span>
      </div>
      <div class="user-modal-row">
        <span class="user-modal-label">Ù†Ø§Ù…:</span>
        <span class="user-modal-value">${user.firstname || '-'}</span>
      </div>
      <div class="user-modal-row">
        <span class="user-modal-label">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</span>
        <span class="user-modal-value">${user.lastname || '-'}</span>
      </div>
      <div class="user-modal-row">
        <span class="user-modal-label">Ø§ÛŒÙ…ÛŒÙ„:</span>
        <span class="user-modal-value">${user.email || '-'}</span>
      </div>
      <div class="user-modal-row">
        <span class="user-modal-label">ØªÙ„ÙÙ†:</span>
        <span class="user-modal-value">${user.phone || '-'}</span>
      </div>
      <div class="user-modal-row">
        <span class="user-modal-label">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…:</span>
        <span class="user-modal-value">${fDate(user.createdAt)}</span>
      </div>
      <form id="userMessageForm" class="user-modal-form" data-user-id="${uid}">
        <label for="userMessage">Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±:</label>
        <textarea id="userMessage" name="msg" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯â€¦" required></textarea>
        <button type="submit">Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…</button>
        <div id="user-modal-success" class="user-modal-success" style="display:none"></div>
      </form>
    </div>`;

  overlay.innerHTML = modalHtml;
  overlay.style.display = 'flex';

  document.getElementById('userMessageForm').addEventListener('submit', sendUserMessage);
}

function closeUserModal() {
  document.getElementById('user-modal-overlay').style.display = "none";
  document.getElementById('user-modal-overlay').innerHTML = "";
}

async function sendUserMessage(e) {
  e.preventDefault();
  const form = e.currentTarget;
  const uid = form.dataset.userId;
  const text = form.querySelector('textarea').value.trim();

  if (!text) return alert('Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.');
  if (!uid) return alert('Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!');

  try {
    // Ø§Ø¨ØªØ¯Ø§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ú©Ù† Ú©Ù‡ Ú†Øª Ø¨ÛŒÙ† Ø§Ø¯Ù…ÛŒÙ† Ùˆ Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
    const ensureRes = await fetch(`${API_BASE}/chats/ensure`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ recipientId: uid, recipientRole: 'user' })
    });
    const chat = await ensureRes.json();
    if (!ensureRes.ok) throw new Error(chat.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú¯ÙØªÚ¯Ùˆ');

    // Ø³Ù¾Ø³ Ù¾ÛŒØ§Ù… Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± Ø¢Ù† Ú†Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†
    const res = await fetch(`${API_BASE}/chats/${chat._id}/admin-reply`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ text })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…');

    form.querySelector('textarea').value = '';
    const okBox = document.getElementById('user-modal-success');
    okBox.textContent = 'âœ… Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!';
    okBox.style.display = 'block';
    setTimeout(() => okBox.style.display = 'none', 2500);
  } catch (err) {
    console.error('sendUserMessage error:', err);
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…:\n' + err.message);
  }
}
// Ø¬Ø³ØªØ¬Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
document.getElementById('userSearch').addEventListener('input', e => {
  const q = e.target.value.trim().toLowerCase();
  const filtered = usersList.filter(u => {
    return (
      (u.firstname || '').toLowerCase().includes(q) ||
      (u.lastname || '').toLowerCase().includes(q) ||
      (u.name || '').toLowerCase().includes(q) ||
      (u.phone || '').toLowerCase().includes(q)
    );
  });
  renderUsers(filtered);
});


// Ø¬Ø³ØªØ¬Ùˆ Ù…Ø­ØµÙˆÙ„Ø§Øª
document.getElementById('productSearch').addEventListener('input', e => {
  productSearchQuery = e.target.value.trim().toLowerCase();
  renderProducts();
});

// ÙÛŒÙ„ØªØ± Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª
document.querySelectorAll('.products-filters button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.products-filters button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    productsSortMode = btn.getAttribute('data-sort');
    renderProducts();
  });
});

// -------- Ù†Ù…Ø§ÛŒØ´ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ --------







window.deleteSeller = async function(id) {
  const idx = shopsList.findIndex(s =>
    toIdString(s.sellerId) === id ||
    toIdString(s.seller_id) === id ||
    toIdString(s._id) === id ||
    toIdString(s._sid) === id ||
    toIdString(s.shopurl) === id
  );
  const shop = shopsList[idx];
  if (!shop) return alert('ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!');
  const name = shop.storename || shop.shopLogoText || 'Ø¨Ø¯ÙˆÙ†â€ŒÙ†Ø§Ù…';

  if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Â«${name}Â» Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) return;

  const sid = shop.sellerId || shop.seller_id || shop._id || shop._sid || null;
  if (!sid) return alert('Ø´Ù†Ø§Ø³Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');

  console.log('Deleting seller:', sid, name);

  try {
    const res = await fetch(`${API_BASE}/sellers/${encodeURIComponent(sid)}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙØ±ÙˆØ´Ù†Ø¯Ù‡');

    shopsList.splice(idx, 1);
    renderSellers();
    updateSidebarCounts();
    updateHeaderCounts();
    alert('âœ… ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.');
  } catch (err) {
    console.error('deleteSeller error:', err);
    alert('âŒ ' + err.message);
  }
};




/* ---------- helper : Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ÛŒÚ© Ù…Ø­ØµÙˆÙ„ ---------- */
function findShopForProduct(prod) {
  if (!prod) return null;

  /* 1) Ø¨Ø± Ø§Ø³Ø§Ø³ shopurl */
  if (prod.shopurl) {
    return shopsList.find(s => String(s.shopurl) === String(prod.shopurl));
  }

  /* 2) Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ù†Ø§Ø³Ù‡Ù” ÙØ±ÙˆØ´Ù†Ø¯Ù‡ */
  const sid = toIdString(prod.sellerId || prod.seller_id);
  if (sid) {
    return shopsList.find(s =>
      toIdString(s.sellerId || s.seller_id || s._sid) === sid
    );
  }
  return null;
}


// -------- Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„Ø§Øª --------
/* ---------- renderProducts (Ù†Ø³Ø®Ù‡Ù” Ø¬Ø¯ÛŒØ¯) ---------- */
/* -------- renderProducts (NO productâ€‘count column) -------- */
// -------- Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„Ø§Øª --------
function renderProducts() {
  const tbody = document.querySelector('#productsTable tbody');
  tbody.innerHTML = '';

  // Û±) Ú©Ù¾ÛŒ Ù„ÛŒØ³Øª Ùˆ Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ± Ø¬Ø³ØªØ¬Ùˆ
  let list = [...productsList];
  if (productSearchQuery) {
    list = list.filter(prod => {
      let shop = prod.seller || findShopForProduct(prod);
      return (
        (prod.title || prod.name || '').toLowerCase().includes(productSearchQuery) ||
        (shop?.storename || shop?.shopLogoText || '').toLowerCase().includes(productSearchQuery) ||
        (shop?.ownerName || `${shop?.ownerFirstname || ''} ${shop?.ownerLastname || ''}`.trim().toLowerCase()).includes(productSearchQuery)
      );
    });
  }

  // Û²) Ø§Ø¹Ù…Ø§Ù„ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ (ÙØ±Ø¶: ÙÛŒÙ„Ø¯ createdAt Ø¯Ø± Ù‡Ø± Ù…Ø­ØµÙˆÙ„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
  list.forEach(prod => {
    prod._createdAt = prod.createdAt ? new Date(prod.createdAt).getTime() : 0;
  });
  if (productsSortMode === 'newest') {
    list.sort((a, b) => b._createdAt - a._createdAt);
  } else if (productsSortMode === 'oldest') {
    list.sort((a, b) => a._createdAt - b._createdAt);
  }

  // Û³) Ø§Ú¯Ø± Ù„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#888;padding:1.5rem">Ù‡ÛŒÚ† Ù…Ø­ØµÙˆÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>`;
    return;
  }

  // Û´) Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª ÙÛŒÙ„ØªØ±Ø´Ø¯Ù‡/Ù…Ø±ØªØ¨â€ŒØ´Ø¯Ù‡
  list.forEach((prod, i) => {
    let shop = prod.seller || findShopForProduct(prod);
    const productName = prod.title || prod.name || '-';
    const storeName = shop ? (shop.storename || shop.shopLogoText || '-') : '-';
    const ownerName = shop ? (shop.ownerName || `${shop.ownerFirstname || ''} ${shop.ownerLastname || ''}`.trim() || '-') : '-';
    const storeAddr = shop ? (shop.address || shop.shopAddress || '-') : '-';
    const shopUrl = (shop ? shop.shopurl : (prod.shopurl || prod.shopUrl || '')) || '';
    const linkHTML = shopUrl ? `<a href="/shop.html?shopurl=${encodeURIComponent(shopUrl)}" target="_blank" style="color:#0ea5e9;text-decoration:underline">${shopUrl}</a>` : '-';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${productName}</td>
      <td>${storeName}</td>
      <td>${ownerName}</td>
      <td>${storeAddr}</td>
      <td>${linkHTML}</td>
      <td>
        <button class="action-btn edit" onclick="editProduct(${i})"><i class="ri-pencil-line"></i> ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="action-btn delete" onclick="deleteProduct(${i})"><i class="ri-delete-bin-line"></i> Ø­Ø°Ù</button>
      </td>`;
    tbody.appendChild(tr);
  });
}



// -------- Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„ --------
window.deleteProduct = async function (idx) {
  const prod = productsList[idx];
  if (!prod) return alert('Ù…Ø­ØµÙˆÙ„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!');
  
  if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù…Ø­ØµÙˆÙ„ "${prod.title || prod.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}" Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ`)) return;

  try {
    const res = await fetch(`${API_BASE}/products/${prod._id || prod.id}`, {
      method: 'DELETE',
      credentials: 'include'  // Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª (Ù…Ø«Ù„ admin_token)
    });

    if (!res.ok) {
      const data = await res.json();
      throw new Error(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„');
    }

    // Ø­Ø°Ù Ø§Ø² Ù„ÛŒØ³Øª Ù…Ø­Ù„ÛŒ Ùˆ Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯
    productsList.splice(idx, 1);
    renderProducts();
    updateSidebarCounts();
    updateHeaderCounts();
    alert('âœ… Ù…Ø­ØµÙˆÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.');

  } catch (err) {
    console.error('âŒ deleteProduct error:', err);
    alert('âŒ ' + err.message);
  }
};




window.deleteUser = async function (idx) {
  const user = usersList[idx];
  if (!user)        return alert('Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!');
  const name = `${user.firstname || ''} ${user.lastname || ''}`.trim()
               || user.name || user.phone || 'Ø¨Ø¯ÙˆÙ†â€ŒÙ†Ø§Ù…';

  if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Â«${name}Â» Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ
Ù¾Ø³ Ø§Ø² Ø­Ø°ÙØŒ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ø¯ÛŒÚ¯Ø± Ù‚Ø§Ø¯Ø± Ø¨Ù‡ ÙˆØ±ÙˆØ¯ ÛŒØ§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.`)) return;

  try {
    const res  = await fetch(`${API_BASE}/user/${user._id || user.id}`, {
      method      : 'DELETE',
      credentials : 'include'
    });
    const data  = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±');

    /* Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ø§Ø² Ø¢Ø±Ø§ÛŒÙ‡Ù” Ù…Ø­Ù„ÛŒ Ùˆ Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ Ø±Ø§Ø¨Ø· */
    usersList.splice(idx, 1);
    renderUsers();
    updateSidebarCounts();
    updateHeaderCounts();

    alert('âœ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ùˆ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯.');
  } catch (err) {
    console.error('deleteUser error:', err);
    alert('âŒ ' + err.message);
  }
};

window.blockUser = async function(id, idx) {
  if (!id) return alert('Ø´Ù†Ø§Ø³Ù‡ Ù…Ø¹ØªØ¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯');
  if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ù…Ø´ØªØ±ÛŒ Ø±Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ù†ÛŒØ¯ØŸ')) return;
  try {
    console.log('blockUser ->', { targetId: id, targetRole: 'user' });
    const res = await fetch(`${API_BASE}/chats/block-target`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targetId: id, targetRole: 'user' })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ');
    usersList[idx].blockedByAdmin = true;
    renderUsers();
    alert('âœ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯.');
  } catch (err) {
    console.error('blockUser error:', err);
    alert('âŒ ' + err.message);
  }
};

window.unblockUser = async function(id, idx) {
  if (!id) return alert('Ø´Ù†Ø§Ø³Ù‡ Ù…Ø¹ØªØ¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯');
  if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ù…Ø´ØªØ±ÛŒ Ø±Ø§ Ø¢Ø²Ø§Ø¯ Ú©Ù†ÛŒØ¯ØŸ')) return;
  try {
    console.log('unblockUser ->', { targetId: id, targetRole: 'user' });
    const res = await fetch(`${API_BASE}/chats/unblock-target`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targetId: id, targetRole: 'user' })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒ');
    usersList[idx].blockedByAdmin = false;
    renderUsers();
    alert('âœ… Ú©Ø§Ø±Ø¨Ø± Ø¢Ø²Ø§Ø¯ Ø´Ø¯.');
  } catch (err) {
    console.error('unblockUser error:', err);
    alert('âŒ ' + err.message);
  }
};








// -------- Nav & Responsive (FIXED) --------
// -------- Nav & Responsive (FIXED) --------
const sidebar       = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');
const menuLinks     = document.querySelectorAll('.sidebar-menu a');

// Ø¢Ø¨Ø¬Ú©Øª Ù¾Ù†Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ù‚Ø¨Ù„Ø§Ù‹ ØªØ¹Ø±ÛŒÙ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯:
const panels = {
  dashboard: document.getElementById('dashboard-panel'),
  users:     document.getElementById('users-panel'),
  sellers:   document.getElementById('sellers-panel'),
  products:  document.getElementById('products-panel'),
  plans:     document.getElementById('plans-panel'),
  ads:       document.getElementById('ads-panel'),
  messages:  document.getElementById('messages-panel'),
  'daily-visits': document.getElementById('daily-visits-panel')
};

menuLinks.forEach(link => {
  link.addEventListener('click', async e => {
    e.preventDefault();

    // 1) Ø§Ø³ØªØ§ÛŒÙ„Ù active Ø¯Ø± Ù…Ù†Ùˆ
    menuLinks.forEach(l => l.classList.remove('active'));
    link.classList.add('active');

    // 2) Ù…Ø®ÙÛŒ/Ù†Ù…Ø§ÛŒØ´Ù Ù¾Ù†Ù„â€ŒÙ‡Ø§
    Object.values(panels).forEach(p => p.style.display = 'none');
    const section = link.dataset.section;
    panels[section].style.display = 'block';

    // 3) Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡Ù” Ù‡Ø¯Ø±
    updateHeaderCounts();

    // 4) ÙˆÙ‚ØªÛŒ ÙˆØ§Ø±Ø¯ Ø¨Ø®Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø´Ø¯ÛŒÙ…ØŒ polling Ø±Ø§ Ø§Ø³ØªØ§Ø±Øª Ú©Ù†Ø›
    //    ÙˆÙ‚ØªÛŒ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒÙ…ØŒ polling Ø±Ø§ Ù…ØªÙˆÙ‚Ù Ú©Ù†.
    if (section === 'messages') {
      startMessagesPolling();
    } else {
      stopMessagesPolling();
    }

    // Ù„ÙˆØ¯ Ù…Ø­ØªÙˆØ§ÛŒ AJAX Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ø§Ø²Ø¯ÛŒØ¯
    if (section === 'daily-visits') {
      loadDailyVisContent();
    }

    // 5) Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
    if (window.innerWidth < 700) sidebar.classList.remove('open');
  });
});

// Ø¯Ú©Ù…Ù‡Ù” Ø¨Ø±Ú¯Ø± Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
document.body.addEventListener('click', e => {
  if (
    window.innerWidth < 700 &&
    sidebar.classList.contains('open') &&
    !sidebar.contains(e.target) &&
    e.target !== sidebarToggle
  ) {
    sidebar.classList.remove('open');
  }
});
window.addEventListener('resize', () => {
  if (window.innerWidth > 700) sidebar.classList.remove('open');
});


// -------- Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ --------
let chartObj;
let filterBtns = [
  {label: 'Ø§Ù…Ø±ÙˆØ²', value: 'today'},
  {label: 'Ø¯ÛŒØ±ÙˆØ²', value: 'yesterday'},
  {label: 'Û· Ø±ÙˆØ² Ø§Ø®ÛŒØ±', value: 'week'},
  {label: 'Û³Û° Ø±ÙˆØ² Ø§Ø®ÛŒØ±', value: 'month'},
];

function showDashboardChart(type, title) {
  let wrap = document.getElementById('dashboard-dynamic-chart-wrap');
  wrap.innerHTML = `
    <div class="dynamic-chart-box-pro">
      <div class="dynamic-chart-top">
        <span id="chartBox-title">${title}</span>
        <button id="close-dash-chart" class="close-dash-chart-btn">Ã—</button>
      </div>
      <div class="dynamic-chart-filters">
        ${filterBtns.map(b => `<button class="dash-filter-btn" data-v="${b.value}">${b.label}</button>`).join('')}
      </div>
      <div class="dynamic-chart-canvas-wrap">
        <canvas id="chartBox-canvas"></canvas>
      </div>
    </div>
  `;

  document.getElementById('close-dash-chart').onclick = () => {
    wrap.innerHTML = "";
    if (chartObj) chartObj.destroy();
  };

  let arrs = {
    visits: visitsPerDay,
    users: usersPerDay,
    sellers: Array(30).fill(shopsList.length),
    products: productsPerDay
  };
  let labelsObj = {
    week: ['Ø´Ù†Ø¨Ù‡','ÛŒÚ©Ø´Ù†Ø¨Ù‡','Ø¯ÙˆØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡','Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡','Ø¬Ù…Ø¹Ù‡'],
    month: days30.map(str => {
      let [m,d] = str.split('/');
      return `${parseInt(d)}/${parseInt(m)}`;
    })
  };

  function getData(period) {
    let arr = arrs[type];
    if (period === "today") return { data: [arr[arr.length - 1]], labels: ["Ø§Ù…Ø±ÙˆØ²"] };
    if (period === "yesterday") return { data: [arr[arr.length - 2]], labels: ["Ø¯ÛŒØ±ÙˆØ²"] };
    if (period === "week") {
      return { data: arr.slice(-7), labels: labelsObj.week };
    }
    if (period === "month") {
      if(window.innerWidth<700){
        return {data: arr.slice(-10), labels: labelsObj.month.slice(-10)};
      }
      return {data: arr.slice(-30), labels: labelsObj.month};
    }
    return { data: [], labels: [] };
  }

  function getColor() {
    if (type === "visits") return "rgba(16,185,129,1)";
    if (type === "users") return "rgba(14,165,233,1)";
    if (type === "sellers") return "rgba(22,163,74,1)";
    if (type === "products") return "rgba(234,179,8,1)";
    return "#666";
  }
  function getGradient(ctx) {
    let grad = ctx.createLinearGradient(0,0,0,260);
    grad.addColorStop(0,"rgba(14,165,233,0.25)");
    grad.addColorStop(1,"rgba(16,185,129,0.04)");
    return grad;
  }
  function getType(period) {
    return (period === "today" || period === "yesterday") ? "bar" : "line";
  }

  wrap.querySelectorAll(".dash-filter-btn").forEach(btn => {
    btn.onclick = () => {
      wrap.querySelectorAll(".dash-filter-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      let period = btn.getAttribute("data-v");
      let { data, labels } = getData(period);
      if (chartObj) chartObj.destroy();

      const canvas = document.getElementById('chartBox-canvas');
      let parW = Math.max(canvas.parentElement.offsetWidth, 360);
      canvas.width = Math.min(900, parW - 0 + 1);
      canvas.height = window.innerWidth < 600 ? 240 : 340;

      let color = getColor();
      let typeC = getType(period);

      chartObj = new Chart(canvas.getContext('2d'), {
        type: typeC,
        data: {
          labels: labels,
          datasets: [{
            label: title,
            data: data,
            backgroundColor: (ctx) =>
              typeC === "bar"
                ? color + "B0"
                : getGradient(ctx.chart.ctx),
            borderColor: color,
            borderWidth: 4,
            fill: true,
            tension: 0.5,
            pointRadius: 8,
            pointBackgroundColor: color,
            pointBorderColor: "#fff",
            pointHoverRadius: 12,
            pointHoverBorderWidth: 2,
            barPercentage: 0.45,
            categoryPercentage: 0.7,
            borderCapStyle: 'round'
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              rtl: true,
              padding: 15,
              backgroundColor: "#fff",
              borderColor: "#10b98122",
              borderWidth: 1.2,
              titleColor: "#16a34a",
              bodyColor: "#0ea5e9",
              bodyFont: { family: "Vazirmatn" },
              titleFont: { family: "Vazirmatn", weight: "bold", size:16 },
              displayColors: false,
              callbacks: {
                title: (ctx) => ctx[0].label,
                label: (ctx) => " " + ctx.dataset.label + ": " + ctx.formattedValue
              }
            }
          },
          layout: { padding: { left: 5, right: 5, top: 0, bottom: 5 } },
          scales: {
            y: {
              beginAtZero: true,
              border: { color: "#e5e7eb" },
              grid: { color: "#e5e7eb2b", drawTicks: false, borderDash: [3,5] },
              ticks: { color: '#999', font: { size: 15, weight:'bold' } }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#555', font: { size: 15, weight: 700 } }
            }
          }
        }
      });
    };
  });
  wrap.querySelector('.dash-filter-btn[data-v="week"]').click();
}

// Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø±
document.getElementById('card-visits').onclick = ()=> showDashboardChart("visits", "Ø¢Ù…Ø§Ø± Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ø³Ø§ÛŒØª");
document.getElementById('card-users').onclick = ()=> showDashboardChart("users", "Ø¢Ù…Ø§Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù†");
document.getElementById('card-sellers').onclick = ()=> showDashboardChart("sellers", "Ø¢Ù…Ø§Ø± ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§");
document.getElementById('card-products').onclick = ()=> showDashboardChart("products", "Ø¢Ù…Ø§Ø± Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯");

// -------- Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯ÛŒØªØ§ Ùˆ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ --------
// Ù†Ø³Ø®Ù‡Ù” Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡â€ŒÛŒ updateAll â€” ÙÙ‚Ø· Ù‡Ù…ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†
async function updateAll() {
  try {
    // Û±) ÙˆØ§Ú©Ø´ÛŒ Ù‡Ù…â€ŒØ²Ù…Ø§Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    const [users, shops, products] = await Promise.all([
      fetchUsers(),
      fetchShops(),
      fetchProducts()
    ]);

    // Û²) Ø³Øªâ€ŒÚ©Ø±Ø¯Ù† Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ
    usersList    = users;
    shopsList    = shops;
    await refreshSellerPerformanceMap();
    console.group('ğŸŸ¢ shopsList snapshot');
shopsList.slice(0, 10).forEach((s, i) => {
  console.log(i,
    'sid:',   s._sid,
    '_id:',   toIdString(s._id),
    'sellerId:', toIdString(s.sellerId ?? s.seller_id),
    'shopurl:', toIdString(s.shopurl)
  );
});
console.groupEnd();

    productsList = products;

    // Û³) ØªØ¹ÛŒÛŒÙ† Ø´Ù†Ø§Ø³Ù‡Ù” ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡
   // Û³) ØªØ¹ÛŒÛŒÙ† Ø´Ù†Ø§Ø³Ù‡Ù” ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (Ù†Ø³Ø®Ù‡â€ŒÛŒ Ø¬Ø¯ÛŒØ¯)
/* â”€â”€â”€ STEP 1 : Ø³Ø§Ø®Øª Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
shopsList.forEach(s => {
  // Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÛŒ Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§
  const uniqueId = toIdString(
    s.sellerId   || s.seller_id ||
    s._id        || s.id        ||
    (s.shopurl ? 'shopurl:' + s.shopurl : '')
  );
  s._sid     = uniqueId;
  s.sellerId = uniqueId;   // â† Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
});


/* ğŸ†•  Ù„Ø§Ú¯ ØªØ­Ù„ÛŒÙ„ÛŒ â€“ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯. Ø®ÙˆØ§Ø³ØªÛŒ Ø¨Ø¹Ø¯Ø§Ù‹ Ø­Ø°Ù Ú©Ù†. */
console.table(
  shopsList.map(({_sid, _id, sellerId, shopurl}) => ({ _sid, _id, sellerId, shopurl }))
);
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */



    // Û´) Ù¾Ø³ Ø§Ø² Ø¯Ø§Ø´ØªÙ† _sidÙ‡Ø§ØŒ Ù…Ù¾ Ù†Ø§Ù…â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø³Ø§Ø²
    buildNameMaps();

    // Ûµ) ÙˆØ§Ú©Ø´ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´)
    await fetchMessages();

    // Ø­ØªÙ…Ø§Ù‹ Ø¬Ø¯ÙˆÙ„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø±Ø§ Ù‡Ù… Ø±Ù†Ø¯Ø± Ú©Ù†
    renderMessages();

    // Û¶) Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡ (Ù†Ù…ÙˆÙ†Ù‡)
    usersPerDay[usersPerDay.length - 1]       = usersList.length;
    sellersPerDay[sellersPerDay.length - 1]   = shopsList.length;
    productsPerDay[productsPerDay.length - 1] = productsList.length;

    // Û·) Ø±Ù†Ø¯Ø± Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ
    updateDashboardCards();
    updateSidebarCounts();
    updateHeaderCounts();
    renderUsers();
    renderSellers();
    renderProducts();

  } catch (err) {
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†!\n' + (err.message || err));
  }
}



/* Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ */
updateAll();


let style = document.createElement('style');
style.innerHTML = `@keyframes fadeIn{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:none;}}`;
document.head.appendChild(style);







// --- ÙÛŒÙ„ØªØ± Ùˆ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ ---
let sellersSortMode = 'newest'; // Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
document.querySelectorAll('.seller-filter-btn').forEach(btn => {
  btn.onclick = function() {
    document.querySelectorAll('.seller-filter-btn').forEach(b=>b.classList.remove('active'));
    this.classList.add('active');
    sellersSortMode = this.getAttribute('data-sort');
    renderSellers();
  }
});


let sellerSearchQuery = '';  // Ù…ØªØºÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ú©ÙˆØ¦Ø±ÛŒ Ø¬Ø³ØªØ¬Ùˆ

// Ø¬Ø³ØªØ¬Ùˆ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§
document.getElementById('sellerSearch').addEventListener('input', e => {
  sellerSearchQuery = e.target.value.trim().toLowerCase();
  renderSellers();
});

function renderSellers() {
  const tbody = document.querySelector('#sellersTable tbody');
  tbody.innerHTML = '';

  if (!shopsList.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="color:#888;text-align:center">Ù‡ÛŒÚ† ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>`;
    return;
  }

  // ÙÛŒÙ„ØªØ± Ø¬Ø³ØªØ¬Ùˆ (Ù†Ø§Ù… ÙØ±ÙˆØ´Ú¯Ø§Ù‡ØŒ Ù†Ø§Ù… ØµØ§Ø­Ø¨ØŒ Ø¢Ø¯Ø±Ø³)
  let sellers = shopsList.filter(shop => {
    const storeName = (shop.storename || shop.shopLogoText || '').toLowerCase();
    const ownerName = (shop.ownerName || `${shop.ownerFirstname || ''} ${shop.ownerLastname || ''}`.trim()).toLowerCase();
    const storeAddr = (shop.address || shop.shopAddress || '').toLowerCase();
    const phone = (shop.phone || shop.mobile || shop.ownerPhone || shop.ownerMobile || '').toLowerCase();
    return (
      storeName.includes(sellerSearchQuery) ||
      ownerName.includes(sellerSearchQuery) ||
      storeAddr.includes(sellerSearchQuery) ||
      phone.includes(sellerSearchQuery)
    );
  });

  sellers.forEach(shop => {
    shop._productsCount = shop.productsCount ?? shop.productCount ?? 0;
    shop._visits = shop.visits || shop.shopVisits || 0;
    shop._createdAt = shop.createdAt ? new Date(shop.createdAt).getTime() : 0;
    shop._subStart = shop.subscriptionStart ? new Date(shop.subscriptionStart) : null;
    shop._subEnd = shop.subscriptionEnd ? new Date(shop.subscriptionEnd) : null;
  });

  // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ
  if (sellersSortMode === 'newest') {
    sellers.sort((a, b) => b._createdAt - a._createdAt);
  } else if (sellersSortMode === 'oldest') {
    sellers.sort((a, b) => a._createdAt - b._createdAt);
  } else if (sellersSortMode === 'mostvisited') {
    sellers.sort((a, b) => b._visits - a._visits);
  } else if (sellersSortMode === 'mostproducts') {
    sellers.sort((a, b) => b._productsCount - a._productsCount);
  }

  sellers.forEach((shop, i) => {
    let countProducts = shop._productsCount;
    let ownerName = shop.ownerName || `${shop.ownerFirstname || ''} ${shop.ownerLastname || ''}`.trim() || "-";
    let shopLink = shop.shopurl
      ? `<a href="/shop.html?shopurl=${shop.shopurl}" target="_blank" style="color:#0ea5e9;text-decoration:underline">${shop.shopurl}</a>`
      : '-';

    const sellerKey = resolveSellerKeyFromShop(shop);
    const performance = sellerKey ? getSellerPerformanceByKey(sellerKey) : null;
    const adminScore = performance && performance.adminScore != null ? performance.adminScore : null;
    const scoreBadge = adminScore != null
      ? `<span class="seller-score-badge has-score"><strong>${adminScore}</strong><span class="score-suffix">/100</span></span>`
      : '<span class="seller-score-badge no-score">Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</span>';
    const statusSeverity = performance ? performance.severity || 'neutral' : 'neutral';
    const statusLabel = performance ? performance.statusLabel : 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ';
    const statusBadge = `<span class="seller-status-pill status-${statusSeverity}">${statusLabel}</span>`;
    const eligibilityClass = performance
      ? (performance.canStay ? 'status-eligible' : 'status-ineligible')
      : 'status-neutral';
    const eligibilityText = performance
      ? (performance.canStay ? 'âœ… Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø§Ø¯Ø§Ù…Ù‡ ÙØ¹Ø§Ù„ÛŒØª' : 'â›” Ø§Ù…Ú©Ø§Ù† Ø§Ø¯Ø§Ù…Ù‡ ÙØ¹Ø§Ù„ÛŒØª Ø¯Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯')
      : 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø¯Ù…ÛŒÙ†';
    const combinedStatus = `<div class="seller-score-cell-wrap">${scoreBadge}${statusBadge}<span class="seller-status-note ${eligibilityClass}">${eligibilityText}</span></div>`;
    const sid = toIdString(shop.sellerId || shop.seller_id || shop._id || shop._sid || shop.shopurl);
    let tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="seller-cell seller-modal-trigger" style="cursor:pointer;color:#10b981;font-weight:bold">${shop.storename || shop.shopLogoText || '-'}</td>
      <td class="seller-cell seller-modal-trigger" style="cursor:pointer">${ownerName}</td>
      <td class="seller-cell seller-modal-trigger" style="cursor:pointer">${shop.address || shop.shopAddress || '-'}</td>
      <td>${shopLink}</td>
      <td>${countProducts}</td>
      <td>${shop._visits}</td>
      <td class="seller-cell seller-modal-trigger seller-score-cell" data-score-key="${sellerKey || ''}">${combinedStatus}</td>
      <td>
        <button class="action-btn delete">
          <i class="ri-delete-bin-line"></i> Ø­Ø°Ù
        </button>
      </td>
    `;
    // Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø¨Ù‡ Ù‡Ø± Ø³Ù„ÙˆÙ„ Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ©
    Array.from(tr.querySelectorAll('.seller-cell')).forEach(td=>{
      td.onclick = () => showSellerModal(shop);
    });
    const delBtn = tr.querySelector('.action-btn.delete');
    if (delBtn) {
      delBtn.addEventListener('click', () => deleteSeller(sid));
    }
    tbody.appendChild(tr);
  });

  if (!sellers.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="color:#888;text-align:center">Ù‡ÛŒÚ† ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>`;
  }
}

// Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡
// â† Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
/* ===== Ù†Ø³Ø®Ù‡Ù” Ø¬Ø¯ÛŒØ¯ ØªØ§Ø¨Ø¹ showSellerModal (Ù‡Ù…Ø±Ø§Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„) ===== */
/* ------------------------------------------------------------------
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ showSellerModal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let sellerModalOverlayClickHandler = null;
let sellerModalKeydownHandler = null;
async function showSellerModal (shop) {
  const overlay = document.getElementById('seller-modal-overlay');

  /* ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ */
  const fDate = d =>
    d
      ? new Date(d).toLocaleDateString('fa-IR', {
          year: 'numeric', month: 'long', day: 'numeric'
        })
      : 'â€”';

  /*â€ŠØ´Ù†Ø§Ø³Ù‡Ù” Ù…Ø·Ù…Ø¦Ù† ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€Š*/
  const sellerId =
        (shop._id && shop._id.toString())              ||
        (shop.sellerId && String(shop.sellerId))       ||
        (shop._sid && !String(shop._sid).startsWith('shopurl:')
          ? String(shop._sid)
          : '')                                        ||
        (shop.shopurl ? `shopurl:${shop.shopurl}` : '');

  const storeName = shop.storename || shop.shopLogoText || '-';
  const url       = shop.shopurl  || '';
  const phone     =
        shop.phone || shop.mobile ||
        shop.ownerPhone || shop.ownerMobile || '-';
  const sellerScoreKey = resolveSellerKeyFromShop(shop);

  if (sellerScoreKey && !sellerPerformanceLoaded) {
    await refreshSellerPerformanceMap();
  }

  let performanceMeta = sellerScoreKey ? getSellerPerformanceByKey(sellerScoreKey) : null;

  const existingAdminScore = performanceMeta && performanceMeta.adminScore != null
    ? performanceMeta.adminScore
    : null;
  const defaultAdminScore = 75;
  let hasExistingScore = existingAdminScore != null;
  const initialAdminScore = hasExistingScore ? existingAdminScore : defaultAdminScore;
  const statusSeverity = performanceMeta ? performanceMeta.severity || 'neutral' : 'neutral';
  const statusLabel = performanceMeta ? performanceMeta.statusLabel : 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ';
  const statusMessage = performanceMeta && performanceMeta.statusMessage
    ? performanceMeta.statusMessage
    : 'Ù¾Ø³ Ø§Ø² Ø«Ø¨Øª Ù†Ù…Ø±Ù‡ØŒ ÙˆØ¶Ø¹ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.';
  const eligibilityNote = performanceMeta
    ? (performanceMeta.canStay ? 'âœ… Ø§ÛŒÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø§Ø¯Ø§Ù…Ù‡ Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø§Ø³Øª.' : 'â›” Ø¨Ø§ Ø§ÛŒÙ† Ù†Ù…Ø±Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ù‚Ø§Ø¯Ø± Ø¨Ù‡ Ù…Ø§Ù†Ø¯Ù† Ø¯Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª Ù†ÛŒØ³Øª.')
    : 'Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒØŒ Ø§Ø¨ØªØ¯Ø§ Ù†Ù…Ø±Ù‡ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.';
  const statusUpdatedText = performanceMeta && performanceMeta.updatedAt
    ? `Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${formatDateTime(performanceMeta.updatedAt)}`
    : 'Ù‡Ù†ÙˆØ² Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
  const existingAdminNote = performanceMeta && typeof performanceMeta.note === 'string'
    ? performanceMeta.note
    : (performanceMeta && typeof performanceMeta.adminScoreNote === 'string'
      ? performanceMeta.adminScoreNote
      : '');
  const existingAdminMessage = performanceMeta && typeof performanceMeta.adminScoreMessage === 'string'
    ? performanceMeta.adminScoreMessage
    : (performanceMeta && typeof performanceMeta.publicMessage === 'string'
      ? performanceMeta.publicMessage
      : '');
  const defaultNoteMessage = 'ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
  const defaultMessageText = 'Ù¾ÛŒØ§Ù…ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
  const noteDisplayHtml = existingAdminNote
    ? formatNoteForDisplay(existingAdminNote)
    : escapeHtml(defaultNoteMessage);
  const noteValueForInput = escapeHtml(existingAdminNote);
  const messageDisplayHtml = existingAdminMessage
    ? formatNoteForDisplay(existingAdminMessage)
    : escapeHtml(defaultMessageText);
  const messageValueForInput = escapeHtml(existingAdminMessage);

  /* ---------- Ø±Ù†Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ‡ ---------- */
  overlay.innerHTML = `
    <div class="seller-modal" role="dialog" aria-modal="true">
      <button type="button" class="seller-modal-close" onclick="closeSellerModal()" aria-label="Ø¨Ø³ØªÙ† Ù¾Ù†Ø¬Ø±Ù‡">Ã—</button>

      <div class="seller-modal-title">
        Ù…Ø´Ø®ØµØ§Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡:
        <span style="color:#0ea5e9">${storeName}</span>
      </div>

      <div class="seller-modal-row">
        <span class="seller-modal-label">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…:</span>
        <span class="seller-modal-value">${fDate(shop.createdAt)}</span>
      </div>

      <div class="seller-modal-row">
        <span class="seller-modal-label">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„:</span>
        <span class="seller-modal-value">${phone}</span>
      </div>

      <div class="seller-modal-row">
        <span class="seller-modal-label">Ù†ÙˆØ¹ Ø§Ø´ØªØ±Ø§Ú©:</span>
        <span class="seller-modal-value">${shop.subscriptionType || '-'}</span>
      </div>

      <div class="seller-modal-row">
        <span class="seller-modal-label">ØªØ§Ø±ÛŒØ® Ø®Ø±ÛŒØ¯:</span>
        <span class="seller-modal-value">${fDate(shop.subscriptionStart)}</span>
      </div>

      <div class="seller-modal-row">
        <span class="seller-modal-label">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†:</span>
        <span class="seller-modal-value">${fDate(shop.subscriptionEnd)}</span>
      </div>

      <!-- Ø±Ø¯ÛŒÙ Ù¾Ø³ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯ -->

      <div class="seller-score-block" data-score-key="${sellerScoreKey || ''}">
        <span class="seller-modal-label">Ù†Ù…Ø±Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø¯Ù…ÛŒÙ†</span>
        <div class="seller-score-range">
          <input type="range" id="sellerScoreInput" min="0" max="100" step="1" value="${initialAdminScore}" aria-label="Ø§Ù…ØªÛŒØ§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙØ±ÙˆØ´Ù†Ø¯Ù‡">
          <div class="seller-score-value" id="sellerScoreValue">${initialAdminScore}</div>
        </div>
        <div class="seller-score-actions">
          <button type="button" class="score-save-btn" id="saveSellerScoreBtn">Ø«Ø¨Øª Ù†Ù…Ø±Ù‡</button>
          <button type="button" class="score-clear-btn" id="clearSellerScoreBtn" ${hasExistingScore ? '' : 'disabled'}>Ø­Ø°Ù Ù†Ù…Ø±Ù‡</button>
        </div>
        <p class="seller-score-hint">Ù†Ù…Ø±Ù‡ Û° ØªØ§ Û±Û°Û° Ú©ÛŒÙÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø±Ø§ Ø§Ø² Ù†Ú¯Ø§Ù‡ ØªÛŒÙ… Ø§Ø¯Ù…ÛŒÙ† Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ù¾Ø³ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù‚Ø¯Ø§Ø±ØŒ Ø¯Ú©Ù…Ù‡ Â«Ø«Ø¨Øª Ù†Ù…Ø±Ù‡Â» Ø±Ø§ Ø¨Ø²Ù†.</p>
        <div class="seller-score-note">
          <label for="sellerScoreNote">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¯Ø§Ø®Ù„ÛŒ Ø§Ø¯Ù…ÛŒÙ†</label>
          <textarea id="sellerScoreNote" placeholder="Ù†Ú©Ø§Øª Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯â€¦">${noteValueForInput}</textarea>
          <p class="seller-score-note-hint">Ø§ÛŒÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… Ø§Ø¯Ù…ÛŒÙ† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù†Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</p>
        </div>
        <div class="seller-score-message">
          <label for="sellerScoreMessage">Ù¾ÛŒØ§Ù… Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</label>
          <textarea id="sellerScoreMessage" placeholder="Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ù†Ù…Ø±Ù‡ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯â€¦">${messageValueForInput}</textarea>
          <p class="seller-score-message-hint">ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ù…ØªÙ† Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ Ø¯Ø± Ø¨Ø®Ø´ ÙˆØ¶Ø¹ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ù†Ù„ Ø®ÙˆØ¯ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
        </div>
        <div class="seller-score-alert" id="sellerScoreAlert" style="display:none;"></div>
        <div class="seller-score-status" id="sellerScoreStatus">
          <div class="seller-score-status-header">
            <span class="seller-status-pill status-${statusSeverity}" id="sellerStatusBadge">${statusLabel}</span>
            <span class="seller-status-updated" id="sellerStatusUpdated">${statusUpdatedText}</span>
          </div>
          <p class="seller-status-text" id="sellerStatusText">${statusMessage}</p>
          <p class="seller-status-note ${performanceMeta ? (performanceMeta.canStay ? 'status-eligible' : 'status-ineligible') : 'status-neutral'}" id="sellerStatusNote">${eligibilityNote}</p>
          <div class="seller-score-message-display" id="sellerMessageDisplay">
            <span class="seller-score-message-title">Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</span>
            <p class="seller-message-text" id="sellerMessageText">${messageDisplayHtml}</p>
          </div>
          <div class="seller-score-note-display" id="sellerNoteDisplay">
            <span class="seller-score-note-title">Ø¢Ø®Ø±ÛŒÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</span>
            <p class="seller-note-text" id="sellerNoteText">${noteDisplayHtml}</p>
          </div>
        </div>
      </div>

      <form id="sellerMessageForm"
            class="seller-modal-form"
            data-seller-id="${sellerId}"
            data-shopurl="${url}">
        <label for="sellerMessage">Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§ÛŒÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
        <textarea id="sellerMessage" name="msg"
                  placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯â€¦" required></textarea>
        <button type="submit">Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…</button>
        <div id="seller-modal-success"
             class="seller-modal-success"
             style="display:none"></div>
      </form>
    </div>`;

  overlay.style.display = 'flex';

  if (sellerModalOverlayClickHandler) {
    overlay.removeEventListener('click', sellerModalOverlayClickHandler);
  }
  sellerModalOverlayClickHandler = (event) => {
    if (event.target === overlay) {
      closeSellerModal();
    }
  };
  overlay.addEventListener('click', sellerModalOverlayClickHandler);

  if (sellerModalKeydownHandler) {
    document.removeEventListener('keydown', sellerModalKeydownHandler);
  }
  sellerModalKeydownHandler = (event) => {
    if (event.key === 'Escape') {
      closeSellerModal();
    }
  };
  document.addEventListener('keydown', sellerModalKeydownHandler);

  const scoreInputEl = document.getElementById('sellerScoreInput');
  const scoreValueEl = document.getElementById('sellerScoreValue');
  const scoreSaveBtn = document.getElementById('saveSellerScoreBtn');
  const scoreClearBtn = document.getElementById('clearSellerScoreBtn');
  const scoreAlertEl = document.getElementById('sellerScoreAlert');
  const sellerScoreNoteEl = document.getElementById('sellerScoreNote');
  const sellerScoreMessageEl = document.getElementById('sellerScoreMessage');
  const statusElements = {
    badge: document.getElementById('sellerStatusBadge'),
    text: document.getElementById('sellerStatusText'),
    note: document.getElementById('sellerStatusNote'),
    updated: document.getElementById('sellerStatusUpdated'),
    noteText: document.getElementById('sellerNoteText'),
    noteContainer: document.getElementById('sellerNoteDisplay'),
    messageText: document.getElementById('sellerMessageText'),
    messageContainer: document.getElementById('sellerMessageDisplay')
  };

  if (scoreInputEl && scoreValueEl) {
    scoreInputEl.value = String(initialAdminScore);
    scoreValueEl.textContent = String(initialAdminScore);
  }

  const resolveNoteValue = (info) => {
    if (!info) return '';
    if (typeof info.note === 'string') return info.note;
    if (typeof info.adminScoreNote === 'string') return info.adminScoreNote;
    return '';
  };

  const resolveMessageValue = (info) => {
    if (!info) return '';
    if (typeof info.adminScoreMessage === 'string') return info.adminScoreMessage;
    if (typeof info.publicMessage === 'string') return info.publicMessage;
    return '';
  };

  const updateNoteUI = (value) => {
    const noteValue = typeof value === 'string' ? value : '';
    if (sellerScoreNoteEl) sellerScoreNoteEl.value = noteValue;
    if (statusElements.noteText) {
      statusElements.noteText.innerHTML = noteValue
        ? formatNoteForDisplay(noteValue)
        : escapeHtml(defaultNoteMessage);
    }
    if (statusElements.noteContainer) {
      statusElements.noteContainer.style.display = 'flex';
    }
  };

  const updateMessageUI = (value) => {
    const messageValue = typeof value === 'string' ? value : '';
    if (sellerScoreMessageEl) sellerScoreMessageEl.value = messageValue;
    if (statusElements.messageText) {
      statusElements.messageText.innerHTML = messageValue
        ? formatNoteForDisplay(messageValue)
        : escapeHtml(defaultMessageText);
    }
    if (statusElements.messageContainer) {
      statusElements.messageContainer.style.display = 'flex';
      if (messageValue) {
        statusElements.messageContainer.classList.remove('is-empty');
      } else {
        statusElements.messageContainer.classList.add('is-empty');
      }
    }
  };

  updateNoteUI(existingAdminNote);
  updateMessageUI(existingAdminMessage);

  const applyStatusMeta = (meta) => {
    const info = meta || null;
    const severity = info ? info.severity || 'neutral' : 'neutral';
    if (statusElements.badge) {
      statusElements.badge.textContent = info ? info.statusLabel : 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ';
      statusElements.badge.className = `seller-status-pill status-${severity}`;
    }
    if (statusElements.text) {
      statusElements.text.textContent = info && info.statusMessage
        ? info.statusMessage
        : 'Ù¾Ø³ Ø§Ø² Ø«Ø¨Øª Ù†Ù…Ø±Ù‡ØŒ ÙˆØ¶Ø¹ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.';
    }
    if (statusElements.note) {
      const canStay = info ? !!info.canStay : null;
      statusElements.note.textContent = info
        ? (canStay ? 'âœ… Ø§ÛŒÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø§Ø¯Ø§Ù…Ù‡ Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø§Ø³Øª.' : 'â›” Ø¨Ø§ Ø§ÛŒÙ† Ù†Ù…Ø±Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ù‚Ø§Ø¯Ø± Ø¨Ù‡ Ù…Ø§Ù†Ø¯Ù† Ø¯Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª Ù†ÛŒØ³Øª.')
        : 'Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒØŒ Ø§Ø¨ØªØ¯Ø§ Ù†Ù…Ø±Ù‡ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.';
      statusElements.note.className = `seller-status-note ${info ? (canStay ? 'status-eligible' : 'status-ineligible') : 'status-neutral'}`;
    }
    if (statusElements.updated) {
      statusElements.updated.textContent = info && info.updatedAt
        ? `Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${formatDateTime(info.updatedAt)}`
        : 'Ù‡Ù†ÙˆØ² Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
    }
    updateNoteUI(resolveNoteValue(info));
    updateMessageUI(resolveMessageValue(info));
  };

  applyStatusMeta(performanceMeta);

  const showScoreAlert = (message, type = 'success') => {
    if (!scoreAlertEl) return;
    scoreAlertEl.textContent = message;
    scoreAlertEl.classList.remove('is-success', 'is-error');
    scoreAlertEl.classList.add(type === 'error' ? 'is-error' : 'is-success');
    scoreAlertEl.style.display = 'block';
    setTimeout(() => {
      if (scoreAlertEl) scoreAlertEl.style.display = 'none';
    }, 2800);
  };

  if (scoreInputEl) {
    scoreInputEl.addEventListener('input', () => {
      if (scoreValueEl) scoreValueEl.textContent = scoreInputEl.value;
    });
  }

  if (scoreSaveBtn) {
    scoreSaveBtn.addEventListener('click', async () => {
      if (!sellerScoreKey) {
        showScoreAlert('Ø´Ù†Ø§Ø³Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ù…Ø±Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.', 'error');
        return;
      }
      const sourceValue = scoreInputEl ? scoreInputEl.value : initialAdminScore;
      const noteValue = sellerScoreNoteEl ? sellerScoreNoteEl.value : '';
      const messageValue = sellerScoreMessageEl ? sellerScoreMessageEl.value : '';
      if (!messageValue.trim()) {
        showScoreAlert('Ù„Ø·ÙØ§Ù‹ Ø¯Ù„ÛŒÙ„ Ù†Ù…Ø±Ù‡ Ø±Ø§ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.', 'error');
        return;
      }
      scoreSaveBtn.disabled = true;
      scoreSaveBtn.classList.add('is-loading');
      try {
        const meta = await setSellerScoreByKey(sellerScoreKey, sourceValue, noteValue, messageValue);
        performanceMeta = meta || performanceMeta;
        const finalScore = meta && meta.adminScore != null
          ? meta.adminScore
          : Math.max(0, Math.min(100, Math.round(Number(sourceValue) || 0)));
        if (scoreValueEl) scoreValueEl.textContent = String(finalScore);
        if (scoreInputEl) scoreInputEl.value = String(finalScore);
        hasExistingScore = finalScore != null;
        if (scoreClearBtn) scoreClearBtn.disabled = !hasExistingScore;
        if (meta) {
          applyStatusMeta(meta);
        } else {
          updateNoteUI(noteValue);
          updateMessageUI(messageValue);
        }
        renderSellers();
        showScoreAlert((meta && meta.message) || 'Ù†Ù…Ø±Ù‡ Ø«Ø¨Øª Ø´Ø¯.');
      } catch (err) {
        console.error('saveSellerScore error:', err);
        showScoreAlert(err.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ù…Ø±Ù‡.', 'error');
      } finally {
        scoreSaveBtn.disabled = false;
        scoreSaveBtn.classList.remove('is-loading');
      }
    });
  }

  if (scoreClearBtn) {
    scoreClearBtn.addEventListener('click', async () => {
      if (!sellerScoreKey) {
        showScoreAlert('Ø´Ù†Ø§Ø³Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.', 'error');
        return;
      }
      scoreClearBtn.disabled = true;
      scoreClearBtn.classList.add('is-loading');
      try {
        const meta = await clearSellerScoreByKey(sellerScoreKey);
        performanceMeta = meta || null;
        if (scoreInputEl) scoreInputEl.value = String(defaultAdminScore);
        if (scoreValueEl) scoreValueEl.textContent = String(defaultAdminScore);
        hasExistingScore = false;
        if (meta) {
          applyStatusMeta(meta);
        } else {
          updateNoteUI('');
          updateMessageUI('');
        }
        renderSellers();
        showScoreAlert((meta && meta.message) || 'Ù†Ù…Ø±Ù‡ Ø­Ø°Ù Ø´Ø¯.');
      } catch (err) {
        console.error('clearSellerScore error:', err);
        showScoreAlert(err.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù†Ù…Ø±Ù‡.', 'error');
        scoreClearBtn.disabled = false;
      } finally {
        scoreClearBtn.classList.remove('is-loading');
      }
    });
  }

  /* Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… */
  document
    .getElementById('sellerMessageForm')
    .addEventListener('submit', sendSellerMessage);

  // ØªØ§Ø¨Ø¹ fetchSellerPassword Ø¯ÛŒÚ¯Ø± Ù†ÛŒØ§Ø²ÛŒ Ù†ÛŒØ³Øª Ùˆ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯
}









function closeSellerModal() {
  const overlay = document.getElementById('seller-modal-overlay');
  if (!overlay) return;
  overlay.style.display = "none";
  overlay.innerHTML = "";
  if (sellerModalOverlayClickHandler) {
    overlay.removeEventListener('click', sellerModalOverlayClickHandler);
    sellerModalOverlayClickHandler = null;
  }
  if (sellerModalKeydownHandler) {
    document.removeEventListener('keydown', sellerModalKeydownHandler);
    sellerModalKeydownHandler = null;
  }
}

// â† Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
async function sendSellerMessage(e) {
  e.preventDefault();
  const form  = e.currentTarget;
  let   rawId = form.dataset.sellerId;  // "shopurl:slug" ÛŒØ§ ObjectId
  const text  = form.querySelector('textarea').value.trim();

  if (!text) {
    return alert('Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.');
  }
  if (!rawId) {
    return alert('Ø´Ù†Ø§Ø³Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!');
  }

  // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ payload
  const body = { text, from: 'admin' };
  if (rawId.startsWith('shopurl:')) {
    body.shopurl = rawId.replace(/^shopurl:/, '');
  } else {
    body.sellerId = rawId;
  }

  try {
    const res = await fetch(`${API_BASE}/chats`, {
      method: 'POST',
      headers: {
        'Content-Type':  'application/json'
        // Ù‡Ø¯Ø± Authorization Ù„Ø§Ø²Ù… Ù†ÛŒØ³Øª Ú†ÙˆÙ† Ø¨Ø§ Ú©ÙˆÚ©ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒ
      },
      credentials: 'include',
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.error || data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…');
    }

    // Ù…ÙˆÙÙ‚ÛŒØª
    form.querySelector('textarea').value = '';
    const okBox = document.getElementById('seller-modal-success');
    okBox.textContent = 'âœ… Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!';
    okBox.style.display = 'block';
    setTimeout(() => okBox.style.display = 'none', 2500);

  } catch (err) {
    console.error('sendSellerMessage error:', err, body);
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…:\n' + err.message);
  }
}











/**
 * Ø§Ú¯Ø± chat.seller Ù¾Ø± Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ ÛŒØ§ shopurl Ø¯Ø± shopsList Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ú©Ù†
 */
// 1) ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† Ø´ÛŒØ¡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡
/** Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø´ÛŒØ¡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø¨Ø§ sellerId ÛŒØ§ shopurl */
// ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† Ø´ÛŒØ¡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡
// Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø´ÛŒØ¡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø¨Ø§ sellerId ÛŒØ§ shopurl
// ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† ÙØ±ÙˆØ´Ú¯Ø§Ù‡
function findShopBySellerId(sellerId, shopUrl) {
  const sid = toIdString(sellerId);
  const url = toIdString(shopUrl);
  
  // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø´Ù†Ø§Ø³Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡
  const bySellerId = shopsList.find(shop => {
    const shopIds = [
      toIdString(shop._id),
      toIdString(shop.id),
      toIdString(shop.sellerId),
      toIdString(shop.seller_id),
      shop._sid ? toIdString(shop._sid) : null
    ].filter(Boolean);
    
    return shopIds.includes(sid);
  });
  
  if (bySellerId) return bySellerId;
  
  // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø«Ø§Ù†ÙˆÛŒÙ‡ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø¯Ø±Ø³ ÙØ±ÙˆØ´Ú¯Ø§Ù‡
  const byShopUrl = shopsList.find(shop => 
    toIdString(shop.shopurl) === url
  );
  
  return byShopUrl || null;
}
// ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…Ø¯Ø§Ù„ ÙØ±Ø³ØªÙ†Ø¯Ù‡
// ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡
async function getSellerDetails(sellerId) {
  try {
    const res = await fetch(`${API_BASE}/sellers/${encodeURIComponent(sellerId)}`, {
      credentials: 'include'
    });
    
    if (!res.ok) {
      throw new Error('ÙØ±ÙˆØ´Ù†Ø¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯');
    }
    
    return await res.json();
  } catch (err) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡:', err);
    return null;
  }
}

// ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…Ø¯Ø§Ù„
async function openSenderModal(chat) {
  const ov = document.getElementById('sender-modal-overlay');
  if (!ov) return;

  ov.innerHTML = `
    <div class="sender-modal">
      <button class="sender-modal-close" onclick="closeSenderModal()">Ã—</button>
      <h4>Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡...</h4>
    </div>
  `;
  ov.style.display = 'flex';

  try {
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø´Ù†Ø§Ø³Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø§Ø² Ú†Øª
    const sellerId = chat.sellerId || '';
    
    // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø§Ø² Ø¨Ú©â€ŒØ§Ù†Ø¯
    const seller = await getSellerDetails(sellerId);
    
    if (!seller) {
      ov.innerHTML = `
        <div class="sender-modal">
          <button class="sender-modal-close" onclick="closeSenderModal()">Ã—</button>
          <h4>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h4>
          <p>ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ ${sellerId} ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
        </div>
      `;
      return;
    }

    // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡
    ov.innerHTML = `
      <div class="sender-modal">
        <button class="sender-modal-close" onclick="closeSenderModal()">Ã—</button>
        <h4>Ù…Ø´Ø®ØµØ§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡</h4>
        
        <div class="sender-info-row">
          <span class="sender-info-label">Ù†Ø§Ù… ÙØ±ÙˆØ´Ú¯Ø§Ù‡:</span>
          <span class="sender-info-value">${seller.storename || '-'}</span>
        </div>
        
        <div class="sender-info-row">
          <span class="sender-info-label">Ù†Ø§Ù… ØµØ§Ø­Ø¨ ÙØ±ÙˆØ´Ú¯Ø§Ù‡:</span>
          <span class="sender-info-value">${seller.firstname || ''} ${seller.lastname || ''}</span>
        </div>
        
        <div class="sender-info-row">
          <span class="sender-info-label">Ø¢Ø¯Ø±Ø³ ÙØ±ÙˆØ´Ú¯Ø§Ù‡:</span>
          <span class="sender-info-value">${seller.address || '-'}</span>
        </div>
        
        <div class="sender-info-row">
          <span class="sender-info-label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</span>
          <span class="sender-info-value">${seller.phone || '-'}</span>
        </div>
        
        <div class="sender-info-row">
          <span class="sender-info-label">Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ†ØªØ±Ù†ØªÛŒ:</span>
          <span class="sender-info-value">${seller.shopurl || '-'}</span>
        </div>
        
        <div class="sender-info-row">
          <span class="sender-info-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ:</span>
          <span class="sender-info-value">${seller.category || '-'}</span>
        </div>
      </div>
    `;
  } catch (err) {
    ov.innerHTML = `
      <div class="sender-modal">
        <button class="sender-modal-close" onclick="closeSenderModal()">Ã—</button>
        <h4>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h4>
        <p>${err.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
      </div>
    `;
  }
}
/* Ø¨Ø³ØªÙ† Ù…Ø¯Ø§Ù„ */
function closeSenderModal() {
  const ov = document.getElementById('sender-modal-overlay');
  ov.style.display = 'none';
  ov.innerHTML = '';
}




// ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ø³Ø§Ø²ÛŒ ID




// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”






// Ø«Ø¨Øª Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù„Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ panels
// Ø«Ø¨Øª Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù„Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ panels
// Ø«Ø¨Øª Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù„Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ panels
panels['plans'] = document.getElementById('plans-panel');

panels['ads'] = document.getElementById('ads-panel');
panels['messages'] = document.getElementById('messages-panel');


/* Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ */
const planInputs = {
  "1month":  document.getElementById('plan-1month'),
  "3month":  document.getElementById('plan-3month'),
  "12month": document.getElementById('plan-12month'),
  "vitriPlus": document.getElementById('vitriPlusPrice')
};
const plansMsg  = document.getElementById('plansMsg');





// ØªØ§Ø¨Ø¹ debounce Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø±Ø± Ù…ÙˆÙ‚Ø¹ ØªØ§ÛŒÙ¾ (ÛµÛ°Û° Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡)
function debounce(fn, delay = 500) {
  let timeout;
  return (...args) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => fn(...args), delay);
  };
}


// ØªØ§Ø¨Ø¹ normalize phone (Ù…Ø´ØªØ±Ú© Ø¨Ø±Ø§ÛŒ ÙØ±Ø§Ù†Øª)
function normalizePhone(p) {
  if (!p) return null;
  p = p.replace(/\D/g, '');  // Ø­Ø°Ù ØºÛŒØ±Ø¹Ø¯Ø¯ÛŒ
  if (p.length === 10 && p.startsWith('9')) p = '0' + p;
  return (p.length === 11 && p.startsWith('09')) ? p : null;
}


/* ---------- 1) Ø®ÙˆØ§Ù†Ø¯Ù† Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± ---------- */
async function loadPlanPrices() {
  try {
    let phone = document.getElementById('seller-phone-plans').value.trim();
    phone = normalizePhone(phone);
    let url = `${API_BASE}/plans`;
    if (phone) {
      url += `?sellerPhone=${encodeURIComponent(phone)}`;
    }

    const res = await fetch(url, { credentials: 'include' });
    if (!res.ok) throw new Error(await res.text());

    const { plans } = await res.json();  // { "1month": ..., "3month": ..., ... }

    // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§
    planInputs['1month'].value  = plans['1month']  ?? '';
    planInputs['3month'].value  = plans['3month']  ?? '';
    planInputs['12month'].value = plans['12month'] ?? '';
    planInputs['vitriPlus'].value = plans['vitriPlus'] ?? '';

    // Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ø®Ø§Ù„ÛŒ (ÛŒØ¹Ù†ÛŒ override Ù†Ø¯Ø§Ø±Ù‡)ØŒ Ù¾ÛŒØ§Ù… Ø¨Ø¯ÛŒØ¯
    if (phone && !Object.values(plans).some(p => p !== null)) {
      showPlansMsg('Ù‚ÛŒÙ…Øª Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡Ø› Ø§Ø² Ù‚ÛŒÙ…Øª Ø¹Ù…ÙˆÙ…ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.', true, phone);
    }
  } catch (err) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§:', err);
    showPlansMsg('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§!', false);
  }
}

/* ---------- 2) Ø°Ø®ÛŒØ±Ù‡ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± ---------- */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return '';
}

async function savePlanPrices(e) {
  e.preventDefault();

  // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ payload
  const prices = {
    '1month':  Number(planInputs['1month'].value),
    '3month':  Number(planInputs['3month'].value),
    '12month': Number(planInputs['12month'].value),
    'vitriPlus': Number(planInputs['vitriPlus'].value)
  };

  const validPrices = {};
  Object.keys(prices).forEach(k => {
    const val = prices[k];
    if (!Number.isNaN(val) && val > 0) validPrices[k] = val;
  });

  if (!Object.keys(validPrices).length) {
    showPlansMsg('Ù‡ÛŒÚ† Ù‚ÛŒÙ…Øª Ù…Ø¹ØªØ¨Ø±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯', false);
    return;
  }

  const body = { prices: validPrices };


  const rawPhone = document.getElementById('seller-phone-plans').value.trim();
  const phone    = normalizePhone(rawPhone);
  if (rawPhone && !phone) {
    showPlansMsg('Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.', false);
    return;
  }

  if (phone && !(await sellerExists(phone))) {
    showPlansMsg('ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.', false);
    return;
  }

  if (phone) body.sellerPhone = phone;

  try {
    const token = getCookie('admin_token') || getCookie('access_token');

    const res = await fetch(`${API_BASE}/plans/admin`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': 'Bearer ' + token })
      },
      credentials: 'include',
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (!res.ok || data.success === false) {
      throw new Error(data.message || await res.text());
    }

    await loadPlanPrices();
    showPlansMsg('âœ… ' + (data.message || 'Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.'), true, phone);
  } catch (err) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§:', err);
    showPlansMsg('âŒ ' + err.message, false, phone);
  }
}


/* ---------- 3) Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª / Ø®Ø·Ø§ ---------- */
function showPlansMsg(txt, ok, phone = '') {
  const plansMsg = document.getElementById('plansMsg');
  plansMsg.textContent      = txt + (phone ? ` (Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ ${phone})` : ' (Ø¹Ù…ÙˆÙ…ÛŒ)');
  plansMsg.style.display    = 'block';
  plansMsg.style.background = ok ? '#e0fdfa' : '#fee2e2';
  plansMsg.style.color      = ok ? '#10b981' : '#b91c1c';
  setTimeout(() => plansMsg.style.display = 'none', 3000);
}

/* ---------- 4) Ø§ØªØµØ§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ---------- */
if (document.getElementById('plansForm')) {
  loadPlanPrices();                                   // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
  document.getElementById('plansForm')
          .addEventListener('submit', savePlanPrices); // Ø°Ø®ÛŒØ±Ù‡ Ø±ÙˆÛŒ Ø¨Ú©â€ŒØ§Ù†Ø¯
  
  // listener Ø±ÙˆÛŒ input Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø¨Ø±Ø§ÛŒ reload Ù…ÙˆÙ‚Ø¹ ØªØºÛŒÛŒØ±
  document.getElementById('seller-phone-plans')
          .addEventListener('input', debounce(loadPlanPrices));
}







const adInputs = {
  'ad_search'   : document.getElementById('ad_search'),
  'ad_home'     : document.getElementById('ad_home'),
  'ad_products' : document.getElementById('ad_products')
};
const adsMsg = document.getElementById('adsMsg');

// ---------- 2) Ø®ÙˆØ§Ù†Ø¯Ù† Ù‚ÛŒÙ…Øªâ€Œ ØªØ¨Ù„ÛŒØºØ§Øª ----------
async function loadAdsPrices() {
  try {
    let phone = document.getElementById('seller-phone-ads').value.trim();
    phone = normalizePhone(phone);
    let url = `${API_BASE}/adplans`;
    if (phone) {
      url += `?sellerPhone=${encodeURIComponent(phone)}`;
    }
    const res  = await fetch(url, { credentials: 'include' });
    const json = await res.json();              // { adplans: { search:12000, â€¦ } }
    const prices = json.adplans || {};
    Object.keys(adInputs).forEach(k => {
      adInputs[k].value = prices[k] ?? '';
    });

    // Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ø®Ø§Ù„ÛŒ (ÛŒØ¹Ù†ÛŒ override Ù†Ø¯Ø§Ø±Ù‡)ØŒ Ù¾ÛŒØ§Ù… Ø¨Ø¯ÛŒØ¯
    if (phone && !Object.values(prices).some(p => p !== null)) {
      showAdsMsg('Ù‚ÛŒÙ…Øª Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡Ø› Ø§Ø² Ù‚ÛŒÙ…Øª Ø¹Ù…ÙˆÙ…ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.', true, phone);
    }
  } catch (err) {
    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª ØªØ¨Ù„ÛŒØºØ§Øª', err);
    showAdsMsg('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª ØªØ¨Ù„ÛŒØºØ§Øª!', false);
  }
}

// ---------- 3) Ø°Ø®ÛŒØ±Ù‡ Ù‚ÛŒÙ…Øª ØªØ¨Ù„ÛŒØºØ§Øª ----------
async function saveAdsPrices(e) {
  e.preventDefault();
  // Û±) payload
  const prices = {};
  Object.keys(adInputs).forEach(k => {
    const val = Number(adInputs[k].value);
    if (!Number.isNaN(val) && val > 0) prices[k] = val;
  });

  if (!Object.keys(prices).length) {
    showAdsMsg('Ù‡ÛŒÚ† Ù‚ÛŒÙ…Øª Ù…Ø¹ØªØ¨Ø±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯', false);
    return;
  }

  const body = { prices };


  const rawPhone   = document.getElementById('seller-phone-ads').value.trim();
  let sellerPhone  = normalizePhone(rawPhone);
  if (rawPhone && !sellerPhone) {
    showAdsMsg('Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.', false);
    return;
  }

  if (sellerPhone && !(await sellerExists(sellerPhone))) {
    showAdsMsg('ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.', false);
    return;
  }


  if (sellerPhone) body.sellerPhone = sellerPhone;

  // Û²) ØªÙˆÚ©Ù†
  const token = getCookie('admin_token') || getCookie('access_token');

  try {
    // Û³) PUT
    const res = await fetch(`${API_BASE}/adplans/admin`, {
      method: 'PUT',
      headers: {
        'Content-Type':  'application/json',
        'Authorization': token ? 'Bearer ' + token : ''
      },
      credentials: 'include',
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!res.ok || data.success === false) {
      throw new Error(data.message || await res.text());
    }

    // Ø¨Ø¹Ø¯ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙÙ‚ØŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø±Ùˆ reload Ú©Ù†
    await loadAdsPrices();
    showAdsMsg('âœ… ' + (data.message || 'Ù‚ÛŒÙ…Øª ØªØ¨Ù„ÛŒØºØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.'), true, sellerPhone);
  } catch (err) {
    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù‚ÛŒÙ…Øª ØªØ¨Ù„ÛŒØºØ§Øª', err);
    showAdsMsg('âŒ ' + err.message, false, sellerPhone);
  }
}

// ---------- 4) Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… ----------
function showAdsMsg (txt, ok, phone = '') {
  adsMsg.textContent      = txt + (phone ? ` (Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ ${phone})` : ' (Ø¹Ù…ÙˆÙ…ÛŒ)');
  adsMsg.style.display    = 'block';
  adsMsg.style.background = ok ? '#e0fdfa' : '#fee2e2';
  adsMsg.style.color      = ok ? '#10b981' : '#b91c1c';
  setTimeout(() => adsMsg.style.display = 'none', 3000);
}

/* ---------- 5) Ø§ØªØµØ§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ---------- */
if (document.getElementById('adsForm')) {
  loadAdsPrices();                                   // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
  document.getElementById('adsForm')
          .addEventListener('submit', saveAdsPrices);// Ø°Ø®ÛŒØ±Ù‡ Ø±ÙˆÛŒ Ø¨Ú©â€ŒØ§Ù†Ø¯
  
  // listener Ø±ÙˆÛŒ input Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø¨Ø±Ø§ÛŒ reload Ù…ÙˆÙ‚Ø¹ ØªØºÛŒÛŒØ±
  document.getElementById('seller-phone-ads')
          .addEventListener('input', debounce(loadAdsPrices));
}







// â”€â”€â”€ Ø¨Ø§Ù„Ø§ÛŒ Ø¨Ø®Ø´ "Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ Ø¬Ø¯Ø§ÙˆÙ„" â”€â”€â”€
// â”€â”€â”€ Ø¨Ø§Ù„Ø§ÛŒ Ø¨Ø®Ø´ "Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ Ø¬Ø¯Ø§ÙˆÙ„" â”€â”€â”€
// â”€â”€â”€ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ <script> (Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø®Ø§Ù„ÛŒ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯) â”€â”€â”€
// â”€â”€â”€ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¯Ø± Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† â”€â”€â”€

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


// Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø¯Ø§Ù„ HTML
const modalWrapper = document.createElement('div');
modalWrapper.id = 'chatModal';
modalWrapper.innerHTML = `
  <div class="modal-overlay" onclick="closeModal()"></div>
  <div class="modal-content">
    <h3>Ú¯ÙØªÚ¯Ùˆ</h3>
    <div id="chatMessages" class="chat-messages"></div>
    
    <div class="chat-input-area">
      <textarea id="chatReplyInput" rows="2" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
      <button onclick="sendAdminMessage()">Ø§Ø±Ø³Ø§Ù„</button>
      <!-- â†“ Ø¯Ú©Ù…Ù‡Ù” Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ â†“ -->
      <button class="action-btn block" onclick="blockCurrentSender()">Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ ÙØ±Ø³ØªÙ†Ø¯Ù‡</button>
      <button class="action-btn unblock" id="unblockBtn" onclick="unblockCurrentSender()" style="display:none">Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù†</button>
      <span id="blockedBadge" class="blocked-badge" style="display:none">Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡</span>
    </div>

    <button class="modal-close" onclick="closeModal()">Ø¨Ø³ØªÙ†</button>
  </div>
`;

document.body.appendChild(modalWrapper);

// Ù…ØªØºÛŒØ± Ú©Ù…Ú©ÛŒ
let currentChatId = null;

// Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¯Ø§Ù„
window.openChatModal = async function (chatId) {
  currentChatId = chatId;
  const chat = messagesList.find(c => c._id === chatId);
  const container = document.getElementById('chatMessages');
  container.innerHTML = '';
  document.getElementById('chatReplyInput').disabled = false;
  document.getElementById('blockedBadge').style.display = 'none';
  document.getElementById('unblockBtn').style.display = 'none';
  const blockBtn = document.querySelector('#chatModal .action-btn.block');
  if (blockBtn) blockBtn.style.display = 'inline-block';

  if (chat && chat.blockedByAdmin) {
    document.getElementById('chatReplyInput').disabled = true;
    document.getElementById('blockedBadge').style.display = 'inline-block';
    document.getElementById('unblockBtn').style.display = 'inline-block';
    if (blockBtn) blockBtn.style.display = 'none';
  }

  // ğŸŸ¢ Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… ÙØ±ÙˆØ´Ù†Ø¯Ù‡ ÛŒØ§ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø®ÙˆÙ†Ø¯Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡ØŒ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø§Ø·Ù„Ø§Ø¹ Ø¨Ø¯Ù‡ Ú©Ù‡ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù†Ø¯
  if (chat) {
    const unreadMsgIds = (chat.messages || [])
      .filter(m => (m.from === 'seller' || m.from === 'user') && !m.read)
      .map(m => m._id)
      .filter(Boolean);

    if (unreadMsgIds.length > 0) {
      try {
        const token = getCookie('admin_token') || getCookie('access_token');
        await fetch(`${API_BASE}/chats/${chatId}/mark-read`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token && { Authorization: 'Bearer ' + token })
          },
          credentials: 'include',
          body: JSON.stringify({ messageIds: unreadMsgIds })
        });
        // ØªÙˆÛŒ Ù„ÛŒØ³Øª Ù…Ø­Ù„ÛŒ Ù‡Ù… Ø¨Ø±Ùˆ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø±Ùˆ Ø®ÙˆØ§Ù†Ø¯Ù‡â€ŒØ´Ø¯Ù‡ Ú©Ù†
        chat.messages.forEach(m => {
          if (unreadMsgIds.includes(m._id)) m.readByAdmin = true;
          if (unreadMsgIds.includes(m._id)) m.read = true;
        });
        updateSidebarCounts(); // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ù¾ÛŒØ§Ù… Ø¢Ù¾Ø¯ÛŒØª Ø´Ù‡
        renderMessages();      // Ø¬Ø¯ÙˆÙ„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø±ÙØ±Ø´ Ø´Ù‡
      } catch (e) {
        console.warn('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§:', e);
      }
    }
  }

  if (!chat || !chat.messages?.length) {
    container.innerHTML = '<p style="text-align:center;color:#888">Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
  } else {
    chat.messages.forEach(msg => {
     const sender = getSenderName(chat, msg);


      const date = new Date(msg.createdAt || msg.date).toLocaleString('fa-IR', {
        hour12: false,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });

      const div = document.createElement('div');
      div.className = 'chat-bubble ' + msg.from;
      div.innerHTML = `
        <div class="sender">${sender}</div>
        <div class="text">${msg.text || '-'}</div>
        <div class="time">${date}</div>`;
      container.appendChild(div);
    });
  }

  document.getElementById('chatModal').classList.add('show');
  document.getElementById('chatReplyInput').focus();

  setTimeout(() => {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
  }, 100);
};


// Ø¨Ø³ØªÙ† Ù…Ø¯Ø§Ù„
window.closeModal = function () {
  document.getElementById('chatModal').classList.remove('show');
  document.getElementById('chatReplyInput').value = '';
  currentChatId = null;
};

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø² Ø·Ø±Ù Ø§Ø¯Ù…ÛŒÙ†
// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø² Ø·Ø±Ù Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„ Ú¯ÙØªÚ¯Ùˆ
// â”€â”€â”€ Ø¯Ø± Ø¨Ø®Ø´ <script> Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† â”€â”€â”€
// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø² Ø·Ø±Ù Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„ Ú¯ÙØªÚ¯Ùˆ
// Ø¯Ø± ÙØ§ÛŒÙ„ JS ÙØ±Ø§Ù†Øª-Ù†Ø¯ (Ù…Ø«Ù„Ø§Ù‹ public/js/main.js ÛŒØ§ Ø¯Ø§Ø®Ù„ ØªÚ¯ <script> Ø¯Ø± HTML)
// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø² Ø·Ø±Ù Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„ Ú¯ÙØªÚ¯Ùˆ
window.sendAdminMessage = async function () {
  const text = document.getElementById('chatReplyInput').value.trim();
  if (!text)          return alert('Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
  if (!currentChatId) return alert('Ú†Øª Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');

  try {
    const res = await fetch(`${API_BASE}/chats/${currentChatId}/admin-reply`, {
      method: 'POST',
      credentials: 'include', // Ø§Ø±Ø³Ø§Ù„ Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ÛŒ HttpOnly Ù…Ø«Ù„ admin_token
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ text })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù….');

    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙÙ‚
    const idx = messagesList.findIndex(c => c._id === currentChatId);
    if (idx !== -1) messagesList[idx] = data;

    openChatModal(currentChatId); // Ù…ÙˆØ¯Ø§Ù„ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†
    document.getElementById('chatReplyInput').value = '';
    updateSidebarCounts();

  } catch (err) {
    console.error('âŒ sendAdminMessage error:', err);
    alert('âŒ ' + err.message);
  }
};








// Ø¨Ø³ØªÙ† Ù…Ø¯Ø§Ù„ Ø¨Ø§ Ú©Ù„ÛŒØ¯ ESC
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});



document.addEventListener('DOMContentLoaded', () => {
  const header = document.getElementById('broadcastHeader');
  const card   = document.getElementById('broadcastCard');

  header.addEventListener('click', () => {
    card.classList.toggle('collapsed');
  });
});





/**
 * Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ ÙØ±Ø³ØªÙ†Ø¯Ù‡Ù” Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù… Ø¯Ø± Ú†Øª Ø¬Ø§Ø±ÛŒ
 */
async function blockCurrentSender() {
  if (!currentChatId) return alert('Ø´Ù†Ø§Ø³Ù‡Ù” Ú†Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.');
  const chat = messagesList.find(c => c._id === currentChatId) || {};
  const targetRole = chat.sellerId ? 'seller' : 'user';
  const targetId   = chat.sellerId || chat.customerId || chat.userId;
  const label      = targetRole === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : 'Ù…Ø´ØªØ±ÛŒ';

  if (!targetId) return alert('Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.');
  if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† ${label} Ø±Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ù†ÛŒØ¯ØŸ`)) return;

  try {
    console.log('blockCurrentSender ->', { targetId, targetRole });
    const res = await fetch(`${API_BASE}/chats/block-target`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({ targetId, targetRole })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ');

    alert('âœ… ' + (data.message || 'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯.'));
    document.getElementById('chatReplyInput').disabled = true;
    document.getElementById('blockedBadge').style.display = 'inline-block';
    await fetchMessages();
  } catch (err) {
    console.error('âŒ blockCurrentSender error:', err);
    alert('âŒ ' + err.message);
  }
}

async function unblockCurrentSender() {
  if (!currentChatId) return alert('Ø´Ù†Ø§Ø³Ù‡Ù” Ú†Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.');
  const chat = messagesList.find(c => c._id === currentChatId) || {};
  const targetRole = chat.sellerId ? 'seller' : 'user';
  const targetId   = chat.sellerId || chat.customerId || chat.userId;
  const label      = targetRole === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : 'Ù…Ø´ØªØ±ÛŒ';

  if (!targetId) return alert('Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.');
  if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† ${label} Ø±Ø§ Ø¢Ø²Ø§Ø¯ Ú©Ù†ÛŒØ¯ØŸ`)) return;

  try {
    console.log('unblockCurrentSender ->', { targetId, targetRole });
    const res = await fetch(`${API_BASE}/chats/unblock-target`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({ targetId, targetRole })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒ');

    alert('âœ… ' + (data.message || 'Ú©Ø§Ø±Ø¨Ø± Ø¢Ø²Ø§Ø¯ Ø´Ø¯.'));
    await fetchMessages();
    openChatModal(currentChatId);
  } catch (err) {
    console.error('âŒ unblockCurrentSender error:', err);
    alert('âŒ ' + err.message);
  }
}



async function sendBroadcastMessage() {
  const target = document.querySelector('#broadcastTarget').value;
  const text   = document.querySelector('#broadcastText').value.trim();
  const status = document.querySelector('#broadcastStatus');

  if (!text) {
    status.style.color = '#f43f5e';
    status.textContent = 'Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.';
    return;
  }
  status.style.color = '#888';
  status.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';

  try {
    const res = await fetch(`${API_BASE}/chats/broadcast`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({ target, text })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ');
    status.style.color = '#10b981';
    status.textContent = `âœ… Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ ${data.sent || 0} Ù†ÙØ± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.`;
    document.querySelector('#broadcastText').value = '';
  } catch (err) {
    console.error('âŒ sendBroadcastMessage error:', err);
    status.style.color = '#f43f5e';
    status.textContent = 'âŒ ' + err.message;
  }
}




async function fetchUnreadCountAndUpdateBadge() {
  try {
   const res = await fetch(`${API_BASE}/chats/all`, {
  credentials: 'include'
});
    if (!res.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø´Ù…Ø§Ø±Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§");
    const data = await res.json();
    const chats = Array.isArray(data) ? data : (data.chats || []);
    let total = 0;
    chats.forEach(chat => {
      if (Array.isArray(chat.messages)) {
        total += chat.messages.filter(
          m => (m.from === 'seller' || m.from === 'user') && !m.read
        ).length;
      }
    });
    document.getElementById('count-messages').textContent = total > 0 ? total : '';
    document.getElementById('header-messages-count').textContent = total > 0 ? `(${total} Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯)` : '';
  } catch (e) {
    document.getElementById('count-messages').textContent = '';
    document.getElementById('header-messages-count').textContent = '';
  }
}

function startBadgePolling() {
  if (badgeInterval) clearInterval(badgeInterval);
  fetchUnreadCountAndUpdateBadge();
  badgeInterval = setInterval(fetchUnreadCountAndUpdateBadge, 7000); // Ù‡Ø± Û· Ø«Ø§Ù†ÛŒÙ‡ ÛŒÚ©Ø¨Ø§Ø±
}
startBadgePolling();

// Ù„ÙˆØ¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø¢Ù…Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ø§ AJAX
function loadDailyVisContent() {
  const panel = document.getElementById('daily-visits-panel');
  panel.innerHTML = '<p style="text-align:center;color:#888">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù…Ø­ØªÙˆØ§...</p>';

  const xhr = new XMLHttpRequest();
  xhr.open('GET', 'admin-dailyVis.html', true);  // Ø§Ú¯Ø± Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„ Ù…ØªÙØ§ÙˆØª Ø¨ÙˆØ¯ØŒ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡ (Ù…Ø«Ù„Ø§Ù‹ 'admin/admin-dailyVis.html')

  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4 && xhr.status === 200) {
      // Parse Ù…Ø­ØªÙˆØ§ÛŒ HTML Ø¨Ø§ DOMParser
      const parser = new DOMParser();
      const doc = parser.parseFromString(xhr.responseText, 'text/html');

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ØŒ ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ Ùˆ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ù‡ <head> ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ (Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ CSS Ùˆ Tailwind)
      const headElements = doc.querySelectorAll('head > *');
      headElements.forEach(el => {
        if (el.tagName === 'LINK' || el.tagName === 'STYLE' || el.tagName === 'SCRIPT') {
          // Ú†Ú© Ú©Ù† Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡ØŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† (Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø±)
          if (!document.querySelector(`[href="${el.href}"], [src="${el.src}"]`)) {
            document.head.appendChild(el.cloneNode(true));
          }
        }
      });

      // Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ <body> Ø¯Ø± Ù¾Ù†Ù„
      panel.innerHTML = doc.body.innerHTML;

      // Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„ (Ø¨Ø§ Ø§ÛŒØ¬Ø§Ø¯ ØªÚ¯ <script> Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø¯Ø§Ù…)
      const scripts = doc.querySelectorAll('script');
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ body Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§
        document.body.appendChild(newScript);
      });
    } else if (xhr.readyState === 4) {
      panel.innerHTML = '<p style="text-align:center;color:#ef4444">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù…Ø­ØªÙˆØ§. Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„ Ø±Ùˆ Ú†Ú© Ú©Ù† ÛŒØ§ ØµÙØ­Ù‡ Ø±Ùˆ Ø±ÙØ±Ø´ Ú©Ù†.</p>';
    }
  };
  xhr.send();
}

// Ù„ÙˆØ¯ Ù…Ø­ØªÙˆØ§ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ø¨Ø§ AJAX
// â”€â”€â”€ ØªØ§Ø¨Ø¹ Ø¨Ù‡Ø¨ÙˆØ¯ÛŒØ§ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ Ù…Ø­ØªÙˆØ§ÛŒ Ú¯Ø²Ø§Ø±Ø´Ø§Øª â”€â”€â”€
// â”€â”€â”€ Û±) ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ AJAX Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ â”€â”€â”€
// â”€â”€â”€ 1) ØªØ§Ø¨Ø¹ AJAX Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ (reports.html) â€“ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø¨Ø§ AJAX
   Ø§ÛŒÙ† Ø¨Ù„ÙˆÚ© Ø±Ø§ Ø¯Ø± Ù‡Ù…Ø§Ù† <script> Ø§ØµÙ„ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ Ùˆ
   Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ loadReportsContent / loadDefaultReportsContent
   Ø±Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø­Ø°Ù Ú©Ù†.                                          
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function loadReportsContent () {
  const panel = panels['reports'];

  /* 1) Ù¾ÛŒØ§Ù… Â«Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒâ€¦Â» */
  panel.innerHTML =
    '<p style="text-align:center;color:#888">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§â€¦</p>';

  const xhr = new XMLHttpRequest();
  /* ÙØ§ÛŒÙ„ reports.html Ø¯Ø± Ù‡Ù…Ø§Ù† Ù¾ÙˆØ´Ù‡Ù” Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø³Øª */
  xhr.open('GET', 'reports.html', true);
  xhr.timeout = 5000;                   // Ûµâ€¯Ø«Ø§Ù†ÛŒÙ‡ Ù…Ù‡Ù„Øª

  xhr.onreadystatechange = () => {
    if (xhr.readyState !== 4) return;

    if (xhr.status === 200) {
      /* 2) Parse Ùˆ ØªØ²Ø±ÛŒÙ‚ Ù…Ø­ØªÙˆØ§Ù‰ ÙØ§ÛŒÙ„ */
      const doc = new DOMParser()
        .parseFromString(xhr.responseText, 'text/html');

      /* 3) Ø§ÙØ²ÙˆØ¯Ù† CSS / Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø¨Ù‡ <head> (Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ù†Ø¨ÙˆØ¯Ù†Ø¯) */
      doc.head.querySelectorAll('link,style').forEach(el => {
        if (el.tagName === 'LINK') {
          if (!document.querySelector(`link[href="${el.href}"]`)) {
            document.head.appendChild(el.cloneNode(true));
          }
        } else {
          document.head.appendChild(el.cloneNode(true));
        }
      });

      /* 4) Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø¨Ø¯Ù†Ù‡Ù” ÙØ§ÛŒÙ„ Ø¯Ø± Ù¾Ù†Ù„ Â«reportsÂ» */
      panel.innerHTML = doc.body.innerHTML;

      /* 5) Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… <script>â€ŒÙ‡Ø§ÛŒ reports.html */
      doc.querySelectorAll('script').forEach(old => {
        const s = document.createElement('script');
        if (old.src) s.src = old.src;
        else         s.textContent = old.textContent;
        document.body.appendChild(s);
      });

    } else {
      loadDefaultReportsContent();   // ÙØ§ÛŒÙ„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ ÛŒØ§ Ø®Ø·Ø§ÛŒ HTTP
    }
  };

  xhr.onerror   = loadDefaultReportsContent;
  xhr.ontimeout = loadDefaultReportsContent;
  xhr.send();
}

/* 2) Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ reports.html */
function loadDefaultReportsContent () {
  const panel = panels['reports'];
  panel.innerHTML = `
    <div style="text-align:center;padding:2rem;">
      <h2 style="color:#10b981;font-weight:900">Ú¯Ø²Ø§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h2>
      <p style="color:#666">
        Ù†ØªÙˆØ§Ù†Ø³ØªÙ… <code>reports.html</code> Ø±Ø§ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ú©Ù†Ù…Ø›
        Ù„Ø·ÙØ§Ù‹ Ù…Ø³ÛŒØ± ÛŒØ§ Ø§ØªØµØ§Ù„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.
      </p>
    </div>`;
}

/* 3) Ø§ØªØµØ§Ù„ ØªØ¨ Â«Ú¯Ø²Ø§Ø±Ø´Ø§ØªÂ» Ø¨Ù‡ Ø§ÛŒÙ† Ù…Ù†Ø·Ù‚ */
panels['reports'] = document.getElementById('reports-panel');

menuLinks.forEach(link => {
  if (link.dataset.section !== 'reports') return;

  let loaded = false;        // ÙÙ‚Ø· Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± AJAX Ø¨Ø²Ù†
  link.addEventListener('click', () => {
    if (!loaded) {
      loadReportsContent();
      loaded = true;
    }
  });
});




</script>

<div id="seller-modal-overlay" class="seller-modal-overlay" style="display:none"></div>



<div id="sender-modal-overlay" class="sender-modal-overlay"></div>

<div id="user-modal-overlay" class="user-modal-overlay" style="display:none"></div>
</body>
</html>