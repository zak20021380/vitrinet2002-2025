<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; img-src 'self' data:; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests; block-all-mixed-content">
<meta http-equiv="Strict-Transport-Security" content="max-age=63072000; includeSubDomains; preload">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="Referrer-Policy" content="no-referrer">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta name="referrer" content="no-referrer">
<meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <script src="/security.js" defer></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>پنل مدیریت گزارش‌های فروشندگان | ویترینت</title>
  <!-- فونت Vazirmatn -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Vazirmatn", sans-serif; }
    .panel-card {
      background: #fff; border-radius: 1.3rem;
      box-shadow: 0 2px 18px rgba(14,165,233,.11);
      padding: 32px 26px;
      transition: .2s;
    }
    .panel-card:hover { box-shadow: 0 8px 24px rgba(14,165,233,.16); transform: translateY(-3px); }
    .report-table { width: 100%; background: #fff; border-radius: 1.3rem;
      box-shadow: 0 8px 32px rgba(16,185,129,.10); overflow: hidden; }
    .report-table table { width: 100%; border-collapse: collapse; min-width: auto;}
    .report-table th, .report-table td { text-align: center; padding: 12px; font-size: 16px; }
    .report-table th { background: #d1fae5; color: #047857; font-weight: 800; }
    .report-table td { color: #333; border-bottom: 1px solid rgba(16,185,129,.1); }
    .report-table tr:hover { background: #e0fdfa; }
    @media(max-width:800px) {
      .panel-card { padding: 18px 7px; }
      .report-table th, .report-table td { font-size: 14px; padding: 7px 3px;}
    }
    @media(max-width:600px) {
      .report-table th, .report-table td { font-size: 13px; padding: 6px 2px;}
    }
    .search-input { transition: all 0.3s; }
    .search-input:focus { box-shadow: 0 0 0 3px rgba(16,185,129,.19); }
    .modal-overlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;
      z-index:1000; opacity:0; visibility:hidden; transition:.3s;
    }
    .modal-overlay.active { opacity:1; visibility:visible; }
    .modal-container {
      background: #fff; border-radius: 1.5rem; box-shadow: 0 20px 50px rgba(0,0,0,.15);
      max-width: 95vw; width: 540px; max-height: 92vh; overflow-y: auto;
      transform: translateY(35px); transition: .4s; opacity:0;
      display: flex; flex-direction: column;
    }
    .modal-overlay.active .modal-container {
      transform: translateY(0); opacity:1;
    }
    .modal-header {
      background: linear-gradient(to right, #10b981, #0ea5e9);
      padding: 20px 25px 17px 20px; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem;
      color: #fff; display: flex; align-items: center; justify-content: space-between;
    }
    .modal-header h2 { font-size: 1.2rem; font-weight: 800; margin:0; }
    .close-modal { background: none; border: none; color: #fff; font-size: 2.1rem; cursor: pointer; }
    .close-modal:hover { transform: scale(1.19);}
    .modal-body { padding: 18px 12px 14px;}
    .stat-box {
      background: #f8fafc; border-radius: 1rem; padding: 13px 0; text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.02); margin-bottom: 13px;
    }
    .stat-label { font-size: 0.9rem; color: #64748b; margin-bottom: 6px; font-weight: 600;}
    .stat-value { font-size: 1.2rem; font-weight: 800; color: #1e293b; direction: ltr;}
    .badge { display:inline-block; min-width:56px; border-radius:999px; font-size:13px; font-weight:bold; padding:2px 13px;}
    .badge-new { background:#bfdbfe; color:#1d4ed8;}
    .badge-progress { background:#fef08a; color:#92400e;}
    .badge-rejected { background:#fecaca; color:#b91c1c;}
    .badge-resolved { background:#bbf7d0; color:#166534;}
    .cat { border-radius: .8rem; background: #f3f4f6; color: #0ea5e9; font-size: 13px; font-weight: 700; padding: 4px 16px;}
    .modal-body { max-height:65vh; overflow-y:auto;}
    @keyframes fadeIn { from { opacity: 0; transform: translateY(16px);} to { opacity:1; transform: translateY(0);} }
    .animate-fadeIn { animation: fadeIn .45s cubic-bezier(.36,1.32,.3,1) both; }
    .modal-detail-container { background: #fff; border-radius: 1.2rem; box-shadow: 0 10px 40px rgba(0,0,0,.13);
      max-width: 95vw; width: 390px; max-height: 92vh; overflow-y: auto; padding: 0;
      transform: translateY(28px); opacity:0; transition:.34s; display: flex; flex-direction:column;}
    .modal-overlay.active .modal-detail-container { transform: translateY(0); opacity:1; }
    .modal-detail-header {
      background: linear-gradient(to right, #10b981, #0ea5e9);
      padding: 18px 20px 15px 14px; border-top-left-radius: 1.2rem; border-top-right-radius: 1.2rem;
      color: #fff; display: flex; align-items: center; justify-content: space-between;
    }
    .modal-detail-header h3 { font-size: 1.1rem; font-weight: 700; margin:0;}
    .modal-detail-close { background:none; border:none; color:#fff; font-size:1.85rem; cursor:pointer;}
    .modal-detail-close:hover { transform: scale(1.13);}
    .modal-detail-body { padding: 17px 18px 17px;}
    .modal-detail-row { display: flex; align-items: flex-start; margin-bottom: 11px;}
    .modal-detail-label { min-width: 100px; font-weight: 700; color: #0ea5e9; font-size: 14px;}
    .modal-detail-value { color: #232323; font-size: 14px; word-break: break-word;}
    @media(max-width:480px) {
      .modal-container { width: 98vw; min-width: 0; }
      .modal-detail-container { width: 99vw; min-width: 0;}
      .modal-header, .modal-detail-header { padding-right: 13px; padding-left: 8px;}
      .modal-body, .modal-detail-body { padding: 7px 3vw 9px;}
      .stat-box { padding: 8px 0;}
      .modal-detail-label { min-width: 80px; font-size: 13px;}
      .modal-detail-value { font-size: 13px;}
    }
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    body { font-size: 16px; }
    h1, h2, h3 { font-weight: 900; }
    .stat-value { font-size: 1.3rem; }
    .stat-label { font-size: 1rem; }
  </style>
  <script src="/nav-active.js" defer></script>
</head>
<body class="bg-gradient-to-br from-[#e0fdfa] to-[#d4fbe8] min-h-screen pb-6 px-2 sm:px-4 md:px-8">
<div class="max-w-5xl mx-auto space-y-7 pt-7 md:pt-10 animate-fadeIn">

  <!-- هدر -->
  <header class="text-center mb-2">
    <h1 class="text-2xl xs:text-3xl md:text-4xl font-extrabold text-[#10b981] mb-2 leading-tight">
      مدیریت گزارش‌های فروشندگان | ویترینت
    </h1>
    <p class="text-gray-600 text-sm xs:text-base md:text-lg">
      مشاهده، جستجو، فیلتر و رسیدگی به گزارش‌های کاربران درباره مغازه‌ها
    </p>
  </header>

  <!-- فرم جستجو و فیلتر -->
  <div class="panel-card flex flex-col sm:flex-row gap-6 sm:gap-7">
    <!-- جستجو -->
    <div class="flex-1">
      <h2 class="text-base md:text-lg font-bold text-[#10b981] mb-3 text-center">
        جستجوی فروشنده یا مغازه
      </h2>
      <input id="searchInput" type="text" placeholder="نام فروشنده یا فروشگاه..."
        class="w-full p-3 border rounded-xl search-input text-sm xs:text-base">
    </div>
    <!-- فیلترها -->
    <div class="flex-1">
      <h2 class="text-base md:text-lg font-bold text-[#10b981] mb-3 text-center">
        فیلتر پیشرفته
      </h2>
      <div class="flex flex-col gap-4">
        <select id="categoryFilter" class="w-full p-2 border rounded-xl text-sm xs:text-base">
          <option value="">دسته‌بندی همه</option>
          <option value="عدم تطابق قیمت">عدم تطابق قیمت</option>
          <option value="پاسخ‌ندادن به مشتری">پاسخ‌ندادن به مشتری</option>
          <option value="گران‌فروشی یا هزینهٔ اضافی">گران‌فروشی یا هزینهٔ اضافی</option>
          <option value="مسدودسازی یا رفتار نامناسب">مسدودسازی یا رفتار نامناسب</option>
          <option value="سایر">سایر</option>
        </select>
        <select id="statusFilter" class="w-full p-2 border rounded-xl text-sm xs:text-base">
          <option value="">همه وضعیت‌ها</option>
          <option value="pending">جدید</option>
          <option value="reviewing">بررسی‌شده</option>
          <option value="resolved">رسیدگی شد</option>
          <option value="rejected">رد شد</option>
        </select>
      </div>
    </div>
  </div>

  <!-- نمودار -->
  <div class="panel-card py-4 px-1 sm:px-6">
    <div class="pie-chart-wrap flex justify-center">
      <canvas id="pieChart" class="max-w-[300px] max-h-[300px]"></canvas>
    </div>
  </div>

  <!-- جدول گزارش‌ها -->
  <div class="report-table table-responsive">
    <h2 class="text-base md:text-lg font-bold text-[#10b981] mb-2 mt-2 text-center">
      لیست گزارش‌های کاربران
    </h2>
    <table>
      <thead>
        <tr>
          <th>نام فروشنده/مغازه</th>
          <th>دسته</th>
          <th>متن گزارش</th>
          <th>گزارش‌دهنده</th>
          <th>تاریخ</th>
          <th>وضعیت</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody id="reportTableBody">
        <!-- پر می‌شود -->
      </tbody>
    </table>
    <div id="noResults" class="py-8 text-center text-gray-400 text-base hidden">
      گزارشی یافت نشد.
    </div>
  </div>
</div>

<!-- Modal گزارشات فروشنده -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-container animate-fadeIn">
    <div class="modal-header">
      <h2 id="modalTitle">جزئیات گزارش‌های فروشنده</h2>
      <button class="close-modal" id="closeModalBtn">×</button>
    </div>
    <div class="modal-body">
      <div class="grid grid-cols-2 gap-4 mb-5">
        <div class="stat-box">
          <div class="stat-label">تعداد کل گزارش‌ها</div>
          <div class="stat-value" id="modalReportCount">۰</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">دسته پرتکرار</div>
          <div class="stat-value" id="modalTopCat">-</div>
        </div>
      </div>
      <h3 class="font-bold text-[#0ea5e9] mb-3 text-center">همه گزارش‌های این فروشنده</h3>
      <div id="modalReportsList" class="space-y-3 pr-1"></div>
    </div>
  </div>
</div>

<!-- Modal جزئیات هر گزارش -->
<div class="modal-overlay" id="modalDetailOverlay">
  <div class="modal-detail-container animate-fadeIn">
    <div class="modal-detail-header">
      <h3 id="modalDetailTitle">جزئیات کامل گزارش</h3>
      <button class="modal-detail-close" id="closeModalDetailBtn">×</button>
    </div>
    <div class="modal-detail-body" id="modalDetailBody">
      <!-- پر می‌شود -->
    </div>
  </div>
</div>

<script>
  // تنظیم فونت برای Chart.js
  Chart.defaults.font.family = 'Vazirmatn';

  // مپینگ نوع گزارش به فارسی
  const typeMap = {
    'price_mismatch': 'عدم تطابق قیمت',
    'no_response': 'پاسخ‌ندادن به مشتری',
    'overpricing': 'گران‌فروشی یا هزینهٔ اضافی',
    'block': 'مسدودسازی یا رفتار نامناسب',
    'other': 'سایر'
  };

  // مپینگ وضعیت به فارسی
  const statusMap = {
    'pending': 'جدید',
    'reviewing': 'بررسی‌شده',
    'resolved': 'رسیدگی شد',
    'rejected': 'رد شد'
  };

  // مپینگ وضعیت به کلاس بج
  function badgeClass(status) {
    const mappedStatus = statusMap[status] || status;
    if (mappedStatus === "جدید") return "badge badge-new";
    if (mappedStatus === "بررسی‌شده") return "badge badge-progress";
    if (mappedStatus === "رسیدگی شد") return "badge badge-resolved";
    if (mappedStatus === "رد شد") return "badge badge-rejected";
    return "badge";
  }

  const faDigits = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
  const toFaDigits = (value) => {
    const str = (value ?? '').toString();
    return str.replace(/[0-9]/g, d => faDigits[Number(d)]);
  };

  // تبدیل تاریخ میلادی به شمسی ساده (بدون کتابخانه)
  function toJalaliDate(isoDate) {
    const date = new Date(isoDate);
    const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', calendar: 'persian' };
    return new Intl.DateTimeFormat('fa-IR', options).format(date);
  }

  let reports = []; // داده‌ها از بک‌اند

  const updateReportsCount = () => {
    const countEl = document.getElementById('count-reports');
    if (countEl) {
      countEl.textContent = toFaDigits(reports.length);
    }
  };

  updateReportsCount();

  // دریافت گزارش‌ها از API
  async function fetchReports() {
    try {
      const response = await fetch('/api/reports');
      if (!response.ok) throw new Error('خطا در دریافت داده‌ها');
      const data = await response.json();

      reports = data.map(r => {
        const fullName = `${r.sellerId?.firstname || ''} ${r.sellerId?.lastname || ''}`.trim();
        const reporterName = r.userId
          ? `${r.userId.firstname || ''} ${r.userId.lastname || ''}`.trim()
          : '';
        const contactInfo = (typeof r.contact === 'string' && r.contact.trim())
          ? r.contact.trim()
          : (r.userId?.phone || '');

        return {
          id: r._id,
          seller: r.sellerId
                  ? (fullName || r.sellerId.storename || r.sellerId.shopurl || '-')
                  : (r.shopurl || '-'),
          shopurl: (r.sellerId?.shopurl || r.shopurl || '').trim(),
          sellerPhone: r.sellerId?.phone || '-',
          sellerAddress: r.sellerId?.address || '-',
          category: typeMap[r.type] || r.type,
          message: r.description,
          date: toJalaliDate(r.createdAt),
          status: statusMap[r.status] || r.status,
          rawStatus: r.status,
          user: reporterName || '-',
          contact: contactInfo || '-',
          type: r.type
        };
      });

      filterReports();
      updateReportsCount();
    } catch (err) {
      console.error('خطا در fetch:', err);
      alert('خطایی در بارگذاری گزارش‌ها رخ داد.');
    }
  }

  async function updateReportStatus(id, status) {
    try {
      const res = await fetch(`/api/reports/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      if (!res.ok) {
        let message = 'خطا در بروزرسانی وضعیت';
        const contentType = res.headers.get('Content-Type') || '';
        if (contentType.includes('application/json')) {
          const data = await res.json().catch(() => ({}));
          if (data?.message) message = data.message;
        }
        throw new Error(message);
      }
      return true;
    } catch (err) {
      console.error(err);
      alert(err.message || 'خطا در بروزرسانی وضعیت');
      return false;
    }
  }

  async function deleteReport(id) {
    try {
      const res = await fetch(`/api/reports/${id}`, { method: 'DELETE' });
      if (!res.ok) {
        let message = 'خطا در حذف گزارش';
        const contentType = res.headers.get('Content-Type') || '';
        if (contentType.includes('application/json')) {
          const data = await res.json().catch(() => ({}));
          if (data?.message) message = data.message;
        }
        throw new Error(message);
      }
      return true;
    } catch (err) {
      console.error(err);
      alert(err.message || 'خطا در حذف گزارش');
      return false;
    }
  }

  
  // رندر جدول
  function renderReports(filtered) {
    const tbody = document.getElementById('reportTableBody');
    tbody.innerHTML = '';
    document.getElementById('noResults').classList.toggle('hidden', filtered.length > 0);

    filtered.forEach((r, i) => {
      const row = document.createElement('tr');
      row.className = "cursor-pointer transition hover:scale-[.98] hover:shadow";
      row.onclick = () => showReportDetailModal(r);

      // فروشنده (کلیک خور)
      const sellerTd = document.createElement('td');
      sellerTd.className = "font-bold text-blue-700 cursor-pointer hover:underline";
      sellerTd.textContent = r.seller;
      sellerTd.onclick = e => { e.stopPropagation(); showSellerModal(r.seller); };
      row.appendChild(sellerTd);

      // دسته
      const catTd = document.createElement('td');
      catTd.innerHTML = `<span class="cat">${r.category}</span>`;
      row.appendChild(catTd);

      // پیام
      const msgTd = document.createElement('td');
      msgTd.title = r.message;
      msgTd.textContent = r.message.length > 46 ? r.message.slice(0, 46) + "..." : r.message;
      row.appendChild(msgTd);

      // گزارش‌دهنده
      const reporterTd = document.createElement('td');
      reporterTd.innerHTML = `
        <div class="font-semibold text-slate-700">${r.user || '-'}</div>
        <div class="text-xs text-slate-500">${r.contact || '-'}</div>
      `;
      row.appendChild(reporterTd);

      // تاریخ
      const dateTd = document.createElement('td');
      dateTd.textContent = r.date;
      row.appendChild(dateTd);

      // وضعیت
      const statusTd = document.createElement('td');
      statusTd.innerHTML = `<span class="${badgeClass(r.rawStatus)}">${r.status}</span>`;
      row.appendChild(statusTd);

      // عملیات
      const actionsTd = document.createElement('td');
      actionsTd.className = 'flex justify-center items-center gap-4'; // افزایش فاصله به space-x-4

      // چک‌باکس برای بررسی‌شده با استایل متفاوت (بزرگ‌تر و گردتر)
      if (['pending', 'reviewing'].includes(r.rawStatus)) {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = r.rawStatus === 'reviewing';
        checkbox.className = 'w-6 h-6 rounded-full accent-green-600 cursor-pointer border-2 border-green-300 hover:border-green-500'; // استایل متفاوت: بزرگتر، گرد، بورد اضافه
        checkbox.onclick = async (e) => {
          e.stopPropagation();
          const newStatus = checkbox.checked ? 'reviewing' : 'pending';
          const ok = await updateReportStatus(r.id, newStatus);
          if (ok) {
            r.rawStatus = newStatus;
            r.status = statusMap[newStatus];
            filterReports();
          } else {
            checkbox.checked = !checkbox.checked;
          }
        };
        actionsTd.appendChild(checkbox);
      }

      // دکمه رد با استایل متفاوت (مستطیل، بولدتر، سایه)
      if (r.rawStatus !== 'rejected') {
        const rejectBtn = document.createElement('button');
        rejectBtn.textContent = 'رد';
        rejectBtn.className = 'border border-red-600 bg-red-100 text-red-700 font-bold px-4 py-1.5 rounded-lg hover:bg-red-600 hover:text-white text-sm shadow hover:shadow-md'; // استایل متفاوت: bg اضافه، font-bold، padding، rounded-lg، shadow
        rejectBtn.onclick = async (e) => {
          e.stopPropagation();
          if (confirm('آیا مطمئن هستید از رد این گزارش؟')) {
            const ok = await updateReportStatus(r.id, 'rejected');
            if (ok) {
              r.rawStatus = 'rejected';
              r.status = statusMap['rejected'];
              filterReports();
            }
          }
        };
        actionsTd.appendChild(rejectBtn);
      }

      if (!['resolved', 'rejected'].includes(r.rawStatus)) {
        const resolveBtn = document.createElement('button');
        resolveBtn.textContent = 'رسیدگی شد';
        resolveBtn.className = 'border border-emerald-600 bg-emerald-100 text-emerald-700 font-bold px-4 py-1.5 rounded-lg hover:bg-emerald-600 hover:text-white text-sm shadow hover:shadow-md';
        resolveBtn.onclick = async (e) => {
          e.stopPropagation();
          if (confirm('پس از تأیید به وضعیت «رسیدگی شد» تغییر می‌کند. ادامه می‌دهید؟')) {
            const ok = await updateReportStatus(r.id, 'resolved');
            if (ok) {
              r.rawStatus = 'resolved';
              r.status = statusMap['resolved'];
              filterReports();
            }
          }
        };
        actionsTd.appendChild(resolveBtn);
      }

      // دکمه حذف (بدون تغییر، اما فاصله حفظ می‌شه)
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = '×';
      deleteBtn.className = 'bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600 text-sm';
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        if (confirm('آیا مطمئن هستید از حذف این گزارش؟')) {
          const ok = await deleteReport(r.id);
          if (ok) {
            reports = reports.filter(rep => rep.id !== r.id);
            updateReportsCount();
            filterReports();
          }
        }
      };
      actionsTd.appendChild(deleteBtn);

      row.appendChild(actionsTd);

      tbody.appendChild(row);
    });
  }

  // فیلتر کردن
  function filterReports() {
    const searchInput = document.getElementById('searchInput');
    const search = (searchInput?.value || '').trim().toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    const status = document.getElementById('statusFilter').value;

    const filtered = reports.filter(r => {
      const haystacks = [r.seller, r.sellerPhone, r.user, r.contact, r.message, r.shopurl];
      const matchesSearch = !search || haystacks.some(val =>
        (val || '').toString().toLowerCase().includes(search)
      );
      const matchesCategory = !category || r.category === category;
      const matchesStatus = !status || r.rawStatus === status;
      return matchesSearch && matchesCategory && matchesStatus;
    });
    renderReports(filtered);
    drawPieChart(filtered);
  }

  // نمایش مدال فروشنده و آمار
  function showSellerModal(sellerName) {
    document.body.style.overflow = "hidden";
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('modalTitle').textContent = "گزارش‌های " + sellerName;

    const related = reports.filter(r => r.seller === sellerName);
    document.getElementById('modalReportCount').textContent = related.length;

    // بیشترین دسته پرتکرار
    const cats = {};
    related.forEach(r => cats[r.category] = (cats[r.category] || 0) + 1);
    let topCat = "-", topCount = 0;
    for (const [cat, cnt] of Object.entries(cats)) {
      if (cnt > topCount) { topCat = cat; topCount = cnt; }
    }
    document.getElementById('modalTopCat').textContent = topCat;

    // لیست گزارش (هرکدوم کلیک‌پذیر)
    document.getElementById('modalReportsList').innerHTML = related.map(r => `
      <div class="border rounded-xl px-3 py-2 bg-[#f3f4f6] cursor-pointer hover:bg-[#e0fdfa] transition" onclick="showReportDetailModalById('${r.id}')">
        <div class="flex items-center justify-between mb-1">
          <span class="cat">${r.category}</span>
          <span class="${badgeClass(r.rawStatus)}">${r.status}</span>
        </div>
        <div class="text-gray-800 text-[15px] mb-1">${r.message.length > 60 ? r.message.slice(0, 60)+'...' : r.message}</div>
        <div class="text-xs text-gray-500">${r.date}</div>
      </div>
    `).join('');
  }

  // مدال جزئیات کامل گزارش
  function showReportDetailModal(report) {
    document.body.style.overflow = "hidden";
    document.getElementById('modalDetailOverlay').classList.add('active');
    document.getElementById('modalDetailTitle').textContent = "جزئیات کامل گزارش";

    const hasShopUrl = report.shopurl && report.shopurl !== '-';
    const shopLink = hasShopUrl
      ? `/service-shops.html?shopurl=${encodeURIComponent(report.shopurl)}`
      : '';
    const shopUrlHtml = hasShopUrl
      ? `<a href="${shopLink}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">${report.shopurl}</a>`
      : '-';

    document.getElementById('modalDetailBody').innerHTML = `
      <div class="modal-detail-row"><span class="modal-detail-label">نام فروشنده:</span> <span class="modal-detail-value">${report.seller}</span></div>
      <div class="modal-detail-row"><span class="modal-detail-label">شماره موبایل فروشنده:</span> <span class="modal-detail-value">${report.sellerPhone}</span></div>
      <div class="modal-detail-row"><span class="modal-detail-label">آدرس فروشگاه:</span> <span class="modal-detail-value">${report.sellerAddress}</span></div>
      <div class="modal-detail-row"><span class="modal-detail-label">دسته:</span> <span class="modal-detail-value">${report.category}</span></div>
      <div class="modal-detail-row"><span class="modal-detail-label">وضعیت:</span> <span class="modal-detail-value"><span class="${badgeClass(report.rawStatus)}">${report.status}</span></span></div>
      <div class="modal-detail-row"><span class="modal-detail-label">تاریخ:</span> <span class="modal-detail-value">${report.date}</span></div>
      <div class="modal-detail-row"><span class="modal-detail-label">نام کاربر:</span> <span class="modal-detail-value">${report.user || '-'}</span></div>
      <div class="modal-detail-row"><span class="modal-detail-label">اطلاعات تماس کاربر:</span> <span class="modal-detail-value">${report.contact || '-'}</span></div>
      <div class="modal-detail-row"><span class="modal-detail-label">لینک فروشگاه:</span> <span class="modal-detail-value">${shopUrlHtml}</span></div>
      <div class="modal-detail-row"><span class="modal-detail-label">متن گزارش:</span> <span class="modal-detail-value">${report.message}</span></div>
    `;
  }
  // قابلیت فراخوانی از html
  window.showReportDetailModalById = id => {
    const r = reports.find(x => x.id === id);
    if (r) showReportDetailModal(r);
  };

  // بستن مدال اصلی
  document.getElementById('closeModalBtn').onclick = function() {
    document.getElementById('modalOverlay').classList.remove('active');
    document.body.style.overflow = "";
  }
  document.getElementById('modalOverlay').onclick = function(e) {
    if (e.target === this) {
      document.getElementById('closeModalBtn').click();
    }
  }
  // بستن مدال جزئیات
  document.getElementById('closeModalDetailBtn').onclick = function() {
    document.getElementById('modalDetailOverlay').classList.remove('active');
    document.body.style.overflow = "";
  }
  document.getElementById('modalDetailOverlay').onclick = function(e) {
    if (e.target === this) {
      document.getElementById('closeModalDetailBtn').click();
    }
  }
  // ESC
  document.addEventListener('keydown', function(e){
    if (e.key === "Escape") {
      if (document.getElementById('modalOverlay').classList.contains('active')) {
        document.getElementById('closeModalBtn').click();
      }
      if (document.getElementById('modalDetailOverlay').classList.contains('active')) {
        document.getElementById('closeModalDetailBtn').click();
      }
    }
  });

  // فیلترها
  document.getElementById('searchInput').oninput =
  document.getElementById('categoryFilter').onchange =
  document.getElementById('statusFilter').onchange = filterReports;

  // ----------- PIE CHART
  const pieColors = [
    "#10b981", "#0ea5e9", "#f59e42", "#e11d48", "#6d28d9", "#475569"
  ];
  let myPieChart = null;
  function drawPieChart(filtered) {
    const cats = {};
    filtered.forEach(r => cats[r.category] = (cats[r.category]||0)+1);
    const labels = Object.keys(cats);
    const data = Object.values(cats);

    const ctx = document.getElementById('pieChart').getContext('2d');

    if (myPieChart) {
      myPieChart.destroy();
    }

    if (labels.length === 0) {
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      ctx.font = "bold 18px Vazirmatn";
      ctx.fillStyle = "#9ca3af";
      ctx.textAlign = "center";
      ctx.fillText("داده‌ای نیست", ctx.canvas.width / 2, ctx.canvas.height / 2);
      return;
    }

    myPieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: pieColors.slice(0, labels.length),
          borderWidth: 1,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                size: 14,
                family: 'Vazirmatn'
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let sum = context.dataset.data.reduce((a, b) => a + b, 0);
                let percentage = Math.round((context.raw / sum) * 100);
                return `${context.label}: ${context.raw} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }

  // اولین بار: دریافت داده‌ها
  fetchReports();

</script>
</body>
</html>
