<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>پیام‌های کاربران</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-xl mx-auto bg-white rounded shadow p-4">
    <h2 class="text-lg font-bold mb-4">پیام کاربر</h2>
    <select id="userSelect" class="border rounded p-2 mb-2"></select>
    <div id="msgs" class="h-96 overflow-y-auto border rounded p-2 mb-2"></div>
    <div class="flex gap-2">
      <input id="msgInput" class="flex-1 border rounded p-2" placeholder="پیام">
      <button id="sendBtn" class="bg-blue-600 text-white px-4 rounded">ارسال</button>
    </div>
  </div>
<script>
let currentUser=null;
async function loadUsers(){
  const res=await fetch('/api/messages',{credentials:'include'});
  const ids=await res.json();
  const sel=document.getElementById('userSelect');
  sel.innerHTML=ids.map(id=>`<option value="${id}">${id}</option>`).join('');
  currentUser=ids[0];
  fetchMsgs();
}
async function fetchMsgs(){
  if(!currentUser) return;
  const res=await fetch(`/api/messages/${currentUser}`,{credentials:'include'});
  const data=await res.json();
  const box=document.getElementById('msgs');
  box.innerHTML=data.map(m=>`<div class="${m.senderModel==='Admin'?'text-right':'text-left'}"><div class="inline-block px-2 py-1 rounded ${m.senderModel==='Admin'?'bg-blue-100':'bg-gray-200'}">${m.message}</div><div class="text-xs text-gray-400">${new Date(m.timestamp).toLocaleString('fa-IR')}</div></div>`).join('');
  box.scrollTop=box.scrollHeight;
}
async function send(){
  const msg=document.getElementById('msgInput').value.trim();
  if(!msg||!currentUser) return;
  await fetch('/api/messages/send',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,userId:currentUser})});
  document.getElementById('msgInput').value='';
  fetchMsgs();
}
document.getElementById('userSelect').addEventListener('change',e=>{currentUser=e.target.value;fetchMsgs();});
document.getElementById('sendBtn').addEventListener('click',send);
loadUsers();
setInterval(fetchMsgs,5000);
</script>
</body>
</html>
