<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta http-equiv="Strict-Transport-Security" content="max-age=63072000; includeSubDomains; preload">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="Referrer-Policy" content="no-referrer">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta name="referrer" content="no-referrer">
<meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>پیام‌های کاربران</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/nav-active.js" defer></script>

<!-- TODO: فعال‌سازی پست‌هاگ را هنگام انتشار فراموش نکنید | TODO: Enable PostHog analytics when going live -->
<!--
<script>
  (function () {
    var config = window.POSTHOG_CONFIG || { enabled: false, apiKey: 'phc_YOUR_KEY_HERE', apiHost: 'https://analytics.vitreenet.ir' };
    if (!config.enabled) {
      return; // فعال نیست | Not enabled yet
    }
    try {
      (function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")),p.type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js";(r=t.getElementsByTagName("script")[0]),r.parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:u=e,u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==u._i&&(e+="."+u._i),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"};n="capture identify alias people.set people.set_once people.unset people.increment people.append people.union people.remove people.clear_opt_out_outcome register register_once unregister opt_out_capturing opt_in_capturing has_opted_out_capturing reset isFeatureEnabled onFeatureFlags reloadFeatureFlags group".split(" ");for(o=0;o<n.length;o++)g(u,n[o]);e._i.push([i,s,a])},e.__SV=1.1)})(document, window.posthog || []);
      window.posthog.init(config.apiKey, { api_host: config.apiHost, capture_pageview: true, advanced_disable_decide: true });
    } catch (error) {
      console.warn('PostHog init failed (preview mode):', error);
    }
  })();
</script>
-->

</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-xl mx-auto bg-white rounded shadow p-4">
    <h2 class="text-lg font-bold mb-4">پیام کاربر</h2>
    <select id="userSelect" class="border rounded p-2 mb-2"></select>
    <div id="msgs" class="h-96 overflow-y-auto border rounded p-2 mb-2"></div>
    <div class="flex gap-2">
      <input id="msgInput" class="flex-1 border rounded p-2" placeholder="پیام">
      <button id="sendBtn" class="bg-blue-600 text-white px-4 rounded">ارسال</button>
    </div>
  </div>
<script>
let currentUser=null;
async function loadUsers(){
  const res=await fetch('/api/messages',{credentials:'include'});
  const users=await res.json();
  const sel=document.getElementById('userSelect');
  sel.innerHTML=users.map(u=>{
    const name=((u.firstname||'')+' '+(u.lastname||'')).trim()||u.phone||u._id;
    return `<option value="${u._id}">${name}</option>`;
  }).join('');
  currentUser=users[0]?._id||null;
  fetchMsgs();
}
async function fetchMsgs(){
  if(!currentUser) return;
  const res=await fetch(`/api/messages/${currentUser}`,{credentials:'include'});
  const data=await res.json();
  const box=document.getElementById('msgs');
  box.innerHTML=data.map(m=>{
    const role = m.senderId?.role || (m.senderModel === 'Admin' ? 'admin' : 'user');
    const isAdminSender = role === 'admin';
    const sender = isAdminSender
      ? 'مدیر سایت'
      : (m.senderId?.firstname?`${m.senderId.firstname} ${m.senderId.lastname}`.trim():m.senderId?.phone||'مشتری');
    return `<div class="${isAdminSender?'text-right':'text-left'}"><div class="inline-block px-2 py-1 rounded ${isAdminSender?'bg-blue-100':'bg-gray-200'}">${sender}: ${m.message}</div><div class="text-xs text-gray-400">${new Date(m.timestamp).toLocaleString('fa-IR')}</div></div>`;
  }).join('');
  box.scrollTop=box.scrollHeight;
}
async function send(){
  const msg=document.getElementById('msgInput').value.trim();
  if(!msg||!currentUser) return;
  await fetch('/api/messages/send',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,userId:currentUser})});
  document.getElementById('msgInput').value='';
  fetchMsgs();
}
document.getElementById('userSelect').addEventListener('change',e=>{currentUser=e.target.value;fetchMsgs();});
document.getElementById('sendBtn').addEventListener('click',send);
loadUsers();
setInterval(fetchMsgs,5000);
</script>

<!-- TODO: افزودن رویدادهای PostHog پس از فعال‌سازی | TODO: Enable PostHog events after activation -->
<!--
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const safeCapture = window.safePosthogCapture || function () {};
    // safeCapture('event_name', { /* داده‌های تکمیلی */ });
  });
</script>
-->

</body>
</html>
