<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>پیام‌های کاربران</title>

  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; img-src 'self' data: https: blob:; connect-src 'self' http://localhost:5000 https://api.vitrinet.ir; frame-ancestors 'none'; base-uri 'self'; form-action 'self';">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="no-referrer">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), payment=()">

  <!-- DOMPurify for HTML Sanitization -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Security Utils -->
  <script src="/security-utils.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/nav-active.js" defer></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-xl mx-auto bg-white rounded shadow p-4">
    <h2 class="text-lg font-bold mb-4">پیام کاربر</h2>
    <select id="userSelect" class="border rounded p-2 mb-2"></select>
    <div id="msgs" class="h-96 overflow-y-auto border rounded p-2 mb-2"></div>
    <div class="flex gap-2">
      <input id="msgInput" class="flex-1 border rounded p-2" placeholder="پیام">
      <button id="sendBtn" class="bg-blue-600 text-white px-4 rounded">ارسال</button>
    </div>
  </div>
<script>
let currentUser=null;
async function loadUsers(){
  const res=await fetch('/api/messages',{credentials:'include'});
  const users=await res.json();
  const sel=document.getElementById('userSelect');
  sel.innerHTML=users.map(u=>{
    const name=((u.firstname||'')+' '+(u.lastname||'')).trim()||u.phone||u._id;
    return `<option value="${u._id}">${name}</option>`;
  }).join('');
  currentUser=users[0]?._id||null;
  fetchMsgs();
}
async function fetchMsgs(){
  if(!currentUser) return;
  const res=await fetch(`/api/messages/${currentUser}`,{credentials:'include'});
  const data=await res.json();
  const box=document.getElementById('msgs');
  box.innerHTML=data.map(m=>{
    const role = m.senderId?.role || (m.senderModel === 'Admin' ? 'admin' : 'user');
    const isAdminSender = role === 'admin';
    const sender = isAdminSender
      ? 'مدیر سایت'
      : (m.senderId?.firstname?`${m.senderId.firstname} ${m.senderId.lastname}`.trim():m.senderId?.phone||'مشتری');
    return `<div class="${isAdminSender?'text-right':'text-left'}"><div class="inline-block px-2 py-1 rounded ${isAdminSender?'bg-blue-100':'bg-gray-200'}">${sender}: ${m.message}</div><div class="text-xs text-gray-400">${new Date(m.timestamp).toLocaleString('fa-IR')}</div></div>`;
  }).join('');
  box.scrollTop=box.scrollHeight;
}
async function send(){
  const msg=document.getElementById('msgInput').value.trim();
  if(!msg||!currentUser) return;
  await fetch('/api/messages/send',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,userId:currentUser})});
  document.getElementById('msgInput').value='';
  fetchMsgs();
}
document.getElementById('userSelect').addEventListener('change',e=>{currentUser=e.target.value;fetchMsgs();});
document.getElementById('sendBtn').addEventListener('click',send);
loadUsers();
setInterval(fetchMsgs,5000);
</script>
</body>
</html>
