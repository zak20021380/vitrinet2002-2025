<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مدیریت کارت‌های صفحه اصلی | ویترینت</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #10b981;
      --secondary: #0ea5e9;
      --warning: #f59e0b;
      --bg: #f5faf8;
      --card: #fff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 12px 40px rgba(16, 185, 129, 0.12);
      --radius: 18px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body {
      font-family: "Vazirmatn", Tahoma, sans-serif;
      margin: 0;
      min-height: 100%;
      background: var(--bg);
      color: var(--text);
    }

    body {
      min-height: 100vh;
      overflow-x: hidden;
    }

    .content {
      width: min(100%, 1240px);
      margin-inline: auto;
      padding: 2.2rem clamp(1.2rem, 3vw, 2.8rem) 4rem;
      display: flex;
      flex-direction: column;
      gap: 1.8rem;
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .page-header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .page-header-actions {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .page-title {
      font-size: clamp(1.4rem, 2vw, 1.9rem);
      font-weight: 800;
      color: var(--text);
    }

    .page-subtitle {
      color: var(--muted);
      font-size: 0.95rem;
    }

    .primary-btn {
      background: linear-gradient(120deg, var(--primary), var(--secondary));
      color: #fff;
      border: none;
      border-radius: 14px;
      padding: 0.75rem 1.6rem;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.25);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 32px rgba(14, 165, 233, 0.28);
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(300px, 340px) minmax(0, 1fr);
      gap: clamp(1.2rem, 2vw, 2.4rem);
      align-items: start;
    }

    .panel {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(1.4rem, 2vw, 2rem);
      border: 1px solid rgba(14, 165, 233, 0.08);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      margin-bottom: 1.2rem;
    }

    .panel-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
    }

    .section-list {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    .section-item {
      border: 1px solid rgba(16, 185, 129, 0.12);
      border-radius: var(--radius);
      padding: 1rem 1.1rem;
      background: rgba(255, 255, 255, 0.88);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      transition: all 0.18s ease;
      position: relative;
    }

    .section-item.active {
      border-color: rgba(14, 165, 233, 0.45);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.12);
      background: #fff;
    }

    .section-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 32px rgba(14, 165, 233, 0.12);
    }

    .section-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .badge {
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--primary);
      background: rgba(16, 185, 129, 0.12);
    }

    .muted {
      color: var(--muted);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.1rem 1.4rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    label {
      font-weight: 600;
      font-size: 0.92rem;
      color: var(--text);
    }

    input[type="text"],
    input[type="number"],
    textarea,
    input[type="url"] {
      width: 100%;
      padding: 0.75rem 0.85rem;
      border-radius: 12px;
      border: 1px solid rgba(15, 118, 110, 0.2);
      background: rgba(255, 255, 255, 0.9);
      color: var(--text);
      font-size: 0.95rem;
      transition: border-color 0.18s ease, box-shadow 0.18s ease;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: rgba(14, 165, 233, 0.65);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
    }

    .checkbox-field {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      font-weight: 600;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .form-actions {
      display: flex;
      gap: 0.8rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .secondary-btn,
    .danger-btn {
      padding: 0.7rem 1.4rem;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .secondary-btn {
      background: rgba(14, 165, 233, 0.12);
      color: var(--secondary);
      box-shadow: 0 8px 20px rgba(14, 165, 233, 0.12);
    }

    .secondary-btn:hover,
    .danger-btn:hover {
      transform: translateY(-1px);
    }

    .danger-btn {
      background: rgba(239, 68, 68, 0.15);
      color: #dc2626;
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.15);
    }

    .cards-panel {
      margin-top: 1.8rem;
      border-top: 1px dashed rgba(14, 165, 233, 0.25);
      padding-top: 1.6rem;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }

    .cards-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .cards-list {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .card-item {
      border: 1px solid rgba(14, 165, 233, 0.18);
      border-radius: var(--radius);
      padding: 1rem;
      background: rgba(255, 255, 255, 0.95);
      display: grid;
      gap: 0.6rem;
    }

    .card-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
    }

    .card-item-title {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .card-item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .card-actions {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .ghost-btn {
      border: 1px solid rgba(14, 165, 233, 0.25);
      background: transparent;
      color: var(--secondary);
      padding: 0.5rem 1.1rem;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .ghost-btn.danger {
      color: #dc2626;
      border-color: rgba(239, 68, 68, 0.25);
    }

    .empty-state {
      text-align: center;
      padding: 1.6rem;
      color: var(--muted);
      border: 1px dashed rgba(14, 165, 233, 0.25);
      border-radius: var(--radius);
      background: rgba(236, 253, 245, 0.55);
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #fff;
      border-radius: 14px;
      padding: 0.85rem 1.2rem;
      box-shadow: 0 20px 45px rgba(14, 165, 233, 0.18);
      display: flex;
      align-items: center;
      gap: 0.7rem;
      font-weight: 600;
      border-inline-start: 4px solid var(--primary);
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 40;
    }

    .toast.show {
      opacity: 1;
      pointer-events: all;
      transform: translateY(0);
    }

    .toast.error {
      border-color: #ef4444;
      color: #b91c1c;
    }

    .toast.success {
      border-color: var(--primary);
      color: var(--primary);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 50;
    }

    .modal-backdrop.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal {
      width: min(640px, 100%);
      background: #fff;
      border-radius: 20px;
      padding: 1.8rem;
      box-shadow: 0 30px 60px rgba(15, 118, 110, 0.18);
      border: 1px solid rgba(14, 165, 233, 0.18);
      display: grid;
      gap: 1.2rem;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--text);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    @media (max-width: 1280px) {
      .layout-grid {
        grid-template-columns: minmax(280px, 320px) minmax(0, 1fr);
      }
    }

    @media (max-width: 960px) {
      .layout-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 720px) {
      .page-header-top {
        flex-direction: column;
        align-items: flex-start;
      }

      .page-header {
        gap: 0.5rem;
      }

      .content {
        padding: 1.5rem 1rem 4rem;
      }

      .modal {
        padding: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <main class="content">
      <header class="page-header">
        <div class="page-header-top">
          <div>
            <h1 class="page-title">مدیریت کارت‌های صفحه اصلی</h1>
            <p class="page-subtitle">ردیف کارت‌ها، عنوان سکشن و محتوای آن‌ها را از این بخش ویرایش کنید.</p>
          </div>
          <div class="page-header-actions">
            <a class="ghost-btn" href="dashboard.html">
              <i class="ri-arrow-go-back-line"></i>
              بازگشت به داشبورد
            </a>
            <button class="primary-btn" id="newSectionBtn">
              <i class="ri-add-circle-line"></i>
              سکشن جدید
            </button>
          </div>
        </div>
      </header>

      <div class="layout-grid">
        <section class="panel">
          <div class="panel-header">
            <h2 class="panel-title">لیست سکشن‌ها</h2>
            <span class="badge" id="sectionCount">0 سکشن</span>
          </div>
          <div class="section-list" id="sectionsContainer">
            <div class="empty-state">تا کنون سکشنی ثبت نشده است. با دکمه «سکشن جدید» شروع کنید.</div>
          </div>
        </section>

        <section class="panel" id="sectionEditor">
          <div class="panel-header">
            <div>
              <h2 class="panel-title" id="editorTitle">افزودن سکشن جدید</h2>
              <p class="page-subtitle" id="editorSubtitle">مشخصات سکشن و محتوای کارت‌ها را در این قسمت ثبت کنید.</p>
            </div>
            <div class="badge" id="cardsCountBadge">۰ کارت</div>
          </div>

          <form id="sectionForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="sectionTitle">عنوان سکشن *</label>
                <input type="text" id="sectionTitle" name="title" placeholder="مثلاً محصولات ویژه" required />
              </div>
              <div class="form-group">
                <label for="sectionSlug">اسلاگ (انگلیسی) *</label>
                <input type="text" id="sectionSlug" name="slug" placeholder="popular-products" required />
              </div>
              <div class="form-group">
                <label for="sectionViewAllText">متن دکمه مشاهده همه</label>
                <input type="text" id="sectionViewAllText" name="viewAllText" placeholder="مشاهده همه" />
              </div>
              <div class="form-group">
                <label for="sectionViewAllLink">لینک دکمه مشاهده همه</label>
                <input type="url" id="sectionViewAllLink" name="viewAllLink" placeholder="https://example.com" />
              </div>
              <div class="form-group">
                <label for="sectionSubtitleInput">زیرعنوان</label>
                <input type="text" id="sectionSubtitleInput" name="subtitle" placeholder="توضیح کوتاه برای کاربران" />
              </div>
              <div class="form-group">
                <label for="sectionOrder">ترتیب نمایش</label>
                <input type="number" id="sectionOrder" name="order" min="0" step="1" value="0" />
              </div>
            </div>
            <div class="form-group">
              <label for="sectionDescription">توضیحات سکشن</label>
              <textarea id="sectionDescription" name="description" placeholder="توضیح کامل‌تر برای سکشن"></textarea>
            </div>
            <div class="checkbox-field">
              <input type="checkbox" id="sectionIsActive" name="isActive" checked />
              <label for="sectionIsActive">این سکشن فعال باشد</label>
            </div>

            <div class="form-actions">
              <button type="submit" class="primary-btn" id="saveSectionBtn">
                <i class="ri-save-3-line"></i>
                ذخیره تغییرات
              </button>
              <button type="button" class="secondary-btn" id="resetFormBtn">
                <i class="ri-refresh-line"></i>
                انصراف
              </button>
              <button type="button" class="danger-btn" id="deleteSectionBtn" hidden>
                <i class="ri-delete-bin-6-line"></i>
                حذف سکشن
              </button>
            </div>
          </form>

          <div class="cards-panel" id="cardsPanel">
            <div class="cards-header">
              <div>
                <h3 class="panel-title" id="cardsPanelTitle">کارت‌های سکشن</h3>
                <p class="page-subtitle">برای افزودن کارت جدید، روی دکمه زیر کلیک کنید.</p>
              </div>
              <button class="secondary-btn" id="addCardBtn">
                <i class="ri-add-line"></i>
                افزودن کارت
              </button>
            </div>
            <div class="cards-list" id="cardsContainer">
              <div class="empty-state">ابتدا یک سکشن را انتخاب یا ایجاد کنید تا کارت‌ها نمایش داده شوند.</div>
            </div>
          </div>
        </section>
      </div>
    </main>

  <div class="toast" id="toast"></div>

  <div class="modal-backdrop" id="cardModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="cardModalTitle">کارت جدید</h3>
      </div>
      <form id="cardForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="cardTitle">عنوان کارت *</label>
            <input type="text" id="cardTitle" name="title" required />
          </div>
          <div class="form-group">
            <label for="cardTag">تگ / برچسب</label>
            <input type="text" id="cardTag" name="tag" />
          </div>
          <div class="form-group">
            <label for="cardLocation">مکان / توضیح کوتاه</label>
            <input type="text" id="cardLocation" name="location" />
          </div>
          <div class="form-group">
            <label for="cardPrice">قیمت / مقدار</label>
            <input type="text" id="cardPrice" name="price" />
          </div>
          <div class="form-group">
            <label for="cardOrder">ترتیب نمایش</label>
            <input type="number" id="cardOrder" name="order" value="0" />
          </div>
          <div class="form-group">
            <label for="cardButtonText">متن دکمه</label>
            <input type="text" id="cardButtonText" name="buttonText" placeholder="مثلاً مشاهده محصول" />
          </div>
        </div>
        <div class="form-group">
          <label for="cardImageUrl">آدرس تصویر</label>
          <input type="url" id="cardImageUrl" name="imageUrl" placeholder="https://" />
        </div>
        <div class="form-group">
          <label for="cardLink">لینک مقصد کارت</label>
          <input type="url" id="cardLink" name="link" placeholder="https://" />
        </div>
        <div class="form-group">
          <label for="cardDescription">توضیحات کارت</label>
          <textarea id="cardDescription" name="description" placeholder="توضیح تکمیلی کارت"></textarea>
        </div>
        <div class="checkbox-field">
          <input type="checkbox" id="cardIsActive" name="isActive" checked />
          <label for="cardIsActive">کارت فعال باشد</label>
        </div>
        <div class="modal-actions">
          <button type="submit" class="primary-btn">
            <i class="ri-check-double-line"></i>
            ذخیره کارت
          </button>
          <button type="button" class="secondary-btn" id="cancelCardBtn">
            <i class="ri-close-line"></i>
            انصراف
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (() => {
      const CLEANUP_KEY = '__homeSectionCleanup';
      if (typeof window !== 'undefined' && typeof window[CLEANUP_KEY] === 'function') {
        window[CLEANUP_KEY]();
      }

      const API_BASE = '/api/home-card-sections';
      const toastEl = document.getElementById('toast');
      const sectionsContainer = document.getElementById('sectionsContainer');
      const sectionCountEl = document.getElementById('sectionCount');
      const cardsContainer = document.getElementById('cardsContainer');
      const cardsCountBadge = document.getElementById('cardsCountBadge');
      const cardModalBackdrop = document.getElementById('cardModalBackdrop');
      const cardModalTitle = document.getElementById('cardModalTitle');
      const cardsPanelTitle = document.getElementById('cardsPanelTitle');

      const sectionForm = document.getElementById('sectionForm');
      const sectionEditor = document.getElementById('sectionEditor');
      const editorTitle = document.getElementById('editorTitle');
      const editorSubtitle = document.getElementById('editorSubtitle');
      const deleteSectionBtn = document.getElementById('deleteSectionBtn');
      const resetFormBtn = document.getElementById('resetFormBtn');
      const newSectionBtn = document.getElementById('newSectionBtn');
      const addCardBtn = document.getElementById('addCardBtn');
      const cardForm = document.getElementById('cardForm');
      const cancelCardBtn = document.getElementById('cancelCardBtn');

      let sections = [];
      let selectedSectionId = null;
      let editingCardId = null;
      let toastTimeout = null;

      const sectionFields = {
        title: document.getElementById('sectionTitle'),
        slug: document.getElementById('sectionSlug'),
        viewAllText: document.getElementById('sectionViewAllText'),
        viewAllLink: document.getElementById('sectionViewAllLink'),
        subtitle: document.getElementById('sectionSubtitleInput'),
        order: document.getElementById('sectionOrder'),
        description: document.getElementById('sectionDescription'),
        isActive: document.getElementById('sectionIsActive'),
      };

      const cardFields = {
        title: document.getElementById('cardTitle'),
        tag: document.getElementById('cardTag'),
        location: document.getElementById('cardLocation'),
        price: document.getElementById('cardPrice'),
        order: document.getElementById('cardOrder'),
        buttonText: document.getElementById('cardButtonText'),
        imageUrl: document.getElementById('cardImageUrl'),
        link: document.getElementById('cardLink'),
        description: document.getElementById('cardDescription'),
        isActive: document.getElementById('cardIsActive'),
      };

      function showToast(message, type = 'success') {
        clearTimeout(toastTimeout);
        toastEl.textContent = message;
        toastEl.className = `toast ${type}`;
        requestAnimationFrame(() => toastEl.classList.add('show'));
        toastTimeout = setTimeout(() => {
          toastEl.classList.remove('show');
        }, 3200);
      }

      function formatCount(count) {
        return new Intl.NumberFormat('fa-IR').format(count);
      }

      function sortSections() {
        sections.sort((a, b) => (Number(a.order) || 0) - (Number(b.order) || 0));
      }

      function updateSectionCount() {
        sectionCountEl.textContent = `${formatCount(sections.length)} سکشن`;
      }

      function renderSectionsList() {
        updateSectionCount();
        sectionsContainer.innerHTML = '';

        if (!sections.length) {
          sectionsContainer.innerHTML = '<div class="empty-state">تا کنون سکشنی ثبت نشده است. با دکمه «سکشن جدید» شروع کنید.</div>';
          return;
        }

        sections.forEach((section) => {
          const item = document.createElement('div');
          item.className = 'section-item' + (section._id === selectedSectionId ? ' active' : '');
          item.innerHTML = `
            <div class="section-item-title">${section.title || 'بدون عنوان'}</div>
            <div class="section-meta">
              <span class="badge">${section.slug || 'بدون اسلاگ'}</span>
              <span>${section.isActive ? 'فعال' : 'غیرفعال'}</span>
            </div>
            <div class="section-meta">
              <span><i class="ri-stack-line"></i> ${formatCount(section.cards?.length || 0)} کارت</span>
              <span><i class="ri-hashtag"></i> ترتیب ${Number(section.order) || 0}</span>
            </div>
          `;
          item.addEventListener('click', () => selectSection(section._id));
          sectionsContainer.appendChild(item);
        });
      }

      function resetSectionForm() {
        sectionForm.reset();
        sectionFields.order.value = 0;
        sectionFields.isActive.checked = true;
        deleteSectionBtn.hidden = true;
        selectedSectionId = null;
        editorTitle.textContent = 'افزودن سکشن جدید';
        editorSubtitle.textContent = 'مشخصات سکشن و محتوای کارت‌ها را در این قسمت ثبت کنید.';
        cardsContainer.innerHTML = '<div class="empty-state">ابتدا یک سکشن را انتخاب یا ایجاد کنید تا کارت‌ها نمایش داده شوند.</div>';
        cardsCountBadge.textContent = '۰ کارت';
        cardsPanelTitle.textContent = 'کارت‌های سکشن';
      }

      function fillSectionForm(section) {
        sectionFields.title.value = section.title || '';
        sectionFields.slug.value = section.slug || '';
        sectionFields.viewAllText.value = section.viewAllText || '';
        sectionFields.viewAllLink.value = section.viewAllLink || '';
        sectionFields.subtitle.value = section.subtitle || '';
        sectionFields.order.value = Number(section.order) || 0;
        sectionFields.description.value = section.description || '';
        sectionFields.isActive.checked = section.isActive !== false;
      }

      function renderCards(section) {
        const cards = Array.isArray(section.cards) ? [...section.cards] : [];
        cards.sort((a, b) => (Number(a.order) || 0) - (Number(b.order) || 0));

        cardsCountBadge.textContent = `${formatCount(cards.length)} کارت`;
        cardsPanelTitle.textContent = `کارت‌های سکشن: ${section.title || ''}`;

        if (!cards.length) {
          cardsContainer.innerHTML = '<div class="empty-state">برای این سکشن هنوز کارتی ثبت نشده است.</div>';
          return;
        }

        cardsContainer.innerHTML = '';
        cards.forEach((card) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'card-item';
          wrapper.innerHTML = `
            <div class="card-item-header">
              <div class="card-item-title">${card.title || 'بدون عنوان'}</div>
              <span class="badge">${card.isActive !== false ? 'فعال' : 'غیرفعال'}</span>
            </div>
            <div class="card-item-meta">
              ${card.tag ? `<span><i class="ri-price-tag-3-line"></i> ${card.tag}</span>` : ''}
              ${card.location ? `<span><i class="ri-map-pin-line"></i> ${card.location}</span>` : ''}
              ${card.price ? `<span><i class="ri-money-cny-box-line"></i> ${card.price}</span>` : ''}
              <span><i class="ri-hashtag"></i> ترتیب ${Number(card.order) || 0}</span>
            </div>
            ${card.description ? `<div class="muted">${card.description}</div>` : ''}
            <div class="card-actions">
              <button class="ghost-btn" data-action="edit" data-id="${card._id}"><i class="ri-edit-line"></i> ویرایش</button>
              <button class="ghost-btn danger" data-action="delete" data-id="${card._id}"><i class="ri-delete-bin-line"></i> حذف</button>
              ${card.link ? `<a class="ghost-btn" href="${card.link}" target="_blank" rel="noopener"><i class="ri-external-link-line"></i> مشاهده لینک</a>` : ''}
            </div>
          `;
          wrapper.querySelector('[data-action="edit"]').addEventListener('click', (event) => {
            event.stopPropagation();
            openCardModal(card);
          });
          wrapper.querySelector('[data-action="delete"]').addEventListener('click', (event) => {
            event.stopPropagation();
            deleteCard(card._id);
          });
          cardsContainer.appendChild(wrapper);
        });
      }

      async function fetchSections() {
        try {
          const res = await fetch(`${API_BASE}/admin/all`, { credentials: 'include' });
          if (!res.ok) throw new Error('خطا در دریافت سکشن‌ها');
          sections = await res.json();
          sortSections();
          renderSectionsList();
          if (sections.length) {
            selectSection(sections[0]._id);
          }
        } catch (err) {
          console.error(err);
          showToast('خطا در دریافت اطلاعات از سرور', 'error');
        }
      }

      function selectSection(sectionId) {
        const target = sections.find((item) => item._id === sectionId);
        if (!target) return;
        selectedSectionId = sectionId;
        renderSectionsList();
        fillSectionForm(target);
        renderCards(target);
        deleteSectionBtn.hidden = false;
        editorTitle.textContent = `ویرایش سکشن: ${target.title || ''}`;
        editorSubtitle.textContent = 'تغییرات خود را ذخیره کنید تا در صفحه اصلی اعمال شود.';
      }

      sectionForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = {
          title: sectionFields.title.value.trim(),
          slug: sectionFields.slug.value.trim(),
          viewAllText: sectionFields.viewAllText.value.trim(),
          viewAllLink: sectionFields.viewAllLink.value.trim(),
          subtitle: sectionFields.subtitle.value.trim(),
          description: sectionFields.description.value.trim(),
          order: Number(sectionFields.order.value) || 0,
          isActive: sectionFields.isActive.checked,
        };

        if (!payload.title || !payload.slug) {
          showToast('عنوان و اسلاگ سکشن الزامی است.', 'error');
          return;
        }

        const method = selectedSectionId ? 'PUT' : 'POST';
        const url = selectedSectionId ? `${API_BASE}/${selectedSectionId}` : API_BASE;

        try {
          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.message || 'خطا در ذخیره سکشن');

          const index = sections.findIndex((item) => item._id === data._id);
          if (index > -1) {
            sections[index] = data;
          } else {
            sections.push(data);
          }
          sortSections();
          renderSectionsList();
          selectSection(data._id);
          showToast('سکشن با موفقیت ذخیره شد.');
        } catch (err) {
          console.error(err);
          showToast(err.message || 'خطایی رخ داد.', 'error');
        }
      });

      deleteSectionBtn.addEventListener('click', async () => {
        if (!selectedSectionId) return;
        if (!confirm('آیا از حذف این سکشن مطمئن هستید؟')) return;
        try {
          const res = await fetch(`${API_BASE}/${selectedSectionId}`, {
            method: 'DELETE',
            credentials: 'include',
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.message || 'خطا در حذف سکشن');
          sections = sections.filter((item) => item._id !== selectedSectionId);
          resetSectionForm();
          renderSectionsList();
          showToast('سکشن با موفقیت حذف شد.');
        } catch (err) {
          console.error(err);
          showToast(err.message || 'خطایی رخ داد.', 'error');
        }
      });

      resetFormBtn.addEventListener('click', () => {
        resetSectionForm();
        renderSectionsList();
      });

      newSectionBtn.addEventListener('click', () => {
        resetSectionForm();
        sectionFields.slug.focus();
      });

      addCardBtn.addEventListener('click', () => {
        if (!selectedSectionId) {
          showToast('ابتدا یک سکشن را انتخاب کنید.', 'error');
          return;
        }
        openCardModal();
      });

      function openCardModal(card = null) {
        editingCardId = card?._id || null;
        cardModalTitle.textContent = editingCardId ? 'ویرایش کارت' : 'کارت جدید';
        cardForm.reset();
        cardFields.order.value = 0;
        cardFields.isActive.checked = true;

        if (card) {
          cardFields.title.value = card.title || '';
          cardFields.tag.value = card.tag || '';
          cardFields.location.value = card.location || '';
          cardFields.price.value = card.price || '';
          cardFields.order.value = Number(card.order) || 0;
          cardFields.buttonText.value = card.buttonText || '';
          cardFields.imageUrl.value = card.imageUrl || '';
          cardFields.link.value = card.link || '';
          cardFields.description.value = card.description || '';
          cardFields.isActive.checked = card.isActive !== false;
        }

        cardModalBackdrop.classList.add('active');
      }

      function closeCardModal() {
        cardModalBackdrop.classList.remove('active');
        editingCardId = null;
      }

      cancelCardBtn.addEventListener('click', () => {
        closeCardModal();
      });

      cardModalBackdrop.addEventListener('click', (event) => {
        if (event.target === cardModalBackdrop) {
          closeCardModal();
        }
      });

      cardForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!selectedSectionId) {
          showToast('ابتدا یک سکشن را انتخاب کنید.', 'error');
          return;
        }

        const payload = {
          title: cardFields.title.value.trim(),
          tag: cardFields.tag.value.trim(),
          location: cardFields.location.value.trim(),
          price: cardFields.price.value.trim(),
          order: Number(cardFields.order.value) || 0,
          buttonText: cardFields.buttonText.value.trim(),
          imageUrl: cardFields.imageUrl.value.trim(),
          link: cardFields.link.value.trim(),
          description: cardFields.description.value.trim(),
          isActive: cardFields.isActive.checked,
        };

        if (!payload.title) {
          showToast('عنوان کارت الزامی است.', 'error');
          return;
        }

        const method = editingCardId ? 'PUT' : 'POST';
        const url = editingCardId
          ? `${API_BASE}/${selectedSectionId}/cards/${editingCardId}`
          : `${API_BASE}/${selectedSectionId}/cards`;

        try {
          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.message || 'خطا در ذخیره کارت');

          const index = sections.findIndex((item) => item._id === data._id);
          if (index > -1) {
            sections[index] = data;
          }
          sortSections();
          renderSectionsList();
          selectSection(data._id);
          closeCardModal();
          showToast('کارت با موفقیت ذخیره شد.');
        } catch (err) {
          console.error(err);
          showToast(err.message || 'خطایی رخ داد.', 'error');
        }
      });

      async function deleteCard(cardId) {
        if (!selectedSectionId || !cardId) return;
        if (!confirm('حذف کارت انتخاب شده؟')) return;
        try {
          const res = await fetch(`${API_BASE}/${selectedSectionId}/cards/${cardId}`, {
            method: 'DELETE',
            credentials: 'include',
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.message || 'خطا در حذف کارت');
          const index = sections.findIndex((item) => item._id === data._id);
          if (index > -1) {
            sections[index] = data;
          }
          renderSectionsList();
          selectSection(data._id);
          showToast('کارت حذف شد.');
        } catch (err) {
          console.error(err);
          showToast(err.message || 'خطایی رخ داد.', 'error');
        }
      }

      const handleKeydown = (event) => {
        if (event.key === 'Escape' && cardModalBackdrop.classList.contains('active')) {
          closeCardModal();
        }
      };

      document.addEventListener('keydown', handleKeydown);

      window[CLEANUP_KEY] = () => {
        document.removeEventListener('keydown', handleKeydown);
        delete window[CLEANUP_KEY];
      };

      fetchSections();
    })();
  </script>
</body>
</html>
