<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta http-equiv="Strict-Transport-Security" content="max-age=63072000; includeSubDomains; preload">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="Referrer-Policy" content="no-referrer">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta name="referrer" content="no-referrer">
<meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

  <meta charset="UTF-8" />
  <title>مدیریت کارت‌های صفحه اصلی | ویترینت</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #10b981;
      --secondary: #0ea5e9;
      --warning: #f59e0b;
      --bg: #f5faf8;
      --card: #fff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 12px 40px rgba(16, 185, 129, 0.12);
      --radius: 18px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body {
      font-family: "Vazirmatn", Tahoma, sans-serif;
      margin: 0;
      min-height: 100%;
      background: var(--bg);
      color: var(--text);
    }

    body {
      min-height: 100vh;
      overflow-x: hidden;
    }

    .content {
      width: min(100%, 1240px);
      margin-inline: auto;
      padding: 2.2rem clamp(1.2rem, 3vw, 2.8rem) 4rem;
      display: flex;
      flex-direction: column;
      gap: 1.8rem;
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .page-header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .page-header-actions {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .page-title {
      font-size: clamp(1.4rem, 2vw, 1.9rem);
      font-weight: 800;
      color: var(--text);
    }

    .page-subtitle {
      color: var(--muted);
      font-size: 0.95rem;
    }

    .primary-btn {
      background: linear-gradient(120deg, var(--primary), var(--secondary));
      color: #fff;
      border: none;
      border-radius: 14px;
      padding: 0.75rem 1.6rem;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.25);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 32px rgba(14, 165, 233, 0.28);
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(300px, 340px) minmax(0, 1fr);
      gap: clamp(1.2rem, 2vw, 2.4rem);
      align-items: start;
    }

    .panel {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(1.4rem, 2vw, 2rem);
      border: 1px solid rgba(14, 165, 233, 0.08);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      margin-bottom: 1.2rem;
    }

    .panel-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
    }

    .section-list {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    .section-item {
      border: 1px solid rgba(16, 185, 129, 0.12);
      border-radius: var(--radius);
      padding: 1rem 1.1rem;
      background: rgba(255, 255, 255, 0.88);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      transition: all 0.18s ease;
      position: relative;
    }

    .section-item.active {
      border-color: rgba(14, 165, 233, 0.45);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.12);
      background: #fff;
    }

    .section-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 32px rgba(14, 165, 233, 0.12);
    }

    .section-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .badge {
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--primary);
      background: rgba(16, 185, 129, 0.12);
    }

    .muted {
      color: var(--muted);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.1rem 1.4rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    label {
      font-weight: 600;
      font-size: 0.92rem;
      color: var(--text);
    }

    input[type="text"],
    input[type="number"],
    textarea,
    input[type="url"],
    select {
      width: 100%;
      padding: 0.75rem 0.85rem;
      border-radius: 12px;
      border: 1px solid rgba(15, 118, 110, 0.2);
      background: rgba(255, 255, 255, 0.9);
      color: var(--text);
      font-size: 0.95rem;
      transition: border-color 0.18s ease, box-shadow 0.18s ease;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: rgba(14, 165, 233, 0.65);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
    }

    .checkbox-field {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      font-weight: 600;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .form-actions {
      display: flex;
      gap: 0.8rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .secondary-btn,
    .danger-btn {
      padding: 0.7rem 1.4rem;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .secondary-btn {
      background: rgba(14, 165, 233, 0.12);
      color: var(--secondary);
      box-shadow: 0 8px 20px rgba(14, 165, 233, 0.12);
    }

    .secondary-btn:hover,
    .danger-btn:hover {
      transform: translateY(-1px);
    }

    .danger-btn {
      background: rgba(239, 68, 68, 0.15);
      color: #dc2626;
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.15);
    }

    .cards-panel {
      margin-top: 1.8rem;
      border-top: 1px dashed rgba(14, 165, 233, 0.25);
      padding-top: 1.6rem;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }

    .cards-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .cards-list {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .card-item {
      border: 1px solid rgba(14, 165, 233, 0.18);
      border-radius: var(--radius);
      padding: 1rem;
      background: rgba(255, 255, 255, 0.95);
      display: grid;
      gap: 0.6rem;
    }

    .card-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
    }

    .card-item-title {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .card-item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .card-actions {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .ghost-btn {
      border: 1px solid rgba(14, 165, 233, 0.25);
      background: transparent;
      color: var(--secondary);
      padding: 0.5rem 1.1rem;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .ghost-btn.danger {
      color: #dc2626;
      border-color: rgba(239, 68, 68, 0.25);
    }

    .empty-state {
      text-align: center;
      padding: 1.6rem;
      color: var(--muted);
      border: 1px dashed rgba(14, 165, 233, 0.25);
      border-radius: var(--radius);
      background: rgba(236, 253, 245, 0.55);
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #fff;
      border-radius: 14px;
      padding: 0.85rem 1.2rem;
      box-shadow: 0 20px 45px rgba(14, 165, 233, 0.18);
      display: flex;
      align-items: center;
      gap: 0.7rem;
      font-weight: 600;
      border-inline-start: 4px solid var(--primary);
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 40;
    }

    .toast.show {
      opacity: 1;
      pointer-events: all;
      transform: translateY(0);
    }

    .toast.error {
      border-color: #ef4444;
      color: #b91c1c;
    }

    .toast.success {
      border-color: var(--primary);
      color: var(--primary);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 50;
    }

    .modal-backdrop.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal {
      width: min(640px, 100%);
      background: #fff;
      border-radius: 20px;
      padding: 1.8rem;
      box-shadow: 0 30px 60px rgba(15, 118, 110, 0.18);
      border: 1px solid rgba(14, 165, 233, 0.18);
      display: grid;
      gap: 1.2rem;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--text);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    @media (max-width: 1280px) {
      .layout-grid {
        grid-template-columns: minmax(280px, 320px) minmax(0, 1fr);
      }
    }

    @media (max-width: 960px) {
      .layout-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 720px) {
      .page-header-top {
        flex-direction: column;
        align-items: flex-start;
      }

      .page-header {
        gap: 0.5rem;
      }

      .content {
        padding: 1.5rem 1rem 4rem;
      }

      .modal {
        padding: 1.4rem;
      }
    }
  </style>
  <script src="/nav-active.js" defer></script>

<!-- TODO: فعال‌سازی پست‌هاگ را هنگام انتشار فراموش نکنید | TODO: Enable PostHog analytics when going live -->
<!--
<script>
  (function () {
    var config = window.POSTHOG_CONFIG || { enabled: false, apiKey: 'phc_YOUR_KEY_HERE', apiHost: 'https://analytics.vitreenet.ir' };
    if (!config.enabled) {
      return; // فعال نیست | Not enabled yet
    }
    try {
      (function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")),p.type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js";(r=t.getElementsByTagName("script")[0]),r.parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:u=e,u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==u._i&&(e+="."+u._i),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"};n="capture identify alias people.set people.set_once people.unset people.increment people.append people.union people.remove people.clear_opt_out_outcome register register_once unregister opt_out_capturing opt_in_capturing has_opted_out_capturing reset isFeatureEnabled onFeatureFlags reloadFeatureFlags group".split(" ");for(o=0;o<n.length;o++)g(u,n[o]);e._i.push([i,s,a])},e.__SV=1.1)})(document, window.posthog || []);
      window.posthog.init(config.apiKey, { api_host: config.apiHost, capture_pageview: true, advanced_disable_decide: true });
    } catch (error) {
      console.warn('PostHog init failed (preview mode):', error);
    }
  })();
</script>
-->

</head>
<body>
  <main class="content">
      <header class="page-header">
        <div class="page-header-top">
          <div>
            <h1 class="page-title">مدیریت کارت‌های صفحه اصلی</h1>
            <p class="page-subtitle">ردیف کارت‌ها، عنوان سکشن و محتوای آن‌ها را از این بخش ویرایش کنید.</p>
          </div>
          <div class="page-header-actions">
            <a class="ghost-btn" href="dashboard.html">
              <i class="ri-arrow-go-back-line"></i>
              بازگشت به داشبورد
            </a>
            <button class="primary-btn" id="newSectionBtn">
              <i class="ri-add-circle-line"></i>
              سکشن جدید
            </button>
          </div>
        </div>
      </header>

      <div class="layout-grid">
        <section class="panel">
          <div class="panel-header">
            <h2 class="panel-title">لیست سکشن‌ها</h2>
            <span class="badge" id="sectionCount">0 سکشن</span>
          </div>
          <div class="section-list" id="sectionsContainer">
            <div class="empty-state">تا کنون سکشنی ثبت نشده است. با دکمه «سکشن جدید» شروع کنید.</div>
          </div>
        </section>

        <section class="panel" id="sectionEditor">
          <div class="panel-header">
            <div>
              <h2 class="panel-title" id="editorTitle">افزودن سکشن جدید</h2>
              <p class="page-subtitle" id="editorSubtitle">مشخصات سکشن و محتوای کارت‌ها را در این قسمت ثبت کنید.</p>
            </div>
            <div class="badge" id="cardsCountBadge">۰ کارت</div>
          </div>

          <form id="sectionForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="sectionTitle">عنوان سکشن *</label>
                <input type="text" id="sectionTitle" name="title" placeholder="مثلاً محصولات ویژه" required />
              </div>
              <div class="form-group">
                <label for="sectionSlug">اسلاگ</label>
                <input type="text" id="sectionSlug" name="slug" placeholder="auto from title" />
              </div>
              <div class="form-group">
                <label for="sectionScope">دامنه سکشن</label>
                <select id="sectionScope" name="scope">
                  <option value="all_cities">تمام شهرها</option>
                  <option value="specific_city">فقط یک شهر</option>
                </select>
              </div>
              <div class="form-group">
                <label for="sectionCityName">نام شهر (اختیاری برای تمام شهرها)</label>
                <input type="text" id="sectionCityName" name="cityName" placeholder="مثلاً سنندج" />
              </div>
              <div class="form-group">
                <label for="sectionCityId">شناسه شهر (اختیاری)</label>
                <input type="text" id="sectionCityId" name="cityId" placeholder="city-id" />
              </div>
              <div class="form-group">
                <label for="sectionLayout">چیدمان</label>
                <select id="sectionLayout" name="layout">
                  <option value="carousel">اسلایدر</option>
                  <option value="grid">گرید</option>
                </select>
              </div>
              <div class="form-group">
                <label for="sectionOrder">ترتیب نمایش</label>
                <input type="number" id="sectionOrder" name="order" min="0" step="1" value="0" />
              </div>
              <div class="form-group">
                <label for="sectionViewAllText">متن CTA</label>
                <input type="text" id="sectionViewAllText" name="viewAllText" placeholder="مشاهده همه" />
              </div>
              <div class="form-group">
                <label for="sectionViewAllLink">لینک CTA</label>
                <input type="url" id="sectionViewAllLink" name="viewAllLink" placeholder="https://example.com" />
              </div>
              <div class="form-group">
                <label for="sectionSubtitleInput">زیرعنوان</label>
                <input type="text" id="sectionSubtitleInput" name="subtitle" placeholder="توضیح کوتاه برای کاربران" />
              </div>
            </div>
            <div class="form-group">
              <label for="sectionDescription">توضیحات سکشن</label>
              <textarea id="sectionDescription" name="description" placeholder="توضیح کامل‌تر برای سکشن"></textarea>
            </div>
            <div class="checkbox-field">
              <input type="checkbox" id="sectionIsActive" name="isActive" checked />
              <label for="sectionIsActive">این سکشن فعال باشد</label>
            </div>

            <div class="form-actions">
              <button type="submit" class="primary-btn" id="saveSectionBtn">
                <i class="ri-save-3-line"></i>
                ذخیره تغییرات
              </button>
              <button type="button" class="secondary-btn" id="resetFormBtn">
                <i class="ri-refresh-line"></i>
                انصراف
              </button>
              <button type="button" class="danger-btn" id="deleteSectionBtn" hidden>
                <i class="ri-delete-bin-6-line"></i>
                حذف سکشن
              </button>
            </div>
          </form>

          <div class="cards-panel" id="cardsPanel">
            <div class="cards-header">
              <div>
                <h3 class="panel-title" id="cardsPanelTitle">فروشگاه‌های سکشن</h3>
                <p class="page-subtitle">جستجو کنید، اضافه کنید و ترتیب را با Drag & Drop تغییر دهید.</p>
              </div>
            </div>
            <div class="form-grid" style="margin-bottom:1rem;">
              <div class="form-group" style="grid-column:1/-1;">
                <label for="storeSearchInput">جستجوی فروشگاه (نام یا شناسه)</label>
                <input type="text" id="storeSearchInput" placeholder="مثلاً کافه / 66f..." />
              </div>
            </div>
            <div class="cards-list" id="storeSearchResults"></div>
            <hr style="margin:1rem 0; border:0; border-top:1px solid var(--border);"/>
            <div class="cards-list" id="cardsContainer">
              <div class="empty-state">ابتدا یک سکشن را انتخاب یا ایجاد کنید تا فروشگاه‌ها نمایش داده شوند.</div>
            </div>
          </div>
        </section>
      </div>
    </main>

  <div class="toast" id="toast"></div>


  <script>
(() => {
  const API_BASE = '/api/home-card-sections';
  const SHOPS_API = '/api/shops';
  const toastEl = document.getElementById('toast');
  const sectionsContainer = document.getElementById('sectionsContainer');
  const sectionCountEl = document.getElementById('sectionCount');
  const cardsContainer = document.getElementById('cardsContainer');
  const cardsCountBadge = document.getElementById('cardsCountBadge');
  const cardsPanelTitle = document.getElementById('cardsPanelTitle');
  const searchInput = document.getElementById('storeSearchInput');
  const searchResults = document.getElementById('storeSearchResults');

  const sectionForm = document.getElementById('sectionForm');
  const editorTitle = document.getElementById('editorTitle');
  const editorSubtitle = document.getElementById('editorSubtitle');
  const deleteSectionBtn = document.getElementById('deleteSectionBtn');
  const resetFormBtn = document.getElementById('resetFormBtn');
  const newSectionBtn = document.getElementById('newSectionBtn');

  let sections = [];
  let shops = [];
  let selectedSectionId = null;

  const sectionFields = {
    title: document.getElementById('sectionTitle'), slug: document.getElementById('sectionSlug'),
    subtitle: document.getElementById('sectionSubtitleInput'), description: document.getElementById('sectionDescription'),
    scope: document.getElementById('sectionScope'), cityName: document.getElementById('sectionCityName'), cityId: document.getElementById('sectionCityId'),
    layout: document.getElementById('sectionLayout'), order: document.getElementById('sectionOrder'),
    viewAllText: document.getElementById('sectionViewAllText'), viewAllLink: document.getElementById('sectionViewAllLink'),
    isActive: document.getElementById('sectionIsActive')
  };

  const fnum = (n) => new Intl.NumberFormat('fa-IR').format(n || 0);
  const toast = (msg, type='success') => { toastEl.className = `toast ${type} show`; toastEl.textContent = msg; setTimeout(() => toastEl.classList.remove('show'), 2600); };
  const sortByOrder = (arr) => arr.sort((a,b)=>(Number(a.order)||0)-(Number(b.order)||0));

  function selectedSection() { return sections.find(s => s._id === selectedSectionId) || null; }

  function renderSections() {
    sortByOrder(sections);
    sectionCountEl.textContent = `${fnum(sections.length)} سکشن`;
    sectionsContainer.innerHTML = sections.length ? '' : '<div class="empty-state">سکشنی ثبت نشده است.</div>';
    sections.forEach((s) => {
      const el = document.createElement('div');
      el.className = `section-item ${s._id===selectedSectionId?'active':''}`;
      el.draggable = true;
      el.dataset.id = s._id;
      el.innerHTML = `<div class="section-item-title">${s.title || 'بدون عنوان'}</div>
        <div class="section-meta"><span class="badge">${s.scope==='specific_city'?'شهر خاص':'همه شهرها'}</span><span>${s.isActive ? 'فعال':'غیرفعال'}</span></div>
        <div class="section-meta"><span>${fnum((s.stores||[]).length)} فروشگاه</span><span>ترتیب ${Number(s.order)||0}</span></div>`;
      el.onclick = () => selectSection(s._id);
      el.addEventListener('dragstart', (e) => e.dataTransfer.setData('text/section-id', s._id));
      el.addEventListener('dragover', (e) => e.preventDefault());
      el.addEventListener('drop', async (e) => {
        e.preventDefault();
        const fromId = e.dataTransfer.getData('text/section-id');
        if (!fromId || fromId === s._id) return;
        const fromIndex = sections.findIndex(x => x._id === fromId);
        const toIndex = sections.findIndex(x => x._id === s._id);
        const [moved] = sections.splice(fromIndex, 1);
        sections.splice(toIndex, 0, moved);
        sections.forEach((x,i) => x.order = i);
        renderSections();
        await persistSectionOrder();
      });
      sectionsContainer.appendChild(el);
    });
  }

  function renderStores() {
    const section = selectedSection();
    cardsPanelTitle.textContent = `فروشگاه‌های سکشن: ${section?.title || '-'}`;
    const stores = sortByOrder([...(section?.stores || [])]);
    cardsCountBadge.textContent = `${fnum(stores.length)} فروشگاه`;
    if (!section) {
      cardsContainer.innerHTML = '<div class="empty-state">ابتدا سکشن را انتخاب کنید.</div>'; return;
    }
    if (!stores.length) {
      cardsContainer.innerHTML = '<div class="empty-state">فروشگاهی اضافه نشده است.</div>'; return;
    }
    cardsContainer.innerHTML = '';
    stores.forEach((item) => {
      const row = document.createElement('div');
      row.className = 'card-item';
      row.draggable = true;
      row.dataset.storeId = item.sellerId;
      const seller = item.seller || {};
      row.innerHTML = `<div class="card-item-head"><h4>${seller.storename || 'فروشگاه'}</h4></div>
        <div class="card-item-meta">${seller.city || ''} ${seller.address ? '• '+seller.address : ''}</div>
        <div class="form-grid" style="margin-top:.6rem;"><div class="form-group"><label>Badge NEW</label>
          <select data-badge="${item.sellerId}"><option value="none">بدون برچسب</option><option value="manual">دستی</option><option value="auto">اتومات (جدید)</option></select></div></div>
        <div class="card-item-actions"><button class="danger-btn" data-remove="${item.sellerId}">حذف</button></div>`;
      row.querySelector(`select[data-badge="${item.sellerId}"]`).value = item.badgeMode || 'none';
      row.querySelector(`select[data-badge="${item.sellerId}"]`).onchange = (e) => { item.badgeMode = e.target.value; saveSelectedSection(); };
      row.querySelector(`[data-remove="${item.sellerId}"]`).onclick = () => { section.stores = section.stores.filter(x => x.sellerId !== item.sellerId); renderStores(); saveSelectedSection(); };
      row.addEventListener('dragstart', (e) => e.dataTransfer.setData('text/store-id', item.sellerId));
      row.addEventListener('dragover', (e) => e.preventDefault());
      row.addEventListener('drop', (e) => {
        e.preventDefault();
        const fromId = e.dataTransfer.getData('text/store-id');
        const storesLocal = section.stores || [];
        const fi = storesLocal.findIndex(x => x.sellerId === fromId); const ti = storesLocal.findIndex(x => x.sellerId === item.sellerId);
        if (fi < 0 || ti < 0 || fi === ti) return;
        const [mv] = storesLocal.splice(fi,1); storesLocal.splice(ti,0,mv); storesLocal.forEach((x,i)=>x.order=i);
        renderStores(); saveSelectedSection();
      });
      cardsContainer.appendChild(row);
    });
  }

  function renderSearch() {
    const section = selectedSection();
    const q = (searchInput.value || '').trim().toLowerCase();
    if (!section) { searchResults.innerHTML = '<div class="empty-state">برای افزودن فروشگاه، ابتدا سکشن را ذخیره/انتخاب کنید.</div>'; return; }
    const selectedIds = new Set((section.stores||[]).map(x => x.sellerId));
    const list = shops.filter(s => !selectedIds.has(s.id) && (!q || (s.storename||'').toLowerCase().includes(q) || String(s.id).includes(q))).slice(0, 12);
    searchResults.innerHTML = list.length ? '' : '<div class="empty-state">نتیجه‌ای یافت نشد.</div>';
    list.forEach((shop) => {
      const row = document.createElement('div');
      row.className = 'card-item';
      row.innerHTML = `<div class="card-item-head"><h4>${shop.storename || 'بدون نام'}</h4></div><div class="card-item-meta">${shop.city || ''} ${shop.address ? '• '+shop.address : ''}</div><div class="card-item-actions"><button class="secondary-btn">افزودن</button></div>`;
      row.querySelector('button').onclick = () => {
        section.stores = section.stores || [];
        section.stores.push({ sellerId: shop.id, order: section.stores.length, badgeMode: 'none', isActive: true, seller: { storename: shop.storename, city: shop.city, address: shop.address }});
        renderStores(); renderSearch(); saveSelectedSection();
      };
      searchResults.appendChild(row);
    });
  }

  function fillForm(section = null) {
    sectionForm.reset();
    sectionFields.order.value = section?.order ?? 0;
    sectionFields.isActive.checked = section?.isActive !== false;
    Object.keys(sectionFields).forEach((k) => {
      const el = sectionFields[k];
      if (!el || !section || el.type === 'checkbox') return;
      el.value = section[k] ?? '';
    });
    if (section && sectionFields.isActive) sectionFields.isActive.checked = section.isActive !== false;
    editorTitle.textContent = section ? `ویرایش سکشن: ${section.title}` : 'افزودن سکشن جدید';
    editorSubtitle.textContent = 'مدیریت سکشن‌های صفحه اصلی به همراه فروشگاه‌ها';
    deleteSectionBtn.hidden = !section;
    renderStores(); renderSearch();
  }

  async function fetchSections() {
    const res = await fetch(`${API_BASE}/admin/all`, { credentials: 'include' });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.message || 'خطا در دریافت سکشن‌ها');
    sections = Array.isArray(data) ? data : [];
    renderSections();
    if (sections.length) selectSection(selectedSectionId || sections[0]._id); else fillForm(null);
  }

  async function fetchShops() {
    const res = await fetch(SHOPS_API, { credentials: 'include' });
    shops = res.ok ? (await res.json()) : [];
  }

  function selectSection(id) {
    selectedSectionId = id;
    renderSections();
    fillForm(selectedSection());
  }

  async function saveSelectedSection() {
    const section = selectedSection();
    if (!section) return;
    await fetch(`${API_BASE}/${section._id}`, {
      method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
      body: JSON.stringify(section)
    });
  }

  async function persistSectionOrder() {
    for (const sec of sections) await fetch(`${API_BASE}/${sec._id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ order: sec.order }) });
  }

  sectionForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const current = selectedSection();
    const payload = {
      title: sectionFields.title.value.trim(), slug: sectionFields.slug.value.trim(), subtitle: sectionFields.subtitle.value.trim(),
      description: sectionFields.description.value.trim(), scope: sectionFields.scope.value, cityName: sectionFields.cityName.value.trim(), cityId: sectionFields.cityId.value.trim(),
      layout: sectionFields.layout.value, order: Number(sectionFields.order.value)||0, viewAllText: sectionFields.viewAllText.value.trim(), viewAllLink: sectionFields.viewAllLink.value.trim(),
      ctaText: sectionFields.viewAllText.value.trim(), ctaLink: sectionFields.viewAllLink.value.trim(), isActive: sectionFields.isActive.checked,
      stores: (current?.stores||[]).map((x,i) => ({ sellerId: x.sellerId, order: i, badgeMode: x.badgeMode || 'none', isActive: true }))
    };
    if (!payload.title) return toast('عنوان الزامی است.', 'error');
    if (payload.scope === 'specific_city' && !payload.cityName && !payload.cityId) return toast('برای سکشن شهری، شهر را وارد کنید.', 'error');
    const method = current ? 'PUT' : 'POST';
    const url = current ? `${API_BASE}/${current._id}` : API_BASE;
    const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(payload) });
    const data = await res.json();
    if (!res.ok) return toast(data?.message || 'خطا در ذخیره', 'error');
    await fetchSections();
    selectSection(data._id);
    toast('با موفقیت ذخیره شد.');
  });

  deleteSectionBtn.onclick = async () => {
    const current = selectedSection(); if (!current) return;
    if (!confirm('سکشن حذف شود؟')) return;
    const res = await fetch(`${API_BASE}/${current._id}`, { method: 'DELETE', credentials: 'include' });
    if (!res.ok) return toast('حذف ناموفق بود.', 'error');
    selectedSectionId = null;
    await fetchSections();
    toast('سکشن حذف شد.');
  };

  resetFormBtn.onclick = () => fillForm(selectedSection());
  newSectionBtn.onclick = (e) => { e.preventDefault(); selectedSectionId = null; renderSections(); fillForm(null); };
  searchInput.addEventListener('input', renderSearch);
  sectionFields.scope.addEventListener('change', () => {
    const specific = sectionFields.scope.value === 'specific_city';
    sectionFields.cityName.disabled = !specific;
    sectionFields.cityId.disabled = !specific;
  });

  (async () => {
    try {
      await Promise.all([fetchShops(), fetchSections()]);
      sectionFields.scope.dispatchEvent(new Event('change'));
    } catch (err) {
      console.error(err); toast(err.message || 'خطا در بارگذاری', 'error');
    }
  })();
})();
</script>

<!-- TODO: افزودن رویدادهای PostHog پس از فعال‌سازی | TODO: Enable PostHog events after activation -->
<!--
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const safeCapture = window.safePosthogCapture || function () {};
    // safeCapture('event_name', { /* داده‌های تکمیلی */ });
  });
</script>
-->

</body>
</html>
