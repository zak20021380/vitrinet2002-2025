<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ثبت فروشگاه - ویترینت</title>
  <meta name="description" content="فرم ثبت فروشگاه جدید در ویترینت با انتخاب نام و آدرس اختصاصی فروشگاه. همین حالا فروشگاه آنلاین خود را راه‌اندازی کنید!" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(115deg, #e0fdfa 0%, #f8fafc 60%, #d4fbe8 100%);
      min-height: 100vh;
    }
    .glass {
      background: rgba(255,255,255,0.92);
      box-shadow: 0 10px 38px #10b98119, 0 2px 10px #0ea5e914;
      border-radius: 1.5rem;
      backdrop-filter: blur(10px);
    }
    .brand-btn {
      background: linear-gradient(90deg, #10b981 10%, #0ea5e9 100%);
      color: #fff !important;
      font-weight: bold;
      border-radius: 1rem;
      transition: all .17s;
      box-shadow: 0 2px 12px #10b98126;
    }
    .brand-btn:hover { filter: brightness(1.08);}
    .primary-text { color: #10b981; }
    input[type="password"]:invalid {
      background: #fef2f2;
      border-color: #ef4444;
    }
    
    /* Enhanced mobile header styles */

      .nav-links {
        position: fixed;
        top: 0;
        right: -100%;
        width: 70%;
        max-width: 280px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
        z-index: 100;
        padding: 1.5rem;
        overflow-y: auto;
      }
      .nav-links.active {
        right: 0;
      }
      .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 99;
        display: none;
      }
      .mobile-overlay.active {
        display: block;
      }
      .glass {
        padding: 1.25rem !important;
      }
    }
    
    @media (max-width: 400px) {
      .glass {
        padding: 1rem !important;
        border-radius: 1.25rem;
      }
      .header-logo {
        font-size: 1.25rem !important;
      }
    }
    
    .fadein { animation: fadein .7s; }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(30px);}
      to   { opacity: 1; transform: translateY(0);}
    }
    #category.open {
      position: absolute;
      z-index: 50;
      background: #fff;
      width: 100%;
      max-height: 15rem;
      overflow-y: auto;
    }
    
    /* Optimized hamburger menu */
    .hamburger {
      width: 24px;
      height: 20px;
      position: relative;
      cursor: pointer;
      display: inline-block;
      z-index: 101;
    }
    .hamburger span {
      background: #374151;
      border-radius: 2px;
      height: 3px;
      width: 100%;
      position: absolute;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      left: 0;
    }
    .hamburger span:nth-child(1) { top: 0; }
    .hamburger span:nth-child(2) { top: 8px; }
    .hamburger span:nth-child(3) { top: 16px; }
    .hamburger.active span:nth-child(1) {
      transform: rotate(45deg);
      top: 8px;
    }
    .hamburger.active span:nth-child(2) {
      opacity: 0;
    }
    .hamburger.active span:nth-child(3) {
      transform: rotate(-45deg);
      top: 8px;
    }
  </style>
  <script src="/nav-active.js" defer></script>
</head>
<body class="text-gray-800">

  <!-- Enhanced Mobile-First Header -->
  <header class="w-full bg-white/95 shadow-sm backdrop-blur-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <!-- Logo -->
        <div class="flex-shrink-0">
          <a href="index.html" class="header-logo font-bold text-[1.5rem] sm:text-[1.75rem] md:text-[2rem] bg-gradient-to-l from-[#11d6ad] via-[#10b981] to-[#2db4e8] bg-clip-text text-transparent" style="letter-spacing:1.5px;">ویترینت</a>
        </div>
        
        <!-- Desktop Navigation -->
        <nav class="hidden sm:flex items-center space-x-1 sm:space-x-2 md:space-x-4 rtl:space-x-reverse">
          <a href="index.html" class="text-gray-700 hover:text-[#10b981] font-medium px-3 py-2 text-sm md:text-base transition-colors duration-200">خانه</a>
          <a href="categories.html" class="text-gray-700 hover:text-[#0ea5e9] font-medium px-3 py-2 text-sm md:text-base transition-colors duration-200">دسته‌بندی</a>
          <a href="login.html" class="text-gray-700 hover:text-[#0ea5e9] font-medium px-3 py-2 text-sm md:text-base transition-colors duration-200">ورود</a>
        </nav>
        
        <!-- Mobile menu button -->
<button class="mobile-menu-btn hamburger sm:hidden" id="mobile-menu-btn" aria-label="منوی موبایل">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </div>
    
    <!-- Mobile Navigation -->
    <div class="nav-links sm:hidden" id="mobile-menu">
      <div class="flex items-center justify-between mb-6">
        <span class="font-bold text-lg text-gray-800">منو</span>
        <button class="text-gray-500 hover:text-gray-700" id="close-menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="space-y-3">
        <a href="index.html" class="block text-gray-700 hover:text-[#10b981] font-medium py-3 px-4 rounded-lg hover:bg-gray-50 transition-all duration-200">خانه</a>
        <a href="categories.html" class="block text-gray-700 hover:text-[#0ea5e9] font-medium py-3 px-4 rounded-lg hover:bg-gray-50 transition-all duration-200">دسته‌بندی</a>
        <a href="login.html" class="block text-gray-700 hover:text-[#0ea5e9] font-medium py-3 px-4 rounded-lg hover:bg-gray-50 transition-all duration-200">ورود</a>
      </div>
    </div>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>
  </header>

  <!-- فرم ثبت فروشگاه -->
<main class="max-w-xl mx-auto min-h-screen flex flex-col justify-center items-center px-2" style="margin-top:48px;">
    <section class="glass border rounded-2xl shadow-2xl p-6 sm:p-10" id="register-section">
      <h2 class="text-2xl sm:text-3xl font-extrabold primary-text mb-7 text-center">ثبت فروشگاه جدید</h2>
<form class="space-y-5" id="signup-form" autocomplete="off" novalidate>

  <!-- نام فروشنده -->
  <div>
    <label class="block text-sm font-bold mb-1">نام فروشنده <span class="text-red-500">*</span></label>
    <input required type="text" name="firstname" id="firstname" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="مثلاً علی" />
    <div id="firstname-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <!-- نام خانوادگی فروشنده -->
  <div>
    <label class="block text-sm font-bold mb-1">نام خانوادگی فروشنده <span class="text-red-500">*</span></label>
    <input required type="text" name="lastname" id="lastname" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="مثلاً حسینی" />
    <div id="lastname-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <!-- نام فروشگاه -->
  <div>
    <label class="block text-sm font-bold mb-1">نام فروشگاه <span class="text-red-500">*</span></label>
    <input required type="text" name="storename" id="storename" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="مثلاً گل‌فروش مرکزی" />
    <div id="storename-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <!-- نمایش و ساخت آدرس فروشگاه -->
  <div>
    <label class="block text-sm font-bold mb-1 flex items-center gap-1">
      نام آدرس فروشگاه <span class="text-red-500">*</span>
      <span class="ml-2 text-xs text-gray-500 font-normal">(فقط حروف انگلیسی کوچک و عدد، حداقل ۴ و حداکثر ۱۰ کاراکتر، بدون فاصله و کاراکتر خاص)</span>
    </label>
    <div class="flex items-center gap-2">
      <span class="whitespace-nowrap text-xs sm:text-base text-gray-500">vitreenet.ir/</span>
      <input required type="text" name="shopurl" id="shopurl"
        pattern="^[a-z0-9]{4,10}$"
        class="flex-1 p-3 border rounded-xl focus:ring-2 focus:ring-green-200 text-left ltr"
        placeholder="shopgol" maxlength="10" autocomplete="off" />
    </div>
    <div class="mt-2">
      <span class="text-xs bg-gray-100 rounded p-1" id="address-preview">آدرس فروشگاه شما: vitreenet.ir/shopgol</span>
    </div>
    <div class="text-xs text-gray-500 mt-2 bg-gray-50 rounded p-2">
      <strong>راهنما:</strong>
      <ul class="list-disc pr-5 mt-1">
        <li>فقط از حروف انگلیسی کوچک و عدد استفاده کنید.</li>
        <li>حداقل ۴ و حداکثر ۱۰ کاراکتر.</li>
        <li>از فاصله و کاراکترهای خاص (مثل @, #, !, ؟ و ...) استفاده نکنید.</li>
        <li>این نام بخشی از آدرس فروشگاه شما خواهد بود (<b>vitreenet.ir/</b>).</li>
        <li>مثال: <b>shopgol</b> | <b>cakebox</b> | <b>bookcity</b></li>
      </ul>
      <div id="shopurl-hint" class="text-red-500 mt-2 hidden"></div>
    </div>
  </div>
  <!-- پایان ساخت آدرس فروشگاه -->

  <div>
    <label class="block text-sm font-bold mb-1">شماره تماس <span class="text-red-500">*</span></label>
    <input required type="tel" id="phone" pattern="^09\d{9}$" name="phone" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="0912xxxxxxx" />
    <div id="phone-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <div class="relative">
    <label class="block text-sm font-bold mb-1">دسته‌بندی <span class="text-red-500">*</span></label>
    <select required name="category" id="category" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200 bg-white">
      <option value="" disabled selected data-placeholder="true">انتخاب دسته</option>
    </select>

    <!-- START: service examples (visible only for service categories) -->
<div id="service-examples" class="hidden mt-2 rounded-xl border border-gray-200 bg-gray-50 p-2.5">
  <div class="text-xs text-gray-600 mb-1.5">مثال‌های رایج <span class="font-bold" id="service-examples-title">خدمات</span>:</div>
  <div class="flex flex-wrap gap-2" id="service-examples-chips"></div>
  <div class="text-[11px] text-gray-500 mt-2" id="service-examples-hint">با لمس هر مورد، متن آن به «توضیحات فروشگاه» اضافه می‌شود.</div>
</div>
<!-- END: service examples -->

    <div id="category-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <div id="subcategory-wrapper" class="hidden">
    <label class="block text-sm font-bold mb-1">زیر دسته <span class="text-red-500">*</span></label>
    <div id="subcategory-chips" class="flex flex-wrap gap-2">
      <button type="button" data-value="لباس کودک" class="px-4 py-2 border border-gray-300 rounded-full text-sm bg-white text-gray-700 hover:bg-gray-100">لباس کودک</button>
      <button type="button" data-value="اسباب‌بازی" class="px-4 py-2 border border-gray-300 rounded-full text-sm bg-white text-gray-700 hover:bg-gray-100">اسباب‌بازی</button>
    </div>
    <input type="hidden" id="subcategory" />
    <div id="subcategory-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <div>
    <label class="block text-sm font-bold mb-1">شهر</label>
    <input type="text" readonly value="سنندج" class="w-full p-3 border rounded-xl bg-gray-100 text-gray-500 focus:ring-0 cursor-not-allowed" />
  </div>

  <div>
    <label class="block text-sm font-bold mb-1">آدرس دقیق <span class="text-red-500">*</span></label>
    <input required type="text" name="address" id="address" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="خیابان، کوچه، پلاک..." />
    <div id="address-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <div>
    <label class="block text-sm font-bold mb-1">توضیحات فروشگاه</label>
    <textarea name="desc" class="w-full p-3 border rounded-xl resize-none focus:ring-2 focus:ring-green-200" rows="3" placeholder="توضیحی درباره نوع خدمات یا محصولات..."></textarea>
  </div>

  <div>
    <label class="block text-sm font-bold mb-1 flex items-center gap-1">
      رمز عبور <span class="text-red-500">*</span>
      <span class="ml-2 text-xs text-gray-500 font-normal">(حداقل ۸ کاراکتر، شامل عدد، حرف انگلیسی و نماد)</span>
    </label>
    <input required type="password" id="pass1" minlength="8"
      class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="رمز عبور قوی وارد کنید" autocomplete="new-password" />
  </div>

  <div>
    <label class="block text-sm font-bold mb-1">تکرار رمز عبور <span class="text-red-500">*</span></label>
    <input required type="password" id="pass2" minlength="8"
      class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="رمز را دوباره وارد کنید" autocomplete="new-password" />
    <div id="pass-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <!-- قوانین سایت -->
  <div class="flex items-center gap-2 mt-3">
    <input required type="checkbox" id="rules" class="accent-[#10b981] w-5 h-5 rounded border-gray-400" />
    <label for="rules" class="text-sm select-none">
      <span>قوانین سایت را مطالعه کرده‌ام و قبول دارم.</span>
      <a href="rules.html" target="_blank" class="text-[#0ea5e9] underline hover:text-[#10b981]">مطالعه قوانین</a>
    </label>
  </div>
  <div id="rules-hint" class="text-xs mt-2 text-red-500 hidden"></div>

  <button type="submit" class="w-full brand-btn text-white py-3 rounded-xl font-bold text-lg shadow-md hover:opacity-90 transition mt-2">
    ثبت فروشگاه
  </button>

  <div id="pass-guide" class="text-xs text-gray-500 mt-1 text-center">
    رمز باید حداقل ۸ کاراکتر و ترکیبی از اعداد، حروف انگلیسی و نمادهایی مثل ! @ # $ % ^ & * باشد.
  </div>
</form>

    </section>

    <!-- مرحله تایید کد پیامکی -->
    <section class="glass border rounded-2xl shadow-2xl p-6 sm:p-10 fadein hidden" id="verify-section">
      <h2 class="text-xl sm:text-2xl font-extrabold text-[#10b981] mb-4 text-center">تأیید شماره موبایل</h2>
      <div class="text-center text-gray-600 text-sm mb-6">
        کد ۵ رقمی ارسال شده به شماره <span id="verify-phone" class="font-bold text-gray-800"></span> را وارد کنید.
        <div class="mt-2 text-xs text-gray-500">اگر پیامک دریافت نکردید، تا ۶۰ ثانیه صبر کنید یا شماره را بررسی نمایید.</div>
      </div>
      <form class="flex flex-col items-center gap-5" id="verify-form" autocomplete="off">
        <input type="text" inputmode="numeric" pattern="^\d{5}$" maxlength="5" id="sms-code" class="w-40 text-center border rounded-xl p-3 text-lg font-bold tracking-widest focus:ring-2 focus:ring-green-200" placeholder="-----" required />
        <div id="code-hint" class="text-xs text-red-500 hidden"></div>
        <button type="submit" class="w-full brand-btn text-white py-3 rounded-xl font-bold text-lg shadow-md hover:opacity-90 transition">
          تأیید کد
        </button>
        <button type="button" id="resend-btn" class="text-xs text-[#0ea5e9] underline hover:text-[#10b981] mt-2" disabled>ارسال مجدد کد <span id="resend-timer">(60)</span></button>
      </form>
    </section>
  </main>

  <!-- فوتر -->
  <footer class="mt-20 bg-white border-t text-center text-sm text-gray-500 py-4">
    © 2025 <span class="font-bold text-[#10b981]">ویترینت</span> | همه حقوق محفوظ است.
  </footer>

<script>
  // Mobile menu functionality
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileOverlay = document.getElementById('mobile-overlay');
  const closeMenuBtn = document.getElementById('close-menu');

  function toggleMobileMenu() {
    mobileMenuBtn.classList.toggle('active');
    mobileMenu.classList.toggle('active');
    mobileOverlay.classList.toggle('active');
    document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
  }

  mobileMenuBtn.addEventListener('click', toggleMobileMenu);
  closeMenuBtn.addEventListener('click', toggleMobileMenu);
  mobileOverlay.addEventListener('click', toggleMobileMenu);

  // Close menu when clicking on a link
  document.querySelectorAll('.nav-links a').forEach(link => {
    link.addEventListener('click', () => {
      if (mobileMenu.classList.contains('active')) {
        toggleMobileMenu();
      }
    });
  });

  // نمایش لحظه‌ای آدرس فروشگاه
  document.getElementById("shopurl").addEventListener("input", function (e) {
    let val = this.value.trim();
    // فقط حروف کوچک و عدد؛ بیشتر از 10 کاراکتر اجازه وارد کردن نده
    let cleaned = val.replace(/[^a-z0-9]/g, '').slice(0, 10);
    if (val !== cleaned) {
      this.value = cleaned;
    }
    let prev = document.getElementById("address-preview");
    if (cleaned.length > 0) {
      prev.innerText = "آدرس فروشگاه شما: vitreenet.ir/" + cleaned;
    } else {
      prev.innerText = "آدرس فروشگاه شما: vitreenet.ir/shopgol";
    }
    document.getElementById("shopurl-hint").classList.add("hidden");
  });

  // ریست پیام خطا با تغییر هر فیلد
  [
    ["firstname", "firstname-hint"],
    ["lastname", "lastname-hint"],
    ["pass1", "pass-hint"],
    ["pass2", "pass-hint"],
    ["storename", "storename-hint"],
    ["shopurl", "shopurl-hint"],
    ["phone", "phone-hint"],
    ["category", "category-hint"],
    ["address", "address-hint"],
    ["rules", "rules-hint"]
  ].forEach(function (pair) {
    let el = document.getElementById(pair[0]);
    if (el) {
      el.addEventListener("input", function () {
        document.getElementById(pair[1]).classList.add("hidden");
      });
      if (["category", "rules"].includes(pair[0])) {
        el.addEventListener("change", function () {
          document.getElementById(pair[1]).classList.add("hidden");
        });
      }
    }
  });

  const CATEGORY_API_URL = "http://localhost:5000/api/categories";
  const CATEGORY_CACHE_TTL = 60 * 1000;
  const DEFAULT_CATEGORY_LIST = [
    "پوشاک",
    "خوراک",
    "خدمات",
    "دیجیتال",
    "زیبایی",
    "کتاب و تحریر",
    "لوازم خانگی",
    "ورزشی",
    "تالار و مجالس",
    "قنادی و شیرینی",
    "گل و گیاه",
    "خودرو",
    "کودکان"
  ];
  const DEFAULT_SERVICE_SUBCATEGORIES = [
    "آرایشگاه مردانه",
    "آرایشگاه زنانه",
    "کارواش",
    "کلینیک زیبایی",
    "تعمیر موبایل",
    "آتلیه عکاسی",
    "خیاطی",
    "آرایش حیوانات"
  ];
  const DEFAULT_SERVICE_CATEGORY_NAMES = ["خدمات", "زیبایی", "تالار و مجالس", "خودرو", "ورزشی"];

  let serviceCategoryNames = new Set(DEFAULT_SERVICE_CATEGORY_NAMES);
  let categoriesCache = { data: null, expiresAt: 0 };
  let categoriesFetchPromise = null;

  function normaliseCategoryName(value) {
    if (!value) return "";
    return String(value).replace(/\s+/g, " ").trim();
  }

  function normaliseCategoryRecord(raw, fallbackType = "category") {
    if (raw == null) return null;
    if (typeof raw === "string") {
      const name = normaliseCategoryName(raw);
      if (!name) return null;
      return { id: `${fallbackType}-${name}`, name, slug: null, type: fallbackType };
    }
    if (typeof raw !== "object") return null;
    const name = normaliseCategoryName(raw.name || raw.title || raw.label || raw.slug || "");
    if (!name) return null;
    const id = raw.id || raw._id || raw.slug || `${fallbackType}-${name}`;
    const type = typeof raw.type === "string" ? raw.type : fallbackType;
    return {
      id: String(id),
      name,
      slug: raw.slug || null,
      type
    };
  }

  function setServiceCategoryNames(list = []) {
    const combined = [
      ...DEFAULT_SERVICE_CATEGORY_NAMES,
      ...list.map(normaliseCategoryName).filter(Boolean)
    ];
    serviceCategoryNames = new Set(combined);
  }

  function isServiceCategory(name) {
    const normalised = normaliseCategoryName(name);
    return normalised && serviceCategoryNames.has(normalised);
  }

  function renderCategoryOptions(records = []) {
    const select = document.getElementById("category");
    if (!select) return;
    const placeholder = select.querySelector("option[data-placeholder]");
    select.innerHTML = "";
    if (placeholder) {
      placeholder.selected = true;
      placeholder.disabled = true;
      select.appendChild(placeholder);
    } else {
      const option = document.createElement("option");
      option.value = "";
      option.disabled = true;
      option.selected = true;
      option.dataset.placeholder = "true";
      option.textContent = "انتخاب دسته";
      select.appendChild(option);
    }

    if (!records.length) {
      select.disabled = true;
      return;
    }

    records
      .map(item => normaliseCategoryRecord(item, "category"))
      .filter(Boolean)
      .sort((a, b) => a.name.localeCompare(b.name, "fa-IR", { sensitivity: "base" }))
      .forEach(item => {
        const option = document.createElement("option");
        option.value = item.name;
        option.textContent = item.name;
        option.dataset.categoryId = item.id;
        if (item.slug) option.dataset.slug = item.slug;
        select.appendChild(option);
      });

    select.disabled = false;
  }

  function handleServiceExampleClick(event) {
    const button = event.currentTarget;
    const tag = button?.dataset?.svcExample;
    if (!tag) return;
    const textarea = document.querySelector("textarea[name='desc']");
    if (!textarea) return;
    if (!textarea.value.includes(tag)) {
      textarea.value = textarea.value ? `${textarea.value.trim()} | ${tag}` : tag;
      showToast("به توضیحات اضافه شد: " + tag);
    } else {
      showToast("قبلاً اضافه شده 😉");
    }
  }

  function renderServiceExampleChips(records = []) {
    const serviceExamples = document.getElementById("service-examples");
    const chipsContainer = document.getElementById("service-examples-chips");
    const titleEl = document.getElementById("service-examples-title");
    if (!serviceExamples || !chipsContainer) return;

    chipsContainer.innerHTML = "";
    const chips = records
      .map(item => normaliseCategoryRecord(item, "service-subcategory"))
      .filter(Boolean)
      .sort((a, b) => a.name.localeCompare(b.name, "fa-IR", { sensitivity: "base" }));

    serviceExamples.dataset.hasChips = chips.length ? 'true' : 'false';

    if (!chips.length) {
      serviceExamples.classList.add("hidden");
    } else {
      chips.forEach(item => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.dataset.svcExample = item.name;
        btn.className = "px-3 py-1.5 rounded-full text-xs bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 active:scale-[.98]";
        btn.textContent = item.name;
        btn.addEventListener("click", handleServiceExampleClick);
        chipsContainer.appendChild(btn);
      });
    }

    if (titleEl) {
      const names = Array.from(serviceCategoryNames);
      titleEl.textContent = names.length ? names.slice(0, 3).join("، ") : "خدمات";
    }
  }

  function updateServiceExamplesVisibility(selectedValue) {
    const serviceExamples = document.getElementById("service-examples");
    if (!serviceExamples) return;
    const hasChips = serviceExamples.dataset.hasChips === 'true';
    if (isServiceCategory(selectedValue) && hasChips) {
      serviceExamples.classList.remove("hidden");
    } else {
      serviceExamples.classList.add("hidden");
    }
  }

  async function fetchCategoriesWithCache({ force = false } = {}) {
    if (!force) {
      if (categoriesCache.data && categoriesCache.expiresAt > Date.now()) {
        return categoriesCache.data;
      }
      if (categoriesFetchPromise) {
        return categoriesFetchPromise;
      }
    }

    categoriesFetchPromise = fetch(CATEGORY_API_URL, {
      credentials: "include"
    })
      .then(async response => {
        if (!response.ok) {
          let message = "خطا در دریافت دسته‌بندی‌ها.";
          try {
            const payload = await response.json();
            if (payload?.message) message = payload.message;
          } catch (err) {
            const text = await response.text();
            if (text) message = text;
          }
          throw new Error(message);
        }
        return response.json();
      })
      .then(payload => {
        const result = {
          categories: Array.isArray(payload?.categories) ? payload.categories : [],
          serviceSubcategories: Array.isArray(payload?.serviceSubcategories) ? payload.serviceSubcategories : [],
          metadata: payload?.metadata || {}
        };
        categoriesCache = {
          data: result,
          expiresAt: Date.now() + CATEGORY_CACHE_TTL
        };
        return result;
      })
      .finally(() => {
        categoriesFetchPromise = null;
      });

    return categoriesFetchPromise;
  }

  async function loadCategoriesIntoForm({ force = false } = {}) {
    try {
      const payload = await fetchCategoriesWithCache({ force });
      renderCategoryOptions(payload.categories);
      if (Array.isArray(payload?.metadata?.serviceCategoryNames)) {
        setServiceCategoryNames(payload.metadata.serviceCategoryNames);
      }
      renderServiceExampleChips(payload.serviceSubcategories);
      updateServiceExamplesVisibility(document.getElementById("category")?.value || "");
    } catch (error) {
      console.error("loadCategoriesIntoForm error ->", error);
      setServiceCategoryNames(DEFAULT_SERVICE_CATEGORY_NAMES);
      renderCategoryOptions(DEFAULT_CATEGORY_LIST);
      renderServiceExampleChips(DEFAULT_SERVICE_SUBCATEGORIES);
      updateServiceExamplesVisibility(document.getElementById("category")?.value || "");
    }
  }

  const categorySelect = document.getElementById("category");
  const subcatWrapper = document.getElementById("subcategory-wrapper");
  const subcatInput = document.getElementById("subcategory");
  const subcatChips = document.querySelectorAll('#subcategory-chips button');

  loadCategoriesIntoForm();

  if (categorySelect) {
    updateServiceExamplesVisibility(categorySelect.value);

    // دسته‌بندی: نشان دادن زیرگروه "کودکان" و مثال‌های خدمات
    categorySelect.addEventListener("change", function () {
      if (subcatWrapper && subcatInput) {
        if (this.value === "کودکان") {
          subcatWrapper.classList.remove("hidden");
        } else {
          subcatWrapper.classList.add("hidden");
          subcatInput.value = "";
          subcatChips.forEach(b => b.classList.remove('bg-[#10b981]','text-white','border-[#10b981]'));
          document.getElementById("subcategory-hint").classList.add("hidden");
        }
      }

      updateServiceExamplesVisibility(this.value);
    });
  }


  subcatChips.forEach(btn => {
    btn.addEventListener('click', function () {
      subcatChips.forEach(b => b.classList.remove('bg-[#10b981]','text-white','border-[#10b981]'));
      this.classList.add('bg-[#10b981]','text-white','border-[#10b981]');
      subcatInput.value = this.dataset.value;
      document.getElementById("subcategory-hint").classList.add("hidden");
    });
  });

  // force category dropdown to open downward
  categorySelect.addEventListener('focus', function(){
    this.size = this.options.length;
    this.classList.add('open');
  });
  categorySelect.addEventListener('blur', function(){
    this.size = 1;
    this.classList.remove('open');
  });
  categorySelect.addEventListener('change', function(){
    this.size = 1;
    this.classList.remove('open');
    this.blur();
  });

  // اعتبارسنجی و ارسال فرم ثبت فروشگاه
  document.getElementById("signup-form").addEventListener("submit", function (e) {
    e.preventDefault(); // همیشه ابتدا قرار بگیره تا فرم ارسال نشه تا بررسی کامل شه

    let hasError = false;

    // نام فروشنده
    let firstname = document.getElementById("firstname").value.trim();
    let firstnameHint = document.getElementById("firstname-hint");
    if (!firstname) {
      firstnameHint.innerText = "لطفاً نام فروشنده را وارد کنید.";
      firstnameHint.classList.remove("hidden");
      hasError = true;
    } else {
      firstnameHint.classList.add("hidden");
    }

    // نام خانوادگی فروشنده
    let lastname = document.getElementById("lastname").value.trim();
    let lastnameHint = document.getElementById("lastname-hint");
    if (!lastname) {
      lastnameHint.innerText = "لطفاً نام خانوادگی فروشنده را وارد کنید.";
      lastnameHint.classList.remove("hidden");
      hasError = true;
    } else {
      lastnameHint.classList.add("hidden");
    }

    // نام فروشگاه
    let storename = document.getElementById("storename").value.trim();
    let storenameHint = document.getElementById("storename-hint");
    if (!storename) {
      storenameHint.innerText = "لطفاً نام فروشگاه را وارد کنید.";
      storenameHint.classList.remove("hidden");
      hasError = true;
    } else {
      storenameHint.classList.add("hidden");
    }

    // آدرس فروشگاه
    let shopurl = document.getElementById("shopurl").value.trim();
    let shopurlHint = document.getElementById("shopurl-hint");
    if (shopurl.length < 4) {
      shopurlHint.innerText = "آدرس فروشگاه باید حداقل ۴ کاراکتر باشد.";
      shopurlHint.classList.remove("hidden");
      hasError = true;
    } else if (shopurl.length > 10) {
      shopurlHint.innerText = "آدرس فروشگاه نباید بیشتر از ۱۰ کاراکتر باشد.";
      shopurlHint.classList.remove("hidden");
      hasError = true;
    } else if (!/^[a-z0-9]+$/.test(shopurl)) {
      shopurlHint.innerText = "آدرس فقط می‌تواند شامل حروف انگلیسی کوچک و عدد باشد. از فاصله و کاراکترهای خاص مثل # یا ! استفاده نکنید.";
      shopurlHint.classList.remove("hidden");
      hasError = true;
    } else {
      shopurlHint.classList.add("hidden");
    }

    // شماره موبایل
    let phone = document.getElementById("phone").value.trim();
    let phoneHint = document.getElementById("phone-hint");
    if (!/^09\d{9}$/.test(phone)) {
      phoneHint.innerText = "شماره موبایل را به صورت صحیح و کامل وارد کنید (مثلاً 09123456789).";
      phoneHint.classList.remove("hidden");
      hasError = true;
    } else {
      phoneHint.classList.add("hidden");
    }

    // دسته‌بندی
    let category = document.getElementById("category").value;
    let categoryHint = document.getElementById("category-hint");
    if (!category) {
      categoryHint.innerText = "لطفاً دسته‌بندی فروشگاه را انتخاب کنید.";
      categoryHint.classList.remove("hidden");
      hasError = true;
    } else {
      categoryHint.classList.add("hidden");
    }

    // زیر دسته در صورت انتخاب دسته کودکان
    let subcategory = "";
    if (category === "کودکان") {
      subcategory = document.getElementById("subcategory").value;
      let subcategoryHint = document.getElementById("subcategory-hint");
      if (!subcategory) {
        subcategoryHint.innerText = "لطفاً زیر دسته کودکان را انتخاب کنید.";
        subcategoryHint.classList.remove("hidden");
        hasError = true;
      } else {
        subcategoryHint.classList.add("hidden");
      }
    }

    // آدرس دقیق
    let address = document.getElementById("address").value.trim();
    let addressHint = document.getElementById("address-hint");
    if (!address) {
      addressHint.innerText = "لطفاً آدرس دقیق فروشگاه را وارد کنید.";
      addressHint.classList.remove("hidden");
      hasError = true;
    } else {
      addressHint.classList.add("hidden");
    }

    // رمز عبور
    let pass1 = document.getElementById("pass1").value;
    let pass2 = document.getElementById("pass2").value;
    let passHint = document.getElementById("pass-hint");
    if (pass1.length < 8) {
      passHint.innerText = "رمز عبور باید حداقل ۸ کاراکتر باشد.";
      passHint.classList.remove("hidden");
      hasError = true;
    } else if (!/[a-zA-Z]/.test(pass1)) {
      passHint.innerText = "رمز عبور باید حداقل یک حرف انگلیسی داشته باشد.";
      passHint.classList.remove("hidden");
      hasError = true;
    } else if (!/\d/.test(pass1)) {
      passHint.innerText = "رمز عبور باید حداقل یک عدد داشته باشد.";
      passHint.classList.remove("hidden");
      hasError = true;
    } else if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pass1)) {
      passHint.innerText = "رمز عبور باید حداقل یک نماد مثل !@#$% داشته باشد.";
      passHint.classList.remove("hidden");
      hasError = true;
    } else if (pass1 !== pass2) {
      passHint.innerText = "رمز عبور و تکرار آن با هم یکسان نیستند.";
      passHint.classList.remove("hidden");
      hasError = true;
    } else {
      passHint.classList.add("hidden");
    }

    // قوانین سایت
    let rules = document.getElementById("rules");
    let rulesHint = document.getElementById("rules-hint");
    if (!rules.checked) {
      rulesHint.innerText = "لطفاً تیک پذیرش قوانین سایت را بزنید.";
      rulesHint.classList.remove("hidden");
      hasError = true;
    } else {
      rulesHint.classList.add("hidden");
    }

    // اگر حتی یکی از خطاها وجود داشت، اجازه ارسال فرم نده
    if (hasError) {
      return;
    }

    // ساخت داده‌ها برای ارسال به بک‌اند
    const data = {
      firstname: firstname,
      lastname: lastname,
      storename: storename,
      shopurl: shopurl,
      phone: phone,
      category: category,
      subcategory: subcategory,
      address: address,
      desc: document.querySelector("textarea[name='desc']").value.trim(),
      password: pass1,
    };

    // غیر فعال کردن دکمه ثبت تا پاسخ بیاد
    let btn = this.querySelector("button[type='submit']");
    btn.disabled = true;
    btn.innerText = "در حال ارسال...";

  fetch("http://localhost:5000/api/auth/register", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify(data),
})
.then(res => res.json())
.then(result => {
  btn.disabled = false;
  btn.innerText = "ثبت فروشگاه";
  if (result.success) {
    localStorage.setItem('shopurl', data.shopurl);
    SafeSS.setJSON('signup_password', data.password); // SafeSS

    // ✅ اضافه‌شدن نقش و دسته برای تعیین پنل بعد از وریفای
    // توجه: نقش از روی داده‌های دریافت شده از سرور تعیین می‌شود.
    SafeSS.setJSON('signup_category', data.category); // SafeSS
    SafeSS.setJSON('signup_role', isServiceCategory(data.category) ? 'service' : 'seller'); // SafeSS

    window.location.href = "verify.html?shopurl=" + encodeURIComponent(data.shopurl) + "&phone=" + encodeURIComponent(data.phone);
  }

  else {
    alert("خطا در ثبت‌نام: " + (result.message || "لطفاً دوباره تلاش کنید"));
  }
})


.catch(err => {
  btn.disabled = false;
  btn.innerText = "ثبت فروشگاه";
  console.error("Error:", err);
  alert("مشکلی در ارتباط با سرور پیش آمد.");
});


  });

  // مرحله تأیید شماره موبایل
function showVerifySection(phone) {
  // مقدار shopurl رو از localStorage بخون
  var shopurl = localStorage.getItem('shopurl');
  // ریدایرکت به صفحه verify.html با پارامتر
  window.location.href = `verify.html?shopurl=${encodeURIComponent(shopurl)}&phone=${encodeURIComponent(phone)}`;
}


  // تایید کد پیامک
// --- تایید کد پیامک با سرور ---
document.getElementById("verify-form").addEventListener("submit", function (e) {
  e.preventDefault();
  var code = document.getElementById("sms-code").value.trim();
  var codeHint = document.getElementById("code-hint");
  var params = new URLSearchParams(window.location.search);
  var shopurl = params.get("shopurl");
  var phone = params.get("phone");
  if (!/^\d{5}$/.test(code)) {
    codeHint.innerText = "کد تأیید باید دقیقاً ۵ رقم باشد.";
    codeHint.classList.remove("hidden");
    return false;
  }

  fetch("http://localhost:5000/api/auth/verify", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ shopurl, phone, code })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      // رمز رو از sessionStorage بخون برای لاگین
      var password = SafeSS.getJSON('signup_password'); // SafeSS
      if (!password) {
        codeHint.innerText = "خطا: رمز ثبت‌نام پیدا نشد. لطفا مجدد ثبت‌نام کنید.";
        codeHint.classList.remove("hidden");
        return;
      }
      // درخواست لاگین به سرور
      fetch("http://localhost:5000/api/auth/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ phone, password })
      })
      .then(res2 => res2.json())
      .then(loginRes => {
        if (loginRes.success && loginRes.seller) {
          // توکن و اطلاعات رو ذخیره کن (در صورت نیاز)
          localStorage.setItem('token', loginRes.token);
          localStorage.setItem('seller', JSON.stringify(loginRes.seller));
          // sessionStorage رو پاک کن
          sessionStorage.removeItem('signup_password');
          // ریدایرکت به داشبورد
          window.location.href = "seller/dashboard.html?shopurl=" + encodeURIComponent(loginRes.seller.shopurl);
        } else {
          codeHint.innerText = loginRes.message || "ورود ناموفق!";
          codeHint.classList.remove("hidden");
        }
      })
      .catch(() => {
        codeHint.innerText = "خطای ورود به اکانت!";
        codeHint.classList.remove("hidden");
      });
    } else {
      codeHint.innerText = result.message || "کد تایید اشتباه است!";
      codeHint.classList.remove("hidden");
    }
  })
  .catch(() => {
    codeHint.innerText = "مشکل ارتباط با سرور!";
    codeHint.classList.remove("hidden");
  });
});

document.getElementById("sms-code").addEventListener("input", function () {
  document.getElementById("code-hint").classList.add("hidden");
});

// تایمر ارسال مجدد کد
var resendBtn = document.getElementById("resend-btn");
var timerSpan = document.getElementById("resend-timer");
function startResendTimer() {
  resendBtn.disabled = true;
  let time = 60;
  timerSpan.innerText = `(${time})`;
  resendBtn.innerHTML = 'ارسال مجدد کد <span id="resend-timer">(' + time + ')</span>';
  timerSpan = document.getElementById("resend-timer");
  let t = setInterval(function () {
    time--;
    timerSpan.innerText = `(${time})`;
    if (time <= 0) {
      clearInterval(t);
      resendBtn.disabled = false;
      timerSpan.innerText = '';
      resendBtn.innerText = 'ارسال مجدد کد';
    }
  }, 1000);
}

resendBtn.addEventListener("click", function () {
  if (resendBtn.disabled) return;
  alert("کد جدید ارسال شد! (در حالت واقعی)");
  startResendTimer();
});



// Mini toast for quick feedback
function showToast(msg) {
  const el = document.createElement('div');
  el.className = "fixed bottom-4 left-1/2 -translate-x-1/2 z-[999] px-4 py-2 rounded-xl bg-gradient-to-l from-[#11d6ad] via-[#10b981] to-[#2db4e8] text-white text-sm shadow-lg";
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => {
    el.style.transition = "opacity .3s, transform .3s";
    el.style.opacity = "0";
    el.style.transform = "translate(-50%, 8px)";
    setTimeout(() => el.remove(), 300);
  }, 1400);
}


</script>


</body>
</html>