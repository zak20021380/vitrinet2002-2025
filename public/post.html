<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ثبت فروشگاه - ویترینت</title>
  <meta name="description" content="فرم ثبت فروشگاه جدید در ویترینت با انتخاب نام و آدرس اختصاصی فروشگاه. همین حالا فروشگاه آنلاین خود را راه‌اندازی کنید!" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(115deg, #e0fdfa 0%, #f8fafc 60%, #d4fbe8 100%);
      min-height: 100vh;
    }
    .glass {
      background: rgba(255,255,255,0.92);
      box-shadow: 0 10px 38px #10b98119, 0 2px 10px #0ea5e914;
      border-radius: 1.5rem;
      backdrop-filter: blur(10px);
    }
    .brand-btn {
      background: linear-gradient(90deg, #10b981 10%, #0ea5e9 100%);
      color: #fff !important;
      font-weight: bold;
      border-radius: 1rem;
      transition: all .17s;
      box-shadow: 0 2px 12px #10b98126;
    }
    .brand-btn:hover { filter: brightness(1.08);}
    .primary-text { color: #10b981; }
    input[type="password"]:invalid {
      background: #fef2f2;
      border-color: #ef4444;
    }
    
    /* Enhanced mobile header styles */

      .nav-links {
        position: fixed;
        top: 0;
        right: -100%;
        width: 70%;
        max-width: 280px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
        z-index: 100;
        padding: 1.5rem;
        overflow-y: auto;
      }
      .nav-links.active {
        right: 0;
      }
      .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 99;
        display: none;
      }
      .mobile-overlay.active {
        display: block;
      }
      .glass {
        padding: 1.25rem !important;
      }
    }
    
    @media (max-width: 400px) {
      .glass {
        padding: 1rem !important;
        border-radius: 1.25rem;
      }
      .header-logo {
        font-size: 1.25rem !important;
      }
    }
    
    .fadein { animation: fadein .7s; }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(30px);}
      to   { opacity: 1; transform: translateY(0);}
    }
    #category.open {
      position: absolute;
      z-index: 50;
      background: #fff;
      width: 100%;
      max-height: 15rem;
      overflow-y: auto;
    }
    
    /* Optimized hamburger menu */
    .hamburger {
      width: 24px;
      height: 20px;
      position: relative;
      cursor: pointer;
      display: inline-block;
      z-index: 101;
    }
    .hamburger span {
      background: #374151;
      border-radius: 2px;
      height: 3px;
      width: 100%;
      position: absolute;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      left: 0;
    }
    .hamburger span:nth-child(1) { top: 0; }
    .hamburger span:nth-child(2) { top: 8px; }
    .hamburger span:nth-child(3) { top: 16px; }
    .hamburger.active span:nth-child(1) {
      transform: rotate(45deg);
      top: 8px;
    }
    .hamburger.active span:nth-child(2) {
      opacity: 0;
    }
    .hamburger.active span:nth-child(3) {
      transform: rotate(-45deg);
      top: 8px;
    }
  </style>
  <script src="/nav-active.js" defer></script>
</head>
<body class="text-gray-800">

  <!-- Enhanced Mobile-First Header -->
  <header class="w-full bg-white/95 shadow-sm backdrop-blur-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <!-- Logo -->
        <div class="flex-shrink-0">
          <a href="index.html" class="header-logo font-bold text-[1.5rem] sm:text-[1.75rem] md:text-[2rem] bg-gradient-to-l from-[#11d6ad] via-[#10b981] to-[#2db4e8] bg-clip-text text-transparent" style="letter-spacing:1.5px;">ویترینت</a>
        </div>
        
        <!-- Desktop Navigation -->
        <nav class="hidden sm:flex items-center space-x-1 sm:space-x-2 md:space-x-4 rtl:space-x-reverse">
          <a href="index.html" class="text-gray-700 hover:text-[#10b981] font-medium px-3 py-2 text-sm md:text-base transition-colors duration-200">خانه</a>
          <a href="categories.html" class="text-gray-700 hover:text-[#0ea5e9] font-medium px-3 py-2 text-sm md:text-base transition-colors duration-200">دسته‌بندی</a>
          <a href="login.html" class="text-gray-700 hover:text-[#0ea5e9] font-medium px-3 py-2 text-sm md:text-base transition-colors duration-200">ورود</a>
        </nav>
        
        <!-- Mobile menu button -->
<button class="mobile-menu-btn hamburger sm:hidden" id="mobile-menu-btn" aria-label="منوی موبایل">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </div>
    
    <!-- Mobile Navigation -->
    <div class="nav-links sm:hidden" id="mobile-menu">
      <div class="flex items-center justify-between mb-6">
        <span class="font-bold text-lg text-gray-800">منو</span>
        <button class="text-gray-500 hover:text-gray-700" id="close-menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="space-y-3">
        <a href="index.html" class="block text-gray-700 hover:text-[#10b981] font-medium py-3 px-4 rounded-lg hover:bg-gray-50 transition-all duration-200">خانه</a>
        <a href="categories.html" class="block text-gray-700 hover:text-[#0ea5e9] font-medium py-3 px-4 rounded-lg hover:bg-gray-50 transition-all duration-200">دسته‌بندی</a>
        <a href="login.html" class="block text-gray-700 hover:text-[#0ea5e9] font-medium py-3 px-4 rounded-lg hover:bg-gray-50 transition-all duration-200">ورود</a>
      </div>
    </div>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>
  </header>

  <!-- فرم ثبت فروشگاه -->
<main class="max-w-xl mx-auto min-h-screen flex flex-col justify-center items-center px-2" style="margin-top:48px;">
    <section class="glass border rounded-2xl shadow-2xl p-6 sm:p-10" id="register-section">
      <h2 class="text-2xl sm:text-3xl font-extrabold primary-text mb-7 text-center">ثبت فروشگاه جدید</h2>
<form class="space-y-5" id="signup-form" autocomplete="off" novalidate>

  <!-- نام فروشنده -->
  <div>
    <label class="block text-sm font-bold mb-1">نام فروشنده <span class="text-red-500">*</span></label>
    <input required type="text" name="firstname" id="firstname" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="مثلاً علی" />
    <div id="firstname-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <!-- نام خانوادگی فروشنده -->
  <div>
    <label class="block text-sm font-bold mb-1">نام خانوادگی فروشنده <span class="text-red-500">*</span></label>
    <input required type="text" name="lastname" id="lastname" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="مثلاً حسینی" />
    <div id="lastname-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <!-- نام فروشگاه -->
  <div>
    <label class="block text-sm font-bold mb-1">نام فروشگاه <span class="text-red-500">*</span></label>
    <input required type="text" name="storename" id="storename" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="مثلاً گل‌فروش مرکزی" />
    <div id="storename-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <!-- نمایش و ساخت آدرس فروشگاه -->
  <div>
    <label class="block text-sm font-bold mb-1 flex items-center gap-1">
      نام آدرس فروشگاه <span class="text-red-500">*</span>
      <span class="ml-2 text-xs text-gray-500 font-normal">(فقط حروف انگلیسی کوچک و عدد، حداقل ۴ و حداکثر ۱۰ کاراکتر، بدون فاصله و کاراکتر خاص)</span>
    </label>
    <div class="flex items-center gap-2">
      <span class="whitespace-nowrap text-xs sm:text-base text-gray-500">vitreenet.ir/</span>
      <input required type="text" name="shopurl" id="shopurl"
        pattern="^[a-z0-9]{4,10}$"
        class="flex-1 p-3 border rounded-xl focus:ring-2 focus:ring-green-200 text-left ltr"
        placeholder="shopgol" maxlength="10" autocomplete="off" />
    </div>
    <div class="mt-2">
      <span class="text-xs bg-gray-100 rounded p-1" id="address-preview">آدرس فروشگاه شما: vitreenet.ir/shopgol</span>
    </div>
    <div class="text-xs text-gray-500 mt-2 bg-gray-50 rounded p-2">
      <strong>راهنما:</strong>
      <ul class="list-disc pr-5 mt-1">
        <li>فقط از حروف انگلیسی کوچک و عدد استفاده کنید.</li>
        <li>حداقل ۴ و حداکثر ۱۰ کاراکتر.</li>
        <li>از فاصله و کاراکترهای خاص (مثل @, #, !, ؟ و ...) استفاده نکنید.</li>
        <li>این نام بخشی از آدرس فروشگاه شما خواهد بود (<b>vitreenet.ir/</b>).</li>
        <li>مثال: <b>shopgol</b> | <b>cakebox</b> | <b>bookcity</b></li>
      </ul>
      <div id="shopurl-hint" class="text-red-500 mt-2 hidden"></div>
    </div>
  </div>
  <!-- پایان ساخت آدرس فروشگاه -->

  <div>
    <label class="block text-sm font-bold mb-1">شماره تماس <span class="text-red-500">*</span></label>
    <input required type="tel" id="phone" pattern="^09\d{9}$" name="phone" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="0912xxxxxxx" />
    <div id="phone-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <div class="relative">
    <label class="block text-sm font-bold mb-1">دسته‌بندی <span class="text-red-500">*</span></label>
    <select required name="category" id="category" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200 bg-white">
      <option value="" disabled selected>در حال بارگذاری...</option>
    </select>

    <!-- START: service examples (visible only for service categories) -->
<div id="service-examples" class="hidden mt-2 rounded-xl border border-gray-200 bg-gray-50 p-2.5">
  <div class="text-xs text-gray-600 mb-1.5 font-bold">زیر گروه</div>
  <div id="service-examples-chips" class="flex flex-wrap gap-2"></div>
  <input type="hidden" id="subcategory" />
  <div id="subcategory-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  <div class="text-[11px] text-gray-500 mt-2">برای انتخاب زیر گروه، روی گزینه موردنظر کلیک کنید.</div>
</div>
<!-- END: service examples -->

    <div id="category-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <div>
    <label class="block text-sm font-bold mb-1">شهر</label>
    <input type="text" readonly value="سنندج" class="w-full p-3 border rounded-xl bg-gray-100 text-gray-500 focus:ring-0 cursor-not-allowed" />
  </div>

  <div>
    <label class="block text-sm font-bold mb-1">آدرس دقیق <span class="text-red-500">*</span></label>
    <input required type="text" name="address" id="address" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="خیابان، کوچه، پلاک..." />
    <div id="address-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <div>
    <label class="block text-sm font-bold mb-1">توضیحات فروشگاه</label>
    <textarea name="desc" class="w-full p-3 border rounded-xl resize-none focus:ring-2 focus:ring-green-200" rows="3" placeholder="توضیحی درباره نوع خدمات یا محصولات..."></textarea>
  </div>

  <div>
    <label class="block text-sm font-bold mb-1 flex items-center gap-1">
      رمز عبور <span class="text-red-500">*</span>
      <span class="ml-2 text-xs text-gray-500 font-normal">(حداقل ۸ کاراکتر، شامل عدد، حرف انگلیسی و نماد)</span>
    </label>
    <div class="relative">
      <input required type="password" id="pass1" minlength="8"
        class="w-full p-3 pl-12 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="رمز عبور قوی وارد کنید" autocomplete="new-password" />
      <button type="button" data-target="pass1" data-visible="false"
        class="password-toggle absolute inset-y-0 left-3 flex items-center text-gray-400 hover:text-gray-600 transition focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#10b981]/60"
        aria-label="نمایش رمز عبور" aria-pressed="false">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12c1.5-4 5.25-7.5 9.75-7.5s8.25 3.5 9.75 7.5c-1.5 4-5.25 7.5-9.75 7.5S3.75 16 2.25 12z" />
          <circle cx="12" cy="12" r="3" stroke-linecap="round" stroke-linejoin="round"></circle>
        </svg>
      </button>
    </div>
  </div>

  <div>
    <label class="block text-sm font-bold mb-1">تکرار رمز عبور <span class="text-red-500">*</span></label>
    <div class="relative">
      <input required type="password" id="pass2" minlength="8"
        class="w-full p-3 pl-12 border rounded-xl focus:ring-2 focus:ring-green-200" placeholder="رمز را دوباره وارد کنید" autocomplete="new-password" />
      <button type="button" data-target="pass2" data-visible="false"
        class="password-toggle absolute inset-y-0 left-3 flex items-center text-gray-400 hover:text-gray-600 transition focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#10b981]/60"
        aria-label="نمایش رمز عبور" aria-pressed="false">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12c1.5-4 5.25-7.5 9.75-7.5s8.25 3.5 9.75 7.5c-1.5 4-5.25 7.5-9.75 7.5S3.75 16 2.25 12z" />
          <circle cx="12" cy="12" r="3" stroke-linecap="round" stroke-linejoin="round"></circle>
        </svg>
      </button>
    </div>
    <div id="pass-hint" class="text-xs mt-2 text-red-500 hidden"></div>
  </div>

  <!-- قوانین سایت -->
  <div class="flex items-center gap-2 mt-3">
    <input required type="checkbox" id="rules" class="accent-[#10b981] w-5 h-5 rounded border-gray-400" />
    <label for="rules" class="text-sm select-none">
      <span>قوانین سایت را مطالعه کرده‌ام و قبول دارم.</span>
      <a href="rules.html" target="_blank" class="text-[#0ea5e9] underline hover:text-[#10b981]">مطالعه قوانین</a>
    </label>
  </div>
  <div id="rules-hint" class="text-xs mt-2 text-red-500 hidden"></div>

  <button type="submit" class="w-full brand-btn text-white py-3 rounded-xl font-bold text-lg shadow-md hover:opacity-90 transition mt-2">
    ثبت فروشگاه
  </button>

  <div id="pass-guide" class="text-xs text-gray-500 mt-1 text-center">
    رمز باید حداقل ۸ کاراکتر و ترکیبی از اعداد، حروف انگلیسی و نمادهایی مثل ! @ # $ % ^ & * باشد.
  </div>
</form>

    </section>

    <!-- مرحله تایید کد پیامکی -->
    <section class="glass border rounded-2xl shadow-2xl p-6 sm:p-10 fadein hidden" id="verify-section">
      <h2 class="text-xl sm:text-2xl font-extrabold text-[#10b981] mb-4 text-center">تأیید شماره موبایل</h2>
      <div class="text-center text-gray-600 text-sm mb-6">
        کد ۵ رقمی ارسال شده به شماره <span id="verify-phone" class="font-bold text-gray-800"></span> را وارد کنید.
        <div class="mt-2 text-xs text-gray-500">اگر پیامک دریافت نکردید، تا ۶۰ ثانیه صبر کنید یا شماره را بررسی نمایید.</div>
      </div>
      <form class="flex flex-col items-center gap-5" id="verify-form" autocomplete="off">
        <input type="text" inputmode="numeric" pattern="^\d{5}$" maxlength="5" id="sms-code" class="w-40 text-center border rounded-xl p-3 text-lg font-bold tracking-widest focus:ring-2 focus:ring-green-200" placeholder="-----" required />
        <div id="code-hint" class="text-xs text-red-500 hidden"></div>
        <button type="submit" class="w-full brand-btn text-white py-3 rounded-xl font-bold text-lg shadow-md hover:opacity-90 transition">
          تأیید کد
        </button>
        <button type="button" id="resend-btn" class="text-xs text-[#0ea5e9] underline hover:text-[#10b981] mt-2" disabled>ارسال مجدد کد <span id="resend-timer">(60)</span></button>
      </form>
    </section>
  </main>

  <!-- فوتر -->
  <footer class="mt-20 bg-white border-t text-center text-sm text-gray-500 py-4">
    © 2025 <span class="font-bold text-[#10b981]">ویترینت</span> | همه حقوق محفوظ است.
  </footer>

<script>
  // --- Safe sessionStorage helper (SafeSS) ---
  const SafeSS = window.SafeSS || {
    setJSON(key, value) {
      try {
        const str = JSON.stringify(value);
        sessionStorage.setItem(key, str);
        return true;
      } catch (err) {
        console.warn('SafeSS setJSON failed', err);
        return false;
      }
    },
    getJSON(key, fallback = null) {
      try {
        const raw = sessionStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch (err) {
        console.warn('SafeSS getJSON failed', err);
        return fallback;
      }
    }
  };
  if (!window.SafeSS) {
    window.SafeSS = SafeSS;
  }

  // Mobile menu functionality
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileOverlay = document.getElementById('mobile-overlay');
  const closeMenuBtn = document.getElementById('close-menu');

  function toggleMobileMenu() {
    mobileMenuBtn.classList.toggle('active');
    mobileMenu.classList.toggle('active');
    mobileOverlay.classList.toggle('active');
    document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
  }

  mobileMenuBtn.addEventListener('click', toggleMobileMenu);
  closeMenuBtn.addEventListener('click', toggleMobileMenu);
  mobileOverlay.addEventListener('click', toggleMobileMenu);

  // Close menu when clicking on a link
  document.querySelectorAll('.nav-links a').forEach(link => {
    link.addEventListener('click', () => {
      if (mobileMenu.classList.contains('active')) {
        toggleMobileMenu();
      }
    });
  });

  // نمایش لحظه‌ای آدرس فروشگاه
  document.getElementById("shopurl").addEventListener("input", function (e) {
    let val = this.value.trim();
    // فقط حروف کوچک و عدد؛ بیشتر از 10 کاراکتر اجازه وارد کردن نده
    let cleaned = val.replace(/[^a-z0-9]/g, '').slice(0, 10);
    if (val !== cleaned) {
      this.value = cleaned;
    }
    let prev = document.getElementById("address-preview");
    if (cleaned.length > 0) {
      prev.innerText = "آدرس فروشگاه شما: vitreenet.ir/" + cleaned;
    } else {
      prev.innerText = "آدرس فروشگاه شما: vitreenet.ir/shopgol";
    }
    document.getElementById("shopurl-hint").classList.add("hidden");
  });

  // Password visibility toggles
  const passwordIcons = {
    show: `<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223a10.477 10.477 0 0 0-1.72 2.473 2.31 2.31 0 0 0 0 2.608C4.46 16.753 8.08 19.5 12 19.5c1.63 0 3.168-.43 4.542-1.155" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.33 16.63C20.8 15.44 22 13.842 22 12c0-.642-.228-1.27-.655-1.859C19.54 6.621 15.973 4.5 12 4.5c-.977 0-1.927.146-2.836.42" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 0 0-3-3" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" /></svg>`,
    hide: `<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12c1.5-4 5.25-7.5 9.75-7.5s8.25 3.5 9.75 7.5c-1.5 4-5.25 7.5-9.75 7.5S3.75 16 2.25 12z" /><circle cx="12" cy="12" r="3" stroke-linecap="round" stroke-linejoin="round"></circle></svg>`
  };

  document.querySelectorAll('.password-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.getAttribute('data-target');
      const input = document.getElementById(targetId);
      if (!input) return;

      const isVisible = btn.getAttribute('data-visible') === 'true';
      input.type = isVisible ? 'password' : 'text';
      btn.setAttribute('data-visible', String(!isVisible));
      btn.setAttribute('aria-pressed', String(!isVisible));
      btn.setAttribute('aria-label', isVisible ? 'نمایش رمز عبور' : 'پنهان کردن رمز عبور');
      btn.innerHTML = isVisible ? passwordIcons.hide : passwordIcons.show;
    });
  });

  // ریست پیام خطا با تغییر هر فیلد
  [
    ["firstname", "firstname-hint"],
    ["lastname", "lastname-hint"],
    ["pass1", "pass-hint"],
    ["pass2", "pass-hint"],
    ["storename", "storename-hint"],
    ["shopurl", "shopurl-hint"],
    ["phone", "phone-hint"],
    ["category", "category-hint"],
    ["address", "address-hint"],
    ["rules", "rules-hint"]
  ].forEach(function (pair) {
    let el = document.getElementById(pair[0]);
    if (el) {
      el.addEventListener("input", function () {
        document.getElementById(pair[1]).classList.add("hidden");
      });
      if (["category", "rules"].includes(pair[0])) {
        el.addEventListener("change", function () {
          document.getElementById(pair[1]).classList.add("hidden");
        });
      }
    }
  });

  const API_ORIGIN = window.location.origin.includes('localhost') ? 'http://localhost:5000' : window.location.origin;
  const CATEGORY_API_URL = `${API_ORIGIN}/api/categories`;
  const CATEGORY_CACHE_KEY = 'post.categories.cache';
  const SERVICE_CACHE_KEY = 'post.serviceSubcategories.cache';
  const CATEGORY_CACHE_TTL_MS = 1000 * 60 * 30; // 30 دقیقه

  // لیست دسته‌های خدماتی برای تشخیص نوع حساب کاربری
  const SERVICE_CATEGORIES = ["خدمات", "زیبایی", "تالار و مجالس", "خودرو", "ورزشی"];

  const DEFAULT_CATEGORIES = [
    'پوشاک',
    'خوراک',
    'خدمات',
    'دیجیتال',
    'زیبایی',
    'کتاب و تحریر',
    'لوازم خانگی',
    'ورزشی',
    'تالار و مجالس',
    'قنادی و شیرینی',
    'گل و گیاه',
    'خودرو',
    'کودکان'
  ];

  const DEFAULT_SERVICE_CATEGORY_NAME = 'خدمات';
  const DEFAULT_SERVICE_SUBCATEGORIES = [
    { name: 'آرایشگاه مردانه', parentName: DEFAULT_SERVICE_CATEGORY_NAME },
    { name: 'آرایشگاه زنانه', parentName: DEFAULT_SERVICE_CATEGORY_NAME },
    { name: 'کارواش', parentName: DEFAULT_SERVICE_CATEGORY_NAME },
    { name: 'کلینیک زیبایی', parentName: DEFAULT_SERVICE_CATEGORY_NAME },
    { name: 'تعمیر موبایل', parentName: DEFAULT_SERVICE_CATEGORY_NAME },
    { name: 'خیاطی', parentName: DEFAULT_SERVICE_CATEGORY_NAME }
  ];
  const DEFAULT_SERVICE_SUBCATEGORY_NAMES = DEFAULT_SERVICE_SUBCATEGORIES.map(item => item.name);
  const DEFAULT_SERVICE_PARENT_MAP = DEFAULT_SERVICE_SUBCATEGORIES.reduce((acc, item) => {
    if (item && item.name) {
      acc[item.name] = item.parentName || DEFAULT_SERVICE_CATEGORY_NAME;
    }
    return acc;
  }, {});

  const categorySelect = document.getElementById("category");
  const serviceExamplesContainer = document.getElementById('service-examples');
  const serviceExamplesChipsContainer = document.getElementById('service-examples-chips');
  const subcatWrapper = document.getElementById("subcategory-wrapper") || serviceExamplesContainer;
  const subcatInput = document.getElementById("subcategory");
  const subcatChipsContainer = document.getElementById('subcategory-chips') || serviceExamplesChipsContainer;
  const categoryState = {
    categories: [],
    serviceSubcategories: []
  };
  let subcategoryValidationActive = false;

  function toIdString(raw) {
    if (!raw) return '';
    if (typeof raw === 'string') return raw;
    if (typeof raw === 'object') {
      if (raw.$oid) return String(raw.$oid);
      if (raw._id) return String(raw._id);
      if (raw.id) return String(raw.id);
    }
    return String(raw);
  }

  function normaliseCategoryText(value) {
    if (!value) return '';
    return String(value).replace(/\s+/g, ' ').trim();
  }

  function getCategoryParentId(item) {
    if (!item) return '';
    if (typeof item === 'string') return '';
    return toIdString(
      item.parentId
        || item.parentID
        || item.parent
        || item.parentCategory
        || item.parentCategoryId
        || item.parentCategoryID
        || (item.parent && (item.parent._id || item.parent.id))
        || ''
    );
  }

  function getCategoryParentName(item) {
    if (!item) return '';
    if (typeof item === 'string') return DEFAULT_SERVICE_PARENT_MAP[item] || '';
    const value = item.parentName
      || item.parentLabel
      || item.parentTitle
      || (item.parent && (item.parent.name || item.parent.title))
      || '';
    return normaliseCategoryText(value);
  }

  function getCategoryType(item) {
    if (!item) return 'category';
    if (typeof item === 'string') return 'category';
    return item.type || 'category';
  }

  function normaliseCategoryItem(raw, fallbackType = 'category') {
    if (!raw) return null;
    if (typeof raw === 'string') {
      const name = normaliseCategoryText(raw);
      if (!name) return null;
      return {
        id: '',
        name,
        type: fallbackType,
        isDefault: fallbackType === 'service-subcategory'
          ? DEFAULT_SERVICE_SUBCATEGORY_NAMES.includes(name)
          : DEFAULT_CATEGORIES.includes(name),
        parentId: '',
        parentName: fallbackType === 'service-subcategory'
          ? DEFAULT_SERVICE_PARENT_MAP[name] || ''
          : ''
      };
    }
    const name = normaliseCategoryText(raw.name || raw.title || raw.label || '');
    if (!name) return null;
    const id = toIdString(raw._id || raw.id || raw.value || '');
    const type = raw.type || fallbackType;
    const parentId = getCategoryParentId(raw);
    const parentName = getCategoryParentName(raw) || (type === 'service-subcategory'
      ? DEFAULT_SERVICE_PARENT_MAP[name] || ''
      : '');
    return {
      id,
      name,
      type,
      isDefault: typeof raw.isDefault === 'boolean'
        ? raw.isDefault
        : (type === 'service-subcategory'
            ? DEFAULT_SERVICE_SUBCATEGORY_NAMES.includes(name)
            : DEFAULT_CATEGORIES.includes(name)),
      parentId,
      parentName
    };
  }

  function normaliseCategoryList(list = [], type = 'category') {
    const unique = new Map();
    list.forEach(item => {
      const record = normaliseCategoryItem(item, type);
      if (!record) return;
      const nameKey = record.name.toLocaleLowerCase('fa-IR');
      const parentKey = getCategoryType(record) === 'service-subcategory'
        ? (record.parentId || record.parentName.toLocaleLowerCase('fa-IR'))
        : '';
      const key = parentKey ? `${nameKey}__${parentKey}` : nameKey;
      if (!unique.has(key) || (!unique.get(key).id && record.id)) {
        unique.set(key, record);
      }
    });
    return Array.from(unique.values()).sort((a, b) => a.name.localeCompare(b.name, 'fa-IR', { sensitivity: 'base' }));
  }

  function saveCategoryCache(key, list) {
    try {
      if (typeof localStorage === 'undefined') return;
      const payload = {
        items: Array.isArray(list) ? list.map(item => ({
          id: item.id || '',
          name: item.name,
          type: item.type,
          isDefault: !!item.isDefault,
          parentId: item.parentId || '',
          parentName: item.parentName || ''
        })) : [],
        updatedAt: Date.now()
      };
      localStorage.setItem(key, JSON.stringify(payload));
    } catch (err) {
      console.warn('saveCategoryCache ->', err);
    }
  }

  function loadCategoryCache(key, fallback = [], type = 'category') {
    try {
      if (typeof localStorage === 'undefined') {
        return normaliseCategoryList(fallback, type);
      }
      const raw = localStorage.getItem(key);
      if (!raw) {
        return normaliseCategoryList(fallback, type);
      }
      const parsed = JSON.parse(raw);
      const updatedAt = Number(parsed?.updatedAt || 0);
      if (updatedAt && Date.now() - updatedAt > CATEGORY_CACHE_TTL_MS) {
        localStorage.removeItem(key);
        return normaliseCategoryList(fallback, type);
      }
      const list = Array.isArray(parsed?.items) ? parsed.items : Array.isArray(parsed) ? parsed : [];
      const normalised = normaliseCategoryList(list, type);
      if (!normalised.length) {
        return normaliseCategoryList(fallback, type);
      }
      return normalised;
    } catch (err) {
      console.warn('loadCategoryCache ->', err);
      return normaliseCategoryList(fallback, type);
    }
  }

  function renderCategoryOptions(list = []) {
    if (!categorySelect) return;
    const options = normaliseCategoryList(list, 'category');
    categoryState.categories = options;
    const previousOption = categorySelect.options[categorySelect.selectedIndex];
    const previousId = categorySelect.dataset.selectedId || (previousOption && previousOption.dataset.id) || '';
    const previousName = categorySelect.dataset.selectedName || categorySelect.value || '';
    categorySelect.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.disabled = true;
    placeholder.selected = true;
    placeholder.textContent = options.length ? 'انتخاب دسته' : 'دسته‌ای یافت نشد';
    categorySelect.appendChild(placeholder);

    let matched = false;
    options.forEach(item => {
      const option = document.createElement('option');
      const id = item.id || '';
      const name = item.name;
      option.value = name;
      option.textContent = name;
      if (id) {
        option.dataset.id = id;
      }
      if (!matched) {
        if (previousId && id && id === previousId) {
          option.selected = true;
          matched = true;
          placeholder.selected = false;
        } else if (!previousId && previousName && name === previousName) {
          option.selected = true;
          matched = true;
          placeholder.selected = false;
        }
      }
      categorySelect.appendChild(option);
    });

    categorySelect.disabled = !options.length;
    if (!matched && options.length) {
      placeholder.selected = true;
    }

    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
    categorySelect.dataset.selectedId = selectedOption?.dataset.id || '';
    categorySelect.dataset.selectedName = selectedOption?.value || '';

    if (!categorySelect.dataset.bound) {
      categorySelect.addEventListener('change', () => {
        const currentOption = categorySelect.options[categorySelect.selectedIndex];
        categorySelect.dataset.selectedId = currentOption?.dataset.id || '';
        categorySelect.dataset.selectedName = currentOption?.value || '';
        updateServiceChipsForSelection();
      });
      categorySelect.dataset.bound = 'true';
    }

    updateServiceChipsForSelection();
  }

  function highlightServiceChip(value = '') {
    const containers = [subcatChipsContainer, serviceExamplesChipsContainer].filter(Boolean);
    containers.forEach(container => {
      const buttons = container.querySelectorAll('button[data-value]');
      buttons.forEach(btn => {
        btn.classList.remove('bg-[#10b981]', 'text-white', 'border-[#10b981]');
        if (btn.dataset.value === value) {
          btn.classList.add('bg-[#10b981]', 'text-white', 'border-[#10b981]');
        }
      });
    });
  }

  function setSubcategoryRequiredState({ hasItems = false, selectedValue = '' } = {}) {
    const hint = document.getElementById('subcategory-hint');
    if (subcatWrapper) {
      subcatWrapper.dataset.hasItems = hasItems ? 'true' : 'false';
    }
    if (subcatInput) {
      subcatInput.dataset.required = hasItems ? 'true' : 'false';
    }
    if (!hint) return;
    if (hasItems && !selectedValue && subcategoryValidationActive) {
      hint.innerText = 'لطفاً زیر گروه را انتخاب کنید.';
      hint.classList.remove('hidden');
    } else {
      hint.classList.add('hidden');
    }
  }

  function handleSubcategorySelection(value = '') {
    const cleaned = typeof value === 'string' ? value.trim() : '';
    if (subcatInput) {
      subcatInput.value = cleaned;
    }
    highlightServiceChip(cleaned);
    const hint = document.getElementById('subcategory-hint');
    if (hint) {
      hint.classList.add('hidden');
    }
    subcategoryValidationActive = false;
    const hasItems = subcatWrapper ? subcatWrapper.dataset.hasItems === 'true' : false;
    setSubcategoryRequiredState({ hasItems, selectedValue: cleaned });
  }

  function renderServiceChips(list = []) {
    const normalised = Array.isArray(list) ? list : [];
    const hasItems = normalised.length > 0;

    if (serviceExamplesContainer) {
      serviceExamplesContainer.classList.toggle('hidden', !hasItems);
    }
    if (!hasItems && subcatInput) {
      subcatInput.value = '';
    }
    if (!hasItems) {
      subcategoryValidationActive = false;
      highlightServiceChip('');
      setSubcategoryRequiredState({ hasItems, selectedValue: '' });
    }

    if (!subcatChipsContainer) return;

    const selected = subcatInput ? subcatInput.value : '';
    subcatChipsContainer.innerHTML = '';
    if (!hasItems) {
      return;
    }

    normalised.forEach(item => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.dataset.value = item.name;
      if (item.id) {
        btn.dataset.id = item.id;
      }
      btn.className = 'px-4 py-2 border border-gray-300 rounded-full text-sm bg-white text-gray-700 hover:bg-gray-100';
      btn.textContent = item.name;
      if (item.name === selected) {
        btn.classList.add('bg-[#10b981]', 'text-white', 'border-[#10b981]');
      }
      subcatChipsContainer.appendChild(btn);
    });

    if (selected) {
      highlightServiceChip(selected);
    }

    setSubcategoryRequiredState({ hasItems, selectedValue: selected });
  }

  function matchesParent(item, filter) {
    if (!filter) return true;
    if (getCategoryType(item) !== 'service-subcategory') return true;
    const itemParentId = item.parentId || '';
    const itemParentName = normaliseCategoryText(item.parentName || '');
    const filterId = filter.id ? toIdString(filter.id) : filter.parentId ? toIdString(filter.parentId) : '';
    const filterName = filter.name
      ? normaliseCategoryText(filter.name)
      : filter.parentName
        ? normaliseCategoryText(filter.parentName)
        : '';
    if (filterId) {
      return itemParentId ? itemParentId === filterId : false;
    }
    if (itemParentId) {
      return false;
    }
    if (filterName) {
      return itemParentName ? itemParentName === filterName : false;
    }
    return !itemParentName;
  }

  function getSelectedCategoryFilter() {
    if (!categorySelect) return null;
    const option = categorySelect.options[categorySelect.selectedIndex];
    if (!option || !option.value) return null;
    if (option.dataset.id) {
      return { id: option.dataset.id };
    }
    return { name: option.value };
  }

  function updateServiceChipsForSelection() {
    const filter = getSelectedCategoryFilter();
    if (!filter) {
      renderServiceChips([]);
      return;
    }
    if (!categoryState.serviceSubcategories.length) {
      renderServiceChips([]);
      return;
    }
    const filtered = categoryState.serviceSubcategories.filter(item => matchesParent(item, filter));
    renderServiceChips(filtered);
  }

  function setServiceSubcategories(list = []) {
    categoryState.serviceSubcategories = normaliseCategoryList(list, 'service-subcategory');
    updateServiceChipsForSelection();
  }

  function applyCategoryPayload(data = {}) {
    const payload = data && typeof data === 'object' ? data : {};
    const categories = normaliseCategoryList(payload?.categories, 'category');
    const services = normaliseCategoryList(payload?.serviceSubcategories, 'service-subcategory');
    const categoriesProvided = Object.prototype.hasOwnProperty.call(payload, 'categories');
    const servicesProvided = Object.prototype.hasOwnProperty.call(payload, 'serviceSubcategories');

    const categoriesToUse = categoriesProvided
      ? categories
      : categoryState.categories.length
        ? categoryState.categories
        : normaliseCategoryList(DEFAULT_CATEGORIES, 'category');

    const servicesToUse = servicesProvided
      ? services
      : categoryState.serviceSubcategories.length
        ? categoryState.serviceSubcategories
        : normaliseCategoryList(DEFAULT_SERVICE_SUBCATEGORIES, 'service-subcategory');

    renderCategoryOptions(categoriesToUse);
    setServiceSubcategories(servicesToUse);
    saveCategoryCache(CATEGORY_CACHE_KEY, categoriesToUse);
    saveCategoryCache(SERVICE_CACHE_KEY, servicesToUse);
  }

  async function fetchCategoryDataForForm({ silent = false } = {}) {
    try {
      const res = await fetch(CATEGORY_API_URL, { credentials: 'include' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data?.message || 'خطا در دریافت دسته‌بندی‌ها.');
      }
      applyCategoryPayload(data);
      if (!silent) {
        showToast('دسته‌بندی‌ها به‌روزرسانی شد ✅');
      }
    } catch (error) {
      console.warn('fetchCategoryDataForForm ->', error);
      if (!silent) {
        showToast(error.message || 'امکان دریافت دسته‌بندی‌ها نبود ❗️');
      }
    }
  }

  const cachedCategories = loadCategoryCache(CATEGORY_CACHE_KEY, DEFAULT_CATEGORIES, 'category');
  const cachedServices = loadCategoryCache(SERVICE_CACHE_KEY, DEFAULT_SERVICE_SUBCATEGORIES, 'service-subcategory');
  renderCategoryOptions(cachedCategories);
  setServiceSubcategories(cachedServices);
  fetchCategoryDataForForm({ silent: true });

  // === Service examples: setup ===
  const chipContainers = Array.from(new Set([serviceExamplesChipsContainer, subcatChipsContainer].filter(Boolean)));
  chipContainers.forEach(container => {
    container.addEventListener('click', event => {
      const button = event.target.closest('button[data-value]');
      if (!button) return;
      handleSubcategorySelection(button.dataset.value || '');
    });
  });

  if (categorySelect) {
    categorySelect.addEventListener('change', function () {
      if (subcatInput) {
        subcatInput.value = '';
      }
      handleSubcategorySelection('');
      const hint = document.getElementById('subcategory-hint');
      if (hint) {
        hint.classList.add('hidden');
      }
    });
  }

  // force category dropdown to open downward
  categorySelect.addEventListener('focus', function(){
    this.size = this.options.length;
    this.classList.add('open');
  });
  categorySelect.addEventListener('blur', function(){
    this.size = 1;
    this.classList.remove('open');
  });
  categorySelect.addEventListener('change', function(){
    this.size = 1;
    this.classList.remove('open');
    this.blur();
  });

  // اعتبارسنجی و ارسال فرم ثبت فروشگاه
  document.getElementById("signup-form").addEventListener("submit", function (e) {
    e.preventDefault(); // همیشه ابتدا قرار بگیره تا فرم ارسال نشه تا بررسی کامل شه

    let hasError = false;

    // نام فروشنده
    let firstname = document.getElementById("firstname").value.trim();
    let firstnameHint = document.getElementById("firstname-hint");
    if (!firstname) {
      firstnameHint.innerText = "لطفاً نام فروشنده را وارد کنید.";
      firstnameHint.classList.remove("hidden");
      hasError = true;
    } else {
      firstnameHint.classList.add("hidden");
    }

    // نام خانوادگی فروشنده
    let lastname = document.getElementById("lastname").value.trim();
    let lastnameHint = document.getElementById("lastname-hint");
    if (!lastname) {
      lastnameHint.innerText = "لطفاً نام خانوادگی فروشنده را وارد کنید.";
      lastnameHint.classList.remove("hidden");
      hasError = true;
    } else {
      lastnameHint.classList.add("hidden");
    }

    // نام فروشگاه
    let storename = document.getElementById("storename").value.trim();
    let storenameHint = document.getElementById("storename-hint");
    if (!storename) {
      storenameHint.innerText = "لطفاً نام فروشگاه را وارد کنید.";
      storenameHint.classList.remove("hidden");
      hasError = true;
    } else {
      storenameHint.classList.add("hidden");
    }

    // آدرس فروشگاه
    let shopurl = document.getElementById("shopurl").value.trim();
    let shopurlHint = document.getElementById("shopurl-hint");
    if (shopurl.length < 4) {
      shopurlHint.innerText = "آدرس فروشگاه باید حداقل ۴ کاراکتر باشد.";
      shopurlHint.classList.remove("hidden");
      hasError = true;
    } else if (shopurl.length > 10) {
      shopurlHint.innerText = "آدرس فروشگاه نباید بیشتر از ۱۰ کاراکتر باشد.";
      shopurlHint.classList.remove("hidden");
      hasError = true;
    } else if (!/^[a-z0-9]+$/.test(shopurl)) {
      shopurlHint.innerText = "آدرس فقط می‌تواند شامل حروف انگلیسی کوچک و عدد باشد. از فاصله و کاراکترهای خاص مثل # یا ! استفاده نکنید.";
      shopurlHint.classList.remove("hidden");
      hasError = true;
    } else {
      shopurlHint.classList.add("hidden");
    }

    // شماره موبایل
    let phone = document.getElementById("phone").value.trim();
    let phoneHint = document.getElementById("phone-hint");
    if (!/^09\d{9}$/.test(phone)) {
      phoneHint.innerText = "شماره موبایل را به صورت صحیح و کامل وارد کنید (مثلاً 09123456789).";
      phoneHint.classList.remove("hidden");
      hasError = true;
    } else {
      phoneHint.classList.add("hidden");
    }

    // دسته‌بندی
    let category = document.getElementById("category").value;
    let categoryHint = document.getElementById("category-hint");
    if (!category) {
      categoryHint.innerText = "لطفاً دسته‌بندی فروشگاه را انتخاب کنید.";
      categoryHint.classList.remove("hidden");
      hasError = true;
    } else {
      categoryHint.classList.add("hidden");
    }

    // زیر گروه در صورت نیاز
    let subcategory = "";
    const shouldSelectSubcategory = subcatWrapper && subcatWrapper.dataset.hasItems === 'true';
    if (shouldSelectSubcategory) {
      subcategory = subcatInput ? (subcatInput.value || '').trim() : '';
      if (!subcategory) {
        subcategoryValidationActive = true;
        setSubcategoryRequiredState({ hasItems: true, selectedValue: '' });
        hasError = true;
      } else {
        subcategoryValidationActive = false;
        setSubcategoryRequiredState({ hasItems: true, selectedValue: subcategory });
      }
    } else {
      subcategoryValidationActive = false;
      setSubcategoryRequiredState({ hasItems: false, selectedValue: '' });
    }

    // آدرس دقیق
    let address = document.getElementById("address").value.trim();
    let addressHint = document.getElementById("address-hint");
    if (!address) {
      addressHint.innerText = "لطفاً آدرس دقیق فروشگاه را وارد کنید.";
      addressHint.classList.remove("hidden");
      hasError = true;
    } else {
      addressHint.classList.add("hidden");
    }

    // رمز عبور
    let pass1 = document.getElementById("pass1").value;
    let pass2 = document.getElementById("pass2").value;
    let passHint = document.getElementById("pass-hint");
    if (pass1.length < 8) {
      passHint.innerText = "رمز عبور باید حداقل ۸ کاراکتر باشد.";
      passHint.classList.remove("hidden");
      hasError = true;
    } else if (!/[a-zA-Z]/.test(pass1)) {
      passHint.innerText = "رمز عبور باید حداقل یک حرف انگلیسی داشته باشد.";
      passHint.classList.remove("hidden");
      hasError = true;
    } else if (!/\d/.test(pass1)) {
      passHint.innerText = "رمز عبور باید حداقل یک عدد داشته باشد.";
      passHint.classList.remove("hidden");
      hasError = true;
    } else if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pass1)) {
      passHint.innerText = "رمز عبور باید حداقل یک نماد مثل !@#$% داشته باشد.";
      passHint.classList.remove("hidden");
      hasError = true;
    } else if (pass1 !== pass2) {
      passHint.innerText = "رمز عبور و تکرار آن با هم یکسان نیستند.";
      passHint.classList.remove("hidden");
      hasError = true;
    } else {
      passHint.classList.add("hidden");
    }

    // قوانین سایت
    let rules = document.getElementById("rules");
    let rulesHint = document.getElementById("rules-hint");
    if (!rules.checked) {
      rulesHint.innerText = "لطفاً تیک پذیرش قوانین سایت را بزنید.";
      rulesHint.classList.remove("hidden");
      hasError = true;
    } else {
      rulesHint.classList.add("hidden");
    }

    // اگر حتی یکی از خطاها وجود داشت، اجازه ارسال فرم نده
    if (hasError) {
      return;
    }

    // ساخت داده‌ها برای ارسال به بک‌اند
    const data = {
      firstname: firstname,
      lastname: lastname,
      storename: storename,
      shopurl: shopurl,
      phone: phone,
      category: category,
      subcategory: subcategory,
      address: address,
      desc: document.querySelector("textarea[name='desc']").value.trim(),
      password: pass1,
    };

    // غیر فعال کردن دکمه ثبت تا پاسخ بیاد
    let btn = this.querySelector("button[type='submit']");
    btn.disabled = true;
    btn.innerText = "در حال ارسال...";

    fetch(`${API_ORIGIN}/api/auth/register`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then(res => res.json())
      .then(result => {
        btn.disabled = false;
        btn.innerText = "ثبت فروشگاه";
        if (result.success) {
          localStorage.setItem('shopurl', data.shopurl);
          SafeSS.setJSON('signup_password', data.password); // SafeSS

          // ✅ اضافه‌شدن نقش و دسته برای تعیین پنل بعد از وریفای
          // توجه: SERVICE_CATEGORIES بالاتر در همین فایل تعریف شده.
          SafeSS.setJSON('signup_category', data.category); // SafeSS
          SafeSS.setJSON('signup_role', SERVICE_CATEGORIES.includes(data.category) ? 'service' : 'seller'); // SafeSS

          window.location.href = "verify.html?shopurl=" + encodeURIComponent(data.shopurl) + "&phone=" + encodeURIComponent(data.phone);
        }

        else {
          alert("خطا در ثبت‌نام: " + (result.message || "لطفاً دوباره تلاش کنید"));
        }
      })
      .catch(err => {
        btn.disabled = false;
        btn.innerText = "ثبت فروشگاه";
        console.error("Error:", err);
        alert("مشکلی در ارتباط با سرور پیش آمد.");
      });


  });

  // مرحله تأیید شماره موبایل
function showVerifySection(phone) {
  // مقدار shopurl رو از localStorage بخون
  var shopurl = localStorage.getItem('shopurl');
  // ریدایرکت به صفحه verify.html با پارامتر
  window.location.href = `verify.html?shopurl=${encodeURIComponent(shopurl)}&phone=${encodeURIComponent(phone)}`;
}


  // تایید کد پیامک
// --- تایید کد پیامک با سرور ---
document.getElementById("verify-form").addEventListener("submit", function (e) {
  e.preventDefault();
  var code = document.getElementById("sms-code").value.trim();
  var codeHint = document.getElementById("code-hint");
  var params = new URLSearchParams(window.location.search);
  var shopurl = params.get("shopurl");
  var phone = params.get("phone");
  if (!/^\d{5}$/.test(code)) {
    codeHint.innerText = "کد تأیید باید دقیقاً ۵ رقم باشد.";
    codeHint.classList.remove("hidden");
    return false;
  }

  fetch(`${API_ORIGIN}/api/auth/verify`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ shopurl, phone, code })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      // رمز رو از sessionStorage بخون برای لاگین
      var password = SafeSS.getJSON('signup_password'); // SafeSS
      if (!password) {
        codeHint.innerText = "خطا: رمز ثبت‌نام پیدا نشد. لطفا مجدد ثبت‌نام کنید.";
        codeHint.classList.remove("hidden");
        return;
      }
      // درخواست لاگین به سرور
      fetch(`${API_ORIGIN}/api/auth/login`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ phone, password })
      })
      .then(res2 => res2.json())
      .then(loginRes => {
        if (loginRes.success && loginRes.seller) {
          // توکن و اطلاعات رو ذخیره کن (در صورت نیاز)
          localStorage.setItem('token', loginRes.token);
          localStorage.setItem('seller', JSON.stringify(loginRes.seller));
          // sessionStorage رو پاک کن
          sessionStorage.removeItem('signup_password');
          // ریدایرکت به داشبورد
          window.location.href = "seller/dashboard.html?shopurl=" + encodeURIComponent(loginRes.seller.shopurl);
        } else {
          codeHint.innerText = loginRes.message || "ورود ناموفق!";
          codeHint.classList.remove("hidden");
        }
      })
      .catch(() => {
        codeHint.innerText = "خطای ورود به اکانت!";
        codeHint.classList.remove("hidden");
      });
    } else {
      codeHint.innerText = result.message || "کد تایید اشتباه است!";
      codeHint.classList.remove("hidden");
    }
  })
  .catch(() => {
    codeHint.innerText = "مشکل ارتباط با سرور!";
    codeHint.classList.remove("hidden");
  });
});

document.getElementById("sms-code").addEventListener("input", function () {
  document.getElementById("code-hint").classList.add("hidden");
});

// تایمر ارسال مجدد کد
var resendBtn = document.getElementById("resend-btn");
var timerSpan = document.getElementById("resend-timer");
function startResendTimer() {
  resendBtn.disabled = true;
  let time = 60;
  timerSpan.innerText = `(${time})`;
  resendBtn.innerHTML = 'ارسال مجدد کد <span id="resend-timer">(' + time + ')</span>';
  timerSpan = document.getElementById("resend-timer");
  let t = setInterval(function () {
    time--;
    timerSpan.innerText = `(${time})`;
    if (time <= 0) {
      clearInterval(t);
      resendBtn.disabled = false;
      timerSpan.innerText = '';
      resendBtn.innerText = 'ارسال مجدد کد';
    }
  }, 1000);
}

resendBtn.addEventListener("click", function () {
  if (resendBtn.disabled) return;
  alert("کد جدید ارسال شد! (در حالت واقعی)");
  startResendTimer();
});



// Mini toast for quick feedback
function showToast(msg) {
  const el = document.createElement('div');
  el.className = "fixed bottom-4 left-1/2 -translate-x-1/2 z-[999] px-4 py-2 rounded-xl bg-gradient-to-l from-[#11d6ad] via-[#10b981] to-[#2db4e8] text-white text-sm shadow-lg";
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => {
    el.style.transition = "opacity .3s, transform .3s";
    el.style.opacity = "0";
    el.style.transform = "translate(-50%, 8px)";
    setTimeout(() => el.remove(), 300);
  }, 1400);
}


</script>


</body>
</html>