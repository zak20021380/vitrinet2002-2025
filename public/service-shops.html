<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="page-title">— | Vitreenet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            font-family: 'Vazirmatn', sans-serif;
        }
        :root {
            --footer-image: none;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .service-card {
            scroll-snap-align: start;
        }
        .review-card {
            scroll-snap-align: start;
        }
        .portfolio-card {
            scroll-snap-align: start;
        }
        .scroll-container {
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        .scroll-container::-webkit-scrollbar {
            display: none;
        }
        .bounce-animation {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        .progress-animation {
            animation: progress 2s ease-out;
        }
        @keyframes progress {
            0% {
                width: 0%;
            }
        }
        .premium-icon {
            transition: all 0.3s ease;
        }
        .premium-icon:hover {
            filter: drop-shadow(0 0 6px #3B82F6);
            transform: scale(1.1);
        }
        .badge-minimal {
            font-size: 0.65rem;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;
        }
        .scrollbar-hide {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Header Animations */
        .logo-animation {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .logo-animation:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.6));
        }
        .header-item {
            transition: all 0.2s ease;
        }
        .header-item:hover {
            transform: translateY(-2px);
        }
        .status-chip {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        .mobile-menu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .mobile-menu.active {
            max-height: 500px;
        }
        /* Service Card Styles */
        .service-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .service-price {
            font-size: 1.5rem;
            font-weight: 900;
            color: #1e40af;
        }
        .service-currency {
            font-size: 0.9rem;
            font-weight: 500;
            color: #64748b;
        }
        .service-button {
            background: linear-gradient(135deg, #06b6d4, #3b82f6, #10b981);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .service-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            transition: left 0.5s ease;
        }
        .service-button:hover::before {
            left: 100%;
        }
        .service-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
        }
        .service-button:active {
            transform: translateY(0) scale(0.98);
        }
        .cta-button {
            background: linear-gradient(135deg, #06b6d4, #3b82f6, #10b981);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .cta-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            transition: left 0.5s ease;
        }
        .cta-button:hover::before {
            left: 100%;
        }
        .cta-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
        }
        .cta-button:active {
            transform: translateY(0) scale(0.98);
        }
        
        /* Portfolio Section Styles */
        .portfolio-section {
            padding: 3rem 1rem;
            background: linear-gradient(to bottom, #f9fafb, #ffffff);
        }
        .portfolio-title {
            text-align: center;
            font-size: 1.875rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 0.5rem;
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .portfolio-title::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            border-radius: 4px;
            margin: 0.75rem auto 0;
        }
        .portfolio-subtitle {
            text-align: center;
            color: #64748b;
            font-size: 1.125rem;
            margin-bottom: 2.5rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        .portfolio-card {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .portfolio-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }
        .portfolio-img-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem 1rem 0 0;
            height: 220px;
        }
        .portfolio-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        .portfolio-card:hover .portfolio-img {
            transform: scale(1.05);
        }
        .portfolio-content {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .portfolio-name {
            font-weight: 700;
            font-size: 1.25rem;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }
        .portfolio-description {
            color: #64748b;
            font-size: 0.9375rem;
            line-height: 1.6;
            flex-grow: 1;
            margin-bottom: 1.5rem;
        }
        .portfolio-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .portfolio-stat {
            display: flex;
            align-items: center;
            color: #64748b;
            font-size: 0.875rem;
        }
        .portfolio-stat i {
            margin-left: 0.25rem;
        }
        .portfolio-btn {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            width: fit-content;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            margin-top: auto;
        }
        .portfolio-btn:hover {
            background: linear-gradient(135deg, #2563eb, #0891b2);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
        }
        .portfolio-btn:active {
            transform: translateY(0);
        }
        
        /* Modal Styles */
        #imageModal {
            transition: all 0.3s ease;
        }
        #imageModal .relative {
            transition: all 0.3s ease;
            transform: scale(0.95);
            opacity: 0;
        }
        #imageModal .scale-100 {
            transform: scale(1);
        }
        #imageModal .opacity-100 {
            opacity: 1;
        }
        #imageModal .scale-95 {
            transform: scale(0.95);
        }
        #imageModal .opacity-0 {
            opacity: 0;
        }
        
        /* Line clamp for description text */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* mobile nav */
        @media (max-width: 768px) {
            .hide-on-mobile { display: none !important; }
        }
        ::-webkit-scrollbar {width: 7px;}
        ::-webkit-scrollbar-thumb {background: #c8f7e6;}
        @media (max-width: 640px) {
            body { padding-bottom: 72px; }
            footer:not(.mobile-nav) { display: none; }
            .mobile-nav {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 72px;
                background: rgba(255,255,255,0.96);
                backdrop-filter: blur(12px);
                border-top: 1px solid rgba(224,242,254,0.8);
                border-radius: 24px 24px 0 0;
                box-shadow: 0 -5px 25px rgba(0,0,0,0.08);
                z-index: 100;
                padding: 8px 0;
            }
            .nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: #94a3b8;
                transition: all 0.2s;
                border-radius: 12px;
                padding: 6px 0;
            }
            .nav-item.active {
                color: #10b981;
                transform: translateY(-4px);
            }
            .nav-item:active { transform: scale(0.92); }
            .nav-icon {
                width: 24px;
                height: 24px;
                margin-bottom: 4px;
            }
            .nav-label {
                font-size: 11px;
                font-weight: 800;
            }
        }
        
/* --- Chips & Dialog (new) --- */
.chip {
  height: 36px;
  padding: 0 12px;
  border-radius: 9999px;
  font-weight: 800;
  font-size: 12px;
  background: rgba(255,255,255,0.82);
  color: #374151; /* gray-700 */
  border: 1px solid rgba(255,255,255,0.6);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  box-shadow: 0 4px 14px rgba(59,130,246,0.08);
  transition: all .2s ease;
  display: inline-flex; align-items: center; gap: 6px;
}
.chip:hover { background: #fff; box-shadow: 0 8px 22px rgba(59,130,246,0.14); }
.chip:active { transform: scale(0.98); }

.chip--primary {
  color: #fff;
  background: linear-gradient(135deg,#3B82F6,#06B6D4);
  border: none;
  box-shadow: 0 6px 20px rgba(59,130,246,0.28);
}
.chip--primary:hover { filter: brightness(0.98); }


.dialog-card-enter { transform: scale(0.96); opacity: 0; }
.dialog-card-show  { transform: scale(1);    opacity: 1; transition: all .18s ease; }





/* Professional booking status styles */
/* Simple time slot styles */
.time-slot {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 44px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  background: white;
  cursor: pointer;
  transition: all 0.2s ease;
}

.time-slot:hover {
  border-color: #3b82f6;
}

.time-slot.selected {
  border-color: #3b82f6;
  background: #eff6ff;
  color: #1d4ed8;
}

.time-slot:disabled {
  background: #f9fafb;
  color: #9ca3af;
  cursor: not-allowed;
  opacity: 0.6;
}

.time-slot:disabled:hover {
  border-color: #d1d5db;
}

@media (max-width: 640px) {
  .time-slot {
    height: 45px;
    font-size: 13px;
  }
  
  .booking-legend {
    gap: 12px;
    padding: 12px;
  }
  
  .legend-item {
    font-size: 12px;
  }
}
        
    </style>
</head>
<body class="bg-gray-50 text-gray-800" data-seller-id="123" data-store-id="123" data-shopurl="demo-shop">
    <!-- Sticky Header -->
    <!-- header desktop redesign start -->
<!-- header desktop redesign start -->
<!-- ===== Clean, Responsive Header (no "باز است") ===== -->
<header id="main-header" class="sticky top-0 z-[90] isolate bg-white/95 md:bg-white/70 md:backdrop-blur-lg border-b border-slate-200/70 shadow-sm transition-all duration-300">
  <!-- hairline -->
  <div aria-hidden="true" class="h-[2px] w-full bg-gradient-to-l from-cyan-400 via-blue-500 to-purple-500 opacity-70"></div>

  <!-- ========== Mobile ========== -->
  <div id="mobile-header" class="md:hidden px-3">
    <div id="mobile-top" class="flex items-center justify-between h-14 py-2">
      <!-- Right: Brand -->
      <a href="/index.html" class="flex items-center gap-2 font-extrabold text-[15px] text-blue-600 tracking-tight select-none">
        <span class="leading-none">ویترینت</span>
      </a>

      <!-- Center: Shop title -->
      <h1 id="header-shop-name-mobile"
          class="flex-1 mx-2 min-w-0 text-center text-[14px] sm:text-[15px] font-black text-slate-900 truncate"
          title="نام فروشگاه">
        نام فروشگاه
      </h1>

      <!-- Left: Address + Report -->
      <div class="flex items-center gap-1.5 flex-shrink-0">
        <button id="mobile-address-chip" data-open="addressModal" aria-label="آدرس"
                class="h-9 px-3 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 active:scale-95 transition text-[12px] font-bold text-slate-800 flex items-center gap-1.5">
          <i class="fa-solid fa-location-dot text-blue-600"></i>
          <span class="max-[360px]:hidden">آدرس</span>
        </button>
        <button id="mobile-report-trigger" data-open="reportModal" aria-label="گزارش"
                class="h-9 w-9 grid place-items-center rounded-lg border border-slate-200 bg-white hover:bg-slate-50 active:scale-95 transition">
          <i class="fa-regular fa-flag text-blue-700 text-[13px]"></i>
        </button>
      </div>
    </div>

    <!-- keep stub for your scroll logic -->
    <div id="mobile-chips" class="hidden h-0 overflow-hidden"></div>
  </div>

  <!-- ========== Desktop / Large screens ========== -->
  <div class="hidden md:block">
    <div class="max-w-screen-xl mx-auto px-3 py-3">
      <div class="rounded-2xl bg-white/75 backdrop-blur border border-white/60 ring-1 ring-black/5 shadow-sm px-4 lg:px-6 py-2.5">
        <div class="flex items-center justify-between gap-3">
          <!-- Right: Brand (RTL) -->
          <a href="/index.html" class="flex items-center gap-2 font-extrabold text-lg lg:text-xl text-blue-600 tracking-tight flex-shrink-0">
            <span class="leading-none">ویترینت</span>
          </a>

          <!-- Center: identity -->
          <div class="flex-1 min-w-0 flex items-center justify-center gap-3 text-sm">
            <h1 id="header-shop-name-lg"
                class="truncate font-black text-slate-900 max-w-[42vw] lg:max-w-[48vw]"
                title="نام فروشگاه">
              نام فروشگاه
            </h1>
            <span class="hidden sm:inline text-slate-300">·</span>
            <button id="desktop-address-chip" data-open="addressModal"
                    class="hidden sm:inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white/90 border border-slate-200 shadow-sm hover:bg-white text-[12px] text-slate-700">
              <i class="fa-solid fa-location-dot text-blue-600"></i>
              آدرس
            </button>
            <span class="hidden sm:inline text-slate-300">·</span>
            <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-amber-50 border border-amber-200 text-[12px] text-slate-800">
              <i class="fa-solid fa-star text-amber-400"></i>
              <span id="header-rating-lg" class="font-bold">0.0</span>
              <span class="text-slate-500">(<span id="header-count-lg">0</span>)</span>
            </span>
          </div>

          <!-- Left: report -->
          <button id="report-trigger" data-open="reportModal"
                  class="h-10 px-4 rounded-xl border border-slate-200 bg-white text-blue-700 font-bold hover:bg-slate-50 active:scale-95 transition flex-shrink-0">
            گزارش
          </button>
        </div>
      </div>
    </div>
  </div>
</header>


<div id="seller-profile" class="max-w-4xl mx-auto p-4 text-center hidden">
  <h2 id="seller-name" class="text-2xl font-bold mb-2"></h2>
  <p id="seller-category" class="text-gray-600"></p>
  <p id="seller-phone" class="text-gray-600"></p>
  <p id="seller-address" class="text-gray-600"></p>
</div>





<!-- Address Modal (simple & clean) -->
<div id="addressModal" role="dialog" aria-modal="true" aria-labelledby="address-title"
     class="hidden fixed inset-0 z-[80] items-center justify-center">
  <!-- backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" data-close></div>

  <!-- card -->
  <div class="modal-card relative w-[92%] max-w-sm bg-white rounded-2xl shadow-xl p-5
              transform transition duration-150 scale-95 opacity-0">
    <!-- close -->
    <button type="button" data-close
            class="absolute top-2 left-2 text-gray-500 hover:text-gray-700 text-xl leading-none">
      &times;
    </button>

    <!-- title -->
    <div class="flex items-center gap-2 mb-3">
      <span class="inline-flex w-9 h-9 items-center justify-center rounded-xl
                   bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
        <!-- pin icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
      </span>
      <h2 id="address-title" class="text-base font-extrabold text-gray-900">آدرس</h2>
    </div>

    <!-- content -->
    <div class="space-y-3 text-[13px] sm:text-sm leading-7 text-gray-700">
      <div class="flex items-start gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mt-1 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <p id="full-address">—</p>

      </div>

      <div class="flex items-center gap-2 text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-emerald-600" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6.62 10.79a15.053 15.053 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24c1.11.37 2.3.57 3.58.57a1 1 0 011 1V20a1 1 0 01-1 1C10.07 21 3 13.93 3 5a1 1 0 011-1h3.5a1 1 0 011 1c0 1.28.2 2.47.57 3.58a1 1 0 01-.24 1.01l-2.21 2.2z"/>
        </svg>
        <a id="modal-phone" href="tel:" class="font-bold tracking-wide">—</a>

      </div>
    </div>

    <!-- actions -->
    <div class="mt-5 text-left">
      <button type="button" data-close
              class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold">
        بستن
      </button>
    </div>
  </div>
</div>


<div id="reportModal" role="dialog" aria-modal="true" aria-labelledby="report-title"
     class="hidden fixed inset-0 z-[80] items-center justify-center">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" data-close></div>
  <div class="modal-card relative bg-white/80 backdrop-blur-xl border border-white/60 rounded-2xl shadow-lg p-6 w-11/12 max-w-md transform transition duration-150 scale-95 opacity-0">
    <h2 id="report-title" class="mb-4 text-lg font-bold bg-gradient-to-r from-blue-500/20 to-teal-400/20 p-2 rounded-xl text-center">گزارش مشکل</h2>
    <form id="report-form" class="space-y-4">
      <div>
        <textarea id="report-text" maxlength="500" class="w-full min-h-[6rem] p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm resize-none" placeholder="مشکل یا سوءاستفاده را توضیح دهید…"></textarea>
        <div id="report-counter" class="text-xs text-gray-500 text-left mt-1">۰/۵۰۰</div>
      </div>
      <input id="report-contact" type="text" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="اطلاعات تماس (اختیاری)">
      <div class="flex justify-end gap-3">
        <button type="button" data-close class="px-4 py-2 rounded-full bg-white/80 hover:bg-white hover:shadow transition focus:outline-none focus:ring-2 focus:ring-blue-500">انصراف</button>
        <button type="submit" class="px-4 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-500">ارسال گزارش</button>
      </div>
    </form>
  </div>
</div>



<!-- Pending Booking Modal -->
<div id="pendingBookingModal" role="dialog" aria-modal="true" aria-labelledby="pb-title"
     class="hidden fixed inset-0 z-[120] items-center justify-center">
  <!-- backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" data-close></div>

  <!-- card -->
  <div class="modal-card relative w-[92%] max-w-sm bg-white rounded-2xl shadow-2xl p-6
              transform transition duration-150 scale-95 opacity-0">
    <!-- close -->
    <button type="button" data-close
            class="absolute top-2 left-2 text-gray-500 hover:text-gray-700 text-xl leading-none">
      &times;
    </button>

    <!-- header -->
    <div class="flex items-center gap-3 mb-4">
      <span class="inline-flex w-10 h-10 items-center justify-center rounded-xl
                   bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s-9-6-9-13a9 9 0 1118 0c0 7-9 13-9 13z"></path>
          <path d="M9 12l2 2 4-4"></path>
        </svg>
      </span>
      <div>
        <h3 id="pb-title" class="text-base font-extrabold text-gray-900">درخواست ثبت شد</h3>
        <p class="text-xs text-gray-500">نوبت شما در انتظار تأیید فروشنده است</p>
      </div>
    </div>

    <!-- details -->
    <div class="rounded-xl bg-gray-50 border border-gray-200 p-4 mb-4 text-sm">
      <div class="grid grid-cols-2 gap-y-2 gap-x-3">
        <div class="text-gray-600">خدمت</div>   <div id="pb-service" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">تاریخ</div>   <div id="pb-date"    class="font-bold text-gray-800"></div>
        <div class="text-gray-600">ساعت</div>    <div id="pb-time"    class="font-bold text-gray-800"></div>
        <div class="text-gray-600">شماره شما</div><div id="pb-phone"   class="font-bold text-gray-800 ltr-num"></div>
      </div>
    </div>

    <div class="flex items-start gap-2 text-xs text-gray-600 mb-5">
      <i class="fas fa-sms mt-0.5"></i>
      <span>در صورت تأیید، نتیجه از طریق پیامک اطلاع‌رسانی می‌شود.</span>
    </div>

    <!-- actions -->
    <div class="flex justify-end">
      <button type="button" data-close
              class="px-4 py-2 rounded-full bg-blue-600 text-white font-bold hover:bg-blue-700">
        متوجه شدم
      </button>
    </div>
  </div>
</div>




<!-- Block Booking While Pending (clean popup) -->
<div id="pendingBlockModal" role="dialog" aria-modal="true" aria-labelledby="pb-block-title"
     class="hidden fixed inset-0 z-[130] items-center justify-center">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" data-close></div>

  <div class="modal-card relative w-[92%] max-w-sm bg-white rounded-2xl shadow-2xl p-6
              transform transition duration-150 scale-95 opacity-0">
    <button type="button" data-close class="absolute top-2 left-2 text-gray-500 hover:text-gray-700 text-xl leading-none">&times;</button>

    <div class="flex items-center gap-3 mb-3">
      <span class="inline-flex w-10 h-10 items-center justify-center rounded-xl bg-gradient-to-tr from-amber-500 to-red-500 text-white">
        <i class="fas fa-hourglass-half"></i>
      </span>
      <div>
        <h3 id="pb-block-title" class="text-base font-extrabold text-gray-900">لطفاً کمی صبر کنید</h3>
        <p class="text-xs text-gray-500">نوبت قبلی شما هنوز در انتظار تأیید فروشنده است.</p>
      </div>
    </div>

    <div class="rounded-xl bg-gray-50 border border-gray-200 p-4 mb-4 text-sm">
      <div class="grid grid-cols-2 gap-y-2 gap-x-3">
        <div class="text-gray-600">خدمت</div><div id="pblk-service" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">تاریخ</div><div id="pblk-date" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">ساعت</div><div id="pblk-time" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">ثبت‌شده</div><div id="pblk-created" class="font-bold text-gray-800"></div>
      </div>
    </div>

    <div class="text-xs text-gray-600 mb-5">
      پس از تأیید، از طریق پیامک اطلاع‌رسانی می‌شود و سپس می‌توانید نوبت جدید بگیرید.
    </div>

    <div class="flex justify-end">
      <button type="button" data-close class="px-4 py-2 rounded-full bg-blue-600 text-white font-bold hover:bg-blue-700">
        متوجه شدم
      </button>
    </div>
  </div>
</div>



<!-- Toast should be above modals -->
<div id="headerToast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] bg-blue-600 text-white text-sm px-4 py-2 rounded-full shadow-lg opacity-0 transition-opacity pointer-events-none"></div>


<script>
function showToastDark(message, {type='success', durationMs=2600} = {}) {
  const icons = {
    success: 'fas fa-check',
    info: 'fas fa-info-circle',
    error: 'fas fa-exclamation-circle'
  };
  const existing = document.getElementById('dark-toast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.id = 'dark-toast';
  toast.setAttribute('role', 'status');
  toast.setAttribute('aria-live', 'polite');
  toast.setAttribute('aria-atomic', 'true');
  toast.dir = 'ltr';
  toast.className = 'fixed left-1/2 -translate-x-1/2 bottom-[max(16px,env(safe-area-inset-bottom))] z-[160] bg-black text-white rounded-xl px-4 py-3 shadow-lg ring-1 ring-white/20 flex items-center gap-3 opacity-0 translate-y-2 transition-all duration-200 max-w-[92vw] sm:max-w-md';
  const icon = document.createElement('i');
  icon.className = icons[type] || icons.info;
  const msg = document.createElement('span');
  msg.textContent = message;
  msg.className = 'flex-1';
  msg.dir = 'rtl';
  const closeBtn = document.createElement('button');
  closeBtn.type = 'button';
  closeBtn.textContent = '×';
  closeBtn.className = 'text-xl leading-none';
  toast.append(icon, msg, closeBtn);
  document.body.appendChild(toast);
  requestAnimationFrame(() => {
    toast.classList.remove('opacity-0', 'translate-y-2');
  });
  function removeToast() {
    toast.classList.add('opacity-0', 'translate-y-2');
    setTimeout(() => toast.remove(), 200);
    document.removeEventListener('keydown', onKey);
  }
  function onKey(e) {
    if (e.key === 'Escape') removeToast();
  }
  document.addEventListener('keydown', onKey);
  toast.addEventListener('click', removeToast);
  closeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeToast(); });
  setTimeout(removeToast, durationMs);
}
</script>


<script>
(() => {
  // ====== Sticky header + toast ======
  const header = document.getElementById('main-header');
  const toast  = document.getElementById('headerToast');

  function showToast(msg) {
    if (!toast) return;
    toast.textContent = msg;
    toast.classList.remove('opacity-0');
    toast.classList.add('opacity-100');
    setTimeout(() => {
      toast.classList.add('opacity-0');
      toast.classList.remove('opacity-100');
    }, 2500);
  }

  // Header shadow on scroll
  window.addEventListener('scroll', () => {
    if (!header) return;
    if (window.scrollY > 10) {
      header.classList.add('shadow-lg');
    } else {
      header.classList.remove('shadow-lg');
    }
  });

  // Mobile top compact/expand
  const mobileTop   = document.getElementById('mobile-top');
  const mobileChips = document.getElementById('mobile-chips');
  let lastY = window.scrollY;
  window.addEventListener('scroll', () => {
    if (!mobileTop || !mobileChips) return;
    if (window.innerWidth > 768) return;
    if (window.scrollY > lastY && window.scrollY > 20) {
      mobileTop.classList.remove('py-3');
      mobileTop.classList.add('py-2');
      mobileChips.classList.add('hidden');
    } else {
      mobileTop.classList.add('py-3');
      mobileTop.classList.remove('py-2');
      mobileChips.classList.remove('hidden');
    }
    lastY = window.scrollY;
  });

  // ====== Unified modal system (for both mobile & desktop) ======
  const modalCache = new Map();

  function setupModal(modal) {
    const card = modal.querySelector('.modal-card');
    const closeEls = modal.querySelectorAll('[data-close]');
    let lastFocused = null;
    let prevOverflow = '';

    const focusableSelector = 'button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])';

    function open() {
      lastFocused = document.activeElement;
      prevOverflow = document.body.style.overflow || '';
      document.body.style.overflow = 'hidden';

      modal.classList.remove('hidden');
      modal.classList.add('flex'); // اگه کلاس flex تو HTML نباشه، اینجا تضمین می‌کنیم
      requestAnimationFrame(() => {
        card.classList.remove('scale-95','opacity-0');
        card.classList.add('scale-100','opacity-100');
        const firstFocusable = card.querySelector(focusableSelector);
        if (firstFocusable) firstFocusable.focus();
      });

      document.addEventListener('keydown', trap);
    }

    function close() {
      card.classList.add('scale-95','opacity-0');
      card.classList.remove('scale-100','opacity-100');

      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.removeEventListener('keydown', trap);
        document.body.style.overflow = prevOverflow;
        if (lastFocused) lastFocused.focus();
      }, 180);
    }

    function trap(e) {
      if (e.key === 'Escape') return close();
      if (e.key !== 'Tab') return;
      const f = card.querySelectorAll(focusableSelector);
      if (!f.length) return;
      const first = f[0], last = f[f.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault(); last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault(); first.focus();
      }
    }

    // Close via elements with data-close
    closeEls.forEach(el => el.addEventListener('click', close));
    // Close when clicking outside the card
    modal.addEventListener('click', (e) => {
      if (!card.contains(e.target)) close();
    });

    return { open, close };
  }

  function bindTriggers() {
    document.querySelectorAll('[data-open]').forEach(btn => {
      const id = btn.getAttribute('data-open');
      const modal = document.getElementById(id);
      if (!modal) return;
      if (!modalCache.has(id)) modalCache.set(id, setupModal(modal));
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        modalCache.get(id).open();
      });
    });
  }
  bindTriggers();

  window.openModalById = function(id) {
    const modal = document.getElementById(id);
    if (!modal) return;
    const cached = modalCache.get(id) || setupModal(modal);
    modalCache.set(id, cached);
    cached.open();
  };

  // ====== Address copy ======
  const addressCopyBtn = document.getElementById('address-copy-btn');
  const fullAddressEl  = document.getElementById('full-address');
  if (addressCopyBtn && fullAddressEl) {
    addressCopyBtn.addEventListener('click', () => {
      const txt = (fullAddressEl.textContent || '').trim();
      if (!txt) return;
      navigator.clipboard.writeText(txt).then(() => showToastDark('آدرس کپی شد', {type:'success'}));
    });
  }

  // ====== Report form + counter ======
  const reportModal   = document.getElementById('reportModal');
  const reportForm    = document.getElementById('report-form');
  const reportText    = document.getElementById('report-text');
  const reportCounter = document.getElementById('report-counter');

  if (reportText && reportCounter) {
    const updateCounter = () => {
      const len = reportText.value.length;
      reportCounter.textContent = `${len.toLocaleString('fa-IR')}/۵۰۰`;
    };
    reportText.addEventListener('input', updateCounter);
    updateCounter();
  }

  if (reportForm && reportModal) {
    const inst = modalCache.get('reportModal') || setupModal(reportModal);
    modalCache.set('reportModal', inst);
    reportForm.addEventListener('submit', (e) => {
      e.preventDefault();
      inst.close();
      showToastDark('گزارش شما ثبت شد', {type:'success'});
      reportForm.reset();
      if (reportCounter) reportCounter.textContent = '۰/۵۰۰';
    });
  }

  // ================== Booking Gate (prevent booking when previous is pending) ==================
  (function(){
    const KEY_LAST = 'vt:lastBooking';

    function readLast(){
      try { return JSON.parse(localStorage.getItem(KEY_LAST) || 'null'); } catch(e){ return null; }
    }
    function saveLast(obj){ localStorage.setItem(KEY_LAST, JSON.stringify(obj)); }
// نسخهٔ اصلاح‌شدهٔ hasPending با نرمال‌سازی وضعیت‌ها و پارامترهای بیشتر کوئری
async function hasPending(){
  const b = readLast();
  // If no pending booking, exit
  if (!b || b.status !== 'pending') return false;

  const base = window.__API_BASE__ || '';

  // Enhanced status normalization to catch more variations
  const normalize = (s) => {
    s = String(s || '').toLowerCase().trim();
    // Add more confirmed status variations
    if (['confirmed','approve','approved','accept','accepted','done','completed','success','ok','تایید','تایید شده','موفق'].includes(s)) return 'confirmed';
    if (['rejected','declined','canceled','cancelled','failed','no-show','noshow','رد','لغو','لغو شده'].includes(s)) return 'rejected';
    if (['pending','waiting','awaiting','in-review','در انتظار','منتظر'].includes(s)) return 'pending';
    
    // Log unknown statuses for debugging
    console.log('[hasPending] Unknown status:', s);
    return s || 'pending';
  };

  try {
    // Send all available identifiers for better matching
    const params = new URLSearchParams({
      phone: b.phone || '',
      ...(b.id && {id: b.id}),
      ...(b.sellerId && {sellerId: b.sellerId}),
      ...(b.bookingId && {bookingId: b.bookingId}),
      ...(b.date && {date: b.date}),
      ...(b.time && {time: b.time})
    });

    const res = await fetch(`${base}/api/bookings/status?${params.toString()}`, { 
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        ...(window.getToken && window.getToken() ? {'Authorization': 'Bearer ' + window.getToken()} : {})
      }
    });

    if (res.ok) {
      const data = await res.json();
      
      // Try multiple status field names
      const raw = data.status || data.state || data.bookingStatus || data.booking?.status || data.result?.status;
      const norm = normalize(raw);
      
      console.log('[hasPending] Status check:', { raw, normalized: norm, data });

      // If status changed from pending
      if (norm !== 'pending') {
        const next = {
          ...b,
          status: norm,
          resolvedAt: Date.now(),
          bookingId: data.id || data._id || data.bookingId || b.bookingId,
          // Preserve all booking details for loyalty system
          service: b.service,
          date: b.date,
          time: b.time,
          phone: b.phone,
          sellerId: b.sellerId || data.sellerId,
          shopUrl: b.shopUrl
        };
        saveLast(next);

        // Dispatch event for loyalty system
        window.dispatchEvent(new CustomEvent('booking:status', {
          detail: {
            id: next.id,
            status: norm,
            phone: next.phone,
            sellerId: next.sellerId,
            shopUrl: next.shopUrl,
            bookingId: next.bookingId,
            service: next.service
          }
        }));
        
        console.log('[hasPending] Booking confirmed, event dispatched:', next);
        return false; // No longer pending
      }

      // Still pending
      return true;
    }
  } catch (err) {
    console.warn('[hasPending] Check failed:', err);
  }

  // On network error, conservatively assume still pending
  return true;
}

    function fillBlockedModal(){
      const b = readLast(); if (!b) return;
      const $ = id => document.getElementById(id);
      $('pblk-service') && ( $('pblk-service').textContent = b.service || '' );
      $('pblk-date')    && ( $('pblk-date').textContent    = b.date    || '' );
      $('pblk-time')    && ( $('pblk-time').textContent    = b.time    || '' );
      $('pblk-created') && ( $('pblk-created').textContent = new Date(b.createdAt).toLocaleString('fa-IR') );
    }

    // بازکننده ویزارد با چک «pending»
    async function openBookingWizard(prefill){
      if (await hasPending()) {
        fillBlockedModal();
        if (typeof window.openModalById === 'function') window.openModalById('pendingBlockModal');
        return false;
      }
      const wiz = document.getElementById('booking-wizard');
      if (wiz && wiz.classList.contains('hidden')) wiz.classList.remove('hidden');

      // پیش‌انتخاب خدمت اگر از کارت خدمات اومدیم
      if (prefill && prefill.service) {
        document.querySelectorAll('#step-1 .service-option').forEach(opt => {
          const match = opt.dataset.service === prefill.service;
          opt.classList.toggle('bw-selected', match);
          if (match) opt.dispatchEvent(new Event('click'));
        });
      }

      const top = wiz.getBoundingClientRect().top + window.scrollY - 80;
      window.scrollTo({ top, behavior: 'smooth' });
      return true;
    }

    // اکسپورت‌ها
    window.__BOOKING_GUARD__ = { hasPending, readLast, saveLast, openBookingWizard };
    window.hasPendingBooking = hasPending;
    window.openBookingWizard = openBookingWizard;
    window.clearPendingBooking = function(){ localStorage.removeItem(KEY_LAST); };

    // اتصال دکمه‌های صفحه بعد از آماده‌شدن DOM
    document.addEventListener('DOMContentLoaded', () => {
      // CTA هیرو
      const hero = document.getElementById('hero-cta');
      if (hero) hero.addEventListener('click', (e) => { e.preventDefault(); openBookingWizard(); });

      // دکمه‌های «رزرو» روی کارت خدمات
      document.querySelectorAll('.service-button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          openBookingWizard({ service: btn.dataset.service, price: btn.dataset.price });
        });
      });
    });
  })();
  // ================== /Booking Gate ==================

})();
</script>



    <!-- Hero Section -->
<!-- PLACE: Replace the current hero <section> in service-shop.html with this block -->
<section lang="fa" dir="rtl" role="banner" aria-label="اطلاعات اصلی کسب‌وکار"
  class="relative isolate minh-dynamic flex items-center justify-center overflow-hidden px-3 sm:px-6">
  <!-- پس‌زمینه -->
  <div class="absolute inset-0 pointer-events-none select-none">
    <div class="absolute inset-0 bg-gradient-to-br from-blue-100 via-indigo-50/70 to-cyan-50"></div>
    <div class="absolute inset-0 opacity-[0.06] [background-image:radial-gradient(#000_1px,transparent_1.5px)] [background-size:18px_18px] [mask-image:radial-gradient(65%_65%_at_50%_40%,#000,transparent)]"></div>
    <div class="absolute -top-10 -right-6 w-64 h-64 rounded-full bg-purple-300/30 blur-3xl animate-blob"></div>
    <div class="absolute top-8 -left-10 w-64 h-64 rounded-full bg-amber-200/30 blur-3xl animate-blob animation-delay-2000"></div>
    <div class="absolute -bottom-14 right-6 w-64 h-64 rounded-full bg-pink-300/30 blur-3xl animate-blob animation-delay-4000"></div>
  </div>

  <!-- محتوا -->
  <div class="relative z-10 w-full py-8 sm:py-14 lg:py-16">
    <div class="mx-auto max-w-screen-md sm:max-w-2xl lg:max-w-4xl xl:max-w-6xl 2xl:max-w-[1280px]">
      <div class="relative group">
        <!-- هاله گرادیانی -->
        <div class="absolute -inset-[6px] rounded-[28px] lg:rounded-[32px] bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-500 blur-xl opacity-20 group-hover:opacity-35 transition duration-700"></div>

        <!-- کارت شیشه‌ای -->
        <div class="relative rounded-[22px] sm:rounded-[28px] lg:rounded-[32px] backdrop-blur-2xl bg-white/80 border border-white/40 ring-1 ring-black/5 shadow-[0_10px_40px_rgba(0,0,0,0.06)] overflow-hidden">
          <div class="h-1 w-full bg-gradient-to-r from-cyan-500 via-blue-600 to-purple-600"></div>

          <div class="p-5 sm:p-8 lg:p-10 space-y-6 sm:space-y-8 lg:space-y-9">
            <!-- عنوان (بدون متن زیرش) -->
            <div class="text-center space-y-3 sm:space-y-4 lg:space-y-5">
              <h1 id="biz-name"
                  class="font-extrabold leading-tight tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-gray-900 to-gray-700
                         text-[clamp(1.7rem,5vw,2.6rem)] lg:text-[clamp(2.2rem,2.4vw,3.2rem)]">
                نام کسب‌وکار شما
              </h1>
              <span class="mx-auto block h-[3px] w-24 sm:w-28 lg:w-32 rounded-full bg-gradient-to-l from-cyan-500 via-blue-500 to-purple-500 shadow-[0_0_22px_rgba(59,130,246,.25)]"></span>
              <!-- تگ‌لاین حذف شد -->
            </div>

            <!-- متادیتا -->
            <div class="flex flex-wrap items-center justify-center gap-2.5 sm:gap-4 lg:gap-4">
              <!-- امتیاز -->
              <div class="flex items-center gap-1.5 px-3 py-2 lg:px-3.5 lg:py-2 rounded-full bg-amber-50 border border-amber-200 text-xs sm:text-sm lg:text-sm shadow-sm
                          hover:ring-2 hover:ring-amber-200/70 transition">
                <svg class="w-4 h-4 lg:w-5 lg:h-5 text-amber-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                </svg>
                <span id="avg-rating" class="font-bold text-gray-800">۰٫۰</span>
                <span class="text-gray-500">( <span id="review-count">۰</span> )</span>
              </div>

              <!-- آدرس -->
              <button id="location-link" data-open="addressModal"
                class="flex items-center gap-1.5 px-3 py-2 lg:px-3.5 lg:py-2 rounded-full bg-blue-50 border border-blue-200 text-xs sm:text-sm lg:text-sm text-blue-700 shadow-sm
                       hover:bg-blue-100 hover:ring-2 hover:ring-blue-300 transition">
                <svg class="w-4 h-4 lg:w-5 lg:h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a2 2 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"/>
                  <circle cx="12" cy="11" r="3"></circle>
                </svg>
                <span id="hero-brief-address" class="font-medium">تهران، ولیعصر</span>
              </button>
            </div>

            <div class="w-full h-px bg-gradient-to-l from-transparent via-gray-200 to-transparent"></div>

            <!-- CTAها -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2.5 sm:gap-4 lg:gap-4">
              <button id="hero-cta"
                class="relative group/btn inline-flex items-center justify-center gap-2
                       px-6 sm:px-8 lg:px-8 py-3.5 sm:py-4 lg:py-4
                       rounded-2xl font-bold text-sm sm:text-base lg:text-base text-white
                       bg-gradient-to-r from-cyan-600 via-blue-600 to-purple-600 shadow-lg hover:shadow-xl
                       hover:-translate-y-0.5 active:scale-95 transition-all duration-200
                       focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400">
                <span class="absolute inset-0 rounded-2xl -z-10 bg-[linear-gradient(110deg,transparent,rgba(255,255,255,.25),transparent)]
                             -translate-x-full group-hover/btn:translate-x-0 transition-transform duration-700"></span>
                <svg class="w-5 h-5 sm:w-6 sm:h-6 lg:w-6 lg:h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M19 3h-1V1h-2v2H8V1H6v2H5A2 2 0 003 5v12a3 3 0 003 3h12a3 3 0 003-3V5a2 2 0 00-2-2zM5 9h14v8a1 1 0 01-1 1H6a1 1 0 01-1-1V9z"/>
                </svg>
                <span>رزرو آنلاین</span>
              </button>

              <a id="hero-call" href="tel:"
                 class="inline-flex items-center justify-center gap-2
                        px-6 sm:px-8 lg:px-8 py-3.5 sm:py-4 lg:py-4
                        rounded-2xl font-bold text-sm sm:text-base lg:text-base
                        border-2 border-gray-200 bg-white text-gray-700 hover:border-gray-300 hover:bg-gray-50
                        hover:-translate-y-0.5 active:scale-95 transition-all duration-200
                        focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-100">
                <svg class="w-5 h-5 sm:w-6 sm:h-6 lg:w-6 lg:h-6 text-green-600" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a1 1 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66a1 1 0 00.24-1.02c-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
                </svg>
                <span>تماس فوری</span>
              </a>
            </div>

            <!-- اعتماد مینیمال -->
            <div class="flex flex-wrap items-center justify-center gap-4 sm:gap-6 lg:gap-6 pt-1">
              <div class="flex items-center gap-1.5 text-xs sm:text-sm lg:text-sm text-gray-600">
                <span class="inline-block w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                <span>پاسخ‌گویی سریع</span>
              </div>
              <div class="flex items-center gap-1.5 text-xs sm:text-sm lg:text-sm text-gray-600">
                <span class="inline-block w-2 h-2 rounded-full bg-blue-500"></span>
                <span>رزرو امن</span>
              </div>
              <div class="flex items-center gap-1.5 text-xs sm:text-sm lg:text-sm text-gray-600">
                <span class="inline-block w-2 h-2 rounded-full bg-purple-500"></span>
                <span>کیفیت تضمین‌شده</span>
              </div>
            </div>
          </div>
        </div>
      </div>      
    </div>
  </div>
</section>

<style>
  /* ارتفاع پویا برای موبایل‌های ناچ‌دار */
  .minh-dynamic { min-height: 82vh; min-height: 82svh; min-height: 82dvh; padding-bottom: env(safe-area-inset-bottom, 0); }

  /* انیمیشن‌های ملایم */
  @keyframes blob {
    0%,100% { transform: translate(0,0) scale(1); }
    33%     { transform: translate(26px,-40px) scale(1.06); }
    66%     { transform: translate(-18px,18px) scale(0.95); }
  }
  .animate-blob { animation: blob 12s infinite cubic-bezier(.4,0,.2,1); }
  .animation-delay-2000 { animation-delay: 2s; }
  .animation-delay-4000 { animation-delay: 4s; }

  @media (prefers-reduced-motion: reduce) {
    .animate-blob { animation: none; }
  }
</style>








    <!-- Services Section -->
<section class="py-8 px-4">
    <h3 class="text-xl font-bold mb-4">خدمات ما</h3>
    <div class="scroll-container flex overflow-x-auto pb-4 gap-4 snap-x snap-mandatory scrollbar-hide" style="scroll-padding: 0 1rem;">
            <!-- Service Card 1 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/barber-cutting-hair/400/300.jpg" alt="اصلاح سر و صورت" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">اصلاح سر و صورت</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">اصلاح حرفه‌ای سر و صورت با جدیدترین متدهای روز</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">۱۵۰,۰۰۰</span>
                            <span class="service-currency mr-1">تومان</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="اصلاح سر و صورت" data-price="150000">
                            رزرو
                        </button>
                    </div>
                </div>
            </div>
            <!-- Service Card 2 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/facial-massage/400/300.jpg" alt="ماساژ صورت" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">ماساژ صورت</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">ماساژ صورت با روغن‌های گیاهی و مراقبت از پوست</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">۱۲۰,۰۰۰</span>
                            <span class="service-currency mr-1">تومان</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="ماساژ صورت" data-price="120000">
                            رزرو
                        </button>
                    </div>
                </div>
            </div>
            <!-- Service Card 3 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/hair-coloring/400/300.jpg" alt="رنگ مو" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">رنگ مو</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">رنگ موی حرفه‌ای با بهترین برندهای روز دنیا</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">۲۰۰,۰۰۰</span>
                            <span class="service-currency mr-1">تومان</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="رنگ مو" data-price="200000">
                            رزرو
                        </button>
                    </div>
                </div>
            </div>
            <!-- Service Card 4 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/professional-hair-wash/400/300.jpg" alt="شستشوی حرفه‌ای" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">شستشوی حرفه‌ای</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">شستشوی حرفه‌ای مو با شامپوهای مخصوص</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">۸۰,۰۰۰</span>
                            <span class="service-currency mr-1">تومان</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="شستشوی حرفه‌ای" data-price="80000">
                            رزرو
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Portfolio Section - Updated -->
<!-- ============ Portfolio Section (Dynamic, from backend) ============ -->
<section id="portfolio" class="portfolio-section">
  <div class="container mx-auto px-4">
    <div class="text-center mb-6">
      <h2 class="portfolio-title text-3xl font-extrabold">نمونه کارها</h2>
      <p id="portfolio-empty" class="hidden text-gray-500 text-sm mt-3">فعلاً نمونه کاری ثبت نشده.</p>
      <div id="portfolio-loading" class="flex items-center justify-center gap-2 text-gray-500 text-sm mt-2">
        <i class="fas fa-spinner fa-spin"></i><span>در حال بارگذاری…</span>
      </div>
    </div>

    <!-- Mobile: horizontal -->
    <div class="md:hidden pb-6 -mx-4 px-4">
      <div id="portfolio-row" class="flex space-x-4 space-x-reverse w-max overflow-x-auto scroll-container" style="scroll-padding: 0 1rem;"></div>
    </div>

    <!-- Desktop: grid -->
    <div id="portfolio-grid" class="hidden md:grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
  </div>

  <!-- Card Template -->
  <template id="tpl-portfolio-card">
    <div class="portfolio-card bg-white rounded-2xl overflow-hidden shadow-lg transition-all duration-300 hover:shadow-xl hover:-translate-y-1 flex flex-col flex-shrink-0 w-72 md:w-auto">
      <div class="relative portfolio-img-container h-56">
        <img class="portfolio-img w-full h-full object-cover" alt="">
      </div>
      <div class="portfolio-content p-5 flex flex-col flex-1">
        <h3 class="portfolio-name font-bold text-lg mb-2 truncate"></h3>
        <p class="portfolio-description text-gray-600 text-sm mb-4 line-clamp-2"></p>
        <div class="portfolio-stats flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3 space-x-reverse text-gray-500">
            <div class="flex items-center"><i class="far fa-eye ml-1"></i><span class="text-sm js-views">0</span></div>
            <div class="flex items-center"><i class="far fa-heart ml-1"></i><span class="text-sm js-likes">0</span></div>
          </div>
        </div>
        <button class="portfolio-btn w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg transition-all duration-300 hover:from-blue-600 hover:to-blue-700 hover:shadow-md js-open">
          مشاهده دقیق‌تر
        </button>
      </div>
    </div>
  </template>
</section>

<!-- Fullscreen Image Modal (responsive) -->
<div id="imageModal" class="fixed inset-0 bg-black/90 z-50 hidden p-4 overflow-y-auto flex items-center justify-center">
  <div class="relative w-full max-w-full sm:max-w-5xl max-h-[90vh] flex flex-col transform transition-all duration-200 scale-95 opacity-0">
    <div class="bg-white rounded-2xl overflow-hidden shadow-2xl flex-grow flex flex-col">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
        <button id="imageModalClose" type="button" class="flex items-center gap-1 text-gray-500 hover:text-gray-700 text-sm">
          <i class="fas fa-times"></i>
          <span>بستن</span>
        </button>
      </div>
      <div class="flex-grow flex items-center justify-center p-2 bg-gray-100">
        <img id="modalImage" src="" alt="" class="max-w-full max-h-[60vh] object-contain rounded-lg">
      </div>
      <div class="p-4 border-t flex justify-between items-center">
        <div class="flex items-center space-x-4 space-x-reverse text-gray-600">
          <div class="flex items-center"><i class="far fa-eye ml-1"></i><span id="modalViews" class="text-sm">0</span></div>
          <div class="flex items-center"><i class="far fa-heart ml-1"></i><span id="modalLikes" class="text-sm">0</span></div>
        </div>
      </div>
    </div>
  </div>
</div>
    <!-- Booking Wizard -->
<section id="booking-wizard" class="hidden py-8 px-4" dir="rtl">
<style>
  /* هایلایت انتخاب‌ها + OTP */
  .bw-selected{ border-color:#3b82f6 !important; background:#eff6ff; }
  .bw-otp{ width:48px;height:56px;text-align:center;font-size:20px;border:1px solid #d1d5db;border-radius:12px;outline:0; }
  .bw-otp:focus{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.25); }

  /* شماره‌ها همیشه LTR نمایش داده شوند */
  .ltr-num{ direction:ltr; unicode-bidi:isolate; }

  /* نمایش اعداد با فونت فارسی */
  .fa-num{
    font-family: 'Vazirmatn', sans-serif;
    font-feature-settings: 'ss02', 'tnum';
  }

  /* نمایش اعداد با فونت لاتین */
  .en-num{
    font-family: 'Vazirmatn', sans-serif;
    font-feature-settings: 'tnum';
  }

  .bw-phone{
    direction:ltr;
    text-align:left;
    unicode-bidi: embed;
  }

  /* بهبود لمس روی موبایل */
  @media (hover:none){ .bw-tap{ padding-top:.65rem; padding-bottom:.65rem; } }

  /* --- Slots: زیباسازی و حالت‌ها --- */
  .slot{
    position:relative; display:flex; align-items:center; justify-content:center;
    height:44px; border:1px solid #d1d5db; border-radius:12px; font-weight:800;
    background:#fff; transition:.18s ease; user-select:none;
  }
  .slot:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(59,130,246,.07); }
  .slot:active{ transform:scale(.98); }
  .slot--free{ cursor:pointer; }
  .slot--picked, .time-option.bw-selected{ border-color:#3b82f6 !important; background:#eff6ff; }
  .slot--booked, .slot--past{ cursor:not-allowed; color:#9ca3af; background:#f8fafc; }
  .slot--booked{ border-color:#fecaca; background:#fff1f2; color:#ef4444; }
  .slot--past{  border-color:#e5e7eb; background:#f9fafb; }
  .slot[disabled]{ pointer-events:none; }

  .slot-badge{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:11px; font-weight:900; opacity:.92;
  }
  .slot-badge i{ margin-left:.35rem; }
  /* Skeleton بارگذاری ساعت‌ها */
  .skeleton-slot{
    height:44px; border-radius:12px; background:#eef2f7; animation:vtSlotPulse 1.1s ease-in-out infinite;
  }
  @keyframes vtSlotPulse { 0%,100{opacity:.65} 50%{opacity:1} }
</style>


  <div class="bg-white rounded-xl shadow-md p-6">
    <h3 class="text-xl font-bold mb-6">نوبت‌گیری</h3>

    <!-- مراحل و نوار پیشرفت: 5 مرحله -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm text-gray-600">مرحله <span id="current-step">۱</span> از ۵</span>
        <div class="flex space-x-1 space-x-reverse">
          <div class="step-dot w-3 h-3 rounded-full bg-blue-600" data-step="1"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="2"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="3"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="4"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="5"></div>
        </div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width:20%"></div>
      </div>
    </div>

    <!-- Step 1: انتخاب خدمت -->
    <div id="step-1" class="step">
      <h4 class="font-bold mb-4">انتخاب خدمت</h4>
      <div class="space-y-3">
        <div id="booking-services" class="space-y-3"></div>
      </div>
      <button id="next-to-step-2" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full w-full transition-all disabled:bg-gray-400" disabled>
        ادامه
      </button>
    </div>

    <!-- Step 2: انتخاب روز و ساعت -->
    <div id="step-2" class="step hidden">
      <h4 class="font-bold mb-4">انتخاب روز و ساعت</h4>

      <div class="mb-6">
        <h5 class="font-medium mb-2">روز</h5>
        <div id="booking-days" class="grid grid-cols-3 gap-2"></div>
      </div>

      <div class="mb-6">
        <h5 class="font-medium mb-2">ساعت</h5>

        <div id="booking-times" class="grid grid-cols-3 gap-2"></div>
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-1" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">بازگشت</button>
        <button id="next-to-step-3" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>ادامه</button>
      </div>
    </div>

    <!-- Step 3: اطلاعات تماس -->
    <div id="step-3" class="step hidden">
      <h4 class="font-bold mb-4">اطلاعات تماس</h4>

      <!-- موبایل: راست‌چین برای کاربران فارسی -->
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2" for="phone-number">شماره موبایل</label>
          <div class="flex items-center w-full border border-gray-300 rounded-lg overflow-hidden">
            <input
              type="tel"
              id="phone-number"
              inputmode="numeric"
              autocomplete="tel"
              class="bw-phone fa-num flex-1 py-3 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="۰۹۱۲۳۴۵۶۷۸۹"
              maxlength="11"
              pattern="^۰[۰-۹]{10}$"
              dir="ltr"
              lang="fa">
            <span class="px-3 text-gray-500 text-sm en-num ltr-num select-none bg-gray-50 border-r border-gray-300">+98</span>
          </div>
        <p id="phone-error" class="text-red-500 text-xs mt-1 hidden">شماره وارد شده معتبر نیست</p>
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium mb-2" for="customer-name">نام و نام خانوادگی</label>
        <input type="text" id="customer-name" class="w-full border border-gray-300 rounded-lg py-3 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="نام و نام خانوادگی">
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-2" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">بازگشت</button>
        <button id="next-to-step-4" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>ادامه</button>
      </div>
    </div>

    <!-- Step 4: تایید شماره (OTP) -->
    <div id="step-4" class="step hidden">
      <h4 class="font-bold mb-3">تایید شماره موبایل</h4>
      <p class="text-sm text-gray-600 mb-4">
        یک کد ۴ رقمی به شماره
        <span id="otp-phone" class="font-bold text-gray-800 ltr-num"></span>
        ارسال شد.
      </p>

      <button id="edit-phone" class="mb-4 text-blue-600 font-bold text-sm hover:text-blue-700">ویرایش شماره</button>

 <div class="flex items-center justify-center gap-2 mb-2" dir="ltr">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
</div>
      <p id="otp-error" class="text-xs text-red-500 text-center mb-2 hidden">کد تایید صحیح نیست</p>

      <div class="flex items-center justify-between mb-6">
        <div class="text-xs text-gray-500">ارسال مجدد در <span id="otp-timer" class="font-bold">۶۰</span> ثانیه</div>
        <button id="resend-otp" class="text-xs font-bold text-blue-600 disabled:text-gray-400" disabled>ارسال مجدد کد</button>
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-3-otp" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">بازگشت</button>
        <button id="verify-otp" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>تایید کد</button>
      </div>
    </div>

    <!-- Step 5: تایید نهایی -->
    <div id="step-5" class="step hidden">
      <h4 class="font-bold mb-4">تایید نوبت</h4>
      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-right items-baseline">
          <div class="text-gray-600 py-1">خدمت:</div><div id="confirm-service" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">تاریخ:</div><div id="confirm-date" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">ساعت:</div><div id="confirm-time" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">نام:</div><div id="confirm-name" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">شماره تماس:</div><div id="confirm-phone" class="font-bold text-right py-1 ltr-num"></div>
          <div class="text-gray-600 mt-4 pt-4 border-t border-gray-200 py-1">مبلغ کل:</div>
          <div id="confirm-price" class="font-bold text-lg text-right mt-4 pt-4 border-t border-gray-200 py-1"></div>
        </div>
      </div>
      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-3" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">بازگشت</button>
<button id="confirm-booking" data-no-loader class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>تایید نهایی</button>   


</div>
    </div>

    <!-- Success -->
    <div id="booking-success" class="hidden text-center py-8">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-check text-green-600 text-2xl"></i>
      </div>
      <h4 class="text-xl font-bold mb-2">نوبت شما با موفقیت ثبت شد</h4>
      <p class="text-gray-600 mb-6">کد پیگیری شما: <span class="font-bold">#۱۲۳۴۵</span></p>
      <p class="text-gray-600 mb-6">جزئیات نوبت به شماره موبایل شما ارسال خواهد شد.</p>
      <button id="close-booking" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all">بستن</button>
    </div>
  </div>

<script>
(() => {
  'use strict';

  // ===== Helpers
  const API_ROOT = window.__API_BASE__ || '';
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const toEn = s => (s||'')
    .replace(/[۰-۹]/g, d => '0123456789'['۰۱۲۳۴۵۶۷۸۹'.indexOf(d)])
    .replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
  const toFa = s => (s||'').replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[parseInt(d,10)]);
  const normalizeTime = t => {
    const [h='00', m='00'] = toEn(String(t||'')).split(':');
    return `${h.padStart(2,'0')}:${m.padStart(2,'0')}`;
  };
  const scrollInto = el => { if(!el) return; const top = el.getBoundingClientRect().top + scrollY - 80; window.scrollTo({top,behavior:'smooth'}); };
  const genId = () => 'c_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
  const getCookie = name => document.cookie.split('; ').find(r => r.startsWith(name + '='))?.split('=')[1] || '';
  const setCookie = (name, value) => { document.cookie = name + '=' + encodeURIComponent(value) + ';path=/'; };
  const TOKEN_KEYS = ['access_token', 'auth_token', 'jwt_token'];
  const clearToken = () => {
    TOKEN_KEYS.forEach(k => localStorage.removeItem(k));
    document.cookie = 'auth_token=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT';
  };
  function getToken() {
    let t = null;
    for (const k of TOKEN_KEYS) {
      const val = localStorage.getItem(k);
      if (val) { t = val; break; }
    }
    if (!t) t = getCookie('auth_token');
    if (!t) return null;
    try {
      const payload = JSON.parse(atob(t.split('.')[1] || ''));
      if (payload.exp * 1000 < Date.now()) {
        clearToken();
        return null;
      }
    } catch (_) {
      clearToken();
      return null;
    }
    return t;
  }

  let bookedTimes = new Set();
  async function fetchBookedSlots(dateISO){
    const sid = document.body?.dataset?.sellerId;
    if (!sid || !dateISO) return new Set();
    try {
      const res = await fetch(`${API_ROOT}/api/booked-slots/${encodeURIComponent(sid)}?date=${encodeURIComponent(dateISO)}`);
      if(!res.ok) throw new Error('fail');
      const data = await res.json();
      const times = (data.times || []).map(normalizeTime);
      return new Set(times);
    }catch(err){
      console.error('fetch booked slots failed', err);
      return new Set();
    }
  }

  // کد مادر برای محیط توسعه
  const MASTER_OTP = '0000';

  // ===== Persistent selection (FIX: name & phone هم ذخیره شوند)
  const SS_KEY = 'vt:booking.sel';
  function saveSel() {
    const payload = {
      service:   st.service || null,
      serviceId: st.serviceId || null,
      price:     Number.isFinite(st.price) ? st.price : (parseInt(st.price||'0',10)||0),
      date:      st.date || null,
      time:      st.time || null,
      // NEW
      name:  (st.name || nameInp?.value || '').trim(),
      phone: toEn(st.phone || phoneInp?.value || '')
    };
    try { sessionStorage.setItem(SS_KEY, JSON.stringify(payload)); } catch(e){}
  }
  function loadSel() {
    try {
      const raw = sessionStorage.getItem(SS_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (obj.service)   st.service = obj.service;
      if (obj.serviceId) st.serviceId = obj.serviceId;
      if (obj.price != null) st.price = parseInt(obj.price,10) || 0;
      if (obj.date)      st.date = obj.date;
      if (obj.time)      st.time = obj.time;
      // NEW: rehydrate name/phone و داخل input هم بریز
      if (obj.name)  { st.name = obj.name;   if (nameInp)  nameInp.value  = obj.name; }
      if (obj.phone) { st.phone = toEn(obj.phone); if (phoneInp) phoneInp.value = obj.phone; }
    } catch(e){}
  }

  // اگر از روی کارت‌های «رزرو» وارد شدیم، همون لحظه prefill ذخیره بشه
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.service-button');
    if (!btn) return;
    try {
      const pre = {
        service:   btn.dataset.service || btn.closest('.service-card')?.querySelector('h4')?.textContent?.trim() || '',
        price:     parseInt(btn.dataset.price||'0',10)||0,
        serviceId: btn.dataset.serviceId || btn.dataset.id || null
      };
      sessionStorage.setItem(SS_KEY, JSON.stringify({ ...JSON.parse(sessionStorage.getItem(SS_KEY)||'{}'), ...pre }));
    } catch(_) {}
  });

  // ===== State
  const st = {
    step:1, customerId:null,
    service:null, serviceId:null, price:0, duration:60,
    date:null, time:null,
    name:'', phone:'', otp:'', otpTimer:0, otpInt:null, otpTo:''
  };

  // ===== Elements
  const wizard = $('#booking-wizard');
  const steps = {1:$('#step-1'),2:$('#step-2'),3:$('#step-3'),4:$('#step-4'),5:$('#step-5')};
  const dots = $$('.step-dot'); const curLbl = $('#current-step'); const pbar = $('#progress-bar');

  // step1
  const servicesWrap = $('#booking-services'); 
  let   svcOpts = $$('.service-option');
  const next1 = $('#next-to-step-2');

  // step2
  let dateOpts = []; let timeOpts = [];
  let sellerSchedule = {};
  const WEEKDAY_NAMES = { '6':'شنبه','0':'یکشنبه','1':'دوشنبه','2':'سه‌شنبه','3':'چهارشنبه','4':'پنج‌شنبه','5':'جمعه' };

  async function loadSellerSchedule(){
    const sid = document.body?.dataset?.sellerId;
    if(!sid) return;
    try{
      const res = await fetch(`${API_ROOT}/api/booking-slots/${encodeURIComponent(sid)}`);
      if(!res.ok) throw new Error('fail');
      sellerSchedule = await res.json() || {};
      renderSchedule();
    }catch(err){ console.error('load seller schedule failed', err); }
  }

  function renderSchedule(){
    const daysWrap = document.getElementById('booking-days');
    const timesWrap = document.getElementById('booking-times');
    if(!daysWrap || !timesWrap) return;
    daysWrap.innerHTML='';
    timesWrap.innerHTML='';
    const order=['6','0','1','2','3','4','5'];
    order.forEach(k=>{
      const times=sellerSchedule[k];
      if(!Array.isArray(times) || !times.length) return;
      const d=document.createElement('div');
      d.className='date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap';
      d.textContent=WEEKDAY_NAMES[k];
      d.dataset.day=k;
      daysWrap.appendChild(d);
    });
    dateOpts=$$('.date-option');
    dateOpts.forEach(el=>el.addEventListener('click', ()=>{ pick(dateOpts, el); st.date=el.innerText.trim(); st.time=''; renderTimes(el.dataset.day); saveSel(); chk2(); }));
    if(dateOpts[0]) dateOpts[0].click();
  }

async function renderTimes(dayIdx){
  const timesWrap = document.getElementById('booking-times');
  if (!timesWrap) return;
  
  timesWrap.innerHTML = '';
  const times = (sellerSchedule[String(dayIdx)] || []).map(normalizeTime);
  const dayName = WEEKDAY_NAMES[String(dayIdx)];
  const start = nextDateFor(dayName, '00:00');
  const dateStr = formatLocalDate(start);
  
  // Show loading state
  timesWrap.innerHTML = '<div class="col-span-3 text-center py-4 text-gray-500">در حال بررسی ساعات موجود...</div>';
  
  try {
    bookedTimes = await fetchBookedSlots(dateStr);
  } catch (error) {
    console.error('Error fetching booked slots:', error);
    bookedTimes = new Set();
  }
  
  // Clear loading
  timesWrap.innerHTML = '';
  
  if (times.length === 0) {
    const noTimesDiv = document.createElement('div');
    noTimesDiv.className = 'col-span-3 text-center py-8 text-gray-500';
    noTimesDiv.innerHTML = `
      <i class="fas fa-calendar-times text-3xl mb-2 text-gray-400"></i>
      <p>برای این روز ساعت کاری تعریف نشده است</p>
    `;
    timesWrap.appendChild(noTimesDiv);
    return;
  }
  
  times.forEach(time => {
    const norm = normalizeTime(time);
    const button = document.createElement('button');
    const isBooked = bookedTimes.has(norm);
    const timeDisplay = toFa(norm);
    
    button.type = 'button';
    button.className = 'time-slot';
    button.textContent = timeDisplay;
    button.disabled = isBooked;

    if (isBooked) {
      button.classList.add('slot--booked');
      button.setAttribute('title', 'این ساعت رزرو شده است');
    } else {
      button.setAttribute('title', 'کلیک کنید تا این ساعت را انتخاب کنید');
      button.addEventListener('click', () => {
        // Remove previous selections
        timeOpts.forEach(opt => opt.classList.remove('selected'));
        
        // Select current time
        button.classList.add('selected');
        
        st.time = timeDisplay;
        saveSel();
        chk2();
      });
    }
    
    timesWrap.appendChild(button);
  });
  
  // Update timeOpts array for other functions
  timeOpts = Array.from(timesWrap.querySelectorAll('.time-slot:not(:disabled)'));

  // Reset previously selected time if it is no longer available
  if (!timeOpts.some(opt => opt.textContent.trim() === st.time)) {
    st.time = '';
  }

  // Ensure next button is disabled until a valid time is chosen
  chk2();
}





  document.addEventListener('services:loaded', loadSellerSchedule);
  const back2 = $('#back-to-step-1'); const next2 = $('#next-to-step-3');

  // step3
  const nameInp = $('#customer-name'); const phoneInp = $('#phone-number');
  const phoneErr = $('#phone-error'); const back3 = $('#back-to-step-2'); const next3 = $('#next-to-step-4');

  // step4 (otp)
  const otpPhone = $('#otp-phone'); const otpInputs = () => $$('.bw-otp');
  const otpErr = $('#otp-error'); const otpTimerLbl = $('#otp-timer'); const resendBtn = $('#resend-otp');
  const editPhone = $('#edit-phone'); const back4 = $('#back-to-step-3-otp'); const verifyBtn = $('#verify-otp');

  // step5
  const back5 = $('#back-to-step-3'); const confirmBtn = $('#confirm-booking');
  const cSvc = $('#confirm-service'), cDate = $('#confirm-date'), cTime = $('#confirm-time'), cName = $('#confirm-name'), cPhone = $('#confirm-phone'), cPrice = $('#confirm-price');

  // success
  const successBox = $('#booking-success'); const closeSuccess = $('#close-booking');

  // ===== Validations & Button state
  const validPhone = raw => {
    const v = toEn(raw).trim();
    return /^0\d{10}$/.test(v) && v.startsWith('09');
  };

  function rebuildFromDOMIfMissing() {
    if (!st.service) {
      const sel = document.querySelector('#booking-services .service-option.bw-selected');
      if (sel) {
        st.service   = sel.dataset.service || sel.textContent.trim();
        st.price     = parseInt(sel.dataset.price || '0', 10) || st.price || 0;
        st.serviceId = sel.dataset.serviceId || st.serviceId || null;
      }
    }
    if (!st.date) {
      const dSel = document.querySelector('.date-option.bw-selected');
      if (dSel) st.date = dSel.innerText.trim();
    }
    if (!st.time) {
      const tSel = document.querySelector('.time-option.bw-selected');
      if (tSel) st.time = tSel.innerText.trim();
    }
  }


// چک‌لیست خطاها برای مرحله ۵
function getStep5Errors() {
  const errs = [];
  const svcSel  = document.querySelector('#booking-services .service-option.bw-selected');
  const dateSel = document.querySelector('.date-option.bw-selected');
  const timeSel = document.querySelector('.time-option.bw-selected');
  const nm = (nameInp?.value || '').trim();
  const ph = toEn(phoneInp?.value || '');

  if (!svcSel)  errs.push('خدمت را انتخاب کنید.');
  if (!dateSel) errs.push('روز را انتخاب کنید.');
  if (!timeSel) errs.push('ساعت را انتخاب کنید.');
  if (nm.length < 2) errs.push('نام را کامل بنویسید.');
  if (!/^0\d{10}$/.test(ph)) errs.push('شماره موبایل نامعتبر است (مثال: 09123456789).');

  return errs;
}






// نسخه تقویت‌شده: فعال/غیرفعال + نمایش دلیل
function updateConfirmState(reason = '') {
  // از DOM بخوانیم تا چیزی از state جا نماند
  const svcSel  = document.querySelector('#booking-services .service-option.bw-selected');
  const dateSel = document.querySelector('.date-option.bw-selected');
  const timeSel = document.querySelector('.time-option.bw-selected');

  if (svcSel) {
    st.service   = svcSel.dataset.service || svcSel.textContent.trim();
    st.price     = parseInt(svcSel.dataset.price || '0', 10) || 0;
    st.serviceId = svcSel.dataset.serviceId || null;
  }
  if (dateSel) st.date = dateSel.innerText.trim();
  if (timeSel) st.time = timeSel.innerText.trim();
  if (nameInp)  st.name  = (nameInp.value || '').trim();
  if (phoneInp) st.phone = toEn(phoneInp.value || '');

  const errs = getStep5Errors();
  const box  = document.getElementById('confirm-errors');

  if (!confirmBtn) return;

  if (errs.length) {
    // غیرفعال + نشان‌دادن دلیل‌ها
    confirmBtn.disabled = true;
    confirmBtn.setAttribute('disabled', 'disabled');
    confirmBtn.setAttribute('aria-disabled', 'true');
    confirmBtn.classList.add('cursor-not-allowed', 'opacity-50');
    confirmBtn.classList.remove('bg-blue-600','hover:bg-blue-700');

    if (box) {
      box.innerHTML = 'نمی‌تونم تایید کنم چون:' +
        '<ul class="list-disc pr-5 mt-2">' +
        errs.map(e => `<li>${e}</li>`).join('') +
        '</ul>';
      box.classList.remove('hidden');
    }
  } else {
    // فعال
    confirmBtn.disabled = false;
    confirmBtn.removeAttribute('disabled');
    confirmBtn.setAttribute('aria-disabled', 'false');
    confirmBtn.classList.remove('cursor-not-allowed', 'opacity-50');
    confirmBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

    if (box) {
      box.classList.add('hidden');
      box.textContent = '';
    }
  }

  // لاگ برای دیباگ سریع
  console.debug('[confirm-state]', reason, {
    service: st.service, date: st.date, time: st.time,
    name: st.name, phone: st.phone, ok: errs.length === 0
  });
}


  // ===== PATCH: نوع دکمه و نگهبان ضد-disabled
  if (confirmBtn) {
    confirmBtn.type = 'button'; // از هر submit-handler عمومی در امان
    const confirmGuard = new MutationObserver(() => {
      const ready = !!(st.service && st.date && st.time && (nameInp?.value||'').trim() && /^0\d{10}$/.test(toEn(phoneInp?.value||'')));
      if (ready && confirmBtn.hasAttribute('disabled')) {
        confirmBtn.disabled = false;
        confirmBtn.removeAttribute('disabled');
        confirmBtn.setAttribute('aria-disabled', 'false');
        confirmBtn.classList.remove('cursor-not-allowed', 'opacity-50');
        confirmBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
      }
    });
    confirmGuard.observe(confirmBtn, { attributes: true, attributeFilter: ['disabled'] });
    // اختیاری: روی unload قطعش نکنیم هم مشکلی نیست
  }

  // ===== Navigation
  function showStep(n){
    st.step = n;
    Object.values(steps).forEach(s => s.classList.add('hidden'));
    steps[n].classList.remove('hidden');
    curLbl.textContent = n.toString();
    pbar.style.width = (n*20) + '%';
    dots.forEach(d => { const k = +d.dataset.step; d.classList.toggle('bg-blue-600', k<=n); d.classList.toggle('bg-gray-300', k>n); });
    scrollInto(wizard);
    if (n === 5) {
      updateConfirmState('enter-step5');
      // PATCH: دوبار فراخوانی برای حذف race با رندر/transition
      requestAnimationFrame(() => updateConfirmState('enter-step5:raf'));
      setTimeout(() => updateConfirmState('enter-step5:timeout'), 0);
    }
  }

  // ===== Validators
  function chk1(){ next1.disabled = !(st.service && st.price); saveSel(); updateConfirmState('chk1'); }
  function chk2(){
    const booked = st.time && bookedTimes.has(normalizeTime(st.time));
    if (booked) st.time = '';
    next2.disabled = !(st.date && st.time);
    saveSel();
    updateConfirmState('chk2');
  }
  function chk3(){
    const ok = nameInp.value.trim().length >= 2 && validPhone(phoneInp.value);
    next3.disabled = !ok;
    phoneErr.classList.toggle('hidden', validPhone(phoneInp.value));
    st.name  = nameInp.value.trim();
    st.phone = toEn(phoneInp.value);
    saveSel();
    updateConfirmState('chk3');
  }
  function chkOTP(){
    const code = toEn(otpInputs().map(i=>i.value).join('')).replace(/\D/g,'');
    verifyBtn.disabled = (code.length!==4);
    if (!verifyBtn.disabled) otpErr.classList.add('hidden');
  }

  // ===== Step 1: build service options from service cards
  function buildServiceOptionsFromCards(){
    if (!servicesWrap) return;
    const sourceButtons = $$('.service-button');
    if (!sourceButtons.length) return;

    servicesWrap.innerHTML = '';
    sourceButtons.forEach((btn, idx) => {
      const title = btn.dataset.service || btn.closest('.service-card')?.querySelector('h4')?.textContent?.trim() || `خدمت ${idx+1}`;
      const price = parseInt(btn.dataset.price || '0', 10) || 0;
      const serviceId = btn.dataset.serviceId || btn.dataset.id || '';

      const opt = document.createElement('div');
      opt.className = 'service-option border border-gray-300 rounded-lg p-3 cursor-pointer hover:border-blue-500 flex items-center justify-between';
      opt.dataset.service = title;
      opt.dataset.price = String(price);
      if (serviceId) opt.dataset.serviceId = serviceId;

      opt.innerHTML = `
        <div class="font-bold text-gray-800">${title}</div>
        <div class="text-sm text-gray-600">${price ? toFa(price.toLocaleString()) + ' تومان' : '—'}</div>
      `;

      opt.addEventListener('click', () => {
        svcOpts.forEach(x => x.classList.remove('bw-selected'));
        opt.classList.add('bw-selected');
        st.service   = title;
        st.price     = price;
        st.serviceId = serviceId || null;
        saveSel();
        chk1();
      });

      servicesWrap.appendChild(opt);
    });

    svcOpts = $$('#booking-services .service-option');

    // اگر از قبل prefill داشتیم، همین‌جا اعمال کنیم
    loadSel();
    if (st.service) {
      const match = Array.from(svcOpts).find(o => (o.dataset.service||'').trim() === st.service);
      if (match) {
        match.classList.add('bw-selected');
        st.price = parseInt(match.dataset.price||'0',10)||st.price||0;
        chk1();
      }
    }
  }

  function wireExistingServiceOptions(){
    if (!svcOpts.length) return;
    svcOpts.forEach(o=>{
      o.addEventListener('click', ()=>{
        svcOpts.forEach(x=>x.classList.remove('bw-selected'));
        o.classList.add('bw-selected');
        st.service   = o.dataset.service || o.textContent.trim();
        st.price     = parseInt(o.dataset.price||'0',10)||0;
        st.serviceId = o.dataset.serviceId || null;
        saveSel();
        chk1();
      });
    });
  }

  // step1 next
  next1?.addEventListener('click', ()=>showStep(2));

  // ===== Step 2
  function pick(list, el){ list.forEach(x=>x.classList.remove('bw-selected')); el.classList.add('bw-selected'); }
  back2.addEventListener('click', ()=>showStep(1));
  next2.addEventListener('click', ()=>showStep(3));

  // ===== Step 3
  function onStep3(){
    st.name  = nameInp.value.trim();
    st.phone = toEn(phoneInp.value);
    saveSel();
    chk3();
  }
  nameInp.addEventListener('input', onStep3);
  phoneInp.addEventListener('input', (e)=>{
    let value = e.target.value;
    value = value.replace(/[^\u06F0-\u06F9\u0660-\u06690-9]/g, '');
    value = value.slice(0, 11);
    e.target.value = value;
    st.phone = toEn(value);
    onStep3();
  });
  back3.addEventListener('click', ()=>showStep(2));
  next3.addEventListener('click', ()=>{
    if (next3.disabled) return;
    st.phone = toEn(phoneInp.value); st.name = nameInp.value.trim();

    // ارسال کد (دمو) — ۴ رقمی
    st.otp   = String(Math.floor(1000 + Math.random()*9000));
    st.otpTo = st.phone;

    // ماسک شماره
    const v = toEn(st.phone).replace(/\D/g,'');
    otpPhone.textContent = (v.length<8) ? v : (v.slice(0,4)+'*****'+v.slice(-4));

    startOtpTimer();
    clearOtp();
    otpErr.classList.add('hidden');
    chkOTP();
    showStep(4);
  });

  // ===== Step 4 (OTP)
  function clearOtp(){ otpInputs().forEach((i,idx)=>{ i.value=''; if(idx===0) i.focus(); }); }
  function startOtpTimer(){
    stopOtpTimer(); st.otpTimer = 60; resendBtn.disabled = true; updateOtpTimer();
    st.otpInt = setInterval(()=>{ st.otpTimer--; updateOtpTimer(); if(st.otpTimer<=0){ stopOtpTimer(); resendBtn.disabled=false; } }, 1000);
  }
  function stopOtpTimer(){ if(st.otpInt){ clearInterval(st.otpInt); st.otpInt=null; } }
  function updateOtpTimer(){ otpTimerLbl.textContent = st.otpTimer.toString(); }

  document.addEventListener('input', (e)=>{
    const t = e.target; if(!(t instanceof HTMLInputElement)) return;
    if(!t.classList.contains('bw-otp')) return;
    t.value = toEn(t.value).replace(/\D/g,'').slice(0,1);
    const arr = otpInputs(); const idx = arr.indexOf(t);
    if(t.value && idx < arr.length-1){ arr[idx+1].focus(); }
    chkOTP();
  });
  document.addEventListener('keydown', (e)=>{
    const t = e.target; if(!(t instanceof HTMLInputElement)) return;
    if(!t.classList.contains('bw-otp')) return;
    if(e.key==='Backspace' && !t.value){
      const arr = otpInputs(); const idx = arr.indexOf(t);
      if(idx>0) arr[idx-1].focus();
    }
  });

  const resendOtp = ()=>{ st.otp = String(Math.floor(1000 + Math.random()*9000)); startOtpTimer(); };
  resendBtn.addEventListener('click', ()=>{ if(!resendBtn.disabled) resendOtp(); });

  // ذخیره مشتری
function persistCustomer(){
    const existing = getCookie('customerId');
    const cid = st.customerId || existing || genId();
    st.customerId = cid;
    setCookie('customerId', cid);
    setCookie('customerName', st.name);
    setCookie('customerPhone', st.phone);
    
    // Also save to localStorage for better persistence
    if (st.name) localStorage.setItem('vt_user_name', st.name);
    if (st.phone) localStorage.setItem('vt_user_phone', st.phone);
  }

  // تایید OTP
  verifyBtn.addEventListener('click', async ()=>{
    const code = toEn(otpInputs().map(i=>i.value.trim()).join('')).replace(/\D/g,'');
    if (code.length !== 4) { otpErr.classList.remove('hidden'); return; }
    if (code !== st.otp && code !== MASTER_OTP) { otpErr.classList.remove('hidden'); return; }
    stopOtpTimer();

    verifyBtn.disabled = true;
    const originalHTML = verifyBtn.innerHTML;
    verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>در حال تایید...';

    try {
      const profilePayload = { name: st.name, phone: st.phone, customerId: st.customerId };
      const response = await fetch(`${API_ROOT}/api/user/profile`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(getToken() ? {'Authorization': 'Bearer ' + getToken()} : {})
        },
        credentials: 'include',
        body: JSON.stringify(profilePayload)
      });
      if (!response.ok) throw new Error('Profile save failed');

      persistCustomer();
    } catch (error) {
      console.error('Profile save failed:', error);
      if (typeof showToastDark === 'function') showToastDark('خطا در ثبت اطلاعات کاربری', {type: 'error'});
      persistCustomer(); // ادامه محلی
    } finally {
      // رفتن به مرحله تایید
      fillConfirm();
      saveSel(); // اطمینان از ذخیره name/phone قبل از Step 5
      showStep(5);
      requestAnimationFrame(() => updateConfirmState('after-otp'));
      verifyBtn.disabled = false;
      verifyBtn.innerHTML = originalHTML;
    }
  });

  editPhone.addEventListener('click', ()=>showStep(3));
  back4.addEventListener('click',  ()=>showStep(3));

  // ===== Step 5 (Confirm)
  function fillConfirm(){
    loadSel();
    rebuildFromDOMIfMissing();
    // تضمین اینکه name/phone گم نشه
    st.name  = st.name  || nameInp?.value.trim() || '';
    st.phone = st.phone || toEn(phoneInp?.value || '') || '';

    cSvc.textContent   = st.service || '';
    cDate.textContent  = st.date   || '';
    cTime.textContent  = st.time   || '';
    cName.textContent  = st.name   || '';
    cPhone.textContent = st.phone  || '';
    cPrice.textContent = (st.price? st.price.toLocaleString('fa-IR'):'۰') + ' تومان';

    saveSel();
    updateConfirmState('fillConfirm');
  }

  back5.addEventListener('click', ()=>showStep(3));

// --- Final submit: send booking to backend & then show pending modal ---
(function hookConfirmToServerBooking(){
  const btn = document.getElementById('confirm-booking');
  if (!btn) return;

  // در صورت نیاز، مسیر API خودت رو اینجا تنظیم کن
  const BOOKING_ENDPOINT = (window.__API_BASE__ || '') + '/api/bookings';

  btn.type = 'button'; // جلوگیری از submit فرم‌های عمومی

  btn.addEventListener('click', async (e) => {
    // جلوِ هر لیسنر قدیمی را بگیر
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    if (btn.disabled) return;

    // بازسازی/برداشت مقادیر نهایی از DOM
    const name  = (document.getElementById('customer-name')?.value || (st.name||'')).trim();
    const phone = toEn(document.getElementById('phone-number')?.value || (st.phone||''));

    // خدمت/روز/ساعت از DOM اگر توی st نباشه
    const svcSel  = document.querySelector('#booking-services .service-option.bw-selected');
    if (svcSel) {
      st.service   = svcSel.dataset.service || svcSel.textContent.trim();
      st.price     = parseInt(svcSel.dataset.price || '0', 10) || 0;
      st.serviceId = svcSel.dataset.serviceId || null;
    }
    const dateSel = document.querySelector('.date-option.bw-selected');
    if (dateSel) st.date = dateSel.innerText.trim();
    const timeSel = document.querySelector('.time-option.bw-selected');
    if (timeSel) st.time = timeSel.innerText.trim();

    // اعتبارسنجی اولیه (همون‌هایی که بک‌اند می‌خواد)
    if (!st.service || !st.date || !st.time || !name || !/^0\d{10}$/.test(phone)) {
      const msg = 'اطلاعات نوبت ناقص است.';
      (typeof showToastDark==='function') ? showToastDark(msg, {type:'error'}) : alert(msg);
      console.error('submit booking failed', new Error(msg), {st, name, phone});
      return;
    }

    // نرمال‌سازی تاریخ/ساعت به فرمت مورد انتظار بک‌اند
    const { startISO } = composeSlotISO(st.date, st.time, st.duration || 60);
    const date = startISO.slice(0,10);   // YYYY-MM-DD
    const time = startISO.slice(11,16);  // HH:mm

    const sellerId = document.body?.dataset?.sellerId || null;

    // re-check availability just before submit to avoid stale selections
    try {
      const latest = await fetchBookedSlots(date);
      if (latest.has(normalizeTime(time))) {
        const warn = 'این بازه زمانی قبلاً رزرو شده است. لطفاً زمان دیگری را انتخاب کنید.';
        (typeof showToastDark==='function') ? showToastDark(warn, {type:'error'}) : alert(warn);
        st.time = '';
        const dayIdx = WEEKDAY_MAP[st.date.split(/\s+/)[0]];
        if (typeof dayIdx === 'number') await renderTimes(dayIdx);
        showStep(2);
        chk2();
        return;
      }
    } catch (err) {
      console.error('revalidate slot failed', err);
    }

    // ساخت payload طبق قرارداد بک‌اند: یا serviceId یا (sellerId + service)
    const payload = {
      customerName:  name,
      customerPhone: phone,
      date,
      time,
      ...(st.serviceId ? { serviceId: st.serviceId } : { sellerId, service: st.service })
    };

    // دکمه در حال پردازش
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>در حال ثبت...';

    try {
      const res = await fetch(BOOKING_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          ...(getToken() ? {'Authorization':'Bearer ' + getToken()} : {})
        },
        credentials: 'include',
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        let serverMsg = 'خطا در ثبت نوبت';
        try {
          const data = await res.json();
          serverMsg = data?.message || data?.error || serverMsg;
        } catch(_) {}
        throw new Error(serverMsg);
      }

      const data = await res.json(); // انتظار: id/bookingId/status ...

      // ذخیره «pending» محلی (برای بلاک رزرو بعدی و همگام‌سازی)
      const last = {
        id:        genId(),
        bookingId: data.id || data._id || data.bookingId || null,
        service:   st.service,
        date:      st.date,  // برای نمایش
        time:      st.time,  // برای نمایش
        phone,
        status:    data.status || 'pending',
        createdAt: Date.now(),
        sellerId,
        shopUrl:   document.body?.dataset?.shopurl || null
      };
      try { localStorage.setItem('vt:lastBooking', JSON.stringify(last)); } catch(_){}

      // پر کردن و نمایش مودال «ثبت شد / در انتظار تأیید»
      const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val || '—'; };
      setText('pb-service', st.service);
      setText('pb-date',    st.date);
      setText('pb-time',    st.time);
      setText('pb-phone',   phone);

      if (typeof window.openModalById === 'function') {
        window.openModalById('pendingBookingModal');
      } else if (typeof showToastDark === 'function') {
        showToastDark('درخواست ثبت شد و در انتظار تأیید فروشنده است.', { type: 'success' });
      } else {
        alert('درخواست ثبت شد و در انتظار تأیید فروشنده است.');
      }

      // ریست ویزارد
      resetWizardState();

    } catch (err) {
      const msg = err?.message || 'ثبت نوبت ناموفق بود';
      (typeof showToastDark==='function') ? showToastDark(msg, {type:'error'}) : alert(msg);
      console.error('submit booking failed', err, {payload});
      if (msg.includes('بازه زمانی قبلاً رزرو شده') && st.date) {
        st.time = '';
        const dayIdx = WEEKDAY_MAP[st.date.split(/\s+/)[0]];
        if (typeof dayIdx === 'number') await renderTimes(dayIdx);
        showStep(2);
        chk2();
      }
    } finally {
      btn.innerHTML = originalHTML;
      btn.disabled = false;
    }
  }, true); // capture=true تا هر لیسنر قدیمی قبلش خنثی بشه
})();
// --- /Final submit ---

  // --- /built-in success popup ---

  // Helper: reset
  function resetWizardState() {
    ['service','date','time'].forEach(k => st[k] = null);
    try { sessionStorage.removeItem(SS_KEY); } catch(e){}
    svcOpts.forEach(x => x.classList.remove('bw-selected'));
    dateOpts.forEach(x => x.classList.remove('bw-selected'));
    timeOpts.forEach(x => x.classList.remove('bw-selected'));
    if (next1) next1.disabled = true;
    if (next2) next2.disabled = true;
    confirmBtn.disabled = true;
    confirmBtn.setAttribute('disabled','disabled');
    showStep(1);
  }

  // ===== Compose slot
  const WEEKDAY_MAP = {
    'یکشنبه':0,'دوشنبه':1,'سه‌شنبه':2,'سه شنبه':2,'چهارشنبه':3,'پنج‌شنبه':4,'پنجشنبه':4,'جمعه':5,'شنبه':6
  };
  function nextDateFor(dayName, hhmm){
    const targetDow = WEEKDAY_MAP[(dayName||'').trim()];
    const now = new Date(); let d = new Date(); let add = 0;
    if (typeof targetDow === 'number'){
      const diff = (targetDow - now.getDay() + 7) % 7;
      add = diff;
    }
    d.setDate(now.getDate() + add);
    const parts = toEn(hhmm||'12:00').split(':');
    const h = parseInt(parts[0]||'12',10), m = parseInt(parts[1]||'0',10);
    d.setHours(h||0, m||0, 0, 0);
    if (add===0 && d.getTime() <= now.getTime()) d.setDate(d.getDate()+7);
    return d;
  }
  function formatLocalDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function composeSlotISO(dateText, timeText, durationMin=60){
    const dayName = (dateText||'').trim().split(/\s+/)[0];
    let start = nextDateFor(dayName, timeText||'12:00');
    if (!(start instanceof Date) || isNaN(+start)) start = new Date(Date.now() + 60*60*1000);
    const end = new Date(start.getTime() + durationMin*60*1000);
    return { startISO: start.toISOString(), endISO: end.toISOString() };
  }

  // ===== Submit booking (legacy handler removed; handled by modern wizard)

  closeSuccess.addEventListener('click', ()=>{
    successBox.classList.add('hidden');
    showStep(1);
  });

  // ===== Init from cookies
// ===== Init from localStorage first, then cookies as fallback
  const saved = {
    cid: getCookie('customerId'),
    name: localStorage.getItem('vt_user_name') || decodeURIComponent(getCookie('customerName') || ''),
    phone: localStorage.getItem('vt_user_phone') || getCookie('customerPhone')
  };
if (saved.cid)  st.customerId = saved.cid;
  if (saved.name) {
    nameInp.value = saved.name;
    st.name = saved.name;
  }
  if (saved.phone) {
    phoneInp.value = saved.phone;
    st.phone = saved.phone;
  }
  // Build & wire
  buildServiceOptionsFromCards();
  wireExistingServiceOptions();

  // Initial validation
  (function initButtons(){
    next1.disabled = true; next2.disabled = true; next3.disabled = true; confirmBtn.disabled = true;
    confirmBtn.setAttribute('disabled','disabled');
    if (confirmBtn) confirmBtn.type = 'button';
  })();

  // اگر prefill در session هست، از همون شروع کن
  loadSel();
  if (st.service) {
    const match = document.querySelector(`#booking-services .service-option[data-service="${CSS.escape(st.service)}"]`);
    if (match) { match.classList.add('bw-selected'); next1.disabled = false; }
  }
  if (st.date) {
    const dMatch = Array.from(dateOpts).find(d => d.innerText.trim() === st.date);
    if (dMatch) dMatch.classList.add('bw-selected');
  }
  if (st.time) {
    const tMatch = Array.from(timeOpts).find(t => t.innerText.trim() === st.time);
    if (tMatch) tMatch.classList.add('bw-selected');
  }

  // نام/شماره از کوکی‌ها یا session
  st.name  = (nameInp.value||'').trim();
  st.phone = toEn(phoneInp.value||'');
  updateConfirmState('init');
  showStep(1);

  // ابزار تست
  window.forceEnableConfirm = function() {
    const btn = document.getElementById('confirm-booking');
    if (btn) {
      btn.disabled = false;
      btn.removeAttribute('disabled');
      console.log('دکمه تایید نهایی به صورت دستی فعال شد');
    }
  };

  // Update date options to future dates (دمویی)
  const dateOptions = $$('.date-option');
  const persianDates = ['22 شهریور', '23 شهریور', '24 شهریور', '25 شهریور', '26 شهریور', '27 شهریور'];
  dateOptions.forEach((opt, i) => {
    const boldDiv = opt.querySelector('.font-bold');
    if (boldDiv) { boldDiv.textContent = persianDates[i]; }
  });
})();
</script>







</section>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
const btns = document.querySelectorAll(
  'button[type="submit"]:not([data-no-loader]), .service-button'
);


    btns.forEach(btn => {
      btn.addEventListener('click', function () {
        if (this.disabled || this.classList.contains('loading')) return;

        const original = this.innerHTML;

        // Allow the submit event to fire first
        setTimeout(() => {
          this.classList.add('loading');
          this.disabled = true;
          this.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>در حال پردازش...';
        }, 0);

        // Safety revert after 2s (UI-only fallback)
        setTimeout(() => {
          this.classList.remove('loading');
          this.disabled = false;
          this.innerHTML = original;
        }, 2000);
      });
    });
  });
  </script>




    <!-- Customer Reviews -->


<!-- Loyalty Rewards Card Component -->

<section id="loyalty-disabled" class="w-full py-8 px-4 sm:px-5 hidden" dir="rtl">
  <div class="mx-auto max-w-[680px] md:max-w-[720px]">
    <div class="rounded-3xl bg-gray-100 border border-gray-200 p-8 text-center">
      <h2 class="text-xl font-bold text-gray-700 mb-2">باشگاه مشتریان غیر فعال است</h2>
      <p class="text-gray-600">این فروشنده بخش جایزه دادن را غیرفعال کرده است.</p>
    </div>
  </div>
</section>

<!-- ============ Loyalty Rewards (Vitreenet) ============ -->
<section id="loyalty-card" class="w-full py-8 px-4 sm:px-5" dir="rtl">
  <!-- پیکربندی -->
<div id="lr-data"
     data-current="0"
     data-target="10"
     data-reward=""
     data-booking-url=""
     data-login-url="/login"
     data-rules=""></div>

  <div class="mx-auto relative max-w-[680px] md:max-w-[720px]">
    <!-- پس‌زمینه گرادیان ساده -->
    <div class="absolute inset-0 -z-10 rounded-3xl bg-gradient-to-r from-purple-500/10 via-pink-500/10 to-blue-500/10 blur-2xl"></div>

    <!-- قاب با گرادیان -->
    <div class="group relative rounded-3xl p-[2px] bg-gradient-to-r from-purple-500 via-pink-500 to-blue-500 transition-shadow duration-300 hover:shadow-xl">
      
      <!-- MEMBER CLUB badge -->
      <div class="absolute -top-3 right-4 z-20 select-none">
        <span class="inline-flex rounded-full p-[1.5px] bg-gradient-to-r from-purple-500 to-pink-500 shadow-md">
          <span dir="ltr"
                class="relative inline-flex items-center rounded-full
                       px-4 py-1.5 text-[10px] sm:text-[11px]
                       font-extrabold uppercase tracking-[0.18em]
                       text-white bg-gradient-to-r from-purple-600 to-pink-600">
            <span class="relative z-10">VIP MEMBER</span>
          </span>
        </span>
      </div>

      <!-- کارت اصلی -->
      <div class="rounded-3xl bg-white/95 backdrop-blur-sm p-6 sm:p-7 pt-14 shadow-lg relative overflow-hidden">

        <!-- عنوان و چیپ قانون -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2.5 sm:gap-3 mb-5">
          <h2 class="text-[20px] sm:text-[22px] md:text-2xl font-black bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">باشگاه مشتریان ویژه</h2>
          <div class="min-w-0 text-[12px] sm:text-[13px] font-semibold px-3.5 py-2 rounded-full bg-gradient-to-r from-purple-100 to-pink-100 text-purple-800 border border-purple-200 shadow-sm max-w-[78vw] sm:max-w-none truncate">
            هر <span id="reward-target" class="font-bold">۱۰</span> نوبت، <span id="reward-text" class="font-bold">یک اصلاح رایگان</span>
          </div>
        </div>

        <!-- متن مرحله‌ای -->
        <div class="text-center max-w-[48ch] mx-auto mb-4">
          <h3 id="lr-headline" class="text-[16px] sm:text-[18px] font-extrabold text-gray-800 tracking-[0.01em]"></h3>
          <p id="lr-sub" class="text-[12px] text-gray-600 mt-1"></p>
        </div>

        <!-- متریک‌ها -->
        <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-6">
          <div class="relative group">
            <div class="absolute inset-0 bg-gradient-to-br from-green-400/20 to-emerald-500/20 rounded-xl blur-sm"></div>
            <div class="relative rounded-xl bg-white border border-green-200 px-4 py-3 text-center shadow-sm">
              <div class="text-[10px] sm:text-[11px] text-gray-600 font-medium mb-1">انجام شده</div>
              <div id="lr-m-current" class="text-[18px] sm:text-[20px] font-bold text-green-600">۰</div>
            </div>
          </div>
          <div class="relative group">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-400/20 to-cyan-500/20 rounded-xl blur-sm"></div>
            <div class="relative rounded-xl bg-white border border-blue-200 px-4 py-3 text-center shadow-sm">
              <div class="text-[10px] sm:text-[11px] text-gray-600 font-medium mb-1">تا جایزه</div>
              <div id="lr-m-left" class="text-[18px] sm:text-[20px] font-bold text-blue-600">۰</div>
            </div>
          </div>
        </div>

        <!-- نوار پیشرفت -->
        <div class="mb-4">
          <div class="relative h-[12px] sm:h-[14px] rounded-full bg-gray-100 shadow-inner overflow-hidden">
            <div class="absolute inset-0 opacity-30 bg-[repeating-linear-gradient(to_right,transparent,transparent_9.5%,rgba(0,0,0,0.1)_9.5%,rgba(0,0,0,0.1)_10.5%)]"></div>
            <div id="lr-bar" class="relative h-full w-0 rounded-full transition-all duration-500 ease-out"
                 style="background: linear-gradient(90deg, #8B5CF6, #EC4899, #3B82F6);">
              <div class="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow border-2 border-purple-500"></div>
            </div>
          </div>
          <div class="mt-2 text-[12px] sm:text-sm font-medium text-gray-700 flex justify-between items-center">
            <span id="lr-counts" class="font-bold">۰ از ۰</span>
            <span class="text-[11px] text-gray-500">در حال پیشرفت</span>
          </div>
        </div>

        <!-- راهنما -->
        <p id="lr-helper" class="text-center text-[12px] sm:text-[13px] text-gray-600 mb-6 font-medium"></p>

        <!-- دکمه‌ها -->
        <div class="flex flex-col sm:flex-row justify-center gap-2.5 sm:gap-3">
          <button id="lr-cta" class="relative group w-full sm:w-auto rounded-full px-6 py-3.5 text-[14px] font-bold
                  text-white shadow-lg overflow-hidden transform transition-all duration-200 hover:shadow-xl active:scale-[0.98]">
            <div class="absolute inset-0 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600"></div>
            <span class="relative z-10 flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
              </svg>
              <span id="lr-cta-label">رزرو بعدی</span>
            </span>
          </button>

          <button id="lr-rules" class="relative group w-full sm:w-auto rounded-full px-6 py-3.5 text-[14px] font-bold
                  bg-white text-purple-700 shadow overflow-hidden border-2 border-purple-300 hover:border-purple-400 transform transition-all duration-200 hover:shadow-md active:scale-[0.98]">
            <div class="absolute inset-0 bg-gradient-to-r from-purple-50 to-pink-50 opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
            <span class="relative z-10 flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
              قوانین
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- استیکی موبایل -->
  <div id="lr-sticky" class="fixed inset-x-0 bottom-0 z-40 sm:hidden pointer-events-none transition-all duration-200 transform translate-y-0">
    <div class="pointer-events-auto mx-auto max-w-2xl px-3">
      <div class="rounded-t-2xl bg-white/95 backdrop-blur shadow-xl p-4 pb-[max(16px,env(safe-area-inset-bottom))] border-t border-x border-gray-200">
        <div class="absolute top-2 left-1/2 -translate-x-1/2 w-10 h-1 bg-gray-300 rounded-full"></div>
        <div class="flex items-center justify-between gap-3 mt-1">
          <div class="min-w-0 flex-1">
            <div id="lr-sticky-label" class="text-[11px] text-gray-500 font-medium mb-1">باشگاه ویژه</div>
            <div class="flex items-center gap-3">
              <div id="lr-sticky-progress" class="text-[14px] font-bold text-purple-700" aria-live="polite">۰ از ۰</div>
              <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                <div id="lr-sticky-bar" class="h-full w-0 transition-all duration-500 ease-out bg-gradient-to-r from-purple-600 to-pink-600"></div>
              </div>
            </div>
          </div>
          <button id="lr-cta-mobile" class="rounded-full px-5 py-3 text-[13px] font-bold text-white shadow-lg transform transition-all duration-200 active:scale-[0.98] bg-gradient-to-r from-purple-600 to-pink-600">
            <span class="flex items-center gap-1.5">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 1.414L10.586 9.5H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"/>
              </svg>
              <span id="lr-cta-mobile-label">رزرو</span>
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Rules Modal -->
<div id="lrRulesModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-close></div>
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="modal-card relative w-full max-w-md transform transition-all duration-200 scale-95 opacity-0">
      <div class="bg-white rounded-2xl shadow-2xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">قوانین باشگاه مشتریان</h3>
          <button class="p-2 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors duration-200" data-close aria-label="بستن">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="bg-gray-50 rounded-xl p-4 mb-5">
          <div id="lr-rules-content" class="text-gray-700 text-sm whitespace-pre-line leading-7 max-h-64 overflow-y-auto"></div>
        </div>
        <button class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-3 rounded-full shadow-lg transition-all duration-200 active:scale-[0.98]" data-close>متوجه شدم</button>
      </div>
    </div>
  </div>
</div>

<!-- Redeem Modal -->
<div id="lrRedeemModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-close></div>
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="modal-card relative w-full max-w-md transform transition-all duration-200 scale-95 opacity-0">
      <div class="bg-white rounded-2xl shadow-2xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">دریافت جایزه</h3>
        <button class="p-2 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors duration-200" data-close aria-label="بستن">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <div id="lr-redeem-body">
          <div class="text-center mb-5">
            <div class="inline-flex p-4 rounded-full bg-gradient-to-br from-purple-100 to-pink-100 mb-3">
              <svg class="w-10 h-10 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
            </div>
            <p class="text-gray-700 mb-2">به <span id="lr-reward-inline" class="font-bold text-purple-700">یک اصلاح رایگان</span> رسیدی</p>
            <p class="text-sm text-gray-500">آماده دریافت جایزه‌ای؟</p>
          </div>
          
          <div class="rounded-xl bg-gray-50 border border-gray-200 p-4 mb-5">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">وضعیت فعلی</span>
              <span id="lr-redeem-counts" class="font-bold text-purple-700">۰ از ۰</span>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-full transition-colors duration-200 active:scale-[0.98]" data-close>فعلاً نه</button>
            <button id="lr-redeem-confirm" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-3 rounded-full shadow-lg transition-all duration-200 active:scale-[0.98]">
              <span class="flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                دریافت جایزه
              </span>
            </button>
          </div>
        </div>

        <div id="lr-redeem-done" class="hidden text-center py-8">
          <div class="inline-flex p-4 rounded-full bg-gradient-to-br from-green-100 to-emerald-100 mb-4">
            <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <p class="text-xl font-bold text-green-600 mb-2">جایزه ثبت شد</p>
          <p class="text-gray-600">در رزرو بعدی استفاده می‌شه</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  'use strict';

  const rewardsDisabled = localStorage.getItem('vit_vip_rewards_disabled') === '1';
  if (rewardsDisabled) {
    document.getElementById('loyalty-card')?.classList.add('hidden');
    document.getElementById('loyalty-disabled')?.classList.remove('hidden');
    return;
  }

  // ------- KEYS & HELPERS -------
  const KEY_PROGRESS = 'vitreenet_loyalty_current';   // پیشرفت فعلی تا جایزه
  const KEY_TOTAL    = 'vitreenet_booking_total';     // تعداد کل رزروها (برای تشخیص «اولین نوبت»)
  const AUTH_LS_KEY  = 'auth_user';                   // فقط حالت تست/دِمو

  const toFa = n => String(n).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
  const reduce = () => window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function toast(msg, type = 'info') {
    if (typeof showToastDark === 'function') showToastDark(msg, { type });
  }

  // ------- ADAPTERS (قابل تعویض با بک‌اند) -------
  const adapters = {
    async getAuth() {
      if (window.__APP_USER__ && window.__APP_USER__.id) return { loggedIn: true, user: window.__APP_USER__ };
      try {
        const raw = localStorage.getItem(AUTH_LS_KEY);
        if (raw) return { loggedIn: true, user: JSON.parse(raw) };
      } catch (e) {}
      return { loggedIn: false, user: null };
    },
    async getBookingSummary(userId) {
      if (window.__BOOKING_SUMMARY__ && typeof window.__BOOKING_SUMMARY__.total === 'number') {
        return { total: window.__BOOKING_SUMMARY__.total };
      }
      const total = parseInt(localStorage.getItem(KEY_TOTAL) || '0', 10) || 0;
      return { total };
    }
  };

  // ------- MODAL -------
  function openModal(root) {
    root.classList.remove('hidden');
    const card = root.querySelector('.modal-card');
    requestAnimationFrame(() => { card.classList.remove('scale-95','opacity-0'); card.classList.add('scale-100','opacity-100'); });
  }
  function closeModal(root) {
    const card = root.querySelector('.modal-card');
    card.classList.add('scale-95','opacity-0'); card.classList.remove('scale-100','opacity-100');
    setTimeout(() => root.classList.add('hidden'), reduce()?0:200);
  }

  // ------- COPY (صمیمی/متعادل) -------
  function copyFor(progress, current, target, reward) {
    const left = Math.max(0, target - current);
    const pick = (arr) => arr[(current + left) % arr.length];

    if (current >= target) {
      return pick([
        { h: 'جایزه‌ت آماده‌ست 🎁', sub: 'بزن بگیریمش.',            help: 'روی رزرو بعدی اعمالش می‌کنیم.', cta: 'دریافت جایزه' },
        { h: 'حله! رسیدی به جایزه', sub: 'فقط فعالش کنیم و تمام.',  help: 'تو رزرو بعدی استفاده میشه.',    cta: 'دریافت جایزه' },
        { h: 'به هدف خوردی ✨',     sub: 'وقتِ نقد کردنشه.',         help: 'بعدی که رزرو کنی می‌افته.',      cta: 'دریافت جایزه' },
      ]);
    }
    if (current * 2 === target) {
      return pick([
        { h: 'نصفش رفت ✅',      sub: 'چند تا دیگه مونده.',  help: `${left} نوبت مونده.`, cta: 'رزرو بعدی' },
        { h: 'نصف راهی! 👌',     sub: 'با همین فرمون برو.',  help: `${left} نوبت مونده.`, cta: 'رزرو بعدی' },
      ]);
    }
    if (progress >= 90) {
      return pick([
        { h: 'یه قدم تا جایزه',  sub: 'همین یکی دیگه.',      help: left <= 1 ? 'با نوبت بعدی می‌رسی.' : `${left} نوبت مونده.`, cta: 'رزرو بعدی' },
        { h: 'تقریباً رسیدی ⏳', sub: 'کم مونده، بزن بریم.', help: left <= 1 ? 'نوبت بعدی کافیه.'    : `${left} نوبت مونده.`, cta: 'رزرو بعدی' },
      ]);
    }
    if (progress >= 60) {
      return pick([
        { h: 'خوب داری میری 🚀', sub: 'همینو نگه دار.',      help: `${left} نوبت تا جایزه.`, cta: 'رزرو بعدی' },
        { h: 'مسیر رو گرفتی',   sub: 'یکی‌یکی جلو برو.',    help: `${left} نوبت تا جایزه.`, cta: 'رزرو بعدی' },
      ]);
    }
    if (current > 0) {
      return pick([
        { h: 'شروع خوبی زدی',   sub: 'نذار فاصله بیفته.',   help: `${left} نوبت مونده.`,    cta: 'رزرو بعدی' },
        { h: 'اوله راهی ولی رو غلتکی', sub: 'قدم بعدی رو بردار.', help: `${left} نوبت مونده.`, cta: 'رزرو بعدی' },
      ]);
    }
    return pick([
      { h: 'به باشگاه خوش اومدی 👋', sub: 'اولین نوبت رو بگیر و بریم.', help: `با ${target} نوبت، ${reward}.`, cta: 'رزرو اولین نوبت' },
      { h: 'از همین‌جا شروع کن',     sub: 'اولین رزرو = یه قدم جلو.',   help: `با ${target} نوبت، ${reward}.`, cta: 'رزرو اولین نوبت' },
    ]);
  }

  // ------- AUTH / HISTORY -------
  let AUTH = { loggedIn: false, user: null };
  let HAS_BOOKED_BEFORE = false;

  function chooseCtaText(current, target) {
    if (current >= target) return 'دریافت جایزه';
    return HAS_BOOKED_BEFORE ? 'رزرو بعدی' : 'رزرو اولین نوبت';
  }

  function applyCtaText(text) {
    const l1 = document.getElementById('lr-cta-label');
    if (l1) l1.textContent = text;
    const l2 = document.getElementById('lr-cta-mobile-label');
    if (l2) l2.textContent = (text === 'دریافت جایزه') ? 'دریافت' : (text === 'رزرو اولین نوبت' ? 'شروع' : 'رزرو');
  }

  function updateSticky(current, target) {
    const pct = Math.min(100, Math.max(0, (current/target)*100));
    const stickyTxt = document.getElementById('lr-sticky-progress');
    const bar = document.getElementById('lr-sticky-bar');
    if (stickyTxt) stickyTxt.textContent = `${toFa(current)} از ${toFa(target)}`;
    if (bar) bar.style.width = pct + '%';
  }

  function redirectToLogin() {
    const data = document.getElementById('lr-data');
    const loginUrl = data.dataset.loginUrl || '/login';
    const redirect = encodeURIComponent(window.location.href);
    window.location.href = `${loginUrl}?redirect=${redirect}`;
  }

  function requireLogin() {
    toast('اول یه ورود کوچیک لازم داریم؛ سریع برمی‌گردیم همین‌جا 🙂');
    setTimeout(redirectToLogin, 900);
  }

  // ------- INIT CARD -------
  function initCard() {
    const data = document.getElementById('lr-data');
    const target = parseInt(data.dataset.target || '10', 10);
    const reward = data.dataset.reward || '';

    // مقدار خام (ممکنه از سرور یا لوکال بیاد)
    const raw = parseInt(localStorage.getItem(KEY_PROGRESS) ?? data.dataset.current ?? '0', 10) || 0;

    // اگر لاگین نیست یا هرگز رزرو نکرده ⇒ صفر نمایش داده می‌شود
    const current = (!AUTH.loggedIn || !HAS_BOOKED_BEFORE) ? 0 : raw;

    document.getElementById('reward-target').textContent = toFa(target);
    document.getElementById('reward-text').textContent   = reward;

    const pct = Math.min(100, Math.max(0, Math.round((current/target)*100)));
    const {h, sub, help} = copyFor(pct, current, target, reward);

    document.getElementById('lr-headline').textContent = h;
    document.getElementById('lr-sub').textContent      = sub;
    document.getElementById('lr-helper').textContent   = help;

    document.getElementById('lr-counts').textContent   = `${toFa(current)} از ${toFa(target)}`;
    document.getElementById('lr-bar').style.width      = pct + '%';

    const left = Math.max(0, target - current);
    const mCur = document.getElementById('lr-m-current');
    const mLeft = document.getElementById('lr-m-left');
    if (mCur)  mCur.textContent  = toFa(current);
    if (mLeft) mLeft.textContent = toFa(left);

    const ri = document.getElementById('lr-reward-inline');
    if (ri) ri.textContent = reward;
    const rc = document.getElementById('lr-redeem-counts');
    if (rc) rc.textContent = `${toFa(current)} از ${toFa(target)}`;

    applyCtaText(chooseCtaText(current, target));
    updateSticky(current, target);

    // برای هندلرها
    data.dataset.current = String(current);
  }

  // ------- EVENTS -------
  function bindEvents() {
    const data = document.getElementById('lr-data');

    document.getElementById('lr-rules')?.addEventListener('click', () => {
      document.getElementById('lr-rules-content').textContent = data.dataset.rules || '';
      openModal(document.getElementById('lrRulesModal'));
    });

    document.querySelectorAll('#lrRulesModal [data-close], #lrRedeemModal [data-close]').forEach(b=>{
      b.addEventListener('click', e => closeModal(e.target.closest('[role="dialog"]')));
    });
    ['lrRulesModal','lrRedeemModal'].forEach(id=>{
      const m = document.getElementById(id);
      if (m) m.addEventListener('click', e => { if (e.target.hasAttribute('data-close')) closeModal(m); });
    });
    document.addEventListener('keydown', e => {
      if (e.key==='Escape') ['lrRulesModal','lrRedeemModal'].forEach(id=>{
        const m=document.getElementById(id); if(m && !m.classList.contains('hidden')) closeModal(m);
      });
    });

    // --- CTA ---
    async function goCTA() {
      const data = document.getElementById('lr-data');
      if (!data) return;

      const target  = parseInt(data.dataset.target  || '10', 10);
      const current = parseInt(data.dataset.current || '0', 10);

      // اگر کاربر لاگین نیست ولی CTA «رزرو اولین نوبت» است، مستقیم وارد ویزارد شو
      const ctaText    = document.getElementById('lr-cta-label')?.textContent?.trim();
      const isFirstCTA = (ctaText === 'رزرو اولین نوبت') || (!AUTH.loggedIn && !HAS_BOOKED_BEFORE);

      if (!AUTH.loggedIn && !isFirstCTA) {
        requireLogin();
        return;
      }

      if (current >= target && AUTH.loggedIn) {
        openModal(document.getElementById('lrRedeemModal'));
        return;
      }

      // قفل رزرو تا تایید قبلی
      const lsHasPending = () => {
        try {
          const b = JSON.parse(localStorage.getItem('vt:lastBooking') || 'null');
          return !!(b && b.status === 'pending');
        } catch(e){ return false; }
      };
      const hasPending =
        typeof window.hasPendingBooking === 'function'
          ? await window.hasPendingBooking()
          : lsHasPending();

      if (hasPending) {
        if (typeof window.openModalById === 'function' && document.getElementById('pendingBlockModal')) {
          window.openModalById('pendingBlockModal');
        } else if (typeof showToastDark === 'function') {
          showToastDark('نوبت قبلی‌ت هنوز تایید نشده. لطفاً صبر کنی تا تأیید بشه ✋', { type: 'info' });
        } else {
          alert('نوبت قبلی هنوز تایید نشده است.');
        }
        return;
      }

      // باز کردن ویزارد رزرو
      if (typeof window.openBookingWizard === 'function') {
        window.openBookingWizard();
        return;
      }

      const ids = ['booking-wizard', 'booking', 'reserve', 'reservation'];
      let el = null;
      for (const id of ids) { const t = document.getElementById(id); if (t) { el = t; break; } }
      if (el) {
        if (el.classList.contains('hidden')) el.classList.remove('hidden');
        const top = el.getBoundingClientRect().top + window.scrollY - 80;
        (reduce() ? window.scrollTo(0, top) : window.scrollTo({ top, behavior:'smooth' }));
      } else {
        const url = data.dataset.bookingUrl;
        if (url) window.location.href = url; else toast('بخش رزرو هنوز بالا نیومده');
      }
    }

    document.getElementById('lr-cta')?.addEventListener('click', goCTA);
    document.getElementById('lr-cta-mobile')?.addEventListener('click', goCTA);

    // تأیید دریافت جایزه -> ارسال درخواست به فروشنده و ریست پیشرفت
    document.getElementById('lr-redeem-confirm')?.addEventListener('click', async () => {
      if (!AUTH.loggedIn) { requireLogin(); return; }
      const storeId = document.body?.dataset?.storeId || document.body?.dataset?.sellerId;
      document.getElementById('lr-redeem-body').classList.add('hidden');
      document.getElementById('lr-redeem-done').classList.remove('hidden');
      try {
        await fetch('/api/loyalty/request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ storeId })
        });
      } catch (_) {}
      setTimeout(() => {
        localStorage.setItem(KEY_PROGRESS, '0');
        data.dataset.current = '0';
        closeModal(document.getElementById('lrRedeemModal'));
        document.getElementById('lr-redeem-done').classList.add('hidden');
        document.getElementById('lr-redeem-body').classList.remove('hidden');
        toast('درخواست جایزه ثبت شد', 'success');
        initCard();
      }, 250);
    });

    // ====== شمارشِ امن رزروهای تایید شده (Patch) ======
    const KEY_COUNTED = 'vit_loyalty_counted_ids'; // لیست رزروهایی که شمرده‌ایم

    const _getCounted = () => {
      try { return new Set(JSON.parse(localStorage.getItem(KEY_COUNTED) || '[]')); }
      catch { return new Set(); }
    };
    const _setCounted = (set) => {
      try { localStorage.setItem(KEY_COUNTED, JSON.stringify([...set])); } catch {}
    };
    const _extractBookingId = (b) => {
      if (!b) return null;
      return (
        b.bookingId || b.id || b._id ||
        // fallback اگر بک‌اند id نده
        [b.sellerId||'', b.phone||'', b.date||'', b.time||''].join('|')
      );
    };

    // وضعیت‌های مختلف برگشتی را به شکل یکسان نرمال می‌کند
    const normalizeStatus = (s = '') => {
      s = String(s).toLowerCase().trim();
      if ([
        'confirmed','approve','approved','accept','accepted','done',
        'completed','success','ok','تایید','تایید شده','موفق'
      ].includes(s)) return 'confirmed';
      if ([
        'rejected','declined','canceled','cancelled','failed',
        'no-show','noshow','رد','لغو','لغو شده'
      ].includes(s)) return 'rejected';
      return 'pending';
    };

    function syncFromConfirmedBooking(source = 'event') {
      const data = document.getElementById('lr-data');
      if (!data) return;

      let b = null;
      try { b = JSON.parse(localStorage.getItem('vt:lastBooking') || 'null'); } catch {}

      // Only proceed if seller has approved the booking
      if (!b || normalizeStatus(b.status) !== 'confirmed') return;

      // Prevent counting the same booking multiple times (e.g. when no id is provided)
      if (b._countedForLoyalty) return;

      const bookingId = _extractBookingId(b);
      const counted = _getCounted();

      // اگر قبلاً این رزرو شمرده شده، خروج
      if (bookingId && counted.has(bookingId)) return;

      // افزایش‌ها
      const cur   = parseInt(localStorage.getItem(KEY_PROGRESS) ?? data.dataset.current ?? '0', 10) || 0;
      const next  = cur + 1;
      localStorage.setItem(KEY_PROGRESS, String(next));

      const total = parseInt(localStorage.getItem(KEY_TOTAL) || '0', 10) || 0;
      localStorage.setItem(KEY_TOTAL, String(total + 1));

      // علامت‌گذاری این رزرو
      if (bookingId) { counted.add(bookingId); _setCounted(counted); }
      b._countedForLoyalty = true;
      try { localStorage.setItem('vt:lastBooking', JSON.stringify(b)); } catch {}

      HAS_BOOKED_BEFORE = true;

      // نوتیف/رفرش UI
      const target = parseInt(data.dataset.target || '10', 10);
      if (cur < target && next >= target) toast('تبریک! به جایزه رسیدی 🎉', 'success');

      data.dataset.current = String(next);
      initCard();
    }


    // Enhanced booking status checker with retry logic
function setupEnhancedStatusCheck() {
  let retryCount = 0;
  const maxRetries = 3;
  
  // Check on page load
  setTimeout(async () => {
    const b = JSON.parse(localStorage.getItem('vt:lastBooking') || 'null');
    if (b && normalizeStatus(b.status) === 'pending') {
      console.log('[Loyalty] Checking pending booking on load:', b);
      
      // Retry logic for better reliability
      while (retryCount < maxRetries) {
        const stillPending = await window.hasPendingBooking();
        if (!stillPending) {
          console.log('[Loyalty] Booking confirmed after retry', retryCount + 1);
          syncFromConfirmedBooking('enhanced-check');
          break;
        }
        retryCount++;
        await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2s between retries
      }
    }
  }, 1000);

  // Also check when page becomes visible (user returns to tab)
  document.addEventListener('visibilitychange', async () => {
    if (!document.hidden) {
      const b = JSON.parse(localStorage.getItem('vt:lastBooking') || 'null');
      if (b && normalizeStatus(b.status) === 'pending') {
        console.log('[Loyalty] Checking booking on visibility change');
        const stillPending = await window.hasPendingBooking();
        if (!stillPending) {
          syncFromConfirmedBooking('visibility-change');
        }
      }
    }
  });
}

// Call this function right after the loyalty system initialization
setupEnhancedStatusCheck();

    // وقتی وضعیت از بخش Booking Gate می‌آید
    window.addEventListener('booking:status', (e) => {
      if (normalizeStatus(e?.detail?.status) === 'confirmed') {
        syncFromConfirmedBooking('booking:status');
      }
    });

    // همگام‌سازی بین تب‌ها
    window.addEventListener('storage', (e) => {
      if (e.key === 'vt:lastBooking') {
        try {
          const v = JSON.parse(e.newValue || 'null');
          if (normalizeStatus(v?.status) === 'confirmed') {
            syncFromConfirmedBooking('storage');
          }
        } catch {}
      }
    });

    // چک دوره‌ای سبک (وقتی pending است)
// Change the interval from 30000 (30 seconds) to 10000 (10 seconds)
setInterval(async () => {
  try {
    const b = JSON.parse(localStorage.getItem('vt:lastBooking') || 'null');
    if (b && normalizeStatus(b.status) === 'pending' && typeof window.hasPendingBooking === 'function') {
      console.log('[Loyalty] Periodic check for pending booking');
      const stillPending = await window.hasPendingBooking();
      if (!stillPending) {
        syncFromConfirmedBooking('poll');
      }
    }
  } catch (err) {
    console.error('[Loyalty] Periodic check error:', err);
  }
}, 10000); // Changed from 30000 to 10000

    // یک‌بار روی لود صفحه
    document.addEventListener('DOMContentLoaded', () => syncFromConfirmedBooking('boot'));

    // مخفی‌کردن استیکی وقتی CTA داخل ویو
    const stickyWrap = document.getElementById('lr-sticky');
    const cta = document.getElementById('lr-cta');
    if (stickyWrap && cta && 'IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          stickyWrap.style.transform = entry.isIntersecting ? 'translateY(100%)' : 'translateY(0)';
        });
      }, { threshold: 0.5 });
      io.observe(cta);
    }
  }

  // ------- BOOTSTRAP -------
  async function initAuthAndHistory() {
    AUTH = await adapters.getAuth();
    const sum = await adapters.getBookingSummary(AUTH.user?.id);
    HAS_BOOKED_BEFORE = (sum?.total || 0) > 0;
    initCard();
  }

  // با هر تغییر لاگین/کاربر، کارت دوباره محاسبه می‌شود
  document.addEventListener('auth:changed', initAuthAndHistory);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { bindEvents(); initAuthAndHistory(); });
  } else {
    bindEvents();
    initAuthAndHistory();
  }
})();
</script>

<!-- ========== /Loyalty Rewards ========== -->










    
   <!-- Customer Reviews Section - Complete with Review Form -->
<section class="py-8 px-4">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
        <div>
            <h3 class="text-xl font-bold mb-1">نظرات کاربران</h3>
            <div class="flex items-center gap-2">
                <div id="review-stars" class="flex items-center"></div>
                <span id="review-average" class="text-sm font-bold text-gray-700">۰</span>
                <span id="review-count-text" class="text-sm text-gray-500">(۰ نظر)</span>


                <button id="rate-now-chip" type="button"
  class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full
         bg-gradient-to-r from-blue-600 to-teal-500 text-white
         text-[11px] sm:text-xs md:text-sm font-bold shadow-sm
         hover:shadow-md active:scale-95 focus:outline-none
         focus-visible:ring-2 focus-visible:ring-blue-500">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
       class="w-4 h-4" fill="currentColor" aria-hidden="true">
    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
  </svg>
  <span class="hidden xs:inline sm:inline">ثبت امتیاز</span>
  <span class="sm:hidden"> ثبت امتیاز</span>
</button>

            </div>
        </div>
        
        <!-- Buttons Container -->
        <div class="flex items-center gap-2 w-full sm:w-auto">
            <!-- Write Review Button -->
            <button id="write-review-btn" class="flex-1 sm:flex-initial flex items-center justify-center gap-2 px-4 py-2.5 bg-gradient-to-r from-blue-600 to-teal-500 text-white rounded-full text-sm font-bold hover:shadow-lg transform hover:scale-105 transition-all">
                <i class="fas fa-pen text-xs"></i>
                <span>ثبت نظر</span>
            </button>
            
            <!-- Show All Reviews Button -->
            <button id="show-all-reviews" class="flex-1 sm:flex-initial flex items-center justify-center gap-2 px-4 py-2.5 bg-white border border-gray-200 rounded-full text-sm font-bold text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm">
                <span>مشاهده همه</span>
                <i class="fas fa-arrow-left text-xs"></i>
            </button>
        </div>
    </div>
    
    <!-- Reviews Carousel -->
    <div id="reviews-container" class="scroll-container flex overflow-x-auto pb-4 space-x-4 space-x-reverse scrollbar-hide"></div>
</section>

<!-- Reviews Modal -->
<div id="reviewsModal" class="fixed inset-0 z-[120] hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300" id="reviews-backdrop"></div>
    
    <!-- Modal Container -->
    <div class="flex items-end sm:items-center justify-center min-h-full p-0 sm:p-4">
        <div id="reviews-modal-content" class="relative bg-white w-full sm:max-w-2xl md:max-w-3xl lg:max-w-4xl 
                                                  rounded-t-3xl sm:rounded-2xl shadow-2xl transform transition-all duration-300 
                                                  translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0
                                                  max-h-[90vh] sm:max-h-[85vh] flex flex-col">
            
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white rounded-t-3xl sm:rounded-t-2xl border-b border-gray-100 px-6 py-5 z-10">
                <!-- Drag Handle for Mobile -->
                <div class="sm:hidden w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">نظرات کاربران</h3>
                        <div class="flex items-center gap-3">
                            <div id="modal-stars" class="flex items-center gap-1"></div>
                            <span id="modal-average" class="font-bold text-gray-800">۰</span>
                            <span id="modal-count" class="text-sm text-gray-500">بر اساس ۰ نظر</span>

                            <!-- Filter Chips -->
                            <div class="hidden sm:flex items-center gap-2 mr-4">
                                <button class="review-filter-chip active" data-filter="all">همه</button>
                                <button class="review-filter-chip" data-filter="5">5 ستاره</button>
                                <button class="review-filter-chip" data-filter="4">4 ستاره</button>
                                <button class="review-filter-chip" data-filter="3">3 ستاره</button>
                            </div>
                        </div>
                    </div>
                    
                    <button id="close-reviews-modal" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 
                                                            flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
                
                <!-- Mobile Filter Chips -->
                <div class="sm:hidden flex items-center gap-2 mt-3 overflow-x-auto scrollbar-hide">
                    <button class="review-filter-chip active" data-filter="all">همه</button>
                    <button class="review-filter-chip" data-filter="5">5 ستاره</button>
                    <button class="review-filter-chip" data-filter="4">4 ستاره</button>
                    <button class="review-filter-chip" data-filter="3">3 ستاره</button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto px-6 py-4">
                <!-- Rating Summary -->
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-5 mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="text-center sm:text-right">
                            <div id="summary-average" class="text-4xl font-bold text-gray-900 mb-1">۰</div>
                            <div id="summary-stars" class="flex items-center justify-center sm:justify-start gap-1 mb-2"></div>
                            <div id="summary-count" class="text-sm text-gray-600">۰ نظر ثبت شده</div>
                        </div>

        <div class="space-y-2">
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600 w-12">5 ستاره</span>
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="bar-5" class="h-full bg-yellow-400 rounded-full" style="width: 0%"></div>
            </div>
            <span id="count-5" class="text-xs text-gray-600 w-8">0</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600 w-12">4 ستاره</span>
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="bar-4" class="h-full bg-yellow-400 rounded-full" style="width: 0%"></div>
            </div>
            <span id="count-4" class="text-xs text-gray-600 w-8">0</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600 w-12">3 ستاره</span>
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="bar-3" class="h-full bg-yellow-400 rounded-full" style="width: 0%"></div>
            </div>
            <span id="count-3" class="text-xs text-gray-600 w-8">0</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600 w-12">2 ستاره</span>
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="bar-2" class="h-full bg-yellow-400 rounded-full" style="width: 0%"></div>
            </div>
            <span id="count-2" class="text-xs text-gray-600 w-8">0</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600 w-12">1 ستاره</span>
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="bar-1" class="h-full bg-yellow-400 rounded-full" style="width: 0%"></div>
            </div>
            <span id="count-1" class="text-xs text-gray-600 w-8">0</span>
          </div>
        </div>
                    </div>
                </div>

                <!-- Write Review CTA in Modal -->
                <div class="mb-6">
                    <button id="write-review-modal-btn" class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-blue-600 to-teal-500 text-white rounded-xl font-bold hover:shadow-lg transform hover:scale-105 transition-all">
                        <i class="fas fa-pen ml-2"></i>
                        نظر خود را ثبت کنید
                    </button>
                </div>
                
                <!-- Reviews List -->
                <div class="space-y-4" id="reviews-list"></div>

                <!-- Load More Button -->
                <div class="text-center mt-6">
                    <button class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-full transition-colors">
                        نمایش نظرات بیشتر
                        <i class="fas fa-chevron-down mr-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Form Modal -->
<div id="reviewFormModal" class="fixed inset-0 z-[120] hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300" id="review-form-backdrop"></div>
    
    <div class="flex items-end sm:items-center justify-center min-h-full p-0 sm:p-4">
        <div id="review-form-content" class="relative bg-white w-full sm:max-w-lg rounded-t-3xl sm:rounded-2xl shadow-2xl transform transition-all duration-300 translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0 max-h-[90vh] overflow-y-auto">
            
            <!-- Mobile Drag Handle -->
            <div class="sm:hidden sticky top-0 bg-white rounded-t-3xl py-3 z-10">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto"></div>
            </div>
            
            <div class="p-6">
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">ثبت نظر جدید</h3>
                    <button id="close-review-form" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
                
                <!-- Form -->
                <form id="review-form">
                    <!-- Rating Stars -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-3">امتیاز شما</label>
                        <div class="flex items-center gap-3">
                            <div class="rating-stars flex gap-2">
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="1"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="2"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="3"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="4"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="5"></i>
                            </div>
                            <span id="rating-text" class="text-sm font-bold text-gray-600"></span>
                        </div>
                    </div>
                    
                    <!-- Name -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2" for="reviewer-name">نام شما</label>
                        <input type="text" id="reviewer-name" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="نام و نام خانوادگی" required>
                    </div>
                    
                    <!-- Service Used -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2" for="service-used">خدمت دریافت شده</label>
                        <select id="service-used" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            <option value="">انتخاب کنید...</option>
                        </select>
                    </div>
                    
                    <!-- Review Text -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2" for="review-text">نظر شما</label>
                        <textarea id="review-text" rows="4" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none transition-all" placeholder="تجربه خود را با دیگران به اشتراک بگذارید..." required></textarea>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500">حداقل 20 کاراکتر</span>
                            <span id="char-counter" class="text-xs text-gray-500">0/500</span>
                        </div>
                    </div>
                    
                    <!-- Recommend Checkbox -->
                    <div class="mb-6">
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" id="recommend-checkbox" class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 mt-0.5">
                            <span class="text-sm text-gray-700">این آرایشگاه را به دوستانم پیشنهاد می‌کنم</span>
                        </label>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="flex gap-3">
                        <button type="button" id="cancel-review" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-xl transition-colors">
                            انصراف
                        </button>
                        <button type="submit" id="submit-review" data-no-loader
                            class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-teal-500 text-white font-bold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            ارسال نظر
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Styles for Reviews -->
<style>
/* Review Cards */
.review-card {
    transition: all 0.3s ease;
}

.review-card:hover {
    transform: translateY(-2px);
}

/* Modal Animations */
#reviewsModal.show #reviews-backdrop,
#reviewFormModal.show #review-form-backdrop {
    opacity: 1;
}

#reviewsModal.show #reviews-modal-content,
#reviewFormModal.show #review-form-content {
    transform: translateY(0) !important;
    opacity: 1 !important;
}

@media (min-width: 640px) {
    #reviewsModal.show #reviews-modal-content,
    #reviewFormModal.show #review-form-content {
        transform: scale(1) !important;
    }
}

/* Filter Chips */
.review-filter-chip {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    background: white;
    color: #4b5563;
    border: 1px solid #e5e7eb;
    transition: all 0.2s;
    white-space: nowrap;
}

.review-filter-chip:hover {
    background: #f9fafb;
    border-color: #d1d5db;
}

.review-filter-chip.active {
    background: linear-gradient(135deg, #3b82f6, #06b6d4);
    color: white;
    border-color: transparent;
}

/* Line Clamp for Long Reviews */
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Read More Button Animation */
.read-more-btn {
    display: inline-flex;
    align-items: center;
    transition: all 0.2s;
}

.read-more-btn:hover {
    gap: 4px;
}

.read-more-btn i {
    transition: transform 0.2s;
}

.read-more-btn.expanded i {
    transform: rotate(180deg);
}

/* Rating Stars Animation */
.rating-star {
    transition: all 0.2s;
}

.rating-star:hover {
    transform: scale(1.1);
}

.rating-star.filled {
    color: #facc15 !important;
}


/* Mobile Specific Styles */
@media (max-width: 640px) {
    #reviews-modal-content,
    #review-form-content {
        min-height: 70vh;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }
}

/* Smooth Scrollbar */
.scrollbar-hide::-webkit-scrollbar {
    display: none;
}

.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}


@media (max-width: 640px){
  #review-form-content{ 
    padding-bottom: max(16px, env(safe-area-inset-bottom));
  }
}






/* Map container with footer image */
.footer-image-map {
  position: relative;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
}

.footer-image-map::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.4));
  pointer-events: none;
}

.footer-image-map img {
  width: 100%;
  height: auto;
  display: block;
  max-height: none;
  object-fit: contain;
}

/* Fallback text styling when no image */
#map-container:not(.footer-image-map) {
  display: flex;
  align-items: center;
  justify-content: center;
  color: #6b7280;
  font-size: 14px;
}


</style>

<!-- JavaScript for Reviews (fixed) -->
<script>
document.addEventListener('DOMContentLoaded', async function() {
  // ====== Elements ======
  const reviewsModal = document.getElementById('reviewsModal');
  const reviewsModalContent = document.getElementById('reviews-modal-content');
  const showAllBtn = document.getElementById('show-all-reviews');
  const closeReviewsBtn = document.getElementById('close-reviews-modal');
  const reviewsBackdrop = document.getElementById('reviews-backdrop');

  const reviewFormModal = document.getElementById('reviewFormModal');
  const reviewFormContent = document.getElementById('review-form-content');
  const writeReviewBtn = document.getElementById('write-review-btn');
  const writeReviewModalBtn = document.getElementById('write-review-modal-btn');
  const closeReviewFormBtn = document.getElementById('close-review-form');
  const reviewFormBackdrop = document.getElementById('review-form-backdrop');
  const cancelReviewBtn = document.getElementById('cancel-review');

  const rateNowChip = document.getElementById('rate-now-chip');
  if (rateNowChip) rateNowChip.addEventListener('click', () => writeReviewBtn?.click());

  function setReviewActions(enabled) {
    [showAllBtn, writeReviewBtn, writeReviewModalBtn, rateNowChip].forEach(btn => {
      if (!btn) return;
      btn.disabled = !enabled;
      btn.classList.toggle('hidden', !enabled);
    });
  }

  // ====== Form refs ======
  const reviewForm = document.getElementById('review-form');
  const ratingStars = document.querySelectorAll('.rating-star');
  const ratingText = document.getElementById('rating-text');
  const reviewTextarea = document.getElementById('review-text');
  const charCounter = document.getElementById('char-counter');
  const submitBtn = document.getElementById('submit-review');
  const serviceSelect = document.getElementById('service-used');

  // Populate service dropdown when services are loaded
  document.addEventListener('services:loaded', e => {
    if (!serviceSelect) return;
    const items = Array.isArray(e.detail) ? e.detail.filter(it => it.isActive) : [];
    serviceSelect.innerHTML = '<option value="">انتخاب کنید...</option>';
    items.forEach(it => {
      const title = it.title || '';
      const opt = document.createElement('option');
      opt.value = title;
      opt.textContent = title;
      serviceSelect.appendChild(opt);
    });
  });

  // ====== Helpers ======
  const toFa = s => String(s).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
  const toFaNum = n => toFa(String(n));
  const escapeHTML = (str='') => str
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  // آپدیت همه المان‌هایی که id تکراری دارند
  const qAllId = (id) => Array.from(document.querySelectorAll(`[id="${id}"]`));
  const setTextAllById = (id, text) => qAllId(id).forEach(el => el && (el.textContent = text));
  const setHTMLAllById = (id, html) => qAllId(id).forEach(el => el && (el.innerHTML = html));

  function showToast(msg, type='info'){ try { showToastDark(msg, {type}); } catch(_) { console.log(type.toUpperCase()+':', msg); } }

  const TOKEN_KEYS = ['access_token', 'token', 'jwt'];
  function getToken() {
    let t = null;
    for (const k of TOKEN_KEYS) {
      const val = localStorage.getItem(k);
      if (val) { t = val; break; }
    }
    if (!t) return null;
    try {
      const payload = JSON.parse(atob(t.split('.')[1] || ''));
      if (payload.exp * 1000 < Date.now()) {
        TOKEN_KEYS.forEach(k => localStorage.removeItem(k));
        return null;
      }
    } catch (_) {
      return null;
    }
    return t;
  }
  function clearToken() {
    TOKEN_KEYS.forEach(k => localStorage.removeItem(k));
  }
  const authHeaders = () => {
    const t = getToken();
    return t ? { 'Authorization': 'Bearer ' + t } : {};
  };

  // ====== Identity / Scope ======
  const body = document.body;
  const storeId = body?.dataset?.storeId || 'default';
  // مقادیر shopurl و sellerId بعداً تعیین می‌شن
  let shopurl = '';
  let sellerId = null;

  const userId = window.__APP_USER__?.id;
  const isAdmin = window.__APP_USER__?.isAdmin || window.__APP_USER__?.role === 'admin';

  const reviewKey = userId ? `review:last:${storeId}:${userId}` : `review:last:${storeId}`;
  function canSubmitReview() {
    if (isAdmin) return true;
    const last = localStorage.getItem(reviewKey);
    return !last || (Date.now() - parseInt(last || '0', 10)) > 86400000; // 24h
  }
  function markReviewSubmitted() {
    localStorage.setItem(reviewKey, Date.now().toString());
  }
  function updateSubmitState() {
    if (!submitBtn) return;
    if (canSubmitReview()) {
      submitBtn.disabled = false;
      submitBtn.removeAttribute('title');
    } else {
      submitBtn.disabled = true;
      submitBtn.title = 'روزانه یک نظر می‌تونی ثبت کنی.';
      showToast('روزانه یک نظر می‌تونی ثبت کنی.', 'info');
    }
  }

  // ====== Stars ======
  function starHtml(score, size='text-xs') {
    let html = '';
    for (let i=1;i<=5;i++){
      if (score >= i) html += `<i class="fas fa-star text-yellow-400 ${size}"></i>`;
      else if (score >= i-0.5) html += `<i class="fas fa-star-half-alt text-yellow-400 ${size}"></i>`;
      else html += `<i class="far fa-star text-gray-300 ${size}"></i>`;
    }
    return html;
  }
  function setStars(el, score, size='text-sm'){ if(el) el.innerHTML = starHtml(score, size); }
  function setStarsAllById(id, score, size='text-sm'){ qAllId(id).forEach(el => setStars(el, score, size)); }

  // ====== Data I/O ======
  async function fetchByUrl(url) {
    const res = await fetch(url, { credentials: 'include' });
    if (res.status === 404) return null;
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  async function loadReviews() {
    try {
      // Ensure we have the latest identifiers in case other scripts set them later
      if (!shopurl) {
        shopurl = document.body?.dataset?.shopurl || '';
      }
      if (!sellerId) {
        sellerId = document.body?.dataset?.sellerId || window.LAST_PUBLIC?.sellerId || null;
      }

      let data = null;

      if (shopurl) {
        // حالت معمول: از URL شاپ می‌گیریم
        data = await fetchByUrl(`/api/shopAppearance/url/${encodeURIComponent(shopurl)}`);
        sellerId = data?.sellerId || sellerId;
      } else if (sellerId) {
        // fallback اگر shopurl نبود ولی sellerId داریم
        data = await fetchByUrl(`/api/shopAppearance/${encodeURIComponent(sellerId)}`);
      }

      if (!sellerId) {
        showToast('sellerId یا shopurl مشخص نیست؛ ثبت نظر غیرممکنه.', 'error');
        renderReviews([]); // خالی
        updateSummary(0, 0, []);
        setReviewActions(false);
        return;
      }

      if (!/^[0-9a-fA-F]{24}$/.test(sellerId)) {
        showToast('شناسه فروشنده نامعتبر است', 'error');
        renderReviews([]);
        updateSummary(0, 0, []);
        setReviewActions(false);
        return;
      }

      const reviewsRes = await fetchByUrl(`/api/shopAppearance/${encodeURIComponent(sellerId)}/reviews`);
      const reviews = Array.isArray(reviewsRes) ? reviewsRes : (reviewsRes?.reviews || []);
      const avg = typeof data?.averageRating === 'number'
                    ? data.averageRating
                    : (reviews.length ? (reviews.reduce((s,r)=>s+(+r.score||0),0) / reviews.length) : 0);
      const cnt = typeof data?.ratingCount === 'number'
                    ? data.ratingCount
                    : reviews.length;

      updateSummary(avg, cnt, reviews);
      renderReviews(reviews);
      setReviewActions(true);
    } catch (err) {
      console.error('load reviews failed', err);
      showToast('لود نظرات ناموفق بود.', 'error');
      renderReviews([]);
      updateSummary(0, 0, []);
      setReviewActions(false);
    }
  }

  // ====== Render ======
  function renderReviews(list) {
    const reviews = Array.isArray(list) ? list : (list?.reviews || []);
    const container = document.getElementById('reviews-container');
    const modalList = document.getElementById('reviews-list');
    if (container) container.innerHTML = '';
    if (modalList) modalList.innerHTML = '';

    if (!reviews.length) {
      container && (container.innerHTML = '<div class="w-full text-center text-gray-500 py-8">هنوز نظری ثبت نشده است.</div>');
      modalList && (modalList.innerHTML = '<div class="w-full text-center text-gray-500 py-4">هنوز نظری ثبت نشده است.</div>');
      return;
    }

    reviews.forEach(r => {
      const rawName =
        r.userName ||
        (r.userId && typeof r.userId === 'object'
          ? [r.userId.firstname, r.userId.lastname].filter(Boolean).join(' ')
          : '');
      const name = escapeHTML(rawName || 'کاربر');
      const date = r.createdAt ? new Date(r.createdAt).toLocaleDateString('fa-IR') : '';
      const comment = escapeHTML(r.comment || '');
      const score = Math.max(1, Math.min(5, Number(r.score) || 0));
      const stars = starHtml(score);

      container && container.insertAdjacentHTML('beforeend', `
        <div class="review-card flex-shrink-0 w-80 bg-white rounded-2xl shadow-sm hover:shadow-md transition-shadow border border-gray-100 p-5">
          <div class="flex items-start justify-between mb-3">
            <div>
              <h4 class="font-bold text-gray-900 mb-1">${name}</h4>
              <div class="flex items-center gap-1">${stars}</div>
            </div>
            <span class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-full">${escapeHTML(date)}</span>
          </div>
          <p class="text-sm text-gray-700 leading-6">${comment}</p>
        </div>
      `);

      modalList && modalList.insertAdjacentHTML('beforeend', `
        <div class="review-item bg-white border border-gray-100 rounded-2xl p-5 hover:shadow-md transition-shadow" data-rating="${score}">
          <div class="flex items-start justify-between mb-3">
            <div>
              <h4 class="font-bold text-gray-900 mb-1">${name}</h4>
              <div class="flex items-center gap-2">
                <div class="flex items-center gap-1">${stars}</div>
                <span class="text-xs text-gray-400">•</span>
                <span class="text-xs text-gray-500">${escapeHTML(date)}</span>
              </div>
            </div>
          </div>
          <div class="review-text-container">
            <p class="text-sm text-gray-700 leading-7 review-text">${comment}</p>
          </div>
        </div>
      `);
    });
  }

function updateSummary(avg, count, ratings) {
  // ستاره‌ها
  setStarsAllById('review-stars', avg, 'text-xs');
  setStars(document.getElementById('modal-stars'), avg, 'text-xs');
  setStars(document.getElementById('summary-stars'), avg, 'text-sm');

  // میانگین
  const avgStr = toFa((Number(avg)||0).toFixed(1).replace('.', '٫'));
  setTextAllById('review-average', avgStr);
  setTextAllById('avg-rating', avgStr);
  
  // Update header ratings
  const avgEn = (Number(avg)||0).toFixed(1);
  const headerRatingMobile = document.getElementById('header-rating-mobile');
  if (headerRatingMobile) headerRatingMobile.textContent = avgStr;
  const headerRatingLg = document.getElementById('header-rating-lg');
  if (headerRatingLg) headerRatingLg.textContent = avgStr;
  
  const modalAvg = document.getElementById('modal-average');
  if (modalAvg) modalAvg.textContent = avgStr;
  const bigAvg = document.getElementById('summary-average');
  if (bigAvg) bigAvg.textContent = avgStr;

  // تعداد
  const cntStr = toFaNum(count || 0);
  setTextAllById('review-count', cntStr);
  setTextAllById('review-count-text', `(${cntStr} نظر)`);
  
  // Update header counts
  const headerCountMobile = document.getElementById('header-count-mobile');
  if (headerCountMobile) headerCountMobile.textContent = cntStr;
  const headerCountLg = document.getElementById('header-count-lg');
  if (headerCountLg) headerCountLg.textContent = cntStr;
  
  const modalCount = document.getElementById('modal-count');
  if (modalCount) modalCount.textContent = `بر اساس ${cntStr} نظر`;
  const bigCount = document.getElementById('summary-count');
  if (bigCount) bigCount.textContent = `${cntStr} نظر ثبت شده`;

  // توزیع 1..5
  const totals = [0,0,0,0,0];
  (ratings||[]).forEach(r => {
    const s = Math.max(1, Math.min(5, Number(r.score)||0));
    totals[s-1] += 1;
  });
  for (let s=1; s<=5; s++){
    const bar = document.getElementById(`bar-${s}`);
    const span = document.getElementById(`count-${s}`);
    const c = totals[s-1];
    const pct = count ? (c / count) * 100 : 0;
    if (bar) bar.style.width = `${pct}%`;
    if (span) span.textContent = toFaNum(c);
  }
}

  // ====== Modals ======
  function openReviewsModal(){
    if (!reviewsModal) return;
    reviewsModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    setTimeout(() => reviewsModal.classList.add('show'), 10);
  }
  function closeReviewsModal() {
    if (!reviewsModal) return;
    reviewsModal.classList.remove('show');
    setTimeout(() => {
      reviewsModal.classList.add('hidden');
      document.body.style.overflow = '';
    }, 300);
  }
  function openReviewForm() {
    if (!reviewFormModal) return;
    reviewFormModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    setTimeout(() => reviewFormModal.classList.add('show'), 10);
    updateSubmitState();
  }
  function closeReviewFormModal() {
    if (!reviewFormModal) return;
    reviewFormModal.classList.remove('show');
    setTimeout(() => {
      reviewFormModal.classList.add('hidden');
      document.body.style.overflow = '';
      // reset
      reviewForm?.reset();
      selectedRating = 0;
      ratingStars.forEach(star => {
        star.classList.remove('fas','filled');
        star.classList.add('far');
      });
      if (ratingText) ratingText.textContent = '';
      if (charCounter) charCounter.textContent = toFaNum('0/500');
    }, 300);
  }

  showAllBtn?.addEventListener('click', openReviewsModal);
  closeReviewsBtn?.addEventListener('click', closeReviewsModal);
  reviewsBackdrop?.addEventListener('click', closeReviewsModal);

  writeReviewBtn?.addEventListener('click', openReviewForm);
  writeReviewModalBtn?.addEventListener('click', openReviewForm);
  closeReviewFormBtn?.addEventListener('click', closeReviewFormModal);
  reviewFormBackdrop?.addEventListener('click', closeReviewFormModal);
  cancelReviewBtn?.addEventListener('click', closeReviewFormModal);

  // ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (reviewsModal && !reviewsModal.classList.contains('hidden')) closeReviewsModal();
      if (reviewFormModal && !reviewFormModal.classList.contains('hidden')) closeReviewFormModal();
    }
  });

  // Swipe close (mobile)
  function setupSwipeToClose(modalContent, closeFn){
    if (!modalContent) return;
    let startY=0, currentY=0, dragging=false;
    modalContent.addEventListener('touchstart', (e)=>{ if (innerWidth<=640){ startY=e.touches[0].clientY; dragging=true; }});
    modalContent.addEventListener('touchmove', (e)=>{ if(!dragging||innerWidth>640)return; currentY=e.touches[0].clientY; const dy=Math.max(0,currentY-startY); if(dy>0) modalContent.style.transform=`translateY(${dy}px)`; });
    modalContent.addEventListener('touchend', ()=>{ if(!dragging||innerWidth>640)return; const dy=currentY-startY; if(dy>100) closeFn(); else modalContent.style.transform=''; dragging=false; });
  }
  setupSwipeToClose(reviewsModalContent, closeReviewsModal);
  setupSwipeToClose(reviewFormContent, closeReviewFormModal);

  // ====== Filters ======
  const filterChips = document.querySelectorAll('.review-filter-chip');
  filterChips.forEach(chip=>{
    chip.addEventListener('click', function(){
      filterChips.forEach(c=>c.classList.remove('active'));
      this.classList.add('active');
      const filter = this.dataset.filter;
      document.querySelectorAll('.review-item').forEach(review=>{
        review.style.display = (filter==='all' || String(review.dataset.rating)===String(filter)) ? '' : 'none';
      });
    });
  });

  // ====== Rating UI ======
  const ratingMessages = ['', 'ضعیف', 'متوسط', 'خوب', 'عالی', 'فوق‌العاده'];
  let selectedRating = 0;

  function updateStars(rating){
    ratingStars.forEach((star, idx) => {
      if (idx < rating) {
        star.classList.remove('far');
        star.classList.add('fas','filled');
      } else {
        star.classList.remove('fas','filled');
        star.classList.add('far');
      }
    });
  }

  ratingStars.forEach(star=>{
    star.addEventListener('click', function(){
      selectedRating = parseInt(this.dataset.rating, 10) || 0;
      updateStars(selectedRating);
      if (ratingText) ratingText.textContent = ratingMessages[selectedRating] || '';
    });
    star.addEventListener('mouseenter', function(){
      const hover = parseInt(this.dataset.rating, 10) || 0;
      updateStars(hover);
      if (ratingText) ratingText.textContent = ratingMessages[hover] || '';
    });
  });
  document.querySelector('.rating-stars')?.addEventListener('mouseleave', function(){
    updateStars(selectedRating);
    if (ratingText) ratingText.textContent = selectedRating ? (ratingMessages[selectedRating]||'') : '';
  });

  // ====== Char counter ======
  reviewTextarea?.addEventListener('input', function(){
    let val = this.value;
    if (val.length > 500) { val = val.slice(0,500); this.value = val; }
    if (charCounter) charCounter.textContent = toFa(`${val.length}/500`);
  });
  if (charCounter) charCounter.textContent = toFa('0/500');

  // ====== Submit ======
  const POST_ENDPOINT = (sid) => `/api/shopAppearance/${encodeURIComponent(sid)}/rate`;

  reviewForm?.addEventListener('submit', async function(e){
    e.preventDefault();

    if (!canSubmitReview()) { showToast('روزانه یک نظر می‌تونی ثبت کنی.', 'info'); return; }
    if (!selectedRating) { showToast('لطفاً امتیاز بده 🙂', 'info'); return; }
    if (!reviewTextarea || reviewTextarea.value.trim().length < 20) { showToast('متن نظر حداقل ۲۰ کاراکتر باشه.', 'error'); return; }

    // مطمئن شو sellerId داریم و معتبره
    if (!sellerId) {
      // تلاش آخر: دوباره از سرور بگیر
      try { await loadReviews(); } catch {}
    }
    if (!sellerId || !/^[0-9a-fA-F]{24}$/.test(sellerId)) {
      showToast(sellerId ? 'شناسه فروشنده نامعتبر است' : 'sellerId نامشخصه؛ ثبت نظر ممکن نیست.', 'error');
      return;
    }

      const bookings = JSON.parse(localStorage.getItem('vitreenet-bookings') || '[]');
      if (!bookings.length) {
        showToast('برای ثبت نظر باید حداقل یک نوبت ثبت کرده باشید.', 'error');
        return;
      }
      const token = getToken();

    const payload = {
      rating: selectedRating,
      comment: reviewTextarea.value.trim()
    };

    // Loading state
    const old = submitBtn?.innerHTML;
    if (submitBtn){
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>در حال ارسال...';
    }

    // می‌بندیم که UX روون بشه، ولی اگر خطا بود توست می‌دیم
    closeReviewFormModal();

    try {
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers.Authorization = 'Bearer ' + token;
        const res = await fetch(POST_ENDPOINT(sellerId), {
          method: 'POST',
          headers,
          credentials: 'include',
          body: JSON.stringify(payload)
        });
      if (res.status === 401) {
        clearToken();
        showToast('نشست شما منقضی شده؛ لطفاً دوباره وارد شوید.', 'error');
        return;
      }
      if (!res.ok) throw new Error('HTTP '+res.status);

      markReviewSubmitted();
      showToast('نظر ثبت شد و پس از تایید نمایش داده می‌شود 🙌', 'success');
      await loadReviews();
    } catch (err) {
      console.error('submit review failed', err);
      showToast('خطا در ثبت نظر', 'error');
    } finally {
      if (submitBtn){
        submitBtn.disabled = false;
        submitBtn.innerHTML = old || 'ارسال نظر';
      }
    }
  });

  // ====== Boot ======
  const loc = await getShopUrlFromLocation();
  if (typeof loc === 'object') {
    shopurl = loc.shopurl || '';
    if (loc.sellerId) sellerId = loc.sellerId;
  } else {
    shopurl = loc || '';
  }
  if (!shopurl && !sellerId) {
    shopurl = body?.dataset?.shopurl || '';
    sellerId = body?.dataset?.sellerId || null;
  }
  async function handleServicesLoaded() {
    sellerId = document.body?.dataset?.sellerId || null;
    await loadReviews();
  }

  document.addEventListener('services:loaded', handleServicesLoaded);

  if (document.body?.dataset?.sellerId) {
    await handleServicesLoaded();
  }
});
</script>

    <!-- Store Info & Contact -->
    <section class="py-8 px-4">
        <h3 class="text-xl font-bold mb-4">اطلاعات و تماس</h3>
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="mb-6">
                <div class="flex items-start mb-4">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                        <i class="fas fa-map-marker-alt text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-bold mb-1">آدرس</h4>
<p id="store-address" class="text-sm text-gray-700">آدرس در حال بارگذاری...</p>
                    </div>
                </div>
                <div class="mb-4">
                    <div id="map-container" class="w-full max-w-3xl mx-auto min-h-[200px] rounded-lg overflow-hidden bg-gray-200">نقشه در حال بارگذاری...</div>
                </div>
            </div>
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                        <i class="fas fa-phone text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-bold mb-1">شماره تماس</h4>
<p id="store-phone" class="text-sm text-gray-700">شماره تماس در حال بارگذاری...</p>
                    </div>
                </div>
            </div>
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                        <i class="fas fa-clock text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-bold mb-1">ساعت کاری</h4>
<p id="store-hours" class="text-sm text-gray-700">ساعات کاری در حال بارگذاری...</p>
                    </div>
                </div>
            </div>
 

<div class="grid grid-cols-2 gap-3">
  <!-- صفحه اصلی ویترینت -->
  <a href="local***index.html"
     class="group inline-flex items-center justify-center gap-1.5 sm:gap-2 w-full
            rounded-2xl px-3.5 py-3 sm:px-4 sm:py-3.5 min-h-[52px] sm:min-h-[56px]
            font-extrabold text-white text-[13px] sm:text-[15px] shadow-lg
            bg-gradient-to-tr from-blue-600 to-teal-500 ring-1 ring-white/60
            transition-all hover:from-blue-700 hover:to-teal-600
            hover:shadow-[0_10px_25px_rgba(16,185,129,0.25)]
            active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
     aria-label="رفتن به صفحه اصلی ویترینت">
    <i class="fas fa-house ml-1.5 sm:ml-2 text-[14px] sm:text-base opacity-95 transition-transform group-active:scale-95"></i>
    <span class="truncate">صفحه اصلی ویترینت</span>
  </a>

  <!-- مغازه‌های مشابه -->
  <a href="local***discover.html"
     class="group inline-flex items-center justify-center gap-1.5 sm:gap-2 w-full
            rounded-2xl px-3.5 py-3 sm:px-4 sm:py-3.5 min-h-[52px] sm:min-h-[56px]
            font-extrabold text-blue-800 text-[13px] sm:text-[15px]
            bg-gradient-to-tr from-sky-50/90 via-cyan-50/90 to-emerald-50/90
            backdrop-blur-md border border-white/60 shadow
            hover:from-sky-100/90 hover:via-cyan-100/90 hover:to-emerald-100/90 hover:shadow-lg
            active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500
            transition-all"
     aria-label="مشاهده مغازه‌های مشابه">
    <i class="fas fa-store ml-1.5 sm:ml-2 text-[14px] sm:text-base opacity-95 transition-transform group-active:scale-95"></i>
    <span class="truncate">مغازه‌های مشابه</span>
  </a>
</div>




        </div>
    </section>
    <!-- Mobile Navigation Bar -->

<footer id="site-footer" class="w-full mt-16 hide-on-mobile" aria-labelledby="vitreenet-footer-title">
  <h2 id="vitreenet-footer-title" class="sr-only">ویترینت — ویترین آنلاین کسب‌وکارهای محلی</h2>

  <div class="bg-gradient-to-tr from-[#f8fafc] via-[#e0fdfa] to-[#d4fbe8]
              rounded-t-[1.7rem] border-t border-white/70
              shadow-[0_-12px_30px_rgba(0,0,0,0.06)]">
    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 py-10">

      <div class="grid grid-cols-1 md:grid-cols-4 gap-10">
        <!-- 1) اشاره خیلی مختصر به مغازه -->
        <div>
          <div class="flex items-center gap-2 mb-2">
            <span class="inline-flex w-9 h-9 items-center justify-center rounded-xl
                         bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
              <i class="fa-solid fa-store"></i>
            </span>
            <p id="footer-shop-name" class="font-extrabold text-gray-800">آرایشگاه مردانه سلطنتی</p>
          </div>
          <p class="text-xs text-gray-600 leading-6">
            این صفحه بر بستر <strong class="text-gray-800">ویترینت</strong> میزبانی می‌شود.
          </p>
          <!-- بنا به خواست شما دکمه «رزرو سریع» حذف شد -->
        </div>

        <!-- 2) ویترینت در یک نگاه (برای کاربران) -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="inline-flex w-9 h-9 items-center justify-center rounded-xl
                         bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
              <i class="fa-solid fa-compass"></i>
            </span>
            <p class="font-extrabold text-gray-800">ویترینت در یک نگاه</p>
          </div>

          <p class="text-sm text-gray-700 leading-7">
            با ویترینت، ویترین آنلاینِ مغازه‌ات را بساز و مدیریت کن؛
            رزرو نوبت، پرداخت امن، باشگاه مشتریان و گزارش‌های هوشمند — همه یک‌جا و بدون کدنویسی.
          </p>

          <div class="mt-4 space-y-2">
            <a href="/" rel="home"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-white
                      bg-gradient-to-tr from-blue-600 to-teal-500 hover:from-blue-700 hover:to-teal-600
                      shadow-lg transition" aria-label="رفتن به صفحه اصلی ویترینت">
              صفحهٔ اصلی ویترینت
            </a>

            <a href="/discover"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-blue-700
                      bg-white/80 backdrop-blur border border-white/70 hover:bg-white hover:shadow transition"
               aria-label="مشاهده مغازه‌های مشابه در ویترینت">
              مغازه‌های مشابه
            </a>
          </div>
        </div>

        <!-- 3) مزیت‌ها (خلاصه و کاربردی) -->
        <div>
          <p class="font-extrabold text-gray-800 mb-3">چرا ویترینت؟</p>
          <ul class="space-y-2 text-sm text-gray-700">
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> رزرو آنلاین با یادآوری خودکار</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> پرداخت امن و فاکتور دیجیتال</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> باشگاه مشتریان و کوپن‌های تخفیف</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> ظاهر سبک، واکنش‌گرا و سریع</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> داشبورد آمار و گزارش‌های کاربردی</li>
          </ul>
        </div>

        <!-- 4) CTA برای صاحبان کسب‌وکار -->
        <div>
          <p class="font-extrabold text-gray-800 mb-3">برای صاحبان کسب‌وکار</p>
          <div class="space-y-3">
            <a href="/merchant/register"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-white
                      bg-gradient-to-tr from-blue-600 to-teal-500 hover:from-blue-700 hover:to-teal-600
                      shadow-lg transition" aria-label="ثبت فروشگاه در ویترینت">
              ثبت فروشگاه در ویترینت
            </a>
            <a href="/merchant/login"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-blue-700
                      bg-white/80 backdrop-blur border border-white/70 hover:bg-white hover:shadow transition"
               aria-label="ورود فروشندگان">
              ورود فروشندگان
            </a>
            <div class="text-xs text-gray-500 leading-6">
              کمتر از ۳ دقیقه تا راه‌اندازی — بدون نیاز به برنامه‌نویسی
            </div>
          </div>
        </div>
      </div>

      <!-- نوار پایینی -->
      <div class="mt-10 pt-4 border-t border-white/70
                  flex flex-col sm:flex-row items-center justify-between gap-3
                  text-gray-500 text-sm">
        <div class="flex items-center gap-2">
          <span class="inline-flex w-6 h-6 items-center justify-center rounded-lg
                       bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
            <i class="fa-solid fa-gem"></i>
          </span>
          <span>ساخته شده با <strong class="text-gray-700">ویترینت</strong> — ویترین آنلاین کسب‌وکارهای محلی</span>
        </div>

        <p>© <span id="footer-year"></span> ویترینت — همه حقوق محفوظ است.</p>

        <div class="flex items-center gap-2">
          <a href="/terms" class="hover:text-blue-700 transition">قوانین</a>
          <span class="text-gray-300">•</span>
          <a href="/privacy" class="hover:text-blue-700 transition">حریم خصوصی</a>
          <span class="text-gray-300">•</span>
          <button id="back-to-top" class="chip chip--primary" aria-label="بازگشت به بالای صفحه">بازگشت به بالا</button>
        </div>
      </div>

    </div>
  </div>
</footer>




<script>
  (function () {
    // سال شمسی با ارقام فارسی
    const yearEl = document.getElementById('footer-year');
    if (yearEl) {
      yearEl.textContent = new Intl.DateTimeFormat('fa-IR', { year: 'numeric' }).format(new Date());
    }

    // بازگشت به بالا با اسکرول نرم (رعایت Reduce Motion)
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const up = document.getElementById('back-to-top');
    if (up) {
      up.addEventListener('click', () => {
        if (prefersReduced) {
          window.scrollTo(0, 0);
        } else {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    }

    // اسکرول نرم برای لینک‌های داخلی داخل فوتر (#anchor)
    document.querySelectorAll('#site-footer a[href^="#"]').forEach(a => {
      a.addEventListener('click', (e) => {
        const id = a.getAttribute('href');
        const target = document.querySelector(id);
        if (!target) return;
        e.preventDefault();

        if (prefersReduced) {
          target.scrollIntoView();
        } else {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // بهبود دسترس‌پذیری: فوکوس پس از اسکرول
        target.setAttribute('tabindex', '-1');
        target.focus({ preventScroll: true });
      });
    });
  })();
</script>


    <script src="nav-active.js"></script>

    <script>
        // Modal functionality for portfolio images
        function openModal(imageSrc, title) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            
            modalImage.src = imageSrc;
            modalTitle.textContent = title;
            
            // Disable body scroll
            document.body.style.overflow = 'hidden';
            
            // Show modal with animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.relative').classList.add('scale-100', 'opacity-100');
                modal.querySelector('.relative').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
        function closeModal() {
            const modal = document.getElementById('imageModal');
            
            // Hide modal with animation
            modal.querySelector('.relative').classList.add('scale-95', 'opacity-0');
            modal.querySelector('.relative').classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                // Enable body scroll
                document.body.style.overflow = '';
            }, 300);
        }
        // Close modal when clicking outside the image
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        // Booking Wizard Logic
document.addEventListener('DOMContentLoaded', function () {
  // ---- عناصر اصلی
  const heroCta         = document.getElementById('hero-cta');
  const bookingWizard   = document.getElementById('booking-wizard');
  const prefersReduced  = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  const API_ROOT = window.__API_BASE__ || '';

  // مراحل و اندیکاتورها
  const step1 = document.getElementById('step-1');
  const step2 = document.getElementById('step-2');
  const step3 = document.getElementById('step-3');
  const step4 = document.getElementById('step-4');

  const currentStep     = document.getElementById('current-step');
  const progressBar     = document.getElementById('progress-bar');
  const step2Indicator  = document.getElementById('step-2-indicator');
  const step3Indicator  = document.getElementById('step-3-indicator');
  const step4Indicator  = document.getElementById('step-4-indicator');

  // گزینه‌ها و دکمه‌ها
  let serviceOptions  = [];
  const dateOptions   = document.querySelectorAll('.date-option');
  const timeOptions   = document.querySelectorAll('.time-option');

  const nextToStep2     = document.getElementById('next-to-step-2');
  const nextToStep3     = document.getElementById('next-to-step-3');
  const nextToStep4     = document.getElementById('next-to-step-4');

  const backToStep1     = document.getElementById('back-to-step-1');
  const backToStep2     = document.getElementById('back-to-step-2');
  const backToStep3     = document.getElementById('back-to-step-3');

  // فیلدها و تایید
  const phoneNumber     = document.getElementById('phone-number');
  const customerName    = document.getElementById('customer-name');

  const confirmService  = document.getElementById('confirm-service');
  const confirmDate     = document.getElementById('confirm-date');
  const confirmTime     = document.getElementById('confirm-time');
  const confirmName     = document.getElementById('confirm-name');
  const confirmPhone    = document.getElementById('confirm-phone');
  const confirmPrice    = document.getElementById('confirm-price');

  const confirmBooking  = document.getElementById('confirm-booking');
  const bookingSuccess  = document.getElementById('booking-success');
  const closeBooking    = document.getElementById('close-booking');

  // وضعیت انتخاب‌ها
  let selectedService = '';
  let selectedServiceId = '';
  let selectedPrice   = '';
  let selectedDate    = '';
  let selectedTime    = '';

  const priceFa = n => (Number(n)||0).toLocaleString('fa-IR');

  function bindServiceOptions() {
    serviceOptions = Array.from(document.querySelectorAll('#step-1 .service-option'));
    serviceOptions.forEach(option => {
      option.addEventListener('click', function () {
        serviceOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
        this.classList.add('border-blue-500', 'bg-blue-50');
        selectedService   = this.getAttribute('data-service')     || '';
        selectedServiceId = this.getAttribute('data-service-id') || '';
        selectedPrice     = this.getAttribute('data-price')       || '';
        enable(nextToStep2, true);
      });
    });
  }

  function renderBookingServices(items) {
    const container = document.getElementById('booking-services');
    if (!container) return;
    container.innerHTML = '';
    const active = Array.isArray(items) ? items.filter(it => it.isActive) : [];
    if (!active.length) {
      container.innerHTML = '<div class="text-center text-gray-500">فعلاً سرویسی ثبت نشده است.</div>';
      return;
    }
    active.forEach(it => {
      const off  = Number(it.discountPercent ?? it.offPercent ?? it.discount ?? 0) || 0;
      const base = Number(it.finalPrice ?? it.price ?? 0);
      const finalPrice = off ? Math.max(0, Math.round((it.price || 0) * (100 - off) / 100)) : base;
      container.insertAdjacentHTML('beforeend',
        `<div class="service-option border border-gray-300 rounded-lg p-3 hover:border-blue-500 cursor-pointer bw-tap" data-service-id="${it._id}" data-service="${it.title || ''}" data-price="${finalPrice}">
          <div class="flex justify-between items-center">
            <div>
              <h5 class="font-bold">${it.title || ''}</h5>
              <p class="text-sm text-gray-600">${it.desc || ''}</p>
            </div>
            <span class="font-bold">${priceFa(finalPrice)} تومان</span>
          </div>
        </div>`);
    });
    bindServiceOptions();
  }

  document.addEventListener('services:loaded', e => {
    renderBookingServices(e.detail || []);
  });

  // ---- توابع کمکی
  function scrollToWizard() {
    if (!bookingWizard) return;
    const top = bookingWizard.getBoundingClientRect().top + window.scrollY - 80;
    prefersReduced ? window.scrollTo(0, top) : window.scrollTo({ top, behavior: 'smooth' });
  }
  function openWizard() {
    bookingWizard?.classList.remove('hidden');
    scrollToWizard();
  }
  function enable(el, on = true) {
    if (!el) return;
    el.disabled = !on;
  }

  // ---- باز کردن ویزارد از CTA بالا
  heroCta?.addEventListener('click', function (e) {
    e.preventDefault?.();
    openWizard();
  });

  // ---- باز کردن ویزارد از کارت‌های خدمات + پر‌کردن خودکار مرحله ۱
  // (اصلاح کلاس دکمه‌ها از .service-select به .service-button)
  document.querySelectorAll('.service-button').forEach((button) => {
    button.addEventListener('click', function () {
      const svc   = this.getAttribute('data-service');
      openWizard();
      // انتخاب خودکار همان گزینه در مرحله ۱ با تریگر کردن کلیک خودش
      setTimeout(() => {
        const opt = document.querySelector(`.service-option[data-service="${svc}"]`);
        opt?.click();
      }, 0);
    });
  });

  // ---- مرحله ۱: انتخاب سرویس
  // رویداد کلیک پس از بارگذاری خدمات توسط bindServiceOptions متصل می‌شود

  nextToStep2?.addEventListener('click', function () {
    step1.classList.add('hidden');
    step2.classList.remove('hidden');
    currentStep.textContent = '2';
      step2Indicator?.classList.remove('bg-gray-300');
      step2Indicator?.classList.add('bg-blue-600');
    progressBar.style.width = '50%';
    // از اینجا به بعد هنوز چیزی انتخاب نشده، دکمه مرحله بعد غیرفعال باشد
    enable(nextToStep3, false);
  });

  // ---- مرحله ۲: انتخاب تاریخ و ساعت
  dateOptions.forEach(option => {
    option.addEventListener('click', function () {
      // پاک‌کردن انتخاب قبلی
      dateOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
      // انتخاب فعلی
      this.classList.add('border-blue-500', 'bg-blue-50');
      // استخراج متن از دو div داخلی (اصلاح selector اشتباه '.div:nth-child()')
      const first  = this.firstElementChild?.textContent?.trim() || '';
      const second = this.lastElementChild?.textContent?.trim()  || '';
      // مطابق منطق قبلی: فرمت «دومی + اولی»
      selectedDate = (second + ' ' + first).trim();
      // فعال‌سازی دکمه بعدی اگر ساعت هم انتخاب شده
      if (selectedTime) enable(nextToStep3, true);
    });
  });

  timeOptions.forEach(option => {
    option.addEventListener('click', function () {
      // پاک‌کردن انتخاب قبلی
      timeOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
      // انتخاب فعلی
      this.classList.add('border-blue-500', 'bg-blue-50');
      // ذخیره
      selectedTime = (this.textContent || '').trim();
      // فعال‌سازی دکمه بعدی اگر تاریخ هم انتخاب شده
      if (selectedDate) enable(nextToStep3, true);
    });
  });

  backToStep1?.addEventListener('click', function () {
    step2.classList.add('hidden');
    step1.classList.remove('hidden');
    currentStep.textContent = '1';
      step2Indicator?.classList.remove('bg-blue-600');
      step2Indicator?.classList.add('bg-gray-300');
    progressBar.style.width = '25%';
  });

  nextToStep3?.addEventListener('click', function () {
    step2.classList.add('hidden');
    step3.classList.remove('hidden');
    currentStep.textContent = '3';
      step3Indicator?.classList.remove('bg-gray-300');
      step3Indicator?.classList.add('bg-blue-600');
    progressBar.style.width = '75%';
    // اطمینان از غیرفعال بودن دکمه مرحله ۴ تا تکمیل اعتبارسنجی
    validateStep3();
  });

  // ---- مرحله ۳: اطلاعات تماس
  function validateStep3() {
    const okPhone = (phoneNumber.value || '').trim().length >= 10;
    const okName  = (customerName.value || '').trim() !== '';
    enable(nextToStep4, okPhone && okName);
  }
  phoneNumber?.addEventListener('input', validateStep3);
  customerName?.addEventListener('input', validateStep3);

  backToStep2?.addEventListener('click', function () {
    step3.classList.add('hidden');
    step2.classList.remove('hidden');
    currentStep.textContent = '2';
      step3Indicator?.classList.remove('bg-blue-600');
      step3Indicator?.classList.add('bg-gray-300');
    progressBar.style.width = '50%';
  });

  nextToStep4?.addEventListener('click', function () {
    // تکمیل جزئیات تایید
    confirmService.textContent = selectedService;
    confirmDate.textContent    = selectedDate;
    confirmTime.textContent    = selectedTime;
    confirmName.textContent    = customerName.value;
    confirmPhone.textContent   = '+98' + phoneNumber.value; // پیش‌شماره لاتین مشابه شماره موبایل
    confirmPrice.textContent   = (parseInt(selectedPrice, 10) || 0).toLocaleString('fa-IR') + ' تومان';

    // رفتن به مرحله ۴
    step3.classList.add('hidden');
    step4.classList.remove('hidden');
    currentStep.textContent = '4';
      step4Indicator?.classList.remove('bg-gray-300');
      step4Indicator?.classList.add('bg-blue-600');
    progressBar.style.width = '100%';
  });

  // ---- مرحله ۴: تایید نهایی
  backToStep3?.addEventListener('click', function () {
    step4.classList.add('hidden');
    step3.classList.remove('hidden');
    currentStep.textContent = '3';
      step4Indicator?.classList.remove('bg-blue-600');
      step4Indicator?.classList.add('bg-gray-300');
    progressBar.style.width = '75%';
  });

confirmBooking?.addEventListener('click', async function () {
  // Store original button state
  const originalText = this.textContent;
  const wasDisabled = this.disabled;
  
  // Set loading state
  this.disabled = true;
  this.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>در حال تایید...';
  
  try {
    // Determine sellerId from available sources
    let sellerId =
      document.body?.dataset?.sellerId ||
      window.LAST_PUBLIC?.sellerId ||
      (window.LAST_PUBLIC?.items?.find(it => it._id === selectedServiceId)?.sellerId);

    // Validate required data before submitting
    if (!selectedService || !sellerId) {
      // Restore button state on validation failure
      this.disabled = wasDisabled;
      this.innerHTML = originalText;

      const msg = !selectedService
        ? 'لطفاً یک سرویس را انتخاب کنید.'
        : 'اطلاعات فروشنده یافت نشد. لطفاً صفحه را دوباره بارگذاری کنید.';

      if (typeof showToastDark === 'function') {
        showToastDark(msg, { type: 'error' });
      } else {
        alert(msg);
      }
      return;
    }

    // Submit the booking
    const res = await fetch(`${API_ROOT}/api/bookings`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        serviceId: selectedServiceId || undefined,
        service: selectedService,
        sellerId,
        customerName: customerName.value.trim(),
        customerPhone: phoneNumber.value.trim(),
        date: selectedDate,
        time: selectedTime
      })
    });
    
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.message || `HTTP ${res.status}`);
    }
    
    // Success - show success screen
    step4.classList.add('hidden');
    bookingSuccess.classList.remove('hidden');
    
    // Save booking data
    window.__BOOKING_GUARD__?.saveLast({
      phone: phoneNumber.value,
      service: selectedService,
      date: selectedDate,
      time: selectedTime,
      status: 'pending',
      createdAt: new Date().toISOString()
    });

    // Save for gamification
    const bookings = JSON.parse(localStorage.getItem('vitreenet-bookings') || '[]');
    bookings.push({
      id: Date.now().toString(36),
      service: selectedService,
      price: selectedPrice,
      date: selectedDate,
      time: selectedTime,
      name: customerName.value,
      phone: phoneNumber.value,
      timestamp: new Date().toISOString(),
      status: 'pending'
    });
    localStorage.setItem('vitreenet-bookings', JSON.stringify(bookings));
    
  } catch (err) {
    console.error('submit booking failed', err);
    
    // Restore button on error
    this.disabled = wasDisabled;
    this.innerHTML = originalText;
    
    // Show error to user
    if (typeof showToastDark === 'function') {
      showToastDark(err.message || 'خطا در ثبت نوبت. لطفاً دوباره تلاش کنید.', {type: 'error'});
    } else {
      alert(err.message || 'خطا در ثبت نوبت. لطفاً دوباره تلاش کنید.');
    }
    
    return; // Don't hide the form on error
  }
  
  // Note: Don't restore button on success as we're moving to success screen
});

  closeBooking?.addEventListener('click', function () {
    // بستن و ریست کامل ویزارد
    bookingWizard.classList.add('hidden');
    resetBookingWizard();
  });

  // ---- ریست کامل ویزارد
  function resetBookingWizard() {
    // مراحل
    step1.classList.remove('hidden');
    step2.classList.add('hidden');
    step3.classList.add('hidden');
    step4.classList.add('hidden');
    bookingSuccess.classList.add('hidden');

    // اندیکاتورها
    currentStep.textContent = '1';
      step2Indicator?.classList.remove('bg-blue-600');
      step2Indicator?.classList.add('bg-gray-300');
      step3Indicator?.classList.remove('bg-blue-600');
      step3Indicator?.classList.add('bg-gray-300');
      step4Indicator?.classList.remove('bg-blue-600');
      step4Indicator?.classList.add('bg-gray-300');
    progressBar.style.width = '25%';

    // انتخاب‌ها
    serviceOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
    dateOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
    timeOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));

    // فیلدها
    phoneNumber.value = '';
    customerName.value = '';

    // دکمه‌ها
    enable(nextToStep2, false);
    enable(nextToStep3, false);
    enable(nextToStep4, false);

    // وضعیت
    selectedService   = '';
    selectedServiceId = '';
    selectedPrice     = '';
    selectedDate      = '';
    selectedTime      = '';
  }
});

    </script>






<!-- Mobile Bottom Footer / Nav (5 items, same style) -->
<footer id="mobile-bottom-nav" class="mobile-nav lg:hidden safe-area-bottom" role="navigation" aria-label="ناوبری موبایل">
  <style>
    .safe-area-bottom {
      padding-bottom: env(safe-area-inset-bottom, 0);
    }
    
    @supports (padding: max(0px)) {
      .mobile-nav {
        padding-bottom: max(8px, env(safe-area-inset-bottom));
        height: calc(72px + env(safe-area-inset-bottom));
      }
    }
  </style>  <!-- خانه -->
  <button type="button" class="nav-item" data-nav="home" aria-label="خانه" aria-current="page">
    <i class="fa-solid fa-house nav-icon"></i>
    <span class="nav-label">خانه</span>
  </button>

  <!-- خدمات -->
  <button type="button" class="nav-item" data-nav="services" aria-label="خدمات">
    <i class="fa-solid fa-scissors nav-icon"></i>
    <span class="nav-label">خدمات</span>
  </button>

  <!-- رزرو (CTA وسط، برجسته) -->
  <button type="button" class="nav-item active -mt-6 !text-white" data-nav="booking" aria-label="رزرو" style="padding:0">
    <span class="inline-flex items-center justify-center w-14 h-14 rounded-2xl shadow-lg ring-4 ring-white/60 bg-gradient-to-tr from-blue-600 to-teal-500">
      <i class="fa-solid fa-calendar-check text-lg"></i>
    </span>
    <span class="nav-label mt-1">رزرو</span>
  </button>

  <!-- نمونه‌کار -->
  <button type="button" class="nav-item" data-nav="portfolio" aria-label="نمونه‌کار">
    <i class="fa-solid fa-images nav-icon"></i>
    <span class="nav-label">نمونه‌کار</span>
  </button>

  <!-- پروفایل -->
  <button type="button" class="nav-item" data-nav="profile" aria-label="پروفایل">
    <i class="fa-solid fa-user nav-icon"></i>
    <span class="nav-label">پروفایل</span>
  </button>
</footer>

<script>
(() => {
  const nav = document.getElementById('mobile-bottom-nav');
  if (!nav) return;

  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const items = nav.querySelectorAll('.nav-item');

  const setActive = (key) => {
    items.forEach(btn => {
      const isActive = btn.dataset.nav === key;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-current', isActive ? 'page' : 'false');
    });
  };

  const smoothGo = (target) => {
    if (!target) return;
    if (prefersReduced) target.scrollIntoView();
    else target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  const byId = (id) => document.getElementById(id);
  const bySel = (sel) => document.querySelector(sel);

  const findByHeading = (keyword) => {
    const hs = [...document.querySelectorAll('h1,h2,h3,h4')];
    const hit = hs.find(h => (h.textContent || '').includes(keyword));
    return hit ? (hit.closest('section') || hit) : null;
  };

  // Targets (with robust fallbacks)
  const targets = {
    home: () => document.documentElement,
    services: () => byId('services') || findByHeading('خدمات'),
    booking: () => byId('booking-wizard'),
    portfolio: () => byId('portfolio') || bySel('.portfolio-section') || findByHeading('نمونه کار'),
    profile: () => byId('profile') || findByHeading('پروفایل'),
  };

  // Click handlers
  items.forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.dataset.nav;

      if (key === 'home') {
        // لینک مستقیم به صفحه اصلی ویترینت
        window.location.href = 'local***index.html';
        return;
      }

      if (key === 'booking') {
        const wizard = byId('booking-wizard');
        const heroCta = byId('hero-cta');
        if (wizard && wizard.classList.contains('hidden')) {
          if (heroCta) heroCta.click();
          else wizard.classList.remove('hidden');
        }
        const t = targets.booking();
        if (t) {
          const top = t.getBoundingClientRect().top + window.scrollY - 80;
          if (prefersReduced) window.scrollTo(0, top);
          else window.scrollTo({ top, behavior: 'smooth' });
          setActive('booking');
        }
        return;
      }

      if (key === 'profile') {
        // انتقال به صفحه پروفایل کاربر
        window.location.href = 'service-seller-panel/s-profile.html';
        return;
      }

      const t = targets[key] && targets[key]();
      if (t) smoothGo(t);
      setActive(key);
    });
  });

  // Scroll spy (if supported)
  const spySections = [
    { key: 'services', el: targets.services() },
    { key: 'portfolio', el: targets.portfolio() },
    { key: 'profile',  el: targets.profile() },
  ].filter(s => s.el);

  if ('IntersectionObserver' in window && spySections.length) {
    const io = new IntersectionObserver((entries) => {
      const vis = entries.filter(e => e.isIntersecting)
                         .sort((a,b) => b.intersectionRatio - a.intersectionRatio)[0];
      if (!vis) return;
      const hit = spySections.find(s => s.el === vis.target);
      if (hit) setActive(hit.key);
    }, { threshold: [0.35, 0.6], rootMargin: '-20% 0px -50% 0px' });
    spySections.forEach(s => io.observe(s.el));

    // Top of page = خانه
    window.addEventListener('scroll', () => {
      if (window.scrollY < 80) setActive('home');
    }, { passive: true });
  }

  // Initial state
  setActive('home');
})();
</script>



<script>
  (function () {
    var badge = document.getElementById('vip-badge');
    var out   = document.getElementById('vip-count');
    if (!badge || !out) return;
    var n = Number(badge.getAttribute('data-count') || 0);
    out.textContent = new Intl.NumberFormat('fa-IR').format(n) + ' نفر';
  })();
</script>






<script>
/* پاپ‌اپ شیشه‌ای وسط صفحه + ترجمه پیام‌ها (Drop-in Replacement) */
(() => {
  const translate = (txt) => {
    if (!txt) return "";
    if (/You can submit one review per day/i.test(txt)) {
      return "روزانه فقط یک نظر می‌توانید ثبت کنید.";
    }
    return txt;
  };

  // همان امضای قبلی: showToastDark(message, {type, durationMs})
  window.showToastDark = function (message, { type = "info", durationMs = 2600 } = {}) {
    const palette = {
      success: { ring: "ring-emerald-200", icon: "text-emerald-600", ico: "fas fa-check" },
      info:    { ring: "ring-blue-200",    icon: "text-blue-600",    ico: "fas fa-info-circle" },
      error:   { ring: "ring-rose-200",    icon: "text-rose-600",    ico: "fas fa-exclamation-circle" }
    };
    const p = palette[type] || palette.info;

    // اگر قبلاً بازه، حذف کن
    const existing = document.getElementById("dark-toast");
    if (existing) existing.remove();

    // لایه‌ی پس‌زمینه (برای کلیک برای بستن)
    const overlay = document.createElement("div");
    overlay.id = "dark-toast";
    overlay.setAttribute("role", "dialog");
    overlay.setAttribute("aria-modal", "true");
    overlay.dir = "rtl";
    overlay.className =
      "fixed inset-0 z-[160] flex items-center justify-center p-4 " +
      "bg-black/30 backdrop-blur-sm opacity-0 transition-opacity duration-200";

    // کارت وسط صفحه
    const card = document.createElement("div");
    card.className =
      `relative w-full max-w-sm sm:max-w-md rounded-2xl bg-white/95 backdrop-blur-md ` +
      `shadow-2xl ring-1 ${p.ring} transform scale-95 opacity-0 transition-all duration-200`;

    // محتوای کارت
    const inner = document.createElement("div");
    inner.className = "px-5 py-4 flex items-start gap-3 text-slate-900";

    const icon = document.createElement("i");
    icon.className = `${p.ico} ${p.icon} text-xl mt-0.5`;

    const msg = document.createElement("div");
    msg.className = "text-[14px] leading-7 font-bold";
    msg.textContent = translate(message);

    const closeBtn = document.createElement("button");
    closeBtn.type = "button";
    closeBtn.setAttribute("aria-label", "بستن");
    closeBtn.className =
      "absolute top-2 left-2 w-9 h-9 rounded-full text-slate-500 " +
      "hover:text-slate-700 hover:bg-slate-100 flex items-center justify-center";
    closeBtn.innerHTML = "&times;";

    inner.append(icon, msg);
    card.append(closeBtn, inner);
    overlay.append(card);
    document.body.appendChild(overlay);

    // انیمیشن نمایش
    requestAnimationFrame(() => {
      overlay.classList.remove("opacity-0");
      card.classList.remove("scale-95", "opacity-0");
    });

    // بستن با انیمیشن
    const remove = () => {
      overlay.classList.add("opacity-0");
      card.classList.add("scale-95", "opacity-0");
      setTimeout(() => overlay.remove(), 200);
      document.removeEventListener("keydown", onKey);
    };
    const onKey = (e) => { if (e.key === "Escape") remove(); };

    document.addEventListener("keydown", onKey);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) remove(); });
    closeBtn.addEventListener("click", (e) => { e.stopPropagation(); remove(); });

    // زمان‌بندی خودکار + توقف با Hover
    let timer = setTimeout(remove, durationMs);
    overlay.addEventListener("mouseenter", () => clearTimeout(timer));
    overlay.addEventListener("mouseleave", () => {
      timer = setTimeout(remove, 1200);
    });
  };

  // فارسی‌سازی Tooltip دکمه‌ی ارسال نظر در حالت محدودیت روزانه
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("submit-review");
    if (!btn) return;
    const apply = () => {
      if (/You can submit one review per day/i.test(btn.title || "")) {
        btn.title = "روزانه فقط یک نظر می‌توانید ثبت کنید.";
      }
    };
    apply();
    new MutationObserver(apply).observe(btn, { attributes: true, attributeFilter: ["title"] });
  });
})();
</script>






<script>
/* ===== Portfolio Likes (server-based) ===== */
(function(){
  'use strict';
  const API_BASE = (window.API_BASE || '').replace(/\/+$/, '');
  const isLoggedIn = () => { try { return !!JSON.parse(localStorage.getItem('auth_user')||'null'); } catch(_) { return false; } };
  const toFa = n => String(n ?? 0).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);

  const likeCache = new Map(); // id -> {liked, count}

  function updateUI(id){
    const state = likeCache.get(id) || { liked:false, count:0 };
    document.querySelectorAll(`.portfolio-card[data-item-id="${id}"]`).forEach(card=>{
      const wrap = card.querySelector('.fa-heart')?.parentElement;
      const icon = wrap?.querySelector('.fa-heart');
      const cnt  = wrap?.querySelector('span');
      if(!wrap||!icon||!cnt) return;
      icon.classList.toggle('far', !state.liked);
      icon.classList.toggle('fas', state.liked);
      wrap.classList.toggle('text-red-500', state.liked);
      cnt.textContent = toFa(state.count);
      wrap.setAttribute('role','button');
      wrap.setAttribute('tabindex','0');
      wrap.setAttribute('aria-pressed', state.liked ? 'true' : 'false');
      wrap.title = state.liked ? 'لغو لایک' : 'پسندیدن';
    });

    if(window.__PF_ACTIVE_ID===id){
      const mWrap  = document.querySelector('#imageModal .fa-heart')?.parentElement;
      const mIcon  = mWrap?.querySelector('.fa-heart');
      const mLikes = document.getElementById('modalLikes');
      if(mWrap && mIcon && mLikes){
        mIcon.classList.toggle('far', !state.liked);
        mIcon.classList.toggle('fas', state.liked);
        mWrap.classList.toggle('text-red-500', state.liked);
        mLikes.textContent = toFa(state.count);
        mWrap.setAttribute('aria-pressed', state.liked ? 'true' : 'false');
        mWrap.title = state.liked ? 'لغو لایک' : 'پسندیدن';
      }
    }
  }

  async function toggle(id){
    if(!isLoggedIn()){
      if(typeof window.showToastDark === 'function') showToastDark('برای لایک ابتدا وارد شوید', {type:'info'});
      return;
    }
    const prev = likeCache.get(id) || { liked:false, count:0 };
    const optimistic = { liked: !prev.liked, count: prev.count + (prev.liked ? -1 : 1) };
    likeCache.set(id, optimistic);
    updateUI(id);
    try{
      const res = await fetch(`${API_BASE}/api/portfolio/${id}/like`, {
        method:'POST',
        credentials:'include'
      });
      const data = await res.json();
      if(res.ok){
        likeCache.set(id, { liked: data.liked, count: data.likeCount });
      } else {
        likeCache.set(id, prev);
      }
    }catch(_){ likeCache.set(id, prev); }
    updateUI(id);
  }

  function bind(card){
    const id = card.dataset.itemId;
    if(!id || card.dataset.likeBound) return;
    card.dataset.likeBound = '1';
    const wrap = card.querySelector('.fa-heart')?.parentElement;
    if(!wrap) return;
    wrap.addEventListener('click', e=>{ e.preventDefault(); toggle(id); });
    wrap.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(id); }});
  }

  function init(ev){
    const items = ev?.detail?.items || [];
    items.forEach(it => likeCache.set(it.id, { liked: !!it.liked, count: it.likes }));
    document.querySelectorAll('.portfolio-card').forEach(card=>{
      bind(card);
      const id = card.dataset.itemId;
      if(id && likeCache.has(id)) updateUI(id);
    });
    const mWrap = document.querySelector('#imageModal .fa-heart')?.parentElement;
    if(mWrap && !mWrap.dataset.likeBound){
      mWrap.dataset.likeBound = '1';
      mWrap.style.cursor = 'pointer';
      mWrap.addEventListener('click', e=>{ e.preventDefault(); if(window.__PF_ACTIVE_ID) toggle(window.__PF_ACTIVE_ID); });
      mWrap.addEventListener('keydown', e=>{ if((e.key==='Enter'||e.key===' ') && window.__PF_ACTIVE_ID){ e.preventDefault(); toggle(window.__PF_ACTIVE_ID); }});
    }
  }

  window.__PF_SET_ACTIVE_ID = function(id){
    window.__PF_ACTIVE_ID = id;
    if(id) updateUI(id);
  };
  window.__getPortfolioLikes = id => (likeCache.get(id)?.count ?? 0);

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
  document.addEventListener('portfolio:rendered', init);
})();
</script>


<script>
// Lazy load background images with better error handling
document.addEventListener('DOMContentLoaded', () => {
  const lazyBackgrounds = document.querySelectorAll('.lazy-bg');
  
  if ('IntersectionObserver' in window) {
    const bgObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const bg = entry.target;
          const bgUrl = bg.dataset.bg;
          
          // Preload image first
          const img = new Image();
          img.onload = () => {
            bg.style.backgroundImage = `url(${bgUrl})`;
            bg.classList.remove('lazy-bg');
            bg.classList.add('loaded');
          };
          img.onerror = () => {
            console.error('Failed to load background image:', bgUrl);
            bg.classList.add('load-error');
          };
          img.src = bgUrl;
          
          bgObserver.unobserve(bg);
        }
      });
    }, {
      rootMargin: '50px 0px',
      threshold: 0.01
    });
    
    lazyBackgrounds.forEach(bg => bgObserver.observe(bg));
  } else {
    // Fallback for older browsers
    lazyBackgrounds.forEach(bg => {
      bg.style.backgroundImage = `url(${bg.dataset.bg})`;
    });
  }
});
</script>

<script>
// Performance monitoring
window.addEventListener('load', () => {
  if ('performance' in window && 'measureUserAgentSpecificMemory' in performance) {
    const perfData = performance.getEntriesByType('navigation')[0];
    
    // Log performance metrics
    console.log('Performance Metrics:', {
      domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
      loadComplete: perfData.loadEventEnd - perfData.loadEventStart,
      domInteractive: perfData.domInteractive,
      firstPaint: performance.getEntriesByName('first-paint')[0]?.startTime
    });
    
    // Warn if page load is slow
    if (perfData.loadEventEnd - perfData.fetchStart > 3000) {
      console.warn('Page load time exceeds 3 seconds. Consider optimizing resources.');
    }
  }
});
</script>


<!-- ==== VENDOR SERVICES (bind to your backend) – START ==== -->
<script>
(() => {
  'use strict';

  /** ================== Config & Helpers ================== **/
  const API_ROOT = window.__API_BASE__ || '';
  const TOKEN_KEYS = ['access_token', 'token', 'jwt'];
  const clearToken = () => TOKEN_KEYS.forEach(k => localStorage.removeItem(k));
  // اگر توکن رو جای دیگه می‌ذاری، این تابع رو تغییر بده
  function getToken() {
    let t = null;
    for (const k of TOKEN_KEYS) {
      const val = localStorage.getItem(k);
      if (val) { t = val; break; }
    }
    if (!t) return null;
    try {
      const payload = JSON.parse(atob(t.split('.')[1] || ''));
      if (payload.exp * 1000 < Date.now()) {
        clearToken();
        return null;
      }
    } catch (_) {
      clearToken();
      return null;
    }
    return t;
  }
  const authHeaders = () => {
    const t = getToken();
    return t ? { 'Authorization': 'Bearer ' + t } : {};
  };
  const toFa = s => String(s).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
  const priceFa = n => (Number(n)||0).toLocaleString('fa-IR');
  const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));

  function toast(msg, type='info') {
    if (typeof showToastDark === 'function') showToastDark(msg, {type});
    else alert(msg);
  }

  // دریافت shopurl از پارامترها؛ در صورت نبودن، تلاش برای تبدیل sellerId به shopurl
  async function getShopUrlFromLocation() {
    const u = new URL(location.href);
    const q = u.searchParams.get('shopurl');
    if (q) return q.trim();

    const sid = u.searchParams.get('sellerId');
    if (!sid) return '';

    try {
      const res = await fetch(`${API_ROOT}/api/shopAppearance/${encodeURIComponent(sid)}`);
      if (!res.ok) throw new Error('appearance not found');
      const data = await res.json();
      return data.customUrl ? data.customUrl.trim() : '';
    } catch (err) {
      console.error('get shopurl by sellerId failed', err);
      return '';
    }
  }

  function show404() {
    document.body.innerHTML = '<h1 class="text-center mt-10 text-2xl">404 - فروشگاه یافت نشد</h1>';
  }

  // نزدیک‌ترین کانتینر «خدمات ما»
  function findServicesContainer() {
    const headings = Array.from(document.querySelectorAll('section h3'));
    const h = headings.find(el => (el.textContent || '').trim().includes('خدمات ما'));
    if (!h) return null;
    const sec = h.closest('section');
    if (!sec) return null;
    // کانتینر اسکرولی که قبلاً داشتی
    const c = sec.querySelector('.scroll-container');
    return c || null;
  }

  // باز کردن ویزارد رزرو
  function bindReserveClicks(container) {
    if (!container) return;
    container.addEventListener('click', (e) => {
      const btn = e.target.closest('.service-button');
      if (!btn) return;
      e.preventDefault();
      const prefill = { service: btn.dataset.service, price: btn.dataset.price };
      if (typeof window.openBookingWizard === 'function') {
        window.openBookingWizard(prefill);
      } else {
        toast('بخش رزرو در این صفحه پیدا نشد', 'info');
      }
    });
  }

  /** ================== API calls ================== **/
  async function apiGetPublic(shopurl) {
    const res = await fetch(`${API_ROOT}/api/seller-services/by-shopurl/${encodeURIComponent(shopurl)}`, {
      credentials: 'include'
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json(); // { items, sellerId }
  }

  async function apiGetSeller(shopurl) {
    const res = await fetch(`${API_ROOT}/api/sellers/by-shopurl/${encodeURIComponent(shopurl)}`, { credentials: 'include' });
    if (!res.ok) throw new Error('seller not found');
    return res.json();
  }

function updateSellerProfile(seller) {
  // Helper function to create brief address
  const getBriefAddress = (fullAddress) => {
    if (!fullAddress) return 'آدرس کسب‌وکار';
    // Split address by common delimiters
    const parts = fullAddress.split(/[،,-]/);
    if (parts.length >= 2) {
      // Return first two parts (usually street and area)
      return parts.slice(0, 2).join('، ').trim();
    } else if (fullAddress.length > 30) {
      // If address is too long, truncate it
      return fullAddress.substring(0, 30) + '...';
    }
    return fullAddress;
  };

  const mapping = {
    'page-title':   `${seller.storename || ''} | Vitreenet`,
    'seller-name':  seller.storename || '',
    'seller-category': seller.category || '',
    'seller-phone': seller.phone || '',
    'seller-address': seller.address || '',
    'store-phone':  seller.phone || '',
    'store-address': seller.address || '',
    'store-hours': seller.startTime && seller.endTime
      ? `از ${toFa(seller.startTime)} تا ${toFa(seller.endTime)}`
      : 'ساعات کاری ثبت نشده است',
    'biz-name':     seller.storename || '',
    'biz-tagline':  seller.desc || '',
    'full-address': seller.address || '',
    'modal-phone':  seller.phone || '',
    // Add header shop names
    'header-shop-name-mobile': seller.storename || '',
    'header-shop-name-md1': seller.storename || '',
    'header-shop-name-md2': seller.storename || '',
    'header-shop-name-lg': seller.storename || '',
    'footer-shop-name': seller.storename || '',
    // Add brief address for hero
    'hero-brief-address': getBriefAddress(seller.address)
  };
  
  for (const [id, text] of Object.entries(mapping)) {
    const el = document.getElementById(id);
    if (!el) continue;
    if (id === 'modal-phone') {
      el.textContent = text;
      el.href = text ? `tel:${text}` : '#';
    } else if (id === 'header-shop-name-mobile' || id === 'header-shop-name-lg') {
      // Also update the title attribute for these elements
      el.textContent = text;
      el.setAttribute('title', text);
    } else {
      el.textContent = text;
    }
  }

  // Handle footer image from seller data
  if (seller.footerImage || seller.brandingImage || seller.coverImage) {
    const imageUrl = seller.footerImage || seller.brandingImage || seller.coverImage;
    document.documentElement.style.setProperty('--footer-image', `url("${imageUrl}")`);

    // Apply to map container immediately if available
    const mapContainer = document.getElementById('map-container');
    if (mapContainer && imageUrl) {
      mapContainer.classList.add('footer-image-map');
      mapContainer.classList.remove('min-h-[200px]', 'bg-gray-200');
      mapContainer.innerHTML = `<img src="${imageUrl}" alt="تصویر برند فروشگاه">`;
    }
    
    const footerEl = document.getElementById('shop-footer-image');
    if (footerEl) footerEl.hidden = false;
  }

  const heroCall = document.getElementById('hero-call');
  if (heroCall) heroCall.href = seller.phone ? `tel:${seller.phone}` : '#';
}



// Fetch footer image from branding API
// Fetch footer image from branding API with better error handling
async function loadFooterImage(sellerId) {
  if (!sellerId) {
    console.log('No sellerId provided for footer image');
    return;
  }
  
  const mapContainer = document.getElementById('map-container');
  if (!mapContainer) {
    console.log('Map container not found');
    return;
  }
  
  try {
    console.log('Fetching footer image for seller:', sellerId);
    
    // Try the branding endpoint first
    const res = await fetch(`${API_ROOT}/api/branding/footer/${encodeURIComponent(sellerId)}`, {
      credentials: 'include'
    });
    
    let imageUrl = null;
    
    if (res.ok) {
      const data = await res.json();
      imageUrl = data.url || data.imageUrl || data.image;
      console.log('Footer image from branding API:', imageUrl);
    }
    
    // If no image from branding API, try to get it from seller data
    if (!imageUrl) {
      console.log('No image from branding API, trying seller data...');
      // Check if we already have footerImage from seller data
      const footerImageVar = getComputedStyle(document.documentElement).getPropertyValue('--footer-image');
      if (footerImageVar && footerImageVar !== 'none') {
        // Extract URL from CSS variable
        const match = footerImageVar.match(/url\(["']?(.+?)["']?\)/);
        if (match && match[1]) {
          imageUrl = match[1];
          console.log('Using footer image from seller data:', imageUrl);
        }
      }
    }
    
    // Apply the image if we have one
    if (imageUrl) {
      // Update CSS variable
      document.documentElement.style.setProperty('--footer-image', `url("${imageUrl}")`);

      // Update map container with the footer image
      mapContainer.classList.add('footer-image-map');
      mapContainer.classList.remove('min-h-[200px]', 'bg-gray-200');
      mapContainer.innerHTML = `<img src="${imageUrl}" alt="تصویر برند فروشگاه">`;

      // Show footer image element if exists
      const footerEl = document.getElementById('shop-footer-image');
      if (footerEl) footerEl.hidden = false;
      
      console.log('Footer image applied successfully');
    } else {
      console.log('No footer image available');
      // Show a nice placeholder
      mapContainer.innerHTML = `
        <div class="text-center">
          <i class="fas fa-store text-4xl text-gray-400 mb-2"></i>
          <p class="text-sm text-gray-500">تصویر برند فروشگاه</p>
        </div>
      `;
    }
  } catch (err) {
    console.error('Failed to load footer image:', err);
    // Show error state
    mapContainer.innerHTML = `
      <div class="text-center">
        <i class="fas fa-image text-3xl text-gray-400 mb-2"></i>
        <p class="text-sm text-gray-500">در حال بارگذاری تصویر...</p>
      </div>
    `;
  }
}


// Debug function to check what's happening
window.debugFooterImage = function() {
  const mapContainer = document.getElementById('map-container');
  const footerImageVar = getComputedStyle(document.documentElement).getPropertyValue('--footer-image');
  const sellerId = document.body.dataset.sellerId;
  
  console.log('Debug Info:');
  console.log('- Map container exists:', !!mapContainer);
  console.log('- Map container classes:', mapContainer?.className);
  console.log('- Map container style:', mapContainer?.style.backgroundImage);
  console.log('- CSS variable --footer-image:', footerImageVar);
  console.log('- Seller ID:', sellerId);
  console.log('- API_ROOT:', window.__API_BASE__ || '');
}


  /** ================== Render ================== **/
function cardTemplate(item) {
  const img = Array.isArray(item.images) && item.images.length
    ? item.images[Math.max(0, Math.min(item.mainImageIndex || 0, item.images.length - 1))]
    : `https://picsum.photos/seed/${encodeURIComponent(item.title || 'svc')}/800/600.jpg`;

  // قیمت/تخفیف
  const offPct     = Number(item.discountPercent ?? item.offPercent ?? item.discount ?? 0) || 0;
  const hasOff     = offPct > 0 && Number(item.price) > 0;
  const basePrice  = Number(item.finalPrice ?? item.price ?? 0);
  const finalPrice = hasOff ? Math.max(0, Math.round((item.price || 0) * (100 - offPct) / 100)) : basePrice;

  // امتیاز
  const rating      = Number(item.ratingAvg ?? item.rating ?? 0) || null;
  const ratingCount = Number(item.reviewCount ?? item.ratingCount ?? 0) || 0;

  // کپشن بدون تکرار
  const title   = (item.title || '').trim();
  const descRaw = (item.desc  || '').trim();
  const norm    = s => s.toString().trim().replace(/\s+/g, ' ').toLowerCase();
  const showDesc = !!descRaw && norm(descRaw) !== norm(title) && descRaw.length >= 12;

  return `
  <article
    class="service-card group relative flex-shrink-0 w-[90vw] xs:w-[86vw] sm:w-72 md:w-80 bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 snap-start"
    data-svc-id="${item._id}"
  >
    <!-- تصویر + اورلی تخفیف -->
    <div class="relative overflow-hidden">
      <img src="${img}" alt="${title}" loading="lazy" decoding="async"
           class="w-full aspect-[4/3] object-cover transition-transform duration-500 group-hover:scale-105" />
      <div class="absolute inset-0 bg-gradient-to-t from-black/55 via-black/10 to-transparent pointer-events-none"></div>

      <div class="absolute top-2 left-2 flex gap-2">
        ${hasOff ? `<span class="rounded-full bg-rose-600/95 text-white text-[11px] px-2 py-1">${toFa(offPct)}٪ تخفیف</span>` : ``}
        ${item.badge ? `<span class="rounded-full bg-emerald-600/95 text-white text-[11px] px-2 py-1">${item.badge}</span>` : ``}
      </div>
      <!-- ⛔️ عنوان روی تصویر حذف شد تا تکرار نشه -->
    </div>

    <!-- کپشن -->
    <div class="p-4 flex flex-col gap-3">
      <!-- ردیف عنوان + امتیاز -->
      <div class="flex items-center justify-between gap-3">
        <h4 class="font-extrabold text-[16px] sm:text-[17px] md:text-lg text-gray-900 line-clamp-1">${title || '—'}</h4>
        <div class="flex items-center gap-1 text-[12px] ${rating ? '' : 'hidden'}" aria-label="امتیاز ${rating || 0}">
          <svg class="w-[14px] h-[14px] text-amber-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
          <span class="text-gray-700">${(rating || 0).toFixed(1).replace('.', '٫')}</span>
          <span class="text-gray-500">(${toFa(ratingCount)})</span>
        </div>
      </div>

      ${showDesc ? `<p class="text-[13px] sm:text-[14px] text-gray-600 leading-6 line-clamp-2">${descRaw}</p>` : ''}

      <!-- ردیف قیمت / رزرو -->
      <div class="mt-1 grid grid-cols-[1fr_auto] items-center gap-4">
        <div class="min-w-0">
          <div class="flex items-baseline gap-1">
            <span class="service-price text-[19px] sm:text-[20px] font-extrabold tracking-tight text-gray-900">
              <span class="price-view">${priceFa(finalPrice)}</span>
            </span>
            <span class="service-currency text-[12px] sm:text-[13px] text-gray-500">تومان</span>
          </div>
          <div class="text-[11px] sm:text-[12px] text-rose-600 ${hasOff ? '' : 'hidden'}">
            <s class="text-gray-400">${priceFa(item.price || 0)}</s><span class="ml-1">– ${toFa(offPct)}٪</span>
          </div>
        </div>

        <!-- دکمه رزرو (بدون آیکن، سایز لمسی) -->
        <button
          class="service-button cta-button inline-flex items-center justify-center text-white font-bold py-3 sm:py-3.5 px-6 sm:px-7 rounded-full text-[14px] sm:text-[15px] leading-none whitespace-nowrap transition-all ${item.isActive ? '' : 'opacity-40 pointer-events-none'}"
          data-service="${title}" data-price="${finalPrice || 0}" aria-label="رزرو ${title}"
        >
          رزرو
        </button>
      </div>
    </div>
  </article>`;
}






  /** ================== Bootstrap ================== **/
  const servicesContainer = findServicesContainer();
  bindReserveClicks(servicesContainer);

  let LAST_PUBLIC = { items: [], sellerId: null };
  // expose to global scope for booking scripts
  window.LAST_PUBLIC = LAST_PUBLIC;

  function renderList() {
    if (!servicesContainer) return;
    servicesContainer.innerHTML = '';
    if (!LAST_PUBLIC.items || LAST_PUBLIC.items.length === 0) {
      servicesContainer.innerHTML = `
        <div class="w-full text-center text-gray-500 py-8">
          فعلاً سرویسی ثبت نشده است.
        </div>`;
      return;
    }

    // مرتب‌سازی: فعال‌ها اول، بعد قیمت صعودی
    const sorted = [...LAST_PUBLIC.items].sort((a,b) => {
      if (!!b.isActive - !!a.isActive) return (!!b.isActive - !!a.isActive);
      if ((a.price||0) !== (b.price||0)) return (a.price||0) - (b.price||0);
      return (a.createdAt||'') < (b.createdAt||'') ? 1 : -1;
    });

    sorted.forEach(item => {
      if (!item.isActive) return;
      servicesContainer.insertAdjacentHTML('beforeend', cardTemplate(item));
    });
  }

async function renderAll() {
  const shopurl = await getShopUrlFromLocation();
  if (!shopurl) { show404(); return; }

  try {
    const [data, seller] = await Promise.all([
      apiGetPublic(shopurl),
      apiGetSeller(shopurl)
    ]);

LAST_PUBLIC = data; // { items, sellerId }
window.LAST_PUBLIC = LAST_PUBLIC; // keep global in sync
updateSellerProfile(seller);

// ensure sellerId is available for later requests
document.body.dataset.sellerId = data.sellerId || seller._id || seller.id;

// Store seller data for s-profile.html navigation
localStorage.setItem('seller', JSON.stringify({
  ...seller,
  sellerId: data.sellerId || seller._id || seller.id
}));
    
    
    // Load footer image using sellerId
    if (data.sellerId || seller._id || seller.id) {
      await loadFooterImage(data.sellerId || seller._id || seller.id);
    }
    
    renderList();
    document.dispatchEvent(new CustomEvent('services:loaded', { detail: data.items || [] }));
  } catch (err) {
    console.error('Load public services failed', err);
    show404();
  }
}

  document.addEventListener('DOMContentLoaded', renderAll);
})();
</script>
<!-- ==== VENDOR SERVICES – END ==== -->


<script>
(() => {
  'use strict';

  // ---------- Helpers ----------
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const toFa = n => String(n ?? 0).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);

  // shop slug from URL (?shopurl=, ?shop=, ?seller=)
  function getShopSlug() {
    const u = new URL(location.href);
    return (u.searchParams.get('shopurl') || u.searchParams.get('shop') || u.searchParams.get('seller') || '').trim();
  }

  // API base (optional global). Falls back to same origin.
  const API_BASE = (window.API_BASE || '').replace(/\/+$/, '');
  const SLUG = getShopSlug();

  // Candidate endpoints to be compatible with new backend & s-seller-panel.js
  // The first "ok & non-empty" wins. You can prune once your final route is fixed.
  const CANDIDATES = [
    `${API_BASE}/api/portfolio/public/${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/portfolio?shopurl=${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/service-portfolio/public/${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/seller-portfolio/public/${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/portfolios/public/${encodeURIComponent(SLUG)}`,
  ];

  // Normalize backend item to UI model
  function normalize(item) {
    const img = item.image || item.cover || (item.images?.[0]?.url || item.images?.[0]) || '';
    return {
      id:      item._id || item.id || crypto.randomUUID?.() || ('pf_' + Math.random().toString(36).slice(2)),
      title:   item.title || item.name || '—',
      desc:    item.description || item.desc || '',
      image:   img,
      views:   item.views ?? item.viewCount ?? 0,
      likes:   item.likeCount ?? item.likes ?? 0,
      liked:   !!item.liked,
      created: item.createdAt || item.updatedAt || null
    };
  }

  async function tryFetch(url) {
    const r = await fetch(url, { credentials: 'include' });
    if (!r.ok) return null;
    const data = await r.json().catch(()=>null);
    const list = Array.isArray(data) ? data : (data?.items || data?.data || data?.results || []);
    return Array.isArray(list) ? list : null;
  }

  function getLocalPortfolio() {
    try {
      const raw = localStorage.getItem('vit_portfolio');
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr.map(normalize) : [];
    } catch (_) {
      return [];
    }
  }

  async function loadPortfolio() {
    if (!SLUG) return getLocalPortfolio();
    for (const url of CANDIDATES) {
      try {
        const items = await tryFetch(url);
        if (items && items.length) return items.map(normalize);
      } catch (_) {}
    }
    return getLocalPortfolio();
  }

  // ---------- Rendering ----------
  const grid = $('#portfolio-grid');
  const row  = $('#portfolio-row');
  const emptyMsg = $('#portfolio-empty');
  const loading  = $('#portfolio-loading');
  const tpl = $('#tpl-portfolio-card');

  function createCard(it) {
    const node = tpl.content.firstElementChild.cloneNode(true);

    const imgEl   = node.querySelector('.portfolio-img');
    const titleEl = node.querySelector('.portfolio-name');
    const descEl  = node.querySelector('.portfolio-description');
    const vEl     = node.querySelector('.js-views');
    const lEl     = node.querySelector('.js-likes');
    const btn     = node.querySelector('.js-open');

    titleEl.textContent = it.title || '—';
    descEl.textContent  = it.desc || '';
    vEl.textContent     = toFa(it.views);
    lEl.textContent     = toFa(it.likes);

    // Lazy: use data-src; real load by IntersectionObserver
    imgEl.alt = it.title || '';
    imgEl.dataset.src = it.image || '';
    imgEl.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='; // 1x1
    node.dataset.itemId = it.id;
    const hWrap = node.querySelector('.fa-heart')?.parentElement;
    const hIcon = hWrap?.querySelector('.fa-heart');
    if(hWrap && hIcon && it.liked){
      hIcon.classList.remove('far');
      hIcon.classList.add('fas');
      hWrap.classList.add('text-red-500');
    }

    btn.addEventListener('click', () => openImageModal(it));

    return node;
  }

function render(items) {
  // clear
  row.innerHTML = '';
  grid.innerHTML = '';
  if (!items.length) {
    emptyMsg.classList.remove('hidden');
    return;
  }
  emptyMsg.classList.add('hidden');
  // mobile row
  items.forEach(it => row.appendChild(createCard(it)));
  // desktop grid - create separate cards for desktop to avoid duplication
  items.forEach(it => grid.appendChild(createCard(it)));
  // DON'T show grid here - let CSS handle it
  // grid.classList.remove('hidden'); // Remove this line
  // start lazy load
  lazyLoadImages();
}

  // ---------- Lazy Loading ----------
  function lazyLoadImages() {
    const imgs = $$('#portfolio .portfolio-img');
    if (!('IntersectionObserver' in window)) {
      imgs.forEach(img => { if (img.dataset.src) img.src = img.dataset.src; });
      return;
    }
    const io = new IntersectionObserver((entries, obs) => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          const img = e.target;
          const src = img.dataset.src;
          if (src) {
            img.src = src;
            img.removeAttribute('data-src');
          }
          obs.unobserve(img);
        }
      });
    }, { rootMargin: '120px' });
    imgs.forEach(img => io.observe(img));
  }

  // ---------- Image Modal ----------
  const imageModal = $('#imageModal');
  const imageEl    = $('#modalImage');
  const titleEl    = $('#modalTitle');
  const mViews     = $('#modalViews');
  const mLikes     = $('#modalLikes');
  const closeBtn   = $('#imageModalClose');
  const modalContent = imageModal?.querySelector('.relative');

  function openImageModal(it) {
    if (!imageModal) return;
    titleEl.textContent = it.title || '';
    imageEl.src = it.image || '';
    imageEl.alt = it.title || '';
    mViews.textContent = toFa(it.views ?? 0);
    const curLikes = typeof window.__getPortfolioLikes === 'function' ? window.__getPortfolioLikes(it.id) : (it.likes ?? 0);
    mLikes.textContent = toFa(curLikes);
    window.__PF_SET_ACTIVE_ID?.(it.id);
    imageModal.classList.remove('hidden');
    imageModal.classList.add('flex');
    modalContent?.classList.remove('scale-95','opacity-0');
    modalContent?.classList.add('scale-100','opacity-100');
    document.addEventListener('keydown', onEsc);
  }

  function closeImageModal() {
    modalContent?.classList.add('scale-95','opacity-0');
    modalContent?.classList.remove('scale-100','opacity-100');
    imageModal.classList.add('hidden');
    imageModal.classList.remove('flex');
    imageEl.src = '';
    document.removeEventListener('keydown', onEsc);
  }

  function onEsc(e) { if (e.key === 'Escape') closeImageModal(); }

  closeBtn?.addEventListener('click', closeImageModal);
  imageModal?.addEventListener('click', e => { 
    if (e.target === imageModal) closeImageModal();
  });

  // ---------- Public refresh hook (optional) ----------
  // اگر پنل فروشنده بعد از ثبت نمونه‌کار event بزنه، این صفحه رفرش می‌شود:
  // document.dispatchEvent(new Event('portfolio:refresh'))
  document.addEventListener('portfolio:refresh', async () => {
    loading?.classList.remove('hidden');
    const items = await loadPortfolio();
    render(items);
    document.dispatchEvent(new CustomEvent('portfolio:rendered', { detail: { items } }));
    loading?.classList.add('hidden');
  });

  // ---------- Boot ----------
  (async () => {
    try {
      const items = await loadPortfolio();
      render(items);
      document.dispatchEvent(new CustomEvent('portfolio:rendered', { detail: { items } }));
    } finally {
      loading?.classList.add('hidden');
    }
})();
})();
</script>

<script src="booking-status-popup.js"></script>

<script>
(function () {
  // 1) تزریق shopurl / sellerId از URL به دیتاستِ بدنه
  const params   = new URLSearchParams(location.search);
  const shopurl  = params.get('shopurl');
  const sellerId = params.get('sellerId');

  if (shopurl)  document.body.dataset.shopurl  = shopurl;
  if (sellerId) {
    document.body.dataset.sellerId = sellerId;
    document.body.dataset.storeId  = sellerId;
  }

  // 2) پری‌فیل سرویس برای ویزارد (اختیاری: اگر در URL بود)
  //     این کلید همونه که خود ویزارد داخلش انتخاب‌ها رو نگه می‌داره
  const SS_KEY    = 'vt:booking.sel';
  const service   = params.get('service');     // مثلا "اصلاح سر و صورت"
  const price     = params.get('price');       // مثلا 150000
  const serviceId = params.get('serviceId');   // اگر داری

  if (service || price || serviceId) {
    let cur = {};
    try { cur = JSON.parse(sessionStorage.getItem(SS_KEY) || '{}'); } catch(_) {}
    if (service)   cur.service   = decodeURIComponent(service);
    if (price)     cur.price     = parseInt(price, 10) || 0;
    if (serviceId) cur.serviceId = serviceId;
    try { sessionStorage.setItem(SS_KEY, JSON.stringify(cur)); } catch(_) {}
  }

  // 3) اگر با #booking-wizard اومدیم، به‌صورت ایمن ویزارد رو باز کن
  function bootWizardFromHash() {
    if (location.hash !== '#booking-wizard') return;

    // اولویت: از گارد داخلی استفاده کن (جلوگیری از رزرو در حالت pending)
    if (typeof window.openBookingWizard === 'function') {
      window.openBookingWizard(
        service ? { service: decodeURIComponent(service), price: parseInt(price || '0', 10) || undefined } : undefined
      );
      return;
    }

    // فالبک ساده: باز کردن سکشن و اسکرول
    const el = document.getElementById('booking-wizard');
    if (el) {
      el.classList.remove('hidden');
      const top = el.getBoundingClientRect().top + window.scrollY - 80;
      window.scrollTo({ top, behavior: 'smooth' });
    }
  }

  document.addEventListener('DOMContentLoaded', bootWizardFromHash);
  window.addEventListener('hashchange', bootWizardFromHash);
})();
</script>


</body>
</html>
