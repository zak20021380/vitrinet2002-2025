<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="page-title">â€” | Vitreenet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            font-family: 'Vazirmatn', sans-serif;
        }
        :root {
            --footer-image: none;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .service-card {
            scroll-snap-align: start;
        }
        .review-card {
            scroll-snap-align: start;
        }
        .portfolio-card {
            scroll-snap-align: start;
        }
        .scroll-container {
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        .scroll-container::-webkit-scrollbar {
            display: none;
        }
        .bounce-animation {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        .progress-animation {
            animation: progress 2s ease-out;
        }
        @keyframes progress {
            0% {
                width: 0%;
            }
        }
        .premium-icon {
            transition: all 0.3s ease;
        }
        .premium-icon:hover {
            filter: drop-shadow(0 0 6px #3B82F6);
            transform: scale(1.1);
        }
        .badge-minimal {
            font-size: 0.65rem;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;
        }
        .scrollbar-hide {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Header Animations */
        .logo-animation {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .logo-animation:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.6));
        }
        .header-item {
            transition: all 0.2s ease;
        }
        .header-item:hover {
            transform: translateY(-2px);
        }
        .status-chip {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        .mobile-menu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .mobile-menu.active {
            max-height: 500px;
        }
        /* Service Card Styles */
        .service-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .service-price {
            font-size: 1.5rem;
            font-weight: 900;
            color: #1e40af;
        }
        .service-currency {
            font-size: 0.9rem;
            font-weight: 500;
            color: #64748b;
        }
        .service-button {
            background: linear-gradient(135deg, #06b6d4, #3b82f6, #10b981);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .service-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            transition: left 0.5s ease;
        }
        .service-button:hover::before {
            left: 100%;
        }
        .service-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
        }
        .service-button:active {
            transform: translateY(0) scale(0.98);
        }
        .cta-button {
            background: linear-gradient(135deg, #06b6d4, #3b82f6, #10b981);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .cta-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            transition: left 0.5s ease;
        }
        .cta-button:hover::before {
            left: 100%;
        }
        .cta-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
        }
        .cta-button:active {
            transform: translateY(0) scale(0.98);
        }
        
        /* Portfolio Section Styles */
        .portfolio-section {
            padding: 3rem 1rem;
            background: linear-gradient(to bottom, #f9fafb, #ffffff);
        }
        .portfolio-title {
            text-align: center;
            font-size: 1.875rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 0.5rem;
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .portfolio-title::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            border-radius: 4px;
            margin: 0.75rem auto 0;
        }
        .portfolio-subtitle {
            text-align: center;
            color: #64748b;
            font-size: 1.125rem;
            margin-bottom: 2.5rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        .portfolio-card {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .portfolio-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }
        .portfolio-img-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem 1rem 0 0;
            height: 220px;
        }
        .portfolio-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        .portfolio-card:hover .portfolio-img {
            transform: scale(1.05);
        }
        .portfolio-content {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .portfolio-name {
            font-weight: 700;
            font-size: 1.25rem;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }
        .portfolio-description {
            color: #64748b;
            font-size: 0.9375rem;
            line-height: 1.6;
            flex-grow: 1;
            margin-bottom: 1.5rem;
        }
        .portfolio-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .portfolio-stat {
            display: flex;
            align-items: center;
            color: #64748b;
            font-size: 0.875rem;
        }
        .portfolio-stat i {
            margin-left: 0.25rem;
        }
        .portfolio-btn {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            width: fit-content;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            margin-top: auto;
        }
        .portfolio-btn:hover {
            background: linear-gradient(135deg, #2563eb, #0891b2);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
        }
        .portfolio-btn:active {
            transform: translateY(0);
        }
        
        /* Modal Styles */
        #imageModal {
            transition: all 0.3s ease;
        }
        #imageModal .relative {
            transition: all 0.3s ease;
            transform: scale(0.95);
            opacity: 0;
        }
        #imageModal .scale-100 {
            transform: scale(1);
        }
        #imageModal .opacity-100 {
            opacity: 1;
        }
        #imageModal .scale-95 {
            transform: scale(0.95);
        }
        #imageModal .opacity-0 {
            opacity: 0;
        }
        
        /* Line clamp for description text */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* mobile nav */
        @media (max-width: 768px) {
            .hide-on-mobile { display: none !important; }
        }
        ::-webkit-scrollbar {width: 7px;}
        ::-webkit-scrollbar-thumb {background: #c8f7e6;}
        @media (max-width: 640px) {
            body { padding-bottom: 72px; }
            footer:not(.mobile-nav) { display: none; }
            .mobile-nav {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 72px;
                background: rgba(255,255,255,0.96);
                backdrop-filter: blur(12px);
                border-top: 1px solid rgba(224,242,254,0.8);
                border-radius: 24px 24px 0 0;
                box-shadow: 0 -5px 25px rgba(0,0,0,0.08);
                z-index: 100;
                padding: 8px 0;
            }
            .nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: #94a3b8;
                transition: all 0.2s;
                border-radius: 12px;
                padding: 6px 0;
            }
            .nav-item.active {
                color: #10b981;
                transform: translateY(-4px);
            }
            .nav-item:active { transform: scale(0.92); }
            .nav-icon {
                width: 24px;
                height: 24px;
                margin-bottom: 4px;
            }
            .nav-label {
                font-size: 11px;
                font-weight: 800;
            }
        }
        
/* --- Chips & Dialog (new) --- */
.chip {
  height: 36px;
  padding: 0 12px;
  border-radius: 9999px;
  font-weight: 800;
  font-size: 12px;
  background: rgba(255,255,255,0.82);
  color: #374151; /* gray-700 */
  border: 1px solid rgba(255,255,255,0.6);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  box-shadow: 0 4px 14px rgba(59,130,246,0.08);
  transition: all .2s ease;
  display: inline-flex; align-items: center; gap: 6px;
}
.chip:hover { background: #fff; box-shadow: 0 8px 22px rgba(59,130,246,0.14); }
.chip:active { transform: scale(0.98); }

.chip--primary {
  color: #fff;
  background: linear-gradient(135deg,#3B82F6,#06B6D4);
  border: none;
  box-shadow: 0 6px 20px rgba(59,130,246,0.28);
}
.chip--primary:hover { filter: brightness(0.98); }


.dialog-card-enter { transform: scale(0.96); opacity: 0; }
.dialog-card-show  { transform: scale(1);    opacity: 1; transition: all .18s ease; }


        
    </style>
</head>
<body class="bg-gray-50 text-gray-800" data-seller-id="123" data-shopurl="demo-shop">
    <!-- Sticky Header -->
    <!-- header desktop redesign start -->
<!-- header desktop redesign start -->
<!-- ===== Clean, Responsive Header (no "Ø¨Ø§Ø² Ø§Ø³Øª") ===== -->
<header id="main-header" class="sticky top-0 z-[90] isolate bg-white/95 md:bg-white/70 md:backdrop-blur-lg border-b border-slate-200/70 shadow-sm transition-all duration-300">
  <!-- hairline -->
  <div aria-hidden="true" class="h-[2px] w-full bg-gradient-to-l from-cyan-400 via-blue-500 to-purple-500 opacity-70"></div>

  <!-- ========== Mobile ========== -->
  <div id="mobile-header" class="md:hidden px-3">
    <div id="mobile-top" class="flex items-center justify-between h-14 py-2">
      <!-- Right: Brand -->
      <a href="/index.html" class="flex items-center gap-2 font-extrabold text-[15px] text-blue-600 tracking-tight select-none">
        <span class="leading-none">ÙˆÛŒØªØ±ÛŒÙ†Øª</span>
      </a>

      <!-- Center: Shop title -->
      <h1 id="header-shop-name-mobile"
          class="flex-1 mx-2 min-w-0 text-center text-[14px] sm:text-[15px] font-black text-slate-900 truncate"
          title="Ù†Ø§Ù… ÙØ±ÙˆØ´Ú¯Ø§Ù‡">
        Ù†Ø§Ù… ÙØ±ÙˆØ´Ú¯Ø§Ù‡
      </h1>

      <!-- Left: Address + Report -->
      <div class="flex items-center gap-1.5 flex-shrink-0">
        <button id="mobile-address-chip" data-open="addressModal" aria-label="Ø¢Ø¯Ø±Ø³"
                class="h-9 px-3 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 active:scale-95 transition text-[12px] font-bold text-slate-800 flex items-center gap-1.5">
          <i class="fa-solid fa-location-dot text-blue-600"></i>
          <span class="max-[360px]:hidden">Ø¢Ø¯Ø±Ø³</span>
        </button>
        <button id="mobile-report-trigger" data-open="reportModal" aria-label="Ú¯Ø²Ø§Ø±Ø´"
                class="h-9 w-9 grid place-items-center rounded-lg border border-slate-200 bg-white hover:bg-slate-50 active:scale-95 transition">
          <i class="fa-regular fa-flag text-blue-700 text-[13px]"></i>
        </button>
      </div>
    </div>

    <!-- keep stub for your scroll logic -->
    <div id="mobile-chips" class="hidden h-0 overflow-hidden"></div>
  </div>

  <!-- ========== Desktop / Large screens ========== -->
  <div class="hidden md:block">
    <div class="max-w-screen-xl mx-auto px-3 py-3">
      <div class="rounded-2xl bg-white/75 backdrop-blur border border-white/60 ring-1 ring-black/5 shadow-sm px-4 lg:px-6 py-2.5">
        <div class="flex items-center justify-between gap-3">
          <!-- Right: Brand (RTL) -->
          <a href="/index.html" class="flex items-center gap-2 font-extrabold text-lg lg:text-xl text-blue-600 tracking-tight flex-shrink-0">
            <span class="leading-none">ÙˆÛŒØªØ±ÛŒÙ†Øª</span>
          </a>

          <!-- Center: identity -->
          <div class="flex-1 min-w-0 flex items-center justify-center gap-3 text-sm">
            <h1 id="header-shop-name-lg"
                class="truncate font-black text-slate-900 max-w-[42vw] lg:max-w-[48vw]"
                title="Ù†Ø§Ù… ÙØ±ÙˆØ´Ú¯Ø§Ù‡">
              Ù†Ø§Ù… ÙØ±ÙˆØ´Ú¯Ø§Ù‡
            </h1>
            <span class="hidden sm:inline text-slate-300">Â·</span>
            <button id="desktop-address-chip" data-open="addressModal"
                    class="hidden sm:inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white/90 border border-slate-200 shadow-sm hover:bg-white text-[12px] text-slate-700">
              <i class="fa-solid fa-location-dot text-blue-600"></i>
              Ø¢Ø¯Ø±Ø³
            </button>
            <span class="hidden sm:inline text-slate-300">Â·</span>
            <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-amber-50 border border-amber-200 text-[12px] text-slate-800">
              <i class="fa-solid fa-star text-amber-400"></i>
              <span id="header-rating-lg" class="font-bold">0.0</span>
              <span class="text-slate-500">(<span id="header-count-lg">0</span>)</span>
            </span>
          </div>

          <!-- Left: report -->
          <button id="report-trigger" data-open="reportModal"
                  class="h-10 px-4 rounded-xl border border-slate-200 bg-white text-blue-700 font-bold hover:bg-slate-50 active:scale-95 transition flex-shrink-0">
            Ú¯Ø²Ø§Ø±Ø´
          </button>
        </div>
      </div>
    </div>
  </div>
</header>


<div id="seller-profile" class="max-w-4xl mx-auto p-4 text-center hidden">
  <h2 id="seller-name" class="text-2xl font-bold mb-2"></h2>
  <p id="seller-category" class="text-gray-600"></p>
  <p id="seller-phone" class="text-gray-600"></p>
  <p id="seller-address" class="text-gray-600"></p>
</div>





<!-- Address Modal (simple & clean) -->
<div id="addressModal" role="dialog" aria-modal="true" aria-labelledby="address-title"
     class="hidden fixed inset-0 z-[80] items-center justify-center">
  <!-- backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" data-close></div>

  <!-- card -->
  <div class="modal-card relative w-[92%] max-w-sm bg-white rounded-2xl shadow-xl p-5
              transform transition duration-150 scale-95 opacity-0">
    <!-- close -->
    <button type="button" data-close
            class="absolute top-2 left-2 text-gray-500 hover:text-gray-700 text-xl leading-none">
      &times;
    </button>

    <!-- title -->
    <div class="flex items-center gap-2 mb-3">
      <span class="inline-flex w-9 h-9 items-center justify-center rounded-xl
                   bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
        <!-- pin icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
      </span>
      <h2 id="address-title" class="text-base font-extrabold text-gray-900">Ø¢Ø¯Ø±Ø³</h2>
    </div>

    <!-- content -->
    <div class="space-y-3 text-[13px] sm:text-sm leading-7 text-gray-700">
      <div class="flex items-start gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mt-1 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <p id="full-address">â€”</p>

      </div>

      <div class="flex items-center gap-2 text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-emerald-600" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6.62 10.79a15.053 15.053 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24c1.11.37 2.3.57 3.58.57a1 1 0 011 1V20a1 1 0 01-1 1C10.07 21 3 13.93 3 5a1 1 0 011-1h3.5a1 1 0 011 1c0 1.28.2 2.47.57 3.58a1 1 0 01-.24 1.01l-2.21 2.2z"/>
        </svg>
        <a id="modal-phone" href="tel:" class="font-bold tracking-wide">â€”</a>

      </div>
    </div>

    <!-- actions -->
    <div class="mt-5 text-left">
      <button type="button" data-close
              class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold">
        Ø¨Ø³ØªÙ†
      </button>
    </div>
  </div>
</div>


<div id="reportModal" role="dialog" aria-modal="true" aria-labelledby="report-title"
     class="hidden fixed inset-0 z-[80] items-center justify-center">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" data-close></div>
  <div class="modal-card relative bg-white/80 backdrop-blur-xl border border-white/60 rounded-2xl shadow-lg p-6 w-11/12 max-w-md transform transition duration-150 scale-95 opacity-0">
    <h2 id="report-title" class="mb-4 text-lg font-bold bg-gradient-to-r from-blue-500/20 to-teal-400/20 p-2 rounded-xl text-center">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø´Ú©Ù„</h2>
    <form id="report-form" class="space-y-4">
      <div>
        <textarea id="report-text" maxlength="500" class="w-full min-h-[6rem] p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm resize-none" placeholder="Ù…Ø´Ú©Ù„ ÛŒØ§ Ø³ÙˆØ¡Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø±Ø§ ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯â€¦"></textarea>
        <div id="report-counter" class="text-xs text-gray-500 text-left mt-1">Û°/ÛµÛ°Û°</div>
      </div>
      <input id="report-contact" type="text" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
      <div class="flex justify-end gap-3">
        <button type="button" data-close class="px-4 py-2 rounded-full bg-white/80 hover:bg-white hover:shadow transition focus:outline-none focus:ring-2 focus:ring-blue-500">Ø§Ù†ØµØ±Ø§Ù</button>
        <button type="submit" class="px-4 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-500">Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´</button>
      </div>
    </form>
  </div>
</div>



<!-- Pending Booking Modal -->
<div id="pendingBookingModal" role="dialog" aria-modal="true" aria-labelledby="pb-title"
     class="hidden fixed inset-0 z-[120] items-center justify-center">
  <!-- backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" data-close></div>

  <!-- card -->
  <div class="modal-card relative w-[92%] max-w-sm bg-white rounded-2xl shadow-2xl p-6
              transform transition duration-150 scale-95 opacity-0">
    <!-- close -->
    <button type="button" data-close
            class="absolute top-2 left-2 text-gray-500 hover:text-gray-700 text-xl leading-none">
      &times;
    </button>

    <!-- header -->
    <div class="flex items-center gap-3 mb-4">
      <span class="inline-flex w-10 h-10 items-center justify-center rounded-xl
                   bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s-9-6-9-13a9 9 0 1118 0c0 7-9 13-9 13z"></path>
          <path d="M9 12l2 2 4-4"></path>
        </svg>
      </span>
      <div>
        <h3 id="pb-title" class="text-base font-extrabold text-gray-900">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øª Ø´Ø¯</h3>
        <p class="text-xs text-gray-500">Ù†ÙˆØ¨Øª Ø´Ù…Ø§ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø§Ø³Øª</p>
      </div>
    </div>

    <!-- details -->
    <div class="rounded-xl bg-gray-50 border border-gray-200 p-4 mb-4 text-sm">
      <div class="grid grid-cols-2 gap-y-2 gap-x-3">
        <div class="text-gray-600">Ø®Ø¯Ù…Øª</div>   <div id="pb-service" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">ØªØ§Ø±ÛŒØ®</div>   <div id="pb-date"    class="font-bold text-gray-800"></div>
        <div class="text-gray-600">Ø³Ø§Ø¹Øª</div>    <div id="pb-time"    class="font-bold text-gray-800"></div>
        <div class="text-gray-600">Ø´Ù…Ø§Ø±Ù‡ Ø´Ù…Ø§</div><div id="pb-phone"   class="font-bold text-gray-800 ltr-num"></div>
      </div>
    </div>

    <div class="flex items-start gap-2 text-xs text-gray-600 mb-5">
      <i class="fas fa-sms mt-0.5"></i>
      <span>Ø¯Ø± ØµÙˆØ±Øª ØªØ£ÛŒÛŒØ¯ØŒ Ù†ØªÛŒØ¬Ù‡ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù¾ÛŒØ§Ù…Ú© Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</span>
    </div>

    <!-- actions -->
    <div class="flex justify-end">
      <button type="button" data-close
              class="px-4 py-2 rounded-full bg-blue-600 text-white font-bold hover:bg-blue-700">
        Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…
      </button>
    </div>
  </div>
</div>




<!-- Block Booking While Pending (clean popup) -->
<div id="pendingBlockModal" role="dialog" aria-modal="true" aria-labelledby="pb-block-title"
     class="hidden fixed inset-0 z-[130] items-center justify-center">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" data-close></div>

  <div class="modal-card relative w-[92%] max-w-sm bg-white rounded-2xl shadow-2xl p-6
              transform transition duration-150 scale-95 opacity-0">
    <button type="button" data-close class="absolute top-2 left-2 text-gray-500 hover:text-gray-700 text-xl leading-none">&times;</button>

    <div class="flex items-center gap-3 mb-3">
      <span class="inline-flex w-10 h-10 items-center justify-center rounded-xl bg-gradient-to-tr from-amber-500 to-red-500 text-white">
        <i class="fas fa-hourglass-half"></i>
      </span>
      <div>
        <h3 id="pb-block-title" class="text-base font-extrabold text-gray-900">Ù„Ø·ÙØ§Ù‹ Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</h3>
        <p class="text-xs text-gray-500">Ù†ÙˆØ¨Øª Ù‚Ø¨Ù„ÛŒ Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø§Ø³Øª.</p>
      </div>
    </div>

    <div class="rounded-xl bg-gray-50 border border-gray-200 p-4 mb-4 text-sm">
      <div class="grid grid-cols-2 gap-y-2 gap-x-3">
        <div class="text-gray-600">Ø®Ø¯Ù…Øª</div><div id="pblk-service" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">ØªØ§Ø±ÛŒØ®</div><div id="pblk-date" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">Ø³Ø§Ø¹Øª</div><div id="pblk-time" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</div><div id="pblk-created" class="font-bold text-gray-800"></div>
      </div>
    </div>

    <div class="text-xs text-gray-600 mb-5">
      Ù¾Ø³ Ø§Ø² ØªØ£ÛŒÛŒØ¯ØŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù¾ÛŒØ§Ù…Ú© Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø³Ù¾Ø³ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ú¯ÛŒØ±ÛŒØ¯.
    </div>

    <div class="flex justify-end">
      <button type="button" data-close class="px-4 py-2 rounded-full bg-blue-600 text-white font-bold hover:bg-blue-700">
        Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…
      </button>
    </div>
  </div>
</div>



<!-- Toast should be above modals -->
<div id="headerToast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] bg-blue-600 text-white text-sm px-4 py-2 rounded-full shadow-lg opacity-0 transition-opacity pointer-events-none"></div>


<script>
function showToastDark(message, {type='success', durationMs=2600} = {}) {
  const icons = {
    success: 'fas fa-check',
    info: 'fas fa-info-circle',
    error: 'fas fa-exclamation-circle'
  };
  const existing = document.getElementById('dark-toast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.id = 'dark-toast';
  toast.setAttribute('role', 'status');
  toast.setAttribute('aria-live', 'polite');
  toast.setAttribute('aria-atomic', 'true');
  toast.dir = 'ltr';
  toast.className = 'fixed left-1/2 -translate-x-1/2 bottom-[max(16px,env(safe-area-inset-bottom))] z-[160] bg-black text-white rounded-xl px-4 py-3 shadow-lg ring-1 ring-white/20 flex items-center gap-3 opacity-0 translate-y-2 transition-all duration-200 max-w-[92vw] sm:max-w-md';
  const icon = document.createElement('i');
  icon.className = icons[type] || icons.info;
  const msg = document.createElement('span');
  msg.textContent = message;
  msg.className = 'flex-1';
  msg.dir = 'rtl';
  const closeBtn = document.createElement('button');
  closeBtn.type = 'button';
  closeBtn.textContent = 'Ã—';
  closeBtn.className = 'text-xl leading-none';
  toast.append(icon, msg, closeBtn);
  document.body.appendChild(toast);
  requestAnimationFrame(() => {
    toast.classList.remove('opacity-0', 'translate-y-2');
  });
  function removeToast() {
    toast.classList.add('opacity-0', 'translate-y-2');
    setTimeout(() => toast.remove(), 200);
    document.removeEventListener('keydown', onKey);
  }
  function onKey(e) {
    if (e.key === 'Escape') removeToast();
  }
  document.addEventListener('keydown', onKey);
  toast.addEventListener('click', removeToast);
  closeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeToast(); });
  setTimeout(removeToast, durationMs);
}
</script>


<script>
(() => {
  // ====== Sticky header + toast ======
  const header = document.getElementById('main-header');
  const toast  = document.getElementById('headerToast');

  function showToast(msg) {
    if (!toast) return;
    toast.textContent = msg;
    toast.classList.remove('opacity-0');
    toast.classList.add('opacity-100');
    setTimeout(() => {
      toast.classList.add('opacity-0');
      toast.classList.remove('opacity-100');
    }, 2500);
  }

  // Header shadow on scroll
  window.addEventListener('scroll', () => {
    if (!header) return;
    if (window.scrollY > 10) {
      header.classList.add('shadow-lg');
    } else {
      header.classList.remove('shadow-lg');
    }
  });

  // Mobile top compact/expand
  const mobileTop   = document.getElementById('mobile-top');
  const mobileChips = document.getElementById('mobile-chips');
  let lastY = window.scrollY;
  window.addEventListener('scroll', () => {
    if (!mobileTop || !mobileChips) return;
    if (window.innerWidth > 768) return;
    if (window.scrollY > lastY && window.scrollY > 20) {
      mobileTop.classList.remove('py-3');
      mobileTop.classList.add('py-2');
      mobileChips.classList.add('hidden');
    } else {
      mobileTop.classList.add('py-3');
      mobileTop.classList.remove('py-2');
      mobileChips.classList.remove('hidden');
    }
    lastY = window.scrollY;
  });

  // ====== Unified modal system (for both mobile & desktop) ======
  const modalCache = new Map();

  function setupModal(modal) {
    const card = modal.querySelector('.modal-card');
    const closeEls = modal.querySelectorAll('[data-close]');
    let lastFocused = null;
    let prevOverflow = '';

    const focusableSelector = 'button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])';

    function open() {
      lastFocused = document.activeElement;
      prevOverflow = document.body.style.overflow || '';
      document.body.style.overflow = 'hidden';

      modal.classList.remove('hidden');
      modal.classList.add('flex'); // Ø§Ú¯Ù‡ Ú©Ù„Ø§Ø³ flex ØªÙˆ HTML Ù†Ø¨Ø§Ø´Ù‡ØŒ Ø§ÛŒÙ†Ø¬Ø§ ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
      requestAnimationFrame(() => {
        card.classList.remove('scale-95','opacity-0');
        card.classList.add('scale-100','opacity-100');
        const firstFocusable = card.querySelector(focusableSelector);
        if (firstFocusable) firstFocusable.focus();
      });

      document.addEventListener('keydown', trap);
    }

    function close() {
      card.classList.add('scale-95','opacity-0');
      card.classList.remove('scale-100','opacity-100');

      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.removeEventListener('keydown', trap);
        document.body.style.overflow = prevOverflow;
        if (lastFocused) lastFocused.focus();
      }, 180);
    }

    function trap(e) {
      if (e.key === 'Escape') return close();
      if (e.key !== 'Tab') return;
      const f = card.querySelectorAll(focusableSelector);
      if (!f.length) return;
      const first = f[0], last = f[f.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault(); last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault(); first.focus();
      }
    }

    // Close via elements with data-close
    closeEls.forEach(el => el.addEventListener('click', close));
    // Close when clicking outside the card
    modal.addEventListener('click', (e) => {
      if (!card.contains(e.target)) close();
    });

    return { open, close };
  }

  function bindTriggers() {
    document.querySelectorAll('[data-open]').forEach(btn => {
      const id = btn.getAttribute('data-open');
      const modal = document.getElementById(id);
      if (!modal) return;
      if (!modalCache.has(id)) modalCache.set(id, setupModal(modal));
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        modalCache.get(id).open();
      });
    });
  }
  bindTriggers();

  window.openModalById = function(id) {
    const modal = document.getElementById(id);
    if (!modal) return;
    const cached = modalCache.get(id) || setupModal(modal);
    modalCache.set(id, cached);
    cached.open();
  };

  // ====== Address copy ======
  const addressCopyBtn = document.getElementById('address-copy-btn');
  const fullAddressEl  = document.getElementById('full-address');
  if (addressCopyBtn && fullAddressEl) {
    addressCopyBtn.addEventListener('click', () => {
      const txt = (fullAddressEl.textContent || '').trim();
      if (!txt) return;
      navigator.clipboard.writeText(txt).then(() => showToastDark('Ø¢Ø¯Ø±Ø³ Ú©Ù¾ÛŒ Ø´Ø¯', {type:'success'}));
    });
  }

  // ====== Report form + counter ======
  const reportModal   = document.getElementById('reportModal');
  const reportForm    = document.getElementById('report-form');
  const reportText    = document.getElementById('report-text');
  const reportCounter = document.getElementById('report-counter');

  if (reportText && reportCounter) {
    const updateCounter = () => {
      const len = reportText.value.length;
      reportCounter.textContent = `${len.toLocaleString('fa-IR')}/ÛµÛ°Û°`;
    };
    reportText.addEventListener('input', updateCounter);
    updateCounter();
  }

  if (reportForm && reportModal) {
    const inst = modalCache.get('reportModal') || setupModal(reportModal);
    modalCache.set('reportModal', inst);
    reportForm.addEventListener('submit', (e) => {
      e.preventDefault();
      inst.close();
      showToastDark('Ú¯Ø²Ø§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯', {type:'success'});
      reportForm.reset();
      if (reportCounter) reportCounter.textContent = 'Û°/ÛµÛ°Û°';
    });
  }

  // ================== Booking Gate (prevent booking when previous is pending) ==================
  (function(){
    const KEY_LAST = 'vt:lastBooking';

    function readLast(){
      try { return JSON.parse(localStorage.getItem(KEY_LAST) || 'null'); } catch(e){ return null; }
    }
    function saveLast(obj){ localStorage.setItem(KEY_LAST, JSON.stringify(obj)); }
// Ù†Ø³Ø®Ù‡Ù” Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡Ù” hasPending Ø¨Ø§ Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ Ùˆ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ± Ú©ÙˆØ¦Ø±ÛŒ
async function hasPending(){
  const b = readLast();
  // Ø§Ú¯Ø± Ø±Ø²Ø±Ùˆ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø®Ø±ÙˆØ¬
  if (!b || b.status !== 'pending') return false;

  const base = window.__API_BASE__ || '';

  // Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø±Ø§ÛŒØ¬ Ø¨Ú©â€ŒØ§Ù†Ø¯ Ø¨Ù‡ Ø³Ù‡ Ø­Ø§Ù„Øª: pending / confirmed / rejected
  const normalize = (s) => {
    s = String(s || '').toLowerCase().trim();
    if (['confirmed','approve','approved','accept','accepted','done','completed','success','ok'].includes(s)) return 'confirmed';
    if (['rejected','declined','canceled','cancelled','failed','no-show','noshow'].includes(s)) return 'rejected';
    if (['pending','waiting','awaiting','in-review'].includes(s)) return 'pending';
    return s || 'pending';
  };

  try {
    // Ù‡Ø± Ú†Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø§Ø±ÛŒÙ… Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø¯Ù‡ÛŒÙ… ØªØ§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø±Ú©ÙˆØ±Ø¯ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø´ÙˆØ¯
    const params = new URLSearchParams({
      phone: b.phone || ''
    });
    if (b.id)       params.set('id', b.id);
    if (b.sellerId) params.set('sellerId', b.sellerId);

    const res = await fetch(`${base}/api/bookings/status?${params.toString()}`, { credentials: 'include' });

    if (res.ok) {
      const data = await res.json();
      const raw  = data.status ?? data.state ?? data.bookingStatus;
      const norm = normalize(raw);

      // Ø§Ú¯Ø± Ø§Ø² pending Ø®Ø§Ø±Ø¬ Ø´Ø¯ØŒ Ø°Ø®ÛŒØ±Ù‡Ù” Ù…Ø­Ù„ÛŒ + Ø§Ø±Ø³Ø§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ø³Ù†Ú©Ø±ÙˆÙ† UI/Ø¨Ø§Ø´Ú¯Ø§Ù‡
      if (norm !== 'pending') {
        const next = {
          ...b,
          status: norm,                         // âœ… ÙˆØ¶Ø¹ÛŒØª Ù†Ø±Ù…Ø§Ù„â€ŒØ´Ø¯Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
          resolvedAt: Date.now(),
          bookingId: data.id || data._id || b.bookingId
        };
        saveLast(next);

        // ğŸ”” Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¨Ù‡ Ø§ÛŒÙ† Ø±ÙˆÛŒØ¯Ø§Ø¯ Ú¯ÙˆØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
        window.dispatchEvent(new CustomEvent('booking:status', {
          detail: {
            id: next.id,
            status: norm,                       // âœ… Â«confirmedÂ» Ø­ØªÛŒ Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ú¯ÙØªÙ‡ Ø¨Ø§Ø´Ø¯ approved
            phone: next.phone,
            sellerId: next.sellerId,
            shopUrl: next.shopUrl
          }
        }));
        return false; // Ø¯ÛŒÚ¯Ø± pending Ù†ÛŒØ³Øª
      }

      // Ù‡Ù†ÙˆØ² pending Ø§Ø³Øª
      return true;
    }
  } catch (err) {
    console.warn('hasPending check failed', err);
  }

  // Ø±ÙˆÛŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ù…Ø­Ø§ÙØ¸Ù‡â€ŒÚ©Ø§Ø±: pending ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø§Ø² Ø±Ø²Ø±ÙˆÙ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø´ÙˆØ¯
  return true;
}

    function fillBlockedModal(){
      const b = readLast(); if (!b) return;
      const $ = id => document.getElementById(id);
      $('pblk-service') && ( $('pblk-service').textContent = b.service || '' );
      $('pblk-date')    && ( $('pblk-date').textContent    = b.date    || '' );
      $('pblk-time')    && ( $('pblk-time').textContent    = b.time    || '' );
      $('pblk-created') && ( $('pblk-created').textContent = new Date(b.createdAt).toLocaleString('fa-IR') );
    }

    // Ø¨Ø§Ø²Ú©Ù†Ù†Ø¯Ù‡ ÙˆÛŒØ²Ø§Ø±Ø¯ Ø¨Ø§ Ú†Ú© Â«pendingÂ»
    async function openBookingWizard(prefill){
      if (await hasPending()) {
        fillBlockedModal();
        if (typeof window.openModalById === 'function') window.openModalById('pendingBlockModal');
        return false;
      }
      const wiz = document.getElementById('booking-wizard');
      if (wiz && wiz.classList.contains('hidden')) wiz.classList.remove('hidden');

      // Ù¾ÛŒØ´â€ŒØ§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª Ø§Ú¯Ø± Ø§Ø² Ú©Ø§Ø±Øª Ø®Ø¯Ù…Ø§Øª Ø§ÙˆÙ…Ø¯ÛŒÙ…
      if (prefill && prefill.service) {
        document.querySelectorAll('#step-1 .service-option').forEach(opt => {
          const match = opt.dataset.service === prefill.service;
          opt.classList.toggle('bw-selected', match);
          if (match) opt.dispatchEvent(new Event('click'));
        });
      }

      const top = wiz.getBoundingClientRect().top + window.scrollY - 80;
      window.scrollTo({ top, behavior: 'smooth' });
      return true;
    }

    // Ø§Ú©Ø³Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§
    window.__BOOKING_GUARD__ = { hasPending, readLast, saveLast, openBookingWizard };
    window.hasPendingBooking = hasPending;
    window.openBookingWizard = openBookingWizard;
    window.clearPendingBooking = function(){ localStorage.removeItem(KEY_LAST); };

    // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù† DOM
    document.addEventListener('DOMContentLoaded', () => {
      // CTA Ù‡ÛŒØ±Ùˆ
      const hero = document.getElementById('hero-cta');
      if (hero) hero.addEventListener('click', (e) => { e.preventDefault(); openBookingWizard(); });

      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Â«Ø±Ø²Ø±ÙˆÂ» Ø±ÙˆÛŒ Ú©Ø§Ø±Øª Ø®Ø¯Ù…Ø§Øª
      document.querySelectorAll('.service-button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          openBookingWizard({ service: btn.dataset.service, price: btn.dataset.price });
        });
      });
    });
  })();
  // ================== /Booking Gate ==================

})();
</script>



    <!-- Hero Section -->
<!-- PLACE: Replace the current hero <section> in service-shop.html with this block -->
<section lang="fa" dir="rtl" role="banner" aria-label="Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±"
  class="relative isolate minh-dynamic flex items-center justify-center overflow-hidden px-3 sm:px-6">
  <!-- Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ -->
  <div class="absolute inset-0 pointer-events-none select-none">
    <div class="absolute inset-0 bg-gradient-to-br from-blue-100 via-indigo-50/70 to-cyan-50"></div>
    <div class="absolute inset-0 opacity-[0.06] [background-image:radial-gradient(#000_1px,transparent_1.5px)] [background-size:18px_18px] [mask-image:radial-gradient(65%_65%_at_50%_40%,#000,transparent)]"></div>
    <div class="absolute -top-10 -right-6 w-64 h-64 rounded-full bg-purple-300/30 blur-3xl animate-blob"></div>
    <div class="absolute top-8 -left-10 w-64 h-64 rounded-full bg-amber-200/30 blur-3xl animate-blob animation-delay-2000"></div>
    <div class="absolute -bottom-14 right-6 w-64 h-64 rounded-full bg-pink-300/30 blur-3xl animate-blob animation-delay-4000"></div>
  </div>

  <!-- Ù…Ø­ØªÙˆØ§ -->
  <div class="relative z-10 w-full py-8 sm:py-14 lg:py-16">
    <div class="mx-auto max-w-screen-md sm:max-w-2xl lg:max-w-4xl xl:max-w-6xl 2xl:max-w-[1280px]">
      <div class="relative group">
        <!-- Ù‡Ø§Ù„Ù‡ Ú¯Ø±Ø§Ø¯ÛŒØ§Ù†ÛŒ -->
        <div class="absolute -inset-[6px] rounded-[28px] lg:rounded-[32px] bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-500 blur-xl opacity-20 group-hover:opacity-35 transition duration-700"></div>

        <!-- Ú©Ø§Ø±Øª Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ -->
        <div class="relative rounded-[22px] sm:rounded-[28px] lg:rounded-[32px] backdrop-blur-2xl bg-white/80 border border-white/40 ring-1 ring-black/5 shadow-[0_10px_40px_rgba(0,0,0,0.06)] overflow-hidden">
          <div class="h-1 w-full bg-gradient-to-r from-cyan-500 via-blue-600 to-purple-600"></div>

          <div class="p-5 sm:p-8 lg:p-10 space-y-6 sm:space-y-8 lg:space-y-9">
            <!-- Ø¹Ù†ÙˆØ§Ù† (Ø¨Ø¯ÙˆÙ† Ù…ØªÙ† Ø²ÛŒØ±Ø´) -->
            <div class="text-center space-y-3 sm:space-y-4 lg:space-y-5">
              <h1 id="biz-name"
                  class="font-extrabold leading-tight tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-gray-900 to-gray-700
                         text-[clamp(1.7rem,5vw,2.6rem)] lg:text-[clamp(2.2rem,2.4vw,3.2rem)]">
                Ù†Ø§Ù… Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ø´Ù…Ø§
              </h1>
              <span class="mx-auto block h-[3px] w-24 sm:w-28 lg:w-32 rounded-full bg-gradient-to-l from-cyan-500 via-blue-500 to-purple-500 shadow-[0_0_22px_rgba(59,130,246,.25)]"></span>
              <!-- ØªÚ¯â€ŒÙ„Ø§ÛŒÙ† Ø­Ø°Ù Ø´Ø¯ -->
            </div>

            <!-- Ù…ØªØ§Ø¯ÛŒØªØ§ -->
            <div class="flex flex-wrap items-center justify-center gap-2.5 sm:gap-4 lg:gap-4">
              <!-- Ø§Ù…ØªÛŒØ§Ø² -->
              <div class="flex items-center gap-1.5 px-3 py-2 lg:px-3.5 lg:py-2 rounded-full bg-amber-50 border border-amber-200 text-xs sm:text-sm lg:text-sm shadow-sm
                          hover:ring-2 hover:ring-amber-200/70 transition">
                <svg class="w-4 h-4 lg:w-5 lg:h-5 text-amber-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                </svg>
                <span id="avg-rating" class="font-bold text-gray-800">Û°Ù«Û°</span>
                <span class="text-gray-500">( <span id="review-count">Û°</span> )</span>
              </div>

              <!-- Ø¢Ø¯Ø±Ø³ -->
              <button id="location-link" data-open="addressModal"
                class="flex items-center gap-1.5 px-3 py-2 lg:px-3.5 lg:py-2 rounded-full bg-blue-50 border border-blue-200 text-xs sm:text-sm lg:text-sm text-blue-700 shadow-sm
                       hover:bg-blue-100 hover:ring-2 hover:ring-blue-300 transition">
                <svg class="w-4 h-4 lg:w-5 lg:h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a2 2 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"/>
                  <circle cx="12" cy="11" r="3"></circle>
                </svg>
                <span id="hero-brief-address" class="font-medium">ØªÙ‡Ø±Ø§Ù†ØŒ ÙˆÙ„ÛŒØ¹ØµØ±</span>
              </button>
            </div>

            <div class="w-full h-px bg-gradient-to-l from-transparent via-gray-200 to-transparent"></div>

            <!-- CTAÙ‡Ø§ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2.5 sm:gap-4 lg:gap-4">
              <button id="hero-cta"
                class="relative group/btn inline-flex items-center justify-center gap-2
                       px-6 sm:px-8 lg:px-8 py-3.5 sm:py-4 lg:py-4
                       rounded-2xl font-bold text-sm sm:text-base lg:text-base text-white
                       bg-gradient-to-r from-cyan-600 via-blue-600 to-purple-600 shadow-lg hover:shadow-xl
                       hover:-translate-y-0.5 active:scale-95 transition-all duration-200
                       focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400">
                <span class="absolute inset-0 rounded-2xl -z-10 bg-[linear-gradient(110deg,transparent,rgba(255,255,255,.25),transparent)]
                             -translate-x-full group-hover/btn:translate-x-0 transition-transform duration-700"></span>
                <svg class="w-5 h-5 sm:w-6 sm:h-6 lg:w-6 lg:h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M19 3h-1V1h-2v2H8V1H6v2H5A2 2 0 003 5v12a3 3 0 003 3h12a3 3 0 003-3V5a2 2 0 00-2-2zM5 9h14v8a1 1 0 01-1 1H6a1 1 0 01-1-1V9z"/>
                </svg>
                <span>Ø±Ø²Ø±Ùˆ Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
              </button>

              <a id="hero-call" href="tel:"
                 class="inline-flex items-center justify-center gap-2
                        px-6 sm:px-8 lg:px-8 py-3.5 sm:py-4 lg:py-4
                        rounded-2xl font-bold text-sm sm:text-base lg:text-base
                        border-2 border-gray-200 bg-white text-gray-700 hover:border-gray-300 hover:bg-gray-50
                        hover:-translate-y-0.5 active:scale-95 transition-all duration-200
                        focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-100">
                <svg class="w-5 h-5 sm:w-6 sm:h-6 lg:w-6 lg:h-6 text-green-600" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a1 1 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66a1 1 0 00.24-1.02c-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
                </svg>
                <span>ØªÙ…Ø§Ø³ ÙÙˆØ±ÛŒ</span>
              </a>
            </div>

            <!-- Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„ -->
            <div class="flex flex-wrap items-center justify-center gap-4 sm:gap-6 lg:gap-6 pt-1">
              <div class="flex items-center gap-1.5 text-xs sm:text-sm lg:text-sm text-gray-600">
                <span class="inline-block w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                <span>Ù¾Ø§Ø³Ø®â€ŒÚ¯ÙˆÛŒÛŒ Ø³Ø±ÛŒØ¹</span>
              </div>
              <div class="flex items-center gap-1.5 text-xs sm:text-sm lg:text-sm text-gray-600">
                <span class="inline-block w-2 h-2 rounded-full bg-blue-500"></span>
                <span>Ø±Ø²Ø±Ùˆ Ø§Ù…Ù†</span>
              </div>
              <div class="flex items-center gap-1.5 text-xs sm:text-sm lg:text-sm text-gray-600">
                <span class="inline-block w-2 h-2 rounded-full bg-purple-500"></span>
                <span>Ú©ÛŒÙÛŒØª ØªØ¶Ù…ÛŒÙ†â€ŒØ´Ø¯Ù‡</span>
              </div>
            </div>
          </div>
        </div>
      </div>      
    </div>
  </div>
</section>

<style>
  /* Ø§Ø±ØªÙØ§Ø¹ Ù¾ÙˆÛŒØ§ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ú†â€ŒØ¯Ø§Ø± */
  .minh-dynamic { min-height: 82vh; min-height: 82svh; min-height: 82dvh; padding-bottom: env(safe-area-inset-bottom, 0); }

  /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù„Ø§ÛŒÙ… */
  @keyframes blob {
    0%,100% { transform: translate(0,0) scale(1); }
    33%     { transform: translate(26px,-40px) scale(1.06); }
    66%     { transform: translate(-18px,18px) scale(0.95); }
  }
  .animate-blob { animation: blob 12s infinite cubic-bezier(.4,0,.2,1); }
  .animation-delay-2000 { animation-delay: 2s; }
  .animation-delay-4000 { animation-delay: 4s; }

  @media (prefers-reduced-motion: reduce) {
    .animate-blob { animation: none; }
  }
</style>








    <!-- Services Section -->
<section class="py-8 px-4">
    <h3 class="text-xl font-bold mb-4">Ø®Ø¯Ù…Ø§Øª Ù…Ø§</h3>
    <div class="scroll-container flex overflow-x-auto pb-4 gap-4 snap-x snap-mandatory scrollbar-hide" style="scroll-padding: 0 1rem;">
            <!-- Service Card 1 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/barber-cutting-hair/400/300.jpg" alt="Ø§ØµÙ„Ø§Ø­ Ø³Ø± Ùˆ ØµÙˆØ±Øª" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">Ø§ØµÙ„Ø§Ø­ Ø³Ø± Ùˆ ØµÙˆØ±Øª</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">Ø§ØµÙ„Ø§Ø­ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø³Ø± Ùˆ ØµÙˆØ±Øª Ø¨Ø§ Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ù…ØªØ¯Ù‡Ø§ÛŒ Ø±ÙˆØ²</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">Û±ÛµÛ°,Û°Û°Û°</span>
                            <span class="service-currency mr-1">ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="Ø§ØµÙ„Ø§Ø­ Ø³Ø± Ùˆ ØµÙˆØ±Øª" data-price="150000">
                            Ø±Ø²Ø±Ùˆ
                        </button>
                    </div>
                </div>
            </div>
            <!-- Service Card 2 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/facial-massage/400/300.jpg" alt="Ù…Ø§Ø³Ø§Ú˜ ØµÙˆØ±Øª" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">Ù…Ø§Ø³Ø§Ú˜ ØµÙˆØ±Øª</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">Ù…Ø§Ø³Ø§Ú˜ ØµÙˆØ±Øª Ø¨Ø§ Ø±ÙˆØºÙ†â€ŒÙ‡Ø§ÛŒ Ú¯ÛŒØ§Ù‡ÛŒ Ùˆ Ù…Ø±Ø§Ù‚Ø¨Øª Ø§Ø² Ù¾ÙˆØ³Øª</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">Û±Û²Û°,Û°Û°Û°</span>
                            <span class="service-currency mr-1">ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="Ù…Ø§Ø³Ø§Ú˜ ØµÙˆØ±Øª" data-price="120000">
                            Ø±Ø²Ø±Ùˆ
                        </button>
                    </div>
                </div>
            </div>
            <!-- Service Card 3 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/hair-coloring/400/300.jpg" alt="Ø±Ù†Ú¯ Ù…Ùˆ" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">Ø±Ù†Ú¯ Ù…Ùˆ</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">Ø±Ù†Ú¯ Ù…ÙˆÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø§ Ø¨Ù‡ØªØ±ÛŒÙ† Ø¨Ø±Ù†Ø¯Ù‡Ø§ÛŒ Ø±ÙˆØ² Ø¯Ù†ÛŒØ§</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">Û²Û°Û°,Û°Û°Û°</span>
                            <span class="service-currency mr-1">ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="Ø±Ù†Ú¯ Ù…Ùˆ" data-price="200000">
                            Ø±Ø²Ø±Ùˆ
                        </button>
                    </div>
                </div>
            </div>
            <!-- Service Card 4 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/professional-hair-wash/400/300.jpg" alt="Ø´Ø³ØªØ´ÙˆÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">Ø´Ø³ØªØ´ÙˆÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">Ø´Ø³ØªØ´ÙˆÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù…Ùˆ Ø¨Ø§ Ø´Ø§Ù…Ù¾ÙˆÙ‡Ø§ÛŒ Ù…Ø®ØµÙˆØµ</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">Û¸Û°,Û°Û°Û°</span>
                            <span class="service-currency mr-1">ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="Ø´Ø³ØªØ´ÙˆÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ" data-price="80000">
                            Ø±Ø²Ø±Ùˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Portfolio Section - Updated -->
<!-- ============ Portfolio Section (Dynamic, from backend) ============ -->
<section id="portfolio" class="portfolio-section">
  <div class="container mx-auto px-4">
    <div class="text-center mb-6">
      <h2 class="portfolio-title text-3xl font-extrabold">Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±Ù‡Ø§</h2>
      <p id="portfolio-empty" class="hidden text-gray-500 text-sm mt-3">ÙØ¹Ù„Ø§Ù‹ Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</p>
      <div id="portfolio-loading" class="flex items-center justify-center gap-2 text-gray-500 text-sm mt-2">
        <i class="fas fa-spinner fa-spin"></i><span>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</span>
      </div>
    </div>

    <!-- Mobile: horizontal -->
    <div class="md:hidden pb-6 -mx-4 px-4">
      <div id="portfolio-row" class="flex space-x-4 space-x-reverse w-max overflow-x-auto scroll-container" style="scroll-padding: 0 1rem;"></div>
    </div>

    <!-- Desktop: grid -->
    <div id="portfolio-grid" class="hidden md:grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
  </div>

  <!-- Card Template -->
  <template id="tpl-portfolio-card">
    <div class="portfolio-card bg-white rounded-2xl overflow-hidden shadow-lg transition-all duration-300 hover:shadow-xl hover:-translate-y-1 flex flex-col flex-shrink-0 w-72 md:w-auto">
      <div class="relative portfolio-img-container h-56">
        <img class="portfolio-img w-full h-full object-cover" alt="">
      </div>
      <div class="portfolio-content p-5 flex flex-col flex-1">
        <h3 class="portfolio-name font-bold text-lg mb-2 truncate"></h3>
        <p class="portfolio-description text-gray-600 text-sm mb-4 line-clamp-2"></p>
        <div class="portfolio-stats flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3 space-x-reverse text-gray-500">
            <div class="flex items-center"><i class="far fa-eye ml-1"></i><span class="text-sm js-views">0</span></div>
            <div class="flex items-center"><i class="far fa-heart ml-1"></i><span class="text-sm js-likes">0</span></div>
          </div>
        </div>
        <button class="portfolio-btn w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg transition-all duration-300 hover:from-blue-600 hover:to-blue-700 hover:shadow-md js-open">
          Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±
        </button>
      </div>
    </div>
  </template>
</section>

<!-- Fullscreen Image Modal (responsive) -->
<div id="imageModal" class="fixed inset-0 bg-black/90 z-50 hidden p-4 overflow-y-auto flex items-center justify-center">
  <div class="relative w-full max-w-full sm:max-w-5xl max-h-[90vh] flex flex-col transform transition-all duration-200 scale-95 opacity-0">
    <div class="bg-white rounded-2xl overflow-hidden shadow-2xl flex-grow flex flex-col">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
        <button id="imageModalClose" type="button" class="flex items-center gap-1 text-gray-500 hover:text-gray-700 text-sm">
          <i class="fas fa-times"></i>
          <span>Ø¨Ø³ØªÙ†</span>
        </button>
      </div>
      <div class="flex-grow flex items-center justify-center p-2 bg-gray-100">
        <img id="modalImage" src="" alt="" class="max-w-full max-h-[60vh] object-contain rounded-lg">
      </div>
      <div class="p-4 border-t flex justify-between items-center">
        <div class="flex items-center space-x-4 space-x-reverse text-gray-600">
          <div class="flex items-center"><i class="far fa-eye ml-1"></i><span id="modalViews" class="text-sm">0</span></div>
          <div class="flex items-center"><i class="far fa-heart ml-1"></i><span id="modalLikes" class="text-sm">0</span></div>
        </div>
      </div>
    </div>
  </div>
</div>
    <!-- Booking Wizard -->
<section id="booking-wizard" class="hidden py-8 px-4" dir="rtl">
  <style>
    /* Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ + OTP */
    .bw-selected{ border-color:#3b82f6 !important; background:#eff6ff; }
    .bw-otp{ width:48px;height:56px;text-align:center;font-size:20px;border:1px solid #d1d5db;border-radius:12px;outline:0; }
    .bw-otp:focus{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.25); }
    /* Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ Ù‡Ù…ÛŒØ´Ù‡ LTR Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯ */
    .ltr-num{ direction:ltr; unicode-bidi:isolate; }
    /* Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø§ ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ */
    .fa-num{
      font-family: 'Vazirmatn', sans-serif;
      font-feature-settings: 'ss02', 'tnum';
    }
    /* Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø§ ÙÙˆÙ†Øª Ù„Ø§ØªÛŒÙ† */
    .en-num{
      font-family: 'Vazirmatn', sans-serif;
      font-feature-settings: 'tnum';
    }
    .bw-phone{
      direction:ltr;
      text-align:left;
      unicode-bidi: embed;
    }
    /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù„Ù…Ø³ Ø±ÙˆÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
    @media (hover:none){ .bw-tap{ padding-top:.65rem; padding-bottom:.65rem; } }
  </style>

  <div class="bg-white rounded-xl shadow-md p-6">
    <h3 class="text-xl font-bold mb-6">Ù†ÙˆØ¨Øªâ€ŒÚ¯ÛŒØ±ÛŒ</h3>

    <!-- Ù…Ø±Ø§Ø­Ù„ Ùˆ Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª: 5 Ù…Ø±Ø­Ù„Ù‡ -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm text-gray-600">Ù…Ø±Ø­Ù„Ù‡ <span id="current-step">Û±</span> Ø§Ø² Ûµ</span>
        <div class="flex space-x-1 space-x-reverse">
          <div class="step-dot w-3 h-3 rounded-full bg-blue-600" data-step="1"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="2"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="3"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="4"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="5"></div>
        </div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width:20%"></div>
      </div>
    </div>

    <!-- Step 1: Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª -->
    <div id="step-1" class="step">
      <h4 class="font-bold mb-4">Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª</h4>
      <div class="space-y-3">
        <div id="booking-services" class="space-y-3"></div>
      </div>
      <button id="next-to-step-2" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full w-full transition-all disabled:bg-gray-400" disabled>
        Ø§Ø¯Ø§Ù…Ù‡
      </button>
    </div>

    <!-- Step 2: Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ² Ùˆ Ø³Ø§Ø¹Øª -->
    <div id="step-2" class="step hidden">
      <h4 class="font-bold mb-4">Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ² Ùˆ Ø³Ø§Ø¹Øª</h4>

      <div class="mb-6">
        <h5 class="font-medium mb-2">Ø±ÙˆØ²</h5>
        <div class="grid grid-cols-3 gap-2">
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">Ø´Ù†Ø¨Ù‡</div><div class="font-bold">Û±Û´ ØªÛŒØ±</div>
          </div>
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">ÛŒÚ©Ø´Ù†Ø¨Ù‡</div><div class="font-bold">Û±Ûµ ØªÛŒØ±</div>
          </div>
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">Ø¯ÙˆØ´Ù†Ø¨Ù‡</div><div class="font-bold">Û±Û¶ ØªÛŒØ±</div>
          </div>
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</div><div class="font-bold">Û±Û· ØªÛŒØ±</div>
          </div>
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</div><div class="font-bold">Û±Û¸ ØªÛŒØ±</div>
          </div>
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡</div><div class="font-bold">Û±Û¹ ØªÛŒØ±</div>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <h5 class="font-medium mb-2">Ø³Ø§Ø¹Øª</h5>
        <div class="grid grid-cols-3 gap-2">
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">Û±Û°:Û°Û°</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">Û±Û±:Û°Û°</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">Û±Û²:Û°Û°</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">Û±Û´:Û°Û°</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">Û±Ûµ:Û°Û°</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">Û±Û¶:Û°Û°</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">Û±Û·:Û°Û°</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">Û±Û¸:Û°Û°</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">Û±Û¹:Û°Û°</div>
        </div>
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-1" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <button id="next-to-step-3" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>Ø§Ø¯Ø§Ù…Ù‡</button>
      </div>
    </div>

    <!-- Step 3: Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ -->
    <div id="step-3" class="step hidden">
      <h4 class="font-bold mb-4">Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³</h4>

      <!-- Ù…ÙˆØ¨Ø§ÛŒÙ„: Ø±Ø§Ø³Øªâ€ŒÚ†ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ§Ø±Ø³ÛŒ -->
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2" for="phone-number">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label>
          <div class="flex items-center w-full border border-gray-300 rounded-lg overflow-hidden">
            <input
              type="tel"
              id="phone-number"
              inputmode="numeric"
              autocomplete="tel"
              class="bw-phone fa-num flex-1 py-3 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Û°Û¹Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"
              maxlength="11"
              pattern="^Û°[Û°-Û¹]{10}$"
              dir="ltr"
              lang="fa">
            <span class="px-3 text-gray-500 text-sm en-num ltr-num select-none bg-gray-50 border-r border-gray-300">+98</span>
          </div>
        <p id="phone-error" class="text-red-500 text-xs mt-1 hidden">Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª</p>
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium mb-2" for="customer-name">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
        <input type="text" id="customer-name" class="w-full border border-gray-300 rounded-lg py-3 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-2" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <button id="next-to-step-4" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>Ø§Ø¯Ø§Ù…Ù‡</button>
      </div>
    </div>

    <!-- Step 4: ØªØ§ÛŒÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡ (OTP) -->
    <div id="step-4" class="step hidden">
      <h4 class="font-bold mb-3">ØªØ§ÛŒÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</h4>
      <p class="text-sm text-gray-600 mb-4">
        ÛŒÚ© Ú©Ø¯ Û´ Ø±Ù‚Ù…ÛŒ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡
        <span id="otp-phone" class="font-bold text-gray-800 ltr-num"></span>
        Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.
      </p>

      <button id="edit-phone" class="mb-4 text-blue-600 font-bold text-sm hover:text-blue-700">ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù‡</button>

 <div class="flex items-center justify-center gap-2 mb-2" dir="ltr">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
</div>
      <p id="otp-error" class="text-xs text-red-500 text-center mb-2 hidden">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª</p>

      <div class="flex items-center justify-between mb-6">
        <div class="text-xs text-gray-500">Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ø¯Ø± <span id="otp-timer" class="font-bold">Û¶Û°</span> Ø«Ø§Ù†ÛŒÙ‡</div>
        <button id="resend-otp" class="text-xs font-bold text-blue-600 disabled:text-gray-400" disabled>Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ú©Ø¯</button>
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-3-otp" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <button id="verify-otp" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>ØªØ§ÛŒÛŒØ¯ Ú©Ø¯</button>
      </div>
    </div>

    <!-- Step 5: ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ -->
    <div id="step-5" class="step hidden">
      <h4 class="font-bold mb-4">ØªØ§ÛŒÛŒØ¯ Ù†ÙˆØ¨Øª</h4>
      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-right items-baseline">
          <div class="text-gray-600 py-1">Ø®Ø¯Ù…Øª:</div><div id="confirm-service" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">ØªØ§Ø±ÛŒØ®:</div><div id="confirm-date" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">Ø³Ø§Ø¹Øª:</div><div id="confirm-time" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">Ù†Ø§Ù…:</div><div id="confirm-name" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</div><div id="confirm-phone" class="font-bold text-right py-1 ltr-num"></div>
          <div class="text-gray-600 mt-4 pt-4 border-t border-gray-200 py-1">Ù…Ø¨Ù„Øº Ú©Ù„:</div>
          <div id="confirm-price" class="font-bold text-lg text-right mt-4 pt-4 border-t border-gray-200 py-1"></div>
        </div>
      </div>
      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-3" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
<button id="confirm-booking" data-no-loader class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ</button>      </div>
    </div>

    <!-- Success -->
    <div id="booking-success" class="hidden text-center py-8">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-check text-green-600 text-2xl"></i>
      </div>
      <h4 class="text-xl font-bold mb-2">Ù†ÙˆØ¨Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯</h4>
      <p class="text-gray-600 mb-6">Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø´Ù…Ø§: <span class="font-bold">#Û±Û²Û³Û´Ûµ</span></p>
      <p class="text-gray-600 mb-6">Ø¬Ø²Ø¦ÛŒØ§Øª Ù†ÙˆØ¨Øª Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</p>
      <button id="close-booking" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>

<script>
(() => {
  'use strict';

  // ===== Helpers
  const API_ROOT = window.__API_BASE__ || '';
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const toEn = s => (s||'')
    .replace(/[Û°-Û¹]/g, d => '0123456789'['Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)])
    .replace(/[Ù -Ù©]/g, d => '0123456789'['Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)]);
  const toFa = s => (s||'').replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[parseInt(d,10)]);
  const scrollInto = el => { if(!el) return; const top = el.getBoundingClientRect().top + scrollY - 80; window.scrollTo({top,behavior:'smooth'}); };
  const genId = () => 'c_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
  const getCookie = name => document.cookie.split('; ').find(r => r.startsWith(name + '='))?.split('=')[1] || '';
  const setCookie = (name, value) => { document.cookie = name + '=' + encodeURIComponent(value) + ';path=/'; };
  const TOKEN_KEYS = ['access_token', 'auth_token', 'jwt_token'];
  const clearToken = () => {
    TOKEN_KEYS.forEach(k => localStorage.removeItem(k));
    document.cookie = 'auth_token=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT';
  };
  function getToken() {
    let t = null;
    for (const k of TOKEN_KEYS) {
      const val = localStorage.getItem(k);
      if (val) { t = val; break; }
    }
    if (!t) t = getCookie('auth_token');
    if (!t) return null;
    try {
      const payload = JSON.parse(atob(t.split('.')[1] || ''));
      if (payload.exp * 1000 < Date.now()) {
        clearToken();
        return null;
      }
    } catch (_) {
      clearToken();
      return null;
    }
    return t;
  }

  // Ú©Ø¯ Ù…Ø§Ø¯Ø± Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ· ØªÙˆØ³Ø¹Ù‡
  const MASTER_OTP = '0000';

  // ===== Persistent selection (FIX: name & phone Ù‡Ù… Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆÙ†Ø¯)
  const SS_KEY = 'vt:booking.sel';
  function saveSel() {
    const payload = {
      service:   st.service || null,
      serviceId: st.serviceId || null,
      price:     Number.isFinite(st.price) ? st.price : (parseInt(st.price||'0',10)||0),
      date:      st.date || null,
      time:      st.time || null,
      // NEW
      name:  (st.name || nameInp?.value || '').trim(),
      phone: toEn(st.phone || phoneInp?.value || '')
    };
    try { sessionStorage.setItem(SS_KEY, JSON.stringify(payload)); } catch(e){}
  }
  function loadSel() {
    try {
      const raw = sessionStorage.getItem(SS_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (obj.service)   st.service = obj.service;
      if (obj.serviceId) st.serviceId = obj.serviceId;
      if (obj.price != null) st.price = parseInt(obj.price,10) || 0;
      if (obj.date)      st.date = obj.date;
      if (obj.time)      st.time = obj.time;
      // NEW: rehydrate name/phone Ùˆ Ø¯Ø§Ø®Ù„ input Ù‡Ù… Ø¨Ø±ÛŒØ²
      if (obj.name)  { st.name = obj.name;   if (nameInp)  nameInp.value  = obj.name; }
      if (obj.phone) { st.phone = toEn(obj.phone); if (phoneInp) phoneInp.value = obj.phone; }
    } catch(e){}
  }

  // Ø§Ú¯Ø± Ø§Ø² Ø±ÙˆÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Â«Ø±Ø²Ø±ÙˆÂ» ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒÙ…ØŒ Ù‡Ù…ÙˆÙ† Ù„Ø­Ø¸Ù‡ prefill Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø´Ù‡
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.service-button');
    if (!btn) return;
    try {
      const pre = {
        service:   btn.dataset.service || btn.closest('.service-card')?.querySelector('h4')?.textContent?.trim() || '',
        price:     parseInt(btn.dataset.price||'0',10)||0,
        serviceId: btn.dataset.serviceId || btn.dataset.id || null
      };
      sessionStorage.setItem(SS_KEY, JSON.stringify({ ...JSON.parse(sessionStorage.getItem(SS_KEY)||'{}'), ...pre }));
    } catch(_) {}
  });

  // ===== State
  const st = {
    step:1, customerId:null,
    service:null, serviceId:null, price:0, duration:60,
    date:null, time:null,
    name:'', phone:'', otp:'', otpTimer:0, otpInt:null, otpTo:''
  };

  // ===== Elements
  const wizard = $('#booking-wizard');
  const steps = {1:$('#step-1'),2:$('#step-2'),3:$('#step-3'),4:$('#step-4'),5:$('#step-5')};
  const dots = $$('.step-dot'); const curLbl = $('#current-step'); const pbar = $('#progress-bar');

  // step1
  const servicesWrap = $('#booking-services'); 
  let   svcOpts = $$('.service-option');
  const next1 = $('#next-to-step-2');

  // step2
  const dateOpts = $$('.date-option'); const timeOpts = $$('.time-option');
  const back2 = $('#back-to-step-1'); const next2 = $('#next-to-step-3');

  // step3
  const nameInp = $('#customer-name'); const phoneInp = $('#phone-number');
  const phoneErr = $('#phone-error'); const back3 = $('#back-to-step-2'); const next3 = $('#next-to-step-4');

  // step4 (otp)
  const otpPhone = $('#otp-phone'); const otpInputs = () => $$('.bw-otp');
  const otpErr = $('#otp-error'); const otpTimerLbl = $('#otp-timer'); const resendBtn = $('#resend-otp');
  const editPhone = $('#edit-phone'); const back4 = $('#back-to-step-3-otp'); const verifyBtn = $('#verify-otp');

  // step5
  const back5 = $('#back-to-step-3'); const confirmBtn = $('#confirm-booking');
  const cSvc = $('#confirm-service'), cDate = $('#confirm-date'), cTime = $('#confirm-time'), cName = $('#confirm-name'), cPhone = $('#confirm-phone'), cPrice = $('#confirm-price');

  // success
  const successBox = $('#booking-success'); const closeSuccess = $('#close-booking');

  // ===== Validations & Button state
  const validPhone = raw => {
    const v = toEn(raw).trim();
    return /^0\d{10}$/.test(v) && v.startsWith('09');
  };

  function rebuildFromDOMIfMissing() {
    if (!st.service) {
      const sel = document.querySelector('#booking-services .service-option.bw-selected');
      if (sel) {
        st.service   = sel.dataset.service || sel.textContent.trim();
        st.price     = parseInt(sel.dataset.price || '0', 10) || st.price || 0;
        st.serviceId = sel.dataset.serviceId || st.serviceId || null;
      }
    }
    if (!st.date) {
      const dSel = document.querySelector('.date-option.bw-selected');
      if (dSel) st.date = dSel.innerText.trim();
    }
    if (!st.time) {
      const tSel = document.querySelector('.time-option.bw-selected');
      if (tSel) st.time = tSel.innerText.trim();
    }
  }

  // ===== PATCH: Ù†Ø³Ø®Ù‡Ù” Ù¾Ø§ÛŒØ¯Ø§Ø± ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡
  function updateConfirmState(reason = '') {
    // Ø§Ø² DOM Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§
    const svcSel  = document.querySelector('#booking-services .service-option.bw-selected');
    const dateSel = document.querySelector('.date-option.bw-selected');
    const timeSel = document.querySelector('.time-option.bw-selected');

    if (svcSel) {
      st.service   = svcSel.dataset.service || svcSel.textContent.trim();
      st.price     = parseInt(svcSel.dataset.price || '0', 10) || 0;
      st.serviceId = svcSel.dataset.serviceId || null;
    }
    if (dateSel) st.date = dateSel.innerText.trim();
    if (timeSel) st.time = timeSel.innerText.trim();

    // Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
    if (nameInp)  st.name  = (nameInp.value || '').trim();
    if (phoneInp) st.phone = toEn(phoneInp.value || '');

    const hasAllData = !!(st.service && st.date && st.time && st.name && /^0\d{10}$/.test(st.phone));
    if (!confirmBtn) return;

    if (hasAllData) {
      confirmBtn.disabled = false;
      confirmBtn.removeAttribute('disabled');
      confirmBtn.setAttribute('aria-disabled', 'false');
      confirmBtn.classList.remove('cursor-not-allowed', 'opacity-50');
      confirmBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
    } else {
      confirmBtn.disabled = true;
      confirmBtn.setAttribute('disabled', 'disabled');
      confirmBtn.setAttribute('aria-disabled', 'true');
      confirmBtn.classList.add('cursor-not-allowed', 'opacity-50');
      confirmBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    }

    console.debug('[confirm-state]', reason, {
      service: st.service, date: st.date, time: st.time,
      name: st.name, phone: st.phone, ok: hasAllData
    });
  }

  // ===== PATCH: Ù†ÙˆØ¹ Ø¯Ú©Ù…Ù‡ Ùˆ Ù†Ú¯Ù‡Ø¨Ø§Ù† Ø¶Ø¯-disabled
  if (confirmBtn) {
    confirmBtn.type = 'button'; // Ø§Ø² Ù‡Ø± submit-handler Ø¹Ù…ÙˆÙ…ÛŒ Ø¯Ø± Ø§Ù…Ø§Ù†
    const confirmGuard = new MutationObserver(() => {
      const ready = !!(st.service && st.date && st.time && (nameInp?.value||'').trim() && /^0\d{10}$/.test(toEn(phoneInp?.value||'')));
      if (ready && confirmBtn.hasAttribute('disabled')) {
        confirmBtn.disabled = false;
        confirmBtn.removeAttribute('disabled');
        confirmBtn.setAttribute('aria-disabled', 'false');
        confirmBtn.classList.remove('cursor-not-allowed', 'opacity-50');
        confirmBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
      }
    });
    confirmGuard.observe(confirmBtn, { attributes: true, attributeFilter: ['disabled'] });
    // Ø§Ø®ØªÛŒØ§Ø±ÛŒ: Ø±ÙˆÛŒ unload Ù‚Ø·Ø¹Ø´ Ù†Ú©Ù†ÛŒÙ… Ù‡Ù… Ù…Ø´Ú©Ù„ÛŒ Ù†ÛŒØ³Øª
  }

  // ===== Navigation
  function showStep(n){
    st.step = n;
    Object.values(steps).forEach(s => s.classList.add('hidden'));
    steps[n].classList.remove('hidden');
    curLbl.textContent = n.toString();
    pbar.style.width = (n*20) + '%';
    dots.forEach(d => { const k = +d.dataset.step; d.classList.toggle('bg-blue-600', k<=n); d.classList.toggle('bg-gray-300', k>n); });
    scrollInto(wizard);
    if (n === 5) {
      updateConfirmState('enter-step5');
      // PATCH: Ø¯ÙˆØ¨Ø§Ø± ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù race Ø¨Ø§ Ø±Ù†Ø¯Ø±/transition
      requestAnimationFrame(() => updateConfirmState('enter-step5:raf'));
      setTimeout(() => updateConfirmState('enter-step5:timeout'), 0);
    }
  }

  // ===== Validators
  function chk1(){ next1.disabled = !(st.service && st.price); saveSel(); updateConfirmState('chk1'); }
  function chk2(){ next2.disabled = !(st.date && st.time);   saveSel(); updateConfirmState('chk2'); }
  function chk3(){
    const ok = nameInp.value.trim().length >= 2 && validPhone(phoneInp.value);
    next3.disabled = !ok;
    phoneErr.classList.toggle('hidden', validPhone(phoneInp.value));
    st.name  = nameInp.value.trim();
    st.phone = toEn(phoneInp.value);
    saveSel();
    updateConfirmState('chk3');
  }
  function chkOTP(){
    const code = toEn(otpInputs().map(i=>i.value).join('')).replace(/\D/g,'');
    verifyBtn.disabled = (code.length!==4);
    if (!verifyBtn.disabled) otpErr.classList.add('hidden');
  }

  // ===== Step 1: build service options from service cards
  function buildServiceOptionsFromCards(){
    if (!servicesWrap) return;
    const sourceButtons = $$('.service-button');
    if (!sourceButtons.length) return;

    servicesWrap.innerHTML = '';
    sourceButtons.forEach((btn, idx) => {
      const title = btn.dataset.service || btn.closest('.service-card')?.querySelector('h4')?.textContent?.trim() || `Ø®Ø¯Ù…Øª ${idx+1}`;
      const price = parseInt(btn.dataset.price || '0', 10) || 0;
      const serviceId = btn.dataset.serviceId || btn.dataset.id || '';

      const opt = document.createElement('div');
      opt.className = 'service-option border border-gray-300 rounded-lg p-3 cursor-pointer hover:border-blue-500 flex items-center justify-between';
      opt.dataset.service = title;
      opt.dataset.price = String(price);
      if (serviceId) opt.dataset.serviceId = serviceId;

      opt.innerHTML = `
        <div class="font-bold text-gray-800">${title}</div>
        <div class="text-sm text-gray-600">${price ? toFa(price.toLocaleString()) + ' ØªÙˆÙ…Ø§Ù†' : 'â€”'}</div>
      `;

      opt.addEventListener('click', () => {
        svcOpts.forEach(x => x.classList.remove('bw-selected'));
        opt.classList.add('bw-selected');
        st.service   = title;
        st.price     = price;
        st.serviceId = serviceId || null;
        saveSel();
        chk1();
      });

      servicesWrap.appendChild(opt);
    });

    svcOpts = $$('#booking-services .service-option');

    // Ø§Ú¯Ø± Ø§Ø² Ù‚Ø¨Ù„ prefill Ø¯Ø§Ø´ØªÛŒÙ…ØŒ Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ Ø§Ø¹Ù…Ø§Ù„ Ú©Ù†ÛŒÙ…
    loadSel();
    if (st.service) {
      const match = Array.from(svcOpts).find(o => (o.dataset.service||'').trim() === st.service);
      if (match) {
        match.classList.add('bw-selected');
        st.price = parseInt(match.dataset.price||'0',10)||st.price||0;
        chk1();
      }
    }
  }

  function wireExistingServiceOptions(){
    if (!svcOpts.length) return;
    svcOpts.forEach(o=>{
      o.addEventListener('click', ()=>{
        svcOpts.forEach(x=>x.classList.remove('bw-selected'));
        o.classList.add('bw-selected');
        st.service   = o.dataset.service || o.textContent.trim();
        st.price     = parseInt(o.dataset.price||'0',10)||0;
        st.serviceId = o.dataset.serviceId || null;
        saveSel();
        chk1();
      });
    });
  }

  // step1 next
  next1?.addEventListener('click', ()=>showStep(2));

  // ===== Step 2
  function pick(list, el){ list.forEach(x=>x.classList.remove('bw-selected')); el.classList.add('bw-selected'); }
  dateOpts.forEach(el=>el.addEventListener('click', ()=>{ pick(dateOpts, el); st.date = el.innerText.trim(); saveSel(); chk2(); }));
  timeOpts.forEach(el=>el.addEventListener('click', ()=>{ pick(timeOpts, el); st.time = el.innerText.trim(); saveSel(); chk2(); }));
  back2.addEventListener('click', ()=>showStep(1));
  next2.addEventListener('click', ()=>showStep(3));

  // ===== Step 3
  function onStep3(){
    st.name  = nameInp.value.trim();
    st.phone = toEn(phoneInp.value);
    saveSel();
    chk3();
  }
  nameInp.addEventListener('input', onStep3);
  phoneInp.addEventListener('input', (e)=>{
    let value = e.target.value;
    value = value.replace(/[^\u06F0-\u06F9\u0660-\u06690-9]/g, '');
    value = value.slice(0, 11);
    e.target.value = value;
    st.phone = toEn(value);
    onStep3();
  });
  back3.addEventListener('click', ()=>showStep(2));
  next3.addEventListener('click', ()=>{
    if (next3.disabled) return;
    st.phone = toEn(phoneInp.value); st.name = nameInp.value.trim();

    // Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ (Ø¯Ù…Ùˆ) â€” Û´ Ø±Ù‚Ù…ÛŒ
    st.otp   = String(Math.floor(1000 + Math.random()*9000));
    st.otpTo = st.phone;

    // Ù…Ø§Ø³Ú© Ø´Ù…Ø§Ø±Ù‡
    const v = toEn(st.phone).replace(/\D/g,'');
    otpPhone.textContent = (v.length<8) ? v : (v.slice(0,4)+'*****'+v.slice(-4));

    startOtpTimer();
    clearOtp();
    otpErr.classList.add('hidden');
    chkOTP();
    showStep(4);
  });

  // ===== Step 4 (OTP)
  function clearOtp(){ otpInputs().forEach((i,idx)=>{ i.value=''; if(idx===0) i.focus(); }); }
  function startOtpTimer(){
    stopOtpTimer(); st.otpTimer = 60; resendBtn.disabled = true; updateOtpTimer();
    st.otpInt = setInterval(()=>{ st.otpTimer--; updateOtpTimer(); if(st.otpTimer<=0){ stopOtpTimer(); resendBtn.disabled=false; } }, 1000);
  }
  function stopOtpTimer(){ if(st.otpInt){ clearInterval(st.otpInt); st.otpInt=null; } }
  function updateOtpTimer(){ otpTimerLbl.textContent = st.otpTimer.toString(); }

  document.addEventListener('input', (e)=>{
    const t = e.target; if(!(t instanceof HTMLInputElement)) return;
    if(!t.classList.contains('bw-otp')) return;
    t.value = toEn(t.value).replace(/\D/g,'').slice(0,1);
    const arr = otpInputs(); const idx = arr.indexOf(t);
    if(t.value && idx < arr.length-1){ arr[idx+1].focus(); }
    chkOTP();
  });
  document.addEventListener('keydown', (e)=>{
    const t = e.target; if(!(t instanceof HTMLInputElement)) return;
    if(!t.classList.contains('bw-otp')) return;
    if(e.key==='Backspace' && !t.value){
      const arr = otpInputs(); const idx = arr.indexOf(t);
      if(idx>0) arr[idx-1].focus();
    }
  });

  const resendOtp = ()=>{ st.otp = String(Math.floor(1000 + Math.random()*9000)); startOtpTimer(); };
  resendBtn.addEventListener('click', ()=>{ if(!resendBtn.disabled) resendOtp(); });

  // Ø°Ø®ÛŒØ±Ù‡ Ù…Ø´ØªØ±ÛŒ
  function persistCustomer(){
    const existing = getCookie('customerId');
    const cid = st.customerId || existing || genId();
    st.customerId = cid;
    setCookie('customerId', cid);
    setCookie('customerName', st.name);
    setCookie('customerPhone', st.phone);
  }

  // ØªØ§ÛŒÛŒØ¯ OTP
  verifyBtn.addEventListener('click', async ()=>{
    const code = toEn(otpInputs().map(i=>i.value.trim()).join('')).replace(/\D/g,'');
    if (code.length !== 4) { otpErr.classList.remove('hidden'); return; }
    if (code !== st.otp && code !== MASTER_OTP) { otpErr.classList.remove('hidden'); return; }
    stopOtpTimer();

    verifyBtn.disabled = true;
    const originalHTML = verifyBtn.innerHTML;
    verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÛŒØ¯...';

    try {
      const profilePayload = { name: st.name, phone: st.phone, customerId: st.customerId };
      const response = await fetch(`${API_ROOT}/api/user/profile`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(getToken() ? {'Authorization': 'Bearer ' + getToken()} : {})
        },
        credentials: 'include',
        body: JSON.stringify(profilePayload)
      });
      if (!response.ok) throw new Error('Profile save failed');

      persistCustomer();
    } catch (error) {
      console.error('Profile save failed:', error);
      if (typeof showToastDark === 'function') showToastDark('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ', {type: 'error'});
      persistCustomer(); // Ø§Ø¯Ø§Ù…Ù‡ Ù…Ø­Ù„ÛŒ
    } finally {
      // Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ ØªØ§ÛŒÛŒØ¯
      fillConfirm();
      saveSel(); // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø°Ø®ÛŒØ±Ù‡ name/phone Ù‚Ø¨Ù„ Ø§Ø² Step 5
      showStep(5);
      requestAnimationFrame(() => updateConfirmState('after-otp'));
      verifyBtn.disabled = false;
      verifyBtn.innerHTML = originalHTML;
    }
  });

  editPhone.addEventListener('click', ()=>showStep(3));
  back4.addEventListener('click',  ()=>showStep(3));

  // ===== Step 5 (Confirm)
  function fillConfirm(){
    loadSel();
    rebuildFromDOMIfMissing();
    // ØªØ¶Ù…ÛŒÙ† Ø§ÛŒÙ†Ú©Ù‡ name/phone Ú¯Ù… Ù†Ø´Ù‡
    st.name  = st.name  || nameInp?.value.trim() || '';
    st.phone = st.phone || toEn(phoneInp?.value || '') || '';

    cSvc.textContent   = st.service || '';
    cDate.textContent  = st.date   || '';
    cTime.textContent  = st.time   || '';
    cName.textContent  = st.name   || '';
    cPhone.textContent = st.phone  || '';
    cPrice.textContent = (st.price? st.price.toLocaleString('fa-IR'):'Û°') + ' ØªÙˆÙ…Ø§Ù†';

    saveSel();
    updateConfirmState('fillConfirm');
  }

  back5.addEventListener('click', ()=>showStep(3));

  // --- Built-in success popup on final confirm ---
  (function hookConfirmToPendingModal(){
    const btn = document.getElementById('confirm-booking');
    if (!btn) return;

    btn.addEventListener('click', async () => {
      if (btn.disabled) return;

      // Ø³ÛŒÙ†Ú© Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
      st.name  = (document.getElementById('customer-name')?.value || st.name || '').trim();
      st.phone = toEn(document.getElementById('phone-number')?.value || st.phone || '');

      if (!st.service || !st.date || !st.time || !st.name || !/^0\d{10}$/.test(st.phone)) return;

      // 1) Ø°Ø®ÛŒØ±Ù‡Ù” ÙˆØ¶Ø¹ÛŒØª Â«pendingÂ»
      const last = {
        id: genId(),
        service: st.service,
        date:    st.date,
        time:    st.time,
        phone:   st.phone,
        status:  'pending',
        createdAt: Date.now(),
        sellerId: document.body?.dataset?.sellerId || null,
        shopUrl:  document.body?.dataset?.shopurl  || null
      };
      try { localStorage.setItem('vt:lastBooking', JSON.stringify(last)); } catch(_) {}

      // 2) Ù¾Ø± Ú©Ø±Ø¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø¯Ø§Ø®Ù„ÛŒ
      const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val || 'â€”'; };
      setText('pb-service', st.service);
      setText('pb-date',    st.date);
      setText('pb-time',    st.time);
      setText('pb-phone',   st.phone);

      // 3) Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ù¾â€ŒØ¢Ù¾
      if (typeof window.openModalById === 'function') {
        window.openModalById('pendingBookingModal');
      } else if (typeof window.showToastDark === 'function') {
        showToastDark('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø§Ø³Øª.', { type: 'success' });
      } else {
        alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø§Ø³Øª.');
      }

      // 4) Ø±ÛŒØ³Øª ÙˆÛŒØ²Ø§Ø±Ø¯
      resetWizardState();
    });
  })();
  // --- /built-in success popup ---

  // Helper: reset
  function resetWizardState() {
    ['service','date','time'].forEach(k => st[k] = null);
    try { sessionStorage.removeItem(SS_KEY); } catch(e){}
    svcOpts.forEach(x => x.classList.remove('bw-selected'));
    dateOpts.forEach(x => x.classList.remove('bw-selected'));
    timeOpts.forEach(x => x.classList.remove('bw-selected'));
    if (next1) next1.disabled = true;
    if (next2) next2.disabled = true;
    confirmBtn.disabled = true;
    confirmBtn.setAttribute('disabled','disabled');
    showStep(1);
  }

  // ===== Compose slot
  const WEEKDAY_MAP = {
    'ÛŒÚ©Ø´Ù†Ø¨Ù‡':0,'Ø¯ÙˆØ´Ù†Ø¨Ù‡':1,'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡':2,'Ø³Ù‡ Ø´Ù†Ø¨Ù‡':2,'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡':3,'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡':4,'Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡':4,'Ø¬Ù…Ø¹Ù‡':5,'Ø´Ù†Ø¨Ù‡':6
  };
  function nextDateFor(dayName, hhmm){
    const targetDow = WEEKDAY_MAP[(dayName||'').trim()];
    const now = new Date(); let d = new Date(); let add = 0;
    if (typeof targetDow === 'number'){
      const diff = (targetDow - now.getDay() + 7) % 7;
      add = diff;
    }
    d.setDate(now.getDate() + add);
    const parts = toEn(hhmm||'12:00').split(':');
    const h = parseInt(parts[0]||'12',10), m = parseInt(parts[1]||'0',10);
    d.setHours(h||0, m||0, 0, 0);
    if (add===0 && d.getTime() <= now.getTime()) d.setDate(d.getDate()+7);
    return d;
  }
  function composeSlotISO(dateText, timeText, durationMin=60){
    const dayName = (dateText||'').trim().split(/\s+/)[0];
    let start = nextDateFor(dayName, timeText||'12:00');
    if (!(start instanceof Date) || isNaN(+start)) start = new Date(Date.now() + 60*60*1000);
    const end = new Date(start.getTime() + durationMin*60*1000);
    return { startISO: start.toISOString(), endISO: end.toISOString() };
  }

  // ===== Submit booking (legacy handler removed; handled by modern wizard)

  closeSuccess.addEventListener('click', ()=>{
    successBox.classList.add('hidden');
    showStep(1);
  });

  // ===== Init from cookies
  const saved = {
    cid: getCookie('customerId'),
    name: decodeURIComponent(getCookie('customerName') || ''),
    phone: getCookie('customerPhone')
  };
  if (saved.cid)  st.customerId = saved.cid;
  if (saved.name) nameInp.value = saved.name;
  if (saved.phone) phoneInp.value = saved.phone;

  // Build & wire
  buildServiceOptionsFromCards();
  wireExistingServiceOptions();

  // Initial validation
  (function initButtons(){
    next1.disabled = true; next2.disabled = true; next3.disabled = true; confirmBtn.disabled = true;
    confirmBtn.setAttribute('disabled','disabled');
    if (confirmBtn) confirmBtn.type = 'button';
  })();

  // Ø§Ú¯Ø± prefill Ø¯Ø± session Ù‡Ø³ØªØŒ Ø§Ø² Ù‡Ù…ÙˆÙ† Ø´Ø±ÙˆØ¹ Ú©Ù†
  loadSel();
  if (st.service) {
    const match = document.querySelector(`#booking-services .service-option[data-service="${CSS.escape(st.service)}"]`);
    if (match) { match.classList.add('bw-selected'); next1.disabled = false; }
  }
  if (st.date) {
    const dMatch = Array.from(dateOpts).find(d => d.innerText.trim() === st.date);
    if (dMatch) dMatch.classList.add('bw-selected');
  }
  if (st.time) {
    const tMatch = Array.from(timeOpts).find(t => t.innerText.trim() === st.time);
    if (tMatch) tMatch.classList.add('bw-selected');
  }

  // Ù†Ø§Ù…/Ø´Ù…Ø§Ø±Ù‡ Ø§Ø² Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ ÛŒØ§ session
  st.name  = (nameInp.value||'').trim();
  st.phone = toEn(phoneInp.value||'');
  updateConfirmState('init');
  showStep(1);

  // Ø§Ø¨Ø²Ø§Ø± ØªØ³Øª
  window.forceEnableConfirm = function() {
    const btn = document.getElementById('confirm-booking');
    if (btn) {
      btn.disabled = false;
      btn.removeAttribute('disabled');
      console.log('Ø¯Ú©Ù…Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯');
    }
  };

  // Update date options to future dates (Ø¯Ù…ÙˆÛŒÛŒ)
  const dateOptions = $$('.date-option');
  const persianDates = ['22 Ø´Ù‡Ø±ÛŒÙˆØ±', '23 Ø´Ù‡Ø±ÛŒÙˆØ±', '24 Ø´Ù‡Ø±ÛŒÙˆØ±', '25 Ø´Ù‡Ø±ÛŒÙˆØ±', '26 Ø´Ù‡Ø±ÛŒÙˆØ±', '27 Ø´Ù‡Ø±ÛŒÙˆØ±'];
  dateOptions.forEach((opt, i) => {
    const boldDiv = opt.querySelector('.font-bold');
    if (boldDiv) { boldDiv.textContent = persianDates[i]; }
  });
})();
</script>







</section>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
const btns = document.querySelectorAll(
  'button[type="submit"]:not([data-no-loader]), .service-button'
);


    btns.forEach(btn => {
      btn.addEventListener('click', function () {
        if (this.disabled || this.classList.contains('loading')) return;

        const original = this.innerHTML;

        // Allow the submit event to fire first
        setTimeout(() => {
          this.classList.add('loading');
          this.disabled = true;
          this.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...';
        }, 0);

        // Safety revert after 2s (UI-only fallback)
        setTimeout(() => {
          this.classList.remove('loading');
          this.disabled = false;
          this.innerHTML = original;
        }, 2000);
      });
    });
  });
  </script>




    <!-- Customer Reviews -->


<!-- Loyalty Rewards Card Component -->

<section id="loyalty-disabled" class="w-full py-8 px-4 sm:px-5 hidden" dir="rtl">
  <div class="mx-auto max-w-[680px] md:max-w-[720px]">
    <div class="rounded-3xl bg-gray-100 border border-gray-200 p-8 text-center">
      <h2 class="text-xl font-bold text-gray-700 mb-2">Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ù…Ø´ØªØ±ÛŒØ§Ù† ØºÛŒØ± ÙØ¹Ø§Ù„ Ø§Ø³Øª</h2>
      <p class="text-gray-600">Ø§ÛŒÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø¨Ø®Ø´ Ø¬Ø§ÛŒØ²Ù‡ Ø¯Ø§Ø¯Ù† Ø±Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª.</p>
    </div>
  </div>
</section>

<!-- ============ Loyalty Rewards (Vitreenet) ============ -->
<section id="loyalty-card" class="w-full py-8 px-4 sm:px-5" dir="rtl">
  <!-- Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ -->
<div id="lr-data"
     data-current="0"
     data-target="10"
     data-reward=""
     data-booking-url=""
     data-login-url="/login"
     data-rules=""></div>

  <div class="mx-auto relative max-w-[680px] md:max-w-[720px]">
    <!-- Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ú¯Ø±Ø§Ø¯ÛŒØ§Ù† Ø³Ø§Ø¯Ù‡ -->
    <div class="absolute inset-0 -z-10 rounded-3xl bg-gradient-to-r from-purple-500/10 via-pink-500/10 to-blue-500/10 blur-2xl"></div>

    <!-- Ù‚Ø§Ø¨ Ø¨Ø§ Ú¯Ø±Ø§Ø¯ÛŒØ§Ù† -->
    <div class="group relative rounded-3xl p-[2px] bg-gradient-to-r from-purple-500 via-pink-500 to-blue-500 transition-shadow duration-300 hover:shadow-xl">
      
      <!-- MEMBER CLUB badge -->
      <div class="absolute -top-3 right-4 z-20 select-none">
        <span class="inline-flex rounded-full p-[1.5px] bg-gradient-to-r from-purple-500 to-pink-500 shadow-md">
          <span dir="ltr"
                class="relative inline-flex items-center rounded-full
                       px-4 py-1.5 text-[10px] sm:text-[11px]
                       font-extrabold uppercase tracking-[0.18em]
                       text-white bg-gradient-to-r from-purple-600 to-pink-600">
            <span class="relative z-10">VIP MEMBER</span>
          </span>
        </span>
      </div>

      <!-- Ú©Ø§Ø±Øª Ø§ØµÙ„ÛŒ -->
      <div class="rounded-3xl bg-white/95 backdrop-blur-sm p-6 sm:p-7 pt-14 shadow-lg relative overflow-hidden">

        <!-- Ø¹Ù†ÙˆØ§Ù† Ùˆ Ú†ÛŒÙ¾ Ù‚Ø§Ù†ÙˆÙ† -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2.5 sm:gap-3 mb-5">
          <h2 class="text-[20px] sm:text-[22px] md:text-2xl font-black bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ù…Ø´ØªØ±ÛŒØ§Ù† ÙˆÛŒÚ˜Ù‡</h2>
          <div class="min-w-0 text-[12px] sm:text-[13px] font-semibold px-3.5 py-2 rounded-full bg-gradient-to-r from-purple-100 to-pink-100 text-purple-800 border border-purple-200 shadow-sm max-w-[78vw] sm:max-w-none truncate">
            Ù‡Ø± <span id="reward-target" class="font-bold">Û±Û°</span> Ù†ÙˆØ¨ØªØŒ <span id="reward-text" class="font-bold">ÛŒÚ© Ø§ØµÙ„Ø§Ø­ Ø±Ø§ÛŒÚ¯Ø§Ù†</span>
          </div>
        </div>

        <!-- Ù…ØªÙ† Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ -->
        <div class="text-center max-w-[48ch] mx-auto mb-4">
          <h3 id="lr-headline" class="text-[16px] sm:text-[18px] font-extrabold text-gray-800 tracking-[0.01em]"></h3>
          <p id="lr-sub" class="text-[12px] text-gray-600 mt-1"></p>
        </div>

        <!-- Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ -->
        <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-6">
          <div class="relative group">
            <div class="absolute inset-0 bg-gradient-to-br from-green-400/20 to-emerald-500/20 rounded-xl blur-sm"></div>
            <div class="relative rounded-xl bg-white border border-green-200 px-4 py-3 text-center shadow-sm">
              <div class="text-[10px] sm:text-[11px] text-gray-600 font-medium mb-1">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</div>
              <div id="lr-m-current" class="text-[18px] sm:text-[20px] font-bold text-green-600">Û°</div>
            </div>
          </div>
          <div class="relative group">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-400/20 to-cyan-500/20 rounded-xl blur-sm"></div>
            <div class="relative rounded-xl bg-white border border-blue-200 px-4 py-3 text-center shadow-sm">
              <div class="text-[10px] sm:text-[11px] text-gray-600 font-medium mb-1">ØªØ§ Ø¬Ø§ÛŒØ²Ù‡</div>
              <div id="lr-m-left" class="text-[18px] sm:text-[20px] font-bold text-blue-600">Û°</div>
            </div>
          </div>
        </div>

        <!-- Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª -->
        <div class="mb-4">
          <div class="relative h-[12px] sm:h-[14px] rounded-full bg-gray-100 shadow-inner overflow-hidden">
            <div class="absolute inset-0 opacity-30 bg-[repeating-linear-gradient(to_right,transparent,transparent_9.5%,rgba(0,0,0,0.1)_9.5%,rgba(0,0,0,0.1)_10.5%)]"></div>
            <div id="lr-bar" class="relative h-full w-0 rounded-full transition-all duration-500 ease-out"
                 style="background: linear-gradient(90deg, #8B5CF6, #EC4899, #3B82F6);">
              <div class="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow border-2 border-purple-500"></div>
            </div>
          </div>
          <div class="mt-2 text-[12px] sm:text-sm font-medium text-gray-700 flex justify-between items-center">
            <span id="lr-counts" class="font-bold">Û° Ø§Ø² Û°</span>
            <span class="text-[11px] text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒØ´Ø±ÙØª</span>
          </div>
        </div>

        <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ -->
        <p id="lr-helper" class="text-center text-[12px] sm:text-[13px] text-gray-600 mb-6 font-medium"></p>

        <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
        <div class="flex flex-col sm:flex-row justify-center gap-2.5 sm:gap-3">
          <button id="lr-cta" class="relative group w-full sm:w-auto rounded-full px-6 py-3.5 text-[14px] font-bold
                  text-white shadow-lg overflow-hidden transform transition-all duration-200 hover:shadow-xl active:scale-[0.98]">
            <div class="absolute inset-0 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600"></div>
            <span class="relative z-10 flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
              </svg>
              <span id="lr-cta-label">Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ</span>
            </span>
          </button>

          <button id="lr-rules" class="relative group w-full sm:w-auto rounded-full px-6 py-3.5 text-[14px] font-bold
                  bg-white text-purple-700 shadow overflow-hidden border-2 border-purple-300 hover:border-purple-400 transform transition-all duration-200 hover:shadow-md active:scale-[0.98]">
            <div class="absolute inset-0 bg-gradient-to-r from-purple-50 to-pink-50 opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
            <span class="relative z-10 flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
              Ù‚ÙˆØ§Ù†ÛŒÙ†
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø§Ø³ØªÛŒÚ©ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
  <div id="lr-sticky" class="fixed inset-x-0 bottom-0 z-40 sm:hidden pointer-events-none transition-all duration-200 transform translate-y-0">
    <div class="pointer-events-auto mx-auto max-w-2xl px-3">
      <div class="rounded-t-2xl bg-white/95 backdrop-blur shadow-xl p-4 pb-[max(16px,env(safe-area-inset-bottom))] border-t border-x border-gray-200">
        <div class="absolute top-2 left-1/2 -translate-x-1/2 w-10 h-1 bg-gray-300 rounded-full"></div>
        <div class="flex items-center justify-between gap-3 mt-1">
          <div class="min-w-0 flex-1">
            <div id="lr-sticky-label" class="text-[11px] text-gray-500 font-medium mb-1">Ø¨Ø§Ø´Ú¯Ø§Ù‡ ÙˆÛŒÚ˜Ù‡</div>
            <div class="flex items-center gap-3">
              <div id="lr-sticky-progress" class="text-[14px] font-bold text-purple-700" aria-live="polite">Û° Ø§Ø² Û°</div>
              <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                <div id="lr-sticky-bar" class="h-full w-0 transition-all duration-500 ease-out bg-gradient-to-r from-purple-600 to-pink-600"></div>
              </div>
            </div>
          </div>
          <button id="lr-cta-mobile" class="rounded-full px-5 py-3 text-[13px] font-bold text-white shadow-lg transform transition-all duration-200 active:scale-[0.98] bg-gradient-to-r from-purple-600 to-pink-600">
            <span class="flex items-center gap-1.5">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 1.414L10.586 9.5H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"/>
              </svg>
              <span id="lr-cta-mobile-label">Ø±Ø²Ø±Ùˆ</span>
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Rules Modal -->
<div id="lrRulesModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-close></div>
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="modal-card relative w-full max-w-md transform transition-all duration-200 scale-95 opacity-0">
      <div class="bg-white rounded-2xl shadow-2xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ù…Ø´ØªØ±ÛŒØ§Ù†</h3>
          <button class="p-2 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors duration-200" data-close aria-label="Ø¨Ø³ØªÙ†">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="bg-gray-50 rounded-xl p-4 mb-5">
          <div id="lr-rules-content" class="text-gray-700 text-sm whitespace-pre-line leading-7 max-h-64 overflow-y-auto"></div>
        </div>
        <button class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-3 rounded-full shadow-lg transition-all duration-200 active:scale-[0.98]" data-close>Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…</button>
      </div>
    </div>
  </div>
</div>

<!-- Redeem Modal -->
<div id="lrRedeemModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-close></div>
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="modal-card relative w-full max-w-md transform transition-all duration-200 scale-95 opacity-0">
      <div class="bg-white rounded-2xl shadow-2xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø§ÛŒØ²Ù‡</h3>
        <button class="p-2 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors duration-200" data-close aria-label="Ø¨Ø³ØªÙ†">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <div id="lr-redeem-body">
          <div class="text-center mb-5">
            <div class="inline-flex p-4 rounded-full bg-gradient-to-br from-purple-100 to-pink-100 mb-3">
              <svg class="w-10 h-10 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
            </div>
            <p class="text-gray-700 mb-2">Ø¨Ù‡ <span id="lr-reward-inline" class="font-bold text-purple-700">ÛŒÚ© Ø§ØµÙ„Ø§Ø­ Ø±Ø§ÛŒÚ¯Ø§Ù†</span> Ø±Ø³ÛŒØ¯ÛŒ</p>
            <p class="text-sm text-gray-500">Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø§ÛŒØ²Ù‡â€ŒØ§ÛŒØŸ</p>
          </div>
          
          <div class="rounded-xl bg-gray-50 border border-gray-200 p-4 mb-5">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</span>
              <span id="lr-redeem-counts" class="font-bold text-purple-700">Û° Ø§Ø² Û°</span>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-full transition-colors duration-200 active:scale-[0.98]" data-close>ÙØ¹Ù„Ø§Ù‹ Ù†Ù‡</button>
            <button id="lr-redeem-confirm" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-3 rounded-full shadow-lg transition-all duration-200 active:scale-[0.98]">
              <span class="flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø§ÛŒØ²Ù‡
              </span>
            </button>
          </div>
        </div>

        <div id="lr-redeem-done" class="hidden text-center py-8">
          <div class="inline-flex p-4 rounded-full bg-gradient-to-br from-green-100 to-emerald-100 mb-4">
            <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <p class="text-xl font-bold text-green-600 mb-2">Ø¬Ø§ÛŒØ²Ù‡ Ø«Ø¨Øª Ø´Ø¯</p>
          <p class="text-gray-600">Ø¯Ø± Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´Ù‡</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  'use strict';

  const rewardsDisabled = localStorage.getItem('vit_vip_rewards_disabled') === '1';
  if (rewardsDisabled) {
    document.getElementById('loyalty-card')?.classList.add('hidden');
    document.getElementById('loyalty-disabled')?.classList.remove('hidden');
    return;
  }

  // ------- KEYS & HELPERS -------
  const KEY_PROGRESS = 'vitreenet_loyalty_current';   // Ù¾ÛŒØ´Ø±ÙØª ÙØ¹Ù„ÛŒ ØªØ§ Ø¬Ø§ÛŒØ²Ù‡
  const KEY_TOTAL    = 'vitreenet_booking_total';     // ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø±Ø²Ø±ÙˆÙ‡Ø§ (Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Â«Ø§ÙˆÙ„ÛŒÙ† Ù†ÙˆØ¨ØªÂ»)
  const AUTH_LS_KEY  = 'auth_user';                   // ÙÙ‚Ø· Ø­Ø§Ù„Øª ØªØ³Øª/Ø¯ÙÙ…Ùˆ

  const toFa = n => String(n).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);
  const reduce = () => window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function toast(msg, type = 'info') {
    if (typeof showToastDark === 'function') showToastDark(msg, { type });
  }

  // ------- ADAPTERS (Ù‚Ø§Ø¨Ù„ ØªØ¹ÙˆÛŒØ¶ Ø¨Ø§ Ø¨Ú©â€ŒØ§Ù†Ø¯) -------
  const adapters = {
    async getAuth() {
      if (window.__APP_USER__ && window.__APP_USER__.id) return { loggedIn: true, user: window.__APP_USER__ };
      try {
        const raw = localStorage.getItem(AUTH_LS_KEY);
        if (raw) return { loggedIn: true, user: JSON.parse(raw) };
      } catch (e) {}
      return { loggedIn: false, user: null };
    },
    async getBookingSummary(userId) {
      if (window.__BOOKING_SUMMARY__ && typeof window.__BOOKING_SUMMARY__.total === 'number') {
        return { total: window.__BOOKING_SUMMARY__.total };
      }
      const total = parseInt(localStorage.getItem(KEY_TOTAL) || '0', 10) || 0;
      return { total };
    }
  };

  // ------- MODAL -------
  function openModal(root) {
    root.classList.remove('hidden');
    const card = root.querySelector('.modal-card');
    requestAnimationFrame(() => { card.classList.remove('scale-95','opacity-0'); card.classList.add('scale-100','opacity-100'); });
  }
  function closeModal(root) {
    const card = root.querySelector('.modal-card');
    card.classList.add('scale-95','opacity-0'); card.classList.remove('scale-100','opacity-100');
    setTimeout(() => root.classList.add('hidden'), reduce()?0:200);
  }

  // ------- COPY (ØµÙ…ÛŒÙ…ÛŒ/Ù…ØªØ¹Ø§Ø¯Ù„) -------
  function copyFor(progress, current, target, reward) {
    const left = Math.max(0, target - current);
    const pick = (arr) => arr[(current + left) % arr.length];

    if (current >= target) {
      return pick([
        { h: 'Ø¬Ø§ÛŒØ²Ù‡â€ŒØª Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Øª ğŸ', sub: 'Ø¨Ø²Ù† Ø¨Ú¯ÛŒØ±ÛŒÙ…Ø´.',            help: 'Ø±ÙˆÛŒ Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ Ø§Ø¹Ù…Ø§Ù„Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….', cta: 'Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø§ÛŒØ²Ù‡' },
        { h: 'Ø­Ù„Ù‡! Ø±Ø³ÛŒØ¯ÛŒ Ø¨Ù‡ Ø¬Ø§ÛŒØ²Ù‡', sub: 'ÙÙ‚Ø· ÙØ¹Ø§Ù„Ø´ Ú©Ù†ÛŒÙ… Ùˆ ØªÙ…Ø§Ù….',  help: 'ØªÙˆ Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒØ´Ù‡.',    cta: 'Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø§ÛŒØ²Ù‡' },
        { h: 'Ø¨Ù‡ Ù‡Ø¯Ù Ø®ÙˆØ±Ø¯ÛŒ âœ¨',     sub: 'ÙˆÙ‚ØªÙ Ù†Ù‚Ø¯ Ú©Ø±Ø¯Ù†Ø´Ù‡.',         help: 'Ø¨Ø¹Ø¯ÛŒ Ú©Ù‡ Ø±Ø²Ø±Ùˆ Ú©Ù†ÛŒ Ù…ÛŒâ€ŒØ§ÙØªÙ‡.',      cta: 'Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø§ÛŒØ²Ù‡' },
      ]);
    }
    if (current * 2 === target) {
      return pick([
        { h: 'Ù†ØµÙØ´ Ø±ÙØª âœ…',      sub: 'Ú†Ù†Ø¯ ØªØ§ Ø¯ÛŒÚ¯Ù‡ Ù…ÙˆÙ†Ø¯Ù‡.',  help: `${left} Ù†ÙˆØ¨Øª Ù…ÙˆÙ†Ø¯Ù‡.`, cta: 'Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ' },
        { h: 'Ù†ØµÙ Ø±Ø§Ù‡ÛŒ! ğŸ‘Œ',     sub: 'Ø¨Ø§ Ù‡Ù…ÛŒÙ† ÙØ±Ù…ÙˆÙ† Ø¨Ø±Ùˆ.',  help: `${left} Ù†ÙˆØ¨Øª Ù…ÙˆÙ†Ø¯Ù‡.`, cta: 'Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ' },
      ]);
    }
    if (progress >= 90) {
      return pick([
        { h: 'ÛŒÙ‡ Ù‚Ø¯Ù… ØªØ§ Ø¬Ø§ÛŒØ²Ù‡',  sub: 'Ù‡Ù…ÛŒÙ† ÛŒÚ©ÛŒ Ø¯ÛŒÚ¯Ù‡.',      help: left <= 1 ? 'Ø¨Ø§ Ù†ÙˆØ¨Øª Ø¨Ø¹Ø¯ÛŒ Ù…ÛŒâ€ŒØ±Ø³ÛŒ.' : `${left} Ù†ÙˆØ¨Øª Ù…ÙˆÙ†Ø¯Ù‡.`, cta: 'Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ' },
        { h: 'ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ø±Ø³ÛŒØ¯ÛŒ â³', sub: 'Ú©Ù… Ù…ÙˆÙ†Ø¯Ù‡ØŒ Ø¨Ø²Ù† Ø¨Ø±ÛŒÙ….', help: left <= 1 ? 'Ù†ÙˆØ¨Øª Ø¨Ø¹Ø¯ÛŒ Ú©Ø§ÙÛŒÙ‡.'    : `${left} Ù†ÙˆØ¨Øª Ù…ÙˆÙ†Ø¯Ù‡.`, cta: 'Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ' },
      ]);
    }
    if (progress >= 60) {
      return pick([
        { h: 'Ø®ÙˆØ¨ Ø¯Ø§Ø±ÛŒ Ù…ÛŒØ±ÛŒ ğŸš€', sub: 'Ù‡Ù…ÛŒÙ†Ùˆ Ù†Ú¯Ù‡ Ø¯Ø§Ø±.',      help: `${left} Ù†ÙˆØ¨Øª ØªØ§ Ø¬Ø§ÛŒØ²Ù‡.`, cta: 'Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ' },
        { h: 'Ù…Ø³ÛŒØ± Ø±Ùˆ Ú¯Ø±ÙØªÛŒ',   sub: 'ÛŒÚ©ÛŒâ€ŒÛŒÚ©ÛŒ Ø¬Ù„Ùˆ Ø¨Ø±Ùˆ.',    help: `${left} Ù†ÙˆØ¨Øª ØªØ§ Ø¬Ø§ÛŒØ²Ù‡.`, cta: 'Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ' },
      ]);
    }
    if (current > 0) {
      return pick([
        { h: 'Ø´Ø±ÙˆØ¹ Ø®ÙˆØ¨ÛŒ Ø²Ø¯ÛŒ',   sub: 'Ù†Ø°Ø§Ø± ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙØªÙ‡.',   help: `${left} Ù†ÙˆØ¨Øª Ù…ÙˆÙ†Ø¯Ù‡.`,    cta: 'Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ' },
        { h: 'Ø§ÙˆÙ„Ù‡ Ø±Ø§Ù‡ÛŒ ÙˆÙ„ÛŒ Ø±Ùˆ ØºÙ„ØªÚ©ÛŒ', sub: 'Ù‚Ø¯Ù… Ø¨Ø¹Ø¯ÛŒ Ø±Ùˆ Ø¨Ø±Ø¯Ø§Ø±.', help: `${left} Ù†ÙˆØ¨Øª Ù…ÙˆÙ†Ø¯Ù‡.`, cta: 'Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ' },
      ]);
    }
    return pick([
      { h: 'Ø¨Ù‡ Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ ğŸ‘‹', sub: 'Ø§ÙˆÙ„ÛŒÙ† Ù†ÙˆØ¨Øª Ø±Ùˆ Ø¨Ú¯ÛŒØ± Ùˆ Ø¨Ø±ÛŒÙ….', help: `Ø¨Ø§ ${target} Ù†ÙˆØ¨ØªØŒ ${reward}.`, cta: 'Ø±Ø²Ø±Ùˆ Ø§ÙˆÙ„ÛŒÙ† Ù†ÙˆØ¨Øª' },
      { h: 'Ø§Ø² Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†',     sub: 'Ø§ÙˆÙ„ÛŒÙ† Ø±Ø²Ø±Ùˆ = ÛŒÙ‡ Ù‚Ø¯Ù… Ø¬Ù„Ùˆ.',   help: `Ø¨Ø§ ${target} Ù†ÙˆØ¨ØªØŒ ${reward}.`, cta: 'Ø±Ø²Ø±Ùˆ Ø§ÙˆÙ„ÛŒÙ† Ù†ÙˆØ¨Øª' },
    ]);
  }

  // ------- AUTH / HISTORY -------
  let AUTH = { loggedIn: false, user: null };
  let HAS_BOOKED_BEFORE = false;

  function chooseCtaText(current, target) {
    if (current >= target) return 'Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø§ÛŒØ²Ù‡';
    return HAS_BOOKED_BEFORE ? 'Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ' : 'Ø±Ø²Ø±Ùˆ Ø§ÙˆÙ„ÛŒÙ† Ù†ÙˆØ¨Øª';
  }

  function applyCtaText(text) {
    const l1 = document.getElementById('lr-cta-label');
    if (l1) l1.textContent = text;
    const l2 = document.getElementById('lr-cta-mobile-label');
    if (l2) l2.textContent = (text === 'Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø§ÛŒØ²Ù‡') ? 'Ø¯Ø±ÛŒØ§ÙØª' : (text === 'Ø±Ø²Ø±Ùˆ Ø§ÙˆÙ„ÛŒÙ† Ù†ÙˆØ¨Øª' ? 'Ø´Ø±ÙˆØ¹' : 'Ø±Ø²Ø±Ùˆ');
  }

  function updateSticky(current, target) {
    const pct = Math.min(100, Math.max(0, (current/target)*100));
    const stickyTxt = document.getElementById('lr-sticky-progress');
    const bar = document.getElementById('lr-sticky-bar');
    if (stickyTxt) stickyTxt.textContent = `${toFa(current)} Ø§Ø² ${toFa(target)}`;
    if (bar) bar.style.width = pct + '%';
  }

  function redirectToLogin() {
    const data = document.getElementById('lr-data');
    const loginUrl = data.dataset.loginUrl || '/login';
    const redirect = encodeURIComponent(window.location.href);
    window.location.href = `${loginUrl}?redirect=${redirect}`;
  }

  function requireLogin() {
    toast('Ø§ÙˆÙ„ ÛŒÙ‡ ÙˆØ±ÙˆØ¯ Ú©ÙˆÚ†ÛŒÚ© Ù„Ø§Ø²Ù… Ø¯Ø§Ø±ÛŒÙ…Ø› Ø³Ø±ÛŒØ¹ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ… Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ ğŸ™‚');
    setTimeout(redirectToLogin, 900);
  }

  // ------- INIT CARD -------
  function initCard() {
    const data = document.getElementById('lr-data');
    const target = parseInt(data.dataset.target || '10', 10);
    const reward = data.dataset.reward || '';

    // Ù…Ù‚Ø¯Ø§Ø± Ø®Ø§Ù… (Ù…Ù…Ú©Ù†Ù‡ Ø§Ø² Ø³Ø±ÙˆØ± ÛŒØ§ Ù„ÙˆÚ©Ø§Ù„ Ø¨ÛŒØ§Ø¯)
    const raw = parseInt(localStorage.getItem(KEY_PROGRESS) ?? data.dataset.current ?? '0', 10) || 0;

    // Ø§Ú¯Ø± Ù„Ø§Ú¯ÛŒÙ† Ù†ÛŒØ³Øª ÛŒØ§ Ù‡Ø±Ú¯Ø² Ø±Ø²Ø±Ùˆ Ù†Ú©Ø±Ø¯Ù‡ â‡’ ØµÙØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    const current = (!AUTH.loggedIn || !HAS_BOOKED_BEFORE) ? 0 : raw;

    document.getElementById('reward-target').textContent = toFa(target);
    document.getElementById('reward-text').textContent   = reward;

    const pct = Math.min(100, Math.max(0, Math.round((current/target)*100)));
    const {h, sub, help} = copyFor(pct, current, target, reward);

    document.getElementById('lr-headline').textContent = h;
    document.getElementById('lr-sub').textContent      = sub;
    document.getElementById('lr-helper').textContent   = help;

    document.getElementById('lr-counts').textContent   = `${toFa(current)} Ø§Ø² ${toFa(target)}`;
    document.getElementById('lr-bar').style.width      = pct + '%';

    const left = Math.max(0, target - current);
    const mCur = document.getElementById('lr-m-current');
    const mLeft = document.getElementById('lr-m-left');
    if (mCur)  mCur.textContent  = toFa(current);
    if (mLeft) mLeft.textContent = toFa(left);

    const ri = document.getElementById('lr-reward-inline');
    if (ri) ri.textContent = reward;
    const rc = document.getElementById('lr-redeem-counts');
    if (rc) rc.textContent = `${toFa(current)} Ø§Ø² ${toFa(target)}`;

    applyCtaText(chooseCtaText(current, target));
    updateSticky(current, target);

    // Ø¨Ø±Ø§ÛŒ Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
    data.dataset.current = String(current);
  }

  // ------- EVENTS -------
  function bindEvents() {
    const data = document.getElementById('lr-data');

    document.getElementById('lr-rules')?.addEventListener('click', () => {
      document.getElementById('lr-rules-content').textContent = data.dataset.rules || '';
      openModal(document.getElementById('lrRulesModal'));
    });

    document.querySelectorAll('#lrRulesModal [data-close], #lrRedeemModal [data-close]').forEach(b=>{
      b.addEventListener('click', e => closeModal(e.target.closest('[role="dialog"]')));
    });
    ['lrRulesModal','lrRedeemModal'].forEach(id=>{
      const m = document.getElementById(id);
      if (m) m.addEventListener('click', e => { if (e.target.hasAttribute('data-close')) closeModal(m); });
    });
    document.addEventListener('keydown', e => {
      if (e.key==='Escape') ['lrRulesModal','lrRedeemModal'].forEach(id=>{
        const m=document.getElementById(id); if(m && !m.classList.contains('hidden')) closeModal(m);
      });
    });

    // --- CTA ---
    async function goCTA() {
      const data = document.getElementById('lr-data');
      if (!data) return;

      const target  = parseInt(data.dataset.target  || '10', 10);
      const current = parseInt(data.dataset.current || '0', 10);

      // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù„Ø§Ú¯ÛŒÙ† Ù†ÛŒØ³Øª ÙˆÙ„ÛŒ CTA Â«Ø±Ø²Ø±Ùˆ Ø§ÙˆÙ„ÛŒÙ† Ù†ÙˆØ¨ØªÂ» Ø§Ø³ØªØŒ Ù…Ø³ØªÙ‚ÛŒÙ… ÙˆØ§Ø±Ø¯ ÙˆÛŒØ²Ø§Ø±Ø¯ Ø´Ùˆ
      const ctaText    = document.getElementById('lr-cta-label')?.textContent?.trim();
      const isFirstCTA = (ctaText === 'Ø±Ø²Ø±Ùˆ Ø§ÙˆÙ„ÛŒÙ† Ù†ÙˆØ¨Øª') || (!AUTH.loggedIn && !HAS_BOOKED_BEFORE);

      if (!AUTH.loggedIn && !isFirstCTA) {
        requireLogin();
        return;
      }

      if (current >= target && AUTH.loggedIn) {
        openModal(document.getElementById('lrRedeemModal'));
        return;
      }

      // Ù‚ÙÙ„ Ø±Ø²Ø±Ùˆ ØªØ§ ØªØ§ÛŒÛŒØ¯ Ù‚Ø¨Ù„ÛŒ
      const lsHasPending = () => {
        try {
          const b = JSON.parse(localStorage.getItem('vt:lastBooking') || 'null');
          return !!(b && b.status === 'pending');
        } catch(e){ return false; }
      };
      const hasPending =
        typeof window.hasPendingBooking === 'function'
          ? await window.hasPendingBooking()
          : lsHasPending();

      if (hasPending) {
        if (typeof window.openModalById === 'function' && document.getElementById('pendingBlockModal')) {
          window.openModalById('pendingBlockModal');
        } else if (typeof showToastDark === 'function') {
          showToastDark('Ù†ÙˆØ¨Øª Ù‚Ø¨Ù„ÛŒâ€ŒØª Ù‡Ù†ÙˆØ² ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡. Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒ ØªØ§ ØªØ£ÛŒÛŒØ¯ Ø¨Ø´Ù‡ âœ‹', { type: 'info' });
        } else {
          alert('Ù†ÙˆØ¨Øª Ù‚Ø¨Ù„ÛŒ Ù‡Ù†ÙˆØ² ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
        }
        return;
      }

      // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙˆÛŒØ²Ø§Ø±Ø¯ Ø±Ø²Ø±Ùˆ
      if (typeof window.openBookingWizard === 'function') {
        window.openBookingWizard();
        return;
      }

      const ids = ['booking-wizard', 'booking', 'reserve', 'reservation'];
      let el = null;
      for (const id of ids) { const t = document.getElementById(id); if (t) { el = t; break; } }
      if (el) {
        if (el.classList.contains('hidden')) el.classList.remove('hidden');
        const top = el.getBoundingClientRect().top + window.scrollY - 80;
        (reduce() ? window.scrollTo(0, top) : window.scrollTo({ top, behavior:'smooth' }));
      } else {
        const url = data.dataset.bookingUrl;
        if (url) window.location.href = url; else toast('Ø¨Ø®Ø´ Ø±Ø²Ø±Ùˆ Ù‡Ù†ÙˆØ² Ø¨Ø§Ù„Ø§ Ù†ÛŒÙˆÙ…Ø¯Ù‡');
      }
    }

    document.getElementById('lr-cta')?.addEventListener('click', goCTA);
    document.getElementById('lr-cta-mobile')?.addEventListener('click', goCTA);

    // ØªØ£ÛŒÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø§ÛŒØ²Ù‡ -> Ø±ÛŒØ³Øª Ù¾ÛŒØ´Ø±ÙØª (Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ ÙˆØ±ÙˆØ¯)
    document.getElementById('lr-redeem-confirm')?.addEventListener('click', () => {
      if (!AUTH.loggedIn) { requireLogin(); return; }
      document.getElementById('lr-redeem-body').classList.add('hidden');
      document.getElementById('lr-redeem-done').classList.remove('hidden');
      setTimeout(() => {
        localStorage.setItem(KEY_PROGRESS, '0');
        data.dataset.current = '0';
        closeModal(document.getElementById('lrRedeemModal'));
        document.getElementById('lr-redeem-done').classList.add('hidden');
        document.getElementById('lr-redeem-body').classList.remove('hidden');
        toast('Ø¬Ø§ÛŒØ²Ù‡ Ø«Ø¨Øª Ø´Ø¯Ø› Ù…Ø¨Ø§Ø±Ú©â€ŒØªÙ‡!', 'success');
        initCard();
      }, 250);
    });

    // ====== Ø´Ù…Ø§Ø±Ø´Ù Ø§Ù…Ù† Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ (Patch) ======
    const KEY_COUNTED = 'vit_loyalty_counted_ids'; // Ù„ÛŒØ³Øª Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø´Ù…Ø±Ø¯Ù‡â€ŒØ§ÛŒÙ…

    const _getCounted = () => {
      try { return new Set(JSON.parse(localStorage.getItem(KEY_COUNTED) || '[]')); }
      catch { return new Set(); }
    };
    const _setCounted = (set) => {
      try { localStorage.setItem(KEY_COUNTED, JSON.stringify([...set])); } catch {}
    };
    const _extractBookingId = (b) => {
      if (!b) return null;
      return (
        b.bookingId || b.id || b._id ||
        // fallback Ø§Ú¯Ø± Ø¨Ú©â€ŒØ§Ù†Ø¯ id Ù†Ø¯Ù‡
        [b.sellerId||'', b.phone||'', b.date||'', b.time||''].join('|')
      );
    };

    function syncFromConfirmedBooking(source = 'event') {
      const data = document.getElementById('lr-data');
      if (!data) return;

      let b = null;
      try { b = JSON.parse(localStorage.getItem('vt:lastBooking') || 'null'); } catch {}
      if (!b || String(b.status).toLowerCase().trim() !== 'confirmed') return;

      const bookingId = _extractBookingId(b);
      const counted = _getCounted();

      // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø§ÛŒÙ† Ø±Ø²Ø±Ùˆ Ø´Ù…Ø±Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ Ø®Ø±ÙˆØ¬
      if (bookingId && counted.has(bookingId)) return;

      // Ø§ÙØ²Ø§ÛŒØ´â€ŒÙ‡Ø§
      const cur   = parseInt(localStorage.getItem(KEY_PROGRESS) ?? data.dataset.current ?? '0', 10) || 0;
      const next  = cur + 1;
      localStorage.setItem(KEY_PROGRESS, String(next));

      const total = parseInt(localStorage.getItem(KEY_TOTAL) || '0', 10) || 0;
      localStorage.setItem(KEY_TOTAL, String(total + 1));

      // Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§ÛŒÙ† Ø±Ø²Ø±Ùˆ
      if (bookingId) { counted.add(bookingId); _setCounted(counted); }
      b._countedForLoyalty = true;
      try { localStorage.setItem('vt:lastBooking', JSON.stringify(b)); } catch {}

      HAS_BOOKED_BEFORE = true;

      // Ù†ÙˆØªÛŒÙ/Ø±ÙØ±Ø´ UI
      const target = parseInt(data.dataset.target || '10', 10);
      if (cur < target && next >= target) toast('ØªØ¨Ø±ÛŒÚ©! Ø¨Ù‡ Ø¬Ø§ÛŒØ²Ù‡ Ø±Ø³ÛŒØ¯ÛŒ ğŸ‰', 'success');

      data.dataset.current = String(next);
      initCard();
    }

    // ÙˆÙ‚ØªÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø² Ø¨Ø®Ø´ Booking Gate Ù…ÛŒâ€ŒØ¢ÛŒØ¯
    window.addEventListener('booking:status', (e) => {
      if (e?.detail?.status === 'confirmed') syncFromConfirmedBooking('booking:status');
    });

    // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨ÛŒÙ† ØªØ¨â€ŒÙ‡Ø§
    window.addEventListener('storage', (e) => {
      if (e.key === 'vt:lastBooking') {
        try {
          const v = JSON.parse(e.newValue || 'null');
          if (v?.status === 'confirmed') syncFromConfirmedBooking('storage');
        } catch {}
      }
    });

    // Ú†Ú© Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø³Ø¨Ú© (ÙˆÙ‚ØªÛŒ pending Ø§Ø³Øª)
    setInterval(async () => {
      try {
        const b = JSON.parse(localStorage.getItem('vt:lastBooking') || 'null');
        if (b && b.status === 'pending' && typeof window.hasPendingBooking === 'function') {
          const stillPending = await window.hasPendingBooking();
          if (!stillPending) {
            // hasPendingBooking Ø®ÙˆØ¯Ø´ vt:lastBooking Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            syncFromConfirmedBooking('poll');
          }
        }
      } catch {}
    }, 30000);

    // ÛŒÚ©â€ŒØ¨Ø§Ø± Ø±ÙˆÛŒ Ù„ÙˆØ¯ ØµÙØ­Ù‡
    document.addEventListener('DOMContentLoaded', () => syncFromConfirmedBooking('boot'));

    // Ù…Ø®ÙÛŒâ€ŒÚ©Ø±Ø¯Ù† Ø§Ø³ØªÛŒÚ©ÛŒ ÙˆÙ‚ØªÛŒ CTA Ø¯Ø§Ø®Ù„ ÙˆÛŒÙˆ
    const stickyWrap = document.getElementById('lr-sticky');
    const cta = document.getElementById('lr-cta');
    if (stickyWrap && cta && 'IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          stickyWrap.style.transform = entry.isIntersecting ? 'translateY(100%)' : 'translateY(0)';
        });
      }, { threshold: 0.5 });
      io.observe(cta);
    }
  }

  // ------- BOOTSTRAP -------
  async function initAuthAndHistory() {
    AUTH = await adapters.getAuth();
    const sum = await adapters.getBookingSummary(AUTH.user?.id);
    HAS_BOOKED_BEFORE = (sum?.total || 0) > 0;
    initCard();
  }

  // Ø¨Ø§ Ù‡Ø± ØªØºÛŒÛŒØ± Ù„Ø§Ú¯ÛŒÙ†/Ú©Ø§Ø±Ø¨Ø±ØŒ Ú©Ø§Ø±Øª Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  document.addEventListener('auth:changed', initAuthAndHistory);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { bindEvents(); initAuthAndHistory(); });
  } else {
    bindEvents();
    initAuthAndHistory();
  }
})();
</script>

<!-- ========== /Loyalty Rewards ========== -->










    
   <!-- Customer Reviews Section - Complete with Review Form -->
<section class="py-8 px-4">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
        <div>
            <h3 class="text-xl font-bold mb-1">Ù†Ø¸Ø±Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
            <div class="flex items-center gap-2">
                <div id="review-stars" class="flex items-center"></div>
                <span id="review-average" class="text-sm font-bold text-gray-700">Û°</span>
                <span id="review-count-text" class="text-sm text-gray-500">(Û° Ù†Ø¸Ø±)</span>


                <button id="rate-now-chip" type="button"
  class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full
         bg-gradient-to-r from-blue-600 to-teal-500 text-white
         text-[11px] sm:text-xs md:text-sm font-bold shadow-sm
         hover:shadow-md active:scale-95 focus:outline-none
         focus-visible:ring-2 focus-visible:ring-blue-500">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
       class="w-4 h-4" fill="currentColor" aria-hidden="true">
    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
  </svg>
  <span class="hidden xs:inline sm:inline">Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²</span>
  <span class="sm:hidden"> Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²</span>
</button>

            </div>
        </div>
        
        <!-- Buttons Container -->
        <div class="flex items-center gap-2 w-full sm:w-auto">
            <!-- Write Review Button -->
            <button id="write-review-btn" class="flex-1 sm:flex-initial flex items-center justify-center gap-2 px-4 py-2.5 bg-gradient-to-r from-blue-600 to-teal-500 text-white rounded-full text-sm font-bold hover:shadow-lg transform hover:scale-105 transition-all">
                <i class="fas fa-pen text-xs"></i>
                <span>Ø«Ø¨Øª Ù†Ø¸Ø±</span>
            </button>
            
            <!-- Show All Reviews Button -->
            <button id="show-all-reviews" class="flex-1 sm:flex-initial flex items-center justify-center gap-2 px-4 py-2.5 bg-white border border-gray-200 rounded-full text-sm font-bold text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm">
                <span>Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡</span>
                <i class="fas fa-arrow-left text-xs"></i>
            </button>
        </div>
    </div>
    
    <!-- Reviews Carousel -->
    <div id="reviews-container" class="scroll-container flex overflow-x-auto pb-4 space-x-4 space-x-reverse scrollbar-hide"></div>
</section>

<!-- Reviews Modal -->
<div id="reviewsModal" class="fixed inset-0 z-[120] hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300" id="reviews-backdrop"></div>
    
    <!-- Modal Container -->
    <div class="flex items-end sm:items-center justify-center min-h-full p-0 sm:p-4">
        <div id="reviews-modal-content" class="relative bg-white w-full sm:max-w-2xl md:max-w-3xl lg:max-w-4xl 
                                                  rounded-t-3xl sm:rounded-2xl shadow-2xl transform transition-all duration-300 
                                                  translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0
                                                  max-h-[90vh] sm:max-h-[85vh] flex flex-col">
            
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white rounded-t-3xl sm:rounded-t-2xl border-b border-gray-100 px-6 py-5 z-10">
                <!-- Drag Handle for Mobile -->
                <div class="sm:hidden w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Ù†Ø¸Ø±Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
                        <div class="flex items-center gap-3">
                            <div id="modal-stars" class="flex items-center gap-1"></div>
                            <span id="modal-average" class="font-bold text-gray-800">Û°</span>
                            <span id="modal-count" class="text-sm text-gray-500">Ø¨Ø± Ø§Ø³Ø§Ø³ Û° Ù†Ø¸Ø±</span>

                            <!-- Filter Chips -->
                            <div class="hidden sm:flex items-center gap-2 mr-4">
                                <button class="review-filter-chip active" data-filter="all">Ù‡Ù…Ù‡</button>
                                <button class="review-filter-chip" data-filter="5">5 Ø³ØªØ§Ø±Ù‡</button>
                                <button class="review-filter-chip" data-filter="4">4 Ø³ØªØ§Ø±Ù‡</button>
                                <button class="review-filter-chip" data-filter="3">3 Ø³ØªØ§Ø±Ù‡</button>
                            </div>
                        </div>
                    </div>
                    
                    <button id="close-reviews-modal" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 
                                                            flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
                
                <!-- Mobile Filter Chips -->
                <div class="sm:hidden flex items-center gap-2 mt-3 overflow-x-auto scrollbar-hide">
                    <button class="review-filter-chip active" data-filter="all">Ù‡Ù…Ù‡</button>
                    <button class="review-filter-chip" data-filter="5">5 Ø³ØªØ§Ø±Ù‡</button>
                    <button class="review-filter-chip" data-filter="4">4 Ø³ØªØ§Ø±Ù‡</button>
                    <button class="review-filter-chip" data-filter="3">3 Ø³ØªØ§Ø±Ù‡</button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto px-6 py-4">
                <!-- Rating Summary -->
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-5 mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="text-center sm:text-right">
                            <div id="summary-average" class="text-4xl font-bold text-gray-900 mb-1">Û°</div>
                            <div id="summary-stars" class="flex items-center justify-center sm:justify-start gap-1 mb-2"></div>
                            <div id="summary-count" class="text-sm text-gray-600">Û° Ù†Ø¸Ø± Ø«Ø¨Øª Ø´Ø¯Ù‡</div>
                        </div>

        <div class="space-y-2">
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600 w-12">5 Ø³ØªØ§Ø±Ù‡</span>
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="bar-5" class="h-full bg-yellow-400 rounded-full" style="width: 0%"></div>
            </div>
            <span id="count-5" class="text-xs text-gray-600 w-8">0</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600 w-12">4 Ø³ØªØ§Ø±Ù‡</span>
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="bar-4" class="h-full bg-yellow-400 rounded-full" style="width: 0%"></div>
            </div>
            <span id="count-4" class="text-xs text-gray-600 w-8">0</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600 w-12">3 Ø³ØªØ§Ø±Ù‡</span>
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="bar-3" class="h-full bg-yellow-400 rounded-full" style="width: 0%"></div>
            </div>
            <span id="count-3" class="text-xs text-gray-600 w-8">0</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600 w-12">2 Ø³ØªØ§Ø±Ù‡</span>
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="bar-2" class="h-full bg-yellow-400 rounded-full" style="width: 0%"></div>
            </div>
            <span id="count-2" class="text-xs text-gray-600 w-8">0</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600 w-12">1 Ø³ØªØ§Ø±Ù‡</span>
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="bar-1" class="h-full bg-yellow-400 rounded-full" style="width: 0%"></div>
            </div>
            <span id="count-1" class="text-xs text-gray-600 w-8">0</span>
          </div>
        </div>
                    </div>
                </div>

                <!-- Write Review CTA in Modal -->
                <div class="mb-6">
                    <button id="write-review-modal-btn" class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-blue-600 to-teal-500 text-white rounded-xl font-bold hover:shadow-lg transform hover:scale-105 transition-all">
                        <i class="fas fa-pen ml-2"></i>
                        Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯
                    </button>
                </div>
                
                <!-- Reviews List -->
                <div class="space-y-4" id="reviews-list"></div>

                <!-- Load More Button -->
                <div class="text-center mt-6">
                    <button class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-full transition-colors">
                        Ù†Ù…Ø§ÛŒØ´ Ù†Ø¸Ø±Ø§Øª Ø¨ÛŒØ´ØªØ±
                        <i class="fas fa-chevron-down mr-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Form Modal -->
<div id="reviewFormModal" class="fixed inset-0 z-[120] hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300" id="review-form-backdrop"></div>
    
    <div class="flex items-end sm:items-center justify-center min-h-full p-0 sm:p-4">
        <div id="review-form-content" class="relative bg-white w-full sm:max-w-lg rounded-t-3xl sm:rounded-2xl shadow-2xl transform transition-all duration-300 translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0 max-h-[90vh] overflow-y-auto">
            
            <!-- Mobile Drag Handle -->
            <div class="sm:hidden sticky top-0 bg-white rounded-t-3xl py-3 z-10">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto"></div>
            </div>
            
            <div class="p-6">
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Ø«Ø¨Øª Ù†Ø¸Ø± Ø¬Ø¯ÛŒØ¯</h3>
                    <button id="close-review-form" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
                
                <!-- Form -->
                <form id="review-form">
                    <!-- Rating Stars -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-3">Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§</label>
                        <div class="flex items-center gap-3">
                            <div class="rating-stars flex gap-2">
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="1"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="2"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="3"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="4"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="5"></i>
                            </div>
                            <span id="rating-text" class="text-sm font-bold text-gray-600"></span>
                        </div>
                    </div>
                    
                    <!-- Name -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2" for="reviewer-name">Ù†Ø§Ù… Ø´Ù…Ø§</label>
                        <input type="text" id="reviewer-name" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" required>
                    </div>
                    
                    <!-- Service Used -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2" for="service-used">Ø®Ø¯Ù…Øª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡</label>
                        <select id="service-used" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                        </select>
                    </div>
                    
                    <!-- Review Text -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2" for="review-text">Ù†Ø¸Ø± Ø´Ù…Ø§</label>
                        <textarea id="review-text" rows="4" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none transition-all" placeholder="ØªØ¬Ø±Ø¨Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø¨Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯..." required></textarea>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500">Ø­Ø¯Ø§Ù‚Ù„ 20 Ú©Ø§Ø±Ø§Ú©ØªØ±</span>
                            <span id="char-counter" class="text-xs text-gray-500">0/500</span>
                        </div>
                    </div>
                    
                    <!-- Recommend Checkbox -->
                    <div class="mb-6">
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" id="recommend-checkbox" class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 mt-0.5">
                            <span class="text-sm text-gray-700">Ø§ÛŒÙ† Ø¢Ø±Ø§ÛŒØ´Ú¯Ø§Ù‡ Ø±Ø§ Ø¨Ù‡ Ø¯ÙˆØ³ØªØ§Ù†Ù… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ù…</span>
                        </label>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="flex gap-3">
                        <button type="button" id="cancel-review" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-xl transition-colors">
                            Ø§Ù†ØµØ±Ø§Ù
                        </button>
                        <button type="submit" id="submit-review" data-no-loader
                            class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-teal-500 text-white font-bold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø±
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Styles for Reviews -->
<style>
/* Review Cards */
.review-card {
    transition: all 0.3s ease;
}

.review-card:hover {
    transform: translateY(-2px);
}

/* Modal Animations */
#reviewsModal.show #reviews-backdrop,
#reviewFormModal.show #review-form-backdrop {
    opacity: 1;
}

#reviewsModal.show #reviews-modal-content,
#reviewFormModal.show #review-form-content {
    transform: translateY(0) !important;
    opacity: 1 !important;
}

@media (min-width: 640px) {
    #reviewsModal.show #reviews-modal-content,
    #reviewFormModal.show #review-form-content {
        transform: scale(1) !important;
    }
}

/* Filter Chips */
.review-filter-chip {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    background: white;
    color: #4b5563;
    border: 1px solid #e5e7eb;
    transition: all 0.2s;
    white-space: nowrap;
}

.review-filter-chip:hover {
    background: #f9fafb;
    border-color: #d1d5db;
}

.review-filter-chip.active {
    background: linear-gradient(135deg, #3b82f6, #06b6d4);
    color: white;
    border-color: transparent;
}

/* Line Clamp for Long Reviews */
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Read More Button Animation */
.read-more-btn {
    display: inline-flex;
    align-items: center;
    transition: all 0.2s;
}

.read-more-btn:hover {
    gap: 4px;
}

.read-more-btn i {
    transition: transform 0.2s;
}

.read-more-btn.expanded i {
    transform: rotate(180deg);
}

/* Rating Stars Animation */
.rating-star {
    transition: all 0.2s;
}

.rating-star:hover {
    transform: scale(1.1);
}

.rating-star.filled {
    color: #facc15 !important;
}


/* Mobile Specific Styles */
@media (max-width: 640px) {
    #reviews-modal-content,
    #review-form-content {
        min-height: 70vh;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }
}

/* Smooth Scrollbar */
.scrollbar-hide::-webkit-scrollbar {
    display: none;
}

.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}


@media (max-width: 640px){
  #review-form-content{ 
    padding-bottom: max(16px, env(safe-area-inset-bottom));
  }
}






/* Map container with footer image */
.footer-image-map {
  position: relative;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
}

.footer-image-map::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.4));
  pointer-events: none;
}

.footer-image-map img {
  width: 100%;
  height: auto;
  display: block;
  max-height: none;
  object-fit: contain;
}

/* Fallback text styling when no image */
#map-container:not(.footer-image-map) {
  display: flex;
  align-items: center;
  justify-content: center;
  color: #6b7280;
  font-size: 14px;
}


</style>

<!-- JavaScript for Reviews (fixed) -->
<script>
document.addEventListener('DOMContentLoaded', async function() {
  // ====== Elements ======
  const reviewsModal = document.getElementById('reviewsModal');
  const reviewsModalContent = document.getElementById('reviews-modal-content');
  const showAllBtn = document.getElementById('show-all-reviews');
  const closeReviewsBtn = document.getElementById('close-reviews-modal');
  const reviewsBackdrop = document.getElementById('reviews-backdrop');

  const reviewFormModal = document.getElementById('reviewFormModal');
  const reviewFormContent = document.getElementById('review-form-content');
  const writeReviewBtn = document.getElementById('write-review-btn');
  const writeReviewModalBtn = document.getElementById('write-review-modal-btn');
  const closeReviewFormBtn = document.getElementById('close-review-form');
  const reviewFormBackdrop = document.getElementById('review-form-backdrop');
  const cancelReviewBtn = document.getElementById('cancel-review');

  const rateNowChip = document.getElementById('rate-now-chip');
  if (rateNowChip) rateNowChip.addEventListener('click', () => writeReviewBtn?.click());

  function setReviewActions(enabled) {
    [showAllBtn, writeReviewBtn, writeReviewModalBtn, rateNowChip].forEach(btn => {
      if (!btn) return;
      btn.disabled = !enabled;
      btn.classList.toggle('hidden', !enabled);
    });
  }

  // ====== Form refs ======
  const reviewForm = document.getElementById('review-form');
  const ratingStars = document.querySelectorAll('.rating-star');
  const ratingText = document.getElementById('rating-text');
  const reviewTextarea = document.getElementById('review-text');
  const charCounter = document.getElementById('char-counter');
  const submitBtn = document.getElementById('submit-review');
  const serviceSelect = document.getElementById('service-used');

  // Populate service dropdown when services are loaded
  document.addEventListener('services:loaded', e => {
    if (!serviceSelect) return;
    const items = Array.isArray(e.detail) ? e.detail.filter(it => it.isActive) : [];
    serviceSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
    items.forEach(it => {
      const title = it.title || '';
      const opt = document.createElement('option');
      opt.value = title;
      opt.textContent = title;
      serviceSelect.appendChild(opt);
    });
  });

  // ====== Helpers ======
  const toFa = s => String(s).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);
  const toFaNum = n => toFa(String(n));
  const escapeHTML = (str='') => str
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  // Ø¢Ù¾Ø¯ÛŒØª Ù‡Ù…Ù‡ Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ id ØªÚ©Ø±Ø§Ø±ÛŒ Ø¯Ø§Ø±Ù†Ø¯
  const qAllId = (id) => Array.from(document.querySelectorAll(`[id="${id}"]`));
  const setTextAllById = (id, text) => qAllId(id).forEach(el => el && (el.textContent = text));
  const setHTMLAllById = (id, html) => qAllId(id).forEach(el => el && (el.innerHTML = html));

  function showToast(msg, type='info'){ try { showToastDark(msg, {type}); } catch(_) { console.log(type.toUpperCase()+':', msg); } }

  const TOKEN_KEYS = ['access_token', 'token', 'jwt'];
  function getToken() {
    let t = null;
    for (const k of TOKEN_KEYS) {
      const val = localStorage.getItem(k);
      if (val) { t = val; break; }
    }
    if (!t) return null;
    try {
      const payload = JSON.parse(atob(t.split('.')[1] || ''));
      if (payload.exp * 1000 < Date.now()) {
        TOKEN_KEYS.forEach(k => localStorage.removeItem(k));
        return null;
      }
    } catch (_) {
      return null;
    }
    return t;
  }
  function clearToken() {
    TOKEN_KEYS.forEach(k => localStorage.removeItem(k));
  }
  const authHeaders = () => {
    const t = getToken();
    return t ? { 'Authorization': 'Bearer ' + t } : {};
  };

  // ====== Identity / Scope ======
  const body = document.body;
  const storeId = body?.dataset?.storeId || 'default';
  // Ù…Ù‚Ø§Ø¯ÛŒØ± shopurl Ùˆ sellerId Ø¨Ø¹Ø¯Ø§Ù‹ ØªØ¹ÛŒÛŒÙ† Ù…ÛŒâ€ŒØ´Ù†
  let shopurl = '';
  let sellerId = null;

  const userId = window.__APP_USER__?.id;
  const isAdmin = window.__APP_USER__?.isAdmin || window.__APP_USER__?.role === 'admin';

  const reviewKey = userId ? `review:last:${storeId}:${userId}` : `review:last:${storeId}`;
  function canSubmitReview() {
    if (isAdmin) return true;
    const last = localStorage.getItem(reviewKey);
    return !last || (Date.now() - parseInt(last || '0', 10)) > 86400000; // 24h
  }
  function markReviewSubmitted() {
    localStorage.setItem(reviewKey, Date.now().toString());
  }
  function updateSubmitState() {
    if (!submitBtn) return;
    if (canSubmitReview()) {
      submitBtn.disabled = false;
      submitBtn.removeAttribute('title');
    } else {
      submitBtn.disabled = true;
      submitBtn.title = 'Ø±ÙˆØ²Ø§Ù†Ù‡ ÛŒÚ© Ù†Ø¸Ø± Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø«Ø¨Øª Ú©Ù†ÛŒ.';
      showToast('Ø±ÙˆØ²Ø§Ù†Ù‡ ÛŒÚ© Ù†Ø¸Ø± Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø«Ø¨Øª Ú©Ù†ÛŒ.', 'info');
    }
  }

  // ====== Stars ======
  function starHtml(score, size='text-xs') {
    let html = '';
    for (let i=1;i<=5;i++){
      if (score >= i) html += `<i class="fas fa-star text-yellow-400 ${size}"></i>`;
      else if (score >= i-0.5) html += `<i class="fas fa-star-half-alt text-yellow-400 ${size}"></i>`;
      else html += `<i class="far fa-star text-gray-300 ${size}"></i>`;
    }
    return html;
  }
  function setStars(el, score, size='text-sm'){ if(el) el.innerHTML = starHtml(score, size); }
  function setStarsAllById(id, score, size='text-sm'){ qAllId(id).forEach(el => setStars(el, score, size)); }

  // ====== Data I/O ======
  async function fetchByUrl(url) {
    const res = await fetch(url, { credentials: 'include' });
    if (res.status === 404) return null;
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  async function loadReviews() {
    try {
      // Ensure we have the latest identifiers in case other scripts set them later
      if (!shopurl) {
        shopurl = document.body?.dataset?.shopurl || '';
      }
      if (!sellerId) {
        sellerId = document.body?.dataset?.sellerId || window.LAST_PUBLIC?.sellerId || null;
      }

      let data = null;

      if (shopurl) {
        // Ø­Ø§Ù„Øª Ù…Ø¹Ù…ÙˆÙ„: Ø§Ø² URL Ø´Ø§Ù¾ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
        data = await fetchByUrl(`/api/shopAppearance/url/${encodeURIComponent(shopurl)}`);
        sellerId = data?.sellerId || sellerId;
      } else if (sellerId) {
        // fallback Ø§Ú¯Ø± shopurl Ù†Ø¨ÙˆØ¯ ÙˆÙ„ÛŒ sellerId Ø¯Ø§Ø±ÛŒÙ…
        data = await fetchByUrl(`/api/shopAppearance/${encodeURIComponent(sellerId)}`);
      }

      if (!sellerId) {
        showToast('sellerId ÛŒØ§ shopurl Ù…Ø´Ø®Øµ Ù†ÛŒØ³ØªØ› Ø«Ø¨Øª Ù†Ø¸Ø± ØºÛŒØ±Ù…Ù…Ú©Ù†Ù‡.', 'error');
        renderReviews([]); // Ø®Ø§Ù„ÛŒ
        updateSummary(0, 0, []);
        setReviewActions(false);
        return;
      }

      if (!/^[0-9a-fA-F]{24}$/.test(sellerId)) {
        showToast('Ø´Ù†Ø§Ø³Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', 'error');
        renderReviews([]);
        updateSummary(0, 0, []);
        setReviewActions(false);
        return;
      }

      const reviewsRes = await fetchByUrl(`/api/shopAppearance/${encodeURIComponent(sellerId)}/reviews`);
      const reviews = Array.isArray(reviewsRes) ? reviewsRes : (reviewsRes?.reviews || []);
      const avg = typeof data?.averageRating === 'number'
                    ? data.averageRating
                    : (reviews.length ? (reviews.reduce((s,r)=>s+(+r.score||0),0) / reviews.length) : 0);
      const cnt = typeof data?.ratingCount === 'number'
                    ? data.ratingCount
                    : reviews.length;

      updateSummary(avg, cnt, reviews);
      renderReviews(reviews);
      setReviewActions(true);
    } catch (err) {
      console.error('load reviews failed', err);
      showToast('Ù„ÙˆØ¯ Ù†Ø¸Ø±Ø§Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.', 'error');
      renderReviews([]);
      updateSummary(0, 0, []);
      setReviewActions(false);
    }
  }

  // ====== Render ======
  function renderReviews(list) {
    const reviews = Array.isArray(list) ? list : (list?.reviews || []);
    const container = document.getElementById('reviews-container');
    const modalList = document.getElementById('reviews-list');
    if (container) container.innerHTML = '';
    if (modalList) modalList.innerHTML = '';

    if (!reviews.length) {
      container && (container.innerHTML = '<div class="w-full text-center text-gray-500 py-8">Ù‡Ù†ÙˆØ² Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>');
      modalList && (modalList.innerHTML = '<div class="w-full text-center text-gray-500 py-4">Ù‡Ù†ÙˆØ² Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>');
      return;
    }

    reviews.forEach(r => {
      const rawName =
        r.userName ||
        (r.userId && typeof r.userId === 'object'
          ? [r.userId.firstname, r.userId.lastname].filter(Boolean).join(' ')
          : '');
      const name = escapeHTML(rawName || 'Ú©Ø§Ø±Ø¨Ø±');
      const date = r.createdAt ? new Date(r.createdAt).toLocaleDateString('fa-IR') : '';
      const comment = escapeHTML(r.comment || '');
      const score = Math.max(1, Math.min(5, Number(r.score) || 0));
      const stars = starHtml(score);

      container && container.insertAdjacentHTML('beforeend', `
        <div class="review-card flex-shrink-0 w-80 bg-white rounded-2xl shadow-sm hover:shadow-md transition-shadow border border-gray-100 p-5">
          <div class="flex items-start justify-between mb-3">
            <div>
              <h4 class="font-bold text-gray-900 mb-1">${name}</h4>
              <div class="flex items-center gap-1">${stars}</div>
            </div>
            <span class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-full">${escapeHTML(date)}</span>
          </div>
          <p class="text-sm text-gray-700 leading-6">${comment}</p>
        </div>
      `);

      modalList && modalList.insertAdjacentHTML('beforeend', `
        <div class="review-item bg-white border border-gray-100 rounded-2xl p-5 hover:shadow-md transition-shadow" data-rating="${score}">
          <div class="flex items-start justify-between mb-3">
            <div>
              <h4 class="font-bold text-gray-900 mb-1">${name}</h4>
              <div class="flex items-center gap-2">
                <div class="flex items-center gap-1">${stars}</div>
                <span class="text-xs text-gray-400">â€¢</span>
                <span class="text-xs text-gray-500">${escapeHTML(date)}</span>
              </div>
            </div>
          </div>
          <div class="review-text-container">
            <p class="text-sm text-gray-700 leading-7 review-text">${comment}</p>
          </div>
        </div>
      `);
    });
  }

function updateSummary(avg, count, ratings) {
  // Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§
  setStarsAllById('review-stars', avg, 'text-xs');
  setStars(document.getElementById('modal-stars'), avg, 'text-xs');
  setStars(document.getElementById('summary-stars'), avg, 'text-sm');

  // Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†
  const avgStr = toFa((Number(avg)||0).toFixed(1).replace('.', 'Ù«'));
  setTextAllById('review-average', avgStr);
  setTextAllById('avg-rating', avgStr);
  
  // Update header ratings
  const avgEn = (Number(avg)||0).toFixed(1);
  const headerRatingMobile = document.getElementById('header-rating-mobile');
  if (headerRatingMobile) headerRatingMobile.textContent = avgStr;
  const headerRatingLg = document.getElementById('header-rating-lg');
  if (headerRatingLg) headerRatingLg.textContent = avgStr;
  
  const modalAvg = document.getElementById('modal-average');
  if (modalAvg) modalAvg.textContent = avgStr;
  const bigAvg = document.getElementById('summary-average');
  if (bigAvg) bigAvg.textContent = avgStr;

  // ØªØ¹Ø¯Ø§Ø¯
  const cntStr = toFaNum(count || 0);
  setTextAllById('review-count', cntStr);
  setTextAllById('review-count-text', `(${cntStr} Ù†Ø¸Ø±)`);
  
  // Update header counts
  const headerCountMobile = document.getElementById('header-count-mobile');
  if (headerCountMobile) headerCountMobile.textContent = cntStr;
  const headerCountLg = document.getElementById('header-count-lg');
  if (headerCountLg) headerCountLg.textContent = cntStr;
  
  const modalCount = document.getElementById('modal-count');
  if (modalCount) modalCount.textContent = `Ø¨Ø± Ø§Ø³Ø§Ø³ ${cntStr} Ù†Ø¸Ø±`;
  const bigCount = document.getElementById('summary-count');
  if (bigCount) bigCount.textContent = `${cntStr} Ù†Ø¸Ø± Ø«Ø¨Øª Ø´Ø¯Ù‡`;

  // ØªÙˆØ²ÛŒØ¹ 1..5
  const totals = [0,0,0,0,0];
  (ratings||[]).forEach(r => {
    const s = Math.max(1, Math.min(5, Number(r.score)||0));
    totals[s-1] += 1;
  });
  for (let s=1; s<=5; s++){
    const bar = document.getElementById(`bar-${s}`);
    const span = document.getElementById(`count-${s}`);
    const c = totals[s-1];
    const pct = count ? (c / count) * 100 : 0;
    if (bar) bar.style.width = `${pct}%`;
    if (span) span.textContent = toFaNum(c);
  }
}

  // ====== Modals ======
  function openReviewsModal(){
    if (!reviewsModal) return;
    reviewsModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    setTimeout(() => reviewsModal.classList.add('show'), 10);
  }
  function closeReviewsModal() {
    if (!reviewsModal) return;
    reviewsModal.classList.remove('show');
    setTimeout(() => {
      reviewsModal.classList.add('hidden');
      document.body.style.overflow = '';
    }, 300);
  }
  function openReviewForm() {
    if (!reviewFormModal) return;
    reviewFormModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    setTimeout(() => reviewFormModal.classList.add('show'), 10);
    updateSubmitState();
  }
  function closeReviewFormModal() {
    if (!reviewFormModal) return;
    reviewFormModal.classList.remove('show');
    setTimeout(() => {
      reviewFormModal.classList.add('hidden');
      document.body.style.overflow = '';
      // reset
      reviewForm?.reset();
      selectedRating = 0;
      ratingStars.forEach(star => {
        star.classList.remove('fas','filled');
        star.classList.add('far');
      });
      if (ratingText) ratingText.textContent = '';
      if (charCounter) charCounter.textContent = toFaNum('0/500');
    }, 300);
  }

  showAllBtn?.addEventListener('click', openReviewsModal);
  closeReviewsBtn?.addEventListener('click', closeReviewsModal);
  reviewsBackdrop?.addEventListener('click', closeReviewsModal);

  writeReviewBtn?.addEventListener('click', openReviewForm);
  writeReviewModalBtn?.addEventListener('click', openReviewForm);
  closeReviewFormBtn?.addEventListener('click', closeReviewFormModal);
  reviewFormBackdrop?.addEventListener('click', closeReviewFormModal);
  cancelReviewBtn?.addEventListener('click', closeReviewFormModal);

  // ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (reviewsModal && !reviewsModal.classList.contains('hidden')) closeReviewsModal();
      if (reviewFormModal && !reviewFormModal.classList.contains('hidden')) closeReviewFormModal();
    }
  });

  // Swipe close (mobile)
  function setupSwipeToClose(modalContent, closeFn){
    if (!modalContent) return;
    let startY=0, currentY=0, dragging=false;
    modalContent.addEventListener('touchstart', (e)=>{ if (innerWidth<=640){ startY=e.touches[0].clientY; dragging=true; }});
    modalContent.addEventListener('touchmove', (e)=>{ if(!dragging||innerWidth>640)return; currentY=e.touches[0].clientY; const dy=Math.max(0,currentY-startY); if(dy>0) modalContent.style.transform=`translateY(${dy}px)`; });
    modalContent.addEventListener('touchend', ()=>{ if(!dragging||innerWidth>640)return; const dy=currentY-startY; if(dy>100) closeFn(); else modalContent.style.transform=''; dragging=false; });
  }
  setupSwipeToClose(reviewsModalContent, closeReviewsModal);
  setupSwipeToClose(reviewFormContent, closeReviewFormModal);

  // ====== Filters ======
  const filterChips = document.querySelectorAll('.review-filter-chip');
  filterChips.forEach(chip=>{
    chip.addEventListener('click', function(){
      filterChips.forEach(c=>c.classList.remove('active'));
      this.classList.add('active');
      const filter = this.dataset.filter;
      document.querySelectorAll('.review-item').forEach(review=>{
        review.style.display = (filter==='all' || String(review.dataset.rating)===String(filter)) ? '' : 'none';
      });
    });
  });

  // ====== Rating UI ======
  const ratingMessages = ['', 'Ø¶Ø¹ÛŒÙ', 'Ù…ØªÙˆØ³Ø·', 'Ø®ÙˆØ¨', 'Ø¹Ø§Ù„ÛŒ', 'ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡'];
  let selectedRating = 0;

  function updateStars(rating){
    ratingStars.forEach((star, idx) => {
      if (idx < rating) {
        star.classList.remove('far');
        star.classList.add('fas','filled');
      } else {
        star.classList.remove('fas','filled');
        star.classList.add('far');
      }
    });
  }

  ratingStars.forEach(star=>{
    star.addEventListener('click', function(){
      selectedRating = parseInt(this.dataset.rating, 10) || 0;
      updateStars(selectedRating);
      if (ratingText) ratingText.textContent = ratingMessages[selectedRating] || '';
    });
    star.addEventListener('mouseenter', function(){
      const hover = parseInt(this.dataset.rating, 10) || 0;
      updateStars(hover);
      if (ratingText) ratingText.textContent = ratingMessages[hover] || '';
    });
  });
  document.querySelector('.rating-stars')?.addEventListener('mouseleave', function(){
    updateStars(selectedRating);
    if (ratingText) ratingText.textContent = selectedRating ? (ratingMessages[selectedRating]||'') : '';
  });

  // ====== Char counter ======
  reviewTextarea?.addEventListener('input', function(){
    let val = this.value;
    if (val.length > 500) { val = val.slice(0,500); this.value = val; }
    if (charCounter) charCounter.textContent = toFa(`${val.length}/500`);
  });
  if (charCounter) charCounter.textContent = toFa('0/500');

  // ====== Submit ======
  const POST_ENDPOINT = (sid) => `/api/shopAppearance/${encodeURIComponent(sid)}/rate`;

  reviewForm?.addEventListener('submit', async function(e){
    e.preventDefault();

    if (!canSubmitReview()) { showToast('Ø±ÙˆØ²Ø§Ù†Ù‡ ÛŒÚ© Ù†Ø¸Ø± Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø«Ø¨Øª Ú©Ù†ÛŒ.', 'info'); return; }
    if (!selectedRating) { showToast('Ù„Ø·ÙØ§Ù‹ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø¯Ù‡ ğŸ™‚', 'info'); return; }
    if (!reviewTextarea || reviewTextarea.value.trim().length < 20) { showToast('Ù…ØªÙ† Ù†Ø¸Ø± Ø­Ø¯Ø§Ù‚Ù„ Û²Û° Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ù‡.', 'error'); return; }

    // Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ sellerId Ø¯Ø§Ø±ÛŒÙ… Ùˆ Ù…Ø¹ØªØ¨Ø±Ù‡
    if (!sellerId) {
      // ØªÙ„Ø§Ø´ Ø¢Ø®Ø±: Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ú¯ÛŒØ±
      try { await loadReviews(); } catch {}
    }
    if (!sellerId || !/^[0-9a-fA-F]{24}$/.test(sellerId)) {
      showToast(sellerId ? 'Ø´Ù†Ø§Ø³Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª' : 'sellerId Ù†Ø§Ù…Ø´Ø®ØµÙ‡Ø› Ø«Ø¨Øª Ù†Ø¸Ø± Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª.', 'error');
      return;
    }

      const bookings = JSON.parse(localStorage.getItem('vitreenet-bookings') || '[]');
      if (!bookings.length) {
        showToast('Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø¸Ø± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù†ÙˆØ¨Øª Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´ÛŒØ¯.', 'error');
        return;
      }
      const token = getToken();

    const payload = {
      rating: selectedRating,
      comment: reviewTextarea.value.trim()
    };

    // Loading state
    const old = submitBtn?.innerHTML;
    if (submitBtn){
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';
    }

    // Ù…ÛŒâ€ŒØ¨Ù†Ø¯ÛŒÙ… Ú©Ù‡ UX Ø±ÙˆÙˆÙ† Ø¨Ø´Ù‡ØŒ ÙˆÙ„ÛŒ Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¨ÙˆØ¯ ØªÙˆØ³Øª Ù…ÛŒâ€ŒØ¯ÛŒÙ…
    closeReviewFormModal();

    try {
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers.Authorization = 'Bearer ' + token;
        const res = await fetch(POST_ENDPOINT(sellerId), {
          method: 'POST',
          headers,
          credentials: 'include',
          body: JSON.stringify(payload)
        });
      if (res.status === 401) {
        clearToken();
        showToast('Ù†Ø´Ø³Øª Ø´Ù…Ø§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡Ø› Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.', 'error');
        return;
      }
      if (!res.ok) throw new Error('HTTP '+res.status);

      markReviewSubmitted();
      showToast('Ù†Ø¸Ø± Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ù¾Ø³ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ğŸ™Œ', 'success');
      await loadReviews();
    } catch (err) {
      console.error('submit review failed', err);
      showToast('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø¸Ø±', 'error');
    } finally {
      if (submitBtn){
        submitBtn.disabled = false;
        submitBtn.innerHTML = old || 'Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø±';
      }
    }
  });

  // ====== Boot ======
  const loc = await getShopUrlFromLocation();
  if (typeof loc === 'object') {
    shopurl = loc.shopurl || '';
    if (loc.sellerId) sellerId = loc.sellerId;
  } else {
    shopurl = loc || '';
  }
  if (!shopurl && !sellerId) {
    shopurl = body?.dataset?.shopurl || '';
    sellerId = body?.dataset?.sellerId || null;
  }
  async function handleServicesLoaded() {
    sellerId = document.body?.dataset?.sellerId || null;
    await loadReviews();
  }

  document.addEventListener('services:loaded', handleServicesLoaded);

  if (document.body?.dataset?.sellerId) {
    await handleServicesLoaded();
  }
});
</script>

    <!-- Store Info & Contact -->
    <section class="py-8 px-4">
        <h3 class="text-xl font-bold mb-4">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ ØªÙ…Ø§Ø³</h3>
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="mb-6">
                <div class="flex items-start mb-4">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                        <i class="fas fa-map-marker-alt text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-bold mb-1">Ø¢Ø¯Ø±Ø³</h4>
<p id="store-address" class="text-sm text-gray-700">Ø¢Ø¯Ø±Ø³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                    </div>
                </div>
                <div class="mb-4">
                    <div id="map-container" class="w-full max-w-3xl mx-auto min-h-[200px] rounded-lg overflow-hidden bg-gray-200">Ù†Ù‚Ø´Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                </div>
            </div>
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                        <i class="fas fa-phone text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-bold mb-1">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</h4>
<p id="store-phone" class="text-sm text-gray-700">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                    </div>
                </div>
            </div>
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                        <i class="fas fa-clock text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-bold mb-1">Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ</h4>
<p id="store-hours" class="text-sm text-gray-700">Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                    </div>
                </div>
            </div>
 

<div class="grid grid-cols-2 gap-3">
  <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ ÙˆÛŒØªØ±ÛŒÙ†Øª -->
  <a href="local***index.html"
     class="group inline-flex items-center justify-center gap-1.5 sm:gap-2 w-full
            rounded-2xl px-3.5 py-3 sm:px-4 sm:py-3.5 min-h-[52px] sm:min-h-[56px]
            font-extrabold text-white text-[13px] sm:text-[15px] shadow-lg
            bg-gradient-to-tr from-blue-600 to-teal-500 ring-1 ring-white/60
            transition-all hover:from-blue-700 hover:to-teal-600
            hover:shadow-[0_10px_25px_rgba(16,185,129,0.25)]
            active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
     aria-label="Ø±ÙØªÙ† Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ ÙˆÛŒØªØ±ÛŒÙ†Øª">
    <i class="fas fa-house ml-1.5 sm:ml-2 text-[14px] sm:text-base opacity-95 transition-transform group-active:scale-95"></i>
    <span class="truncate">ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ ÙˆÛŒØªØ±ÛŒÙ†Øª</span>
  </a>

  <!-- Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡ -->
  <a href="local***discover.html"
     class="group inline-flex items-center justify-center gap-1.5 sm:gap-2 w-full
            rounded-2xl px-3.5 py-3 sm:px-4 sm:py-3.5 min-h-[52px] sm:min-h-[56px]
            font-extrabold text-blue-800 text-[13px] sm:text-[15px]
            bg-gradient-to-tr from-sky-50/90 via-cyan-50/90 to-emerald-50/90
            backdrop-blur-md border border-white/60 shadow
            hover:from-sky-100/90 hover:via-cyan-100/90 hover:to-emerald-100/90 hover:shadow-lg
            active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500
            transition-all"
     aria-label="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡">
    <i class="fas fa-store ml-1.5 sm:ml-2 text-[14px] sm:text-base opacity-95 transition-transform group-active:scale-95"></i>
    <span class="truncate">Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡</span>
  </a>
</div>




        </div>
    </section>
    <!-- Mobile Navigation Bar -->

<footer id="site-footer" class="w-full mt-16 hide-on-mobile" aria-labelledby="vitreenet-footer-title">
  <h2 id="vitreenet-footer-title" class="sr-only">ÙˆÛŒØªØ±ÛŒÙ†Øª â€” ÙˆÛŒØªØ±ÛŒÙ† Ø¢Ù†Ù„Ø§ÛŒÙ† Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ</h2>

  <div class="bg-gradient-to-tr from-[#f8fafc] via-[#e0fdfa] to-[#d4fbe8]
              rounded-t-[1.7rem] border-t border-white/70
              shadow-[0_-12px_30px_rgba(0,0,0,0.06)]">
    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 py-10">

      <div class="grid grid-cols-1 md:grid-cols-4 gap-10">
        <!-- 1) Ø§Ø´Ø§Ø±Ù‡ Ø®ÛŒÙ„ÛŒ Ù…Ø®ØªØµØ± Ø¨Ù‡ Ù…ØºØ§Ø²Ù‡ -->
        <div>
          <div class="flex items-center gap-2 mb-2">
            <span class="inline-flex w-9 h-9 items-center justify-center rounded-xl
                         bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
              <i class="fa-solid fa-store"></i>
            </span>
            <p id="footer-shop-name" class="font-extrabold text-gray-800">Ø¢Ø±Ø§ÛŒØ´Ú¯Ø§Ù‡ Ù…Ø±Ø¯Ø§Ù†Ù‡ Ø³Ù„Ø·Ù†ØªÛŒ</p>
          </div>
          <p class="text-xs text-gray-600 leading-6">
            Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø± Ø¨Ø³ØªØ± <strong class="text-gray-800">ÙˆÛŒØªØ±ÛŒÙ†Øª</strong> Ù…ÛŒØ²Ø¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
          </p>
          <!-- Ø¨Ù†Ø§ Ø¨Ù‡ Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø¯Ú©Ù…Ù‡ Â«Ø±Ø²Ø±Ùˆ Ø³Ø±ÛŒØ¹Â» Ø­Ø°Ù Ø´Ø¯ -->
        </div>

        <!-- 2) ÙˆÛŒØªØ±ÛŒÙ†Øª Ø¯Ø± ÛŒÚ© Ù†Ú¯Ø§Ù‡ (Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†) -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="inline-flex w-9 h-9 items-center justify-center rounded-xl
                         bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
              <i class="fa-solid fa-compass"></i>
            </span>
            <p class="font-extrabold text-gray-800">ÙˆÛŒØªØ±ÛŒÙ†Øª Ø¯Ø± ÛŒÚ© Ù†Ú¯Ø§Ù‡</p>
          </div>

          <p class="text-sm text-gray-700 leading-7">
            Ø¨Ø§ ÙˆÛŒØªØ±ÛŒÙ†ØªØŒ ÙˆÛŒØªØ±ÛŒÙ† Ø¢Ù†Ù„Ø§ÛŒÙ†Ù Ù…ØºØ§Ø²Ù‡â€ŒØ§Øª Ø±Ø§ Ø¨Ø³Ø§Ø² Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†Ø›
            Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨ØªØŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù…Ù†ØŒ Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ù…Ø´ØªØ±ÛŒØ§Ù† Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ â€” Ù‡Ù…Ù‡ ÛŒÚ©â€ŒØ¬Ø§ Ùˆ Ø¨Ø¯ÙˆÙ† Ú©Ø¯Ù†ÙˆÛŒØ³ÛŒ.
          </p>

          <div class="mt-4 space-y-2">
            <a href="/" rel="home"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-white
                      bg-gradient-to-tr from-blue-600 to-teal-500 hover:from-blue-700 hover:to-teal-600
                      shadow-lg transition" aria-label="Ø±ÙØªÙ† Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ ÙˆÛŒØªØ±ÛŒÙ†Øª">
              ØµÙØ­Ù‡Ù” Ø§ØµÙ„ÛŒ ÙˆÛŒØªØ±ÛŒÙ†Øª
            </a>

            <a href="/discover"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-blue-700
                      bg-white/80 backdrop-blur border border-white/70 hover:bg-white hover:shadow transition"
               aria-label="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡ Ø¯Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª">
              Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡
            </a>
          </div>
        </div>

        <!-- 3) Ù…Ø²ÛŒØªâ€ŒÙ‡Ø§ (Ø®Ù„Ø§ØµÙ‡ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ) -->
        <div>
          <p class="font-extrabold text-gray-800 mb-3">Ú†Ø±Ø§ ÙˆÛŒØªØ±ÛŒÙ†ØªØŸ</p>
          <ul class="space-y-2 text-sm text-gray-700">
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> Ø±Ø²Ø±Ùˆ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¨Ø§ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù…Ù† Ùˆ ÙØ§Ú©ØªÙˆØ± Ø¯ÛŒØ¬ÛŒØªØ§Ù„</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ù…Ø´ØªØ±ÛŒØ§Ù† Ùˆ Ú©ÙˆÙ¾Ù†â€ŒÙ‡Ø§ÛŒ ØªØ®ÙÛŒÙ</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> Ø¸Ø§Ù‡Ø± Ø³Ø¨Ú©ØŒ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ Ùˆ Ø³Ø±ÛŒØ¹</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¢Ù…Ø§Ø± Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ</li>
          </ul>
        </div>

        <!-- 4) CTA Ø¨Ø±Ø§ÛŒ ØµØ§Ø­Ø¨Ø§Ù† Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± -->
        <div>
          <p class="font-extrabold text-gray-800 mb-3">Ø¨Ø±Ø§ÛŒ ØµØ§Ø­Ø¨Ø§Ù† Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±</p>
          <div class="space-y-3">
            <a href="/merchant/register"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-white
                      bg-gradient-to-tr from-blue-600 to-teal-500 hover:from-blue-700 hover:to-teal-600
                      shadow-lg transition" aria-label="Ø«Ø¨Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¯Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª">
              Ø«Ø¨Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¯Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª
            </a>
            <a href="/merchant/login"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-blue-700
                      bg-white/80 backdrop-blur border border-white/70 hover:bg-white hover:shadow transition"
               aria-label="ÙˆØ±ÙˆØ¯ ÙØ±ÙˆØ´Ù†Ø¯Ú¯Ø§Ù†">
              ÙˆØ±ÙˆØ¯ ÙØ±ÙˆØ´Ù†Ø¯Ú¯Ø§Ù†
            </a>
            <div class="text-xs text-gray-500 leading-6">
              Ú©Ù…ØªØ± Ø§Ø² Û³ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ â€” Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ
            </div>
          </div>
        </div>
      </div>

      <!-- Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ†ÛŒ -->
      <div class="mt-10 pt-4 border-t border-white/70
                  flex flex-col sm:flex-row items-center justify-between gap-3
                  text-gray-500 text-sm">
        <div class="flex items-center gap-2">
          <span class="inline-flex w-6 h-6 items-center justify-center rounded-lg
                       bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
            <i class="fa-solid fa-gem"></i>
          </span>
          <span>Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ <strong class="text-gray-700">ÙˆÛŒØªØ±ÛŒÙ†Øª</strong> â€” ÙˆÛŒØªØ±ÛŒÙ† Ø¢Ù†Ù„Ø§ÛŒÙ† Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ</span>
        </div>

        <p>Â© <span id="footer-year"></span> ÙˆÛŒØªØ±ÛŒÙ†Øª â€” Ù‡Ù…Ù‡ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.</p>

        <div class="flex items-center gap-2">
          <a href="/terms" class="hover:text-blue-700 transition">Ù‚ÙˆØ§Ù†ÛŒÙ†</a>
          <span class="text-gray-300">â€¢</span>
          <a href="/privacy" class="hover:text-blue-700 transition">Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ</a>
          <span class="text-gray-300">â€¢</span>
          <button id="back-to-top" class="chip chip--primary" aria-label="Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¨Ø§Ù„Ø§</button>
        </div>
      </div>

    </div>
  </div>
</footer>




<script>
  (function () {
    // Ø³Ø§Ù„ Ø´Ù…Ø³ÛŒ Ø¨Ø§ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ
    const yearEl = document.getElementById('footer-year');
    if (yearEl) {
      yearEl.textContent = new Intl.DateTimeFormat('fa-IR', { year: 'numeric' }).format(new Date());
    }

    // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¨Ø§Ù„Ø§ Ø¨Ø§ Ø§Ø³Ú©Ø±ÙˆÙ„ Ù†Ø±Ù… (Ø±Ø¹Ø§ÛŒØª Reduce Motion)
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const up = document.getElementById('back-to-top');
    if (up) {
      up.addEventListener('click', () => {
        if (prefersReduced) {
          window.scrollTo(0, 0);
        } else {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    }

    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ù†Ø±Ù… Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø¯Ø§Ø®Ù„ ÙÙˆØªØ± (#anchor)
    document.querySelectorAll('#site-footer a[href^="#"]').forEach(a => {
      a.addEventListener('click', (e) => {
        const id = a.getAttribute('href');
        const target = document.querySelector(id);
        if (!target) return;
        e.preventDefault();

        if (prefersReduced) {
          target.scrollIntoView();
        } else {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Ø¨Ù‡Ø¨ÙˆØ¯ Ø¯Ø³ØªØ±Ø³â€ŒÙ¾Ø°ÛŒØ±ÛŒ: ÙÙˆÚ©ÙˆØ³ Ù¾Ø³ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„
        target.setAttribute('tabindex', '-1');
        target.focus({ preventScroll: true });
      });
    });
  })();
</script>


    <script src="nav-active.js"></script>

    <script>
        // Modal functionality for portfolio images
        function openModal(imageSrc, title) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            
            modalImage.src = imageSrc;
            modalTitle.textContent = title;
            
            // Disable body scroll
            document.body.style.overflow = 'hidden';
            
            // Show modal with animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.relative').classList.add('scale-100', 'opacity-100');
                modal.querySelector('.relative').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
        function closeModal() {
            const modal = document.getElementById('imageModal');
            
            // Hide modal with animation
            modal.querySelector('.relative').classList.add('scale-95', 'opacity-0');
            modal.querySelector('.relative').classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                // Enable body scroll
                document.body.style.overflow = '';
            }, 300);
        }
        // Close modal when clicking outside the image
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        // Booking Wizard Logic
document.addEventListener('DOMContentLoaded', function () {
  // ---- Ø¹Ù†Ø§ØµØ± Ø§ØµÙ„ÛŒ
  const heroCta         = document.getElementById('hero-cta');
  const bookingWizard   = document.getElementById('booking-wizard');
  const prefersReduced  = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  const API_ROOT = window.__API_BASE__ || '';

  // Ù…Ø±Ø§Ø­Ù„ Ùˆ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§
  const step1 = document.getElementById('step-1');
  const step2 = document.getElementById('step-2');
  const step3 = document.getElementById('step-3');
  const step4 = document.getElementById('step-4');

  const currentStep     = document.getElementById('current-step');
  const progressBar     = document.getElementById('progress-bar');
  const step2Indicator  = document.getElementById('step-2-indicator');
  const step3Indicator  = document.getElementById('step-3-indicator');
  const step4Indicator  = document.getElementById('step-4-indicator');

  // Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ùˆ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
  let serviceOptions  = [];
  const dateOptions   = document.querySelectorAll('.date-option');
  const timeOptions   = document.querySelectorAll('.time-option');

  const nextToStep2     = document.getElementById('next-to-step-2');
  const nextToStep3     = document.getElementById('next-to-step-3');
  const nextToStep4     = document.getElementById('next-to-step-4');

  const backToStep1     = document.getElementById('back-to-step-1');
  const backToStep2     = document.getElementById('back-to-step-2');
  const backToStep3     = document.getElementById('back-to-step-3');

  // ÙÛŒÙ„Ø¯Ù‡Ø§ Ùˆ ØªØ§ÛŒÛŒØ¯
  const phoneNumber     = document.getElementById('phone-number');
  const customerName    = document.getElementById('customer-name');

  const confirmService  = document.getElementById('confirm-service');
  const confirmDate     = document.getElementById('confirm-date');
  const confirmTime     = document.getElementById('confirm-time');
  const confirmName     = document.getElementById('confirm-name');
  const confirmPhone    = document.getElementById('confirm-phone');
  const confirmPrice    = document.getElementById('confirm-price');

  const confirmBooking  = document.getElementById('confirm-booking');
  const bookingSuccess  = document.getElementById('booking-success');
  const closeBooking    = document.getElementById('close-booking');

  // ÙˆØ¶Ø¹ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§
  let selectedService = '';
  let selectedServiceId = '';
  let selectedPrice   = '';
  let selectedDate    = '';
  let selectedTime    = '';

  const priceFa = n => (Number(n)||0).toLocaleString('fa-IR');

  function bindServiceOptions() {
    serviceOptions = Array.from(document.querySelectorAll('#step-1 .service-option'));
    serviceOptions.forEach(option => {
      option.addEventListener('click', function () {
        serviceOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
        this.classList.add('border-blue-500', 'bg-blue-50');
        selectedService   = this.getAttribute('data-service')     || '';
        selectedServiceId = this.getAttribute('data-service-id') || '';
        selectedPrice     = this.getAttribute('data-price')       || '';
        enable(nextToStep2, true);
      });
    });
  }

  function renderBookingServices(items) {
    const container = document.getElementById('booking-services');
    if (!container) return;
    container.innerHTML = '';
    const active = Array.isArray(items) ? items.filter(it => it.isActive) : [];
    if (!active.length) {
      container.innerHTML = '<div class="text-center text-gray-500">ÙØ¹Ù„Ø§Ù‹ Ø³Ø±ÙˆÛŒØ³ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
      return;
    }
    active.forEach(it => {
      const off  = Number(it.discountPercent ?? it.offPercent ?? it.discount ?? 0) || 0;
      const base = Number(it.finalPrice ?? it.price ?? 0);
      const finalPrice = off ? Math.max(0, Math.round((it.price || 0) * (100 - off) / 100)) : base;
      container.insertAdjacentHTML('beforeend',
        `<div class="service-option border border-gray-300 rounded-lg p-3 hover:border-blue-500 cursor-pointer bw-tap" data-service-id="${it._id}" data-service="${it.title || ''}" data-price="${finalPrice}">
          <div class="flex justify-between items-center">
            <div>
              <h5 class="font-bold">${it.title || ''}</h5>
              <p class="text-sm text-gray-600">${it.desc || ''}</p>
            </div>
            <span class="font-bold">${priceFa(finalPrice)} ØªÙˆÙ…Ø§Ù†</span>
          </div>
        </div>`);
    });
    bindServiceOptions();
  }

  document.addEventListener('services:loaded', e => {
    renderBookingServices(e.detail || []);
  });

  // ---- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
  function scrollToWizard() {
    if (!bookingWizard) return;
    const top = bookingWizard.getBoundingClientRect().top + window.scrollY - 80;
    prefersReduced ? window.scrollTo(0, top) : window.scrollTo({ top, behavior: 'smooth' });
  }
  function openWizard() {
    bookingWizard?.classList.remove('hidden');
    scrollToWizard();
  }
  function enable(el, on = true) {
    if (!el) return;
    el.disabled = !on;
  }

  // ---- Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙˆÛŒØ²Ø§Ø±Ø¯ Ø§Ø² CTA Ø¨Ø§Ù„Ø§
  heroCta?.addEventListener('click', function (e) {
    e.preventDefault?.();
    openWizard();
  });

  // ---- Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙˆÛŒØ²Ø§Ø±Ø¯ Ø§Ø² Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø®Ø¯Ù…Ø§Øª + Ù¾Ø±â€ŒÚ©Ø±Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø±Ø­Ù„Ù‡ Û±
  // (Ø§ØµÙ„Ø§Ø­ Ú©Ù„Ø§Ø³ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø§Ø² .service-select Ø¨Ù‡ .service-button)
  document.querySelectorAll('.service-button').forEach((button) => {
    button.addEventListener('click', function () {
      const svc   = this.getAttribute('data-service');
      openWizard();
      // Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ù…Ø§Ù† Ú¯Ø²ÛŒÙ†Ù‡ Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Û± Ø¨Ø§ ØªØ±ÛŒÚ¯Ø± Ú©Ø±Ø¯Ù† Ú©Ù„ÛŒÚ© Ø®ÙˆØ¯Ø´
      setTimeout(() => {
        const opt = document.querySelector(`.service-option[data-service="${svc}"]`);
        opt?.click();
      }, 0);
    });
  });

  // ---- Ù…Ø±Ø­Ù„Ù‡ Û±: Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÙˆÛŒØ³
  // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ú©Ù„ÛŒÚ© Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø®Ø¯Ù…Ø§Øª ØªÙˆØ³Ø· bindServiceOptions Ù…ØªØµÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯

  nextToStep2?.addEventListener('click', function () {
    step1.classList.add('hidden');
    step2.classList.remove('hidden');
    currentStep.textContent = '2';
      step2Indicator?.classList.remove('bg-gray-300');
      step2Indicator?.classList.add('bg-blue-600');
    progressBar.style.width = '50%';
    // Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù‡ Ø¨Ø¹Ø¯ Ù‡Ù†ÙˆØ² Ú†ÛŒØ²ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ØŒ Ø¯Ú©Ù…Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯
    enable(nextToStep3, false);
  });

  // ---- Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª
  dateOptions.forEach(option => {
    option.addEventListener('click', function () {
      // Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø¨Ù„ÛŒ
      dateOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
      // Ø§Ù†ØªØ®Ø§Ø¨ ÙØ¹Ù„ÛŒ
      this.classList.add('border-blue-500', 'bg-blue-50');
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† Ø§Ø² Ø¯Ùˆ div Ø¯Ø§Ø®Ù„ÛŒ (Ø§ØµÙ„Ø§Ø­ selector Ø§Ø´ØªØ¨Ø§Ù‡ '.div:nth-child()')
      const first  = this.firstElementChild?.textContent?.trim() || '';
      const second = this.lastElementChild?.textContent?.trim()  || '';
      // Ù…Ø·Ø§Ø¨Ù‚ Ù…Ù†Ø·Ù‚ Ù‚Ø¨Ù„ÛŒ: ÙØ±Ù…Øª Â«Ø¯ÙˆÙ…ÛŒ + Ø§ÙˆÙ„ÛŒÂ»
      selectedDate = (second + ' ' + first).trim();
      // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø¹Ø¯ÛŒ Ø§Ú¯Ø± Ø³Ø§Ø¹Øª Ù‡Ù… Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
      if (selectedTime) enable(nextToStep3, true);
    });
  });

  timeOptions.forEach(option => {
    option.addEventListener('click', function () {
      // Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø¨Ù„ÛŒ
      timeOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
      // Ø§Ù†ØªØ®Ø§Ø¨ ÙØ¹Ù„ÛŒ
      this.classList.add('border-blue-500', 'bg-blue-50');
      // Ø°Ø®ÛŒØ±Ù‡
      selectedTime = (this.textContent || '').trim();
      // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø¹Ø¯ÛŒ Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ù‡Ù… Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
      if (selectedDate) enable(nextToStep3, true);
    });
  });

  backToStep1?.addEventListener('click', function () {
    step2.classList.add('hidden');
    step1.classList.remove('hidden');
    currentStep.textContent = '1';
      step2Indicator?.classList.remove('bg-blue-600');
      step2Indicator?.classList.add('bg-gray-300');
    progressBar.style.width = '25%';
  });

  nextToStep3?.addEventListener('click', function () {
    step2.classList.add('hidden');
    step3.classList.remove('hidden');
    currentStep.textContent = '3';
      step3Indicator?.classList.remove('bg-gray-300');
      step3Indicator?.classList.add('bg-blue-600');
    progressBar.style.width = '75%';
    // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ØºÛŒØ±ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ø¯Ú©Ù…Ù‡ Ù…Ø±Ø­Ù„Ù‡ Û´ ØªØ§ ØªÚ©Ù…ÛŒÙ„ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
    validateStep3();
  });

  // ---- Ù…Ø±Ø­Ù„Ù‡ Û³: Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³
  function validateStep3() {
    const okPhone = (phoneNumber.value || '').trim().length >= 10;
    const okName  = (customerName.value || '').trim() !== '';
    enable(nextToStep4, okPhone && okName);
  }
  phoneNumber?.addEventListener('input', validateStep3);
  customerName?.addEventListener('input', validateStep3);

  backToStep2?.addEventListener('click', function () {
    step3.classList.add('hidden');
    step2.classList.remove('hidden');
    currentStep.textContent = '2';
      step3Indicator?.classList.remove('bg-blue-600');
      step3Indicator?.classList.add('bg-gray-300');
    progressBar.style.width = '50%';
  });

  nextToStep4?.addEventListener('click', function () {
    // ØªÚ©Ù…ÛŒÙ„ Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ§ÛŒÛŒØ¯
    confirmService.textContent = selectedService;
    confirmDate.textContent    = selectedDate;
    confirmTime.textContent    = selectedTime;
    confirmName.textContent    = customerName.value;
    confirmPhone.textContent   = '+98' + phoneNumber.value; // Ù¾ÛŒØ´â€ŒØ´Ù…Ø§Ø±Ù‡ Ù„Ø§ØªÛŒÙ† Ù…Ø´Ø§Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„
    confirmPrice.textContent   = (parseInt(selectedPrice, 10) || 0).toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†';

    // Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Û´
    step3.classList.add('hidden');
    step4.classList.remove('hidden');
    currentStep.textContent = '4';
      step4Indicator?.classList.remove('bg-gray-300');
      step4Indicator?.classList.add('bg-blue-600');
    progressBar.style.width = '100%';
  });

  // ---- Ù…Ø±Ø­Ù„Ù‡ Û´: ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ
  backToStep3?.addEventListener('click', function () {
    step4.classList.add('hidden');
    step3.classList.remove('hidden');
    currentStep.textContent = '3';
      step4Indicator?.classList.remove('bg-blue-600');
      step4Indicator?.classList.add('bg-gray-300');
    progressBar.style.width = '75%';
  });

confirmBooking?.addEventListener('click', async function () {
  // Store original button state
  const originalText = this.textContent;
  const wasDisabled = this.disabled;
  
  // Set loading state
  this.disabled = true;
  this.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÛŒØ¯...';
  
  try {
    // Submit the booking
    const res = await fetch(`${API_ROOT}/api/bookings`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        serviceId: selectedServiceId,
        service: selectedService,
        sellerId: window.LAST_PUBLIC?.sellerId,
        customerName: customerName.value,
        customerPhone: phoneNumber.value,
        date: selectedDate,
        time: selectedTime
      })
    });
    
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.message || `HTTP ${res.status}`);
    }
    
    // Success - show success screen
    step4.classList.add('hidden');
    bookingSuccess.classList.remove('hidden');
    
    // Save booking data
    window.__BOOKING_GUARD__?.saveLast({
      phone: phoneNumber.value,
      service: selectedService,
      date: selectedDate,
      time: selectedTime,
      status: 'pending',
      createdAt: new Date().toISOString()
    });

    // Save for gamification
    const bookings = JSON.parse(localStorage.getItem('vitreenet-bookings') || '[]');
    bookings.push({
      id: Date.now().toString(36),
      service: selectedService,
      price: selectedPrice,
      date: selectedDate,
      time: selectedTime,
      name: customerName.value,
      phone: phoneNumber.value,
      timestamp: new Date().toISOString(),
      status: 'pending'
    });
    localStorage.setItem('vitreenet-bookings', JSON.stringify(bookings));
    
  } catch (err) {
    console.error('submit booking failed', err);
    
    // Restore button on error
    this.disabled = wasDisabled;
    this.innerHTML = originalText;
    
    // Show error to user
    if (typeof showToastDark === 'function') {
      showToastDark(err.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†ÙˆØ¨Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', {type: 'error'});
    } else {
      alert(err.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†ÙˆØ¨Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
    }
    
    return; // Don't hide the form on error
  }
  
  // Note: Don't restore button on success as we're moving to success screen
});

  closeBooking?.addEventListener('click', function () {
    // Ø¨Ø³ØªÙ† Ùˆ Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ ÙˆÛŒØ²Ø§Ø±Ø¯
    bookingWizard.classList.add('hidden');
    resetBookingWizard();
  });

  // ---- Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ ÙˆÛŒØ²Ø§Ø±Ø¯
  function resetBookingWizard() {
    // Ù…Ø±Ø§Ø­Ù„
    step1.classList.remove('hidden');
    step2.classList.add('hidden');
    step3.classList.add('hidden');
    step4.classList.add('hidden');
    bookingSuccess.classList.add('hidden');

    // Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§
    currentStep.textContent = '1';
      step2Indicator?.classList.remove('bg-blue-600');
      step2Indicator?.classList.add('bg-gray-300');
      step3Indicator?.classList.remove('bg-blue-600');
      step3Indicator?.classList.add('bg-gray-300');
      step4Indicator?.classList.remove('bg-blue-600');
      step4Indicator?.classList.add('bg-gray-300');
    progressBar.style.width = '25%';

    // Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§
    serviceOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
    dateOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
    timeOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));

    // ÙÛŒÙ„Ø¯Ù‡Ø§
    phoneNumber.value = '';
    customerName.value = '';

    // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
    enable(nextToStep2, false);
    enable(nextToStep3, false);
    enable(nextToStep4, false);

    // ÙˆØ¶Ø¹ÛŒØª
    selectedService   = '';
    selectedServiceId = '';
    selectedPrice     = '';
    selectedDate      = '';
    selectedTime      = '';
  }
});

    </script>






<!-- Mobile Bottom Footer / Nav (5 items, same style) -->
<footer id="mobile-bottom-nav" class="mobile-nav lg:hidden safe-area-bottom" role="navigation" aria-label="Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„">
  <style>
    .safe-area-bottom {
      padding-bottom: env(safe-area-inset-bottom, 0);
    }
    
    @supports (padding: max(0px)) {
      .mobile-nav {
        padding-bottom: max(8px, env(safe-area-inset-bottom));
        height: calc(72px + env(safe-area-inset-bottom));
      }
    }
  </style>  <!-- Ø®Ø§Ù†Ù‡ -->
  <button type="button" class="nav-item" data-nav="home" aria-label="Ø®Ø§Ù†Ù‡" aria-current="page">
    <i class="fa-solid fa-house nav-icon"></i>
    <span class="nav-label">Ø®Ø§Ù†Ù‡</span>
  </button>

  <!-- Ø®Ø¯Ù…Ø§Øª -->
  <button type="button" class="nav-item" data-nav="services" aria-label="Ø®Ø¯Ù…Ø§Øª">
    <i class="fa-solid fa-scissors nav-icon"></i>
    <span class="nav-label">Ø®Ø¯Ù…Ø§Øª</span>
  </button>

  <!-- Ø±Ø²Ø±Ùˆ (CTA ÙˆØ³Ø·ØŒ Ø¨Ø±Ø¬Ø³ØªÙ‡) -->
  <button type="button" class="nav-item active -mt-6 !text-white" data-nav="booking" aria-label="Ø±Ø²Ø±Ùˆ" style="padding:0">
    <span class="inline-flex items-center justify-center w-14 h-14 rounded-2xl shadow-lg ring-4 ring-white/60 bg-gradient-to-tr from-blue-600 to-teal-500">
      <i class="fa-solid fa-calendar-check text-lg"></i>
    </span>
    <span class="nav-label mt-1">Ø±Ø²Ø±Ùˆ</span>
  </button>

  <!-- Ù†Ù…ÙˆÙ†Ù‡â€ŒÚ©Ø§Ø± -->
  <button type="button" class="nav-item" data-nav="portfolio" aria-label="Ù†Ù…ÙˆÙ†Ù‡â€ŒÚ©Ø§Ø±">
    <i class="fa-solid fa-images nav-icon"></i>
    <span class="nav-label">Ù†Ù…ÙˆÙ†Ù‡â€ŒÚ©Ø§Ø±</span>
  </button>

  <!-- Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
  <button type="button" class="nav-item" data-nav="profile" aria-label="Ù¾Ø±ÙˆÙØ§ÛŒÙ„">
    <i class="fa-solid fa-user nav-icon"></i>
    <span class="nav-label">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</span>
  </button>
</footer>

<script>
(() => {
  const nav = document.getElementById('mobile-bottom-nav');
  if (!nav) return;

  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const items = nav.querySelectorAll('.nav-item');

  const setActive = (key) => {
    items.forEach(btn => {
      const isActive = btn.dataset.nav === key;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-current', isActive ? 'page' : 'false');
    });
  };

  const smoothGo = (target) => {
    if (!target) return;
    if (prefersReduced) target.scrollIntoView();
    else target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  const byId = (id) => document.getElementById(id);
  const bySel = (sel) => document.querySelector(sel);

  const findByHeading = (keyword) => {
    const hs = [...document.querySelectorAll('h1,h2,h3,h4')];
    const hit = hs.find(h => (h.textContent || '').includes(keyword));
    return hit ? (hit.closest('section') || hit) : null;
  };

  // Targets (with robust fallbacks)
  const targets = {
    home: () => document.documentElement,
    services: () => byId('services') || findByHeading('Ø®Ø¯Ù…Ø§Øª'),
    booking: () => byId('booking-wizard'),
    portfolio: () => byId('portfolio') || bySel('.portfolio-section') || findByHeading('Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±'),
    profile: () => byId('profile') || findByHeading('Ù¾Ø±ÙˆÙØ§ÛŒÙ„'),
  };

  // Click handlers
  items.forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.dataset.nav;

      if (key === 'home') {
        // Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ ÙˆÛŒØªØ±ÛŒÙ†Øª
        window.location.href = 'local***index.html';
        return;
      }

      if (key === 'booking') {
        const wizard = byId('booking-wizard');
        const heroCta = byId('hero-cta');
        if (wizard && wizard.classList.contains('hidden')) {
          if (heroCta) heroCta.click();
          else wizard.classList.remove('hidden');
        }
        const t = targets.booking();
        if (t) {
          const top = t.getBoundingClientRect().top + window.scrollY - 80;
          if (prefersReduced) window.scrollTo(0, top);
          else window.scrollTo({ top, behavior: 'smooth' });
          setActive('booking');
        }
        return;
      }

      if (key === 'profile') {
        // Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±
        window.location.href = 'service-seller-panel/s-profile.html';
        return;
      }

      const t = targets[key] && targets[key]();
      if (t) smoothGo(t);
      setActive(key);
    });
  });

  // Scroll spy (if supported)
  const spySections = [
    { key: 'services', el: targets.services() },
    { key: 'portfolio', el: targets.portfolio() },
    { key: 'profile',  el: targets.profile() },
  ].filter(s => s.el);

  if ('IntersectionObserver' in window && spySections.length) {
    const io = new IntersectionObserver((entries) => {
      const vis = entries.filter(e => e.isIntersecting)
                         .sort((a,b) => b.intersectionRatio - a.intersectionRatio)[0];
      if (!vis) return;
      const hit = spySections.find(s => s.el === vis.target);
      if (hit) setActive(hit.key);
    }, { threshold: [0.35, 0.6], rootMargin: '-20% 0px -50% 0px' });
    spySections.forEach(s => io.observe(s.el));

    // Top of page = Ø®Ø§Ù†Ù‡
    window.addEventListener('scroll', () => {
      if (window.scrollY < 80) setActive('home');
    }, { passive: true });
  }

  // Initial state
  setActive('home');
})();
</script>



<script>
  (function () {
    var badge = document.getElementById('vip-badge');
    var out   = document.getElementById('vip-count');
    if (!badge || !out) return;
    var n = Number(badge.getAttribute('data-count') || 0);
    out.textContent = new Intl.NumberFormat('fa-IR').format(n) + ' Ù†ÙØ±';
  })();
</script>






<script>
/* Ù¾Ø§Ù¾â€ŒØ§Ù¾ Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ ÙˆØ³Ø· ØµÙØ­Ù‡ + ØªØ±Ø¬Ù…Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Drop-in Replacement) */
(() => {
  const translate = (txt) => {
    if (!txt) return "";
    if (/You can submit one review per day/i.test(txt)) {
      return "Ø±ÙˆØ²Ø§Ù†Ù‡ ÙÙ‚Ø· ÛŒÚ© Ù†Ø¸Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.";
    }
    return txt;
  };

  // Ù‡Ù…Ø§Ù† Ø§Ù…Ø¶Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ: showToastDark(message, {type, durationMs})
  window.showToastDark = function (message, { type = "info", durationMs = 2600 } = {}) {
    const palette = {
      success: { ring: "ring-emerald-200", icon: "text-emerald-600", ico: "fas fa-check" },
      info:    { ring: "ring-blue-200",    icon: "text-blue-600",    ico: "fas fa-info-circle" },
      error:   { ring: "ring-rose-200",    icon: "text-rose-600",    ico: "fas fa-exclamation-circle" }
    };
    const p = palette[type] || palette.info;

    // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø§Ø²Ù‡ØŒ Ø­Ø°Ù Ú©Ù†
    const existing = document.getElementById("dark-toast");
    if (existing) existing.remove();

    // Ù„Ø§ÛŒÙ‡â€ŒÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ (Ø¨Ø±Ø§ÛŒ Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ†)
    const overlay = document.createElement("div");
    overlay.id = "dark-toast";
    overlay.setAttribute("role", "dialog");
    overlay.setAttribute("aria-modal", "true");
    overlay.dir = "rtl";
    overlay.className =
      "fixed inset-0 z-[160] flex items-center justify-center p-4 " +
      "bg-black/30 backdrop-blur-sm opacity-0 transition-opacity duration-200";

    // Ú©Ø§Ø±Øª ÙˆØ³Ø· ØµÙØ­Ù‡
    const card = document.createElement("div");
    card.className =
      `relative w-full max-w-sm sm:max-w-md rounded-2xl bg-white/95 backdrop-blur-md ` +
      `shadow-2xl ring-1 ${p.ring} transform scale-95 opacity-0 transition-all duration-200`;

    // Ù…Ø­ØªÙˆØ§ÛŒ Ú©Ø§Ø±Øª
    const inner = document.createElement("div");
    inner.className = "px-5 py-4 flex items-start gap-3 text-slate-900";

    const icon = document.createElement("i");
    icon.className = `${p.ico} ${p.icon} text-xl mt-0.5`;

    const msg = document.createElement("div");
    msg.className = "text-[14px] leading-7 font-bold";
    msg.textContent = translate(message);

    const closeBtn = document.createElement("button");
    closeBtn.type = "button";
    closeBtn.setAttribute("aria-label", "Ø¨Ø³ØªÙ†");
    closeBtn.className =
      "absolute top-2 left-2 w-9 h-9 rounded-full text-slate-500 " +
      "hover:text-slate-700 hover:bg-slate-100 flex items-center justify-center";
    closeBtn.innerHTML = "&times;";

    inner.append(icon, msg);
    card.append(closeBtn, inner);
    overlay.append(card);
    document.body.appendChild(overlay);

    // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù†Ù…Ø§ÛŒØ´
    requestAnimationFrame(() => {
      overlay.classList.remove("opacity-0");
      card.classList.remove("scale-95", "opacity-0");
    });

    // Ø¨Ø³ØªÙ† Ø¨Ø§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
    const remove = () => {
      overlay.classList.add("opacity-0");
      card.classList.add("scale-95", "opacity-0");
      setTimeout(() => overlay.remove(), 200);
      document.removeEventListener("keydown", onKey);
    };
    const onKey = (e) => { if (e.key === "Escape") remove(); };

    document.addEventListener("keydown", onKey);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) remove(); });
    closeBtn.addEventListener("click", (e) => { e.stopPropagation(); remove(); });

    // Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± + ØªÙˆÙ‚Ù Ø¨Ø§ Hover
    let timer = setTimeout(remove, durationMs);
    overlay.addEventListener("mouseenter", () => clearTimeout(timer));
    overlay.addEventListener("mouseleave", () => {
      timer = setTimeout(remove, 1200);
    });
  };

  // ÙØ§Ø±Ø³ÛŒâ€ŒØ³Ø§Ø²ÛŒ Tooltip Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø± Ø¯Ø± Ø­Ø§Ù„Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("submit-review");
    if (!btn) return;
    const apply = () => {
      if (/You can submit one review per day/i.test(btn.title || "")) {
        btn.title = "Ø±ÙˆØ²Ø§Ù†Ù‡ ÙÙ‚Ø· ÛŒÚ© Ù†Ø¸Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.";
      }
    };
    apply();
    new MutationObserver(apply).observe(btn, { attributes: true, attributeFilter: ["title"] });
  });
})();
</script>






<script>
/* ===== Portfolio Likes (server-based) ===== */
(function(){
  'use strict';
  const API_BASE = (window.API_BASE || '').replace(/\/+$/, '');
  const isLoggedIn = () => { try { return !!JSON.parse(localStorage.getItem('auth_user')||'null'); } catch(_) { return false; } };
  const toFa = n => String(n ?? 0).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);

  const likeCache = new Map(); // id -> {liked, count}

  function updateUI(id){
    const state = likeCache.get(id) || { liked:false, count:0 };
    document.querySelectorAll(`.portfolio-card[data-item-id="${id}"]`).forEach(card=>{
      const wrap = card.querySelector('.fa-heart')?.parentElement;
      const icon = wrap?.querySelector('.fa-heart');
      const cnt  = wrap?.querySelector('span');
      if(!wrap||!icon||!cnt) return;
      icon.classList.toggle('far', !state.liked);
      icon.classList.toggle('fas', state.liked);
      wrap.classList.toggle('text-red-500', state.liked);
      cnt.textContent = toFa(state.count);
      wrap.setAttribute('role','button');
      wrap.setAttribute('tabindex','0');
      wrap.setAttribute('aria-pressed', state.liked ? 'true' : 'false');
      wrap.title = state.liked ? 'Ù„ØºÙˆ Ù„Ø§ÛŒÚ©' : 'Ù¾Ø³Ù†Ø¯ÛŒØ¯Ù†';
    });

    if(window.__PF_ACTIVE_ID===id){
      const mWrap  = document.querySelector('#imageModal .fa-heart')?.parentElement;
      const mIcon  = mWrap?.querySelector('.fa-heart');
      const mLikes = document.getElementById('modalLikes');
      if(mWrap && mIcon && mLikes){
        mIcon.classList.toggle('far', !state.liked);
        mIcon.classList.toggle('fas', state.liked);
        mWrap.classList.toggle('text-red-500', state.liked);
        mLikes.textContent = toFa(state.count);
        mWrap.setAttribute('aria-pressed', state.liked ? 'true' : 'false');
        mWrap.title = state.liked ? 'Ù„ØºÙˆ Ù„Ø§ÛŒÚ©' : 'Ù¾Ø³Ù†Ø¯ÛŒØ¯Ù†';
      }
    }
  }

  async function toggle(id){
    if(!isLoggedIn()){
      if(typeof window.showToastDark === 'function') showToastDark('Ø¨Ø±Ø§ÛŒ Ù„Ø§ÛŒÚ© Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', {type:'info'});
      return;
    }
    const prev = likeCache.get(id) || { liked:false, count:0 };
    const optimistic = { liked: !prev.liked, count: prev.count + (prev.liked ? -1 : 1) };
    likeCache.set(id, optimistic);
    updateUI(id);
    try{
      const res = await fetch(`${API_BASE}/api/portfolio/${id}/like`, {
        method:'POST',
        credentials:'include'
      });
      const data = await res.json();
      if(res.ok){
        likeCache.set(id, { liked: data.liked, count: data.likeCount });
      } else {
        likeCache.set(id, prev);
      }
    }catch(_){ likeCache.set(id, prev); }
    updateUI(id);
  }

  function bind(card){
    const id = card.dataset.itemId;
    if(!id || card.dataset.likeBound) return;
    card.dataset.likeBound = '1';
    const wrap = card.querySelector('.fa-heart')?.parentElement;
    if(!wrap) return;
    wrap.addEventListener('click', e=>{ e.preventDefault(); toggle(id); });
    wrap.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(id); }});
  }

  function init(ev){
    const items = ev?.detail?.items || [];
    items.forEach(it => likeCache.set(it.id, { liked: !!it.liked, count: it.likes }));
    document.querySelectorAll('.portfolio-card').forEach(card=>{
      bind(card);
      const id = card.dataset.itemId;
      if(id && likeCache.has(id)) updateUI(id);
    });
    const mWrap = document.querySelector('#imageModal .fa-heart')?.parentElement;
    if(mWrap && !mWrap.dataset.likeBound){
      mWrap.dataset.likeBound = '1';
      mWrap.style.cursor = 'pointer';
      mWrap.addEventListener('click', e=>{ e.preventDefault(); if(window.__PF_ACTIVE_ID) toggle(window.__PF_ACTIVE_ID); });
      mWrap.addEventListener('keydown', e=>{ if((e.key==='Enter'||e.key===' ') && window.__PF_ACTIVE_ID){ e.preventDefault(); toggle(window.__PF_ACTIVE_ID); }});
    }
  }

  window.__PF_SET_ACTIVE_ID = function(id){
    window.__PF_ACTIVE_ID = id;
    if(id) updateUI(id);
  };
  window.__getPortfolioLikes = id => (likeCache.get(id)?.count ?? 0);

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
  document.addEventListener('portfolio:rendered', init);
})();
</script>


<script>
// Lazy load background images with better error handling
document.addEventListener('DOMContentLoaded', () => {
  const lazyBackgrounds = document.querySelectorAll('.lazy-bg');
  
  if ('IntersectionObserver' in window) {
    const bgObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const bg = entry.target;
          const bgUrl = bg.dataset.bg;
          
          // Preload image first
          const img = new Image();
          img.onload = () => {
            bg.style.backgroundImage = `url(${bgUrl})`;
            bg.classList.remove('lazy-bg');
            bg.classList.add('loaded');
          };
          img.onerror = () => {
            console.error('Failed to load background image:', bgUrl);
            bg.classList.add('load-error');
          };
          img.src = bgUrl;
          
          bgObserver.unobserve(bg);
        }
      });
    }, {
      rootMargin: '50px 0px',
      threshold: 0.01
    });
    
    lazyBackgrounds.forEach(bg => bgObserver.observe(bg));
  } else {
    // Fallback for older browsers
    lazyBackgrounds.forEach(bg => {
      bg.style.backgroundImage = `url(${bg.dataset.bg})`;
    });
  }
});
</script>

<script>
// Performance monitoring
window.addEventListener('load', () => {
  if ('performance' in window && 'measureUserAgentSpecificMemory' in performance) {
    const perfData = performance.getEntriesByType('navigation')[0];
    
    // Log performance metrics
    console.log('Performance Metrics:', {
      domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
      loadComplete: perfData.loadEventEnd - perfData.loadEventStart,
      domInteractive: perfData.domInteractive,
      firstPaint: performance.getEntriesByName('first-paint')[0]?.startTime
    });
    
    // Warn if page load is slow
    if (perfData.loadEventEnd - perfData.fetchStart > 3000) {
      console.warn('Page load time exceeds 3 seconds. Consider optimizing resources.');
    }
  }
});
</script>


<!-- ==== VENDOR SERVICES (bind to your backend) â€“ START ==== -->
<script>
(() => {
  'use strict';

  /** ================== Config & Helpers ================== **/
  const API_ROOT = window.__API_BASE__ || '';
  const TOKEN_KEYS = ['access_token', 'token', 'jwt'];
  const clearToken = () => TOKEN_KEYS.forEach(k => localStorage.removeItem(k));
  // Ø§Ú¯Ø± ØªÙˆÚ©Ù† Ø±Ùˆ Ø¬Ø§ÛŒ Ø¯ÛŒÚ¯Ù‡ Ù…ÛŒâ€ŒØ°Ø§Ø±ÛŒØŒ Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ùˆ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡
  function getToken() {
    let t = null;
    for (const k of TOKEN_KEYS) {
      const val = localStorage.getItem(k);
      if (val) { t = val; break; }
    }
    if (!t) return null;
    try {
      const payload = JSON.parse(atob(t.split('.')[1] || ''));
      if (payload.exp * 1000 < Date.now()) {
        clearToken();
        return null;
      }
    } catch (_) {
      clearToken();
      return null;
    }
    return t;
  }
  const authHeaders = () => {
    const t = getToken();
    return t ? { 'Authorization': 'Bearer ' + t } : {};
  };
  const toFa = s => String(s).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);
  const priceFa = n => (Number(n)||0).toLocaleString('fa-IR');
  const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));

  function toast(msg, type='info') {
    if (typeof showToastDark === 'function') showToastDark(msg, {type});
    else alert(msg);
  }

  // Ø¯Ø±ÛŒØ§ÙØª shopurl Ø§Ø² Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§Ø› Ø¯Ø± ØµÙˆØ±Øª Ù†Ø¨ÙˆØ¯Ù†ØŒ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ sellerId Ø¨Ù‡ shopurl
  async function getShopUrlFromLocation() {
    const u = new URL(location.href);
    const q = u.searchParams.get('shopurl');
    if (q) return q.trim();

    const sid = u.searchParams.get('sellerId');
    if (!sid) return '';

    try {
      const res = await fetch(`${API_ROOT}/api/shopAppearance/${encodeURIComponent(sid)}`);
      if (!res.ok) throw new Error('appearance not found');
      const data = await res.json();
      return data.customUrl ? data.customUrl.trim() : '';
    } catch (err) {
      console.error('get shopurl by sellerId failed', err);
      return '';
    }
  }

  function show404() {
    document.body.innerHTML = '<h1 class="text-center mt-10 text-2xl">404 - ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯</h1>';
  }

  // Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ú©Ø§Ù†ØªÛŒÙ†Ø± Â«Ø®Ø¯Ù…Ø§Øª Ù…Ø§Â»
  function findServicesContainer() {
    const headings = Array.from(document.querySelectorAll('section h3'));
    const h = headings.find(el => (el.textContent || '').trim().includes('Ø®Ø¯Ù…Ø§Øª Ù…Ø§'));
    if (!h) return null;
    const sec = h.closest('section');
    if (!sec) return null;
    // Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§Ø³Ú©Ø±ÙˆÙ„ÛŒ Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø§Ø´ØªÛŒ
    const c = sec.querySelector('.scroll-container');
    return c || null;
  }

  // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙˆÛŒØ²Ø§Ø±Ø¯ Ø±Ø²Ø±Ùˆ
  function bindReserveClicks(container) {
    if (!container) return;
    container.addEventListener('click', (e) => {
      const btn = e.target.closest('.service-button');
      if (!btn) return;
      e.preventDefault();
      const prefill = { service: btn.dataset.service, price: btn.dataset.price };
      if (typeof window.openBookingWizard === 'function') {
        window.openBookingWizard(prefill);
      } else {
        toast('Ø¨Ø®Ø´ Ø±Ø²Ø±Ùˆ Ø¯Ø± Ø§ÛŒÙ† ØµÙØ­Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯', 'info');
      }
    });
  }

  /** ================== API calls ================== **/
  async function apiGetPublic(shopurl) {
    const res = await fetch(`${API_ROOT}/api/seller-services/by-shopurl/${encodeURIComponent(shopurl)}`, {
      credentials: 'include'
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json(); // { items, sellerId }
  }

  async function apiGetSeller(shopurl) {
    const res = await fetch(`${API_ROOT}/api/sellers/by-shopurl/${encodeURIComponent(shopurl)}`, { credentials: 'include' });
    if (!res.ok) throw new Error('seller not found');
    return res.json();
  }

function updateSellerProfile(seller) {
  // Helper function to create brief address
  const getBriefAddress = (fullAddress) => {
    if (!fullAddress) return 'Ø¢Ø¯Ø±Ø³ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±';
    // Split address by common delimiters
    const parts = fullAddress.split(/[ØŒ,-]/);
    if (parts.length >= 2) {
      // Return first two parts (usually street and area)
      return parts.slice(0, 2).join('ØŒ ').trim();
    } else if (fullAddress.length > 30) {
      // If address is too long, truncate it
      return fullAddress.substring(0, 30) + '...';
    }
    return fullAddress;
  };

  const mapping = {
    'page-title':   `${seller.storename || ''} | Vitreenet`,
    'seller-name':  seller.storename || '',
    'seller-category': seller.category || '',
    'seller-phone': seller.phone || '',
    'seller-address': seller.address || '',
    'store-phone':  seller.phone || '',
    'store-address': seller.address || '',
    'store-hours': seller.startTime && seller.endTime
      ? `Ø§Ø² ${toFa(seller.startTime)} ØªØ§ ${toFa(seller.endTime)}`
      : 'Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª',
    'biz-name':     seller.storename || '',
    'biz-tagline':  seller.desc || '',
    'full-address': seller.address || '',
    'modal-phone':  seller.phone || '',
    // Add header shop names
    'header-shop-name-mobile': seller.storename || '',
    'header-shop-name-md1': seller.storename || '',
    'header-shop-name-md2': seller.storename || '',
    'header-shop-name-lg': seller.storename || '',
    'footer-shop-name': seller.storename || '',
    // Add brief address for hero
    'hero-brief-address': getBriefAddress(seller.address)
  };
  
  for (const [id, text] of Object.entries(mapping)) {
    const el = document.getElementById(id);
    if (!el) continue;
    if (id === 'modal-phone') {
      el.textContent = text;
      el.href = text ? `tel:${text}` : '#';
    } else if (id === 'header-shop-name-mobile' || id === 'header-shop-name-lg') {
      // Also update the title attribute for these elements
      el.textContent = text;
      el.setAttribute('title', text);
    } else {
      el.textContent = text;
    }
  }

  // Handle footer image from seller data
  if (seller.footerImage || seller.brandingImage || seller.coverImage) {
    const imageUrl = seller.footerImage || seller.brandingImage || seller.coverImage;
    document.documentElement.style.setProperty('--footer-image', `url("${imageUrl}")`);

    // Apply to map container immediately if available
    const mapContainer = document.getElementById('map-container');
    if (mapContainer && imageUrl) {
      mapContainer.classList.add('footer-image-map');
      mapContainer.classList.remove('min-h-[200px]', 'bg-gray-200');
      mapContainer.innerHTML = `<img src="${imageUrl}" alt="ØªØµÙˆÛŒØ± Ø¨Ø±Ù†Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡">`;
    }
    
    const footerEl = document.getElementById('shop-footer-image');
    if (footerEl) footerEl.hidden = false;
  }

  const heroCall = document.getElementById('hero-call');
  if (heroCall) heroCall.href = seller.phone ? `tel:${seller.phone}` : '#';
}



// Fetch footer image from branding API
// Fetch footer image from branding API with better error handling
async function loadFooterImage(sellerId) {
  if (!sellerId) {
    console.log('No sellerId provided for footer image');
    return;
  }
  
  const mapContainer = document.getElementById('map-container');
  if (!mapContainer) {
    console.log('Map container not found');
    return;
  }
  
  try {
    console.log('Fetching footer image for seller:', sellerId);
    
    // Try the branding endpoint first
    const res = await fetch(`${API_ROOT}/api/branding/footer/${encodeURIComponent(sellerId)}`, {
      credentials: 'include'
    });
    
    let imageUrl = null;
    
    if (res.ok) {
      const data = await res.json();
      imageUrl = data.url || data.imageUrl || data.image;
      console.log('Footer image from branding API:', imageUrl);
    }
    
    // If no image from branding API, try to get it from seller data
    if (!imageUrl) {
      console.log('No image from branding API, trying seller data...');
      // Check if we already have footerImage from seller data
      const footerImageVar = getComputedStyle(document.documentElement).getPropertyValue('--footer-image');
      if (footerImageVar && footerImageVar !== 'none') {
        // Extract URL from CSS variable
        const match = footerImageVar.match(/url\(["']?(.+?)["']?\)/);
        if (match && match[1]) {
          imageUrl = match[1];
          console.log('Using footer image from seller data:', imageUrl);
        }
      }
    }
    
    // Apply the image if we have one
    if (imageUrl) {
      // Update CSS variable
      document.documentElement.style.setProperty('--footer-image', `url("${imageUrl}")`);

      // Update map container with the footer image
      mapContainer.classList.add('footer-image-map');
      mapContainer.classList.remove('min-h-[200px]', 'bg-gray-200');
      mapContainer.innerHTML = `<img src="${imageUrl}" alt="ØªØµÙˆÛŒØ± Ø¨Ø±Ù†Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡">`;

      // Show footer image element if exists
      const footerEl = document.getElementById('shop-footer-image');
      if (footerEl) footerEl.hidden = false;
      
      console.log('Footer image applied successfully');
    } else {
      console.log('No footer image available');
      // Show a nice placeholder
      mapContainer.innerHTML = `
        <div class="text-center">
          <i class="fas fa-store text-4xl text-gray-400 mb-2"></i>
          <p class="text-sm text-gray-500">ØªØµÙˆÛŒØ± Ø¨Ø±Ù†Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</p>
        </div>
      `;
    }
  } catch (err) {
    console.error('Failed to load footer image:', err);
    // Show error state
    mapContainer.innerHTML = `
      <div class="text-center">
        <i class="fas fa-image text-3xl text-gray-400 mb-2"></i>
        <p class="text-sm text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ±...</p>
      </div>
    `;
  }
}


// Debug function to check what's happening
window.debugFooterImage = function() {
  const mapContainer = document.getElementById('map-container');
  const footerImageVar = getComputedStyle(document.documentElement).getPropertyValue('--footer-image');
  const sellerId = document.body.dataset.sellerId;
  
  console.log('Debug Info:');
  console.log('- Map container exists:', !!mapContainer);
  console.log('- Map container classes:', mapContainer?.className);
  console.log('- Map container style:', mapContainer?.style.backgroundImage);
  console.log('- CSS variable --footer-image:', footerImageVar);
  console.log('- Seller ID:', sellerId);
  console.log('- API_ROOT:', window.__API_BASE__ || '');
}


  /** ================== Render ================== **/
function cardTemplate(item) {
  const img = Array.isArray(item.images) && item.images.length
    ? item.images[Math.max(0, Math.min(item.mainImageIndex || 0, item.images.length - 1))]
    : `https://picsum.photos/seed/${encodeURIComponent(item.title || 'svc')}/800/600.jpg`;

  // Ù‚ÛŒÙ…Øª/ØªØ®ÙÛŒÙ
  const offPct     = Number(item.discountPercent ?? item.offPercent ?? item.discount ?? 0) || 0;
  const hasOff     = offPct > 0 && Number(item.price) > 0;
  const basePrice  = Number(item.finalPrice ?? item.price ?? 0);
  const finalPrice = hasOff ? Math.max(0, Math.round((item.price || 0) * (100 - offPct) / 100)) : basePrice;

  // Ø§Ù…ØªÛŒØ§Ø²
  const rating      = Number(item.ratingAvg ?? item.rating ?? 0) || null;
  const ratingCount = Number(item.reviewCount ?? item.ratingCount ?? 0) || 0;

  // Ú©Ù¾Ø´Ù† Ø¨Ø¯ÙˆÙ† ØªÚ©Ø±Ø§Ø±
  const title   = (item.title || '').trim();
  const descRaw = (item.desc  || '').trim();
  const norm    = s => s.toString().trim().replace(/\s+/g, ' ').toLowerCase();
  const showDesc = !!descRaw && norm(descRaw) !== norm(title) && descRaw.length >= 12;

  return `
  <article
    class="service-card group relative flex-shrink-0 w-[90vw] xs:w-[86vw] sm:w-72 md:w-80 bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 snap-start"
    data-svc-id="${item._id}"
  >
    <!-- ØªØµÙˆÛŒØ± + Ø§ÙˆØ±Ù„ÛŒ ØªØ®ÙÛŒÙ -->
    <div class="relative overflow-hidden">
      <img src="${img}" alt="${title}" loading="lazy" decoding="async"
           class="w-full aspect-[4/3] object-cover transition-transform duration-500 group-hover:scale-105" />
      <div class="absolute inset-0 bg-gradient-to-t from-black/55 via-black/10 to-transparent pointer-events-none"></div>

      <div class="absolute top-2 left-2 flex gap-2">
        ${hasOff ? `<span class="rounded-full bg-rose-600/95 text-white text-[11px] px-2 py-1">${toFa(offPct)}Ùª ØªØ®ÙÛŒÙ</span>` : ``}
        ${item.badge ? `<span class="rounded-full bg-emerald-600/95 text-white text-[11px] px-2 py-1">${item.badge}</span>` : ``}
      </div>
      <!-- â›”ï¸ Ø¹Ù†ÙˆØ§Ù† Ø±ÙˆÛŒ ØªØµÙˆÛŒØ± Ø­Ø°Ù Ø´Ø¯ ØªØ§ ØªÚ©Ø±Ø§Ø± Ù†Ø´Ù‡ -->
    </div>

    <!-- Ú©Ù¾Ø´Ù† -->
    <div class="p-4 flex flex-col gap-3">
      <!-- Ø±Ø¯ÛŒÙ Ø¹Ù†ÙˆØ§Ù† + Ø§Ù…ØªÛŒØ§Ø² -->
      <div class="flex items-center justify-between gap-3">
        <h4 class="font-extrabold text-[16px] sm:text-[17px] md:text-lg text-gray-900 line-clamp-1">${title || 'â€”'}</h4>
        <div class="flex items-center gap-1 text-[12px] ${rating ? '' : 'hidden'}" aria-label="Ø§Ù…ØªÛŒØ§Ø² ${rating || 0}">
          <svg class="w-[14px] h-[14px] text-amber-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
          <span class="text-gray-700">${(rating || 0).toFixed(1).replace('.', 'Ù«')}</span>
          <span class="text-gray-500">(${toFa(ratingCount)})</span>
        </div>
      </div>

      ${showDesc ? `<p class="text-[13px] sm:text-[14px] text-gray-600 leading-6 line-clamp-2">${descRaw}</p>` : ''}

      <!-- Ø±Ø¯ÛŒÙ Ù‚ÛŒÙ…Øª / Ø±Ø²Ø±Ùˆ -->
      <div class="mt-1 grid grid-cols-[1fr_auto] items-center gap-4">
        <div class="min-w-0">
          <div class="flex items-baseline gap-1">
            <span class="service-price text-[19px] sm:text-[20px] font-extrabold tracking-tight text-gray-900">
              <span class="price-view">${priceFa(finalPrice)}</span>
            </span>
            <span class="service-currency text-[12px] sm:text-[13px] text-gray-500">ØªÙˆÙ…Ø§Ù†</span>
          </div>
          <div class="text-[11px] sm:text-[12px] text-rose-600 ${hasOff ? '' : 'hidden'}">
            <s class="text-gray-400">${priceFa(item.price || 0)}</s><span class="ml-1">â€“ ${toFa(offPct)}Ùª</span>
          </div>
        </div>

        <!-- Ø¯Ú©Ù…Ù‡ Ø±Ø²Ø±Ùˆ (Ø¨Ø¯ÙˆÙ† Ø¢ÛŒÚ©Ù†ØŒ Ø³Ø§ÛŒØ² Ù„Ù…Ø³ÛŒ) -->
        <button
          class="service-button cta-button inline-flex items-center justify-center text-white font-bold py-3 sm:py-3.5 px-6 sm:px-7 rounded-full text-[14px] sm:text-[15px] leading-none whitespace-nowrap transition-all ${item.isActive ? '' : 'opacity-40 pointer-events-none'}"
          data-service="${title}" data-price="${finalPrice || 0}" aria-label="Ø±Ø²Ø±Ùˆ ${title}"
        >
          Ø±Ø²Ø±Ùˆ
        </button>
      </div>
    </div>
  </article>`;
}






  /** ================== Bootstrap ================== **/
  const servicesContainer = findServicesContainer();
  bindReserveClicks(servicesContainer);

  let LAST_PUBLIC = { items: [], sellerId: null };
  // expose to global scope for booking scripts
  window.LAST_PUBLIC = LAST_PUBLIC;

  function renderList() {
    if (!servicesContainer) return;
    servicesContainer.innerHTML = '';
    if (!LAST_PUBLIC.items || LAST_PUBLIC.items.length === 0) {
      servicesContainer.innerHTML = `
        <div class="w-full text-center text-gray-500 py-8">
          ÙØ¹Ù„Ø§Ù‹ Ø³Ø±ÙˆÛŒØ³ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
        </div>`;
      return;
    }

    // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ: ÙØ¹Ø§Ù„â€ŒÙ‡Ø§ Ø§ÙˆÙ„ØŒ Ø¨Ø¹Ø¯ Ù‚ÛŒÙ…Øª ØµØ¹ÙˆØ¯ÛŒ
    const sorted = [...LAST_PUBLIC.items].sort((a,b) => {
      if (!!b.isActive - !!a.isActive) return (!!b.isActive - !!a.isActive);
      if ((a.price||0) !== (b.price||0)) return (a.price||0) - (b.price||0);
      return (a.createdAt||'') < (b.createdAt||'') ? 1 : -1;
    });

    sorted.forEach(item => {
      if (!item.isActive) return;
      servicesContainer.insertAdjacentHTML('beforeend', cardTemplate(item));
    });
  }

async function renderAll() {
  const shopurl = await getShopUrlFromLocation();
  if (!shopurl) { show404(); return; }

  try {
    const [data, seller] = await Promise.all([
      apiGetPublic(shopurl),
      apiGetSeller(shopurl)
    ]);

LAST_PUBLIC = data; // { items, sellerId }
window.LAST_PUBLIC = LAST_PUBLIC; // keep global in sync
updateSellerProfile(seller);

// ensure sellerId is available for later requests
document.body.dataset.sellerId = data.sellerId || seller._id || seller.id;

// Store seller data for s-profile.html navigation
localStorage.setItem('seller', JSON.stringify({
  ...seller,
  sellerId: data.sellerId || seller._id || seller.id
}));
    
    
    // Load footer image using sellerId
    if (data.sellerId || seller._id || seller.id) {
      await loadFooterImage(data.sellerId || seller._id || seller.id);
    }
    
    renderList();
    document.dispatchEvent(new CustomEvent('services:loaded', { detail: data.items || [] }));
  } catch (err) {
    console.error('Load public services failed', err);
    show404();
  }
}

  document.addEventListener('DOMContentLoaded', renderAll);
})();
</script>
<!-- ==== VENDOR SERVICES â€“ END ==== -->


<script>
(() => {
  'use strict';

  // ---------- Helpers ----------
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const toFa = n => String(n ?? 0).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);

  // shop slug from URL (?shopurl=, ?shop=, ?seller=)
  function getShopSlug() {
    const u = new URL(location.href);
    return (u.searchParams.get('shopurl') || u.searchParams.get('shop') || u.searchParams.get('seller') || '').trim();
  }

  // API base (optional global). Falls back to same origin.
  const API_BASE = (window.API_BASE || '').replace(/\/+$/, '');
  const SLUG = getShopSlug();

  // Candidate endpoints to be compatible with new backend & s-seller-panel.js
  // The first "ok & non-empty" wins. You can prune once your final route is fixed.
  const CANDIDATES = [
    `${API_BASE}/api/portfolio/public/${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/portfolio?shopurl=${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/service-portfolio/public/${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/seller-portfolio/public/${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/portfolios/public/${encodeURIComponent(SLUG)}`,
  ];

  // Normalize backend item to UI model
  function normalize(item) {
    const img = item.image || item.cover || (item.images?.[0]?.url || item.images?.[0]) || '';
    return {
      id:      item._id || item.id || crypto.randomUUID?.() || ('pf_' + Math.random().toString(36).slice(2)),
      title:   item.title || item.name || 'â€”',
      desc:    item.description || item.desc || '',
      image:   img,
      views:   item.views ?? item.viewCount ?? 0,
      likes:   item.likeCount ?? item.likes ?? 0,
      liked:   !!item.liked,
      created: item.createdAt || item.updatedAt || null
    };
  }

  async function tryFetch(url) {
    const r = await fetch(url, { credentials: 'include' });
    if (!r.ok) return null;
    const data = await r.json().catch(()=>null);
    const list = Array.isArray(data) ? data : (data?.items || data?.data || data?.results || []);
    return Array.isArray(list) ? list : null;
  }

  function getLocalPortfolio() {
    try {
      const raw = localStorage.getItem('vit_portfolio');
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr.map(normalize) : [];
    } catch (_) {
      return [];
    }
  }

  async function loadPortfolio() {
    if (!SLUG) return getLocalPortfolio();
    for (const url of CANDIDATES) {
      try {
        const items = await tryFetch(url);
        if (items && items.length) return items.map(normalize);
      } catch (_) {}
    }
    return getLocalPortfolio();
  }

  // ---------- Rendering ----------
  const grid = $('#portfolio-grid');
  const row  = $('#portfolio-row');
  const emptyMsg = $('#portfolio-empty');
  const loading  = $('#portfolio-loading');
  const tpl = $('#tpl-portfolio-card');

  function createCard(it) {
    const node = tpl.content.firstElementChild.cloneNode(true);

    const imgEl   = node.querySelector('.portfolio-img');
    const titleEl = node.querySelector('.portfolio-name');
    const descEl  = node.querySelector('.portfolio-description');
    const vEl     = node.querySelector('.js-views');
    const lEl     = node.querySelector('.js-likes');
    const btn     = node.querySelector('.js-open');

    titleEl.textContent = it.title || 'â€”';
    descEl.textContent  = it.desc || '';
    vEl.textContent     = toFa(it.views);
    lEl.textContent     = toFa(it.likes);

    // Lazy: use data-src; real load by IntersectionObserver
    imgEl.alt = it.title || '';
    imgEl.dataset.src = it.image || '';
    imgEl.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='; // 1x1
    node.dataset.itemId = it.id;
    const hWrap = node.querySelector('.fa-heart')?.parentElement;
    const hIcon = hWrap?.querySelector('.fa-heart');
    if(hWrap && hIcon && it.liked){
      hIcon.classList.remove('far');
      hIcon.classList.add('fas');
      hWrap.classList.add('text-red-500');
    }

    btn.addEventListener('click', () => openImageModal(it));

    return node;
  }

function render(items) {
  // clear
  row.innerHTML = '';
  grid.innerHTML = '';
  if (!items.length) {
    emptyMsg.classList.remove('hidden');
    return;
  }
  emptyMsg.classList.add('hidden');
  // mobile row
  items.forEach(it => row.appendChild(createCard(it)));
  // desktop grid - create separate cards for desktop to avoid duplication
  items.forEach(it => grid.appendChild(createCard(it)));
  // DON'T show grid here - let CSS handle it
  // grid.classList.remove('hidden'); // Remove this line
  // start lazy load
  lazyLoadImages();
}

  // ---------- Lazy Loading ----------
  function lazyLoadImages() {
    const imgs = $$('#portfolio .portfolio-img');
    if (!('IntersectionObserver' in window)) {
      imgs.forEach(img => { if (img.dataset.src) img.src = img.dataset.src; });
      return;
    }
    const io = new IntersectionObserver((entries, obs) => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          const img = e.target;
          const src = img.dataset.src;
          if (src) {
            img.src = src;
            img.removeAttribute('data-src');
          }
          obs.unobserve(img);
        }
      });
    }, { rootMargin: '120px' });
    imgs.forEach(img => io.observe(img));
  }

  // ---------- Image Modal ----------
  const imageModal = $('#imageModal');
  const imageEl    = $('#modalImage');
  const titleEl    = $('#modalTitle');
  const mViews     = $('#modalViews');
  const mLikes     = $('#modalLikes');
  const closeBtn   = $('#imageModalClose');
  const modalContent = imageModal?.querySelector('.relative');

  function openImageModal(it) {
    if (!imageModal) return;
    titleEl.textContent = it.title || '';
    imageEl.src = it.image || '';
    imageEl.alt = it.title || '';
    mViews.textContent = toFa(it.views ?? 0);
    const curLikes = typeof window.__getPortfolioLikes === 'function' ? window.__getPortfolioLikes(it.id) : (it.likes ?? 0);
    mLikes.textContent = toFa(curLikes);
    window.__PF_SET_ACTIVE_ID?.(it.id);
    imageModal.classList.remove('hidden');
    imageModal.classList.add('flex');
    modalContent?.classList.remove('scale-95','opacity-0');
    modalContent?.classList.add('scale-100','opacity-100');
    document.addEventListener('keydown', onEsc);
  }

  function closeImageModal() {
    modalContent?.classList.add('scale-95','opacity-0');
    modalContent?.classList.remove('scale-100','opacity-100');
    imageModal.classList.add('hidden');
    imageModal.classList.remove('flex');
    imageEl.src = '';
    document.removeEventListener('keydown', onEsc);
  }

  function onEsc(e) { if (e.key === 'Escape') closeImageModal(); }

  closeBtn?.addEventListener('click', closeImageModal);
  imageModal?.addEventListener('click', e => { 
    if (e.target === imageModal) closeImageModal();
  });

  // ---------- Public refresh hook (optional) ----------
  // Ø§Ú¯Ø± Ù¾Ù†Ù„ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ø«Ø¨Øª Ù†Ù…ÙˆÙ†Ù‡â€ŒÚ©Ø§Ø± event Ø¨Ø²Ù†Ù‡ØŒ Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±ÙØ±Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯:
  // document.dispatchEvent(new Event('portfolio:refresh'))
  document.addEventListener('portfolio:refresh', async () => {
    loading?.classList.remove('hidden');
    const items = await loadPortfolio();
    render(items);
    document.dispatchEvent(new CustomEvent('portfolio:rendered', { detail: { items } }));
    loading?.classList.add('hidden');
  });

  // ---------- Boot ----------
  (async () => {
    try {
      const items = await loadPortfolio();
      render(items);
      document.dispatchEvent(new CustomEvent('portfolio:rendered', { detail: { items } }));
    } finally {
      loading?.classList.add('hidden');
    }
})();
})();
</script>

<script src="booking-status-popup.js"></script>

<script>
(function () {
  // 1) ØªØ²Ø±ÛŒÙ‚ shopurl / sellerId Ø§Ø² URL Ø¨Ù‡ Ø¯ÛŒØªØ§Ø³ØªÙ Ø¨Ø¯Ù†Ù‡
  const params   = new URLSearchParams(location.search);
  const shopurl  = params.get('shopurl');
  const sellerId = params.get('sellerId');

  if (shopurl)  document.body.dataset.shopurl  = shopurl;
  if (sellerId) document.body.dataset.sellerId = sellerId;

  // 2) Ù¾Ø±ÛŒâ€ŒÙÛŒÙ„ Ø³Ø±ÙˆÛŒØ³ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ²Ø§Ø±Ø¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ: Ø§Ú¯Ø± Ø¯Ø± URL Ø¨ÙˆØ¯)
  //     Ø§ÛŒÙ† Ú©Ù„ÛŒØ¯ Ù‡Ù…ÙˆÙ†Ù‡ Ú©Ù‡ Ø®ÙˆØ¯ ÙˆÛŒØ²Ø§Ø±Ø¯ Ø¯Ø§Ø®Ù„Ø´ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ Ø±Ùˆ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±Ù‡
  const SS_KEY    = 'vt:booking.sel';
  const service   = params.get('service');     // Ù…Ø«Ù„Ø§ "Ø§ØµÙ„Ø§Ø­ Ø³Ø± Ùˆ ØµÙˆØ±Øª"
  const price     = params.get('price');       // Ù…Ø«Ù„Ø§ 150000
  const serviceId = params.get('serviceId');   // Ø§Ú¯Ø± Ø¯Ø§Ø±ÛŒ

  if (service || price || serviceId) {
    let cur = {};
    try { cur = JSON.parse(sessionStorage.getItem(SS_KEY) || '{}'); } catch(_) {}
    if (service)   cur.service   = decodeURIComponent(service);
    if (price)     cur.price     = parseInt(price, 10) || 0;
    if (serviceId) cur.serviceId = serviceId;
    try { sessionStorage.setItem(SS_KEY, JSON.stringify(cur)); } catch(_) {}
  }

  // 3) Ø§Ú¯Ø± Ø¨Ø§ #booking-wizard Ø§ÙˆÙ…Ø¯ÛŒÙ…ØŒ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø§ÛŒÙ…Ù† ÙˆÛŒØ²Ø§Ø±Ø¯ Ø±Ùˆ Ø¨Ø§Ø² Ú©Ù†
  function bootWizardFromHash() {
    if (location.hash !== '#booking-wizard') return;

    // Ø§ÙˆÙ„ÙˆÛŒØª: Ø§Ø² Ú¯Ø§Ø±Ø¯ Ø¯Ø§Ø®Ù„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† (Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±Ø²Ø±Ùˆ Ø¯Ø± Ø­Ø§Ù„Øª pending)
    if (typeof window.openBookingWizard === 'function') {
      window.openBookingWizard(
        service ? { service: decodeURIComponent(service), price: parseInt(price || '0', 10) || undefined } : undefined
      );
      return;
    }

    // ÙØ§Ù„Ø¨Ú© Ø³Ø§Ø¯Ù‡: Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ú©Ø´Ù† Ùˆ Ø§Ø³Ú©Ø±ÙˆÙ„
    const el = document.getElementById('booking-wizard');
    if (el) {
      el.classList.remove('hidden');
      const top = el.getBoundingClientRect().top + window.scrollY - 80;
      window.scrollTo({ top, behavior: 'smooth' });
    }
  }

  document.addEventListener('DOMContentLoaded', bootWizardFromHash);
  window.addEventListener('hashchange', bootWizardFromHash);
})();
</script>


</body>
</html>
