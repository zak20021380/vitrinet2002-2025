<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="page-title">— | Vitreenet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            font-family: 'Vazirmatn', sans-serif;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .service-card {
            scroll-snap-align: start;
        }
        .review-card {
            scroll-snap-align: start;
        }
        .scroll-container {
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .scroll-container::-webkit-scrollbar {
            display: none;
        }
        .bounce-animation {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        .progress-animation {
            animation: progress 2s ease-out;
        }
        @keyframes progress {
            0% {
                width: 0%;
            }
        }
        .premium-icon {
            transition: all 0.3s ease;
        }
        .premium-icon:hover {
            filter: drop-shadow(0 0 6px #3B82F6);
            transform: scale(1.1);
        }
        .badge-minimal {
            font-size: 0.65rem;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;
        }
        .scrollbar-hide {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Header Animations */
        .logo-animation {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .logo-animation:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.6));
        }
        .header-item {
            transition: all 0.2s ease;
        }
        .header-item:hover {
            transform: translateY(-2px);
        }
        .status-chip {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        .mobile-menu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .mobile-menu.active {
            max-height: 500px;
        }
        /* Service Card Styles */
        .service-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .service-price {
            font-size: 1.5rem;
            font-weight: 900;
            color: #1e40af;
        }
        .service-currency {
            font-size: 0.9rem;
            font-weight: 500;
            color: #64748b;
        }
        .service-button {
            background: linear-gradient(135deg, #06b6d4, #3b82f6, #10b981);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .service-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            transition: left 0.5s ease;
        }
        .service-button:hover::before {
            left: 100%;
        }
        .service-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
        }
        .service-button:active {
            transform: translateY(0) scale(0.98);
        }
        .cta-button {
            background: linear-gradient(135deg, #06b6d4, #3b82f6, #10b981);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .cta-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            transition: left 0.5s ease;
        }
        .cta-button:hover::before {
            left: 100%;
        }
        .cta-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
        }
        .cta-button:active {
            transform: translateY(0) scale(0.98);
        }
        
        /* Portfolio Section Styles */
        .portfolio-section {
            padding: 3rem 1rem;
            background: linear-gradient(to bottom, #f9fafb, #ffffff);
        }
        .portfolio-title {
            text-align: center;
            font-size: 1.875rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 0.5rem;
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .portfolio-title::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            border-radius: 4px;
            margin: 0.75rem auto 0;
        }
        .portfolio-subtitle {
            text-align: center;
            color: #64748b;
            font-size: 1.125rem;
            margin-bottom: 2.5rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        .portfolio-card {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .portfolio-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }
        .portfolio-img-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem 1rem 0 0;
            height: 220px;
        }
        .portfolio-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        .portfolio-card:hover .portfolio-img {
            transform: scale(1.05);
        }
        .portfolio-content {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .portfolio-name {
            font-weight: 700;
            font-size: 1.25rem;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }
        .portfolio-description {
            color: #64748b;
            font-size: 0.9375rem;
            line-height: 1.6;
            flex-grow: 1;
            margin-bottom: 1.5rem;
        }
        .portfolio-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .portfolio-stat {
            display: flex;
            align-items: center;
            color: #64748b;
            font-size: 0.875rem;
        }
        .portfolio-stat i {
            margin-left: 0.25rem;
        }
        .portfolio-btn {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            width: fit-content;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            margin-top: auto;
        }
        .portfolio-btn:hover {
            background: linear-gradient(135deg, #2563eb, #0891b2);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
        }
        .portfolio-btn:active {
            transform: translateY(0);
        }
        
        /* Modal Styles */
        #imageModal {
            transition: all 0.3s ease;
        }
        #imageModal .relative {
            transition: all 0.3s ease;
            transform: scale(0.95);
            opacity: 0;
        }
        #imageModal .scale-100 {
            transform: scale(1);
        }
        #imageModal .opacity-100 {
            opacity: 1;
        }
        #imageModal .scale-95 {
            transform: scale(0.95);
        }
        #imageModal .opacity-0 {
            opacity: 0;
        }
        
        /* Line clamp for description text */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* mobile nav */
        @media (max-width: 768px) {
            .hide-on-mobile { display: none !important; }
        }
        ::-webkit-scrollbar {width: 7px;}
        ::-webkit-scrollbar-thumb {background: #c8f7e6;}
        @media (max-width: 640px) {
            body { padding-bottom: 72px; }
            footer:not(.mobile-nav) { display: none; }
            .mobile-nav {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 72px;
                background: rgba(255,255,255,0.96);
                backdrop-filter: blur(12px);
                border-top: 1px solid rgba(224,242,254,0.8);
                border-radius: 24px 24px 0 0;
                box-shadow: 0 -5px 25px rgba(0,0,0,0.08);
                z-index: 100;
                padding: 8px 0;
            }
            .nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: #94a3b8;
                transition: all 0.2s;
                border-radius: 12px;
                padding: 6px 0;
            }
            .nav-item.active {
                color: #10b981;
                transform: translateY(-4px);
            }
            .nav-item:active { transform: scale(0.92); }
            .nav-icon {
                width: 24px;
                height: 24px;
                margin-bottom: 4px;
            }
            .nav-label {
                font-size: 11px;
                font-weight: 800;
            }
        }
        
/* --- Chips & Dialog (new) --- */
.chip {
  height: 36px;
  padding: 0 12px;
  border-radius: 9999px;
  font-weight: 800;
  font-size: 12px;
  background: rgba(255,255,255,0.82);
  color: #374151; /* gray-700 */
  border: 1px solid rgba(255,255,255,0.6);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  box-shadow: 0 4px 14px rgba(59,130,246,0.08);
  transition: all .2s ease;
  display: inline-flex; align-items: center; gap: 6px;
}
.chip:hover { background: #fff; box-shadow: 0 8px 22px rgba(59,130,246,0.14); }
.chip:active { transform: scale(0.98); }

.chip--primary {
  color: #fff;
  background: linear-gradient(135deg,#3B82F6,#06B6D4);
  border: none;
  box-shadow: 0 6px 20px rgba(59,130,246,0.28);
}
.chip--primary:hover { filter: brightness(0.98); }

.dialog-card-enter { transform: scale(0.96); opacity: 0; }
.dialog-card-show  { transform: scale(1);    opacity: 1; transition: all .18s ease; }

        
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Sticky Header -->
    <!-- header desktop redesign start -->
<header id="main-header" class="sticky top-0 z-[90] isolate bg-white md:bg-white/50 md:backdrop-blur-md shadow-sm transition-all duration-300">
  <!-- ========== Mobile Header ========== -->
  <div id="mobile-header" class="md:hidden px-3">
    <div id="mobile-top" class="flex items-center justify-between h-14 py-3">
      <!-- Brand (right on RTL) -->
      <a href="/index.html" class="text-blue-600 font-extrabold text-lg tracking-tight">
        ویترینت
      </a>

      <!-- Title (center) -->
      <h1
        class="flex-1 mx-2 text-center text-[15px] font-extrabold text-gray-900 truncate"
        title="آرایشگاه مردانه سلطنتی"
      >
        آرایشگاه مردانه سلطنتی
      </h1>

      <!-- Actions (left): Report + Address -->
      <div class="flex items-center gap-2">
        <button
          id="mobile-report-trigger"
          data-open="reportModal"
          aria-label="گزارش مشکل"
          class="h-9 px-3 rounded-full text-blue-700 bg-white/80 backdrop-blur-md border border-white/60 shadow-sm hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs font-bold transition-all"
        >
          گزارش
        </button>
        <button
          id="mobile-address-chip"
          data-open="addressModal"
          role="button"
          aria-label="نمایش آدرس"
          class="h-9 px-3 rounded-full text-gray-800 bg-white/90 backdrop-blur-md border border-white/60 shadow-sm hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs font-bold flex items-center gap-1 transition-all"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          آدرس
        </button>
      </div>
    </div>

    <!-- keep stub for compatibility -->
    <div id="mobile-chips" class="hidden h-0 overflow-hidden"></div>
  </div>

  <!-- ========== Desktop Header Bar ========== -->
  <div class="hidden md:block">
    <div class="max-w-screen-xl mx-auto px-3 py-3">
      <div class="flex items-center justify-between gap-3 flex-nowrap">
        <!-- Brand -->
        <div class="flex items-center gap-2 flex-shrink-0 md:w-40">
          <a href="/index.html" class="flex items-center focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-10 h-10 text-blue-600 md:hidden">
              <path fill="currentColor" d="M12 2L2 7l10 5l10-5l-10-5m0 2.53L19.22 7L12 10.47L4.78 7L12 4.53M2 17v3.5a1.5 1.5 0 0 0 1.5 1.5h17a1.5 1.5 0 0 0 1.5-1.5V17l-10-5l-10 5m0 2h14v2H5v-2z"/>
            </svg>
            <span class="hidden md:inline-block text-xl font-extrabold tracking-wide text-blue-600 transition-transform hover:scale-105 hover:drop-shadow-[0_0_6px_rgba(37,99,235,0.6)]">ویترینت</span>
          </a>
        </div>

        <!-- Identity Cluster (md only, centered text + chips) -->
        <div class="flex-1 flex flex-col items-center lg:hidden">
          <h1 class="text-lg font-black text-gray-900 text-center truncate md:hidden">آرایشگاه مردانه سلطنتی</h1>
          <div class="hidden md:flex lg:hidden items-center text-sm">
            <h1 class="font-extrabold text-gray-900 truncate max-w-[200px]">آرایشگاه مردانه سلطنتی</h1>
            <span class="mx-2 text-gray-400">•</span>
            <!-- unified trigger attribute -->
            <button
              id="desktop-address-chip"
              data-open="addressModal"
              class="flex items-center gap-1 bg-white/80 backdrop-blur-md border border-white/60 px-3 py-1 rounded-full text-gray-800 transition hover:bg-white hover:shadow focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              آدرس
            </button>
            <span class="mx-2 text-gray-400">•</span>
            <span class="flex items-center gap-1 bg-white/80 backdrop-blur-md border border-white/60 px-3 py-1 rounded-full text-gray-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-amber-500" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2L9.19 8.63L2 9.24l5.46 4.73L5.82 21z"/>
              </svg>
        <span id="avg-rating" class="font-bold">0.0</span>
<span class="text-gray-500">(<span id="review-count">0</span>)</span>
            </span>
          </div>
        </div>

        <!-- Mobile Address & Rating (xs) -->
        <div class="flex items-center gap-3 flex-shrink-0 text-[10px] sm:text-xs md:hidden">
          <div class="flex items-center gap-1 text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <span class="truncate max-w-[80px] sm:max-w-[120px]">-</span>
          </div>
          <div class="flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-amber-500" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2L9.19 8.63L2 9.24l5.46 4.73L5.82 21z"/>
            </svg>
            <span class="font-bold">4.8</span>
            <span class="text-gray-500">(128)</span>
          </div>
        </div>

        <div class="hidden md:block lg:hidden md:w-40"></div>

        <!-- Desktop Center Cluster (lg) -->
        <div class="hidden lg:flex flex-1 items-center justify-center text-sm whitespace-nowrap">
          <h1 class="font-extrabold text-gray-900 truncate max-w-[220px]" title="آرایشگاه مردانه سلطنتی">آرایشگاه مردانه سلطنتی</h1>
          <span class="mx-2 text-gray-400">·</span>
          <button
            id="address-trigger"
            data-open="addressModal"
            class="flex items-center gap-1 bg-white/80 backdrop-blur-md border border-white/60 px-3 py-1 rounded-full text-gray-800 hover:bg-white hover:shadow transition focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            آدرس
          </button>
          <span class="mx-2 text-gray-400">·</span>
          <span class="flex items-center gap-1 bg-white/80 backdrop-blur-md border border-white/60 px-3 py-1 rounded-full text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-amber-500" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2L9.19 8.63L2 9.24l5.46 4.73L5.82 21z"/>
            </svg>
            <span class="font-bold">4.8</span>
            <span class="text-gray-500">(128)</span>
          </span>
          <span class="mx-2 text-gray-400">·</span>
          <button
            id="report-trigger"
            data-open="reportModal"
            class="flex items-center gap-1 bg-white/80 backdrop-blur-md border border-white/60 px-3 py-1 rounded-full text-blue-700 hover:bg-white hover:shadow transition focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold"
          >
            گزارش
          </button>
        </div>

        <div class="hidden lg:block lg:w-40"></div>
      </div>
    </div>
  </div>
</header>
<div id="seller-profile" class="max-w-4xl mx-auto p-4 text-center hidden">
  <h2 id="seller-name" class="text-2xl font-bold mb-2"></h2>
  <p id="seller-category" class="text-gray-600"></p>
  <p id="seller-phone" class="text-gray-600"></p>
  <p id="seller-address" class="text-gray-600"></p>
</div>





<!-- Address Modal (simple & clean) -->
<div id="addressModal" role="dialog" aria-modal="true" aria-labelledby="address-title"
     class="hidden fixed inset-0 z-[80] items-center justify-center">
  <!-- backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" data-close></div>

  <!-- card -->
  <div class="modal-card relative w-[92%] max-w-sm bg-white rounded-2xl shadow-xl p-5
              transform transition duration-150 scale-95 opacity-0">
    <!-- close -->
    <button type="button" data-close
            class="absolute top-2 left-2 text-gray-500 hover:text-gray-700 text-xl leading-none">
      &times;
    </button>

    <!-- title -->
    <div class="flex items-center gap-2 mb-3">
      <span class="inline-flex w-9 h-9 items-center justify-center rounded-xl
                   bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
        <!-- pin icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
      </span>
      <h2 id="address-title" class="text-base font-extrabold text-gray-900">آدرس</h2>
    </div>

    <!-- content -->
    <div class="space-y-3 text-[13px] sm:text-sm leading-7 text-gray-700">
      <div class="flex items-start gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mt-1 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <p id="full-address">—</p>

      </div>

      <div class="flex items-center gap-2 text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-emerald-600" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6.62 10.79a15.053 15.053 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24c1.11.37 2.3.57 3.58.57a1 1 0 011 1V20a1 1 0 01-1 1C10.07 21 3 13.93 3 5a1 1 0 011-1h3.5a1 1 0 011 1c0 1.28.2 2.47.57 3.58a1 1 0 01-.24 1.01l-2.21 2.2z"/>
        </svg>
        <a href="tel:" class="font-bold tracking-wide">—</a>

      </div>
    </div>

    <!-- actions -->
    <div class="mt-5 text-left">
      <button type="button" data-close
              class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold">
        بستن
      </button>
    </div>
  </div>
</div>


<div id="reportModal" role="dialog" aria-modal="true" aria-labelledby="report-title"
     class="hidden fixed inset-0 z-[80] items-center justify-center">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" data-close></div>
  <div class="modal-card relative bg-white/80 backdrop-blur-xl border border-white/60 rounded-2xl shadow-lg p-6 w-11/12 max-w-md transform transition duration-150 scale-95 opacity-0">
    <h2 id="report-title" class="mb-4 text-lg font-bold bg-gradient-to-r from-blue-500/20 to-teal-400/20 p-2 rounded-xl text-center">گزارش مشکل</h2>
    <form id="report-form" class="space-y-4">
      <div>
        <textarea id="report-text" maxlength="500" class="w-full min-h-[6rem] p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm resize-none" placeholder="مشکل یا سوءاستفاده را توضیح دهید…"></textarea>
        <div id="report-counter" class="text-xs text-gray-500 text-left mt-1">۰/۵۰۰</div>
      </div>
      <input id="report-contact" type="text" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="اطلاعات تماس (اختیاری)">
      <div class="flex justify-end gap-3">
        <button type="button" data-close class="px-4 py-2 rounded-full bg-white/80 hover:bg-white hover:shadow transition focus:outline-none focus:ring-2 focus:ring-blue-500">انصراف</button>
        <button type="submit" class="px-4 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-500">ارسال گزارش</button>
      </div>
    </form>
  </div>
</div>



<!-- Pending Booking Modal -->
<div id="pendingBookingModal" role="dialog" aria-modal="true" aria-labelledby="pb-title"
     class="hidden fixed inset-0 z-[120] items-center justify-center">
  <!-- backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" data-close></div>

  <!-- card -->
  <div class="modal-card relative w-[92%] max-w-sm bg-white rounded-2xl shadow-2xl p-6
              transform transition duration-150 scale-95 opacity-0">
    <!-- close -->
    <button type="button" data-close
            class="absolute top-2 left-2 text-gray-500 hover:text-gray-700 text-xl leading-none">
      &times;
    </button>

    <!-- header -->
    <div class="flex items-center gap-3 mb-4">
      <span class="inline-flex w-10 h-10 items-center justify-center rounded-xl
                   bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s-9-6-9-13a9 9 0 1118 0c0 7-9 13-9 13z"></path>
          <path d="M9 12l2 2 4-4"></path>
        </svg>
      </span>
      <div>
        <h3 id="pb-title" class="text-base font-extrabold text-gray-900">درخواست ثبت شد</h3>
        <p class="text-xs text-gray-500">نوبت شما در انتظار تأیید فروشنده است</p>
      </div>
    </div>

    <!-- details -->
    <div class="rounded-xl bg-gray-50 border border-gray-200 p-4 mb-4 text-sm">
      <div class="grid grid-cols-2 gap-y-2 gap-x-3">
        <div class="text-gray-600">خدمت</div>   <div id="pb-service" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">تاریخ</div>   <div id="pb-date"    class="font-bold text-gray-800"></div>
        <div class="text-gray-600">ساعت</div>    <div id="pb-time"    class="font-bold text-gray-800"></div>
        <div class="text-gray-600">شماره شما</div><div id="pb-phone"   class="font-bold text-gray-800 ltr-num"></div>
      </div>
    </div>

    <div class="flex items-start gap-2 text-xs text-gray-600 mb-5">
      <i class="fas fa-sms mt-0.5"></i>
      <span>در صورت تأیید، نتیجه از طریق پیامک اطلاع‌رسانی می‌شود.</span>
    </div>

    <!-- actions -->
    <div class="flex justify-end">
      <button type="button" data-close
              class="px-4 py-2 rounded-full bg-blue-600 text-white font-bold hover:bg-blue-700">
        متوجه شدم
      </button>
    </div>
  </div>
</div>




<!-- Block Booking While Pending (clean popup) -->
<div id="pendingBlockModal" role="dialog" aria-modal="true" aria-labelledby="pb-block-title"
     class="hidden fixed inset-0 z-[130] items-center justify-center">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" data-close></div>

  <div class="modal-card relative w-[92%] max-w-sm bg-white rounded-2xl shadow-2xl p-6
              transform transition duration-150 scale-95 opacity-0">
    <button type="button" data-close class="absolute top-2 left-2 text-gray-500 hover:text-gray-700 text-xl leading-none">&times;</button>

    <div class="flex items-center gap-3 mb-3">
      <span class="inline-flex w-10 h-10 items-center justify-center rounded-xl bg-gradient-to-tr from-amber-500 to-red-500 text-white">
        <i class="fas fa-hourglass-half"></i>
      </span>
      <div>
        <h3 id="pb-block-title" class="text-base font-extrabold text-gray-900">لطفاً کمی صبر کنید</h3>
        <p class="text-xs text-gray-500">نوبت قبلی شما هنوز در انتظار تأیید فروشنده است.</p>
      </div>
    </div>

    <div class="rounded-xl bg-gray-50 border border-gray-200 p-4 mb-4 text-sm">
      <div class="grid grid-cols-2 gap-y-2 gap-x-3">
        <div class="text-gray-600">خدمت</div><div id="pblk-service" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">تاریخ</div><div id="pblk-date" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">ساعت</div><div id="pblk-time" class="font-bold text-gray-800"></div>
        <div class="text-gray-600">ثبت‌شده</div><div id="pblk-created" class="font-bold text-gray-800"></div>
      </div>
    </div>

    <div class="text-xs text-gray-600 mb-5">
      پس از تأیید، از طریق پیامک اطلاع‌رسانی می‌شود و سپس می‌توانید نوبت جدید بگیرید.
    </div>

    <div class="flex justify-end">
      <button type="button" data-close class="px-4 py-2 rounded-full bg-blue-600 text-white font-bold hover:bg-blue-700">
        متوجه شدم
      </button>
    </div>
  </div>
</div>



<!-- Toast should be above modals -->
<div id="headerToast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] bg-blue-600 text-white text-sm px-4 py-2 rounded-full shadow-lg opacity-0 transition-opacity pointer-events-none"></div>


<script>
function showToastDark(message, {type='success', durationMs=2600} = {}) {
  const icons = {
    success: 'fas fa-check',
    info: 'fas fa-info-circle',
    error: 'fas fa-exclamation-circle'
  };
  const existing = document.getElementById('dark-toast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.id = 'dark-toast';
  toast.setAttribute('role', 'status');
  toast.setAttribute('aria-live', 'polite');
  toast.setAttribute('aria-atomic', 'true');
  toast.dir = 'ltr';
  toast.className = 'fixed left-1/2 -translate-x-1/2 bottom-[max(16px,env(safe-area-inset-bottom))] z-[160] bg-black text-white rounded-xl px-4 py-3 shadow-lg ring-1 ring-white/20 flex items-center gap-3 opacity-0 translate-y-2 transition-all duration-200 max-w-[92vw] sm:max-w-md';
  const icon = document.createElement('i');
  icon.className = icons[type] || icons.info;
  const msg = document.createElement('span');
  msg.textContent = message;
  msg.className = 'flex-1';
  msg.dir = 'rtl';
  const closeBtn = document.createElement('button');
  closeBtn.type = 'button';
  closeBtn.textContent = '×';
  closeBtn.className = 'text-xl leading-none';
  toast.append(icon, msg, closeBtn);
  document.body.appendChild(toast);
  requestAnimationFrame(() => {
    toast.classList.remove('opacity-0', 'translate-y-2');
  });
  function removeToast() {
    toast.classList.add('opacity-0', 'translate-y-2');
    setTimeout(() => toast.remove(), 200);
    document.removeEventListener('keydown', onKey);
  }
  function onKey(e) {
    if (e.key === 'Escape') removeToast();
  }
  document.addEventListener('keydown', onKey);
  toast.addEventListener('click', removeToast);
  closeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeToast(); });
  setTimeout(removeToast, durationMs);
}
</script>


<script>
(() => {
  // ====== Sticky header + toast ======
  const header = document.getElementById('main-header');
  const toast  = document.getElementById('headerToast');

  function showToast(msg) {
    if (!toast) return;
    toast.textContent = msg;
    toast.classList.remove('opacity-0');
    toast.classList.add('opacity-100');
    setTimeout(() => {
      toast.classList.add('opacity-0');
      toast.classList.remove('opacity-100');
    }, 2500);
  }

  // Header shadow on scroll
  window.addEventListener('scroll', () => {
    if (!header) return;
    if (window.scrollY > 10) {
      header.classList.add('shadow-lg');
    } else {
      header.classList.remove('shadow-lg');
    }
  });

  // Mobile top compact/expand
  const mobileTop   = document.getElementById('mobile-top');
  const mobileChips = document.getElementById('mobile-chips');
  let lastY = window.scrollY;
  window.addEventListener('scroll', () => {
    if (!mobileTop || !mobileChips) return;
    if (window.innerWidth > 768) return;
    if (window.scrollY > lastY && window.scrollY > 20) {
      mobileTop.classList.remove('py-3');
      mobileTop.classList.add('py-2');
      mobileChips.classList.add('hidden');
    } else {
      mobileTop.classList.add('py-3');
      mobileTop.classList.remove('py-2');
      mobileChips.classList.remove('hidden');
    }
    lastY = window.scrollY;
  });

  // ====== Unified modal system (for both mobile & desktop) ======
  const modalCache = new Map();

  function setupModal(modal) {
    const card = modal.querySelector('.modal-card');
    const closeEls = modal.querySelectorAll('[data-close]');
    let lastFocused = null;
    let prevOverflow = '';

    const focusableSelector = 'button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])';

    function open() {
      lastFocused = document.activeElement;
      prevOverflow = document.body.style.overflow || '';
      document.body.style.overflow = 'hidden';

      modal.classList.remove('hidden');
      modal.classList.add('flex'); // اگه کلاس flex تو HTML نباشه، اینجا تضمین می‌کنیم
      requestAnimationFrame(() => {
        card.classList.remove('scale-95','opacity-0');
        card.classList.add('scale-100','opacity-100');
        const firstFocusable = card.querySelector(focusableSelector);
        if (firstFocusable) firstFocusable.focus();
      });

      document.addEventListener('keydown', trap);
    }

    function close() {
      card.classList.add('scale-95','opacity-0');
      card.classList.remove('scale-100','opacity-100');

      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.removeEventListener('keydown', trap);
        document.body.style.overflow = prevOverflow;
        if (lastFocused) lastFocused.focus();
      }, 180);
    }

    function trap(e) {
      if (e.key === 'Escape') return close();
      if (e.key !== 'Tab') return;
      const f = card.querySelectorAll(focusableSelector);
      if (!f.length) return;
      const first = f[0], last = f[f.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault(); last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault(); first.focus();
      }
    }

    // Close via elements with data-close
    closeEls.forEach(el => el.addEventListener('click', close));
    // Close when clicking outside the card
    modal.addEventListener('click', (e) => {
      if (!card.contains(e.target)) close();
    });

    return { open, close };
  }

  function bindTriggers() {
    document.querySelectorAll('[data-open]').forEach(btn => {
      const id = btn.getAttribute('data-open');
      const modal = document.getElementById(id);
      if (!modal) return;
      if (!modalCache.has(id)) modalCache.set(id, setupModal(modal));
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        modalCache.get(id).open();
      });
    });
  }
  bindTriggers();

  window.openModalById = function(id) {
    const modal = document.getElementById(id);
    if (!modal) return;
    const cached = modalCache.get(id) || setupModal(modal);
    modalCache.set(id, cached);
    cached.open();
  };

  // ====== Address copy ======
  const addressCopyBtn = document.getElementById('address-copy-btn');
  const fullAddressEl  = document.getElementById('full-address');
  if (addressCopyBtn && fullAddressEl) {
    addressCopyBtn.addEventListener('click', () => {
      const txt = (fullAddressEl.textContent || '').trim();
      if (!txt) return;
      navigator.clipboard.writeText(txt).then(() => showToastDark('آدرس کپی شد', {type:'success'}));
    });
  }

  // ====== Report form + counter ======
  const reportModal   = document.getElementById('reportModal');
  const reportForm    = document.getElementById('report-form');
  const reportText    = document.getElementById('report-text');
  const reportCounter = document.getElementById('report-counter');

  if (reportText && reportCounter) {
    const updateCounter = () => {
      const len = reportText.value.length;
      reportCounter.textContent = `${len.toLocaleString('fa-IR')}/۵۰۰`;
    };
    reportText.addEventListener('input', updateCounter);
    updateCounter();
  }

  if (reportForm && reportModal) {
    const inst = modalCache.get('reportModal') || setupModal(reportModal);
    modalCache.set('reportModal', inst);
    reportForm.addEventListener('submit', (e) => {
      e.preventDefault();
      inst.close();
      showToastDark('گزارش شما ثبت شد', {type:'success'});
      reportForm.reset();
      if (reportCounter) reportCounter.textContent = '۰/۵۰۰';
    });
  }

  // ================== Booking Gate (prevent booking when previous is pending) ==================
  (function(){
    const KEY_LAST = 'vt:lastBooking';

    function readLast(){
      try { return JSON.parse(localStorage.getItem(KEY_LAST) || 'null'); } catch(e){ return null; }
    }
    function saveLast(obj){ localStorage.setItem(KEY_LAST, JSON.stringify(obj)); }
    function hasPending(){
      const b = readLast();
      return !!(b && b.status === 'pending');
    }
    function fillBlockedModal(){
      const b = readLast(); if (!b) return;
      const $ = id => document.getElementById(id);
      $('pblk-service') && ( $('pblk-service').textContent = b.service || '' );
      $('pblk-date')    && ( $('pblk-date').textContent    = b.date    || '' );
      $('pblk-time')    && ( $('pblk-time').textContent    = b.time    || '' );
      $('pblk-created') && ( $('pblk-created').textContent = new Date(b.createdAt).toLocaleString('fa-IR') );
    }

    // بازکننده ویزارد با چک «pending»
    function openBookingWizard(prefill){
      if (hasPending()) {
        fillBlockedModal();
        if (typeof window.openModalById === 'function') window.openModalById('pendingBlockModal');
        return false;
      }
      const wiz = document.getElementById('booking-wizard');
      if (wiz && wiz.classList.contains('hidden')) wiz.classList.remove('hidden');

      // پیش‌انتخاب خدمت اگر از کارت خدمات اومدیم
      if (prefill && prefill.service) {
        document.querySelectorAll('#step-1 .service-option').forEach(opt => {
          const match = opt.dataset.service === prefill.service;
          opt.classList.toggle('bw-selected', match);
          if (match) opt.dispatchEvent(new Event('click'));
        });
      }

      const top = wiz.getBoundingClientRect().top + window.scrollY - 80;
      window.scrollTo({ top, behavior: 'smooth' });
      return true;
    }

    // اکسپورت‌ها
    window.__BOOKING_GUARD__ = { hasPending, readLast, saveLast, openBookingWizard };
    window.hasPendingBooking = hasPending;
    window.openBookingWizard = openBookingWizard;
    window.clearPendingBooking = function(){ localStorage.removeItem(KEY_LAST); };

    // اتصال دکمه‌های صفحه بعد از آماده‌شدن DOM
    document.addEventListener('DOMContentLoaded', () => {
      // CTA هیرو
      const hero = document.getElementById('hero-cta');
      if (hero) hero.addEventListener('click', (e) => { e.preventDefault(); openBookingWizard(); });

      // دکمه‌های «رزرو» روی کارت خدمات
      document.querySelectorAll('.service-button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          openBookingWizard({ service: btn.dataset.service, price: btn.dataset.price });
        });
      });
    });
  })();
  // ================== /Booking Gate ==================

})();
</script>



    <!-- Hero Section -->
<section class="relative h-64 md:h-80 overflow-hidden">
  <div class="absolute inset-0 z-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900"></div>
  <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
  <div class="absolute inset-0 flex flex-col justify-end pb-8 px-6 text-white md:items-center md:justify-center md:pb-0">
    <div class="md:text-center md:max-w-md">
      <h2 class="text-2xl font-bold mb-2 md:text-3xl" id="biz-name">نام کسب‌وکار</h2>
      <p class="text-sm mb-5" id="biz-tagline">—</p>
      <button id="hero-cta" class="text-white font-bold py-3 px-6 rounded-full bg-gradient-to-r from-cyan-500 to-blue-600 transition-all md:py-3 md:px-8 md:text-lg">
        رزرو نوبت
      </button>
    </div>
  </div>
</section>

    <!-- Services Section -->
<section class="py-8 px-4">
    <h3 class="text-xl font-bold mb-4">خدمات ما</h3>
    <div class="scroll-container flex overflow-x-auto pb-4 gap-4 snap-x snap-mandatory scrollbar-hide" style="scroll-padding: 0 1rem;">
            <!-- Service Card 1 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/barber-cutting-hair/400/300.jpg" alt="اصلاح سر و صورت" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">اصلاح سر و صورت</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">اصلاح حرفه‌ای سر و صورت با جدیدترین متدهای روز</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">۱۵۰,۰۰۰</span>
                            <span class="service-currency mr-1">تومان</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="اصلاح سر و صورت" data-price="150000">
                            رزرو
                        </button>
                    </div>
                </div>
            </div>
            <!-- Service Card 2 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/facial-massage/400/300.jpg" alt="ماساژ صورت" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">ماساژ صورت</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">ماساژ صورت با روغن‌های گیاهی و مراقبت از پوست</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">۱۲۰,۰۰۰</span>
                            <span class="service-currency mr-1">تومان</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="ماساژ صورت" data-price="120000">
                            رزرو
                        </button>
                    </div>
                </div>
            </div>
            <!-- Service Card 3 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/hair-coloring/400/300.jpg" alt="رنگ مو" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">رنگ مو</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">رنگ موی حرفه‌ای با بهترین برندهای روز دنیا</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">۲۰۰,۰۰۰</span>
                            <span class="service-currency mr-1">تومان</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="رنگ مو" data-price="200000">
                            رزرو
                        </button>
                    </div>
                </div>
            </div>
            <!-- Service Card 4 -->
            <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                <img src="https://picsum.photos/seed/professional-hair-wash/400/300.jpg" alt="شستشوی حرفه‌ای" class="service-image">
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="font-bold text-lg mb-2">شستشوی حرفه‌ای</h4>
                    <p class="text-sm text-gray-600 mb-4 flex-grow">شستشوی حرفه‌ای مو با شامپوهای مخصوص</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div>
                            <span class="service-price">۸۰,۰۰۰</span>
                            <span class="service-currency mr-1">تومان</span>
                        </div>
                        <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all" data-service="شستشوی حرفه‌ای" data-price="80000">
                            رزرو
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Portfolio Section - Updated -->
<!-- ============ Portfolio Section (Dynamic, from backend) ============ -->
<section id="portfolio" class="portfolio-section">
  <div class="container mx-auto px-4">
    <div class="text-center mb-6">
      <h2 class="portfolio-title text-3xl font-extrabold">نمونه کارها</h2>
      <p id="portfolio-empty" class="hidden text-gray-500 text-sm mt-3">فعلاً نمونه کاری ثبت نشده.</p>
      <div id="portfolio-loading" class="flex items-center justify-center gap-2 text-gray-500 text-sm mt-2">
        <i class="fas fa-spinner fa-spin"></i><span>در حال بارگذاری…</span>
      </div>
    </div>

    <!-- Mobile: horizontal -->
    <div class="md:hidden overflow-x-auto pb-6 -mx-4 px-4 scroll-container">
      <div id="portfolio-row" class="flex space-x-4 space-x-reverse w-max"></div>
    </div>

    <!-- Desktop: grid -->
    <div id="portfolio-grid" class="hidden md:grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
  </div>

  <!-- Card Template -->
  <template id="tpl-portfolio-card">
    <div class="portfolio-card bg-white rounded-2xl overflow-hidden shadow-lg transition-all duration-300 hover:shadow-xl hover:-translate-y-1 flex flex-col w-72 md:w-auto">
      <div class="relative portfolio-img-container h-56">
        <img class="portfolio-img w-full h-full object-cover" alt="">
      </div>
      <div class="portfolio-content p-5 flex flex-col flex-1">
        <h3 class="portfolio-name font-bold text-lg mb-2 truncate"></h3>
        <p class="portfolio-description text-gray-600 text-sm mb-4 line-clamp-2"></p>
        <div class="portfolio-stats flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3 space-x-reverse text-gray-500">
            <div class="flex items-center"><i class="far fa-eye ml-1"></i><span class="text-sm js-views">0</span></div>
            <div class="flex items-center"><i class="far fa-heart ml-1"></i><span class="text-sm js-likes">0</span></div>
          </div>
        </div>
        <button class="portfolio-btn w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg transition-all duration-300 hover:from-blue-600 hover:to-blue-700 hover:shadow-md js-open">
          مشاهده دقیق‌تر
        </button>
      </div>
    </div>
  </template>
</section>

<!-- Fullscreen Image Modal (re-usable, no name clash) -->
<div id="imageModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
  <div class="relative max-w-5xl w-full max-h-[90vh] flex flex-col">
    <button id="imageModalClose" class="absolute -top-12 right-0 text-white text-2xl z-10 hover:text-gray-300 transition-colors" aria-label="بستن">
      <i class="fas fa-times"></i>
    </button>
    <div class="bg-white rounded-2xl overflow-hidden shadow-2xl flex-grow flex flex-col">
      <div class="p-4 border-b">
        <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
      </div>
      <div class="flex-grow flex items-center justify-center p-2 bg-gray-100">
        <img id="modalImage" src="" alt="" class="max-w-full max-h-[60vh] object-contain rounded-lg">
      </div>
      <div class="p-4 border-t flex justify-between items-center">
        <div class="flex items-center space-x-4 space-x-reverse text-gray-600">
          <div class="flex items-center"><i class="far fa-eye ml-1"></i><span id="modalViews" class="text-sm">0</span></div>
          <div class="flex items-center"><i class="far fa-heart ml-1"></i><span id="modalLikes" class="text-sm">0</span></div>
        </div>
      </div>
    </div>
  </div>
</div>



    
    <!-- Modal for Fullscreen Image View -->
    <div id="imageModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
        <div class="relative max-w-5xl w-full max-h-[90vh] flex flex-col">
            <button onclick="closeModal()" class="absolute -top-12 right-0 text-white text-2xl z-10 hover:text-gray-300 transition-colors">
                <i class="fas fa-times"></i>
            </button>
            <div class="bg-white rounded-2xl overflow-hidden shadow-2xl flex-grow flex flex-col">
                <div class="p-4 border-b">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
                </div>
                <div class="flex-grow flex items-center justify-center p-2 bg-gray-100">
                    <img id="modalImage" src="" alt="" class="max-w-full max-h-[60vh] object-contain rounded-lg">
                </div>
                <div class="p-4 border-t flex justify-between items-center">
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <div class="flex items-center text-gray-600">
                            <i class="far fa-eye ml-1"></i>
                            <span id="modalViews" class="text-sm">1.2k</span>
                        </div>
                        <div class="flex items-center text-gray-600">
                            <i class="far fa-heart ml-1"></i>
                            <span id="modalLikes" class="text-sm">48</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Booking Wizard -->
<section id="booking-wizard" class="hidden py-8 px-4" dir="rtl">
  <style>
    /* هایلایت انتخاب‌ها + OTP */
    .bw-selected{ border-color:#3b82f6 !important; background:#eff6ff; }
    .bw-otp{ width:48px;height:56px;text-align:center;font-size:20px;border:1px solid #d1d5db;border-radius:12px;outline:0; }
    .bw-otp:focus{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.25); }
    /* شماره‌ها همیشه LTR نمایش داده شوند */
    .ltr-num{ direction:ltr; unicode-bidi:isolate; }
    /* بهبود استایل فیلد شماره موبایل (لاتین، یکنواخت) */
    .bw-phone{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-variant-numeric: tabular-nums;
      letter-spacing:.04em;
      direction:ltr;
      unicode-bidi:isolate;
    }
    /* بهبود لمس روی موبایل */
    @media (hover:none){ .bw-tap{ padding-top:.65rem; padding-bottom:.65rem; } }
  </style>

  <div class="bg-white rounded-xl shadow-md p-6">
    <h3 class="text-xl font-bold mb-6">نوبت‌گیری</h3>

    <!-- مراحل و نوار پیشرفت: 5 مرحله -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm text-gray-600">مرحله <span id="current-step">۱</span> از ۵</span>
        <div class="flex space-x-1 space-x-reverse">
          <div class="step-dot w-3 h-3 rounded-full bg-blue-600" data-step="1"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="2"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="3"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="4"></div>
          <div class="step-dot w-3 h-3 rounded-full bg-gray-300" data-step="5"></div>
        </div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width:20%"></div>
      </div>
    </div>

    <!-- Step 1: انتخاب خدمت -->
    <div id="step-1" class="step">
      <h4 class="font-bold mb-4">انتخاب خدمت</h4>
      <div class="space-y-3">
   <div id="booking-services" class="space-y-3"></div>
        <div class="service-option border border-gray-300 rounded-lg p-3 hover:border-blue-500 cursor-pointer bw-tap" data-service="ماساژ صورت" data-price="120000">
          <div class="flex justify-between items-center">
            <div>
              <h5 class="font-bold">ماساژ صورت</h5>
              <p class="text-sm text-gray-600">ماساژ صورت با روغن‌های گیاهی</p>
            </div>
            <span class="font-bold">۱۲۰٬۰۰۰ تومان</span>
          </div>
        </div>
        <div class="service-option border border-gray-300 rounded-lg p-3 hover:border-blue-500 cursor-pointer bw-tap" data-service="رنگ مو" data-price="200000">
          <div class="flex justify-between items-center">
            <div>
              <h5 class="font-bold">رنگ مو</h5>
              <p class="text-sm text-gray-600">رنگ موی حرفه‌ای</p>
            </div>
            <span class="font-bold">۲۰۰٬۰۰۰ تومان</span>
          </div>
        </div>
        <div class="service-option border border-gray-300 rounded-lg p-3 hover:border-blue-500 cursor-pointer bw-tap" data-service="شستشوی حرفه‌ای" data-price="80000">
          <div class="flex justify-between items-center">
            <div>
              <h5 class="font-bold">شستشوی حرفه‌ای</h5>
              <p class="text-sm text-gray-600">شستشوی حرفه‌ای مو</p>
            </div>
            <span class="font-bold">۸۰٬۰۰۰ تومان</span>
          </div>
        </div>
      </div>
      <button id="next-to-step-2" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full w-full transition-all disabled:bg-gray-400" disabled>
        ادامه
      </button>
    </div>

    <!-- Step 2: انتخاب روز و ساعت -->
    <div id="step-2" class="step hidden">
      <h4 class="font-bold mb-4">انتخاب روز و ساعت</h4>

      <div class="mb-6">
        <h5 class="font-medium mb-2">روز</h5>
        <div class="grid grid-cols-3 gap-2">
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">شنبه</div><div class="font-bold">۱۴ تیر</div>
          </div>
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">یکشنبه</div><div class="font-bold">۱۵ تیر</div>
          </div>
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">دوشنبه</div><div class="font-bold">۱۶ تیر</div>
          </div>
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">سه‌شنبه</div><div class="font-bold">۱۷ تیر</div>
          </div>
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">چهارشنبه</div><div class="font-bold">۱۸ تیر</div>
          </div>
          <div class="date-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">
            <div class="text-sm">پنج‌شنبه</div><div class="font-bold">۱۹ تیر</div>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <h5 class="font-medium mb-2">ساعت</h5>
        <div class="grid grid-cols-3 gap-2">
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">۱۰:۰۰</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">۱۱:۰۰</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">۱۲:۰۰</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">۱۴:۰۰</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">۱۵:۰۰</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">۱۶:۰۰</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">۱۷:۰۰</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">۱۸:۰۰</div>
          <div class="time-option border border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:border-blue-500 bw-tap">۱۹:۰۰</div>
        </div>
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-1" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">بازگشت</button>
        <button id="next-to-step-3" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>ادامه</button>
      </div>
    </div>

    <!-- Step 3: اطلاعات تماس -->
    <div id="step-3" class="step hidden">
      <h4 class="font-bold mb-4">اطلاعات تماس</h4>

      <!-- موبایل: LTR، شروع از چپ با صفر، ارقام «لاتین» -->
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2" for="phone-number">شماره موبایل</label>
        <div class="relative">
          <!-- پیش‌شماره کشور در چپ (LTR) -->
          <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none ltr-num">
            <span class="text-gray-500 text-sm select-none">+98</span>
          </div>
<input
  type="tel" id="phone-number" inputmode="numeric" autocomplete="tel"
  class="w-full border border-gray-300 rounded-lg py-3 pr-14 pl-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
  placeholder="09123456789" maxlength="11" pattern="^0[0-9]{10}$" dir="ltr" style="font-family: 'Vazirmatn', sans-serif;">
        </div>
        <p class="text-xs text-gray-500 mt-1">فقط شماره ایران؛ با <span class="font-bold">۰</span> شروع شود.</p>
        <p id="phone-error" class="text-red-500 text-xs mt-1 hidden">شماره وارد شده معتبر نیست</p>
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium mb-2" for="customer-name">نام و نام خانوادگی</label>
        <input type="text" id="customer-name" class="w-full border border-gray-300 rounded-lg py-3 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="نام و نام خانوادگی">
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-2" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">بازگشت</button>
        <button id="next-to-step-4" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>ادامه</button>
      </div>
    </div>

    <!-- Step 4: تایید شماره (OTP) -->
    <div id="step-4" class="step hidden">
      <h4 class="font-bold mb-3">تایید شماره موبایل</h4>
      <p class="text-sm text-gray-600 mb-4">
        یک کد ۴ رقمی به شماره
        <span id="otp-phone" class="font-bold text-gray-800 ltr-num"></span>
        ارسال شد.
      </p>

      <button id="edit-phone" class="mb-4 text-blue-600 font-bold text-sm hover:text-blue-700">ویرایش شماره</button>

 <div class="flex items-center justify-center gap-2 mb-2" dir="ltr">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
  <input class="bw-otp" type="text" inputmode="numeric" maxlength="1">
</div>
      <p id="otp-error" class="text-xs text-red-500 text-center mb-2 hidden">کد تایید صحیح نیست</p>

      <div class="flex items-center justify-between mb-6">
        <div class="text-xs text-gray-500">ارسال مجدد در <span id="otp-timer" class="font-bold">۶۰</span> ثانیه</div>
        <button id="resend-otp" class="text-xs font-bold text-blue-600 disabled:text-gray-400" disabled>ارسال مجدد کد</button>
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-3-otp" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">بازگشت</button>
        <button id="verify-otp" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>تایید کد</button>
      </div>
    </div>

    <!-- Step 5: تایید نهایی -->
    <div id="step-5" class="step hidden">
      <h4 class="font-bold mb-4">تایید نوبت</h4>
      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-right items-baseline">
          <div class="text-gray-600 py-1">خدمت:</div><div id="confirm-service" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">تاریخ:</div><div id="confirm-date" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">ساعت:</div><div id="confirm-time" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">نام:</div><div id="confirm-name" class="font-bold text-right py-1"></div>
          <div class="text-gray-600 py-1">شماره تماس:</div><div id="confirm-phone" class="font-bold text-right py-1 ltr-num"></div>
          <div class="text-gray-600 mt-4 pt-4 border-t border-gray-200 py-1">مبلغ کل:</div>
          <div id="confirm-price" class="font-bold text-lg text-right mt-4 pt-4 border-t border-gray-200 py-1"></div>
        </div>
      </div>
      <div class="flex space-x-3 space-x-reverse">
        <button id="back-to-step-3" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full transition-all">بازگشت</button>
        <button id="confirm-booking" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all disabled:bg-gray-400" disabled>تایید نهایی</button>
      </div>
    </div>

    <!-- Success -->
    <div id="booking-success" class="hidden text-center py-8">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-check text-green-600 text-2xl"></i>
      </div>
      <h4 class="text-xl font-bold mb-2">نوبت شما با موفقیت ثبت شد</h4>
      <p class="text-gray-600 mb-6">کد پیگیری شما: <span class="font-bold">#۱۲۳۴۵</span></p>
      <p class="text-gray-600 mb-6">جزئیات نوبت به شماره موبایل شما ارسال خواهد شد.</p>
      <button id="close-booking" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all">بستن</button>
    </div>
  </div>

  <script>
    (() => {
      'use strict';

      // ---- helpers
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      // نگاشت کامل ارقام فارسی و عربی‌هندی به انگلیسی/برعکس
      const toEn = s => (s||'')
        .replace(/[۰-۹]/g, d => '0123456789'['۰۱۲۳۴۵۶۷۸۹'.indexOf(d)])
        .replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
      const toFa = s => (s||'').replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[parseInt(d,10)]);
      const scrollInto = el => { if(!el) return; const top = el.getBoundingClientRect().top + scrollY - 80; window.scrollTo({top,behavior:'smooth'}); };
      const genId = () => 'c_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);

      // کد مادر برای محیط توسعه (قبول «۰۰۰۰»)
      const MASTER_OTP = '0000';

      // ---- state
      const st = { step:1, customerId:null, service:null, price:0, date:null, time:null, name:'', phone:'', otp:'', otpTimer:0, otpInt:null, otpTo:'' };

      // ---- els
      const wizard = $('#booking-wizard');
      const steps = {1:$('#step-1'),2:$('#step-2'),3:$('#step-3'),4:$('#step-4'),5:$('#step-5')};
      const dots = $$('.step-dot'); const curLbl = $('#current-step'); const pbar = $('#progress-bar');

      // step1
      const svcOpts = $$('.service-option'); const next1 = $('#next-to-step-2');

      // step2
      const dateOpts = $$('.date-option'); const timeOpts = $$('.time-option');
      const back2 = $('#back-to-step-1'); const next2 = $('#next-to-step-3');

      // step3
      const nameInp = $('#customer-name'); const phoneInp = $('#phone-number');
      const phoneErr = $('#phone-error'); const back3 = $('#back-to-step-2'); const next3 = $('#next-to-step-4');

      // step4 (otp)
      const otpPhone = $('#otp-phone'); const otpInputs = () => $$('.bw-otp');
      const otpErr = $('#otp-error'); const otpTimerLbl = $('#otp-timer'); const resendBtn = $('#resend-otp');
      const editPhone = $('#edit-phone'); const back4 = $('#back-to-step-3-otp'); const verifyBtn = $('#verify-otp');

      // step5
      const back5 = $('#back-to-step-3'); const confirmBtn = $('#confirm-booking');
      const cSvc = $('#confirm-service'), cDate = $('#confirm-date'), cTime = $('#confirm-time'), cName = $('#confirm-name'), cPhone = $('#confirm-phone'), cPrice = $('#confirm-price');

      // success
      const successBox = $('#booking-success'); const closeSuccess = $('#close-booking');

      // ---- nav
      function showStep(n){
        st.step = n;
        Object.values(steps).forEach(s => s.classList.add('hidden'));
        steps[n].classList.remove('hidden');
        curLbl.textContent = n.toString();
        pbar.style.width = (n*20) + '%';
        dots.forEach(d => { const k = +d.dataset.step; d.classList.toggle('bg-blue-600', k<=n); d.classList.toggle('bg-gray-300', k>n); });
        scrollInto(wizard);
      }

      // ---- validators
      const validPhone = raw => {
        const v = toEn(raw).trim();
        return /^0\d{10}$/.test(v) && v.startsWith('09');
      };
      function chk1(){ next1.disabled = !(st.service && st.price); }
      function chk2(){ next2.disabled = !(st.date && st.time); }
      function chk3(){
        const ok = nameInp.value.trim().length >= 2 && validPhone(phoneInp.value);
        next3.disabled = !ok;
        phoneErr.classList.toggle('hidden', validPhone(phoneInp.value));
      }
      function chkOTP(){
        const code = toEn(otpInputs().map(i=>i.value).join('')).replace(/\D/g,'');
        verifyBtn.disabled = (code.length!==4);
        if (!verifyBtn.disabled) otpErr.classList.add('hidden');
      }

      // ---- step1
      svcOpts.forEach(o=>{
        o.addEventListener('click', ()=>{
          svcOpts.forEach(x=>x.classList.remove('bw-selected'));
          o.classList.add('bw-selected');
          st.service = o.dataset.service; st.price = parseInt(o.dataset.price||'0',10)||0;
          chk1();
        });
      });
      next1.addEventListener('click', ()=>showStep(2));

      // ---- step2
      function pick(list, el){ list.forEach(x=>x.classList.remove('bw-selected')); el.classList.add('bw-selected'); }
      dateOpts.forEach(el=>el.addEventListener('click', ()=>{ pick(dateOpts, el); st.date = el.innerText.trim(); chk2(); }));
      timeOpts.forEach(el=>el.addEventListener('click', ()=>{ pick(timeOpts, el); st.time = el.innerText.trim(); chk2(); }));
      back2.addEventListener('click', ()=>showStep(1));
      next2.addEventListener('click', ()=>showStep(3));

      // ---- step3
      function onStep3(){
        st.name = nameInp.value.trim();
        st.phone = toEn(phoneInp.value);
        chk3();
      }
      nameInp.addEventListener('input', onStep3);
 phoneInp.addEventListener('input', (e)=>{
  let value = e.target.value;
  // Keep Persian numbers for display
  value = value.replace(/[^\u06F0-\u06F9\u0660-\u06690-9]/g, '');
  value = value.slice(0, 11);
  e.target.value = value;
  
  // Store English version internally
  st.phone = toEn(value);
  onStep3();
});
      back3.addEventListener('click', ()=>showStep(2));
      next3.addEventListener('click', ()=>{
        if (next3.disabled) return;
        st.phone = toEn(phoneInp.value); st.name = nameInp.value.trim();

        // ارسال کد (دمو) — ۴ رقمی
        st.otp = String(Math.floor(1000 + Math.random()*9000)); // در تولید واقعی از سرور بگیر
        st.otpTo = st.phone;

        // ماسک شماره برای نمایش (0902*****7852)
        const mask = (p => {
          const v = toEn(p).replace(/\D/g,'');
          if (v.length < 8) return v;
          return v.slice(0,4) + '*****' + v.slice(-4);
        })(st.phone);
        otpPhone.textContent = mask;

        startOtpTimer();
        clearOtp();
        otpErr.classList.add('hidden');
        chkOTP();
        showStep(4);
      });

      // ---- step4 (otp)
      function clearOtp(){ otpInputs().forEach((i,idx)=>{ i.value=''; if(idx===0) i.focus(); }); }
      function startOtpTimer(){
        stopOtpTimer(); st.otpTimer = 60; resendBtn.disabled = true; updateOtpTimer();
        st.otpInt = setInterval(()=>{ st.otpTimer--; updateOtpTimer(); if(st.otpTimer<=0){ stopOtpTimer(); resendBtn.disabled=false; } }, 1000);
      }
      function stopOtpTimer(){ if(st.otpInt){ clearInterval(st.otpInt); st.otpInt=null; } }
      function updateOtpTimer(){ otpTimerLbl.textContent = st.otpTimer.toString(); }

      document.addEventListener('input', (e)=>{
        const t = e.target; if(!(t instanceof HTMLInputElement)) return;
        if(!t.classList.contains('bw-otp')) return;
        t.value = toEn(t.value).replace(/\D/g,'').slice(0,1);
        const arr = otpInputs(); const idx = arr.indexOf(t);
        if(t.value && idx < arr.length-1){ arr[idx+1].focus(); }
        chkOTP();
      });
      document.addEventListener('keydown', (e)=>{
        const t = e.target; if(!(t instanceof HTMLInputElement)) return;
        if(!t.classList.contains('bw-otp')) return;
        if(e.key==='Backspace' && !t.value){
          const arr = otpInputs(); const idx = arr.indexOf(t);
          if(idx>0) arr[idx-1].focus();
        }
      });

      // ارسال مجدد OTP (دمو)
      const resendOtp = ()=>{
        st.otp = String(Math.floor(1000 + Math.random()*9000));
        startOtpTimer();
      };
      resendBtn.addEventListener('click', ()=>{ if(!resendBtn.disabled) resendOtp(); });

      // ذخیره مشتری با customerId ثابت
      function persistCustomer(){
        const existing = localStorage.getItem('customerId');
        const cid = st.customerId || existing || genId();
        st.customerId = cid;
        localStorage.setItem('customerId', cid);
        localStorage.setItem('customerName', st.name);
        localStorage.setItem('customerPhone', st.phone);
        // اینجا می‌تونی به سرور هم sync کنی
        // fetch('/api/customers/upsert', {method:'POST', body:JSON.stringify({id:cid,name:st.name,phone:st.phone})})
      }

      // تایید OTP
      verifyBtn.addEventListener('click', ()=>{
        const code = toEn(otpInputs().map(i=>i.value.trim()).join('')).replace(/\D/g,'');
        if (code.length !== 4) { otpErr.classList.remove('hidden'); return; }
        if (code !== st.otp && code !== MASTER_OTP) { otpErr.classList.remove('hidden'); return; }
        stopOtpTimer();
        persistCustomer();

        const auth = { id: st.customerId, name: st.name, phone: st.phone };
localStorage.setItem('auth_user', JSON.stringify(auth)); // Loyalty همینو می‌خونه
window.__APP_USER__ = auth; // اگه جایی از window استفاده می‌کنی

// اختیاری: به Loyalty خبر بده UI رو رفرش کنه
document.dispatchEvent(new Event('auth:changed'));
        fillConfirm();
        showStep(5);
        confirmBtn.disabled = false; // فقط بعد از تایید OTP
      });

      editPhone.addEventListener('click', ()=>showStep(3));
      back4.addEventListener('click',  ()=>showStep(3));

      // ---- step5 (confirm)
      function fillConfirm(){
        cSvc.textContent = st.service || '';
        cDate.textContent= st.date   || '';
        cTime.textContent= st.time   || '';
        cName.textContent= st.name   || '';
        cPhone.textContent= st.phone || '';
        cPrice.textContent= (st.price? st.price.toLocaleString('fa-IR'):'۰') + ' تومان';
      }

      back5.addEventListener('click', ()=>showStep(3));
confirmBtn.addEventListener('click', () => {
  // جلوگیری از کلیک دوباره
  if (confirmBtn.disabled) return;
  confirmBtn.disabled = true;

  // ارسال نهایی رزرو به همراه customerId ثابت (دمو/اختیاری)
  const payload = {
    customerId: st.customerId,
    name:   st.name,
    phone:  st.phone,
    service:st.service,
    date:   st.date,
    time:   st.time,
    price:  st.price
  };
  // اگر بک‌اند داری این رو باز کن:
  // fetch('/api/bookings', {
  //   method:'POST',
  //   headers:{'Content-Type':'application/json'},
  //   body: JSON.stringify(payload)
  // });

  // پرکردن داده‌های مودال «در انتظار تایید»
  const maskPhone = (p => {
    const v = (p || '').replace(/\D/g,'');
    if (v.length < 8) return v;
    return v.slice(0,4) + '*****' + v.slice(-4);
  })(st.phone);

  const pbService = document.getElementById('pb-service');
  const pbDate    = document.getElementById('pb-date');
  const pbTime    = document.getElementById('pb-time');
  const pbPhone   = document.getElementById('pb-phone');

  if (pbService) pbService.textContent = st.service || '';
  if (pbDate)    pbDate.textContent    = st.date    || '';
  if (pbTime)    pbTime.textContent    = st.time    || '';
  if (pbPhone)   pbPhone.textContent   = maskPhone;

  // 🔒 ذخیره رزرو «در انتظار تایید» برای گیت رزرو
  try {
    const pending = {
      id:       (typeof genId === 'function' ? genId() : ('b_' + Date.now())),
      status:   'pending',
      service:  st.service,
      date:     st.date,
      time:     st.time,
      phone:    st.phone,
      createdAt: Date.now()
    };

    if (window.__BOOKING_GUARD__?.saveLast) {
      window.__BOOKING_GUARD__.saveLast(pending);
    } else {
      // fallback
      localStorage.setItem('vt:lastBooking', JSON.stringify(pending));
    }

    // (اختیاری) اعلام یک ایونت برای سایر بخش‌ها
    document.dispatchEvent(new CustomEvent('booking:pending', { detail: pending }));
  } catch (e) {
    // نذار UI خراب شه
    console.warn('save pending booking failed', e);
  }

  // نمایش فقط مودال «در انتظار تایید»
  if (typeof window.openModalById === 'function') {
    window.openModalById('pendingBookingModal');
  } else {
    Object.values(steps).forEach(s => s.classList.add('hidden'));
    successBox.classList.remove('hidden');
    scrollInto(successBox);
  }

  // ریست انتخاب‌ها برای رزرو بعدی
  try {
    ['service','date','time'].forEach(k => st[k] = null);
    svcOpts.forEach(x => x.classList.remove('bw-selected'));
    dateOpts.forEach(x => x.classList.remove('bw-selected'));
    timeOpts.forEach(x => x.classList.remove('bw-selected'));

    next1.disabled = true;
    next2.disabled = true;
    // دکمه تایید تا وقتی دوباره مراحل طی نشن غیرفعال می‌مونه
    confirmBtn.disabled = true;

    showStep(1);
  } catch (e) {
    console.warn('reset wizard failed', e);
  }
});



      closeSuccess.addEventListener('click', ()=>{
        successBox.classList.add('hidden');
        showStep(1);
      });

      // ---- init: پر کردن خودکار از localStorage (بدون تغییر customerId)
      const saved = {
        cid: localStorage.getItem('customerId'),
        name: localStorage.getItem('customerName'),
        phone: localStorage.getItem('customerPhone')
      };
      if (saved.cid) st.customerId = saved.cid;
      if (saved.name) nameInp.value = saved.name;
      if (saved.phone) phoneInp.value = saved.phone; // نمایش لاتین
      // ولیدیشن اولیه
      (function initButtons(){
        next1.disabled = true; next2.disabled = true; next3.disabled = true; confirmBtn.disabled = true;
      })();
      onStep3(); // در صورت پر بودن فیلدها، دکمه ادامه فعال می‌شود
      showStep(1);
    })();

  </script>
</section>

<script>
// Add loading state to all submit buttons
document.addEventListener('DOMContentLoaded', function() {
  const submitButtons = document.querySelectorAll('button[type="submit"], #confirm-booking, .service-button');
  
  submitButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      if (this.disabled || this.classList.contains('loading')) return;
      
      // Store original content
      const originalContent = this.innerHTML;
      
      // Add loading state
      this.classList.add('loading');
      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>در حال پردازش...';
      
      // Remove loading state after operation (adjust timing based on your needs)
      setTimeout(() => {
        this.classList.remove('loading');
        this.disabled = false;
        this.innerHTML = originalContent;
      }, 2000);
    });
  });
});
</script>




    <!-- Customer Reviews -->


<!-- Loyalty Rewards Card Component -->

<!-- ============ Loyalty Rewards (Vitreenet) ============ -->
<section id="loyalty-card" class="w-full py-8 px-4 sm:px-5" dir="rtl">
  <!-- پیکربندی -->
<div id="lr-data"
     data-current="0"
     data-target="10"
     data-reward=""
     data-booking-url=""
     data-login-url="/login"
     data-rules=""></div>

  <div class="mx-auto relative max-w-[680px] md:max-w-[720px]">
    <!-- پس‌زمینه گرادیان ساده -->
    <div class="absolute inset-0 -z-10 rounded-3xl bg-gradient-to-r from-purple-500/10 via-pink-500/10 to-blue-500/10 blur-2xl"></div>

    <!-- قاب با گرادیان -->
    <div class="group relative rounded-3xl p-[2px] bg-gradient-to-r from-purple-500 via-pink-500 to-blue-500 transition-shadow duration-300 hover:shadow-xl">
      
      <!-- MEMBER CLUB badge -->
      <div class="absolute -top-3 right-4 z-20 select-none">
        <span class="inline-flex rounded-full p-[1.5px] bg-gradient-to-r from-purple-500 to-pink-500 shadow-md">
          <span dir="ltr"
                class="relative inline-flex items-center rounded-full
                       px-4 py-1.5 text-[10px] sm:text-[11px]
                       font-extrabold uppercase tracking-[0.18em]
                       text-white bg-gradient-to-r from-purple-600 to-pink-600">
            <span class="relative z-10">VIP MEMBER</span>
          </span>
        </span>
      </div>

      <!-- کارت اصلی -->
      <div class="rounded-3xl bg-white/95 backdrop-blur-sm p-6 sm:p-7 pt-14 shadow-lg relative overflow-hidden">

        <!-- عنوان و چیپ قانون -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2.5 sm:gap-3 mb-5">
          <h2 class="text-[20px] sm:text-[22px] md:text-2xl font-black bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">باشگاه مشتریان ویژه</h2>
          <div class="min-w-0 text-[12px] sm:text-[13px] font-semibold px-3.5 py-2 rounded-full bg-gradient-to-r from-purple-100 to-pink-100 text-purple-800 border border-purple-200 shadow-sm max-w-[78vw] sm:max-w-none truncate">
            هر <span id="reward-target" class="font-bold">۱۰</span> نوبت، <span id="reward-text" class="font-bold">یک اصلاح رایگان</span>
          </div>
        </div>

        <!-- متن مرحله‌ای -->
        <div class="text-center max-w-[48ch] mx-auto mb-4">
          <h3 id="lr-headline" class="text-[16px] sm:text-[18px] font-extrabold text-gray-800 tracking-[0.01em]"></h3>
          <p id="lr-sub" class="text-[12px] text-gray-600 mt-1"></p>
        </div>

        <!-- متریک‌ها -->
        <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-6">
          <div class="relative group">
            <div class="absolute inset-0 bg-gradient-to-br from-green-400/20 to-emerald-500/20 rounded-xl blur-sm"></div>
            <div class="relative rounded-xl bg-white border border-green-200 px-4 py-3 text-center shadow-sm">
              <div class="text-[10px] sm:text-[11px] text-gray-600 font-medium mb-1">انجام شده</div>
              <div id="lr-m-current" class="text-[18px] sm:text-[20px] font-bold text-green-600">۰</div>
            </div>
          </div>
          <div class="relative group">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-400/20 to-cyan-500/20 rounded-xl blur-sm"></div>
            <div class="relative rounded-xl bg-white border border-blue-200 px-4 py-3 text-center shadow-sm">
              <div class="text-[10px] sm:text-[11px] text-gray-600 font-medium mb-1">تا جایزه</div>
              <div id="lr-m-left" class="text-[18px] sm:text-[20px] font-bold text-blue-600">۰</div>
            </div>
          </div>
        </div>

        <!-- نوار پیشرفت -->
        <div class="mb-4">
          <div class="relative h-[12px] sm:h-[14px] rounded-full bg-gray-100 shadow-inner overflow-hidden">
            <div class="absolute inset-0 opacity-30 bg-[repeating-linear-gradient(to_right,transparent,transparent_9.5%,rgba(0,0,0,0.1)_9.5%,rgba(0,0,0,0.1)_10.5%)]"></div>
            <div id="lr-bar" class="relative h-full w-0 rounded-full transition-all duration-500 ease-out"
                 style="background: linear-gradient(90deg, #8B5CF6, #EC4899, #3B82F6);">
              <div class="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow border-2 border-purple-500"></div>
            </div>
          </div>
          <div class="mt-2 text-[12px] sm:text-sm font-medium text-gray-700 flex justify-between items-center">
            <span id="lr-counts" class="font-bold">۰ از ۰</span>
            <span class="text-[11px] text-gray-500">در حال پیشرفت</span>
          </div>
        </div>

        <!-- راهنما -->
        <p id="lr-helper" class="text-center text-[12px] sm:text-[13px] text-gray-600 mb-6 font-medium"></p>

        <!-- دکمه‌ها -->
        <div class="flex flex-col sm:flex-row justify-center gap-2.5 sm:gap-3">
          <button id="lr-cta" class="relative group w-full sm:w-auto rounded-full px-6 py-3.5 text-[14px] font-bold
                  text-white shadow-lg overflow-hidden transform transition-all duration-200 hover:shadow-xl active:scale-[0.98]">
            <div class="absolute inset-0 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600"></div>
            <span class="relative z-10 flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
              </svg>
              <span id="lr-cta-label">رزرو بعدی</span>
            </span>
          </button>

          <button id="lr-rules" class="relative group w-full sm:w-auto rounded-full px-6 py-3.5 text-[14px] font-bold
                  bg-white text-purple-700 shadow overflow-hidden border-2 border-purple-300 hover:border-purple-400 transform transition-all duration-200 hover:shadow-md active:scale-[0.98]">
            <div class="absolute inset-0 bg-gradient-to-r from-purple-50 to-pink-50 opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
            <span class="relative z-10 flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
              قوانین
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- استیکی موبایل -->
  <div id="lr-sticky" class="fixed inset-x-0 bottom-0 z-40 sm:hidden pointer-events-none transition-all duration-200 transform translate-y-0">
    <div class="pointer-events-auto mx-auto max-w-2xl px-3">
      <div class="rounded-t-2xl bg-white/95 backdrop-blur shadow-xl p-4 pb-[max(16px,env(safe-area-inset-bottom))] border-t border-x border-gray-200">
        <div class="absolute top-2 left-1/2 -translate-x-1/2 w-10 h-1 bg-gray-300 rounded-full"></div>
        <div class="flex items-center justify-between gap-3 mt-1">
          <div class="min-w-0 flex-1">
            <div id="lr-sticky-label" class="text-[11px] text-gray-500 font-medium mb-1">باشگاه ویژه</div>
            <div class="flex items-center gap-3">
              <div id="lr-sticky-progress" class="text-[14px] font-bold text-purple-700" aria-live="polite">۰ از ۰</div>
              <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                <div id="lr-sticky-bar" class="h-full w-0 transition-all duration-500 ease-out bg-gradient-to-r from-purple-600 to-pink-600"></div>
              </div>
            </div>
          </div>
          <button id="lr-cta-mobile" class="rounded-full px-5 py-3 text-[13px] font-bold text-white shadow-lg transform transition-all duration-200 active:scale-[0.98] bg-gradient-to-r from-purple-600 to-pink-600">
            <span class="flex items-center gap-1.5">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 1.414L10.586 9.5H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"/>
              </svg>
              <span id="lr-cta-mobile-label">رزرو</span>
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Rules Modal -->
<div id="lrRulesModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-close></div>
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="modal-card relative w-full max-w-md transform transition-all duration-200 scale-95 opacity-0">
      <div class="bg-white rounded-2xl shadow-2xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">قوانین باشگاه مشتریان</h3>
          <button class="p-2 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors duration-200" data-close aria-label="بستن">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="bg-gray-50 rounded-xl p-4 mb-5">
          <div id="lr-rules-content" class="text-gray-700 text-sm whitespace-pre-line leading-7 max-h-64 overflow-y-auto"></div>
        </div>
        <button class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-3 rounded-full shadow-lg transition-all duration-200 active:scale-[0.98]" data-close>متوجه شدم</button>
      </div>
    </div>
  </div>
</div>

<!-- Redeem Modal -->
<div id="lrRedeemModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-close></div>
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="modal-card relative w-full max-w-md transform transition-all duration-200 scale-95 opacity-0">
      <div class="bg-white rounded-2xl shadow-2xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">دریافت جایزه</h3>
        <button class="p-2 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors duration-200" data-close aria-label="بستن">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <div id="lr-redeem-body">
          <div class="text-center mb-5">
            <div class="inline-flex p-4 rounded-full bg-gradient-to-br from-purple-100 to-pink-100 mb-3">
              <svg class="w-10 h-10 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
            </div>
            <p class="text-gray-700 mb-2">به <span id="lr-reward-inline" class="font-bold text-purple-700">یک اصلاح رایگان</span> رسیدی</p>
            <p class="text-sm text-gray-500">آماده دریافت جایزه‌ای؟</p>
          </div>
          
          <div class="rounded-xl bg-gray-50 border border-gray-200 p-4 mb-5">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">وضعیت فعلی</span>
              <span id="lr-redeem-counts" class="font-bold text-purple-700">۰ از ۰</span>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-full transition-colors duration-200 active:scale-[0.98]" data-close>فعلاً نه</button>
            <button id="lr-redeem-confirm" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-3 rounded-full shadow-lg transition-all duration-200 active:scale-[0.98]">
              <span class="flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                دریافت جایزه
              </span>
            </button>
          </div>
        </div>

        <div id="lr-redeem-done" class="hidden text-center py-8">
          <div class="inline-flex p-4 rounded-full bg-gradient-to-br from-green-100 to-emerald-100 mb-4">
            <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <p class="text-xl font-bold text-green-600 mb-2">جایزه ثبت شد</p>
          <p class="text-gray-600">در رزرو بعدی استفاده می‌شه</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  'use strict';

  // ------- KEYS & HELPERS -------
  const KEY_PROGRESS = 'vitreenet_loyalty_current';   // پیشرفت فعلی تا جایزه (برای مهمان هم نگه نمی‌داریم)
  const KEY_TOTAL    = 'vitreenet_booking_total';     // تعداد کل رزروها (تشخیص «اولین نوبت»)
  const AUTH_LS_KEY  = 'auth_user';                   // فقط حالت تست/دِمو

  const toFa = n => String(n).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
  const reduce = () => window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function toast(msg, type = 'info') {
    showToastDark(msg, {type});
  }

  // ------- ADAPTERS (قابل تعویض با بک‌اند) -------
  const adapters = {
    async getAuth() {
      if (window.__APP_USER__ && window.__APP_USER__.id) return { loggedIn: true, user: window.__APP_USER__ };
      try { const raw = localStorage.getItem(AUTH_LS_KEY); if (raw) return { loggedIn: true, user: JSON.parse(raw) }; } catch(e) {}
      return { loggedIn: false, user: null };
    },
    async getBookingSummary(userId) {
      if (window.__BOOKING_SUMMARY__ && typeof window.__BOOKING_SUMMARY__.total === 'number') {
        return { total: window.__BOOKING_SUMMARY__.total };
      }
      const total = parseInt(localStorage.getItem(KEY_TOTAL) || '0', 10) || 0;
      return { total };
    }
  };

  // ------- MODAL -------
  function openModal(root) {
    root.classList.remove('hidden');
    const card = root.querySelector('.modal-card');
    requestAnimationFrame(() => { card.classList.remove('scale-95','opacity-0'); card.classList.add('scale-100','opacity-100'); });
  }
  function closeModal(root) {
    const card = root.querySelector('.modal-card');
    card.classList.add('scale-95','opacity-0'); card.classList.remove('scale-100','opacity-100');
    setTimeout(() => root.classList.add('hidden'), reduce()?0:200);
  }

  // ------- COPY (صمیمی/متعادل) -------
// ------- COPY (صمیمی/متعادل، بدون شعار) -------
function copyFor(progress, current, target, reward) {
  const left = Math.max(0, target - current);
  const pick = (arr) => arr[(current + left) % arr.length]; // چرخشی ساده

  if (current >= target) {
    return pick([
      { h: 'جایزه‌ت آماده‌ست 🎁',   sub: 'بزن بگیریمش.',            help: 'روی رزرو بعدی اعمالش می‌کنیم.', cta: 'دریافت جایزه' },
      { h: 'حله! رسیدی به جایزه',   sub: 'فقط فعالش کنیم و تمام.',  help: 'تو رزرو بعدی استفاده میشه.',    cta: 'دریافت جایزه' },
      { h: 'به هدف خوردی ✨',       sub: 'وقتِ نقد کردنشه.',         help: 'بعدی که رزرو کنی می‌افته.',      cta: 'دریافت جایزه' },
    ]);
  }

  if (current * 2 === target) {
    return pick([
      { h: 'نصفش رفت ✅',           sub: 'چند تا دیگه مونده.',       help: `${left} نوبت مونده.` ,           cta: 'رزرو بعدی' },
      { h: 'نصف راهی! 👌',          sub: 'با همین فرمون برو.',       help: `${left} نوبت مونده.`,            cta: 'رزرو بعدی' },
    ]);
  }

  if (progress >= 90) {
    return pick([
      { h: 'یه قدم تا جایزه',       sub: 'همین یکی دیگه.',           help: left <= 1 ? 'با نوبت بعدی می‌رسی.' : `${left} نوبت مونده.`, cta: 'رزرو بعدی' },
      { h: 'تقریباً رسیدی ⏳',      sub: 'کم مونده، بزن بریم.',      help: left <= 1 ? 'نوبت بعدی کافیه.'    : `${left} نوبت مونده.`, cta: 'رزرو بعدی' },
    ]);
  }

  if (progress >= 60) {
    return pick([
      { h: 'خوب داری میری 🚀',       sub: 'همینو نگه دار.',           help: `${left} نوبت تا جایزه.`,         cta: 'رزرو بعدی' },
      { h: 'مسیر رو گرفتی',         sub: 'یکی‌یکی جلو برو.',         help: `${left} نوبت تا جایزه.`,         cta: 'رزرو بعدی' },
    ]);
  }

  if (current > 0) {
    return pick([
      { h: 'شروع خوبی زدی',         sub: 'نذار فاصله بیفته.',        help: `${left} نوبت مونده.`,            cta: 'رزرو بعدی' },
      { h: 'اوله راهی ولی رو غلتکی',sub: 'قدم بعدی رو بردار.',       help: `${left} نوبت مونده.`,            cta: 'رزرو بعدی' },
    ]);
  }

  // کاربر تازه/هیچ رزروی نداشته
  return pick([
    { h: 'به باشگاه خوش اومدی 👋', sub: 'اولین نوبت رو بگیر و بریم.', help: `با ${target} نوبت، ${reward}.`, cta: 'رزرو اولین نوبت' },
    { h: 'از همین‌جا شروع کن',     sub: 'اولین رزرو = یه قدم جلو.',   help: `با ${target} نوبت، ${reward}.`, cta: 'رزرو اولین نوبت' },
  ]);
}


  // ------- AUTH / HISTORY -------
  let AUTH = { loggedIn: false, user: null };
  let HAS_BOOKED_BEFORE = false;

  function chooseCtaText(current, target) {
    if (current >= target) return 'دریافت جایزه';
    return HAS_BOOKED_BEFORE ? 'رزرو بعدی' : 'رزرو اولین نوبت';
  }

  function applyCtaText(text) {
    const l1 = document.getElementById('lr-cta-label');
    if (l1) l1.textContent = text;
    const l2 = document.getElementById('lr-cta-mobile-label');
    if (l2) l2.textContent = (text === 'دریافت جایزه') ? 'دریافت' : (text === 'رزرو اولین نوبت' ? 'شروع' : 'رزرو');
  }

  function updateSticky(current, target) {
    const pct = Math.min(100, Math.max(0, (current/target)*100));
    const stickyTxt = document.getElementById('lr-sticky-progress');
    const bar = document.getElementById('lr-sticky-bar');
    if (stickyTxt) stickyTxt.textContent = `${toFa(current)} از ${toFa(target)}`;
    if (bar) bar.style.width = pct + '%';
  }

  function redirectToLogin() {
    const data = document.getElementById('lr-data');
    const loginUrl = data.dataset.loginUrl || '/login';
    const redirect = encodeURIComponent(window.location.href);
    window.location.href = `${loginUrl}?redirect=${redirect}`;
  }

  function requireLogin() {
    toast('اول یه ورود کوچیک لازم داریم؛ سریع برمی‌گردیم همین‌جا 🙂');
    setTimeout(redirectToLogin, 900);
  }

  // ------- INIT CARD -------
  function initCard() {
    const data = document.getElementById('lr-data');
    const target = parseInt(data.dataset.target || '10', 10);
    const reward = data.dataset.reward || '';

    // مقدار خام (ممکنه از سرور یا لوکال بیاد)
    const raw = parseInt(localStorage.getItem(KEY_PROGRESS) ?? data.dataset.current ?? '0', 10) || 0;

    // ✳️ منطق جدید: اگر لاگین نیست یا هرگز رزرو نکرده ⇒ صفرِ واقعی نمایش داده می‌شود
    const current = (!AUTH.loggedIn || !HAS_BOOKED_BEFORE) ? 0 : raw;

    document.getElementById('reward-target').textContent = toFa(target);
    document.getElementById('reward-text').textContent   = reward;

    const pct = Math.min(100, Math.max(0, Math.round((current/target)*100)));
    const {h, sub, help} = copyFor(pct, current, target, reward);

    document.getElementById('lr-headline').textContent = h;
    document.getElementById('lr-sub').textContent      = sub;
    document.getElementById('lr-helper').textContent   = help;

    document.getElementById('lr-counts').textContent   = `${toFa(current)} از ${toFa(target)}`;
    document.getElementById('lr-bar').style.width      = pct + '%';

    const left = Math.max(0, target - current);
    const mCur = document.getElementById('lr-m-current');
    const mLeft = document.getElementById('lr-m-left');
    if (mCur)  mCur.textContent  = toFa(current);
    if (mLeft) mLeft.textContent = toFa(left);

    const ri = document.getElementById('lr-reward-inline');
    if (ri) ri.textContent = reward;
    const rc = document.getElementById('lr-redeem-counts');
    if (rc) rc.textContent = `${toFa(current)} از ${toFa(target)}`;

    applyCtaText(chooseCtaText(current, target));
    updateSticky(current, target);

    // این مقدار برای هندلرها استفاده می‌شود
    data.dataset.current = String(current);
  }

  // ------- EVENTS -------
  function bindEvents() {
    const data = document.getElementById('lr-data');

    document.getElementById('lr-rules')?.addEventListener('click', () => {
      document.getElementById('lr-rules-content').textContent = data.dataset.rules || '';
      openModal(document.getElementById('lrRulesModal'));
    });

    document.querySelectorAll('#lrRulesModal [data-close], #lrRedeemModal [data-close]').forEach(b=>{
      b.addEventListener('click', e => closeModal(e.target.closest('[role="dialog"]')));
    });
    ['lrRulesModal','lrRedeemModal'].forEach(id=>{
      const m = document.getElementById(id);
      if (m) m.addEventListener('click', e => { if (e.target.hasAttribute('data-close')) closeModal(m); });
    });
    document.addEventListener('keydown', e => {
      if (e.key==='Escape') ['lrRulesModal','lrRedeemModal'].forEach(id=>{
        const m=document.getElementById(id); if(m && !m.classList.contains('hidden')) closeModal(m);
      });
    });

   // --- REPLACE goCTA inside bindEvents() in the Loyalty Rewards script ---
async function goCTA() {
  const data = document.getElementById('lr-data');
  if (!data) return;

  const target  = parseInt(data.dataset.target  || '10', 10);
  const current = parseInt(data.dataset.current || '0', 10);

  // اگر کاربر لاگین نیست ولی CTA «رزرو اولین نوبت» است، مستقیم برو به ویزارد
  const ctaText    = document.getElementById('lr-cta-label')?.textContent?.trim();
  const isFirstCTA = (ctaText === 'رزرو اولین نوبت') || (!AUTH.loggedIn && !HAS_BOOKED_BEFORE);

  // برای CTAهای دیگر (مثل «رزرو بعدی» یا «دریافت جایزه») همچنان لاگین لازم است
  if (!AUTH.loggedIn && !isFirstCTA) {
    requireLogin();
    return;
  }

  // اگر به حدّ جایزه رسیدی و لاگین هستی → مودال دریافت جایزه
  if (current >= target && AUTH.loggedIn) {
    openModal(document.getElementById('lrRedeemModal'));
    return;
  }

  // ===== قفل رزرو: اگر نوبت قبلی هنوز تایید نشده، اجازه ورود به ویزارد نده
  const lsHasPending = () => {
    try {
      const b = JSON.parse(localStorage.getItem('vt:lastBooking') || 'null');
      return !!(b && b.status === 'pending');
    } catch(e){ return false; }
  };
  const hasPending =
    typeof window.hasPendingBooking === 'function'
      ? window.hasPendingBooking()
      : lsHasPending();

  if (hasPending) {
    // اگر مودال بلاکِ اختصاصی داری
    if (typeof window.openModalById === 'function' && document.getElementById('pendingBlockModal')) {
      window.openModalById('pendingBlockModal');
    } else if (typeof window.showToastDark === 'function') {
      showToastDark('نوبت قبلی‌ت هنوز تایید نشده. لطفاً صبر کنی تا تأیید بشه ✋', { type: 'info' });
    } else {
      alert('نوبت قبلی هنوز تایید نشده است.');
    }
    return;
  }
  // ===== /قفل رزرو

  // باز کردن و اسکرول به ویزارد رزرو
  if (typeof window.openBookingWizard === 'function') {
    window.openBookingWizard();
    return;
  }

  const ids = ['booking-wizard', 'booking', 'reserve', 'reservation'];
  let el = null;
  for (const id of ids) { const t = document.getElementById(id); if (t) { el = t; break; } }
  if (el) {
    if (el.classList.contains('hidden')) el.classList.remove('hidden');
    const top = el.getBoundingClientRect().top + window.scrollY - 80;
    (reduce() ? window.scrollTo(0, top) : window.scrollTo({ top, behavior:'smooth' }));
  } else {
    const url = data.dataset.bookingUrl;
    if (url) window.location.href = url; else toast('بخش رزرو هنوز بالا نیومده');
  }
}


    document.getElementById('lr-cta')?.addEventListener('click', goCTA);
    document.getElementById('lr-cta-mobile')?.addEventListener('click', goCTA);

    // تأیید دریافت جایزه -> ریست پیشرفت (نیازمند ورود)
    document.getElementById('lr-redeem-confirm')?.addEventListener('click', () => {
      if (!AUTH.loggedIn) { requireLogin(); return; }
      document.getElementById('lr-redeem-body').classList.add('hidden');
      document.getElementById('lr-redeem-done').classList.remove('hidden');
      setTimeout(() => {
        localStorage.setItem(KEY_PROGRESS, '0');
        data.dataset.current = '0';
        closeModal(document.getElementById('lrRedeemModal'));
        document.getElementById('lr-redeem-done').classList.add('hidden');
        document.getElementById('lr-redeem-body').classList.remove('hidden');
        toast('جایزه ثبت شد؛ مبارک‌ته!', 'success');
        initCard();
      }, 250);
    });

    // دکمه تایید نهایی رزرو (بیرون سکشن)
document.getElementById('confirm-booking')?.addEventListener('click', () => {
  if (!AUTH.loggedIn) { requireLogin(); return; }

  const cur    = parseInt(localStorage.getItem(KEY_PROGRESS) ?? data.dataset.current ?? '0', 10) || 0;
  const next   = cur + 1;
  const target = parseInt(data.dataset.target || '10', 10);

  // بروزرسانی پیشرفت فعلی
  localStorage.setItem(KEY_PROGRESS, String(next));

  // ثبت تاریخچه کلی برای تشخیص «رزرو داشته/نداشته»
  const total = parseInt(localStorage.getItem(KEY_TOTAL) || '0', 10) || 0;
  localStorage.setItem(KEY_TOTAL, String(total + 1));
  HAS_BOOKED_BEFORE = true;

  // فقط وقتی از زیرِ هدف رد می‌شیم، توست جایزه رو نشون بده
  if (cur < target && next >= target) {
    toast('تبریک! جایزه‌ت رسید', 'success');
  }

  setTimeout(initCard, 300);
});


    // مخفی‌کردن استیکی وقتی CTA داخل ویو
    const stickyWrap = document.getElementById('lr-sticky');
    const cta = document.getElementById('lr-cta');
    if (stickyWrap && cta && 'IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          stickyWrap.style.transform = entry.isIntersecting ? 'translateY(100%)' : 'translateY(0)';
        });
      }, { threshold: 0.5 });
      io.observe(cta);
    }
  }

  // ------- BOOTSTRAP -------
async function initAuthAndHistory() {
  AUTH = await adapters.getAuth();
  const sum = await adapters.getBookingSummary(AUTH.user?.id);
  HAS_BOOKED_BEFORE = (sum?.total || 0) > 0;

  // بعد از تعیین وضعیت، کل UI بر اساس قوانین جدید رفرش می‌شود
  initCard();
}

// ✅ با هر تغییر لاگین/کاربر، کارت دوباره محاسبه می‌شود
document.addEventListener('auth:changed', initAuthAndHistory);

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => { bindEvents(); initAuthAndHistory(); });
} else {
  bindEvents(); 
  initAuthAndHistory();
}
})();

</script>
<!-- ========== /Loyalty Rewards ========== -->










    
   <!-- Customer Reviews Section - Complete with Review Form -->
<section class="py-8 px-4">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
        <div>
            <h3 class="text-xl font-bold mb-1">نظرات کاربران</h3>
            <div class="flex items-center gap-2">
                <div class="flex items-center">
                    <i class="fas fa-star text-yellow-400 text-sm"></i>
                    <i class="fas fa-star text-yellow-400 text-sm"></i>
                    <i class="fas fa-star text-yellow-400 text-sm"></i>
                    <i class="fas fa-star text-yellow-400 text-sm"></i>
                    <i class="fas fa-star-half-alt text-yellow-400 text-sm"></i>
                </div>
                <span class="text-sm font-bold text-gray-700">4.8</span>
                <span class="text-sm text-gray-500">(128 نظر)</span>


                <button id="rate-now-chip" type="button"
  class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full
         bg-gradient-to-r from-blue-600 to-teal-500 text-white
         text-[11px] sm:text-xs md:text-sm font-bold shadow-sm
         hover:shadow-md active:scale-95 focus:outline-none
         focus-visible:ring-2 focus-visible:ring-blue-500">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
       class="w-4 h-4" fill="currentColor" aria-hidden="true">
    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
  </svg>
  <span class="hidden xs:inline sm:inline">ثبت امتیاز</span>
  <span class="sm:hidden"> ثبت امتیاز</span>
</button>

            </div>
        </div>
        
        <!-- Buttons Container -->
        <div class="flex items-center gap-2 w-full sm:w-auto">
            <!-- Write Review Button -->
            <button id="write-review-btn" class="flex-1 sm:flex-initial flex items-center justify-center gap-2 px-4 py-2.5 bg-gradient-to-r from-blue-600 to-teal-500 text-white rounded-full text-sm font-bold hover:shadow-lg transform hover:scale-105 transition-all">
                <i class="fas fa-pen text-xs"></i>
                <span>ثبت نظر</span>
            </button>
            
            <!-- Show All Reviews Button -->
            <button id="show-all-reviews" class="flex-1 sm:flex-initial flex items-center justify-center gap-2 px-4 py-2.5 bg-white border border-gray-200 rounded-full text-sm font-bold text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm">
                <span>مشاهده همه</span>
                <i class="fas fa-arrow-left text-xs"></i>
            </button>
        </div>
    </div>
    
    <!-- Reviews Carousel -->
    <div class="scroll-container flex overflow-x-auto pb-4 space-x-4 space-x-reverse scrollbar-hide">
        <!-- Review Card 1 -->
    <div id="reviews-container" class="scroll-container flex overflow-x-auto pb-4 space-x-4 space-x-reverse scrollbar-hide"></div>
        
        <!-- Review Card 2 -->
        <div class="review-card flex-shrink-0 w-80 bg-white rounded-2xl shadow-sm hover:shadow-md transition-shadow border border-gray-100 p-5">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h4 class="font-bold text-gray-900 mb-1">محمد حسینی</h4>
                    <div class="flex items-center gap-1">
                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                        <i class="far fa-star text-gray-300 text-xs"></i>
                    </div>
                </div>
                <span class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-full">۱ هفته پیش</span>
            </div>
            <p class="text-sm text-gray-700 leading-6">کیفیت خدمات عالی بود و قیمت‌ها هم منصفانه. فقط کمی شلوغ بود و مجبور شدم منتظر بمانم.</p>
        </div>
        
        <!-- Review Card 3 -->
        <div class="review-card flex-shrink-0 w-80 bg-white rounded-2xl shadow-sm hover:shadow-md transition-shadow border border-gray-100 p-5">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h4 class="font-bold text-gray-900 mb-1">رضا اکبری</h4>
                    <div class="flex items-center gap-1">
                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                    </div>
                </div>
                <span class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-full">۲ هفته پیش</span>
            </div>
            <p class="text-sm text-gray-700 leading-6">بهترین آرایشگاهی که تا حالا رفتم! آقای احمدی واقعاً حرفه‌ای هستند و دقیقاً می‌دونن چه مدلی به صورتم میاد.</p>
        </div>
    </div>
</section>

<!-- Reviews Modal -->
<div id="reviewsModal" class="fixed inset-0 z-[120] hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300" id="reviews-backdrop"></div>
    
    <!-- Modal Container -->
    <div class="flex items-end sm:items-center justify-center min-h-full p-0 sm:p-4">
        <div id="reviews-modal-content" class="relative bg-white w-full sm:max-w-2xl md:max-w-3xl lg:max-w-4xl 
                                                  rounded-t-3xl sm:rounded-2xl shadow-2xl transform transition-all duration-300 
                                                  translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0
                                                  max-h-[90vh] sm:max-h-[85vh] flex flex-col">
            
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white rounded-t-3xl sm:rounded-t-2xl border-b border-gray-100 px-6 py-5 z-10">
                <!-- Drag Handle for Mobile -->
                <div class="sm:hidden w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">نظرات کاربران</h3>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-star text-yellow-400"></i>
                                <span class="font-bold text-gray-800">4.8</span>
                            </div>
                            <span class="text-sm text-gray-500">بر اساس 128 نظر</span>
                            
                            <!-- Filter Chips -->
                            <div class="hidden sm:flex items-center gap-2 mr-4">
                                <button class="review-filter-chip active" data-filter="all">همه</button>
                                <button class="review-filter-chip" data-filter="5">5 ستاره</button>
                                <button class="review-filter-chip" data-filter="4">4 ستاره</button>
                                <button class="review-filter-chip" data-filter="3">3 ستاره</button>
                            </div>
                        </div>
                    </div>
                    
                    <button id="close-reviews-modal" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 
                                                            flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
                
                <!-- Mobile Filter Chips -->
                <div class="sm:hidden flex items-center gap-2 mt-3 overflow-x-auto scrollbar-hide">
                    <button class="review-filter-chip active" data-filter="all">همه</button>
                    <button class="review-filter-chip" data-filter="5">5 ستاره</button>
                    <button class="review-filter-chip" data-filter="4">4 ستاره</button>
                    <button class="review-filter-chip" data-filter="3">3 ستاره</button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto px-6 py-4">
                <!-- Rating Summary -->
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-5 mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="text-center sm:text-right">
                            <div class="text-4xl font-bold text-gray-900 mb-1">4.8</div>
                            <div class="flex items-center justify-center sm:justify-start gap-1 mb-2">
                                <i class="fas fa-star text-yellow-400"></i>
                                <i class="fas fa-star text-yellow-400"></i>
                                <i class="fas fa-star text-yellow-400"></i>
                                <i class="fas fa-star text-yellow-400"></i>
                                <i class="fas fa-star-half-alt text-yellow-400"></i>
                            </div>
                            <div class="text-sm text-gray-600">128 نظر ثبت شده</div>
                        </div>
                        
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600 w-12">5 ستاره</span>
                                <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-400 rounded-full" style="width: 75%"></div>
                                </div>
                                <span class="text-xs text-gray-600 w-8">96</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600 w-12">4 ستاره</span>
                                <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-400 rounded-full" style="width: 15%"></div>
                                </div>
                                <span class="text-xs text-gray-600 w-8">19</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600 w-12">3 ستاره</span>
                                <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-400 rounded-full" style="width: 7%"></div>
                                </div>
                                <span class="text-xs text-gray-600 w-8">9</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600 w-12">2 ستاره</span>
                                <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-400 rounded-full" style="width: 2%"></div>
                                </div>
                                <span class="text-xs text-gray-600 w-8">3</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600 w-12">1 ستاره</span>
                                <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-400 rounded-full" style="width: 1%"></div>
                                </div>
                                <span class="text-xs text-gray-600 w-8">1</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Write Review CTA in Modal -->
                <div class="mb-6">
                    <button id="write-review-modal-btn" class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-blue-600 to-teal-500 text-white rounded-xl font-bold hover:shadow-lg transform hover:scale-105 transition-all">
                        <i class="fas fa-pen ml-2"></i>
                        نظر خود را ثبت کنید
                    </button>
                </div>
                
                <!-- Reviews List -->
                <div class="space-y-4" id="reviews-list">
                    <!-- Review Item 1 -->
                    <div class="review-item bg-white border border-gray-100 rounded-2xl p-5 hover:shadow-md transition-shadow" data-rating="5">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-bold text-gray-900 mb-1">علی رضایی</h4>
                                <div class="flex items-center gap-2">
                                    <div class="flex items-center gap-1">
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                    </div>
                                    <span class="text-xs text-gray-400">•</span>
                                    <span class="text-xs text-gray-500">۲ روز پیش</span>
                                </div>
                            </div>
                            <span class="px-3 py-1 bg-green-50 text-green-700 text-xs font-bold rounded-full">
                                <i class="fas fa-check-circle ml-1"></i>
                                خرید تایید شده
                            </span>
                        </div>
                        <div class="review-text-container">
                            <p class="text-sm text-gray-700 leading-7 review-text">
                                تجربه‌ای عالی از آرایشگاه مردانه سلطنتی داشتم. پرسنل بسیار حرفه‌ای و محیط تمیز و شیک بود. حتماً دوباره مراجعه خواهم کرد.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Review Item 2 (Long Review) -->
                    <div class="review-item bg-white border border-gray-100 rounded-2xl p-5 hover:shadow-md transition-shadow" data-rating="4">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-bold text-gray-900 mb-1">محمد حسینی</h4>
                                <div class="flex items-center gap-2">
                                    <div class="flex items-center gap-1">
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="far fa-star text-gray-300 text-xs"></i>
                                    </div>
                                    <span class="text-xs text-gray-400">•</span>
                                    <span class="text-xs text-gray-500">۱ هفته پیش</span>
                                </div>
                            </div>
                            <span class="px-3 py-1 bg-green-50 text-green-700 text-xs font-bold rounded-full">
                                <i class="fas fa-check-circle ml-1"></i>
                                خرید تایید شده
                            </span>
                        </div>
                        <div class="review-text-container">
                            <p class="text-sm text-gray-700 leading-7 review-text line-clamp-3" data-full-text="کیفیت خدمات عالی بود و قیمت‌ها هم منصفانه. فقط کمی شلوغ بود و مجبور شدم منتظر بمانم. بهتر است از قبل نوبت بگیرید. محیط آرایشگاه بسیار تمیز و مرتب بود و از لوازم با کیفیتی استفاده می‌کردند. پرسنل بسیار مودب و حرفه‌ای برخورد کردند و به خواسته‌های من توجه کاملی داشتند. در کل تجربه خوبی بود و پیشنهاد می‌کنم حتماً امتحان کنید.">
                                کیفیت خدمات عالی بود و قیمت‌ها هم منصفانه. فقط کمی شلوغ بود و مجبور شدم منتظر بمانم. بهتر است از قبل نوبت بگیرید. محیط آرایشگاه بسیار تمیز و مرتب بود و از لوازم با کیفیتی استفاده می‌کردند...
                            </p>
                            <button class="text-blue-600 text-sm font-bold mt-2 hover:text-blue-700 read-more-btn">
                                مشاهده بیشتر
                                <i class="fas fa-chevron-down mr-1 text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- More review items... -->
                    <div class="review-item bg-white border border-gray-100 rounded-2xl p-5 hover:shadow-md transition-shadow" data-rating="5">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-bold text-gray-900 mb-1">رضا اکبری</h4>
                                <div class="flex items-center gap-2">
                                    <div class="flex items-center gap-1">
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                    </div>
                                    <span class="text-xs text-gray-400">•</span>
                                    <span class="text-xs text-gray-500">۲ هفته پیش</span>
                                </div>
                            </div>
                        </div>
                        <div class="review-text-container">
                            <p class="text-sm text-gray-700 leading-7 review-text">
                                بهترین آرایشگاهی که تا حالا رفتم! آقای احمدی واقعاً حرفه‌ای هستند و دقیقاً می‌دونن چه مدلی به صورتم میاد. پیشنهاد میکنم.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Load More Button -->
                <div class="text-center mt-6">
                    <button class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-full transition-colors">
                        نمایش نظرات بیشتر
                        <i class="fas fa-chevron-down mr-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Form Modal -->
<div id="reviewFormModal" class="fixed inset-0 z-[120] hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300" id="review-form-backdrop"></div>
    
    <div class="flex items-end sm:items-center justify-center min-h-full p-0 sm:p-4">
        <div id="review-form-content" class="relative bg-white w-full sm:max-w-lg rounded-t-3xl sm:rounded-2xl shadow-2xl transform transition-all duration-300 translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0 max-h-[90vh] overflow-y-auto">
            
            <!-- Mobile Drag Handle -->
            <div class="sm:hidden sticky top-0 bg-white rounded-t-3xl py-3 z-10">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto"></div>
            </div>
            
            <div class="p-6">
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">ثبت نظر جدید</h3>
                    <button id="close-review-form" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
                
                <!-- Form -->
                <form id="review-form">
                    <!-- Rating Stars -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-3">امتیاز شما</label>
                        <div class="flex items-center gap-3">
                            <div class="rating-stars flex gap-2">
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="1"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="2"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="3"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="4"></i>
                                <i class="far fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors rating-star" data-rating="5"></i>
                            </div>
                            <span id="rating-text" class="text-sm font-bold text-gray-600"></span>
                        </div>
                    </div>
                    
                    <!-- Name -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2" for="reviewer-name">نام شما</label>
                        <input type="text" id="reviewer-name" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="نام و نام خانوادگی" required>
                    </div>
                    
                    <!-- Service Used -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2" for="service-used">خدمت دریافت شده</label>
                        <select id="service-used" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            <option value="">انتخاب کنید...</option>
                            <option>اصلاح سر و صورت</option>
                            <option>رنگ مو</option>
                            <option>ماساژ صورت</option>
                            <option>شستشوی حرفه‌ای</option>
                            <option>سایر خدمات</option>
                        </select>
                    </div>
                    
                    <!-- Review Text -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2" for="review-text">نظر شما</label>
                        <textarea id="review-text" rows="4" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none transition-all" placeholder="تجربه خود را با دیگران به اشتراک بگذارید..." required></textarea>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500">حداقل 20 کاراکتر</span>
                            <span id="char-counter" class="text-xs text-gray-500">0/500</span>
                        </div>
                    </div>
                    
                    <!-- Recommend Checkbox -->
                    <div class="mb-6">
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" id="recommend-checkbox" class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 mt-0.5">
                            <span class="text-sm text-gray-700">این آرایشگاه را به دوستانم پیشنهاد می‌کنم</span>
                        </label>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="flex gap-3">
                        <button type="button" id="cancel-review" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-xl transition-colors">
                            انصراف
                        </button>
                        <button type="submit" class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-teal-500 text-white font-bold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed" id="submit-review">
                            ارسال نظر
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Styles for Reviews -->
<style>
/* Review Cards */
.review-card {
    transition: all 0.3s ease;
}

.review-card:hover {
    transform: translateY(-2px);
}

/* Modal Animations */
#reviewsModal.show #reviews-backdrop,
#reviewFormModal.show #review-form-backdrop {
    opacity: 1;
}

#reviewsModal.show #reviews-modal-content,
#reviewFormModal.show #review-form-content {
    transform: translateY(0) !important;
    opacity: 1 !important;
}

@media (min-width: 640px) {
    #reviewsModal.show #reviews-modal-content,
    #reviewFormModal.show #review-form-content {
        transform: scale(1) !important;
    }
}

/* Filter Chips */
.review-filter-chip {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    background: white;
    color: #4b5563;
    border: 1px solid #e5e7eb;
    transition: all 0.2s;
    white-space: nowrap;
}

.review-filter-chip:hover {
    background: #f9fafb;
    border-color: #d1d5db;
}

.review-filter-chip.active {
    background: linear-gradient(135deg, #3b82f6, #06b6d4);
    color: white;
    border-color: transparent;
}

/* Line Clamp for Long Reviews */
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Read More Button Animation */
.read-more-btn {
    display: inline-flex;
    align-items: center;
    transition: all 0.2s;
}

.read-more-btn:hover {
    gap: 4px;
}

.read-more-btn i {
    transition: transform 0.2s;
}

.read-more-btn.expanded i {
    transform: rotate(180deg);
}

/* Rating Stars Animation */
.rating-star {
    transition: all 0.2s;
}

.rating-star:hover {
    transform: scale(1.1);
}

.rating-star.filled {
    color: #facc15 !important;
}


/* Mobile Specific Styles */
@media (max-width: 640px) {
    #reviews-modal-content,
    #review-form-content {
        min-height: 70vh;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }
}

/* Smooth Scrollbar */
.scrollbar-hide::-webkit-scrollbar {
    display: none;
}

.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}


@media (max-width: 640px){
  #review-form-content{ 
    padding-bottom: max(16px, env(safe-area-inset-bottom));
  }
}









</style>

<!-- JavaScript for Reviews -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Reviews Modal
    const reviewsModal = document.getElementById('reviewsModal');
    const reviewsModalContent = document.getElementById('reviews-modal-content');
    const showAllBtn = document.getElementById('show-all-reviews');
    const closeReviewsBtn = document.getElementById('close-reviews-modal');
    const reviewsBackdrop = document.getElementById('reviews-backdrop');
    
    // Review Form Modal
    const reviewFormModal = document.getElementById('reviewFormModal');
    const reviewFormContent = document.getElementById('review-form-content');
    const writeReviewBtn = document.getElementById('write-review-btn');

    // چیپ «ثبت امتیاز» کنار 4.8
const rateNowChip = document.getElementById('rate-now-chip');
if (rateNowChip) rateNowChip.addEventListener('click', () => writeReviewBtn.click());

    const writeReviewModalBtn = document.getElementById('write-review-modal-btn');
    const closeReviewFormBtn = document.getElementById('close-review-form');
    const reviewFormBackdrop = document.getElementById('review-form-backdrop');
    const cancelReviewBtn = document.getElementById('cancel-review');
    
    // Form Elements
    const reviewForm = document.getElementById('review-form');
    const ratingStars = document.querySelectorAll('.rating-star');
    const ratingText = document.getElementById('rating-text');
    const reviewTextarea = document.getElementById('review-text');
    const charCounter = document.getElementById('char-counter');
    const submitBtn = document.getElementById('submit-review');
    const storeId = document.body.dataset.storeId || 'default';
    const userId = window.__APP_USER__?.id;
    const isAdmin = window.__APP_USER__?.isAdmin || window.__APP_USER__?.role === 'admin';
    const reviewKey = userId ? `review:last:${storeId}:${userId}` : `review:last:${storeId}`;
    function canSubmitReview() {
        if (isAdmin) return true;
        const last = localStorage.getItem(reviewKey);
        return !last || (Date.now() - parseInt(last, 10)) > 86400000;
    }
    function markReviewSubmitted() {
        localStorage.setItem(reviewKey, Date.now().toString());
    }
    function updateSubmitState() {
        if (canSubmitReview()) {
            submitBtn.disabled = false;
            submitBtn.removeAttribute('title');
        } else {
            submitBtn.disabled = true;
            submitBtn.title = 'You can submit one review per day.';
            showToastDark('You can submit one review per day.', {type: 'info'});
        }
    }
    
    let selectedRating = 0;
    
    // Open Reviews Modal
    showAllBtn.addEventListener('click', function() {
        reviewsModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        setTimeout(() => {
            reviewsModal.classList.add('show');
        }, 10);
    });
    
    // Open Review Form Modal
    function openReviewForm() {
        reviewFormModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        setTimeout(() => {
            reviewFormModal.classList.add('show');
        }, 10);
        updateSubmitState();
    }
    
    writeReviewBtn.addEventListener('click', openReviewForm);
    if (writeReviewModalBtn) {
        writeReviewModalBtn.addEventListener('click', openReviewForm);
    }
    
    // Close Modals
    function closeReviewsModal() {
        reviewsModal.classList.remove('show');
        setTimeout(() => {
            reviewsModal.classList.add('hidden');
            document.body.style.overflow = '';
        }, 300);
    }
    
    function closeReviewFormModal() {
        reviewFormModal.classList.remove('show');
        setTimeout(() => {
            reviewFormModal.classList.add('hidden');
            document.body.style.overflow = '';
            // Reset form
            reviewForm.reset();
            selectedRating = 0;
            ratingStars.forEach(star => {
                star.classList.remove('fas', 'filled');
                star.classList.add('far');
            });
            ratingText.textContent = '';
            charCounter.textContent = '0/500';
        }, 300);
    }
    
    closeReviewsBtn.addEventListener('click', closeReviewsModal);
    reviewsBackdrop.addEventListener('click', closeReviewsModal);
    
    closeReviewFormBtn.addEventListener('click', closeReviewFormModal);
    reviewFormBackdrop.addEventListener('click', closeReviewFormModal);
    cancelReviewBtn.addEventListener('click', closeReviewFormModal);
    
    // ESC key to close
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (!reviewsModal.classList.contains('hidden')) {
                closeReviewsModal();
            }
            if (!reviewFormModal.classList.contains('hidden')) {
                closeReviewFormModal();
            }
        }
    });
    
    // Mobile Swipe to Close
    function setupSwipeToClose(modalContent, closeFunction) {
        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        
        modalContent.addEventListener('touchstart', function(e) {
            if (window.innerWidth <= 640) {
                startY = e.touches[0].clientY;
                isDragging = true;
            }
        });
        
        modalContent.addEventListener('touchmove', function(e) {
            if (!isDragging || window.innerWidth > 640) return;
            
            currentY = e.touches[0].clientY;
            const translateY = Math.max(0, currentY - startY);
            
            if (translateY > 0) {
                modalContent.style.transform = `translateY(${translateY}px)`;
            }
        });
        
        modalContent.addEventListener('touchend', function() {
            if (!isDragging || window.innerWidth > 640) return;
            
            const translateY = currentY - startY;
            
            if (translateY > 100) {
                closeFunction();
            } else {
                modalContent.style.transform = '';
            }
            
            isDragging = false;
        });
    }
    
    setupSwipeToClose(reviewsModalContent, closeReviewsModal);
    setupSwipeToClose(reviewFormContent, closeReviewFormModal);
    
    // Filter Reviews
    const filterChips = document.querySelectorAll('.review-filter-chip');
    const reviewItems = document.querySelectorAll('.review-item');
    
    filterChips.forEach(chip => {
        chip.addEventListener('click', function() {
            filterChips.forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            
            reviewItems.forEach(review => {
                if (filter === 'all') {
                    review.style.display = '';
                } else {
                    const rating = review.dataset.rating;
                    review.style.display = rating === filter ? '' : 'none';
                }
            });
        });
    });
    
    // Read More/Less functionality
    document.querySelectorAll('.read-more-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const textElement = this.previousElementSibling;
            const fullText = textElement.dataset.fullText;
            
            if (this.classList.contains('expanded')) {
                textElement.classList.add('line-clamp-3');
                textElement.textContent = fullText.substring(0, 150) + '...';
                this.innerHTML = 'مشاهده بیشتر <i class="fas fa-chevron-down mr-1 text-xs"></i>';
                this.classList.remove('expanded');
            } else {
                textElement.classList.remove('line-clamp-3');
                textElement.textContent = fullText;
                this.innerHTML = 'مشاهده کمتر <i class="fas fa-chevron-up mr-1 text-xs"></i>';
                this.classList.add('expanded');
            }
        });
    });
    
    // Rating Stars Interaction
    const ratingMessages = ['', 'ضعیف', 'متوسط', 'خوب', 'عالی', 'فوق‌العاده'];
    
    ratingStars.forEach(star => {
        star.addEventListener('click', function() {
            selectedRating = parseInt(this.dataset.rating);
            updateStars(selectedRating);
            ratingText.textContent = ratingMessages[selectedRating];
        });
        
        star.addEventListener('mouseenter', function() {
            const hoverRating = parseInt(this.dataset.rating);
            updateStars(hoverRating);
            ratingText.textContent = ratingMessages[hoverRating];
        });
    });
    
    document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
        updateStars(selectedRating);
        ratingText.textContent = selectedRating ? ratingMessages[selectedRating] : '';
    });
    
    function updateStars(rating) {
        ratingStars.forEach((star, index) => {
            if (index < rating) {
                star.classList.remove('far');
                star.classList.add('fas', 'filled');
            } else {
                star.classList.remove('fas', 'filled');
                star.classList.add('far');
            }
        });
    }
    
    // Character Counter
    reviewTextarea.addEventListener('input', function() {
        const length = this.value.length;
        charCounter.textContent = `${length}/500`;
        
        if (length > 500) {
            this.value = this.value.substring(0, 500);
            charCounter.textContent = '500/500';
        }
    });
    
    // Form Submission
    reviewForm.addEventListener('submit', function(e) {
        e.preventDefault();

        if (!canSubmitReview()) {
            showToastDark('You can submit one review per day.', {type: 'info'});
            return;
        }

        // Validation
        if (selectedRating === 0) {
            alert('لطفاً امتیاز خود را انتخاب کنید');
            return;
        }

        if (reviewTextarea.value.length < 20) {
            alert('نظر شما باید حداقل 20 کاراکتر باشد');
            return;
        }

        // Close form modal
        closeReviewFormModal();

        setTimeout(() => {
            showToastDark('نظر شما با موفقیت ثبت شد', {type: 'success'});
        }, 300);
        markReviewSubmitted();
    });
});
</script>
    <!-- Store Info & Contact -->
    <section class="py-8 px-4">
        <h3 class="text-xl font-bold mb-4">اطلاعات و تماس</h3>
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="mb-6">
                <div class="flex items-start mb-4">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                        <i class="fas fa-map-marker-alt text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-bold mb-1">آدرس</h4>
<p id="store-address" class="text-sm text-gray-700">آدرس در حال بارگذاری...</p>
                    </div>
                </div>
                <div class="mb-4 h-48 rounded-lg overflow-hidden">
<div id="map-container" class="w-full h-full bg-gray-200 flex items-center justify-center">نقشه در حال بارگذاری...</div>                </div>
            </div>
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                        <i class="fas fa-phone text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-bold mb-1">شماره تماس</h4>
<p id="store-phone" class="text-sm text-gray-700">شماره تماس در حال بارگذاری...</p>
                    </div>
                </div>
            </div>
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                        <i class="fas fa-clock text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-bold mb-1">ساعت کاری</h4>
<p id="store-hours" class="text-sm text-gray-700">ساعات کاری در حال بارگذاری...</p>
<p id="store-hours" class="text-sm text-gray-700">ساعات کاری در حال بارگذاری...</p>
                    </div>
                </div>
            </div>
 

<div class="grid grid-cols-2 gap-3">
  <!-- صفحه اصلی ویترینت -->
  <a href="local***index.html"
     class="group inline-flex items-center justify-center gap-1.5 sm:gap-2 w-full
            rounded-2xl px-3.5 py-3 sm:px-4 sm:py-3.5 min-h-[52px] sm:min-h-[56px]
            font-extrabold text-white text-[13px] sm:text-[15px] shadow-lg
            bg-gradient-to-tr from-blue-600 to-teal-500 ring-1 ring-white/60
            transition-all hover:from-blue-700 hover:to-teal-600
            hover:shadow-[0_10px_25px_rgba(16,185,129,0.25)]
            active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
     aria-label="رفتن به صفحه اصلی ویترینت">
    <i class="fas fa-house ml-1.5 sm:ml-2 text-[14px] sm:text-base opacity-95 transition-transform group-active:scale-95"></i>
    <span class="truncate">صفحه اصلی ویترینت</span>
  </a>

  <!-- مغازه‌های مشابه -->
  <a href="local***discover.html"
     class="group inline-flex items-center justify-center gap-1.5 sm:gap-2 w-full
            rounded-2xl px-3.5 py-3 sm:px-4 sm:py-3.5 min-h-[52px] sm:min-h-[56px]
            font-extrabold text-blue-800 text-[13px] sm:text-[15px]
            bg-gradient-to-tr from-sky-50/90 via-cyan-50/90 to-emerald-50/90
            backdrop-blur-md border border-white/60 shadow
            hover:from-sky-100/90 hover:via-cyan-100/90 hover:to-emerald-100/90 hover:shadow-lg
            active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500
            transition-all"
     aria-label="مشاهده مغازه‌های مشابه">
    <i class="fas fa-store ml-1.5 sm:ml-2 text-[14px] sm:text-base opacity-95 transition-transform group-active:scale-95"></i>
    <span class="truncate">مغازه‌های مشابه</span>
  </a>
</div>




        </div>
    </section>
    <!-- Mobile Navigation Bar -->

<footer id="site-footer" class="w-full mt-16 hide-on-mobile" aria-labelledby="vitreenet-footer-title">
  <h2 id="vitreenet-footer-title" class="sr-only">ویترینت — ویترین آنلاین کسب‌وکارهای محلی</h2>

  <div class="bg-gradient-to-tr from-[#f8fafc] via-[#e0fdfa] to-[#d4fbe8]
              rounded-t-[1.7rem] border-t border-white/70
              shadow-[0_-12px_30px_rgba(0,0,0,0.06)]">
    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 py-10">

      <div class="grid grid-cols-1 md:grid-cols-4 gap-10">
        <!-- 1) اشاره خیلی مختصر به مغازه -->
        <div>
          <div class="flex items-center gap-2 mb-2">
            <span class="inline-flex w-9 h-9 items-center justify-center rounded-xl
                         bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
              <i class="fa-solid fa-store"></i>
            </span>
            <p class="font-extrabold text-gray-800">آرایشگاه مردانه سلطنتی</p>
          </div>
          <p class="text-xs text-gray-600 leading-6">
            این صفحه بر بستر <strong class="text-gray-800">ویترینت</strong> میزبانی می‌شود.
          </p>
          <!-- بنا به خواست شما دکمه «رزرو سریع» حذف شد -->
        </div>

        <!-- 2) ویترینت در یک نگاه (برای کاربران) -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="inline-flex w-9 h-9 items-center justify-center rounded-xl
                         bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
              <i class="fa-solid fa-compass"></i>
            </span>
            <p class="font-extrabold text-gray-800">ویترینت در یک نگاه</p>
          </div>

          <p class="text-sm text-gray-700 leading-7">
            با ویترینت، ویترین آنلاینِ مغازه‌ات را بساز و مدیریت کن؛
            رزرو نوبت، پرداخت امن، باشگاه مشتریان و گزارش‌های هوشمند — همه یک‌جا و بدون کدنویسی.
          </p>

          <div class="mt-4 space-y-2">
            <a href="/" rel="home"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-white
                      bg-gradient-to-tr from-blue-600 to-teal-500 hover:from-blue-700 hover:to-teal-600
                      shadow-lg transition" aria-label="رفتن به صفحه اصلی ویترینت">
              صفحهٔ اصلی ویترینت
            </a>

            <a href="/discover"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-blue-700
                      bg-white/80 backdrop-blur border border-white/70 hover:bg-white hover:shadow transition"
               aria-label="مشاهده مغازه‌های مشابه در ویترینت">
              مغازه‌های مشابه
            </a>
          </div>
        </div>

        <!-- 3) مزیت‌ها (خلاصه و کاربردی) -->
        <div>
          <p class="font-extrabold text-gray-800 mb-3">چرا ویترینت؟</p>
          <ul class="space-y-2 text-sm text-gray-700">
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> رزرو آنلاین با یادآوری خودکار</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> پرداخت امن و فاکتور دیجیتال</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> باشگاه مشتریان و کوپن‌های تخفیف</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> ظاهر سبک، واکنش‌گرا و سریع</li>
            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-emerald-600"></i> داشبورد آمار و گزارش‌های کاربردی</li>
          </ul>
        </div>

        <!-- 4) CTA برای صاحبان کسب‌وکار -->
        <div>
          <p class="font-extrabold text-gray-800 mb-3">برای صاحبان کسب‌وکار</p>
          <div class="space-y-3">
            <a href="/merchant/register"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-white
                      bg-gradient-to-tr from-blue-600 to-teal-500 hover:from-blue-700 hover:to-teal-600
                      shadow-lg transition" aria-label="ثبت فروشگاه در ویترینت">
              ثبت فروشگاه در ویترینت
            </a>
            <a href="/merchant/login"
               class="block w-full text-center px-5 py-3 rounded-xl font-extrabold text-blue-700
                      bg-white/80 backdrop-blur border border-white/70 hover:bg-white hover:shadow transition"
               aria-label="ورود فروشندگان">
              ورود فروشندگان
            </a>
            <div class="text-xs text-gray-500 leading-6">
              کمتر از ۳ دقیقه تا راه‌اندازی — بدون نیاز به برنامه‌نویسی
            </div>
          </div>
        </div>
      </div>

      <!-- نوار پایینی -->
      <div class="mt-10 pt-4 border-t border-white/70
                  flex flex-col sm:flex-row items-center justify-between gap-3
                  text-gray-500 text-sm">
        <div class="flex items-center gap-2">
          <span class="inline-flex w-6 h-6 items-center justify-center rounded-lg
                       bg-gradient-to-tr from-blue-600 to-teal-500 text-white">
            <i class="fa-solid fa-gem"></i>
          </span>
          <span>ساخته شده با <strong class="text-gray-700">ویترینت</strong> — ویترین آنلاین کسب‌وکارهای محلی</span>
        </div>

        <p>© <span id="footer-year"></span> ویترینت — همه حقوق محفوظ است.</p>

        <div class="flex items-center gap-2">
          <a href="/terms" class="hover:text-blue-700 transition">قوانین</a>
          <span class="text-gray-300">•</span>
          <a href="/privacy" class="hover:text-blue-700 transition">حریم خصوصی</a>
          <span class="text-gray-300">•</span>
          <button id="back-to-top" class="chip chip--primary" aria-label="بازگشت به بالای صفحه">بازگشت به بالا</button>
        </div>
      </div>

    </div>
  </div>
</footer>




<script>
  (function () {
    // سال شمسی با ارقام فارسی
    const yearEl = document.getElementById('footer-year');
    if (yearEl) {
      yearEl.textContent = new Intl.DateTimeFormat('fa-IR', { year: 'numeric' }).format(new Date());
    }

    // بازگشت به بالا با اسکرول نرم (رعایت Reduce Motion)
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const up = document.getElementById('back-to-top');
    if (up) {
      up.addEventListener('click', () => {
        if (prefersReduced) {
          window.scrollTo(0, 0);
        } else {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    }

    // اسکرول نرم برای لینک‌های داخلی داخل فوتر (#anchor)
    document.querySelectorAll('#site-footer a[href^="#"]').forEach(a => {
      a.addEventListener('click', (e) => {
        const id = a.getAttribute('href');
        const target = document.querySelector(id);
        if (!target) return;
        e.preventDefault();

        if (prefersReduced) {
          target.scrollIntoView();
        } else {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // بهبود دسترس‌پذیری: فوکوس پس از اسکرول
        target.setAttribute('tabindex', '-1');
        target.focus({ preventScroll: true });
      });
    });
  })();
</script>


    <script src="nav-active.js"></script>

    <script>
        // Modal functionality for portfolio images
        function openModal(imageSrc, title) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            
            modalImage.src = imageSrc;
            modalTitle.textContent = title;
            
            // Disable body scroll
            document.body.style.overflow = 'hidden';
            
            // Show modal with animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.relative').classList.add('scale-100', 'opacity-100');
                modal.querySelector('.relative').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
        function closeModal() {
            const modal = document.getElementById('imageModal');
            
            // Hide modal with animation
            modal.querySelector('.relative').classList.add('scale-95', 'opacity-0');
            modal.querySelector('.relative').classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                // Enable body scroll
                document.body.style.overflow = '';
            }, 300);
        }
        // Close modal when clicking outside the image
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        // Booking Wizard Logic
document.addEventListener('DOMContentLoaded', function () {
  // ---- عناصر اصلی
  const heroCta         = document.getElementById('hero-cta');
  const bookingWizard   = document.getElementById('booking-wizard');
  const prefersReduced  = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // مراحل و اندیکاتورها
  const step1 = document.getElementById('step-1');
  const step2 = document.getElementById('step-2');
  const step3 = document.getElementById('step-3');
  const step4 = document.getElementById('step-4');

  const currentStep     = document.getElementById('current-step');
  const progressBar     = document.getElementById('progress-bar');
  const step2Indicator  = document.getElementById('step-2-indicator');
  const step3Indicator  = document.getElementById('step-3-indicator');
  const step4Indicator  = document.getElementById('step-4-indicator');

  // گزینه‌ها و دکمه‌ها
  const serviceOptions  = document.querySelectorAll('.service-option');
  const dateOptions     = document.querySelectorAll('.date-option');
  const timeOptions     = document.querySelectorAll('.time-option');

  const nextToStep2     = document.getElementById('next-to-step-2');
  const nextToStep3     = document.getElementById('next-to-step-3');
  const nextToStep4     = document.getElementById('next-to-step-4');

  const backToStep1     = document.getElementById('back-to-step-1');
  const backToStep2     = document.getElementById('back-to-step-2');
  const backToStep3     = document.getElementById('back-to-step-3');

  // فیلدها و تایید
  const phoneNumber     = document.getElementById('phone-number');
  const customerName    = document.getElementById('customer-name');

  const confirmService  = document.getElementById('confirm-service');
  const confirmDate     = document.getElementById('confirm-date');
  const confirmTime     = document.getElementById('confirm-time');
  const confirmName     = document.getElementById('confirm-name');
  const confirmPhone    = document.getElementById('confirm-phone');
  const confirmPrice    = document.getElementById('confirm-price');

  const confirmBooking  = document.getElementById('confirm-booking');
  const bookingSuccess  = document.getElementById('booking-success');
  const closeBooking    = document.getElementById('close-booking');

  // وضعیت انتخاب‌ها
  let selectedService = '';
  let selectedPrice   = '';
  let selectedDate    = '';
  let selectedTime    = '';

  // ---- توابع کمکی
  function scrollToWizard() {
    if (!bookingWizard) return;
    const top = bookingWizard.getBoundingClientRect().top + window.scrollY - 80;
    prefersReduced ? window.scrollTo(0, top) : window.scrollTo({ top, behavior: 'smooth' });
  }
  function openWizard() {
    bookingWizard?.classList.remove('hidden');
    scrollToWizard();
  }
  function enable(el, on = true) {
    if (!el) return;
    el.disabled = !on;
  }

  // ---- باز کردن ویزارد از CTA بالا
  heroCta?.addEventListener('click', function (e) {
    e.preventDefault?.();
    openWizard();
  });

  // ---- باز کردن ویزارد از کارت‌های خدمات + پر‌کردن خودکار مرحله ۱
  // (اصلاح کلاس دکمه‌ها از .service-select به .service-button)
  document.querySelectorAll('.service-button').forEach((button) => {
    button.addEventListener('click', function () {
      const svc   = this.getAttribute('data-service');
      openWizard();
      // انتخاب خودکار همان گزینه در مرحله ۱ با تریگر کردن کلیک خودش
      setTimeout(() => {
        const opt = document.querySelector(`.service-option[data-service="${svc}"]`);
        opt?.click();
      }, 0);
    });
  });

  // ---- مرحله ۱: انتخاب سرویس
  serviceOptions.forEach(option => {
    option.addEventListener('click', function () {
      // پاک‌کردن انتخاب قبلی
      serviceOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
      // انتخاب فعلی
      this.classList.add('border-blue-500', 'bg-blue-50');
      // ذخیره
      selectedService = this.getAttribute('data-service') || '';
      selectedPrice   = this.getAttribute('data-price')   || '';
      // فعال‌سازی دکمه بعدی
      enable(nextToStep2, true);
    });
  });

  nextToStep2?.addEventListener('click', function () {
    step1.classList.add('hidden');
    step2.classList.remove('hidden');
    currentStep.textContent = '2';
    step2Indicator.classList.remove('bg-gray-300');
    step2Indicator.classList.add('bg-blue-600');
    progressBar.style.width = '50%';
    // از اینجا به بعد هنوز چیزی انتخاب نشده، دکمه مرحله بعد غیرفعال باشد
    enable(nextToStep3, false);
  });

  // ---- مرحله ۲: انتخاب تاریخ و ساعت
  dateOptions.forEach(option => {
    option.addEventListener('click', function () {
      // پاک‌کردن انتخاب قبلی
      dateOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
      // انتخاب فعلی
      this.classList.add('border-blue-500', 'bg-blue-50');
      // استخراج متن از دو div داخلی (اصلاح selector اشتباه '.div:nth-child()')
      const first  = this.firstElementChild?.textContent?.trim() || '';
      const second = this.lastElementChild?.textContent?.trim()  || '';
      // مطابق منطق قبلی: فرمت «دومی + اولی»
      selectedDate = (second + ' ' + first).trim();
      // فعال‌سازی دکمه بعدی اگر ساعت هم انتخاب شده
      if (selectedTime) enable(nextToStep3, true);
    });
  });

  timeOptions.forEach(option => {
    option.addEventListener('click', function () {
      // پاک‌کردن انتخاب قبلی
      timeOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
      // انتخاب فعلی
      this.classList.add('border-blue-500', 'bg-blue-50');
      // ذخیره
      selectedTime = (this.textContent || '').trim();
      // فعال‌سازی دکمه بعدی اگر تاریخ هم انتخاب شده
      if (selectedDate) enable(nextToStep3, true);
    });
  });

  backToStep1?.addEventListener('click', function () {
    step2.classList.add('hidden');
    step1.classList.remove('hidden');
    currentStep.textContent = '1';
    step2Indicator.classList.remove('bg-blue-600');
    step2Indicator.classList.add('bg-gray-300');
    progressBar.style.width = '25%';
  });

  nextToStep3?.addEventListener('click', function () {
    step2.classList.add('hidden');
    step3.classList.remove('hidden');
    currentStep.textContent = '3';
    step3Indicator.classList.remove('bg-gray-300');
    step3Indicator.classList.add('bg-blue-600');
    progressBar.style.width = '75%';
    // اطمینان از غیرفعال بودن دکمه مرحله ۴ تا تکمیل اعتبارسنجی
    validateStep3();
  });

  // ---- مرحله ۳: اطلاعات تماس
  function validateStep3() {
    const okPhone = (phoneNumber.value || '').trim().length >= 10;
    const okName  = (customerName.value || '').trim() !== '';
    enable(nextToStep4, okPhone && okName);
  }
  phoneNumber?.addEventListener('input', validateStep3);
  customerName?.addEventListener('input', validateStep3);

  backToStep2?.addEventListener('click', function () {
    step3.classList.add('hidden');
    step2.classList.remove('hidden');
    currentStep.textContent = '2';
    step3Indicator.classList.remove('bg-blue-600');
    step3Indicator.classList.add('bg-gray-300');
    progressBar.style.width = '50%';
  });

  nextToStep4?.addEventListener('click', function () {
    // تکمیل جزئیات تایید
    confirmService.textContent = selectedService;
    confirmDate.textContent    = selectedDate;
    confirmTime.textContent    = selectedTime;
    confirmName.textContent    = customerName.value;
    confirmPhone.textContent   = '＋۹۸' + phoneNumber.value; // همان فرمت قبلی با ارقام فارسی
    confirmPrice.textContent   = (parseInt(selectedPrice, 10) || 0).toLocaleString('fa-IR') + ' تومان';

    // رفتن به مرحله ۴
    step3.classList.add('hidden');
    step4.classList.remove('hidden');
    currentStep.textContent = '4';
    step4Indicator.classList.remove('bg-gray-300');
    step4Indicator.classList.add('bg-blue-600');
    progressBar.style.width = '100%';
  });

  // ---- مرحله ۴: تایید نهایی
  backToStep3?.addEventListener('click', function () {
    step4.classList.add('hidden');
    step3.classList.remove('hidden');
    currentStep.textContent = '3';
    step4Indicator.classList.remove('bg-blue-600');
    step4Indicator.classList.add('bg-gray-300');
    progressBar.style.width = '75%';
  });

  confirmBooking?.addEventListener('click', function () {
    // پیام موفقیت
    step4.classList.add('hidden');
    bookingSuccess.classList.remove('hidden');

    // ذخیره برای گیمیفیکیشن
    const bookings = JSON.parse(localStorage.getItem('vitreenet-bookings') || '[]');
    bookings.push({
      service: selectedService,
      price: selectedPrice,
      date: selectedDate,
      time: selectedTime,
      name: customerName.value,
      phone: phoneNumber.value,
      timestamp: new Date().toISOString()
    });
    localStorage.setItem('vitreenet-bookings', JSON.stringify(bookings));
  });

  closeBooking?.addEventListener('click', function () {
    // بستن و ریست کامل ویزارد
    bookingWizard.classList.add('hidden');
    resetBookingWizard();
  });

  // ---- ریست کامل ویزارد
  function resetBookingWizard() {
    // مراحل
    step1.classList.remove('hidden');
    step2.classList.add('hidden');
    step3.classList.add('hidden');
    step4.classList.add('hidden');
    bookingSuccess.classList.add('hidden');

    // اندیکاتورها
    currentStep.textContent = '1';
    step2Indicator.classList.remove('bg-blue-600');
    step2Indicator.classList.add('bg-gray-300');
    step3Indicator.classList.remove('bg-blue-600');
    step3Indicator.classList.add('bg-gray-300');
    step4Indicator.classList.remove('bg-blue-600');
    step4Indicator.classList.add('bg-gray-300');
    progressBar.style.width = '25%';

    // انتخاب‌ها
    serviceOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
    dateOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
    timeOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));

    // فیلدها
    phoneNumber.value = '';
    customerName.value = '';

    // دکمه‌ها
    enable(nextToStep2, false);
    enable(nextToStep3, false);
    enable(nextToStep4, false);

    // وضعیت
    selectedService = '';
    selectedPrice   = '';
    selectedDate    = '';
    selectedTime    = '';
  }
});

    </script>






<!-- Mobile Bottom Footer / Nav (5 items, same style) -->
<footer id="mobile-bottom-nav" class="mobile-nav lg:hidden safe-area-bottom" role="navigation" aria-label="ناوبری موبایل">
  <style>
    .safe-area-bottom {
      padding-bottom: env(safe-area-inset-bottom, 0);
    }
    
    @supports (padding: max(0px)) {
      .mobile-nav {
        padding-bottom: max(8px, env(safe-area-inset-bottom));
        height: calc(72px + env(safe-area-inset-bottom));
      }
    }
  </style>  <!-- خانه -->
  <button type="button" class="nav-item" data-nav="home" aria-label="خانه" aria-current="page">
    <i class="fa-solid fa-house nav-icon"></i>
    <span class="nav-label">خانه</span>
  </button>

  <!-- خدمات -->
  <button type="button" class="nav-item" data-nav="services" aria-label="خدمات">
    <i class="fa-solid fa-scissors nav-icon"></i>
    <span class="nav-label">خدمات</span>
  </button>

  <!-- رزرو (CTA وسط، برجسته) -->
  <button type="button" class="nav-item active -mt-6 !text-white" data-nav="booking" aria-label="رزرو" style="padding:0">
    <span class="inline-flex items-center justify-center w-14 h-14 rounded-2xl shadow-lg ring-4 ring-white/60 bg-gradient-to-tr from-blue-600 to-teal-500">
      <i class="fa-solid fa-calendar-check text-lg"></i>
    </span>
    <span class="nav-label mt-1">رزرو</span>
  </button>

  <!-- نمونه‌کار -->
  <button type="button" class="nav-item" data-nav="portfolio" aria-label="نمونه‌کار">
    <i class="fa-solid fa-images nav-icon"></i>
    <span class="nav-label">نمونه‌کار</span>
  </button>

  <!-- پروفایل -->
  <button type="button" class="nav-item" data-nav="profile" aria-label="پروفایل">
    <i class="fa-solid fa-user nav-icon"></i>
    <span class="nav-label">پروفایل</span>
  </button>
</footer>

<script>
(() => {
  const nav = document.getElementById('mobile-bottom-nav');
  if (!nav) return;

  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const items = nav.querySelectorAll('.nav-item');

  const setActive = (key) => {
    items.forEach(btn => {
      const isActive = btn.dataset.nav === key;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-current', isActive ? 'page' : 'false');
    });
  };

  const smoothGo = (target) => {
    if (!target) return;
    if (prefersReduced) target.scrollIntoView();
    else target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  const byId = (id) => document.getElementById(id);
  const bySel = (sel) => document.querySelector(sel);

  const findByHeading = (keyword) => {
    const hs = [...document.querySelectorAll('h1,h2,h3,h4')];
    const hit = hs.find(h => (h.textContent || '').includes(keyword));
    return hit ? (hit.closest('section') || hit) : null;
  };

  // Targets (with robust fallbacks)
  const targets = {
    home: () => document.documentElement,
    services: () => byId('services') || findByHeading('خدمات'),
    booking: () => byId('booking-wizard'),
    portfolio: () => byId('portfolio') || bySel('.portfolio-section') || findByHeading('نمونه کار'),
    profile: () => byId('profile') || findByHeading('پروفایل'),
  };

  // Click handlers
  items.forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.dataset.nav;

      if (key === 'home') {
        // لینک مستقیم به صفحه اصلی ویترینت
        window.location.href = 'local***index.html';
        return;
      }

      if (key === 'booking') {
        const wizard = byId('booking-wizard');
        const heroCta = byId('hero-cta');
        if (wizard && wizard.classList.contains('hidden')) {
          if (heroCta) heroCta.click();
          else wizard.classList.remove('hidden');
        }
        const t = targets.booking();
        if (t) {
          const top = t.getBoundingClientRect().top + window.scrollY - 80;
          if (prefersReduced) window.scrollTo(0, top);
          else window.scrollTo({ top, behavior: 'smooth' });
          setActive('booking');
        }
        return;
      }

      const t = targets[key] && targets[key]();
      if (t) smoothGo(t);
      setActive(key);
    });
  });

  // Scroll spy (if supported)
  const spySections = [
    { key: 'services', el: targets.services() },
    { key: 'portfolio', el: targets.portfolio() },
    { key: 'profile',  el: targets.profile() },
  ].filter(s => s.el);

  if ('IntersectionObserver' in window && spySections.length) {
    const io = new IntersectionObserver((entries) => {
      const vis = entries.filter(e => e.isIntersecting)
                         .sort((a,b) => b.intersectionRatio - a.intersectionRatio)[0];
      if (!vis) return;
      const hit = spySections.find(s => s.el === vis.target);
      if (hit) setActive(hit.key);
    }, { threshold: [0.35, 0.6], rootMargin: '-20% 0px -50% 0px' });
    spySections.forEach(s => io.observe(s.el));

    // Top of page = خانه
    window.addEventListener('scroll', () => {
      if (window.scrollY < 80) setActive('home');
    }, { passive: true });
  }

  // Initial state
  setActive('home');
})();
</script>



<script>
  (function () {
    var badge = document.getElementById('vip-badge');
    var out   = document.getElementById('vip-count');
    if (!badge || !out) return;
    var n = Number(badge.getAttribute('data-count') || 0);
    out.textContent = new Intl.NumberFormat('fa-IR').format(n) + ' نفر';
  })();
</script>






<script>
/* پاپ‌اپ شیشه‌ای وسط صفحه + ترجمه پیام‌ها (Drop-in Replacement) */
(() => {
  const translate = (txt) => {
    if (!txt) return "";
    if (/You can submit one review per day/i.test(txt)) {
      return "روزانه فقط یک نظر می‌توانید ثبت کنید.";
    }
    return txt;
  };

  // همان امضای قبلی: showToastDark(message, {type, durationMs})
  window.showToastDark = function (message, { type = "info", durationMs = 2600 } = {}) {
    const palette = {
      success: { ring: "ring-emerald-200", icon: "text-emerald-600", ico: "fas fa-check" },
      info:    { ring: "ring-blue-200",    icon: "text-blue-600",    ico: "fas fa-info-circle" },
      error:   { ring: "ring-rose-200",    icon: "text-rose-600",    ico: "fas fa-exclamation-circle" }
    };
    const p = palette[type] || palette.info;

    // اگر قبلاً بازه، حذف کن
    const existing = document.getElementById("dark-toast");
    if (existing) existing.remove();

    // لایه‌ی پس‌زمینه (برای کلیک برای بستن)
    const overlay = document.createElement("div");
    overlay.id = "dark-toast";
    overlay.setAttribute("role", "dialog");
    overlay.setAttribute("aria-modal", "true");
    overlay.dir = "rtl";
    overlay.className =
      "fixed inset-0 z-[160] flex items-center justify-center p-4 " +
      "bg-black/30 backdrop-blur-sm opacity-0 transition-opacity duration-200";

    // کارت وسط صفحه
    const card = document.createElement("div");
    card.className =
      `relative w-full max-w-sm sm:max-w-md rounded-2xl bg-white/95 backdrop-blur-md ` +
      `shadow-2xl ring-1 ${p.ring} transform scale-95 opacity-0 transition-all duration-200`;

    // محتوای کارت
    const inner = document.createElement("div");
    inner.className = "px-5 py-4 flex items-start gap-3 text-slate-900";

    const icon = document.createElement("i");
    icon.className = `${p.ico} ${p.icon} text-xl mt-0.5`;

    const msg = document.createElement("div");
    msg.className = "text-[14px] leading-7 font-bold";
    msg.textContent = translate(message);

    const closeBtn = document.createElement("button");
    closeBtn.type = "button";
    closeBtn.setAttribute("aria-label", "بستن");
    closeBtn.className =
      "absolute top-2 left-2 w-9 h-9 rounded-full text-slate-500 " +
      "hover:text-slate-700 hover:bg-slate-100 flex items-center justify-center";
    closeBtn.innerHTML = "&times;";

    inner.append(icon, msg);
    card.append(closeBtn, inner);
    overlay.append(card);
    document.body.appendChild(overlay);

    // انیمیشن نمایش
    requestAnimationFrame(() => {
      overlay.classList.remove("opacity-0");
      card.classList.remove("scale-95", "opacity-0");
    });

    // بستن با انیمیشن
    const remove = () => {
      overlay.classList.add("opacity-0");
      card.classList.add("scale-95", "opacity-0");
      setTimeout(() => overlay.remove(), 200);
      document.removeEventListener("keydown", onKey);
    };
    const onKey = (e) => { if (e.key === "Escape") remove(); };

    document.addEventListener("keydown", onKey);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) remove(); });
    closeBtn.addEventListener("click", (e) => { e.stopPropagation(); remove(); });

    // زمان‌بندی خودکار + توقف با Hover
    let timer = setTimeout(remove, durationMs);
    overlay.addEventListener("mouseenter", () => clearTimeout(timer));
    overlay.addEventListener("mouseleave", () => {
      timer = setTimeout(remove, 1200);
    });
  };

  // فارسی‌سازی Tooltip دکمه‌ی ارسال نظر در حالت محدودیت روزانه
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("submit-review");
    if (!btn) return;
    const apply = () => {
      if (/You can submit one review per day/i.test(btn.title || "")) {
        btn.title = "روزانه فقط یک نظر می‌توانید ثبت کنید.";
      }
    };
    apply();
    new MutationObserver(apply).observe(btn, { attributes: true, attributeFilter: ["title"] });
  });
})();
</script>






<script>
/* ===== Portfolio Likes (guest-friendly) ===== */
(function(){
  'use strict';
  const REQUIRE_LOGIN_FOR_LIKE = false; // اگر خواستی لاگین را اجباری کنی، اینو true کن
  const isLoggedIn = () => { try { return !!JSON.parse(localStorage.getItem('auth_user')||'null'); } catch(e){ return false } };
  const keyCnt = id => `vt:pf:likes:${id}`;
  const keyMe  = id => `vt:pf:liked:${id}`;

  // تبدیل هر نوع رقم فارسی/عربی به لاتین
  const toEnDigits = s => (s||'')
    .replace(/[۰-۹]/g, d => '0123456789'['۰۱۲۳۴۵۶۷۸۹'.indexOf(d)])
    .replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
  // نمایش به زبان انگلیسی/لاتین با جداکننده هزارگان
  const fmtEn = n => Number(n).toLocaleString('en-US');

  function getId(card){
    if(card.dataset.itemId) return card.dataset.itemId;
    const seed = card.querySelector('img[src*="/seed/"]')?.src.match(/seed\/([^/]+)/)?.[1];
    const fallback = card.querySelector('.portfolio-name')?.textContent?.trim();
    const id = seed || fallback || ('item-' + Math.random().toString(36).slice(2,8));
    card.dataset.itemId = id;
    return id;
  }

  function setA11y(el, liked){
    el.setAttribute('role','button');
    el.setAttribute('tabindex','0');
    el.setAttribute('aria-pressed', liked ? 'true' : 'false');
    el.title = liked ? 'لغو لایک' : 'پسندیدن';
  }

  function updateUIFor(id, liked, count){
    document.querySelectorAll(`.portfolio-card[data-item-id="${id}"]`).forEach(card=>{
      const wrap = card.querySelector('.fa-heart')?.parentElement;
      const icon = wrap?.querySelector('.fa-heart');
      const cnt  = wrap?.querySelector('span');
      if(!wrap || !icon || !cnt) return;
      icon.classList.toggle('far', !liked);
      icon.classList.toggle('fas', liked);
      wrap.classList.toggle('text-red-500', liked);
      cnt.textContent = fmtEn(count);   // ← نمایش لاتین
      setA11y(wrap, liked);
    });
    if(window.__PF_ACTIVE_ID===id){
      const mLikes = document.getElementById('modalLikes');
      if(mLikes) mLikes.textContent = fmtEn(count); // ← نمایش لاتین داخل مودال
    }
  }

  function toggle(id){
    if (REQUIRE_LOGIN_FOR_LIKE && !isLoggedIn()) {
      if (typeof window.showToastDark === 'function') showToastDark('برای لایک یک ورود کوتاه لازمه 🙂', {type:'info'});
      return;
    }
    const liked = localStorage.getItem(keyMe(id))==='1';
    let count = parseInt(localStorage.getItem(keyCnt(id))||'0',10);
    count = liked ? Math.max(0, count-1) : count+1;
    localStorage.setItem(keyCnt(id), String(count));
    if(liked){ localStorage.removeItem(keyMe(id)); } else { localStorage.setItem(keyMe(id),'1'); }
    updateUIFor(id, !liked, count);
    document.dispatchEvent(new CustomEvent('portfolio:likeChanged', { detail:{ id, liked:!liked, count } }));
  }

  function bindCard(card){
    const id = getId(card);
    const wrap = card.querySelector('.fa-heart')?.parentElement;
    const icon = wrap?.querySelector('.fa-heart');
    const cnt  = wrap?.querySelector('span');
    if(!wrap || !icon || !cnt) return;

    // bootstrap از مقدار موجود در DOM فقط بار اول
    if(localStorage.getItem(keyCnt(id))==null){
      const rawText = toEnDigits(cnt.textContent||'0'); // ← نرمال به لاتین
      const raw = parseInt(rawText.replace(/[^\d]/g,''),10) || 0;
      localStorage.setItem(keyCnt(id), String(raw));
    }
    const liked  = localStorage.getItem(keyMe(id))==='1';
    const stored = parseInt(localStorage.getItem(keyCnt(id))||'0',10);
    cnt.textContent = fmtEn(stored); // ← نمایش لاتین
    icon.classList.toggle('far', !liked);
    icon.classList.toggle('fas', liked);
    wrap.classList.toggle('text-red-500', liked);
    setA11y(wrap, liked);

    // click + keyboard
    wrap.addEventListener('click', (e)=>{ e.preventDefault(); toggle(id); });
    wrap.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(id);} });

    // double-tap روی عکس = لایک
    const img = card.querySelector('img');
    if(img){
      let lastTap = 0;
      img.addEventListener('click', ()=>{
        const now = Date.now();
        if(now - lastTap < 350){ if(localStorage.getItem(keyMe(id))!=='1') toggle(id); }
        lastTap = now;
      });
    }
  }

  function init(){ document.querySelectorAll('.portfolio-card').forEach(bindCard); }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();

  // برای استفاده در مودال
  window.__getPortfolioLikes = id => parseInt(localStorage.getItem(keyCnt(id))||'0',10);
})();
</script>

<script>
/* ===== Image viewer modal (sync with like) ===== */
function openModal(imgUrl, title, itemId){
  const modal = document.getElementById('imageModal');
  const cardId = itemId || (imgUrl && (imgUrl.match(/seed\/([^/]+)/)?.[1])) || (title || '').trim();
  window.__PF_ACTIVE_ID = cardId;

  document.getElementById('modalTitle').textContent = title || '';
  document.getElementById('modalImage').src = imgUrl || '';
  const cur = typeof window.__getPortfolioLikes === 'function' ? window.__getPortfolioLikes(cardId) : null;
  if(cur!=null){ document.getElementById('modalLikes').textContent = Number(cur).toLocaleString('en-US'); } // ← لاتین

  // قلب داخل مودال کلیک‌پذیر
  const likeWrap = document.querySelector('#imageModal .fa-heart')?.parentElement;
  if(likeWrap){
    likeWrap.style.cursor = 'pointer';
    likeWrap.onclick = function(){
      const card = Array.from(document.querySelectorAll('.portfolio-card'))
        .find(c => (c.dataset.itemId===cardId) || (c.querySelector('img[src*="/seed/"]')?.src.includes(`/${cardId}/`)));
      card?.querySelector('.fa-heart')?.parentElement?.click();
    };
  }

  modal.classList.remove('hidden');
  modal.classList.add('flex');
  const card = modal.querySelector('.relative');
  if(card){
    card.classList.remove('scale-95','opacity-0');
    card.classList.add('scale-100','opacity-100');
  }
}
function closeModal(){
  const modal = document.getElementById('imageModal');
  const card = modal.querySelector('.relative');
  if(card){
    card.classList.add('scale-95','opacity-0');
    card.classList.remove('scale-100','opacity-100');
    setTimeout(()=>{ modal.classList.add('hidden'); modal.classList.remove('flex'); }, 160);
  }else{
    modal.classList.add('hidden'); modal.classList.remove('flex');
  }
}
</script>


<script>
// Lazy load background images with better error handling
document.addEventListener('DOMContentLoaded', () => {
  const lazyBackgrounds = document.querySelectorAll('.lazy-bg');
  
  if ('IntersectionObserver' in window) {
    const bgObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const bg = entry.target;
          const bgUrl = bg.dataset.bg;
          
          // Preload image first
          const img = new Image();
          img.onload = () => {
            bg.style.backgroundImage = `url(${bgUrl})`;
            bg.classList.remove('lazy-bg');
            bg.classList.add('loaded');
          };
          img.onerror = () => {
            console.error('Failed to load background image:', bgUrl);
            bg.classList.add('load-error');
          };
          img.src = bgUrl;
          
          bgObserver.unobserve(bg);
        }
      });
    }, {
      rootMargin: '50px 0px',
      threshold: 0.01
    });
    
    lazyBackgrounds.forEach(bg => bgObserver.observe(bg));
  } else {
    // Fallback for older browsers
    lazyBackgrounds.forEach(bg => {
      bg.style.backgroundImage = `url(${bg.dataset.bg})`;
    });
  }
});
</script>

<script>
// Performance monitoring
window.addEventListener('load', () => {
  if ('performance' in window && 'measureUserAgentSpecificMemory' in performance) {
    const perfData = performance.getEntriesByType('navigation')[0];
    
    // Log performance metrics
    console.log('Performance Metrics:', {
      domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
      loadComplete: perfData.loadEventEnd - perfData.loadEventStart,
      domInteractive: perfData.domInteractive,
      firstPaint: performance.getEntriesByName('first-paint')[0]?.startTime
    });
    
    // Warn if page load is slow
    if (perfData.loadEventEnd - perfData.fetchStart > 3000) {
      console.warn('Page load time exceeds 3 seconds. Consider optimizing resources.');
    }
  }
});
</script>


<!-- ==== VENDOR SERVICES (bind to your backend) – START ==== -->
<script>
(() => {
  'use strict';

  /** ================== Config & Helpers ================== **/
  const API_BASE = '/api/seller-services';

  // اگر توکن رو جای دیگه می‌ذاری، این تابع رو تغییر بده
  function getToken() {
    return (
      localStorage.getItem('access_token') ||
      localStorage.getItem('token') ||
      localStorage.getItem('jwt') ||
      null
    );
  }
  const authHeaders = () => {
    const t = getToken();
    return t ? { 'Authorization': 'Bearer ' + t } : {};
  };
  const toFa = s => String(s).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
  const priceFa = n => (Number(n)||0).toLocaleString('fa-IR');
  const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));

  function toast(msg, type='info') {
    if (typeof showToastDark === 'function') showToastDark(msg, {type});
    else alert(msg);
  }

  // shopurl را فقط از پارامتر کوئری می‌خواند
  function getShopUrlFromLocation() {
    const u = new URL(location.href);
    const q = u.searchParams.get('shopurl');
    return q ? q.trim() : '';
  }

  function show404() {
    document.body.innerHTML = '<h1 class="text-center mt-10 text-2xl">404 - فروشگاه یافت نشد</h1>';
  }

  // نزدیک‌ترین کانتینر «خدمات ما»
  function findServicesContainer() {
    const headings = Array.from(document.querySelectorAll('section h3'));
    const h = headings.find(el => (el.textContent || '').trim().includes('خدمات ما'));
    if (!h) return null;
    const sec = h.closest('section');
    if (!sec) return null;
    // کانتینر اسکرولی که قبلاً داشتی
    const c = sec.querySelector('.scroll-container');
    return c || null;
  }

  // باز کردن ویزارد رزرو
  function bindReserveClicks(container) {
    if (!container) return;
    container.addEventListener('click', (e) => {
      const btn = e.target.closest('.service-button');
      if (!btn) return;
      e.preventDefault();
      const prefill = { service: btn.dataset.service, price: btn.dataset.price };
      if (typeof window.openBookingWizard === 'function') {
        window.openBookingWizard(prefill);
      } else {
        toast('بخش رزرو در این صفحه پیدا نشد', 'info');
      }
    });
  }

  /** ================== API calls ================== **/
  async function apiGetPublic(shopurl) {
    const res = await fetch(`${API_BASE}/by-shopurl/${encodeURIComponent(shopurl)}`, {
      credentials: 'include'
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json(); // { items, sellerId }
  }

  async function apiGetSeller(shopurl) {
    const res = await fetch(`/api/sellers/by-shopurl/${encodeURIComponent(shopurl)}`, { credentials: 'include' });
    if (!res.ok) throw new Error('seller not found');
    return res.json();
  }

  function updateSellerProfile(seller) {
    const titleEl = document.getElementById('page-title');
    if (titleEl) titleEl.textContent = `${seller.storename || ''} | Vitreenet`;
    document.getElementById('seller-name').textContent = seller.storename || '';
    document.getElementById('seller-category').textContent = seller.category || '';
    document.getElementById('seller-phone').textContent = seller.phone || '';
    document.getElementById('seller-address').textContent = seller.address || '';
  }

  /** ================== Render ================== **/
  function cardTemplate(item) {
    const img = Array.isArray(item.images) && item.images.length
      ? item.images[Math.max(0, Math.min(item.mainImageIndex||0, item.images.length-1))]
      : `https://picsum.photos/seed/${encodeURIComponent(item.title)}/400/300.jpg`;

    return `
      <div class="service-card flex-shrink-0 w-72 bg-white rounded-xl shadow-md overflow-hidden flex flex-col relative" data-svc-id="${item._id}">
        <img src="${img}" alt="${item.title}" class="service-image">
        <div class="p-5 flex flex-col flex-grow">
          <h4 class="font-bold text-lg mb-2">${item.title}</h4>
          <p class="text-sm text-gray-600 mb-4 flex-grow line-clamp-2">${item.desc || ''}</p>
          <div class="flex justify-between items-end mt-auto">
            <div class="space-y-1">
              <div class="text-xs text-gray-500">مدت: ${toFa(item.durationMinutes || 30)} دقیقه</div>
              <div class="flex items-baseline gap-2">
                <span class="service-price">
                  <span class="price-view">${priceFa(item.price)}</span>
                </span>
                <span class="service-currency mr-1">تومان</span>
              </div>
            </div>
            <button class="service-button text-white font-bold py-2 px-5 rounded-full text-sm transition-all cta-button ${item.isActive?'':'opacity-40 pointer-events-none'}"
                    data-service="${item.title}" data-price="${item.price}">
              رزرو
            </button>
          </div>
        </div>
      </div>
    `;
  }


  /** ================== Bootstrap ================== **/
  const servicesContainer = findServicesContainer();
  bindReserveClicks(servicesContainer);

  let LAST_PUBLIC = { items: [], sellerId: null };

  function renderList() {
    if (!servicesContainer) return;
    servicesContainer.innerHTML = '';
    if (!LAST_PUBLIC.items || LAST_PUBLIC.items.length === 0) {
      servicesContainer.innerHTML = `
        <div class="w-full text-center text-gray-500 py-8">
          فعلاً سرویسی ثبت نشده است.
        </div>`;
      return;
    }

    // مرتب‌سازی: فعال‌ها اول، بعد قیمت صعودی
    const sorted = [...LAST_PUBLIC.items].sort((a,b) => {
      if (!!b.isActive - !!a.isActive) return (!!b.isActive - !!a.isActive);
      if ((a.price||0) !== (b.price||0)) return (a.price||0) - (b.price||0);
      return (a.createdAt||'') < (b.createdAt||'') ? 1 : -1;
    });

    sorted.forEach(item => {
      if (!item.isActive) return;
      servicesContainer.insertAdjacentHTML('beforeend', cardTemplate(item));
    });
  }

  async function renderAll() {
    const shopurl = getShopUrlFromLocation();
    if (!shopurl) { show404(); return; }

    try {
      const [data, seller] = await Promise.all([
        apiGetPublic(shopurl),
        apiGetSeller(shopurl)
      ]);
        LAST_PUBLIC = data; // { items, sellerId }
        updateSellerProfile(seller);
        renderList();
      } catch (err) {
        console.error('Load public services failed', err);
        show404();
      }
    }

  document.addEventListener('DOMContentLoaded', renderAll);
})();
</script>
<!-- ==== VENDOR SERVICES – END ==== -->


<script>
(() => {
  'use strict';

  // ---------- Helpers ----------
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const toFa = n => String(n ?? 0).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);

  // shop slug from URL (?shopurl=, ?shop=, ?seller=)
  function getShopSlug() {
    const u = new URL(location.href);
    return (u.searchParams.get('shopurl') || u.searchParams.get('shop') || u.searchParams.get('seller') || '').trim();
  }

  // API base (optional global). Falls back to same origin.
  const API_BASE = (window.API_BASE || '').replace(/\/+$/, '');
  const SLUG = getShopSlug();

  // Candidate endpoints to be compatible with new backend & s-seller-panel.js
  // The first "ok & non-empty" wins. You can prune once your final route is fixed.
  const CANDIDATES = [
    `${API_BASE}/api/service-portfolio/public/${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/seller-portfolio/public/${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/portfolios/public/${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/portfolio/public/${encodeURIComponent(SLUG)}`,
    `${API_BASE}/api/portfolio?shopurl=${encodeURIComponent(SLUG)}`,
  ];

  // Normalize backend item to UI model
  function normalize(item) {
    const img = item.image || item.cover || (item.images?.[0]?.url || item.images?.[0]) || '';
    return {
      id:      item._id || item.id || crypto.randomUUID?.() || ('pf_' + Math.random().toString(36).slice(2)),
      title:   item.title || item.name || '—',
      desc:    item.description || item.desc || '',
      image:   img,
      views:   item.views ?? item.viewCount ?? 0,
      likes:   item.likes ?? item.likeCount ?? 0,
      created: item.createdAt || item.updatedAt || null
    };
  }

  async function tryFetch(url) {
    const r = await fetch(url, { credentials: 'include' });
    if (!r.ok) return null;
    const data = await r.json().catch(()=>null);
    const list = Array.isArray(data) ? data : (data?.items || data?.data || data?.results || []);
    return Array.isArray(list) ? list : null;
  }

  async function loadPortfolio() {
    if (!SLUG) return [];
    for (const url of CANDIDATES) {
      try {
        const items = await tryFetch(url);
        if (items && items.length) return items.map(normalize);
      } catch (_) {}
    }
    return [];
  }

  // ---------- Rendering ----------
  const grid = $('#portfolio-grid');
  const row  = $('#portfolio-row');
  const emptyMsg = $('#portfolio-empty');
  const loading  = $('#portfolio-loading');
  const tpl = $('#tpl-portfolio-card');

  function createCard(it) {
    const node = tpl.content.firstElementChild.cloneNode(true);

    const imgEl   = node.querySelector('.portfolio-img');
    const titleEl = node.querySelector('.portfolio-name');
    const descEl  = node.querySelector('.portfolio-description');
    const vEl     = node.querySelector('.js-views');
    const lEl     = node.querySelector('.js-likes');
    const btn     = node.querySelector('.js-open');

    titleEl.textContent = it.title || '—';
    descEl.textContent  = it.desc || '';
    vEl.textContent     = toFa(it.views);
    lEl.textContent     = toFa(it.likes);

    // Lazy: use data-src; real load by IntersectionObserver
    imgEl.alt = it.title || '';
    imgEl.dataset.src = it.image || '';
    imgEl.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='; // 1x1

    btn.addEventListener('click', () => openImageModal(it));

    return node;
  }

  function render(items) {
    // clear
    row.innerHTML = '';
    grid.innerHTML = '';

    if (!items.length) {
      emptyMsg.classList.remove('hidden');
      return;
    }
    emptyMsg.classList.add('hidden');

    // mobile row
    items.forEach(it => row.appendChild(createCard(it)));
    // desktop grid
    items.forEach(it => grid.appendChild(createCard(it)));

    // show grid on md+
    grid.classList.remove('hidden');

    // start lazy load
    lazyLoadImages();
  }

  // ---------- Lazy Loading ----------
  function lazyLoadImages() {
    const imgs = $$('#portfolio .portfolio-img');
    if (!('IntersectionObserver' in window)) {
      imgs.forEach(img => { if (img.dataset.src) img.src = img.dataset.src; });
      return;
    }
    const io = new IntersectionObserver((entries, obs) => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          const img = e.target;
          const src = img.dataset.src;
          if (src) {
            img.src = src;
            img.removeAttribute('data-src');
          }
          obs.unobserve(img);
        }
      });
    }, { rootMargin: '120px' });
    imgs.forEach(img => io.observe(img));
  }

  // ---------- Image Modal ----------
  const imageModal = $('#imageModal');
  const imageEl    = $('#modalImage');
  const titleEl    = $('#modalTitle');
  const mViews     = $('#modalViews');
  const mLikes     = $('#modalLikes');
  const closeBtn   = $('#imageModalClose');

  function openImageModal(it) {
    if (!imageModal) return;
    titleEl.textContent = it.title || '';
    imageEl.src = it.image || '';
    imageEl.alt = it.title || '';
    mViews.textContent = toFa(it.views ?? 0);
    mLikes.textContent = toFa(it.likes ?? 0);

    imageModal.classList.remove('hidden');
    imageModal.classList.add('flex');
    document.addEventListener('keydown', onEsc);
  }

  function closeImageModal() {
    imageModal.classList.add('hidden');
    imageModal.classList.remove('flex');
    imageEl.src = '';
    document.removeEventListener('keydown', onEsc);
  }

  function onEsc(e) { if (e.key === 'Escape') closeImageModal(); }

  closeBtn?.addEventListener('click', closeImageModal);
  imageModal?.addEventListener('click', e => { 
    if (e.target === imageModal) closeImageModal();
  });

  // ---------- Public refresh hook (optional) ----------
  // اگر پنل فروشنده بعد از ثبت نمونه‌کار event بزنه، این صفحه رفرش می‌شود:
  // document.dispatchEvent(new Event('portfolio:refresh'))
  document.addEventListener('portfolio:refresh', async () => {
    loading?.classList.remove('hidden');
    const items = await loadPortfolio();
    render(items);
    loading?.classList.add('hidden');
  });

  // ---------- Boot ----------
  (async () => {
    try {
      const items = await loadPortfolio();
      render(items);
    } finally {
      loading?.classList.add('hidden');
    }
  })();
})();
</script>


<script>
(function () {
  'use strict';

  // ✅ اگر مسیر mount فرق دارد، این را مطابق سرورت عوض کن
  const API_BASE = '/api/portfolio';

  // --- helpers ---
  const $  = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

  // shopurl را از یکی از جاها می‌گیریم: window.__SHOP_URL__ یا data-attr یا URL
function getShopUrl() {
  // 1) از QueryString
  const qs = new URLSearchParams(location.search);
  const q  = qs.get('shopurl') || qs.get('shop') || qs.get('s');
  if (q) return String(q).trim();

  // 2) از متغیر/دیتا-اَتریبیوت
  if (window.__SHOP_URL__) return String(window.__SHOP_URL__).trim();
  const fromData = document.body?.dataset?.shopurl || document.querySelector('#seller-profile')?.dataset?.shopurl;
  if (fromData) return String(fromData).trim();

  // 3) از مسیر (پسوند .html حذف بشه)
  const parts = location.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
  let last = parts.pop() || '';
  return last.replace(/\.html?$/i, '');
}

  // عناصر UI
  const grid      = $('#portfolio-grid');
  const row       = $('#portfolio-row');
  const tpl       = $('#tpl-portfolio-card');
  const loadingEl = $('#portfolio-loading');
  const emptyEl   = $('#portfolio-empty');

  // مودال (لطفاً مطمئن شو فقط یک #imageModal داری)
  const modal       = $('#imageModal');
  const modalTitle  = $('#modalTitle');
  const modalImg    = $('#modalImage');
  const modalViews  = $('#modalViews');
  const modalLikes  = $('#modalLikes');
  const modalClose  = $('#imageModalClose');

  function openModal(item) {
    if (!modal) return;
    modalTitle && (modalTitle.textContent = item.title || '');
    if (modalImg) {
      modalImg.src = item.image;
      modalImg.alt = item.title || '';
    }
    if (modalViews) modalViews.textContent = ((item.views ?? 0)).toLocaleString('fa-IR');
    if (modalLikes) modalLikes.textContent = ((item.likes ?? 0)).toLocaleString('fa-IR');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
  function closeModal() {
    if (!modal) return;
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
  modal?.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
  modalClose?.addEventListener('click', closeModal);

  // کارت ساز
  function buildCard(item) {
    const node = tpl.content.firstElementChild.cloneNode(true);
    const img  = $('.portfolio-img', node);
    const name = $('.portfolio-name', node);
    const desc = $('.portfolio-description', node);
    const vEl  = $('.js-views', node);
    const lEl  = $('.js-likes', node);
    const btn  = $('.js-open', node);

    if (img) {
      img.src = item.image;
      img.alt = item.title || '';
      img.loading = 'lazy';
      img.decoding = 'async';
    }
    if (name) name.textContent = item.title || '—';
    if (desc) desc.textContent = item.description || '';
    if (vEl)  vEl.textContent  = ((item.views ?? 0)).toLocaleString('fa-IR');
    if (lEl)  lEl.textContent  = ((item.likes ?? 0)).toLocaleString('fa-IR');
    if (btn)  btn.addEventListener('click', () => openModal(item));

    return node;
  }

async function loadPortfolio() {
  const API_BASE = '/api/portfolio'; // اگر API روی پورت/دامنه دیگری‌ست، این را کامل کن مثلا: 'http://localhost:3000/api/portfolio'
  const shopurl  = getShopUrl();

  const loadingEl = document.getElementById('portfolio-loading');
  const emptyEl   = document.getElementById('portfolio-empty');
  const grid      = document.getElementById('portfolio-grid');
  const row       = document.getElementById('portfolio-row');
  const tpl       = document.getElementById('tpl-portfolio-card');

  if (!shopurl) {
    loadingEl?.classList.add('hidden');
    emptyEl?.classList.remove('hidden');
    if (emptyEl) emptyEl.textContent = 'آدرس فروشگاه نامعتبر است.';
    return;
  }

  const url = `${API_BASE}/public/${encodeURIComponent(shopurl)}`;
  try {
    const res = await fetch(url, { credentials: 'include' });
    let payload = null;
    try { payload = await res.json(); } catch(_) {}

    if (!res.ok) {
      const msg = (payload && payload.message) ? payload.message : `HTTP ${res.status}`;
      throw new Error(msg);
    }

    const items = Array.isArray(payload?.items) ? payload.items : [];
    loadingEl?.classList.add('hidden');

    if (!items.length) {
      emptyEl?.classList.remove('hidden');
      return;
    }

    grid?.classList.remove('hidden');

    const buildCard = (item) => {
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.querySelector('.portfolio-img').src = item.image;
      node.querySelector('.portfolio-img').alt = item.title || '';
      node.querySelector('.portfolio-name').textContent = item.title || '—';
      node.querySelector('.portfolio-description').textContent = item.description || '';
      node.querySelector('.js-views').textContent = (item.views ?? 0).toLocaleString('fa-IR');
      node.querySelector('.js-likes').textContent = (item.likes ?? 0).toLocaleString('fa-IR');
      node.querySelector('.js-open').addEventListener('click', () => openModal(item));
      return node;
    };

    items.forEach(it => {
      if (row)  row.appendChild(buildCard(it).cloneNode(true));
      if (grid) grid.appendChild(buildCard(it));
    });
  } catch (err) {
    console.error('portfolio fetch failed:', err);
    loadingEl?.classList.add('hidden');
    emptyEl?.classList.remove('hidden');
    if (emptyEl) emptyEl.textContent = String(err.message || 'خطا در بارگذاری نمونه‌کارها');
  }
}

  // استارت
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadPortfolio);
  } else {
    loadPortfolio();
  }
})();
</script>




</body>
</html>