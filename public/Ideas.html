<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="ocean">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Quiz WebApp Pro â€” Ù†Ø³Ø®Ù‡ ÙØ§Ø±Ø³ÛŒ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <meta name="theme-color" content="#3b82f6" />
  <style>
    :root{
      --brand1:#3b82f6; --brand2:#06b6d4; --brand3:#10b981;
      --accent1:#fde047; --accent2:#fb923c; --accent3:#a78bfa; --accent4:#ec4899;
      --text:#ffffff; --card:rgba(255,255,255,0.15); --cardBorder:rgba(255,255,255,0.30);
      --adBannerH:80px;
    }
    html[data-theme="ocean"] body{
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(255,255,255,0.25), transparent 50%),
        radial-gradient(1000px 700px at 0% 100%, rgba(255,255,255,0.15), transparent 50%),
        linear-gradient(135deg, var(--brand1), var(--brand2), var(--brand3));
    }
    html[data-theme="night"]{
      --brand1:#0f172a; --brand2:#1e293b; --brand3:#312e81;
      --accent1:#22d3ee; --accent2:#6366f1; --accent3:#a78bfa; --accent4:#f472b6;
    }
    html[data-theme="night"] body{
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(255,255,255,0.08), transparent 50%),
        radial-gradient(1000px 700px at 0% 100%, rgba(255,255,255,0.06), transparent 50%),
        linear-gradient(135deg, #0f172a, #1e293b, #312e81);
    }
    *{ font-family:'Vazirmatn',system-ui,-apple-system,Segoe UI,Roboto,sans-serif }
    body{ color:var(--text); min-height:100vh; overflow-x:hidden }
    .glass{ background:var(--card); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:1px solid var(--cardBorder); box-shadow:0 8px 32px rgba(31,38,135,.2) }
    .glass-dark{ background:rgba(0,0,0,.2); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,.15) }
    .card-hover{ transition:all .3s ease }
    .card-hover:hover{ transform:translateY(-5px); box-shadow:0 12px 40px rgba(31,38,135,.3) }
    .nav-item{ position:relative; transition:all .3s ease }
    .nav-item.active::after{ content:''; position:absolute; bottom:0; right:0; left:0; height:3px; background:linear-gradient(90deg,var(--accent1),var(--accent2)); border-radius:3px 3px 0 0 }
    .safe{ padding-bottom: env(safe-area-inset-bottom) }
    .fade-in{ animation:fadeIn .45s ease forwards } @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .pulse{ animation:pulse 2s infinite } @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    /* Buttons */
    .btn{ width:100%; padding:1rem 1.25rem; border-radius:1rem; font-weight:800; box-shadow:0 10px 20px rgba(0,0,0,.12); transition:transform .2s ease, box-shadow .2s ease; min-height:44px; display:flex; align-items:center; justify-content:center }
    .btn:active{ transform:scale(.98) }
    .btn-primary{ background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#111827; box-shadow:0 8px 24px rgba(251,146,60,.35) }
    .btn-secondary{ background:linear-gradient(135deg,var(--accent3),var(--accent4)); color:#fff; box-shadow:0 8px 24px rgba(236,72,153,.35) }
    .btn-tertiary{ background:linear-gradient(135deg,#60a5fa,#6366f1); color:#fff; box-shadow:0 8px 24px rgba(99,102,241,.35) }
    .btn-province{ background:linear-gradient(135deg,#34d399,#10b981); color:#fff; box-shadow:0 8px 24px rgba(16,185,129,.35) }
    .btn-group{ background:linear-gradient(135deg,#c084fc,#a78bfa); color:#fff; box-shadow:0 8px 24px rgba(167,139,250,.35) }
    .btn-duel{ background:linear-gradient(135deg,#f87171,#ef4444); color:#fff; box-shadow:0 8px 24px rgba(239,68,68,.35) }
    .chip{ display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; border-radius:999px; font-size:.85rem; font-weight:700; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:10rem }
    .divider{ height:1px; width:100%; background:rgba(255,255,255,.20); margin:.75rem 0 }
    .choice{ width:100%; text-align:right; padding:1rem 1.1rem; border-radius:1rem; border:1px solid rgba(255,255,255,.20); background:rgba(255,255,255,.10); transition:all .2s ease; display:flex; align-items:center; gap:.75rem; min-height:44px }
    .choice:hover{ background:rgba(255,255,255,.20); transform:translateY(-1px) }
    .choice.correct{ background:rgba(16,185,129,.25); border-color:rgba(16,185,129,.7); box-shadow:0 0 18px rgba(16,185,129,.35) }
    .choice.wrong{ background:rgba(244,63,94,.25); border-color:rgba(244,63,94,.7); box-shadow:0 0 18px rgba(244,63,94,.35) }
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:70; padding:1rem }
    .modal.show{ display:grid }
    .sheet{ position:fixed; inset-inline:0; bottom:0; transform:translateY(100%); transition:transform .35s ease; z-index:60 }
    .sheet.show{ transform:translateY(0) }
    .confetti{ position:fixed; inset:0; pointer-events:none; z-index:80 }
    .selected-setup-item { background: linear-gradient(135deg, var(--accent1), var(--accent2)) !important; color: #111827 !important; border-color: transparent !important; font-weight: 700; box-shadow: 0 0 15px rgba(251, 146, 60, 0.4) !important; }
    .leaderboard-tab { transition: all 0.3s ease; position: relative; cursor:pointer; }
    .leaderboard-tab.active { background: rgba(255, 255, 255, 0.2); border-radius: 0.75rem; }
    .leaderboard-tab.active::after { content: ''; position: absolute; bottom: -0.5rem; right: 50%; transform: translateX(50%); width: 50%; height: 3px; background: linear-gradient(90deg, var(--accent1), var(--accent2)); border-radius: 3px 3px 0 0; }
    .detail-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: var(--card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--cardBorder); border-radius: 1.5rem; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); z-index: 100; max-width: 90%; width: 400px; max-height: 90vh; overflow-y: auto; opacity: 0; transition: all 0.3s ease; padding: 1.5rem; }
    .detail-popup.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .detail-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 99; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
    .detail-overlay.show { opacity: 1; pointer-events: all; }
    .match-card { background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05)); border-radius: 1.5rem; padding: 1.25rem; margin-bottom: 1rem; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.1); }
    .match-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2); border-color: rgba(255, 255, 255, 0.2); }
    .duel-avatars { display: flex; justify-content: space-between; align-items: center; margin: 1rem 0; }
    .duel-avatar { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
    .duel-vs { font-size: 1.5rem; font-weight: 800; color: var(--accent2); }
    .location-card { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 1rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.15); transition: all 0.3s ease; cursor: pointer; min-height:44px }
    .location-card:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-3px); }
    .location-icon { width: 3rem; height: 3rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
    .province-icon { background: linear-gradient(135deg, #34d399, #10b981); }
    .group-icon { background: linear-gradient(135deg, #c084fc, #a78bfa); }
    .rank-badge{
      width:2.5rem; height:2.5rem; border-radius:0.75rem;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size:1rem;
      background:rgba(255,255,255,0.15);
      border:1px solid rgba(255,255,255,0.3);
    }
    .match-types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .match-type-card { background: rgba(255, 255, 255, 0.1); border-radius: 1rem; padding: 1rem; text-align: center; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(255, 255, 255, 0.15); min-height:44px }
    .match-type-card:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-5px); }
    .match-type-card.active { background: linear-gradient(135deg, var(--accent1), var(--accent2)); color: #111827; border-color: transparent; }
    .match-type-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .active-matches { margin-top: 1.5rem; }
    .active-match-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-radius: 1rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.15); margin-bottom: 0.75rem; transition: all 0.3s ease; min-height:44px }
    .active-match-item:hover { background: rgba(255, 255, 255, 0.2); }
    .match-info { display: flex; align-items: center; gap: 0.75rem; }
    .match-avatar { width: 2.5rem; height: 2.5rem; border-radius: 50%; object-fit: cover; }
    .match-details { display: flex; flex-direction: column; }
    .match-name { font-weight: 700; }
    .match-status { font-size: 0.75rem; opacity: 0.8; }
    .match-action { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 700; background: linear-gradient(135deg, var(--accent1), var(--accent2)); color: #111827; cursor: pointer; transition: all 0.2s ease; min-height:44px }
    .match-action:hover { transform: scale(1.05); }
    /* Ads: fixed placeholders to keep CLS at 0 */
    .ad-banner-slot{ position:sticky; bottom:56px; /* leave room for bottom nav */ height:var(--adBannerH); z-index:40; }
    .ad-banner-inner{ height:100%; max-width:420px; margin:0 auto; display:flex; align-items:center; justify-content:center; border-radius:14px; border:1px dashed rgba(255,255,255,.25); background:rgba(0,0,0,.15) }
    .ad-native-slot{ min-height:110px; border-radius:16px; border:1px dashed rgba(255,255,255,.25); background:rgba(0,0,0,.12); display:flex; align-items:center; justify-content:center; }
    .ad-skeleton{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#fff; opacity:.7; font-weight:700; }
    .ad-close{ position:absolute; top:.4rem; left:.4rem; background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.2); width:32px;height:32px;border-radius:999px; display:flex;align-items:center;justify-content:center }
    .interstitial{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:90; padding:1.2rem }
    .interstitial.show{ display:grid }
    .interstitial-card{ position:relative; width:min(420px,96vw); height:min(70vh,520px); border-radius:20px; overflow:hidden; }
    .rewarded{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:90; padding:1.2rem }
    .rewarded.show{ display:grid }
    .rewarded-card{ position:relative; width:min(420px,96vw); height:min(70vh,520px); border-radius:20px; overflow:hidden; }
    .vip-frame{ box-shadow:0 0 0 3px rgba(251,191,36,.9), 0 0 20px rgba(251,191,36,.35) inset; border-radius:999px }
    .province-frame{ box-shadow:0 0 0 3px rgba(16,185,129,.9), 0 0 20px rgba(16,185,129,.35) inset; border-radius:999px }
    @media(min-width:640px){ .ad-banner-slot{ bottom:64px } }
    /* Game Limits UI */
    .limit-card{ background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.15); }
    .limit-bar{ height:8px; width:100%; background:rgba(255,255,255,0.2); border-radius:4px; overflow:hidden; margin-top:0.5rem }
    .limit-progress{ height:100%; background:linear-gradient(90deg,var(--accent1),var(--accent2)); border-radius:4px; transition:width 0.5s ease }
    /* Province Pass */
    .pass-card{ background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.15); }
    .pass-free{ border-left:3px solid var(--accent3) }
    .pass-premium{ border-left:3px solid var(--accent1) }
    .mission-item{ display:flex; align-items:center; justify-content:space-between; padding:0.75rem; background:rgba(255,255,255,0.1); border-radius:0.75rem; margin-bottom:0.5rem }
    .mission-item.completed{ opacity:0.6 }
    .mission-reward{ font-size:0.8rem; display:flex; align-items:center; gap:0.25rem }
    /* Referral */
    .referral-code{ background:rgba(255,255,255,0.1); border-radius:0.75rem; padding:0.75rem 1rem; font-family:monospace; font-size:1.1rem; text-align:center; margin:0.5rem 0 }
    .referral-tier{ display:flex; align-items:center; justify-content:space-between; padding:0.75rem; background:rgba(255,255,255,0.1); border-radius:0.75rem; margin-bottom:0.5rem }
    /* Support & Advertisers */
    .form-group{ margin-bottom:1rem }
    .form-label{ display:block; margin-bottom:0.5rem; font-weight:500 }
    .form-input{ width:100%; padding:0.75rem; border-radius:0.75rem; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:var(--text); min-height:44px }
    .form-textarea{ width:100%; padding:0.75rem; border-radius:0.75rem; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:var(--text); min-height:100px; resize:vertical }
    .ticket-item{ background:rgba(255,255,255,0.1); border-radius:0.75rem; padding:1rem; margin-bottom:0.75rem }
    .ticket-status{ display:inline-block; padding:0.25rem 0.5rem; border-radius:999px; font-size:0.75rem; font-weight:700 }
    .status-open{ background:rgba(251,191,36,0.2); color:var(--accent1) }
    .status-closed{ background:rgba(16,185,129,0.2); color:#10b981 }
    .status-pending{ background:rgba(167,139,250,0.2); color:#a78bfa }
    .advertiser-form{ background:rgba(255,255,255,0.05); padding:1.5rem; border-radius:1.5rem; border:1px solid rgba(255,255,255,0.2); }
    .advertiser-form .form-input,
    .advertiser-form .form-textarea,
    .advertiser-form select{
      background:rgba(255,255,255,0.15);
      border:1px solid rgba(255,255,255,0.3);
      transition:all .3s ease;
    }
    .advertiser-form .form-input:focus,
    .advertiser-form .form-textarea:focus,
    .advertiser-form select:focus{
      background:rgba(255,255,255,0.25);
      border-color:var(--accent1);
      box-shadow:0 0 0 3px rgba(251,146,60,0.4);
      outline:none;
    }
    /* Loading skeleton */
    .skeleton{ background:linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%); background-size:200% 100%; animation:skeleton-loading 1.5s infinite }
    @keyframes skeleton-loading{ 0%{ background-position:200% 0 } 100%{ background-position:-200% 0 } }
    .skeleton-text{ height:1rem; border-radius:0.25rem; margin-bottom:0.5rem }
    .skeleton-title{ height:1.5rem; width:70%; border-radius:0.25rem; margin-bottom:1rem }
    .skeleton-button{ height:44px; border-radius:1rem; width:100% }
    /* Loading Screen */
    #loading{ position:fixed; inset:0; background:linear-gradient(135deg, var(--brand1), var(--brand2), var(--brand3)); display:flex; align-items:center; justify-content:center; z-index:9999; flex-direction:column; gap:1rem; transition:opacity 0.5s ease; }
    #loading.hidden{ opacity:0; pointer-events:none; }
    .loading-spinner{ width:60px; height:60px; border:4px solid rgba(255,255,255,0.3); border-top:4px solid white; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{ 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

    /* --- Shop refresh --- */
.ribbon {
  position:absolute; top:.5rem; left:.5rem;
  background:linear-gradient(135deg,var(--accent1),var(--accent2));
  color:#111827; font-weight:800; font-size:.75rem; padding:.25rem .6rem;
  border-radius:999px; box-shadow:0 8px 24px rgba(251,146,60,.35)
}
#pkg-grid{ grid-auto-rows:1fr; }
.product-card { position:relative; }
.product-card:disabled { opacity:.55; cursor:not-allowed; }



/* Enhanced Payment Modal */
.payment-modal {
  position: fixed;
  inset: 0;
  display: none;
  place-items: center;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  z-index: 100;
  padding: 1rem;
  animation: fadeIn 0.3s ease;
}

.payment-modal.show {
  display: grid;
}

.payment-modal-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
  backdrop-filter: blur(30px);
  -webkit-backdrop-filter: blur(30px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 2rem;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-width: 420px;
  width: 100%;
  padding: 2rem;
  position: relative;
  overflow: hidden;
  animation: slideUp 0.4s ease;
}

.payment-modal-card::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(251, 146, 60, 0.1), transparent 70%);
  animation: rotate 20s linear infinite;
}

@keyframes slideUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.payment-header {
  text-align: center;
  margin-bottom: 2rem;
  position: relative;
  z-index: 1;
}

.payment-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 1rem;
  background: linear-gradient(135deg, var(--accent1), var(--accent2));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  color: #111827;
  box-shadow: 0 10px 30px rgba(251, 146, 60, 0.3);
  animation: pulse 2s infinite;
}

.payment-details {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 1rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  position: relative;
  z-index: 1;
}

.payment-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.payment-row:last-child {
  border-bottom: none;
}

.payment-label {
  opacity: 0.8;
  font-size: 0.9rem;
}

.payment-value {
  font-weight: 700;
  font-size: 1.1rem;
}

.payment-warning {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 0.75rem;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: none;
  position: relative;
  z-index: 1;
}

.payment-warning.show {
  display: block;
  animation: shake 0.5s ease;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.payment-actions {
  display: flex;
  gap: 1rem;
  position: relative;
  z-index: 1;
}

.payment-success-animation {
  position: absolute;
  inset: 0;
  display: none;
  place-items: center;
  background: rgba(16, 185, 129, 0.1);
  z-index: 10;
}

.payment-success-animation.show {
  display: grid;
}



/* --- Province select fixes --- */
#modal-province-select { z-index: 120 !important; }        /* Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø¨Ù‚ÛŒÙ‡ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ */
#modal-province-select .glass { overflow: visible !important; }
#first-province { pointer-events: auto; }                  /* Ø§Ú¯Ø± Ù„Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ø±ÙˆÛŒ select Ø¨ÙˆØ¯ */


  </style>
</head>
<body class="min-h-screen text-white flex flex-col">

  <!-- Loading Screen -->
  <div id="loading">
    <div class="loading-spinner"></div>
    <div class="text-2xl font-bold">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
  </div>
  <!-- Header -->
  <header class="glass sticky top-0 z-30 w-full px-4 py-3 flex items-center justify-between shadow-lg">
    <div class="flex items-center gap-3">
      <div class="relative">
        <img id="hdr-avatar" src="https://i.pravatar.cc/80?img=12" class="w-12 h-12 rounded-full border-2 border-white/30 shadow-md" alt="avatar" />
        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
      </div>
      <div>
        <div id="hdr-name" class="font-bold text-lg">Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†</div>
        <div class="text-xs text-white/80 flex items-center gap-2 flex-wrap">
          <span class="flex items-center gap-1"><i class="fas fa-star text-yellow-300"></i> Ø§Ù…ØªÛŒØ§Ø²: <b id="hdr-score">Û°</b></span>
          <span class="flex items-center gap-1" title="Ø³Ú©Ù‡ Ø¨Ø§Ø²ÛŒ"><i class="fas fa-coins text-yellow-300"></i> <b id="hdr-gcoins">Û°</b></span>
          <!-- Wallet (server) -->
          <span class="flex items-center gap-1" title="Ú©ÛŒÙ Ù¾ÙˆÙ„ (Ø³Ø±ÙˆØ±)"><i class="fas fa-wallet text-emerald-300"></i> <b id="hdr-wallet">â€”</b></span>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <span id="vip-badge" class="chip bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold hidden" aria-live="polite">ÙˆÛŒâ€ŒØ¢ÛŒâ€ŒÙ¾ÛŒ</span>
      <button type="button" id="btn-theme" class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 text-sm hover:bg-white/20 transition-all" title="ØªÙ…" aria-label="ØªØºÛŒÛŒØ± ØªÙ…">
        <i class="fas fa-moon"></i>
      </button>
      <button type="button" id="btn-settings" class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 text-sm hover:bg-white/20 transition-all" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª" aria-label="ØªÙ†Ø¸ÛŒÙ…Ø§Øª">
        <i class="fas fa-sliders-h"></i>
      </button>
      <button type="button" id="btn-notify" class="relative px-3 py-2 rounded-xl bg-white/10 border border-white/20 text-sm hover:bg-white/20 transition-all" title="Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§" aria-label="Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§">
        <i class="fas fa-bell"></i>
        <span id="notif-dot" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs">Û³</span>
      </button>
    </div>
  </header>
  <!-- Banner Ad Placeholder (CLS-safe) -->
  <div id="ad-banner" class="ad-banner-slot safe">
    <div class="ad-banner-inner relative overflow-hidden max-w-md">
      <div class="ad-skeleton w-full text-center select-none">Ù…Ø­Ù„ Ø¨Ù†Ø± Û³Û²Û°Ã—ÛµÛ°/Û±Û°Û°</div>
    </div>
  </div>
  <!-- Pages -->
  <main id="pages" class="flex-1 w-full max-w-md mx-auto p-4 space-y-5">
    <!-- DASHBOARD -->
    <section id="page-dashboard" class="space-y-5">
      <!-- Profile -->
      <div class="glass rounded-3xl p-6 shadow-xl card-hover">
        <div class="flex items-center gap-4 mb-4">
          <div class="relative">
            <img id="profile-avatar" src="https://i.pravatar.cc/120?img=12" class="w-20 h-20 rounded-full border-4 border-white/30 shadow-lg" alt="avatar" />
            <div class="absolute bottom-0 right-0 w-8 h-8 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center border-2 border-white">
              <i class="fas fa-crown text-white text-sm"></i>
            </div>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <h2 id="profile-name" class="text-2xl font-extrabold">Ø²Ú©ÛŒ</h2>
              <span id="vip-chip" class="chip bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold hidden">ÙˆÛŒâ€ŒØ¢ÛŒâ€ŒÙ¾ÛŒ</span>
            </div>
            <div class="text-sm text-white/80 flex flex-col gap-1 mt-1">
              <div class="flex items-center gap-1">
                <i class="fas fa-flag text-yellow-300"></i>
                <span>Ø±ØªØ¨Ù‡ Ú©Ø´ÙˆØ±ÛŒ: <span id="rank-country" class="font-bold">â€”</span></span>
              </div>
              <div class="flex items-center gap-1">
                <i class="fas fa-map-marker-alt text-emerald-300"></i>
                <span>Ø±ØªØ¨Ù‡ Ø§Ø³ØªØ§Ù†: <span id="rank-province" class="font-bold">â€”</span></span>
              </div>
              <div class="flex items-center gap-1">
                <i class="fas fa-location-dot text-sky-300"></i>
                <span>Ø§Ø³ØªØ§Ù† Ø´Ù…Ø§: <span id="user-province">â€”</span></span>
              </div>
              <div id="btn-view-group" class="flex items-center gap-1 cursor-pointer hover:underline">
                <i class="fas fa-users text-blue-300"></i>
                <span>Ú¯Ø±ÙˆÙ‡ Ø´Ù…Ø§: <span id="user-group">â€”</span></span>
              </div>
              <div class="flex items-center gap-1">
                <i class="fas fa-swords text-rose-300"></i>
                <div class="flex flex-wrap items-center gap-2">
                  <span class="chip text-green-300 bg-green-500/20 border-green-500/30"><i class="fas fa-trophy"></i><span id="duel-wins">Û°</span> Ø¨Ø±Ø¯</span>
                  <span class="chip text-rose-300 bg-rose-500/20 border-rose-500/30"><i class="fas fa-skull"></i><span id="duel-losses">Û°</span> Ø¨Ø§Ø®Øª</span>
                </div>
              </div>
            </div>
          </div>
          <button id="btn-edit-profile" class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20 transition">ÙˆÛŒØ±Ø§ÛŒØ´</button>
        </div>
        <div class="divider"></div>
        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="glass rounded-2xl p-4 card-hover">
            <div class="text-2xl font-extrabold text-yellow-300" id="stat-score">Û°</div>
            <div class="text-xs opacity-80 mt-1">Ø§Ù…ØªÛŒØ§Ø²</div>
          </div>
          <div class="glass rounded-2xl p-4 card-hover" title="Ø³Ú©Ù‡ Ø¨Ø§Ø²ÛŒ (Ù„ÙˆÚ©Ø§Ù„)">
            <div class="text-2xl font-extrabold text-emerald-300" id="stat-coins">Û°</div>
            <div class="text-xs opacity-80 mt-1">Ø³Ú©Ù‡ Ø¨Ø§Ø²ÛŒ</div>
          </div>
          <div class="glass rounded-2xl p-4 card-hover">
            <div class="text-2xl font-extrabold text-rose-300" id="stat-lives">Û³</div>
            <div class="text-xs opacity-80 mt-1">Ú©Ù„ÛŒØ¯</div>
          </div>
          <div class="glass rounded-2xl p-4 card-hover col-span-3" title="Ú©ÛŒÙ Ù¾ÙˆÙ„ (Ø³Ø±ÙˆØ±)">
            <div class="flex items-center justify-between">
              <div class="text-sm opacity-90 flex items-center gap-2">
                <i class="fas fa-wallet text-emerald-300"></i>
                <span>Ú©ÛŒÙ Ù¾ÙˆÙ„</span>
              </div>
              <div class="text-xl font-extrabold" id="stat-wallet">â€”</div>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2">
              <button id="go-wallet" class="btn btn-primary text-sm w-full px-4 py-3" aria-label="Ø±ÙØªÙ† Ø¨Ù‡ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡"><i class="fas fa-coins ml-2"></i> Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡</button>
              <button id="go-vip" class="btn btn-tertiary text-sm w-full px-4 py-3" aria-label="Ø±ÙØªÙ† Ø¨Ù‡ Ø§Ø´ØªØ±Ø§Ú© VIP"><i class="fas fa-crown ml-2"></i> Ø§Ø´ØªØ±Ø§Ú© VIP</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Game Limits -->
      <div class="glass rounded-3xl p-5 card-hover">
        <div class="flex items-center justify-between mb-3">
          <div class="text-lg font-bold flex items-center gap-2">
            <i class="fas fa-hourglass-half text-amber-300"></i>
            <span>Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</span>
          </div>
          <div class="text-xs opacity-80" id="daily-reset-timer">Ø±ÛŒØ³Øª Ø¯Ø± Û²Û³:ÛµÛ¹:ÛµÛ¹</div>
        </div>
        
        <div class="space-y-3">
          <!-- Matches Limit -->
          <div class="limit-card">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <i class="fas fa-gamepad text-purple-300"></i>
                <span>Ù…Ø³Ø§Ø¨Ù‚Ù‡</span>
              </div>
              <span class="text-sm"><span id="matches-used">0</span>/<span id="matches-limit">5</span></span>
            </div>
            <div class="limit-bar">
              <div id="matches-progress" class="limit-progress" style="width:0%"></div>
            </div>
          </div>

          <!-- Duel Limit -->
          <div class="limit-card">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <i class="fas fa-hand-fist text-rose-400"></i>
                <span>Ù†Ø¨Ø±Ø¯ ØªÙ† Ø¨Ù‡ ØªÙ†</span>
              </div>
              <span class="text-sm"><span id="duels-used">0</span>/<span id="duels-limit">3</span></span>
            </div>
            <div class="limit-bar">
              <div id="duels-progress" class="limit-progress" style="width:0%"></div>
            </div>
            <div class="mt-3">
              <button id="btn-reset-duel-limit" class="btn btn-secondary text-sm w-full py-2">
                <i class="fas fa-key ml-1"></i> Ø­Ø°Ù Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¨Ø§ 10 Ú©Ù„ÛŒØ¯
              </button>
            </div>
          </div>
        </div>
        
        <!-- Limit Reached CTAs (hidden by default) -->
        <div id="limit-reached-ctas" class="hidden mt-4 space-y-2">
          <div class="text-center text-sm opacity-90 mb-2">Ø¨Ù‡ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡ Ø±Ø³ÛŒØ¯ÛŒ!</div>
          <button id="btn-buy-vip-limit" class="btn btn-tertiary text-sm w-full px-4 py-3">
            <i class="fas fa-crown ml-2"></i> Ø®Ø±ÛŒØ¯ VIP Ùˆ Ø§ÙØ²Ø§ÛŒØ´ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§
          </button>
          <button id="btn-reset-limits" class="btn btn-secondary text-sm w-full px-4 py-3">
            <i class="fas fa-key ml-2"></i> Ø­Ø°Ù Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¨Ø§ 10 Ú©Ù„ÛŒØ¯
          </button>
        </div>
      </div>
      
      <!-- Native Ad (CLS-safe placeholder) -->
      <div id="ad-native-dashboard" class="ad-native-slot relative overflow-hidden">
        <div class="ad-skeleton">ØªØ¨Ù„ÛŒØº Ù‡Ù…Ø³Ø§Ù†</div>
      </div>
      
      <!-- Daily -->
      <div class="glass rounded-3xl p-5 card-hover">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm opacity-90 flex items-center gap-1">
              <i class="fas fa-bolt text-yellow-300"></i>
              <span>Ú†Ø§Ù„Ø´ Ø±ÙˆØ²</span>
            </div>
            <div class="text-lg font-bold">Ûµ Ø³Ø¤Ø§Ù„ ØªØµØ§Ø¯ÙÛŒ â€¢ Ø¬Ø§ÛŒØ²Ù‡: ÛµÛ°ğŸ’°</div>
          </div>
          <button id="btn-daily" class="btn btn-primary w-auto px-6 py-3">Ø´Ø±ÙˆØ¹</button>
        </div>
      </div>
      
      <!-- Streak -->
      <div class="glass rounded-3xl p-5 card-hover">
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="text-sm opacity-90 flex items-center gap-1">
              <i class="fas fa-fire text-orange-400"></i>
              <span>Ø§Ø³ØªØ±ÛŒÚ© Ø±ÙˆØ²Ø§Ù†Ù‡</span>
            </div>
            <div class="text-2xl font-extrabold"><span id="streak">Û°</span> Ø±ÙˆØ²</div>
          </div>
          <button id="btn-claim-streak" class="btn btn-primary w-auto px-5 py-2 pulse" aria-label="Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ©">
            <i class="fas fa-gift ml-1"></i> Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø¯Ø§Ø´
          </button>
        </div>
        <div class="w-full h-3 bg-white/15 rounded-full mt-3 overflow-hidden">
          <div id="streak-bar" class="h-3 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
        <div class="text-xs mt-3 opacity-80 flex items-start gap-1">
          <i class="fas fa-info-circle mt-0.5"></i>
          <span>Ù‡Ø± Ø±ÙˆØ² ÙˆØ§Ø±Ø¯ Ø¨Ø´ÛŒ Ù¾Ø§Ø¯Ø§Ø´ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒØ› Ø§Ú¯Ø± Ø¬Ø§ Ø¨Ù…ÙˆÙ†ÛŒ ØµÙØ± Ù…ÛŒâ€ŒØ´Ù‡ ğŸ˜¬</span>
        </div>
      </div>
      
      <!-- Province Ranking -->
      <div class="glass rounded-3xl p-5 card-hover">
        <div class="flex items-center justify-between mb-4">
          <div class="text-lg font-bold flex items-center gap-2">
            <i class="fas fa-flag text-green-300"></i>
            <span>Ø±ØªØ¨Ù‡ Ø§Ø³ØªØ§Ù† Ø´Ù…Ø§</span>
          </div>
          <div class="text-xs opacity-80">ÙØµÙ„ Û± â€¢ Ù‡ÙØªÙ‡ Û±</div>
        </div>

        <div id="province-top" class="grid grid-cols-2 gap-3 mb-4"></div>
        <div id="my-province-rank" class="flex justify-center mb-4"></div>
        <div class="text-sm text-center opacity-80 mb-4">
          Ù‡Ø± Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒØ¯ØŒ Ú¯Ø§Ù…ÛŒ Ø¨Ø±Ø§ÛŒ ØµØ¹ÙˆØ¯ Ø§Ø³ØªØ§Ù†â€ŒØªØ§Ù† Ø¨Ù‡ Ø±ØªØ¨Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø³Øª.
        </div>

        <button id="btn-view-ranking" class="btn btn-province w-full">
          <i class="fas fa-ranking-star ml-2"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
        </button>
      </div>
      
      <!-- Match Types -->
      <div class="glass rounded-3xl p-5">
        <h3 class="text-xl font-extrabold mb-4 flex items-center gap-2">
          <i class="fas fa-gamepad text-purple-300"></i>
          <span>Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</span>
        </h3>
        <div class="match-types">
          <div class="match-type-card" data-match="duel">
            <div class="match-type-icon text-red-400">
              <i class="fas fa-hand-fist"></i>
            </div>
            <div class="font-bold">Ù†Ø¨Ø±Ø¯ Ø¨Ø§ Ø¯ÙˆØ³ØªØ§Ù†</div>
          </div>
          <div class="match-type-card" data-match="province">
            <div class="match-type-icon text-green-400">
              <i class="fas fa-map-marked-alt"></i>
            </div>
            <div class="font-bold">Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ø³ØªØ§Ù†ÛŒ</div>
          </div>
          <div class="match-type-card" data-match="group">
            <div class="match-type-icon text-purple-400">
              <i class="fas fa-users"></i>
            </div>
            <div class="font-bold">Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ú¯Ø±ÙˆÙ‡ÛŒ</div>
          </div>
        </div>
        <div class="active-matches">
          <div class="text-sm font-bold mb-2 opacity-90">Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙØ¹Ø§Ù„</div>
          <div class="active-match-item">
            <div class="match-info">
              <img src="https://i.pravatar.cc/50?img=3" class="match-avatar" alt="opponent">
              <div class="match-details">
                <div class="match-name">Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ</div>
                <div class="match-status">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø®</div>
              </div>
            </div>
            <button class="match-action">Ù¾Ø°ÛŒØ±ÙØªÙ†</button>
          </div>
          <div class="active-match-item">
            <div class="match-info">
              <div class="location-icon province-icon">
                <i class="fas fa-map-marked-alt"></i>
              </div>
              <div class="match-details">
                <div class="match-name">Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ø³ØªØ§Ù† Ú©Ø±Ø¯Ø³ØªØ§Ù†</div>
                <div class="match-status">Ø´Ø±ÙˆØ¹ Ø¯Ø± Û²Û°:Û°Û°</div>
              </div>
            </div>
            <button class="match-action">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
          </div>
        </div>
      </div>
      
      <!-- Quick -->
      <div class="space-y-4">
        <button class="btn btn-primary text-lg" id="btn-play">
          <i class="fas fa-gamepad ml-2"></i> Ø´Ø±ÙˆØ¹ Ú©ÙˆÛŒÛŒØ²
        </button>
        <div class="grid grid-cols-2 gap-4">
          <button type="button" class="btn btn-secondary" id="btn-shop" data-tab="shop">
            <i class="fas fa-shopping-cart ml-2"></i> ÙØ±ÙˆØ´Ú¯Ø§Ù‡
          </button>
          <button type="button" class="btn btn-tertiary" id="btn-leaderboard" data-tab="leaderboard">
            <i class="fas fa-chart-line ml-2"></i> Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯
          </button>
        </div>
        <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-invite">
          <i class="fas fa-user-plus"></i>
          <span>Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù† (+Ø³Ú©Ù‡)</span>
        </button>
      </div>
      
      <!-- Sponsor (also used as native fallback) -->
      <div class="glass rounded-3xl p-4 text-center text-sm" id="sponsor-card">
        <div class="flex items-center justify-center gap-2">
          <i class="fas fa-bolt text-yellow-300"></i>
          <span>Ø§Ø³Ù¾Ø§Ù†Ø³Ø± Ø§Ù…Ø±ÙˆØ²: <span class="font-bold">Ú©Ø§ÙÙ‡ XYZ</span></span>
        </div>
        <div class="mt-2">
          Ú©Ø¯ ØªØ®ÙÛŒÙ: <span class="font-mono bg-white/20 px-2 py-1 rounded">SANANDAJ10</span>
        </div>
      </div>
      <button id="btn-advertisers" class="btn btn-tertiary w-full">
        ØªØ¨Ù„ÛŒØºâ€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù†
      </button>
    </section>
    
    <!-- QUIZ -->
    <section id="page-quiz" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6 shadow-xl">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2 text-sm gap-2">
          <div class="flex items-center gap-2 flex-wrap justify-center sm:justify-start">
            <span id="quiz-cat" class="chip"><i class="fas fa-folder ml-1"></i> Ø¹Ù…ÙˆÙ…ÛŒ</span>
            <span id="quiz-diff" class="chip"><i class="fas fa-signal ml-1"></i> Ø¢Ø³Ø§Ù†</span>
            <span class="chip"><i class="fas fa-hashtag ml-1"></i> <span id="qnum">Û±</span>/<span id="qtotal">Ûµ</span></span>
          </div>
          <div class="flex items-center gap-2 justify-center sm:justify-end">
            <span class="chip"><i class="fas fa-key text-yellow-400 ml-1"></i> <span id="lives">Û³</span></span>
            <span class="chip"><i class="fas fa-coins text-yellow-300 ml-1"></i> <span id="coins">Û°</span></span>
          </div>
        </div>
        <div id="duel-banner" class="hidden mb-2 flex items-center justify-center">
          <span class="chip"><i class="fas fa-hand-fist text-red-400 ml-1"></i><span id="duel-opponent-name"></span></span>
        </div>
        <div class="mt-2 flex items-center justify-center">
          <div class="relative w-[140px] h-[140px]">
            <svg width="140" height="140" viewBox="0 0 140 140" class="-rotate-90 block">
              <circle cx="70" cy="70" r="64" stroke="rgba(255,255,255,.2)" stroke-width="12" fill="none"/>
              <circle id="timer-ring" cx="70" cy="70" r="64" stroke="url(#gradient)" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="402.124" stroke-dashoffset="0"/>
              <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#fde047" />
                  <stop offset="100%" stop-color="#fb923c" />
                </linearGradient>
              </defs>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="text-3xl font-extrabold leading-none" id="timer-text">Û³Û°</div>
            </div>
          </div>
        </div>
        <h3 id="question" class="text-xl font-bold mt-4 leading-8 text-center"></h3>
      </div>
      
      <!-- Lifelines -->
      <div class="grid grid-cols-3 gap-2 sm:gap-3">
        <button id="life-5050" class="w-full py-3 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition text-[0.65rem] sm:text-sm flex items-center justify-center gap-2">
          <i class="fas fa-percent"></i> ÛµÛ°â€“ÛµÛ°
        </button>
        <button id="life-skip" class="w-full py-3 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition text-[0.65rem] sm:text-sm flex items-center justify-center gap-2">
          <i class="fas fa-forward"></i> Ù¾Ø±Ø´ Ø±Ùˆ Ø¨Ù‡ Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ
        </button>
        <button id="life-pause" class="w-full py-3 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition text-[0.65rem] sm:text-sm flex items-center justify-center gap-2">
          <i class="fas fa-pause"></i> Ù…Ú©Ø«
        </button>
      </div>
      
      <div id="choices" class="space-y-4"></div>
      
      <div class="flex flex-col sm:flex-row items-center gap-4">
        <button id="btn-quit" class="w-full sm:flex-1 py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2">
          <i class="fas fa-arrow-right"></i> Ø®Ø±ÙˆØ¬
        </button>
        <button id="btn-continue" class="hidden w-full sm:flex-1 py-4 rounded-2xl bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold flex items-center justify-center gap-2">
          <i class="fas fa-coins"></i> Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ Û±Û°ğŸ’°
        </button>
      </div>
    </section>
    
    <!-- RESULTS -->
    <section id="page-results" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6 text-center">
        <div class="text-2xl font-extrabold mb-2">Ù†ØªÛŒØ¬Ù‡Ù” Ù…Ø³Ø§Ø¨Ù‚Ù‡</div>
        <div class="text-sm opacity-80 mb-4">Ø®Ù„Ø§ØµÙ‡Ù” Ø¹Ù…Ù„Ú©Ø±Ø¯Øª ğŸ‘‡</div>
        <!-- Duel result (shown only when playing a duel) -->
        <div id="duel-result" class="hidden mb-4">
          <div class="duel-avatars">
            <div class="duel-avatar">
              <img id="duel-avatar-you" class="w-16 h-16 rounded-full border-2 border-white/30" alt="you">
              <div id="duel-name-you" class="text-sm"></div>
            </div>
            <div class="duel-vs">VS</div>
            <div class="duel-avatar">
              <img id="duel-avatar-opponent" class="w-16 h-16 rounded-full border-2 border-white/30" alt="opponent">
              <div id="duel-name-opponent" class="text-sm"></div>
            </div>
          </div>
          <div id="duel-winner" class="font-bold mt-2"></div>
          <div id="duel-stats" class="text-sm opacity-90 mt-1 leading-6"></div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="glass rounded-2xl p-4">
            <div class="text-xl font-extrabold text-emerald-300" id="res-correct">Û°</div>
            <div class="text-xs opacity-80 mt-1">Ø¯Ø±Ø³Øª</div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="text-xl font-extrabold text-rose-300" id="res-wrong">Û°</div>
            <div class="text-xs opacity-80 mt-1">Ù†Ø§Ø¯Ø±Ø³Øª</div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="text-xl font-extrabold text-yellow-300" id="res-earned">Û°</div>
            <div class="text-xs opacity-80 mt-1">Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨â€ŒØ´Ø¯Ù‡</div>
          </div>
        </div>
        <div class="divider"></div>
        <div id="res-list" class="text-right space-y-2 max-h-64 overflow-auto pr-2"></div>
        <!-- Leaderboard CTA -->
        <div class="mt-4 grid grid-cols-1 gap-3">
          <button id="btn-view-leaderboard" class="btn btn-secondary w-full px-4 py-3" aria-label="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ">
            <i class="fas fa-trophy ml-2"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
          </button>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <button id="btn-share" class="btn btn-secondary"><i class="fas fa-share-nodes ml-2"></i> Ø§Ø´ØªØ±Ø§Ú© Ù†ØªÛŒØ¬Ù‡</button>
        <button id="btn-again" class="btn btn-primary"><i class="fas fa-rotate-left ml-2"></i> Ø¨Ø§Ø²ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡</button>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-results">
        <i class="fas fa-home"></i> Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡
      </button>
    </section>
    
    <!-- LEADERBOARD -->
    <section id="page-leaderboard" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-trophy text-yellow-300"></i>
          <span>Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ Ù‡ÙØªÚ¯ÛŒ</span>
        </h3>
        <!-- ØªØ¨â€ŒÙ‡Ø§ÛŒ Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ -->
        <div class="flex justify-between mb-6 bg-white/10 rounded-xl p-1">
          <button type="button" class="leaderboard-tab flex-1 py-2 px-3 rounded-lg text-center font-medium active" data-tab="individual">
            Ø§ÙØ±Ø§Ø¯
          </button>
          <button type="button" class="leaderboard-tab flex-1 py-2 px-3 rounded-lg text-center font-medium" data-tab="province">
            Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§
          </button>
          <button type="button" class="leaderboard-tab flex-1 py-2 px-3 rounded-lg text-center font-medium" data-tab="group">
            Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§
          </button>
        </div>
        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ -->
        <div id="lb-individual" class="lb-content">
          <div id="lb-list" class="space-y-3"></div>
          <!-- Native ad inline -->
          <div id="ad-native-lb" class="ad-native-slot mt-4 relative overflow-hidden">
            <div class="ad-skeleton">ØªØ¨Ù„ÛŒØº Ù‡Ù…Ø³Ø§Ù†</div>
          </div>
        </div>
        <div id="lb-province" class="lb-content hidden">
          <div id="my-province-rank-lb" class="flex justify-center mb-4"></div>
          <div id="province-list" class="space-y-3"></div>
        </div>
        <div id="lb-group" class="lb-content hidden">
          <div id="group-list" class="space-y-3"></div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-lb">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
      </button>
    </section>
    
    <!-- SHOP -->
<!-- SHOP (Minimal) -->
<section id="page-shop" class="hidden space-y-5">
  <div class="glass rounded-3xl overflow-hidden">
    <!-- Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ -->
    <div class="bg-white/10 border-b border-white/15 px-5 py-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
      <div class="flex items-center gap-2 flex-wrap">
        <span class="chip"><i class="fas fa-coins ml-1"></i> Ø³Ú©Ù‡ Ø¨Ø§Ø²ÛŒ: <b id="shop-gcoins">Û°</b></span>
        <span class="chip"><i class="fas fa-wallet ml-1"></i> Ú©ÛŒÙ Ù¾ÙˆÙ„: <b id="shop-wallet">â€”</b></span>
      </div>
      <button id="btn-open-wallet" class="btn btn-primary w-full sm:w-auto px-4 py-2 text-sm"><i class="fas fa-plus-circle ml-1"></i> Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„</button>
    </div>

    <!-- Ù…Ø­ØªÙˆØ§ -->
    <div class="p-5 space-y-6">
      <!-- Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-lg font-extrabold flex items-center gap-2">
            <i class="fas fa-key text-pink-300"></i><span>Ú©Ù„ÛŒØ¯Ù‡Ø§</span>
          </h4>
          <span class="chip"><i class="fas fa-key ml-1"></i> Ø´Ù…Ø§: <b id="keys-count">Û°</b></span>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
          <!-- k1 -->
          <button class="product-card glass-dark rounded-2xl p-3 border border-white/15 hover:bg-white/15 transition text-right min-h-[92px] flex flex-col justify-between" data-buy-key="k1" title="Ø®Ø±ÛŒØ¯ Û± Ú©Ù„ÛŒØ¯">
            <div class="text-xs opacity-80">Ø¨Ø³ØªÙ‡ Ú©ÙˆÚ†Ú©</div>
            <div class="font-extrabold text-lg"><span data-amount>Û±</span> Ú©Ù„ÛŒØ¯</div>
            <div class="text-xs opacity-90"><i class="fas fa-coins text-yellow-300 ml-1"></i> <span data-price>Û³Û°</span> Ø³Ú©Ù‡</div>
          </button>

          <!-- k3 -->
          <button class="product-card glass-dark rounded-2xl p-3 border border-white/15 hover:bg-white/15 transition text-right min-h-[92px] flex flex-col justify-between" data-buy-key="k3" title="Ø®Ø±ÛŒØ¯ Û³ Ú©Ù„ÛŒØ¯">
            <div class="ribbon">Ø¨Ù‡â€ŒØµØ±ÙÙ‡</div>
            <div class="text-xs opacity-80">Ø¨Ø³ØªÙ‡ Ø§Ù‚ØªØµØ§Ø¯ÛŒ</div>
            <div class="font-extrabold text-lg"><span data-amount>Û³</span> Ú©Ù„ÛŒØ¯</div>
            <div class="text-xs opacity-90"><i class="fas fa-coins text-yellow-300 ml-1"></i> <span data-price>Û¸Û°</span> Ø³Ú©Ù‡</div>
          </button>

          <!-- k10 -->
          <button class="product-card glass-dark rounded-2xl p-3 border border-white/15 hover:bg-white/15 transition text-right min-h-[92px] flex flex-col justify-between" data-buy-key="k10" title="Ø®Ø±ÛŒØ¯ Û±Û° Ú©Ù„ÛŒØ¯">
            <div class="text-xs opacity-80">Ø¨Ø³ØªÙ‡ Ø¨Ø²Ø±Ú¯</div>
            <div class="font-extrabold text-lg"><span data-amount>Û±Û°</span> Ú©Ù„ÛŒØ¯</div>
            <div class="text-xs opacity-90"><i class="fas fa-coins text-yellow-300 ml-1"></i> <span data-price>Û²ÛµÛ°</span> Ø³Ú©Ù‡</div>
          </button>
        </div>

        <div class="text-xs opacity-70 mt-2">Ú©Ù„ÛŒØ¯ Ø¨Ø§ Â«Ø³Ú©Ù‡Ù” Ø¨Ø§Ø²ÛŒÂ» Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒØ´Ù‡ØŒ Ù†Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„.</div>
      </div>

      <!-- VIP -->
      <div class="glass-dark rounded-2xl p-5 card-hover">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 text-center sm:text-right">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center">
              <i class="fas fa-crown text-white text-xl"></i>
            </div>
            <div>
              <div class="font-bold text-lg">Ø§Ø´ØªØ±Ø§Ú© VIP</div>
              <div class="text-sm opacity-80 mt-1">Ø­Ø°Ù ØªØ¨Ù„ÛŒØºØ§Øª â€¢ Ø³Ù‚Ù Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨ÛŒØ´ØªØ± â€¢ Ø§Ù…ØªÛŒØ§Ø² Ø§Ø¶Ø§ÙÙ‡</div>
            </div>
          </div>
          <button id="btn-open-vip" class="btn btn-tertiary w-full sm:w-auto px-4 text-sm"><i class="fas fa-crown ml-1"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ù„Ù†â€ŒÙ‡Ø§</button>
        </div>
      </div>

      <!-- Coins (Wallet) -->
      <div class="glass-dark rounded-2xl p-5 card-hover">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 text-center sm:text-right">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-full bg-gradient-to-r from-emerald-400 to-green-500 flex items-center justify-center">
              <i class="fas fa-wallet text-white text-xl"></i>
            </div>
            <div>
              <div class="font-bold text-lg">Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ (Ú©ÛŒÙ Ù¾ÙˆÙ„)</div>
              <div class="text-sm opacity-80 mt-1">Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Û±Û°Û°/ÛµÛ°Û°/Û±Û²Û°Û°/Û³Û°Û°Û° Ø¨Ø§ Ø¨ÙˆÙ†ÙˆØ³</div>
            </div>
          </div>
          <button id="btn-open-wallet-2" class="btn btn-primary w-full sm:w-auto px-4 text-sm"><i class="fas fa-coins ml-1"></i> Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡</button>
        </div>
      </div>
    </div>
  </div>

  <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-shop">
    <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
  </button>
</section>


    
    <!-- WALLET (Buy Coins) -->
    <section id="page-wallet" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-2xl font-extrabold flex items-center gap-2">
            <i class="fas fa-wallet text-emerald-300"></i>
            <span>Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡</span>
          </h3>
          <div class="chip" title="Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ (Ø³Ø±ÙˆØ±)"><i class="fas fa-coins text-yellow-300 ml-1"></i> <b id="wallet-balance">â€”</b></div>
        </div>
        <div id="wallet-offline" class="hidden bg-rose-500/20 border border-rose-400/40 text-rose-50 text-sm rounded-xl p-3 mb-3">
          <i class="fas fa-wifi-slash ml-1"></i> Ø¢ÙÙ„Ø§ÛŒÙ† Ù‡Ø³ØªÛŒØ› Ø®Ø±ÛŒØ¯ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.
        </div>
        <div id="pkg-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
        <div class="text-xs opacity-80 mt-3">Ù¾Ø³ Ø§Ø² Ø§ÛŒØ¬Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´ØŒ Ù†ØªÛŒØ¬Ù‡ Ø§Ø² Ø³Ø±ÙˆØ± ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡ Ùˆ Ø±Ø³ÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†.</div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-wallet">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
      </button>
    </section>
    
    <!-- VIP Subscription -->
    <section id="page-vip" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-2xl font-extrabold flex items-center gap-2">
            <i class="fas fa-crown text-yellow-300"></i>
            <span>Ø§Ø´ØªØ±Ø§Ú© ÙˆÛŒâ€ŒØ¢ÛŒâ€ŒÙ¾ÛŒ</span>
          </h3>
          <div id="vip-status-pill" class="chip"><i class="fas fa-circle-notch fa-spin ml-1"></i> Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª...</div>
        </div>
        <div class="mt-3 grid grid-cols-1 gap-3">
          <!-- VIP Lite -->
          <div class="glass-dark rounded-2xl p-4">
            <div class="flex justify-between items-center mb-2">
              <div class="font-bold text-lg flex items-center gap-2">
                <i class="fas fa-crown text-amber-300"></i>
                <span>ÙˆÛŒâ€ŒØ¢ÛŒâ€ŒÙ¾ÛŒ Ù„Ø§ÛŒØª</span>
              </div>
              <div class="font-bold">Û¹Û¹,Û°Û°Û° ØªÙˆÙ…Ø§Ù† / Ù…Ø§Ù‡</div>
            </div>
            <ul class="text-sm opacity-90 space-y-1 list-disc pr-5 mb-3">
              <li>Ø­Ø°Ù ØªØ¨Ù„ÛŒØºØ§Øª Ø¨Ù†Ø±ÛŒ</li>
              <li>Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡ Ù…Ø³Ø§Ø¨Ù‚Ù‡/Ú©Ù„ÛŒØ¯</li>
            </ul>
            <button id="buy-vip-lite" class="btn btn-secondary w-full" aria-label="Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú© VIP Ù„Ø§ÛŒØª">Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©</button>
          </div>
          
          <!-- VIP Pro -->
          <div class="glass-dark rounded-2xl p-4 border-2 border-amber-400/30">
            <div class="flex justify-between items-center mb-2">
              <div class="font-bold text-lg flex items-center gap-2">
                <i class="fas fa-crown text-yellow-300"></i>
                <span>ÙˆÛŒâ€ŒØ¢ÛŒâ€ŒÙ¾ÛŒ Ù¾Ø±Ùˆ</span>
              </div>
              <div class="font-bold">Û±Û¹Û¹,Û°Û°Û° ØªÙˆÙ…Ø§Ù† / Ù…Ø§Ù‡</div>
            </div>
            <ul class="text-sm opacity-90 space-y-1 list-disc pr-5 mb-3">
              <li>Ø­Ø°Ù ØªÙ…Ø§Ù… ØªØ¨Ù„ÛŒØºØ§Øª (Ø¨Ù†Ø±ÛŒØŒ Ù‡Ù…Ø³Ø§Ù†ØŒ Ù…ÛŒØ§Ù†ÛŒØŒ ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ)</li>
              <li>Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡ Ù…Ø³Ø§Ø¨Ù‚Ù‡/Ú©Ù„ÛŒØ¯</li>
              <li>Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</li>
              <li>Ù‚Ø§Ø¨ Ø¢ÙˆØ§ØªØ§Ø± ÙˆÛŒÚ˜Ù‡ Ø§Ø³ØªØ§Ù†</li>
              <li>Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø³Ø§Ø¨Ù‚Ù‡/Ú©Ù„ÛŒØ¯</li>
            </ul>
            <button id="buy-vip-pro" class="btn btn-primary w-full" aria-label="Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú© VIP Ù¾Ø±Ùˆ">Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©</button>
          </div>
          
          <div id="vip-meta" class="text-sm opacity-90"></div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-vip">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
      </button>
    </section>
    
    <!-- DUEL SETUP -->
    <section id="page-duel" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-hand-fist text-red-400"></i>
          <span>Ù†Ø¨Ø±Ø¯ Ø¨Ø§ Ø¯ÙˆØ³ØªØ§Ù†</span>
        </h3>
        <div class="space-y-4">
          <div class="text-center">
            <p class="mb-4">Ø¯ÙˆØ³Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ø¨Ø±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
            <div class="flex flex-wrap justify-center gap-3 mb-4">
              <button id="btn-duel-random" class="btn btn-duel w-auto px-5 py-2 flex items-center gap-2">
                <i class="fas fa-shuffle"></i><span>Ø­Ø±ÛŒÙ ØªØµØ§Ø¯ÙÛŒ</span>
              </button>
              <button id="btn-duel-link" class="btn btn-tertiary w-auto px-5 py-2 flex items-center gap-2">
                <i class="fas fa-link"></i><span>Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª</span>
              </button>
            </div>
            <div id="duel-friends-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-duel">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
      </button>
    </section>
    
    <!-- PROVINCE SETUP -->
    <section id="page-province" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-map-marked-alt text-green-400"></i>
          <span>Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ø³ØªØ§Ù†ÛŒ</span>
        </h3>
        <div class="space-y-4">
          <div class="text-center">
            <p class="mb-4">Ø§Ø³ØªØ§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
            <div class="space-y-3 max-h-80 overflow-y-auto pr-2">
              <div class="location-card" data-province="1">
                <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
                <div class="flex-1">
                  <div class="font-bold">ØªÙ‡Ø±Ø§Ù†</div>
                  <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>Û±Û²Û´ Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</span></div>
                </div>
                <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> Û±Û¸,ÛµÛ°Û°</div>
              </div>
              <div class="location-card" data-province="2">
                <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
                <div class="flex-1">
                  <div class="font-bold">Ø§ØµÙÙ‡Ø§Ù†</div>
                  <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>Û¹Û¸ Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</span></div>
                </div>
                <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> Û±Ûµ,Û²Û°Û°</div>
              </div>
              <div class="location-card" data-province="3">
                <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
                <div class="flex-1">
                  <div class="font-bold">Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ</div>
                  <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>Û±Û±Û² Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</span></div>
                </div>
                <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> Û±Û¶,Û¸Û°Û°</div>
              </div>
              <div class="location-card" data-province="4">
                <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
                <div class="flex-1">
                  <div class="font-bold">ÙØ§Ø±Ø³</div>
                  <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>Û¸Û· Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</span></div>
                </div>
                <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> Û±Û´,Û³Û°Û°</div>
              </div>
              <div class="location-card" data-province="5">
                <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
                <div class="flex-1">
                  <div class="font-bold">Ú©Ø±Ø¯Ø³ØªØ§Ù†</div>
                  <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>Û±Û°Ûµ Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</span></div>
                </div>
                <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> Û±Ûµ,Û¹Û°Û°</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-province">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
      </button>
    </section>
    
    <!-- GROUP SETUP -->
    <section id="page-group" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-users text-purple-400"></i>
          <span>Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ú¯Ø±ÙˆÙ‡ÛŒ</span>
        </h3>
        <div class="space-y-4">
          <div class="text-center">
            <p class="mb-4">Ú¯Ø±ÙˆÙ‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
            <button id="btn-create-group" class="btn btn-group w-full mb-4"><i class="fas fa-plus ml-2"></i> Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯</button>
            <div id="group-select-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-group">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
      </button>
    </section>
    
    <!-- PROVINCE PASS MISSIONS -->
    <section id="page-pass-missions" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-2xl font-extrabold flex items-center gap-2">
            <i class="fas fa-flag text-green-300"></i>
            <span>Ù…Ø£Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù† Ù¾Ø§Ø³</span>
          </h3>
          <div class="text-xs opacity-80">ÙØµÙ„ Û± â€¢ Ù‡ÙØªÙ‡ Û±</div>
        </div>
        
        <div class="mb-6">
          <h4 class="font-bold mb-3 flex items-center gap-2">
            <i class="fas fa-calendar-day text-blue-300"></i>
            <span>Ù…Ø£Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</span>
          </h4>
          <div class="space-y-2">
            <div class="mission-item">
              <div>
                <div class="font-medium">Ø¨Ø±Ù†Ø¯Ù‡ Û³ Ù…Ø³Ø§Ø¨Ù‚Ù‡</div>
                <div class="text-xs opacity-70">Ù¾Ø§Ø¯Ø§Ø´: Û±Û° XP Ø±Ø§ÛŒÚ¯Ø§Ù† + Ûµ XP Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-star text-yellow-300"></i>
                <span>Û°/Û³</span>
              </div>
            </div>
            <div class="mission-item">
              <div>
                <div class="font-medium">Ù¾Ø§Ø³Ø® Ø¨Ù‡ Û±Û° Ø³Ø¤Ø§Ù„</div>
                <div class="text-xs opacity-70">Ù¾Ø§Ø¯Ø§Ø´: Ûµ XP Ø±Ø§ÛŒÚ¯Ø§Ù† + Û³ XP Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-star text-yellow-300"></i>
                <span>Û°/Û±Û°</span>
              </div>
            </div>
            <div class="mission-item completed">
              <div>
                <div class="font-medium">Ø§Ø´ØªØ±Ø§Ú© Ù†ØªÛŒØ¬Ù‡ Ø¯Ø± Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ</div>
                <div class="text-xs opacity-70">Ù¾Ø§Ø¯Ø§Ø´: Ûµ XP Ø±Ø§ÛŒÚ¯Ø§Ù† + Û³ XP Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-check-circle text-green-300"></i>
                <span>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯</span>
              </div>
            </div>
          </div>
        </div>
        
        <div>
          <h4 class="font-bold mb-3 flex items-center gap-2">
            <i class="fas fa-calendar-week text-purple-300"></i>
            <span>Ù…Ø£Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù‡ÙØªÚ¯ÛŒ</span>
          </h4>
          <div class="space-y-2">
            <div class="mission-item">
              <div>
                <div class="font-medium">Ú©Ø³Ø¨ ÛµÛ°Û° Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø± Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ø³ØªØ§Ù†ÛŒ</div>
                <div class="text-xs opacity-70">Ù¾Ø§Ø¯Ø§Ø´: Û²Û° XP Ø±Ø§ÛŒÚ¯Ø§Ù† + Û±Ûµ XP Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-star text-yellow-300"></i>
                <span>Û°/ÛµÛ°Û°</span>
              </div>
            </div>
            <div class="mission-item">
              <div>
                <div class="font-medium">Ø¯Ø¹ÙˆØª Û² Ø¯ÙˆØ³Øª Ø¬Ø¯ÛŒØ¯</div>
                <div class="text-xs opacity-70">Ù¾Ø§Ø¯Ø§Ø´: Û±Ûµ XP Ø±Ø§ÛŒÚ¯Ø§Ù† + Û±Û° XP Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-star text-yellow-300"></i>
                <span>Û°/Û²</span>
              </div>
            </div>
            <div class="mission-item">
              <div>
                <div class="font-medium">Ø®Ø±ÛŒØ¯ Ø§Ø² ÙØ±ÙˆØ´Ú¯Ø§Ù‡ (Ù‡Ø± Ø¢ÛŒØªÙ…ÛŒ)</div>
                <div class="text-xs opacity-70">Ù¾Ø§Ø¯Ø§Ø´: Û±Û° XP Ø±Ø§ÛŒÚ¯Ø§Ù† + Û±Û° XP Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-star text-yellow-300"></i>
                <span>Û°/Û±</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-pass-missions">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
      </button>
    </section>
    
    <!-- REFERRAL -->
    <section id="page-referral" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-user-plus text-blue-300"></i>
          <span>Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù† Ùˆ Ú©Ø³Ø¨ Ø¬Ø§ÛŒØ²Ù‡</span>
        </h3>
        
        <div class="text-center mb-6">
          <div class="text-lg font-bold mb-2">Ú©Ø¯ Ø¯Ø¹ÙˆØª Ø´Ù…Ø§</div>
          <div class="referral-code">QUIZ5F8A2B</div>
          <button class="btn btn-primary w-full mt-3" id="btn-copy-referral">
            <i class="fas fa-copy ml-2"></i> Ú©Ù¾ÛŒ Ú©Ø¯ Ø¯Ø¹ÙˆØª
          </button>
        </div>
        
        <div class="mb-6">
          <h4 class="font-bold mb-3 flex items-center gap-2">
            <i class="fas fa-gift text-yellow-300"></i>
            <span>Ø¬Ø§ÛŒØ²Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø¹ÙˆØª</span>
          </h4>
          <div class="space-y-3">
            <div class="referral-tier">
              <div>
                <div class="font-medium">Ø¯Ø¹ÙˆØª Ù…Ø³ØªÙ‚ÛŒÙ… (Ø³Ø·Ø­ Û±)</div>
                <div class="text-xs opacity-70">Ù‡Ø± Ø¯ÙˆØ³Øª: ÛµÛ° Ø³Ú©Ù‡</div>
              </div>
              <div class="text-sm font-bold text-yellow-300">Û· Ø±ÙˆØ² Ø§ÙˆÙ„</div>
            </div>
            <div class="referral-tier">
              <div>
                <div class="font-medium">Ø¯Ø¹ÙˆØª ØºÛŒØ±Ù…Ø³ØªÙ‚ÛŒÙ… (Ø³Ø·Ø­ Û²)</div>
                <div class="text-xs opacity-70">Ù‡Ø± Ø¯ÙˆØ³Øª: Û²Û° Ø³Ú©Ù‡</div>
              </div>
              <div class="text-sm font-bold text-yellow-300">Û· Ø±ÙˆØ² Ø§ÙˆÙ„</div>
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <h4 class="font-bold mb-3 flex items-center gap-2">
            <i class="fas fa-users text-green-300"></i>
            <span>Ø¯ÙˆØ³ØªØ§Ù† Ø¯Ø¹ÙˆØª Ø´Ø¯Ù‡</span>
          </h4>
          <div class="space-y-3">
            <div class="glass-dark rounded-2xl p-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img src="https://i.pravatar.cc/50?img=1" class="w-10 h-10 rounded-full border-2 border-white/30" alt="friend">
                <div>
                  <div class="font-bold">Ø³Ø§Ø±Ø§ Ø§Ú©Ø¨Ø±ÛŒ</div>
                  <div class="text-xs opacity-70">Û² Ø±ÙˆØ² Ù¾ÛŒØ´</div>
                </div>
              </div>
              <div class="text-sm font-bold text-green-300">+ÛµÛ°ğŸ’°</div>
            </div>
            <div class="glass-dark rounded-2xl p-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img src="https://i.pravatar.cc/50?img=2" class="w-10 h-10 rounded-full border-2 border-white/30" alt="friend">
                <div>
                  <div class="font-bold">Ø±Ø¶Ø§ Ú©Ø±ÛŒÙ…ÛŒ</div>
                  <div class="text-xs opacity-70">Ûµ Ø±ÙˆØ² Ù¾ÛŒØ´</div>
                </div>
              </div>
              <div class="text-sm font-bold text-green-300">+ÛµÛ°ğŸ’°</div>
            </div>
          </div>
        </div>
        
        <div class="text-center">
          <button class="btn btn-secondary w-full" id="btn-share-referral">
            <i class="fas fa-share-nodes ml-2"></i> Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª
          </button>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-referral">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
      </button>
    </section>
    
    <!-- SUPPORT & ADVERTISERS -->
    <section id="page-support" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-headset text-blue-300"></i>
          <span>Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ùˆ ØªØ¨Ù„ÛŒØºØ§Øª</span>
        </h3>
        
        <!-- Tabs -->
        <div class="flex justify-between mb-6 bg-white/10 rounded-xl p-1">
          <button class="support-tab flex-1 py-2 px-3 rounded-lg text-center font-medium active" data-tab="support">
            Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ
          </button>
          <button class="support-tab flex-1 py-2 px-3 rounded-lg text-center font-medium" data-tab="advertiser">
            ØªØ¨Ù„ÛŒØºâ€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù†
          </button>
        </div>
        
        <!-- Support Content -->
        <div id="support-content" class="tab-content">
          <div class="mb-6">
            <h4 class="font-bold mb-3 flex items-center gap-2">
              <i class="fas fa-ticket-alt text-amber-300"></i>
              <span>Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</span>
            </h4>
            <form id="support-form" class="space-y-4">
              <div class="form-group">
                <label class="form-label" for="support-name">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
                <input type="text" id="support-name" class="form-input" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="support-mobile">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label>
                <input type="tel" id="support-mobile" class="form-input" placeholder="Û°Û¹Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="support-message">Ù¾ÛŒØ§Ù…</label>
                <textarea id="support-message" class="form-textarea" placeholder="Ù…Ø´Ú©Ù„ ÛŒØ§ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." required></textarea>
              </div>
              <button type="submit" class="btn btn-primary w-full">
                <i class="fas fa-paper-plane ml-2"></i> Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª
              </button>
            </form>
          </div>
          
          <div>
            <h4 class="font-bold mb-3 flex items-center gap-2">
              <i class="fas fa-history text-purple-300"></i>
              <span>ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</span>
            </h4>
            <div id="tickets-list" class="space-y-3">
              <div class="ticket-item">
                <div class="flex justify-between items-start mb-1">
                  <div class="font-bold">Ù…Ø´Ú©Ù„ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø®Øª</div>
                  <span class="ticket-status status-pending">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ</span>
                </div>
                <div class="text-xs opacity-70 mb-2">Û±Û´Û°Û²/Û°Ûµ/Û±Û°</div>
                <div class="text-sm">Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ Ø§Ù…Ø§ Ø³Ú©Ù‡â€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù†Ø¯...</div>
              </div>
              <div class="ticket-item">
                <div class="flex justify-between items-start mb-1">
                  <div class="font-bold">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª</div>
                  <span class="ticket-status status-closed">Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡</span>
                </div>
                <div class="text-xs opacity-70 mb-2">Û±Û´Û°Û²/Û°Û´/Û²Ûµ</div>
                <div class="text-sm">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø³ØªÙ‡ Ø³ÙˆØ§Ù„Ø§Øª Ø¬Ø¯ÛŒØ¯...</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Advertiser Content -->
        <div id="advertiser-content" class="tab-content hidden">
          <div class="mb-6 glass rounded-2xl p-6">
            <h4 class="font-bold mb-4 flex items-center gap-2">
              <i class="fas fa-bullhorn text-green-300"></i>
              <span>Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ¨Ù„ÛŒØº</span>
            </h4>
            <form id="advertiser-form" class="space-y-4 advertiser-form">
              <div class="form-group">
                <label class="form-label" for="ad-placement">Ù†ÙˆØ¹ ØªØ¨Ù„ÛŒØº</label>
                <select id="ad-placement" class="form-input" required>
                  <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                  <option value="banner">Ø¨Ù†Ø±ÛŒ</option>
                  <option value="native">Ù‡Ù…Ø³Ø§Ù†</option>
                  <option value="interstitial">Ù…ÛŒØ§Ù†ÛŒ</option>
                  <option value="rewarded">ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="ad-budget">Ø¨ÙˆØ¯Ø¬Ù‡ (ØªÙˆÙ…Ø§Ù†)</label>
                <input type="number" id="ad-budget" class="form-input" placeholder="Ù…Ø«Ø§Ù„: ÛµÛ°Û°Û°Û°Û°Û°" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="ad-provinces">Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§ÛŒ Ù‡Ø¯Ù</label>
                <select id="ad-provinces" class="form-input" multiple required>
                  <option value="ØªÙ‡Ø±Ø§Ù†">ØªÙ‡Ø±Ø§Ù†</option>
                  <option value="Ø§ØµÙÙ‡Ø§Ù†">Ø§ØµÙÙ‡Ø§Ù†</option>
                  <option value="Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ">Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ</option>
                  <option value="ÙØ§Ø±Ø³">ÙØ§Ø±Ø³</option>
                  <option value="Ú©Ø±Ø¯Ø³ØªØ§Ù†">Ú©Ø±Ø¯Ø³ØªØ§Ù†</option>
                  <option value="Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ">Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ</option>
                  <option value="Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† ØºØ±Ø¨ÛŒ">Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† ØºØ±Ø¨ÛŒ</option>
                  <option value="Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†">Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†</option>
                  <option value="Ú¯ÛŒÙ„Ø§Ù†">Ú¯ÛŒÙ„Ø§Ù†</option>
                  <option value="Ø®ÙˆØ²Ø³ØªØ§Ù†">Ø®ÙˆØ²Ø³ØªØ§Ù†</option>
                </select>
                <div class="text-xs opacity-70 mt-1">Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú†Ù†Ø¯ Ø§Ø³ØªØ§Ù†ØŒ Ú©Ù„ÛŒØ¯ Ctrl Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯</div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div class="form-group">
                  <label class="form-label" for="ad-start">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
                  <input type="date" id="ad-start" class="form-input" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="ad-end">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</label>
                  <input type="date" id="ad-end" class="form-input" required>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label" for="ad-creative">Ù„ÛŒÙ†Ú© Ú©Ø±ÛŒØªÛŒÙˆ</label>
                <input type="url" id="ad-creative" class="form-input" placeholder="https://example.com/ad-image.jpg" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="ad-landing">Ù„ÛŒÙ†Ú© Ù…Ù‚ØµØ¯</label>
                <input type="url" id="ad-landing" class="form-input" placeholder="https://example.com" required>
              </div>
              <button type="submit" class="btn btn-primary w-full">
                <i class="fas fa-paper-plane ml-2"></i> Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
              </button>
            </form>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-support">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
      </button>
    </section>
  </main>
  
  <!-- Bottom Nav -->
  <nav class="glass safe sticky bottom-0 z-50 w-full shadow-lg">
    <div class="max-w-md mx-auto grid grid-cols-5">
      <button class="py-4 text-center hover:bg-white/10 transition nav-item" data-tab="dashboard" aria-label="Ø®Ø§Ù†Ù‡">
        <i class="fas fa-home text-xl mb-1"></i>
        <div class="text-xs">Ø®Ø§Ù†Ù‡</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition nav-item" data-tab="quiz" aria-label="Ù…Ø³Ø§Ø¨Ù‚Ù‡">
        <i class="fas fa-gamepad text-xl mb-1"></i>
        <div class="text-xs">Ù…Ø³Ø§Ø¨Ù‚Ù‡</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition nav-item" data-tab="leaderboard" aria-label="Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯">
        <i class="fas fa-chart-line text-xl mb-1"></i>
        <div class="text-xs">Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition nav-item" data-tab="shop" aria-label="ÙØ±ÙˆØ´Ú¯Ø§Ù‡">
        <i class="fas fa-store text-xl mb-1"></i>
        <div class="text-xs">ÙØ±ÙˆØ´Ú¯Ø§Ù‡</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition nav-item" data-tab="support" aria-label="Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ">
        <i class="fas fa-headset text-xl mb-1"></i>
        <div class="text-xs">Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</div>
      </button>
    </div>
  </nav>
  
  <!-- Setup Sheet -->
  <div id="sheet-setup" class="sheet">
    <div class="glass rounded-t-3xl p-5 max-w-md mx-auto">
      <div class="flex items-center justify-between mb-3">
        <div class="text-xl font-extrabold">Ø´Ø±ÙˆØ¹ Ú©ÙˆÛŒÛŒØ²</div>
        <button id="setup-close" class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20"><i class="fas fa-times"></i></button>
      </div>
      <div class="grid grid-cols-3 gap-2 mb-4" id="cat-wrap"></div>
      <div class="grid grid-cols-3 gap-2 mb-4" id="diff-wrap"></div>
      <div class="flex items-center justify-between text-sm mb-3 opacity-90">
        <div>ØªØ¹Ø¯Ø§Ø¯ Ø³Ø¤Ø§Ù„: <span id="setup-count">Ûµ</span></div>
        <input id="range-count" type="range" min="3" max="12" value="5" class="w-48" aria-label="ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„">
      </div>
      <button id="setup-start" class="btn btn-primary"><i class="fas fa-play ml-2"></i> Ø´Ø±ÙˆØ¹</button>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div id="modal-settings" class="modal">
    <div class="glass rounded-3xl p-5 w-full max-w-md">
      <div class="flex items-center justify-between mb-4">
        <div class="text-xl font-extrabold">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
        <button class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20" data-close="#modal-settings"><i class="fas fa-times"></i></button>
      </div>
      <div class="space-y-3">
        <label class="flex items-center justify-between">
          <span>ØµØ¯Ø§</span>
          <input type="checkbox" id="set-sound" class="w-5 h-5 accent-emerald-400">
        </label>
        <label class="flex items-center justify-between">
          <span>Ù„Ø±Ø²Ø´</span>
          <input type="checkbox" id="set-haptics" class="w-5 h-5 accent-emerald-400">
        </label>
        <label class="flex items-center justify-between">
          <span>ØªÙ… Ø´Ø¨ (Night)</span>
          <input type="checkbox" id="set-theme" class="w-5 h-5 accent-emerald-400">
        </label>
      </div>
      <div class="divider"></div>
      <button id="btn-clear" class="w-full py-3 rounded-xl bg-white/10 border border-white/20">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Ø±ÛŒØ³Øª)</button>
    </div>
  </div>
  
  <!-- Notifications Modal -->
  <div id="modal-notify" class="modal">
    <div class="glass rounded-3xl p-5 w-full max-w-md">
      <div class="flex items-center justify-between mb-4">
        <div class="text-xl font-extrabold">Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</div>
        <button class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20" data-close="#modal-notify"><i class="fas fa-times"></i></button>
      </div>
      <div id="notif-list" class="space-y-3 text-sm"></div>
    </div>
  </div>

  <!-- Province Select Modal -->
  <div id="modal-province-select" class="modal">
    <div class="glass rounded-3xl p-5 w-full max-w-md text-center">
      <div class="text-xl font-extrabold mb-4">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù†</div>
      <select id="first-province" class="w-full p-3 rounded-xl bg-white/10 border border-white/20 mb-4">
        <option value="" disabled selected>Ø§Ø³ØªØ§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
      </select>
      <button id="btn-confirm-province" class="btn btn-province">ØªØ§ÛŒÛŒØ¯</button>
    </div>
  </div>

  <!-- Province Coming Soon Modal -->
  <div id="modal-province-soon" class="modal">
    <div class="glass rounded-3xl p-5 w-full max-w-md text-center">
      <div class="flex items-center justify-between mb-4">
        <div class="text-xl font-extrabold">Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ø³ØªØ§Ù†ÛŒ</div>
        <button class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20" data-close="#modal-province-soon"><i class="fas fa-times"></i></button>
      </div>
      <div class="mb-4">Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
      <button class="btn btn-primary" data-close="#modal-province-soon">Ø¨Ø§Ø´Ù‡</button>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="modal-profile" class="modal">
    <div class="glass rounded-3xl p-5 w-full max-w-md">
      <div class="flex items-center justify-between mb-4">
        <div class="text-xl font-extrabold">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</div>
        <button class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20" data-close="#modal-profile"><i class="fas fa-times"></i></button>
      </div>
      <div class="space-y-3">
        <label class="block text-sm opacity-90">Ù†Ø§Ù…</label>
        <input id="inp-name" class="w-full p-3 rounded-xl bg-white/10 border border-white/20" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
        <label class="block text-sm opacity-90">Ø§Ø³ØªØ§Ù†</label>
        <select id="sel-province" class="w-full p-3 rounded-xl bg-white/10 border border-white/20" disabled></select>
        <label class="block text-sm opacity-90">Ú¯Ø±ÙˆÙ‡ Ø´Ù…Ø§</label>
        <div id="lbl-group" class="w-full p-3 rounded-xl bg-white/10 border border-white/20"></div>
        <label class="block text-sm opacity-90">Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</label>
        <input id="inp-avatar" type="file" accept="image/*" class="w-full p-3 rounded-xl bg-white/10 border border-white/20">
      </div>
      <div class="divider"></div>
      <button id="btn-save-profile" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
    </div>
  </div>
  
  <!-- Transaction Receipt Modal -->
  <div id="modal-receipt" class="modal" aria-modal="true" role="dialog" aria-label="Ø±Ø³ÛŒØ¯ ØªØ±Ø§Ú©Ù†Ø´">
    <div class="glass rounded-3xl p-5 w-full max-w-md relative">
      <div class="flex items-center justify-between mb-3">
        <div class="text-xl font-extrabold">Ø±Ø³ÛŒØ¯ ØªØ±Ø§Ú©Ù†Ø´</div>
        <button class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20" data-close="#modal-receipt"><i class="fas fa-times"></i></button>
      </div>
      <div id="receipt-body" class="space-y-2 text-sm"></div>
      <div class="divider"></div>
      <button class="btn btn-primary" data-close="#modal-receipt">Ø¨Ø§Ø´Ù‡</button>
    </div>
  </div>

  <!-- Payment Confirm Modal -->
<!-- Enhanced Payment Modal -->
<div id="modal-payment" class="payment-modal" aria-modal="true" role="dialog" aria-label="ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª">
  <div class="payment-modal-card">
    <div class="payment-header">
      <div class="payment-icon">
        <i class="fas fa-coins"></i>
      </div>
      <h3 class="text-2xl font-extrabold mb-2">ØªØ§ÛŒÛŒØ¯ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡</h3>
      <p class="text-sm opacity-80">Ù„Ø·ÙØ§Ù‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø±ÛŒØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯</p>
    </div>
    
    <div class="payment-details">
      <div class="payment-row">
        <span class="payment-label">Ø¨Ø³ØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ</span>
        <span class="payment-value" id="payment-package-name">-</span>
      </div>
      <div class="payment-row">
        <span class="payment-label">ØªØ¹Ø¯Ø§Ø¯ Ø³Ú©Ù‡</span>
        <span class="payment-value text-yellow-300" id="payment-coins-amount">-</span>
      </div>
      <div class="payment-row">
        <span class="payment-label">Ù‚ÛŒÙ…Øª</span>
        <span class="payment-value" id="payment-price">-</span>
      </div>
      <div class="payment-row">
        <span class="payment-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„</span>
        <span class="payment-value" id="payment-wallet-balance">-</span>
      </div>
    </div>
    
    <div class="payment-warning" id="payment-warning">
      <div class="flex items-center gap-2">
        <i class="fas fa-exclamation-triangle text-red-400"></i>
        <span>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ù…Ø§ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª. Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù‡Ø¯Ø§ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯.</span>
      </div>
    </div>
    
    <div class="payment-actions">
      <button class="btn glass-dark border-white/20 flex-1" onclick="closePaymentModal()">
        Ø§Ù†ØµØ±Ø§Ù
      </button>
      <button id="payment-confirm-btn" class="btn btn-primary flex-1">
        <i class="fas fa-check ml-2"></i>
        ØªØ§ÛŒÛŒØ¯ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª
      </button>
    </div>
    
    <div class="payment-success-animation">
      <div class="text-center">
        <i class="fas fa-check-circle text-6xl text-green-400 mb-4"></i>
        <p class="text-xl font-bold">Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚!</p>
      </div>
    </div>
  </div>
</div>

  <!-- Interstitial Ad -->
  <div id="modal-interstitial" class="interstitial" aria-modal="true" role="dialog" aria-label="ØªØ¨Ù„ÛŒØº Ù…ÛŒØ§Ù†ÛŒ">
    <div class="interstitial-card glass w-full h-full max-w-md max-h-[80vh]">
      <button id="interstitial-close" class="ad-close" aria-label="Ø¨Ø³ØªÙ† ØªØ¨Ù„ÛŒØº"><i class="fas fa-times"></i></button>
      <iframe id="interstitial-frame" title="Interstitial Ad" class="w-full h-full" sandbox="allow-scripts allow-same-origin" loading="lazy"></iframe>
    </div>
  </div>
  
  <!-- Rewarded Ad -->
  <div id="modal-rewarded" class="rewarded" aria-modal="true" role="dialog" aria-label="ØªØ¨Ù„ÛŒØº ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ">
    <div class="rewarded-card glass w-full h-full max-w-md max-h-[80vh] relative">
      <button id="rewarded-close" class="ad-close" aria-label="Ø¨Ø³ØªÙ† ÙˆÛŒØ¯ÛŒÙˆ"><i class="fas fa-times"></i></button>
      <video id="rewarded-video" class="w-full h-full object-cover" playsinline controls preload="metadata">
        <source src="" type="video/mp4">
      </video>
      <div class="absolute bottom-2 right-2 left-2 flex items-center justify-between">
        <div id="rewarded-countdown" class="chip">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        <button id="rewarded-claim" class="btn btn-primary w-auto px-4 py-2 disabled:opacity-50" disabled aria-label="Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø¯Ø§Ø´">Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø¯Ø§Ø´</button>
      </div>
    </div>
  </div>
  
  <!-- Detail Popup -->
  <div id="detail-popup" class="detail-popup">
    <div class="flex justify-between items-start mb-4">
      <h3 class="text-xl font-extrabold" id="detail-title">Ø¬Ø²Ø¦ÛŒØ§Øª</h3>
      <button id="detail-close" class="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 transition">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="detail-content" class="space-y-4"></div>
  </div>
  <div id="detail-overlay" class="detail-overlay"></div>
  
  <!-- Confetti -->
  <canvas id="confetti" class="confetti"></canvas>
  
  <script>
  // Anti-cheating: Detect devtools
  (function() {
    const threshold = 160;
    const checkDevTools = () => {
      const widthThreshold = window.outerWidth - window.innerWidth > threshold;
      const heightThreshold = window.outerHeight - window.innerHeight > threshold;
      if (widthThreshold || heightThreshold) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø±Ø§ Ø¨Ø¨Ù†Ø¯ÛŒØ¯. ØªÙ‚Ù„Ø¨ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª!');
        window.location.reload();
      }
    };
    setInterval(checkDevTools, 2000);
  })();
  // ===== Helpers =====
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  // Ensure all buttons default to type="button" to avoid unintended form submits
  function ensureButtonType(root=document){
    root.querySelectorAll('button:not([type])').forEach(btn=>btn.type='button');
  }
  ensureButtonType();
  new MutationObserver(m=>{
    m.forEach(mu=>{
      mu.addedNodes.forEach(node=>{
        if(node.nodeType!==Node.ELEMENT_NODE) return;
        if(node.matches && node.matches('button:not([type])')) node.type='button';
        if(node.querySelectorAll) ensureButtonType(node);
      });
    });
  }).observe(document.body,{childList:true,subtree:true});
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const faNum = n => (n===null||n===undefined||Number.isNaN(Number(n))) ? 'â€”' : Number(n).toLocaleString('fa-IR');
  const enNum = n => Number(n).toLocaleString('en-US');
function populateProvinceOptions(selectEl, placeholder){
    if(!selectEl) return;

    // Save the currently selected value if any
    const prevValue = selectEl.value;
    selectEl.innerHTML = '';

    if(placeholder){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = placeholder;
      opt.disabled = true;
      opt.selected = true;
      selectEl.appendChild(opt);
    }

    // Check if provinces exist
    if(!State.provinces || State.provinces.length === 0){
      console.warn('No provinces available to populate');
      return;
    }

    State.provinces
      .slice()
      .sort((a,b)=>a.name.localeCompare(b.name, 'fa'))
      .forEach(p => {
        const option = document.createElement('option');
        option.value = p.name;
        option.textContent = p.name;
        selectEl.appendChild(option);
      });

    // Restore previous selection if it exists
    if(prevValue && Array.from(selectEl.options).some(opt => opt.value === prevValue)){
      selectEl.value = prevValue;
    }
  }





  
  const vibrate = ms => { try{ if(State.settings.haptics && navigator.vibrate) navigator.vibrate(ms) }catch{} };
  const toast = (html, ms=2200) => {
    const t=document.createElement('div');
    t.className='fixed top-20 left-1/2 -translate-x-1/2 glass px-5 py-3 rounded-2xl text-white font-bold z-50 fade-in';
    t.innerHTML=html; document.body.appendChild(t); setTimeout(()=>t.remove(), ms);
  };
  const wait = ms => new Promise(r=>setTimeout(r,ms));
  const online = () => navigator.onLine;
  // Minimal sounds
  const SFX = (()=>{ let ctx; const mk=()=>ctx||(ctx=new (window.AudioContext||window.webkitAudioContext)());
    const beep=(f=880,d=0.12,t='sine')=>{ if(!State.settings.sound) return; const a=mk(); const o=a.createOscillator(); const g=a.createGain();
      o.type=t; o.frequency.value=f; o.connect(g); g.connect(a.destination); g.gain.setValueAtTime(0.001,a.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2,a.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.001,a.currentTime+d);
      o.start(); o.stop(a.currentTime+d+0.02);
    };
    return { correct:()=>{beep(880); setTimeout(()=>beep(1320,0.1,'triangle'),90)}, wrong:()=>beep(160,0.25,'sawtooth'), tick:()=>beep(660,0.05), coin:()=>{beep(1200,0.08); setTimeout(()=>beep(1600,0.08),70)} };
  })();
  function shootConfetti(){
    const canvas = $('#confetti'); const ctx = canvas.getContext('2d');
    const W = canvas.width = innerWidth, H = canvas.height = innerHeight;
    const pieces = Array.from({length: 120}, ()=>({
      x: Math.random()*W, y: -20-Math.random()*H, r: 4+Math.random()*6,
      c: ['#fde047','#fb923c','#a78bfa','#ec4899','#34d399'][Math.floor(Math.random()*5)],
      v: 1+Math.random()*3, a: Math.random()*Math.PI*2
    }));
    let t=0, run=true;
    (function anim(){
      if(!run) return; ctx.clearRect(0,0,W,H);
      for(const p of pieces){
        ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        p.y += p.v; p.x += Math.sin(p.a+t/15); if(p.y>H+10) p.y=-10;
      }
      t++; const id=requestAnimationFrame(anim); setTimeout(()=>{run=false; cancelAnimationFrame(id); ctx.clearRect(0,0,W,H)}, 2200);
    })();
  }
  
  // ===== Remote Config (in-file) =====
// === RemoteConfig (Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡) ===
const RemoteConfig = {
  ab: (Math.random() < 0.5) ? 'A' : 'B',

  provinceTargeting: { enabled: true, allow: ['ØªÙ‡Ø±Ø§Ù†','Ú©Ø±Ø¯Ø³ØªØ§Ù†','Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† ØºØ±Ø¨ÛŒ','Ø§ØµÙÙ‡Ø§Ù†'] },

  ads: {
    enabled: true,
    placements: { banner:true, native:true, interstitial:true, rewarded:true },
    freqCaps: { interstitialPerSession: 2, rewardedPerSession: 3 },
    interstitialCooldownMs: 60_000,
    rewardedMinWatchMs: 7_000,
    session: { interstitialShown: 0, rewardedShown: 0, lastInterstitialAt: 0 }
  },

  pricing: {
    // Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ø¯Ù„Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ù‡ priceToman Ù†Ø¯Ø§Ø´ØªÛŒÙ… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
    usdToToman: 70_000,

    // â† Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯
    coins: [
      { id:'c100',  amount:100,  bonus:0,  priceToman: 59_000,   priceCents:199  },
      { id:'c500',  amount:500,  bonus:5,  priceToman: 239_000,  priceCents:799  },
      { id:'c1200', amount:1200, bonus:12, priceToman: 459_000,  priceCents:1499 },
      { id:'c3000', amount:3000, bonus:25, priceToman: 899_000,  priceCents:2999 }
    ],

    vip: {
      lite: { id:'vip_lite', priceCents:299 },
      pro:  { id:'vip_pro',  priceCents:599 }
    },

    // Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Â«Ú©Ù„ÛŒØ¯Â» (Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ø³Ú©Ù‡Ù” Ø¨Ø§Ø²ÛŒ)
    keys: [
      { id:'k1',  amount:1,  priceGame:30  }, // Ø¨Ø³ØªÙ‡ Ú©ÙˆÚ†Ú©
      { id:'k3',  amount:3,  priceGame:80  }, // Ø¨Ø³ØªÙ‡ Ø§Ù‚ØªØµØ§Ø¯ÛŒ
      { id:'k10', amount:10, priceGame:250 }  // Ø¨Ø³ØªÙ‡ Ø¨Ø²Ø±Ú¯
    ]
  },

  abOverrides: {
    A: { ads:{ freqCaps:{ interstitialPerSession:2 } } },
    B: { ads:{ freqCaps:{ interstitialPerSession:1 } } }
  },

  gameLimits: {
    matches: { daily: 5, vipMultiplier: 2, recoveryTime: 2 * 60 * 60 * 1000 }, // 2 hours
    lives:   { daily: 3, vipMultiplier: 2, recoveryTime: 30 * 60 * 1000 },     // 30 minutes
    energy:  { daily: 10, vipMultiplier: 2, recoveryTime: 15 * 60 * 1000 }     // 15 minutes
  }
};



// === Patch Ø§ÛŒÙ…Ù† Ø¨Ø±Ø§ÛŒ RemoteConfig.pricing.keys ===
// Ø§Ú¯Ø± keys Ù†Ø¨Ø§Ø´Ù‡/Ø®Ø§Ù„ÛŒ ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ù‡ØŒ Ø¨Ø§ Ø¯ÛŒÙØ§Ù„Øªâ€ŒÙ‡Ø§ Ù¾Ø± Ùˆ Ù†Ø±Ù…Ø§Ù„Ø§ÛŒØ² Ù…ÛŒâ€ŒÚ©Ù†Ù‡.
// Ø®Ø±ÙˆØ¬ÛŒ: Ø¢Ø±Ø§ÛŒÙ‡â€ŒÛŒ keys Ù†Ù‡Ø§ÛŒÛŒ (Ù…Ø±ØªØ¨ Ùˆ Ø³Ø§Ù„Ù…)
function patchPricingKeys(RemoteConfig){
  const defaults = [
    { id:'k1',  amount:1,  priceGame:30,  label:'Ø¨Ø³ØªÙ‡ Ú©ÙˆÚ†Ú©'     },
    { id:'k3',  amount:3,  priceGame:80,  label:'Ø¨Ø³ØªÙ‡ Ø§Ù‚ØªØµØ§Ø¯ÛŒ'   },
    { id:'k10', amount:10, priceGame:250, label:'Ø¨Ø³ØªÙ‡ Ø¨Ø²Ø±Ú¯'      }
  ];

  if (!RemoteConfig.pricing) RemoteConfig.pricing = {};

  const packs = RemoteConfig.pricing.keys;
  const bad = (p)=> typeof p?.amount!=='number' || typeof p?.priceGame!=='number' || p.amount<=0 || p.priceGame<=0;

  if (!Array.isArray(packs) || packs.length===0 || packs.some(bad)){
    RemoteConfig.pricing.keys = defaults;
  } else {
    RemoteConfig.pricing.keys = packs
      .map(p => ({
        id: String(p.id || ('k' + p.amount)),
        amount: +p.amount,
        priceGame: +p.priceGame,
        label: p.label || (p.amount<=1 ? 'Ø¨Ø³ØªÙ‡ Ú©ÙˆÚ†Ú©' : p.amount<=3 ? 'Ø¨Ø³ØªÙ‡ Ø§Ù‚ØªØµØ§Ø¯ÛŒ' : 'Ø¨Ø³ØªÙ‡ Ø¨Ø²Ø±Ú¯')
      }))
      .filter(p => p.amount>0 && p.priceGame>0)
      .sort((a,b)=> a.amount - b.amount);
  }

  return RemoteConfig.pricing.keys;
}

// âš¡ï¸ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ¹Ø±ÛŒÙ RemoteConfig ØµØ¯Ø§ Ø¨Ø²Ù†:
patchPricingKeys(RemoteConfig);

  // Merge AB overrides
  (function applyAB(){
    const o = RemoteConfig.abOverrides[RemoteConfig.ab];
    if(!o) return;
    function deepMerge(t,s){ for(const k in s){ if(typeof s[k]==='object'&&s[k]){ t[k]=t[k]||{}; deepMerge(t[k],s[k]); } else { t[k]=s[k]; } } }
    deepMerge(RemoteConfig, o);
  })();
  
  // ===== Analytics =====
  async function logEvent(name, payload={}){
    try{
      await fetch('/api/analytics', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ 
          name, 
          ts: Date.now(), 
          province: Server.user.province,
          vipPlan: Server.subscription.plan,
          vipActive: Server.subscription.active,
          ...payload 
        })
      }).catch(()=>{});
    }catch{}
  }
  
  // ===== Server State (Wallet + Subscription only from server) =====
  const Server = {
    wallet: { coins: null, lastTxnId: null },
    subscription: { active:false, status:'unknown', expiry:null, autoRenew:false, plan:null, tier:null },
    user: { province:'ØªÙ‡Ø±Ø§Ù†' }, // can be set by your auth bootstrap
    limits: {
      matches: { used: 0, lastReset: 0, lastRecovery: 0 },
      lives: { used: 0, lastReset: 0, lastRecovery: 0 },
      energy: { used: 0, lastReset: 0, lastRecovery: 0 }
    },
    pass: {
      freeXp: 0,
      premiumXp: 0,
      season: 1,
      week: 1,
      missions: {
        daily: [],
        weekly: []
      }
    }
  };
  
  // ===== Network (timeouts + JSON helpers) =====
  const Net = {
    async jget(url, timeoutMs=8000){
      const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, {cache:'no-store', signal:ctrl.signal});
        const txt = await res.text(); if(!txt) return null;
        try{ return JSON.parse(txt); }catch{ return null; }
      }catch{ return null; } finally{ clearTimeout(t); }
    },
    async jpost(url, data, timeoutMs=12000){
      const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data), signal:ctrl.signal});
        const txt = await res.text(); if(!txt) return null;
        try{ return JSON.parse(txt); }catch{ return null; }
      }catch{ return null; } finally{ clearTimeout(t); }
    }
  };
  
  // ===== App State (legacy gameplay remains local) =====
  const STORAGE_KEY='quiz_webapp_pro_state_v2_fa';
  const State = {
    user:{ id:'guest', name:'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†', avatar:'https://i.pravatar.cc/120?img=12', province:'', group:'Ù‚Ù‡Ø±Ù…Ø§Ù†Ø§Ù† Ø¯Ø§Ù†Ø´' },
    score:0, coins:120, lives:3, vip:false, // vip will be overridden by server
    streak:0, lastClaim:0, boostUntil:0,
    theme:'ocean',
    duelOpponent:null,
    duelWins:0,
    duelLosses:0,
    achievements:{ firstWin:false, tenCorrect:false, streak3:false, vipBought:false },
    settings:{ sound:true, haptics:true },
    leaderboard:[
      { id:'u1', name:'Ø¢Ø±ØªÛŒÙ†', score:18200, province:'ØªÙ‡Ø±Ø§Ù†', group:'Ù‚Ù‡Ø±Ù…Ø§Ù†Ø§Ù† Ø¯Ø§Ù†Ø´' },
      { id:'u2', name:'Ø³Ù…Ø§Ù†Ù‡', score:16500, province:'Ø§ØµÙÙ‡Ø§Ù†', group:'Ù…ØªÙÚ©Ø±Ø§Ù† Ø¬ÙˆØ§Ù†' },
      { id:'u3', name:'Ù…Ø§Ù†ÛŒ', score:14950, province:'Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ', group:'Ú†Ø§Ù„Ø´â€ŒØ¨Ø±Ø§Ù†Ú¯ÛŒØ²Ø§Ù†' },
      { id:'u4', name:'Ù†ÛŒÚ©Ø§', score:13200, province:'ÙØ§Ø±Ø³', group:'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ù†Ø®Ø¨Ù‡' },
    ],
    provinces: [], // populated from data/provinces.json
    groups: [
      { id: 'g1', name: 'Ù‚Ù‡Ø±Ù…Ø§Ù†Ø§Ù† Ø¯Ø§Ù†Ø´', score: 22100, members: 24, admin: 'Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ', created: 'Û±Û´Û°Û²/Û°Û²/Û±Ûµ', memberList: ['Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†','Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ','Ø³Ø§Ø±Ø§ Ø§Ú©Ø¨Ø±ÛŒ','Ø±Ø¶Ø§ Ú©Ø±ÛŒÙ…ÛŒ'], matches:[{opponent:'Ù…ØªÙÚ©Ø±Ø§Ù† Ø¬ÙˆØ§Ù†', time:'Û±Û´Û°Û³/Û°Ûµ/Û²Ûµ Û±Û¸:Û°Û°'}], requests: [] },
      { id: 'g2', name: 'Ù…ØªÙÚ©Ø±Ø§Ù† Ø¬ÙˆØ§Ù†', score: 19800, members: 18, admin: 'Ø³Ø§Ø±Ø§ Ù…Ø­Ù…Ø¯ÛŒ', created: 'Û±Û´Û°Û²/Û°Û³/Û²Û°', memberList: ['Ø³Ø§Ø±Ø§ Ù…Ø­Ù…Ø¯ÛŒ','Ù…Ù‡Ø¯ÛŒ Ø§Ø­Ù…Ø¯ÛŒ'], matches:[{opponent:'Ù¾ÛŒØ´Ø±ÙˆØ§Ù† Ø¹Ù„Ù…', time:'Û±Û´Û°Û³/Û°Ûµ/Û³Û° Û±Û¹:Û°Û°'}], requests: [] },
      { id: 'g3', name: 'Ú†Ø§Ù„Ø´â€ŒØ¨Ø±Ø§Ù†Ú¯ÛŒØ²Ø§Ù†', score: 20500, members: 21, admin: 'Ø±Ø¶Ø§ Ù‚Ø§Ø³Ù…ÛŒ', created: 'Û±Û´Û°Û²/Û°Û±/Û±Û°', memberList: ['Ø±Ø¶Ø§ Ù‚Ø§Ø³Ù…ÛŒ'], matches:[], requests: [] },
      { id: 'g4', name: 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ù†Ø®Ø¨Ù‡', score: 18700, members: 15, admin: 'Ù…Ø±ÛŒÙ… Ø§Ø­Ù…Ø¯ÛŒ', created: 'Û±Û´Û°Û²/Û°Û´/Û°Ûµ', memberList: ['Ù…Ø±ÛŒÙ… Ø§Ø­Ù…Ø¯ÛŒ'], matches:[], requests: [] },
      { id: 'g5', name: 'Ù¾ÛŒØ´Ø±ÙˆØ§Ù† Ø¹Ù„Ù…', score: 21300, members: 27, admin: 'Ø§Ù…ÛŒØ± Ø­Ø³ÛŒÙ†ÛŒ', created: 'Û±Û´Û°Û²/Û°Û²/Û²Û¸', memberList: ['Ø§Ù…ÛŒØ± Ø­Ø³ÛŒÙ†ÛŒ'], matches:[{opponent:'Ù‚Ù‡Ø±Ù…Ø§Ù†Ø§Ù† Ø¯Ø§Ù†Ø´', time:'Û±Û´Û°Û³/Û°Û¶/Û°Û² Û²Û°:Û°Û°'}], requests: [] },
    ],
    ads: { banner: [], native: [], interstitial: [], rewarded: [] },
    quiz:{
      inProgress:false, answered:false, correctIndex:-1,
      duration:30, remain:30, timer:null,
      list:[], idx:0, cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ø¢Ø³Ø§Ù†',
      sessionEarned:0, results:[]
    },
    notifications:[
      { id:'n1', text:'Ø¬Ø§Ù… Ù‡ÙØªÚ¯ÛŒ Ø§Ø² Ø³Ø§Ø¹Øª Û²Û°:Û°Û° Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒØŸ', time:'Ø§Ù…Ø±ÙˆØ²' },
      { id:'n2', text:'Ø¨Ø³ØªÙ‡Ù” Ø³ÙˆØ§Ù„Ø§Øª Â«Ø§Ø¯Ø¨ÛŒØ§Øª ÙØ§Ø±Ø³ÛŒÂ» Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!', time:'Ø¯ÛŒØ±ÙˆØ²' },
      { id:'n3', text:'Ø¨Ø§ Ø¯Ø¹ÙˆØª Ù‡Ø± Ø¯ÙˆØ³Øª Û²Û°ğŸ’° Ù‡Ø¯ÛŒÙ‡ Ø¨Ú¯ÛŒØ±!', time:'Û² Ø±ÙˆØ² Ù¾ÛŒØ´' }
    ],
    referral: {
      code: 'QUIZ5F8A2B',
      referred: [
        { id: 'u1', name: 'Ø³Ø§Ø±Ø§ Ø§Ú©Ø¨Ø±ÛŒ', date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), reward: 50 },
        { id: 'u2', name: 'Ø±Ø¶Ø§ Ú©Ø±ÛŒÙ…ÛŒ', date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), reward: 50 }
      ]
    }
  };
  
  const cats = ['Ø¹Ù…ÙˆÙ…ÛŒ','Ø¹Ù„Ù…','Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒ Ø§ÛŒØ±Ø§Ù†','Ø§Ø¯Ø¨ÛŒØ§Øª ÙØ§Ø±Ø³ÛŒ','ØªØ§Ø±ÛŒØ® Ø§ÛŒØ±Ø§Ù†','Ø³ÛŒÙ†Ù…Ø§ Ùˆ Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ø§ÛŒØ±Ø§Ù†','ÙˆØ±Ø²Ø´ Ø§ÛŒØ±Ø§Ù†','ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ'];
  const diffs = ['Ø¢Ø³Ø§Ù†','Ù…ØªÙˆØ³Ø·','Ø³Ø®Øª'];
  
  function loadState(){ 
    try{ 
      const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); 
      if(s) Object.assign(State,s); 
      
      // Load server state if available
      const serverState = JSON.parse(localStorage.getItem('server_state') || '{}');
      if (serverState.limits) Object.assign(Server.limits, serverState.limits);
      if (serverState.pass) Object.assign(Server.pass, serverState.pass);
    }catch{}
    State.duelOpponent = null;
  }
  
  function saveState(){ 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(State)); 
    localStorage.setItem('server_state', JSON.stringify({
      limits: Server.limits,
      pass: Server.pass
    }));
  }
  
  loadState();
  document.documentElement.setAttribute('data-theme', State.theme || 'ocean');
  
  // Telegram WebApp (optional)
  try{
    if(window.Telegram && Telegram.WebApp){
      Telegram.WebApp.ready();
      const u = Telegram.WebApp.initDataUnsafe?.user;
      if(u){
        State.user.id = String(u.id);
        State.user.name = [u.first_name,u.last_name].filter(Boolean).join(' ');
        if(u.username) State.user.name += ` (@${u.username})`;
      }
    }
    }catch{}

    (function setupProvinceSelect(){
    // 1) Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ú©Ù†
    function bootstrapProvinces(){
      const NAMES = [
        "Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ","Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† ØºØ±Ø¨ÛŒ","Ø§Ø±Ø¯Ø¨ÛŒÙ„","Ø§ØµÙÙ‡Ø§Ù†","Ø§Ù„Ø¨Ø±Ø²","Ø§ÛŒÙ„Ø§Ù…","Ø¨ÙˆØ´Ù‡Ø±","ØªÙ‡Ø±Ø§Ù†",
        "Ú†Ù‡Ø§Ø±Ù…Ø­Ø§Ù„ Ùˆ Ø¨Ø®ØªÛŒØ§Ø±ÛŒ","Ø®Ø±Ø§Ø³Ø§Ù† Ø¬Ù†ÙˆØ¨ÛŒ","Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ","Ø®Ø±Ø§Ø³Ø§Ù† Ø´Ù…Ø§Ù„ÛŒ","Ø®ÙˆØ²Ø³ØªØ§Ù†","Ø²Ù†Ø¬Ø§Ù†","Ø³Ù…Ù†Ø§Ù†",
        "Ø³ÛŒØ³ØªØ§Ù† Ùˆ Ø¨Ù„ÙˆÚ†Ø³ØªØ§Ù†","ÙØ§Ø±Ø³","Ù‚Ø²ÙˆÛŒÙ†","Ù‚Ù…","Ú©Ø±Ø¯Ø³ØªØ§Ù†","Ú©Ø±Ù…Ø§Ù†","Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡","Ú©Ù‡Ú¯ÛŒÙ„ÙˆÛŒÙ‡ Ùˆ Ø¨ÙˆÛŒØ±Ø§Ø­Ù…Ø¯",
        "Ú¯Ù„Ø³ØªØ§Ù†","Ú¯ÛŒÙ„Ø§Ù†","Ù„Ø±Ø³ØªØ§Ù†","Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†","Ù…Ø±Ú©Ø²ÛŒ","Ù‡Ø±Ù…Ø²Ú¯Ø§Ù†","Ù‡Ù…Ø¯Ø§Ù†","ÛŒØ²Ø¯"
      ];
      if (!Array.isArray(State.provinces) || State.provinces.length !== NAMES.length) {
        State.provinces = NAMES.map(n => ({ name:n, score:0, members:0, region:'' }));
      }
    }

    function openModal(sel){ document.querySelector(sel).classList.add('show'); }
    function closeModal(sel){ document.querySelector(sel).classList.remove('show'); }

    function fillAllProvinceSelects(){
      bootstrapProvinces();
      populateProvinceOptions(document.getElementById('first-province'), 'Ø§Ø³ØªØ§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
      const editSel = document.getElementById('sel-province');
      populateProvinceOptions(editSel);
      if (editSel) editSel.value = State.user.province || '';
    }

    // 2) Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ù„Ú©Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹
    fillAllProvinceSelects();

    // 3) Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù‡Ù†ÙˆØ² Ø§Ø³ØªØ§Ù† Ù†Ø¯Ø§Ø±Ø¯ØŒ Ù…ÙˆØ¯Ø§Ù„ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†
    if (!State.user.province) {
      openModal('#modal-province-select');
      setTimeout(()=>document.getElementById('first-province')?.focus(), 50);
    }

    // 4) Ø¯Ú©Ù…Ù‡Ù” ØªØ§ÛŒÛŒØ¯ Ø§Ø³ØªØ§Ù†
    document.getElementById('btn-confirm-province')?.addEventListener('click', () => {
      const sel = document.getElementById('first-province');
      const val = sel?.value || '';
      if (!val) { toast('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø§Ø³ØªØ§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†'); return; }
      State.user.province = val;
      saveState();
      renderHeader();
      renderDashboard();
      closeModal('#modal-province-select');
      toast('Ø§Ø³ØªØ§Ù† Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
    });

    // 5) Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Â«ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„Â» Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ù„ÛŒØ³Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø§Ø³Øª
    document.getElementById('btn-edit-profile')?.addEventListener('click', () => {
      fillAllProvinceSelects();
      openModal('#modal-profile');
    });
  })();

    // ===== Question Bank (ØªÙ…Ø§Ù…Ø§Ù‹ ÙØ§Ø±Ø³ÛŒ) =====
    const qBank = [
      { q:'Ù¾Ø§ÛŒØªØ®Øª Ø§ÛŒØ±Ø§Ù† Ú†ÛŒØ³ØªØŸ', c:['ØªÙ‡Ø±Ø§Ù†','Ø§ØµÙÙ‡Ø§Ù†','Ø´ÛŒØ±Ø§Ø²','ØªØ¨Ø±ÛŒØ²'], a:0, cat:'Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒ Ø§ÛŒØ±Ø§Ù†', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ù…Ø±ØªÙØ¹â€ŒØªØ±ÛŒÙ† Ú©ÙˆÙ‡ Ø§ÛŒØ±Ø§Ù† Ú©Ø¯Ø§Ù… Ø§Ø³ØªØŸ', c:['Ø³Ø¨Ù„Ø§Ù†','Ø²Ø§Ú¯Ø±Ø³','Ø¯Ù…Ø§ÙˆÙ†Ø¯','ØªÙØªØ§Ù†'], a:2, cat:'Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒ Ø§ÛŒØ±Ø§Ù†', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ø¯Ø±ÛŒØ§Ú†Ù‡Ù” Ø§Ø±ÙˆÙ…ÛŒÙ‡ Ø¯Ø± Ú©Ø¯Ø§Ù… Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯ØŸ', c:['Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ Ùˆ ØºØ±Ø¨ÛŒ','Ú©Ø±Ø¯Ø³ØªØ§Ù† Ùˆ Ù‡Ù…Ø¯Ø§Ù†','Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ Ùˆ Ø´Ù…Ø§Ù„ÛŒ','ÙØ§Ø±Ø³ Ùˆ Ø¨ÙˆØ´Ù‡Ø±'], a:0, cat:'Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒ Ø§ÛŒØ±Ø§Ù†', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ø±ÙˆØ¯ Ú©Ø§Ø±ÙˆÙ† Ø¹Ù…Ø¯ØªØ§Ù‹ Ø¯Ø± Ú©Ø¯Ø§Ù… Ø§Ø³ØªØ§Ù† Ø¬Ø±ÛŒØ§Ù† Ø¯Ø§Ø±Ø¯ØŸ', c:['Ø®ÙˆØ²Ø³ØªØ§Ù†','Ù‡Ø±Ù…Ø²Ú¯Ø§Ù†','Ø³ÛŒØ³ØªØ§Ù† Ùˆ Ø¨Ù„ÙˆÚ†Ø³ØªØ§Ù†','Ú¯ÛŒÙ„Ø§Ù†'], a:0, cat:'Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒ Ø§ÛŒØ±Ø§Ù†', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ø³ÛŒâ€ŒÙˆØ³Ù‡â€ŒÙ¾Ù„ Ø¯Ø± Ú©Ø¯Ø§Ù… Ø´Ù‡Ø± Ø§Ø³ØªØŸ', c:['Ø´ÛŒØ±Ø§Ø²','ØªØ¨Ø±ÛŒØ²','Ø§ØµÙÙ‡Ø§Ù†','Ú©Ø±Ù…Ø§Ù†'], a:2, cat:'Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒ Ø§ÛŒØ±Ø§Ù†', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ø´Ø§Ù‡Ù†Ø§Ù…Ù‡ Ø§Ø«Ø± Ú©ÛŒØ³ØªØŸ', c:['Ø­Ø§ÙØ¸','Ø³Ø¹Ø¯ÛŒ','Ù…ÙˆÙ„ÙˆÛŒ','ÙØ±Ø¯ÙˆØ³ÛŒ'], a:3, cat:'Ø§Ø¯Ø¨ÛŒØ§Øª ÙØ§Ø±Ø³ÛŒ', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'ØªØ®Ù„Øµ Ø®ÙˆØ§Ø¬Ù‡ Ø´Ù…Ø³â€ŒØ§Ù„Ø¯ÛŒÙ† Ù…Ø­Ù…Ø¯ Ú†ÛŒØ³ØªØŸ', c:['Ø³Ù†Ø§ÛŒÛŒ','Ø­Ø§ÙØ¸','Ø®ÛŒØ§Ù…','Ø¬Ø§Ù…ÛŒ'], a:1, cat:'Ø§Ø¯Ø¨ÛŒØ§Øª ÙØ§Ø±Ø³ÛŒ', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ú©ØªØ§Ø¨ Â«Ú¯Ù„Ø³ØªØ§Ù†Â» Ø±Ø§ Ú†Ù‡ Ú©Ø³ÛŒ Ù†ÙˆØ´ØªÙ‡ Ø§Ø³ØªØŸ', c:['Ù†Ø¸Ø§Ù…ÛŒ','Ø³Ø¹Ø¯ÛŒ','Ø¹Ø·Ø§Ø±','Ù…ÙˆÙ„ÙˆÛŒ'], a:1, cat:'Ø§Ø¯Ø¨ÛŒØ§Øª ÙØ§Ø±Ø³ÛŒ', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ù…ØµØ±Ø§Ø¹ Â«Ø¨Ù†ÛŒâ€ŒØ¢Ø¯Ù… Ø§Ø¹Ø¶Ø§ÛŒ ÛŒÚ© Ù¾ÛŒÚ©Ø±Ù†Ø¯Â» Ø§Ø² Ú©ÛŒØ³ØªØŸ', c:['Ø­Ø§ÙØ¸','Ø³Ø¹Ø¯ÛŒ','ÙØ±Ø¯ÙˆØ³ÛŒ','Ù†Ø¸Ø§Ù…ÛŒ'], a:1, cat:'Ø§Ø¯Ø¨ÛŒØ§Øª ÙØ§Ø±Ø³ÛŒ', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ú©Ø¯Ø§Ù… Ø´Ø§Ø¹Ø± Ø¨Ù‡ Ø±Ø¨Ø§Ø¹ÛŒâ€ŒØ³Ø±Ø§ÛŒÛŒ Ù…Ø´Ù‡ÙˆØ± Ø§Ø³ØªØŸ', c:['Ø®ÛŒØ§Ù…','Ø­Ø§ÙØ¸','Ù…ÙˆÙ„ÙˆÛŒ','ØµØ§Ø¦Ø¨'], a:0, cat:'Ø§Ø¯Ø¨ÛŒØ§Øª ÙØ§Ø±Ø³ÛŒ', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ø¨Ù†ÛŒØ§Ù†â€ŒÚ¯Ø°Ø§Ø± Ù‡Ø®Ø§Ù…Ù†Ø´ÛŒØ§Ù† Ú†Ù‡ Ú©Ø³ÛŒ Ø¨ÙˆØ¯ØŸ', c:['Ø¯Ø§Ø±ÛŒÙˆØ´ Ø¨Ø²Ø±Ú¯','Ú©Ù…Ø¨ÙˆØ¬ÛŒÙ‡','Ú©ÙˆØ±ÙˆØ´ Ø¨Ø²Ø±Ú¯','Ø®Ø´Ø§ÛŒØ§Ø±Ø´Ø§Ù‡'], a:2, cat:'ØªØ§Ø±ÛŒØ® Ø§ÛŒØ±Ø§Ù†', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ù†ÙˆØ±ÙˆØ² Ø¯Ø± ØªÙ‚ÙˆÛŒÙ… Ø¬Ù„Ø§Ù„ÛŒ Ø¨Ø±Ø§Ø¨Ø± Ø§Ø³Øª Ø¨Ø§ Ø±ÙˆØ²Ù ...', c:['Ø§ÙˆÙ„ Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø§ÙˆÙ„ ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø³ÛŒâ€ŒØ§Ù… Ø§Ø³ÙÙ†Ø¯','Ù¾Ø§Ù†Ø²Ø¯Ù‡Ù… ÙØ±ÙˆØ±Ø¯ÛŒÙ†'], a:1, cat:'ØªØ§Ø±ÛŒØ® Ø§ÛŒØ±Ø§Ù†', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ù†Ø§Ø¯Ø±Ø´Ø§Ù‡ Ø§ÙØ´Ø§Ø± Ø¯Ø± Ú©Ø¯Ø§Ù… Ù‚Ø±Ù† Ø­Ú©Ù…Ø±Ø§Ù†ÛŒ Ú©Ø±Ø¯ØŸ', c:['Ù†Ù‡Ù… Ù‡Ø¬Ø±ÛŒ','ÛŒØ§Ø²Ø¯Ù‡Ù… Ù‡Ø¬Ø±ÛŒ','Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù… Ù‡Ø¬Ø±ÛŒ','Ø³ÛŒØ²Ø¯Ù‡Ù… Ù‡Ø¬Ø±ÛŒ'], a:2, cat:'ØªØ§Ø±ÛŒØ® Ø§ÛŒØ±Ø§Ù†', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ø§ÙˆÙ„ÛŒÙ† Ø§Ø³Ú©Ø§Ø± Ø³ÛŒÙ†Ù…Ø§ÛŒ Ø§ÛŒØ±Ø§Ù† Ø¨Ø±Ø§ÛŒ Ú©Ø¯Ø§Ù… ÙÛŒÙ„Ù… Ø¨ÙˆØ¯ØŸ', c:['Ø¬Ø¯Ø§ÛŒÛŒ Ù†Ø§Ø¯Ø± Ø§Ø² Ø³ÛŒÙ…ÛŒÙ†','ÙØ±ÙˆØ´Ù†Ø¯Ù‡','Ø·Ø¹Ù… Ú¯ÛŒÙ„Ø§Ø³','Ø¨Ú†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ø³Ù…Ø§Ù†'], a:0, cat:'Ø³ÛŒÙ†Ù…Ø§ Ùˆ Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ø§ÛŒØ±Ø§Ù†', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ú©Ø§Ø±Ú¯Ø±Ø¯Ø§Ù† ÙÛŒÙ„Ù… Â«ÙØ±ÙˆØ´Ù†Ø¯Ù‡Â» Ú©ÛŒØ³ØªØŸ', c:['Ø§ØµØºØ± ÙØ±Ù‡Ø§Ø¯ÛŒ','Ù…Ø¬ÛŒØ¯ Ù…Ø¬ÛŒØ¯ÛŒ','Ø¹Ø¨Ø§Ø³ Ú©ÛŒØ§Ø±Ø³ØªÙ…ÛŒ','Ø±Ø®Ø´Ø§Ù† Ø¨Ù†ÛŒâ€ŒØ§Ø¹ØªÙ…Ø§Ø¯'], a:0, cat:'Ø³ÛŒÙ†Ù…Ø§ Ùˆ Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ø§ÛŒØ±Ø§Ù†', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ø³Ø§Ø² Â«ØªØ§Ø±Â» Ø¬Ø²Ùˆ Ú©Ø¯Ø§Ù… Ø¯Ø³ØªÙ‡ Ø§Ø³ØªØŸ', c:['Ø³Ø§Ø²Ù‡Ø§ÛŒ Ø¨Ø§Ø¯ÛŒ','Ø³Ø§Ø²Ù‡Ø§ÛŒ Ø²Ù‡ÛŒ Ù…Ø¶Ø±Ø§Ø¨ÛŒ','Ø³Ø§Ø²Ù‡Ø§ÛŒ Ú©ÙˆØ¨Ù‡â€ŒØ§ÛŒ','Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©'], a:1, cat:'Ø³ÛŒÙ†Ù…Ø§ Ùˆ Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ø§ÛŒØ±Ø§Ù†', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ø¯Ø±Ø¨ÛŒ Ù…Ø´Ù‡ÙˆØ± ØªÙ‡Ø±Ø§Ù† Ø¨ÛŒÙ† Ú©Ø¯Ø§Ù… ØªÛŒÙ…â€ŒÙ‡Ø§Ø³ØªØŸ', c:['Ø³Ù¾Ø§Ù‡Ø§Ù† Ùˆ Ø°ÙˆØ¨â€ŒØ¢Ù‡Ù†','ØªØ±Ø§Ú©ØªÙˆØ± Ùˆ Ù…Ø§Ø´ÛŒÙ†â€ŒØ³Ø§Ø²ÛŒ','Ù¾Ø±Ø³Ù¾ÙˆÙ„ÛŒØ³ Ùˆ Ø§Ø³ØªÙ‚Ù„Ø§Ù„','Ù…Ù„ÙˆØ§Ù† Ùˆ Ù…Ù„ÙˆØ§Ù† Ù†ÙˆÛŒÙ†'], a:2, cat:'ÙˆØ±Ø²Ø´ Ø§ÛŒØ±Ø§Ù†', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ø§ÛŒØ±Ø§Ù† Ú†Ù†Ø¯ Ø¨Ø§Ø± Ù‚Ù‡Ø±Ù…Ø§Ù† Ø¬Ø§Ù… Ù…Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ø³ÛŒØ§ Ø´Ø¯Ù‡ Ø§Ø³ØªØŸ', c:['Ø¯Ùˆ Ø¨Ø§Ø±','Ø³Ù‡ Ø¨Ø§Ø±','Ú†Ù‡Ø§Ø± Ø¨Ø§Ø±','ÛŒÚ© Ø¨Ø§Ø±'], a:1, cat:'ÙˆØ±Ø²Ø´ Ø§ÛŒØ±Ø§Ù†', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ù‚Ù‡Ø±Ù…Ø§Ù† Ù†Ø§Ù…Ø¯Ø§Ø± Ú©Ø´ØªÛŒ Ø¢Ø²Ø§Ø¯ Ø¨Ø§ Ù„Ù‚Ø¨ Â«Ù¾Ù„Ù†Ú¯Â» Ú©ÛŒØ³ØªØŸ', c:['Ø­Ø³Ø§Ù† ÛŒØ²Ø¯Ø§Ù†ÛŒ','Ø¹Ù„ÛŒØ±Ø¶Ø§ Ø¯Ø¨ÛŒØ±','Ø±Ø³ÙˆÙ„ Ø®Ø§Ø¯Ù…','Ø¹Ø¨Ø§Ø³ Ø¬Ø¯ÛŒØ¯ÛŒ'], a:0, cat:'ÙˆØ±Ø²Ø´ Ø§ÛŒØ±Ø§Ù†', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'ÙˆØ§Ø­Ø¯ Ø±Ø³Ù…ÛŒ Ù¾ÙˆÙ„ Ø§ÛŒØ±Ø§Ù† Ú†ÛŒØ³ØªØŸ', c:['ØªÙˆÙ…Ø§Ù†','Ø±ÛŒØ§Ù„','Ø¯Ø±Ù‡Ù…','Ù…Ù†Ø§Øª'], a:1, cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ú©Ø¯ Ù¾Ø³ØªÛŒ Ø§ÛŒØ±Ø§Ù† Ú†Ù†Ø¯ Ø±Ù‚Ù…ÛŒ Ø§Ø³ØªØŸ', c:['Û¸','Û¹','Û±Û°','Û±Û²'], a:2, cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ø¹Ù†ØµØ± Ø¨Ø§ Ù†Ù…Ø§Ø¯ Au Ú©Ø¯Ø§Ù… Ø§Ø³ØªØŸ', c:['Ù†Ù‚Ø±Ù‡','Ø¢Ù„ÙˆÙ…ÛŒÙ†ÛŒÙˆÙ…','Ø·Ù„Ø§','Ø¢Ø±Ú¯ÙˆÙ†'], a:2, cat:'Ø¹Ù„Ù…', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ù‚Ø§Ù†ÙˆÙ† Ø¯ÙˆÙ… Ù†ÛŒÙˆØªÙ†ØŸ', c:['F=ma','E=mcÂ²','V=IR','pV=nRT'], a:0, cat:'Ø¹Ù„Ù…', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ù†ÙˆØ± Ø¯Ø± Ø®Ù„Ø£ ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ø¨Ø§ Ú†Ù‡ Ø³Ø±Ø¹ØªÛŒ Ø­Ø±Ú©Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ', c:['Û³Û°Û° Ú©ÛŒÙ„ÙˆÙ…ØªØ±/Ø«Ø§Ù†ÛŒÙ‡','Û³Ù¬Û°Û°Û° Ú©ÛŒÙ„ÙˆÙ…ØªØ±/Ø«Ø§Ù†ÛŒÙ‡','Û³Û°Û°Ù¬Û°Û°Û° Ú©ÛŒÙ„ÙˆÙ…ØªØ±/Ø«Ø§Ù†ÛŒÙ‡','Û³Ù¬Û°Û°Û°Ù¬Û°Û°Û° Ú©ÛŒÙ„ÙˆÙ…ØªØ±/Ø«Ø§Ù†ÛŒÙ‡'], a:2, cat:'Ø¹Ù„Ù…', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ø²Ø¨Ø§Ù†Ù Ø§Ø¬Ø±Ø§Ø´ÙˆÙ†Ø¯Ù‡ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± ÙˆØ¨ØŸ', c:['Ù¾Ø§ÛŒØªÙˆÙ†','Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª','Ø¬Ø§ÙˆØ§','C#'], a:1, cat:'ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ø§Ø¨Ø²Ø§Ø± Ø±Ø§ÛŒØ¬Ù Ú©Ù†ØªØ±Ù„ Ù†Ø³Ø®Ù‡Ù” Ú©Ø¯ØŸ', c:['Docker','Git','NPM','Webpack'], a:1, cat:'ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ø¹Ø¯Ø¯ Ù¾ÛŒ (Ï€) ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ø¨Ø±Ø§Ø¨Ø± Ø§Ø³Øª Ø¨Ø§ ...', c:['Û²Ù«Û·','Û³Ù«Û±Û´','Û³Ù«Û´Û±','Û²Ù«Û±Û´'], a:1, cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ù¾Ø§ÛŒØªØ®Øª Ú˜Ø§Ù¾Ù† Ú©Ø¯Ø§Ù… Ø§Ø³ØªØŸ', c:['Ø§ÙˆØ³Ø§Ú©Ø§','ØªÙˆÚ©ÛŒÙˆ','Ú©ÛŒÙˆØªÙˆ','Ø³Ø§Ù¾ÙˆØ±Ùˆ'], a:1, cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ø¢Ø³Ø§Ù†' },
    { q:'Ù¾Ø§ÛŒØªØ®Øª Ú©Ø§Ù†Ø§Ø¯Ø§ Ú©Ø¯Ø§Ù… Ø§Ø³ØªØŸ', c:['ØªÙˆØ±Ù†ØªÙˆ','Ø§ÙˆØªØ§ÙˆØ§','Ù…ÙˆÙ†ØªØ±Ø§Ù„','ÙˆÙ†Ú©ÙˆÙˆØ±'], a:1, cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ú©Ø¯Ø§Ù… Ø³Ø¨Ú© Ù‡Ù†Ø±ÛŒ Ø¨Ù‡ Ù¾ÛŒÚ©Ø§Ø³Ùˆ Ù†Ø³Ø¨Øª Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŸ', c:['Ø±Ù…Ø§Ù†ØªÛŒØ³Ù…','Ø§Ù…Ù¾Ø±Ø³ÛŒÙˆÙ†ÛŒØ³Ù…','Ú©ÙˆØ¨ÛŒØ³Ù…','Ø±Ø¦Ø§Ù„ÛŒØ³Ù…'], a:2, cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ø§Ø«Ø± Â«Ø´Ø¨Ù Ù¾Ø±Ø³ØªØ§Ø±Ù‡Â» Ø§Ø«Ø± Ú©ÛŒØ³ØªØŸ', c:['Ù¾ÛŒÚ©Ø§Ø³Ùˆ','ÙˆÙ†â€ŒÚ¯ÙˆÚ¯','Ù…ÙˆÙ†Ú©','Ø¯Ø§ÙˆÛŒÙ†Ú†ÛŒ'], a:1, cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'ÙØ§ØµÙ„Ù‡Ù” Ù†Ù‚Ø·Ù‡Ù” Ù¾Ù†Ø§Ù„ØªÛŒ ØªØ§ Ø¯Ø±ÙˆØ§Ø²Ù‡ Ø¯Ø± ÙÙˆØªØ¨Ø§Ù„ØŸ', c:['Û±Û° Ù…ØªØ±','Û±Û± Ù…ØªØ±','Û±Û² Ù…ØªØ±','Û¹ Ù…ØªØ±'], a:1, cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ø¢Ø³Ø§Ù†' }
  ];
  
  // ===== Game Limits Management =====
  function checkDailyReset() {
    const now = Date.now();
    const today = new Date(now);
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    // Check if we need to reset daily limits
    if (Server.limits.matches.lastReset < today.getTime()) {
      Server.limits.matches.used = 0;
      Server.limits.matches.lastReset = today.getTime();
    }
    
    if (Server.limits.lives.lastReset < today.getTime()) {
      Server.limits.lives.used = 0;
      Server.limits.lives.lastReset = today.getTime();
    }
    
    if (Server.limits.energy.lastReset < today.getTime()) {
      Server.limits.energy.used = 0;
      Server.limits.energy.lastReset = today.getTime();
    }
    
    // Update UI
    updateLimitsUI();
    
    // Update daily reset timer
    updateDailyResetTimer(tomorrow.getTime() - now);
    
    // Check recovery timers
    updateRecoveryTimers();
    
    // Check if any limit is reached
    checkLimitsReached();
  }
  
  function updateLimitsUI() {
    const vipMultiplier = Server.subscription.active ? 
      (Server.subscription.tier === 'pro' ? 3 : 2) : 1;
    
    // Matches
    const matchesLimit = RemoteConfig.gameLimits.matches.daily * vipMultiplier;
    const matchesUsed = Server.limits.matches.used;
    const matchesPct = Math.min(100, (matchesUsed / matchesLimit) * 100);
    $('#matches-used').textContent = faNum(matchesUsed);
    $('#matches-limit').textContent = faNum(matchesLimit);
    $('#matches-progress').style.width = `${matchesPct}%`;
    
    // Duels
    const duelsLimit = RemoteConfig.gameLimits.lives.daily * vipMultiplier;
    const duelsUsed = Server.limits.lives.used;
    const duelsPct = Math.min(100, (duelsUsed / duelsLimit) * 100);
    $('#duels-used').textContent = faNum(duelsUsed);
    $('#duels-limit').textContent = faNum(duelsLimit);
    $('#duels-progress').style.width = `${duelsPct}%`;

    // Energy (UI elements may be absent)
    const energyUsedEl = $('#energy-used');
    const energyLimitEl = $('#energy-limit');
    const energyProgEl = $('#energy-progress');
    if (energyUsedEl && energyLimitEl && energyProgEl) {
      const energyLimit = RemoteConfig.gameLimits.energy.daily * vipMultiplier;
      const energyUsed = Server.limits.energy.used;
      const energyPct = Math.min(100, (energyUsed / energyLimit) * 100);
      energyUsedEl.textContent = faNum(energyUsed);
      energyLimitEl.textContent = faNum(energyLimit);
      energyProgEl.style.width = `${energyPct}%`;
    }
  }
  
  function updateDailyResetTimer(msUntilReset) {
    const hours = Math.floor(msUntilReset / (1000 * 60 * 60));
    const minutes = Math.floor((msUntilReset % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((msUntilReset % (1000 * 60)) / 1000);
    
    $('#daily-reset-timer').textContent = `Ø±ÛŒØ³Øª Ø¯Ø± ${faNum(hours)}:${faNum(minutes).padStart(2, '0')}:${faNum(seconds).padStart(2, '0')}`;
  }
  
  function updateRecoveryTimers() {
    const now = Date.now();

    // Energy recovery
    const energyTimer = $('#energy-recovery-timer');
    if (energyTimer) {
      if (Server.limits.energy.used > 0) {
        const energyRecoveryTime = RemoteConfig.gameLimits.energy.recoveryTime;
        const timeUntilEnergyRecovery = energyRecoveryTime - (now - Server.limits.energy.lastRecovery);

        if (timeUntilEnergyRecovery > 0) {
          const minutes = Math.floor(timeUntilEnergyRecovery / (1000 * 60));
          const seconds = Math.floor((timeUntilEnergyRecovery % (1000 * 60)) / 1000);
          energyTimer.textContent = `Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø¹Ø¯ÛŒ: ${faNum(minutes)}:${faNum(seconds).padStart(2, '0')}`;
        } else {
          energyTimer.textContent = 'Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø¹Ø¯ÛŒ: Ø§Ú©Ù†ÙˆÙ†';
        }
      } else {
        energyTimer.textContent = 'Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø¹Ø¯ÛŒ: --:--';
      }
    }
  }
  
  function checkLimitsReached() {
    const vipMultiplier = Server.subscription.active ? 
      (Server.subscription.tier === 'pro' ? 3 : 2) : 1;
    
    const matchesLimit = RemoteConfig.gameLimits.matches.daily * vipMultiplier;
    const duelsLimit = RemoteConfig.gameLimits.lives.daily * vipMultiplier;

    const matchesReached = Server.limits.matches.used >= matchesLimit;
    const duelsReached = Server.limits.lives.used >= duelsLimit;
    const energyLimit = RemoteConfig.gameLimits.energy.daily * vipMultiplier;
    const energyReached = $('#energy-used') ? Server.limits.energy.used >= energyLimit : false;

    // Show/hide limit reached CTAs
    $('#limit-reached-ctas').classList.toggle('hidden', !(matchesReached || duelsReached || energyReached));

    
    // Log analytics if limit reached
    if (matchesReached && !State.limitsLogged?.matches) {
      logEvent('limit_reached', { type: 'matches', limit: matchesLimit });
      State.limitsLogged = State.limitsLogged || {};
      State.limitsLogged.matches = true;
    }
    
    if (duelsReached && !State.limitsLogged?.duels) {
      logEvent('limit_reached', { type: 'duels', limit: duelsLimit });
      State.limitsLogged = State.limitsLogged || {};
      State.limitsLogged.duels = true;
    }
    
    if (energyReached && !State.limitsLogged?.energy) {
      logEvent('limit_reached', { type: 'energy', limit: energyLimit });
      State.limitsLogged = State.limitsLogged || {};
      State.limitsLogged.energy = true;
    }
  }

  function useGameResource(type) {
    if (type === 'energy') return true;
    const now = Date.now();

    // Check if we can use the resource
    const vipMultiplier = Server.subscription.active ?
      (Server.subscription.tier === 'pro' ? 3 : 2) : 1;

    const limit = RemoteConfig.gameLimits[type].daily * vipMultiplier;

    if (Server.limits[type].used >= limit) {
      return false;
    }

    // Use the resource
    Server.limits[type].used++;
    Server.limits[type].lastRecovery = now;

    // Update UI
    updateLimitsUI();
    checkLimitsReached();

    // Save state
    saveState();

    return true;
  }

  function recoverGameResource(type) {
    if (type === 'energy') return false;
    const now = Date.now();

    // Check if we can recover
    if (Server.limits[type].used <= 0) {
      return false;
    }

    // Check recovery time
    const recoveryTime = RemoteConfig.gameLimits[type].recoveryTime;
    const timeSinceLastRecovery = now - Server.limits[type].lastRecovery;

    if (timeSinceLastRecovery < recoveryTime) {
      return false;
    }

    // Recover the resource
    Server.limits[type].used--;
    Server.limits[type].lastRecovery = now;

    // Update UI
    updateLimitsUI();
    checkLimitsReached();

    // Save state
    saveState();

    return true;
  }
  
  // ===== Rendering (legacy + wallet/sub from server) =====
  function renderHeader(){
    $('#hdr-name').textContent = State.user.name;
    $('#hdr-score').textContent = faNum(State.score);
    $('#hdr-gcoins').textContent = faNum(State.coins);
    $('#hdr-avatar').src = State.user.avatar;
    
    // Apply province frame if user has it
    if (Server.pass.provinceFrame) {
      $('#hdr-avatar').classList.add('province-frame');
    } else {
      $('#hdr-avatar').classList.remove('province-frame');
    }
    
    // Apply VIP frame if user is VIP
    if (Server.subscription.active) {
      $('#hdr-avatar').classList.add('vip-frame');
    } else {
      $('#hdr-avatar').classList.remove('vip-frame');
    }
    
    // server numbers:
    $('#hdr-wallet').textContent = (Server.wallet.coins==null?'â€”':faNum(Server.wallet.coins));
    const vip = Server.subscription.active===true;
    $('#vip-badge').classList.toggle('hidden', !vip);
  }
  
  function renderDashboard(){
    $('#profile-name').textContent = State.user.name;
    $('#profile-avatar').src = State.user.avatar;
    
    // Apply frames
    if (Server.pass.provinceFrame) {
      $('#profile-avatar').classList.add('province-frame');
    } else {
      $('#profile-avatar').classList.remove('province-frame');
    }
    
    if (Server.subscription.active) {
      $('#profile-avatar').classList.add('vip-frame');
    } else {
      $('#profile-avatar').classList.remove('vip-frame');
    }
    
    $('#stat-score').textContent = faNum(State.score);
    $('#stat-coins').textContent = faNum(State.coins);
    $('#stat-lives').textContent = faNum(State.lives);
    $('#vip-chip').classList.toggle('hidden', !Server.subscription.active);
    $('#streak').textContent = faNum(State.streak);
    $('#stat-wallet').textContent = (Server.wallet.coins==null?'â€”':faNum(Server.wallet.coins));
    const pct = clamp((State.streak%7)/7*100,0,100);
    $('#streak-bar').style.width = pct + '%';
    
    // Top provinces and rank
    const provincesSorted = [...State.provinces].sort((a,b)=>b.score-a.score);
    const topWrap = $('#province-top');
    if(topWrap){
      topWrap.innerHTML = provincesSorted.slice(0,2).map((p,i)=>{
        let badgeClass = 'bg-white/20';
        if(i===0) badgeClass = 'bg-gradient-to-br from-yellow-200 to-yellow-400 text-gray-900';
        else if(i===1) badgeClass = 'bg-gradient-to-br from-gray-300 to-gray-400 text-gray-900';
        return `
        <div class="glass rounded-xl p-3 flex flex-col items-center text-center card-hover">
          <span class="rank-badge ${badgeClass} mb-2">${faNum(i+1)}</span>
          <div class="font-bold">${p.name}</div>
          <div class="text-xs opacity-80 mt-1">${faNum(p.score)} Ø§Ù…ØªÛŒØ§Ø²</div>
        </div>`;}).join('');
    }

    const myProvRankEl = $('#my-province-rank');
    const userProvince = State.user.province;
    const myProvIdx = provincesSorted.findIndex(p=>p.name===userProvince);
    if(myProvRankEl){
      if(userProvince){
        myProvRankEl.innerHTML = `<span class="chip"><i class="fas fa-flag text-green-300 ml-1"></i> Ø±ØªØ¨Ù‡ Ø§Ø³ØªØ§Ù† Ø´Ù…Ø§: ${faNum(myProvIdx+1)}</span>`;
      }else{
        myProvRankEl.innerHTML = '<span class="chip">Ø§Ø³ØªØ§Ù† Ø´Ù…Ø§ ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡</span>';
      }
    }

    // rank
    const me = { id: State.user.id, score: State.score, province: State.user.province };
    const arr = [...State.leaderboard.filter(x=>x.id!==me.id), {id:me.id,name:State.user.name,score:me.score,province:me.province}].sort((a,b)=>b.score-a.score);
    const countryIdx = arr.findIndex(x=>x.id===me.id);
    $('#rank-country').textContent = countryIdx>=0 ? faNum(countryIdx+1) : 'â€”';

    const provArr = arr.filter(x=>x.province===me.province);
    const provIdx = provArr.findIndex(x=>x.id===me.id);
    $('#rank-province').textContent = provIdx>=0 ? faNum(provIdx+1) : 'â€”';
    $('#user-province').textContent = me.province || 'â€”';
    $('#user-group').textContent = State.user.group || 'â€”';
    $('#duel-wins').textContent = faNum(State.duelWins);
    $('#duel-losses').textContent = faNum(State.duelLosses);

    // Update limits UI
    updateLimitsUI();
  }
  
  function renderTopBars(){
    $('#lives').textContent = faNum(State.lives);
    $('#coins').textContent = faNum(State.coins);
  }
  
  function navTo(page){
    ['dashboard','quiz','leaderboard','shop','wallet','vip','results','duel','province','group','pass-missions','referral','support'].forEach(p=>$('#page-'+p)?.classList.add('hidden'));
    $('#page-'+page)?.classList.remove('hidden'); $('#page-'+page)?.classList.add('fade-in');
    $$('nav [data-tab]').forEach(b=>{ b.classList.toggle('bg-white/10', b.dataset.tab===page); b.classList.toggle('active', b.dataset.tab===page); });
    if(page==='dashboard') { renderDashboard(); AdManager.renderNative('#ad-native-dashboard'); }
    if(page==='leaderboard'){ renderLeaderboard(); AdManager.renderNative('#ad-native-lb'); }
    if(page==='wallet'){ buildPackages(); }
    if(page==='vip'){ updateVipUI(); }
  }
  
  // ===== Leaderboard / Details (unchanged + detail popups) =====
  function renderLeaderboard(){
    const me = { id: State.user.id, name: State.user.name, score: State.score };
    const arr = [...State.leaderboard.filter(x=>x.id!==me.id), me].sort((a,b)=>b.score-a.score).slice(0,50);
    const wrap = $('#lb-list'); wrap.innerHTML='';
    arr.forEach((u,i)=>{
      const row=document.createElement('div');
      row.className='flex items-center justify-between bg-white/10 border border-white/20 rounded-xl px-4 py-3 card-hover';
      const rank=i+1;
      let badgeClass='bg-white/20';
      if(rank===1) badgeClass='bg-gradient-to-br from-yellow-200 to-yellow-400 text-gray-900';
      else if(rank===2) badgeClass='bg-gradient-to-br from-gray-300 to-gray-400 text-gray-900';
      else if(rank===3) badgeClass='bg-gradient-to-br from-amber-600 to-amber-700 text-gray-900';
      const rankBadge=`<span class="rank-badge ${badgeClass}">${faNum(rank)}</span>`;
      row.innerHTML=`<div class="flex items-center gap-3">${rankBadge}
        <div><div class="font-bold">${u.name}</div>
        <div class="text-xs opacity-80 flex items-center gap-1"><i class="fas fa-star text-yellow-300"></i><span>${faNum(u.score)}</span></div></div></div>`;
      row.addEventListener('click', () => showUserDetail({...u, nationalRank:rank}));
      wrap.appendChild(row);
    });
    
    // provinces
    const provinceList = $('#province-list'); provinceList.innerHTML='';
    const provincesSorted = [...State.provinces].sort((a,b)=>b.score-a.score);
    provincesSorted.forEach((p,i)=>{
      const row=document.createElement('div');
      row.className='location-card';
      const rank=i+1;
      let badgeClass='bg-white/20';
      if(rank===1) badgeClass='bg-gradient-to-br from-yellow-200 to-yellow-400 text-gray-900';
      else if(rank===2) badgeClass='bg-gradient-to-br from-gray-300 to-gray-400 text-gray-900';
      else if(rank===3) badgeClass='bg-gradient-to-br from-amber-600 to-amber-700 text-gray-900';
      row.innerHTML=`<span class="rank-badge ${badgeClass}">${faNum(rank)}</span>
        <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
        <div class="flex-1"><div class="font-bold">${p.name}</div>
        <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>${faNum(p.members)} Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</span></div></div>
        <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> ${faNum(p.score)}</div>`;
      if(p.name===State.user.province){
        row.classList.add('ring-2','ring-green-300');
        setTimeout(()=>row.scrollIntoView({behavior:'smooth',block:'center'}),0);
      }
      row.addEventListener('click', () => showProvinceDetail({...p, rank}));
      provinceList.appendChild(row);
    });

    const myProvRankElLb = $('#my-province-rank-lb');
    if(myProvRankElLb){
      const myProvIdx = provincesSorted.findIndex(p=>p.name===State.user.province);
      if(State.user.province && myProvIdx !== -1){
        myProvRankElLb.innerHTML = `<span class="chip"><i class="fas fa-flag text-green-300 ml-1"></i> Ø±ØªØ¨Ù‡ Ø§Ø³ØªØ§Ù† Ø´Ù…Ø§: ${faNum(myProvIdx+1)}</span>`;
      }else{
        myProvRankElLb.innerHTML = '<span class="chip">Ø§Ø³ØªØ§Ù† Ø´Ù…Ø§ ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡</span>';
      }
    }
    
    // groups
    const groupList = $('#group-list'); groupList.innerHTML='';
    State.groups.sort((a,b)=>b.score-a.score).forEach((g,i)=>{
      const row=document.createElement('div');
      row.className='location-card';
      const rank=i+1;
        let badgeClass='bg-white/20';
        if(rank===1) badgeClass='bg-gradient-to-br from-yellow-200 to-yellow-400 text-gray-900';
        else if(rank===2) badgeClass='bg-gradient-to-br from-gray-300 to-gray-400 text-gray-900';
        else if(rank===3) badgeClass='bg-gradient-to-br from-amber-600 to-amber-700 text-gray-900';
        row.innerHTML=`<span class="rank-badge ${badgeClass}">${faNum(rank)}</span>
        <div class="location-icon group-icon"><i class="fas fa-users"></i></div>
        <div class="flex-1"><div class="font-bold">${g.name}</div>
        <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-user"></i><span>Ù…Ø¯ÛŒØ±: ${g.admin}</span></div></div>
        <div class="text-sm font-bold text-purple-300"><i class="fas fa-trophy"></i> ${faNum(g.score)}</div>`;
      row.addEventListener('click', () => showGroupDetail({...g, rank}));
      groupList.appendChild(row);
    });
  }
  
  function showDetailPopup(title, content) { 
    $('#detail-title').textContent = title; 
    $('#detail-content').innerHTML = content; 
    $('#detail-popup').classList.add('show'); 
    $('#detail-overlay').classList.add('show'); 
  }
  
  function closeDetailPopup() { 
    $('#detail-popup').classList.remove('show'); 
    $('#detail-overlay').classList.remove('show'); 
  }
  
  function showUserDetail(user) {
    const all = [...State.leaderboard, { id: State.user.id, name: State.user.name, score: State.score, province: State.user.province, group: State.user.group }].sort((a,b)=>b.score-a.score);
    const nationalRank = user.nationalRank || (all.findIndex(x => x.id === user.id) + 1);
    const provinceRank = all.filter(x => x.province === user.province).sort((a,b)=>b.score-a.score).findIndex(x => x.id === user.id) + 1;
    const content = `
      <div class="flex flex-col items-center mb-4">
        <img src="${user.avatar || `https://i.pravatar.cc/120?u=${encodeURIComponent(user.name)}`}" class="w-20 h-20 rounded-full border-4 border-white/30 shadow-lg mb-3" alt="avatar">
        <h4 class="text-xl font-bold">${user.name}</h4>
        <div class="text-sm opacity-80 mt-1">Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„</div>
      </div>
      <div class="space-y-3">
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-star text-yellow-300"></i>Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„</span><span class="font-bold text-yellow-300">${faNum(user.score)}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-map-marker-alt text-pink-400"></i>Ø§Ø³ØªØ§Ù†</span><span class="font-bold">${user.province || 'â€”'}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-users text-blue-300"></i>Ú¯Ø±ÙˆÙ‡</span><span class="font-bold">${user.group || 'â€”'}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-globe text-yellow-300"></i>Ø±ØªØ¨Ù‡ Ú©Ø´ÙˆØ±ÛŒ</span><span class="font-bold text-yellow-300">${faNum(nationalRank)}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-flag text-green-300"></i>Ø±ØªØ¨Ù‡ Ø§Ø³ØªØ§Ù†ÛŒ</span><span class="font-bold text-green-300">${faNum(provinceRank)}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-calendar-alt"></i>ØªØ§Ø±ÛŒØ® Ø¹Ø¶ÙˆÛŒØª</span><span class="font-bold">${user.joined || 'Û±Û´Û°Û²/Û°Û±/Û±Ûµ'}</span></div>
      </div>`;
    showDetailPopup('Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ø±Ø¨Ø±', content);
  }
  
  function showProvinceDetail(province) {
    const content = `
      <div class="flex flex-col items-center mb-4">
        <div class="w-20 h-20 rounded-full bg-gradient-to-r from-green-400 to-emerald-500 flex items-center justify-center mb-3"><i class="fas fa-map-marked-alt text-white text-2xl"></i></div>
        <h4 class="text-xl font-bold">${province.name}</h4>
        <div class="text-sm opacity-80 mt-1">${province.region}</div>
      </div>
      <div class="space-y-3">
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„</span><span class="font-bold text-green-300">${faNum(province.score)}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80">ØªØ¹Ø¯Ø§Ø¯ Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù†</span><span class="font-bold">${faNum(province.members)}</span></div>
      </div>`;
    showDetailPopup('Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ø³ØªØ§Ù†', content);
  }
  
  function showGroupDetail(group) {
    const isAdmin = group.admin === State.user.name;
    const isMember = State.user.group === group.name;
    const requested = group.requests?.includes(State.user.id);
    let content = `
      <div class="flex flex-col items-center mb-4">
        <div class="w-20 h-20 rounded-full bg-gradient-to-r from-purple-400 to-indigo-500 flex items-center justify-center mb-3"><i class="fas fa-users text-white text-2xl"></i></div>
        <h4 class="text-xl font-bold">${group.name}</h4>
        <div class="text-sm opacity-80 mt-1">Ú¯Ø±ÙˆÙ‡ Ø¯Ø§Ù†Ø´ÛŒ</div>
      </div>
      <div class="space-y-3">
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„</span><span class="font-bold text-purple-300">${faNum(group.score)}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80">ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¶Ø§</span><span class="font-bold">${faNum(group.members)}</span></div>
      </div>`;

    const membersHtml = (group.memberList || []).map(m=>`<div class="glass rounded-xl p-2 text-sm flex items-center gap-2"><i class="fas fa-user text-blue-200"></i>${m}</div>`).join('');
    content += `
      <div class="mt-4">
        ${isAdmin ? `<input id="new-member-name" class="form-input mb-2" placeholder="Ù†Ø§Ù… Ø¹Ø¶Ùˆ Ø¬Ø¯ÛŒØ¯">
        <button id="btn-add-member" class="btn btn-group w-full"><i class="fas fa-user-plus ml-2"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ</button>` : ''}
        <h5 class="font-bold mb-2${isAdmin ? ' mt-4' : ''}">Ø§Ø¹Ø¶Ø§ÛŒ Ú¯Ø±ÙˆÙ‡</h5>
        <div id="member-list" class="space-y-2">${membersHtml || '<div class="text-sm opacity-80">Ø¹Ø¶ÙˆÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>'}</div>
      </div>`;

    const matchesHtml = (group.matches || []).map(m=>`<div class="glass rounded-xl p-2 text-sm flex justify-between"><span>${m.opponent}</span><span>${m.time}</span></div>`).join('');
    content += `
      <div class="mt-4">
        <h5 class="font-bold mb-2">Ù†Ø¨Ø±Ø¯Ù‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ±Ùˆ</h5>
        <div class="space-y-2">${matchesHtml || '<div class="text-sm opacity-80">Ù†Ø¨Ø±Ø¯ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>'}</div>
      </div>`;

    if (isAdmin) {
      content += `<button id="btn-request-duel" class="btn btn-duel w-full mt-4"><i class="fas fa-swords ml-2"></i> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø¨Ø±Ø¯</button>`;
    } else if (!isMember) {
      content += `
        <button id="btn-join-group" class="btn btn-group w-full mt-4" ${requested ? 'disabled' : ''}>
          <i class="fas fa-user-plus ml-2"></i> ${requested ? 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯' : 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¹Ø¶ÙˆÛŒØª'}
        </button>`;
    }

    showDetailPopup('Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯Ø±ÙˆÙ‡', content);

    $('#btn-join-group')?.addEventListener('click', () => requestJoinGroup(group.id));
    $('#btn-add-member')?.addEventListener('click', () => {
      const name = $('#new-member-name').value.trim();
      if(!name){ toast('Ù†Ø§Ù… Ø¹Ø¶Ùˆ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
      group.memberList = group.memberList || [];
      group.memberList.push(name);
      group.members += 1;
      $('#member-list').innerHTML += `<div class="glass rounded-xl p-2 text-sm flex items-center gap-2"><i class="fas fa-user text-blue-200"></i>${name}</div>`;
      $('#new-member-name').value='';
      toast(`Ø¹Ø¶Ùˆ ${name} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`);
      renderGroupSelect();
    });
    $('#btn-request-duel')?.addEventListener('click', () => openDuelRequest(group));
  }

  function requestJoinGroup(groupId){
    const group = State.groups.find(g=>g.id===groupId);
    if(!group) return;
    group.requests = group.requests || [];
    if(group.requests.includes(State.user.id)){
      toast('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª');
      return;
    }
    group.requests.push(State.user.id);
    toast(`Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¹Ø¶ÙˆÛŒØª Ø¨Ù‡ ${group.name} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯`);
    logEvent('group_join_request', { group: group.name });
    closeDetailPopup();
  }

  function openDuelRequest(group){
    const opponents = State.groups.filter(g=>g.id!==group.id);
    if(opponents.length===0){
      toast('Ú¯Ø±ÙˆÙ‡ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ø¨Ø±Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª');
      return;
    }
    const cards = opponents.map(g=>`
      <div class="location-card" data-opp="${g.id}">
        <div class="location-icon group-icon"><i class="fas fa-users"></i></div>
        <div class="flex-1"><div class="font-bold">${g.name}</div>
          <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-user"></i><span>Ù…Ø¯ÛŒØ±: ${g.admin}</span></div>
        </div>
      </div>`).join('');
    const content = `
      <div class="space-y-3">${cards}</div>
      <button id="btn-back-duel-select" class="btn btn-secondary w-full mt-4"><i class="fas fa-arrow-right ml-2"></i> Ø¨Ø§Ø²Ú¯Ø´Øª</button>`;
    showDetailPopup('Ø§Ù†ØªØ®Ø§Ø¨ Ú¯Ø±ÙˆÙ‡ Ø±Ù‚ÛŒØ¨', content);
    $$('[data-opp]').forEach(el=>{
      el.addEventListener('click',()=>{
        const target = State.groups.find(g=>g.id===el.dataset.opp);
        toast(`Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø¨Ø±Ø¯ Ø¨Ù‡ ${target.name} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯`);
        logEvent('group_duel_request', {from: group.name, to: target.name});
        closeDetailPopup();
      });
    });
    $('#btn-back-duel-select')?.addEventListener('click',()=>showGroupDetail(group));
  }

  function openCreateGroup(){
    const content = `
      <div class="space-y-4">
        <input id="new-group-name" class="form-input" placeholder="Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡">
        <div id="invite-container" class="hidden space-y-2">
          <label class="block text-sm opacity-90">Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª</label>
          <div class="flex">
            <input id="new-group-link" class="form-input flex-1" readonly>
            <button id="btn-copy-link" class="btn btn-secondary ml-2"><i class="fas fa-copy"></i></button>
          </div>
          <div class="text-xs opacity-80">Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù† Ø®ÙˆØ¯ Ø¨Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯</div>
        </div>
        <button id="btn-save-group" class="btn btn-group w-full"><i class="fas fa-check ml-2"></i> Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡</button>
      </div>`;
    showDetailPopup('Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯', content);
    $('#btn-save-group').addEventListener('click', () => {
      const name = $('#new-group-name').value.trim();
      if(!name){ toast('Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
      const newGroup = {
        id: 'g'+(State.groups.length+1),
        name,
        score: 0,
        members: 1,
        admin: State.user.name,
        created: new Date().toLocaleDateString('fa-IR'),
        memberList: [State.user.name],
        requests: [],
        matches: []
      };
      State.groups.push(newGroup);
      State.user.group = name;
      saveState();
      renderGroupSelect();
      $('#user-group').textContent = State.user.group;
      logEvent('group_created', { group: name });
      const link = location.origin + '/?join=' + newGroup.id;
      $('#new-group-link').value = link;
      $('#invite-container').classList.remove('hidden');
      $('#btn-copy-link').addEventListener('click', () => {
        navigator.clipboard.writeText(link);
        toast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯');
      });
      $('#btn-save-group').disabled = true;
      toast('Ú¯Ø±ÙˆÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
    });
  }
  
  // ===== Quiz Flow (legacy) =====
  function buildSet(cat, diff, count){
    let pool = qBank.filter(q => (cat==='Ù‡Ù…Ù‡' || q.cat===cat) && (diff==='Ù‡Ù…Ù‡' || q.diff===diff));
    if(pool.length < count) pool = qBank.slice(); // fallback
    return pool.sort(()=>Math.random()-0.5).slice(0, count);
  }
  
  function resetTimer(seconds){
    const circ = 2*Math.PI*64;
    const ring = $('#timer-ring');
    ring.setAttribute('stroke-dasharray', String(circ));
    ring.style.strokeDashoffset='0';
    $('#timer-text').textContent = faNum(seconds);
    State.quiz.duration = seconds; State.quiz.remain = seconds;
    if(State.quiz.timer) clearInterval(State.quiz.timer);
    State.quiz.timer = setInterval(()=>{
      State.quiz.remain -= 1;
      const r = clamp(State.quiz.remain,0,seconds);
      $('#timer-text').textContent = faNum(r);
      const off = circ*(1 - r/seconds); ring.style.strokeDashoffset = String(off);
      if(r<=5 && r>0) SFX.tick();
      if(r<=0){ clearInterval(State.quiz.timer); lockChoices(); showContinue(); registerAnswer(-1); }
    },1000);
  }
  
  function renderQuestionUI(q){
    $('#quiz-cat').innerHTML = `<i class="fas fa-folder ml-1"></i> ${q.cat}`;
    $('#quiz-diff').innerHTML = `<i class="fas fa-signal ml-1"></i> ${q.diff}`;
    $('#qnum').textContent = faNum(State.quiz.idx+1);
    $('#qtotal').textContent = faNum(State.quiz.list.length);
    $('#question').textContent = q.q;
    const box = $('#choices'); box.innerHTML='';
    q.c.forEach((txt,idx)=>{
      const btn = document.createElement('button');
      btn.className='choice'; btn.setAttribute('aria-label','Ú¯Ø²ÛŒÙ†Ù‡ '+faNum(idx+1));
      btn.innerHTML = `<span class="chip">${faNum(idx+1)}</span><span>${txt}</span>`;
      btn.addEventListener('click', ()=> selectAnswer(idx));
      box.appendChild(btn);
    });
  }
  
  function startQuiz({cat, diff, count}){
    State.quiz.cat=cat; State.quiz.diff=diff;
    State.quiz.list = buildSet(cat, diff, count).map(q=>({ ...q }));
    State.quiz.idx = 0; State.quiz.sessionEarned = 0; State.quiz.results=[];
    State.quiz.inProgress = true; State.quiz.answered=false; $('#btn-continue').classList.add('hidden');
    renderTopBars();
    const q = State.quiz.list[0];
    renderQuestionUI(q);
    resetTimer(diff==='Ø³Ø®Øª'?20:diff==='Ù…ØªÙˆØ³Ø·'?25:30);

    if(State.duelOpponent){
      $('#duel-opponent-name').textContent = State.duelOpponent.name;
      $('#duel-banner').classList.remove('hidden');
    } else {
      $('#duel-banner').classList.add('hidden');
    }

    // Log analytics
    logEvent('quiz_start', { category: cat, difficulty: diff, questionCount: count });
  }
  
  function lockChoices(){ $$('#choices .choice').forEach(el=> el.classList.add('pointer-events-none','opacity-70')); }
  function showContinue(){ if(State.lives<=0){ $('#btn-continue').classList.remove('hidden'); } }
  
  function registerAnswer(idx){
    const q = State.quiz.list[State.quiz.idx] || {};
    const correct = q.a;
    const ok = (idx===correct);
    const base = ok ? 100 : 0;
    const timeBonus = ok ? Math.floor((State.quiz.remain/State.quiz.duration)*50) : 0;
    const boostActive = Date.now() < State.boostUntil;
    const vipBonus = Server.subscription.active ? 20 : 0; // VIP from server
    const earned = Math.floor((base + timeBonus + vipBonus) * (boostActive?2:1));
    
    if(ok){
      State.score += earned; State.coins += 5; State.quiz.sessionEarned += earned; SFX.correct(); vibrate(30);
    } else {
      State.lives -= 1; 
      // Use a life from the limit
      useGameResource('lives');
      SFX.wrong(); vibrate([10,30,10]);
      if(State.lives<=0) showContinue();
    }
    
    State.quiz.results.push({ q:q.q, ok, correct: q.c[correct], you: idx>=0 ? q.c[idx] : 'â€”' });
    saveState(); renderHeader(); renderTopBars();
    
    // Log analytics
    logEvent('question_answered', { 
      correct: ok, 
      timeSpent: State.quiz.duration - State.quiz.remain,
      category: q.cat,
      difficulty: q.diff
    });
  }
  
  function selectAnswer(idx){
    if(State.quiz.answered) return;
    State.quiz.answered = true; clearInterval(State.quiz.timer);
    const correct = State.quiz.list[State.quiz.idx].a;
    const list = $$('#choices .choice');
    list.forEach((el,i)=> el.classList.add(i===correct? 'correct':'wrong'));
    lockChoices();
    registerAnswer(idx);
    setTimeout(nextQuestion, 900);
  }
  
  function nextQuestion(){
    State.quiz.answered=false;
    State.quiz.idx++;
    if(State.quiz.idx >= State.quiz.list.length){
      endQuiz();
      return;
    }
    const q = State.quiz.list[State.quiz.idx];
    renderQuestionUI(q);
    resetTimer(State.quiz.diff==='Ø³Ø®Øª'?20:State.quiz.diff==='Ù…ØªÙˆØ³Ø·'?25:30);
  }
  
  async function endQuiz(){
    State.quiz.inProgress=false;
    const correctCount = State.quiz.results.filter(r=>r.ok).length;
    if(correctCount>0 && !State.achievements.firstWin){ 
      State.achievements.firstWin=true; 
      toast('<i class="fas fa-award ml-2"></i>Ù†Ø´Ø§Ù† Â«Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø±Ø¯Â» Ø¢Ø²Ø§Ø¯ Ø´Ø¯!'); 
      shootConfetti(); 
    }
    if(correctCount>=10 && !State.achievements.tenCorrect){ 
      State.achievements.tenCorrect=true; 
      toast('<i class="fas fa-medal ml-2"></i>Ù†Ø´Ø§Ù† Â«Û±Û° Ù¾Ø§Ø³Ø® Ø¯Ø±Ø³ØªÂ»!'); 
    }
    $('#res-correct').textContent = faNum(correctCount);
    $('#res-wrong').textContent = faNum(State.quiz.results.length - correctCount);
    $('#res-earned').textContent = faNum(State.quiz.sessionEarned);
    const wrap = $('#res-list'); wrap.innerHTML='';
    State.quiz.results.forEach((r,i)=>{
      const row=document.createElement('div'); row.className='bg-white/10 border border-white/20 rounded-xl px-3 py-2';
      row.innerHTML=`<div class="text-sm font-bold mb-1">${faNum(i+1)}. ${r.q}</div>
        <div class="text-xs ${r.ok?'text-emerald-300':'text-rose-300'}">${r.ok?'Ø¯Ø±Ø³Øª':'Ù†Ø§Ø¯Ø±Ø³Øª'}</div>
        <div class="text-xs opacity-90">Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­: ${r.correct}</div>
        <div class="text-xs opacity-70">Ù¾Ø§Ø³Ø® Ø´Ù…Ø§: ${r.you}</div>`;
      wrap.appendChild(row);
    });
    if(State.duelOpponent){
      const total = State.quiz.list.length;
      const opponentCorrect = Math.floor(Math.random()*(total+1));
      const opponentWrong = total - opponentCorrect;
      const opponentEarned = opponentCorrect * 120;
      const yourCorrect = correctCount;
      const yourWrong = total - correctCount;
      const yourEarned = State.quiz.sessionEarned;
      const youName = State.user?.name || 'Ø´Ù…Ø§';
      const oppName = State.duelOpponent.name;
      $('#duel-avatar-you').src = State.user?.avatar || 'https://i.pravatar.cc/60?img=1';
      $('#duel-name-you').textContent = youName;
      $('#duel-avatar-opponent').src = State.duelOpponent.avatar || '';
      $('#duel-name-opponent').textContent = oppName;
      let winnerText = 'Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ù…Ø³Ø§ÙˆÛŒ Ø´Ø¯!';
      if (yourEarned > opponentEarned) {
        winnerText = `${youName} Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯!`;
        State.duelWins++;
      }
      else if (yourEarned < opponentEarned) {
        winnerText = `${oppName} Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯!`;
        State.duelLosses++;
      }
      $('#duel-winner').textContent = winnerText;
      $('#duel-stats').innerHTML = `${youName}: ${faNum(yourCorrect)} Ø¯Ø±Ø³ØªØŒ ${faNum(yourWrong)} Ù†Ø§Ø¯Ø±Ø³ØªØŒ ${faNum(yourEarned)} Ø§Ù…ØªÛŒØ§Ø²<br>${oppName}: ${faNum(opponentCorrect)} Ø¯Ø±Ø³ØªØŒ ${faNum(opponentWrong)} Ù†Ø§Ø¯Ø±Ø³ØªØŒ ${faNum(opponentEarned)} Ø§Ù…ØªÛŒØ§Ø²`;
      $('#duel-result').classList.remove('hidden');
      renderDashboard();
    } else {
      $('#duel-result').classList.add('hidden');
    }
    saveState();
    navTo('results');
    AdManager.maybeShowInterstitial('post_quiz');
  }
  
  // ===== Streak / Daily (legacy) =====
  function claimStreak(){
    const nowDay = Math.floor(Date.now()/86400000);
    if(State.lastClaim === nowDay){ toast('<i class="fas fa-info-circle ml-2"></i>Ø§Ù…Ø±ÙˆØ² Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒ'); return; }
    const yesterday = nowDay - 1;
    if(State.lastClaim === yesterday) State.streak += 1; else State.streak = 1;
    State.lastClaim = nowDay;
    const reward = 5 * State.streak;
    State.coins += reward; State.score += reward*10;
    saveState(); renderDashboard(); renderHeader();
    toast(`<i class="fas fa-gift ml-2"></i>Ù¾Ø§Ø¯Ø§Ø´ Ø§Ù…Ø±ÙˆØ²: ${faNum(reward)}ğŸ’° ğŸ‰`);
    if(State.streak>=3 && !State.achievements.streak3){ State.achievements.streak3=true; toast('<i class="fas fa-fire ml-2"></i>Ù†Ø´Ø§Ù† Â«Ø§Ø³ØªØ±ÛŒÚ© Û³ Ø±ÙˆØ²Ù‡Â»!'); }
  }
  
  function startDaily(){
    const seed = Math.floor(Date.now()/86400000);
    const pool = qBank.slice().map((q,i)=>({q, k: Math.sin((i+1)*seed)*10000})).sort((a,b)=>a.k-b.k).map(o=>o.q);
    State.lives = Math.max(State.lives, 1);
    State.quiz.cat='Ø¹Ù…ÙˆÙ…ÛŒ'; State.quiz.diff='Ù…ØªÙˆØ³Ø·'; State.quiz.list=pool.slice(0,5);
    State.quiz.idx=0; State.quiz.sessionEarned=0; State.quiz.results=[]; State.quiz.inProgress=true; State.quiz.answered=false;
    navTo('quiz'); renderTopBars(); renderQuestionUI(State.quiz.list[0]); resetTimer(25);
  }
  
  // ===== Shop (legacy soft-currency), VIP button rerouted =====

// ===== Shop (Keys) =====
function renderShop(){
  // Ù…ÙˆØ¬ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
  if ($('#shop-gcoins'))  $('#shop-gcoins').textContent  = faNum(State.coins);
  if ($('#shop-wallet'))  $('#shop-wallet').textContent  = (Server.wallet.coins==null?'â€”':faNum(Server.wallet.coins));
  if ($('#keys-count'))   $('#keys-count').textContent   = faNum(State.keys || 0);

  // Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² RemoteConfig Ø¨Ø®ÙˆØ§Ù† Ùˆ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†
  const packs = RemoteConfig.pricing.keys || [];
  packs.forEach(p => {
    const el = document.querySelector(`[data-buy-key="${p.id}"]`);
    if(!el) return;
    el.querySelector('[data-amount]').textContent = faNum(p.amount);
    el.querySelector('[data-price]').textContent  = faNum(p.priceGame);
    const cant = State.coins < p.priceGame;
    el.disabled = cant;
    el.title = cant ? 'Ø³Ú©Ù‡Ù” Ø¨Ø§Ø²ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª' : `Ø®Ø±ÛŒØ¯ ${faNum(p.amount)} Ú©Ù„ÛŒØ¯`;
  });

  // Ù†Ø´Ø§Ù† Â«Ø¨Ù‡â€ŒØµØ±ÙÙ‡â€ŒØªØ±ÛŒÙ†Â» Ø±Ø§ Ø±ÙˆÛŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ù†Ø³Ø¨Øª Ù‚ÛŒÙ…Øª/ØªØ¹Ø¯Ø§Ø¯ Ø¨Ú¯Ø°Ø§Ø±
  const best = packs.reduce((a,b)=> (a.priceGame/a.amount <= b.priceGame/b.amount) ? a : b, packs[0]);
  document.querySelectorAll('.product-card .ribbon.auto').forEach(n=>n.remove());
  if (best) {
    const bestBtn = document.querySelector(`[data-buy-key="${best.id}"]`);
    if (bestBtn && !bestBtn.querySelector('.ribbon')) {
      const badge = document.createElement('div');
      badge.className = 'ribbon auto';
      badge.textContent = 'Ø¨Ù‡â€ŒØµØ±ÙÙ‡â€ŒØªØ±ÛŒÙ†';
      bestBtn.appendChild(badge);
    }
  }
}


function buyKeys(packId){
  const pack = RemoteConfig.pricing.keys.find(p => p.id === packId);
  if (!pack){ toast('Ø¨Ø³ØªÙ‡Ù” Ú©Ù„ÛŒØ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }

  if (State.coins < pack.priceGame){
    toast('<i class="fas fa-exclamation-circle ml-2"></i> Ø³Ú©Ù‡Ù” Ø¨Ø§Ø²ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª'); 
    return;
  }

  State.coins -= pack.priceGame;
  State.keys = (State.keys || 0) + pack.amount;

  saveState();
  renderHeader();       // Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø³Ú©Ù‡ Ø¯Ø± Ù‡Ø¯Ø±
  renderDashboard();    // Ø§Ú¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø§Ø² Ø¨ÙˆØ¯
  renderTopBars();      // Ø§Ú¯Ø± Ø¯Ø§Ø®Ù„ Ù…Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ
  renderShop();         // Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡

  SFX.coin();
  toast(`<i class="fas fa-check-circle ml-2"></i> ${faNum(pack.amount)} Ú©Ù„ÛŒØ¯ Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯`);
  logEvent('purchase_item', { item:'keys', pack: pack.id, amount: pack.amount, price: pack.priceGame });
}

// Ù„ÛŒØ³Ù†Ø± Ú©Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ú©Ù„ÛŒØ¯ (event delegation)
document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-buy-key]');
  if (!btn) return;
  buyKeys(btn.dataset.buyKey);
});


  function buy(item){
    const price = { life:30, boost:50, hint:20, streak:40 }[item];
    if(price==null) return;
    if(State.coins < price){ toast('<i class="fas fa-exclamation-circle ml-2"></i>Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª'); return; }
    State.coins -= price;
    if(item==='life') State.lives += 1;
    if(item==='boost') State.boostUntil = Date.now() + 10*60*1000;
    if(item==='hint') { /* Hint logic */ }
    if(item==='streak') { /* Streak protection logic */ }
    saveState(); renderDashboard(); renderTopBars();
    SFX.coin(); toast('<i class="fas fa-check-circle ml-2"></i>Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
    
    // Log analytics
    logEvent('purchase_item', { item, price });
  }
  
  // ===== Wallet (server) =====
function buildPackages(){
  const grid = $('#pkg-grid');
  grid.innerHTML = '';

  // Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø±Ø§ÛŒ ÙˆÙ‚ØªÛŒ priceToman Ù†Ø¨Ø§Ø´Ù‡
  const usdToToman = RemoteConfig?.pricing?.usdToToman || 70_000;

  // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ Ø¨Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÛŒ Ù‚ÛŒÙ…Øª ØªÙˆÙ…Ø§Ù†ÛŒ Ùˆ Ø§Ø±Ø²Ø´ Ù‡Ø± Ù¾Ú©ÛŒØ¬
  const packs = (RemoteConfig?.pricing?.coins || []).map(p => {
    const bonus = Number(p.bonus || 0);
    const priceToman = (typeof p.priceToman === 'number' && p.priceToman > 0)
      ? p.priceToman
      : Math.round(((p.priceCents || 0) / 100) * usdToToman);

    const received = p.amount + Math.floor(p.amount * bonus / 100); // Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø±ÛŒØ§ÙØªÛŒ
    const valueScore = priceToman > 0 ? (received / priceToman) : 0; // Ø³Ú©Ù‡ Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± ØªÙˆÙ…Ø§Ù†

    return { ...p, bonus, priceToman, received, valueScore };
  });

  if (!packs.length){
    grid.innerHTML = `<div class="glass-dark rounded-2xl p-4 text-center opacity-80">
      Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¨Ø³ØªÙ‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª
    </div>`;
    return;
  }

  // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ù‡â€ŒØµØ±ÙÙ‡â€ŒØªØ±ÛŒÙ† Ø¨Ø³ØªÙ‡
  const best = packs.reduce((a,b) => (a.valueScore >= b.valueScore ? a : b), packs[0]);

  // Ø±Ù†Ø¯Ø± Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§
  packs.forEach(pkg => {
    const card = document.createElement('div');
    card.className = 'glass-dark rounded-2xl p-4 card-hover flex flex-col justify-between relative h-full';

    const bonusBadge = pkg.bonus
      ? `<span class="chip bg-white/20"><i class="fas fa-gift ml-1"></i> ${faNum(pkg.bonus)}%</span>`
      : '';

    const bestRibbon = (pkg.id === best.id)
      ? `<div class="ribbon">Ø¨Ù‡â€ŒØµØ±ÙÙ‡â€ŒØªØ±ÛŒÙ†</div>`
      : '';

    card.innerHTML = `
      ${bestRibbon}
      <div class="flex items-center justify-between">
        <div class="text-lg font-bold">${faNum(pkg.amount)} Ø³Ú©Ù‡</div>
        ${bonusBadge}
      </div>
      <div class="text-sm opacity-80 mt-1">${faNum(pkg.received)} Ø¯Ø±ÛŒØ§ÙØªÛŒ</div>

      <button class="btn btn-primary mt-3 buy-pkg"
              data-id="${pkg.id}"
              aria-label="Ø®Ø±ÛŒØ¯ Ø¨Ø³ØªÙ‡ ${faNum(pkg.amount)} Ø³Ú©Ù‡">
        Ù¾Ø±Ø¯Ø§Ø®Øª ${faNum(pkg.priceToman)} <span class="text-xs">ØªÙˆÙ…Ø§Ù†</span>
      </button>
    `;

    grid.appendChild(card);
  });

  // ÙˆØ¶Ø¹ÛŒØª Ú©ÛŒÙ Ù¾ÙˆÙ„ Ùˆ Ø¢ÙÙ„Ø§ÛŒÙ†
  $('#wallet-balance').textContent = (Server.wallet.coins == null ? 'â€”' : faNum(Server.wallet.coins));
  $('#wallet-offline').classList.toggle('hidden', online());
}




// Enhanced Payment Modal Functions
let currentPackageData = null;

function showPaymentModal(packageId) {
  const pkg = RemoteConfig.pricing.coins.find(p => p.id === packageId);
  if (!pkg) {
    toast('Ø¨Ø³ØªÙ‡ ÛŒØ§ÙØª Ù†Ø´Ø¯');
    return;
  }
  
  currentPackageData = pkg;
  
  // Calculate price in Toman
  const priceToman = pkg.priceToman || Math.round(((pkg.priceCents || 0) / 100) * (RemoteConfig.pricing.usdToToman || 70000));
  const totalCoins = pkg.amount + Math.floor(pkg.amount * (pkg.bonus || 0) / 100);
  const walletBalance = Server.wallet.coins || 0;
  
  // Update modal content
  $('#payment-package-name').textContent = `Ø¨Ø³ØªÙ‡ ${faNum(pkg.amount)} Ø³Ú©Ù‡`;
  $('#payment-coins-amount').textContent = `${faNum(totalCoins)} Ø³Ú©Ù‡`;
  $('#payment-price').textContent = `${faNum(priceToman)} ØªÙˆÙ…Ø§Ù†`;
  $('#payment-wallet-balance').textContent = `${faNum(walletBalance)} ØªÙˆÙ…Ø§Ù†`;
  
  // Check if wallet balance is sufficient
  const needsPayment = walletBalance < priceToman;
  $('#payment-warning').classList.toggle('show', needsPayment);
  
  // Update button text based on balance
  const confirmBtn = $('#payment-confirm-btn');
  if (needsPayment) {
    confirmBtn.innerHTML = '<i class="fas fa-credit-card ml-2"></i> Ø±ÙØªÙ† Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª';
  } else {
    confirmBtn.innerHTML = '<i class="fas fa-check ml-2"></i> ØªØ§ÛŒÛŒØ¯ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª';
  }
  
  // Set up click handler
  confirmBtn.onclick = () => handlePaymentConfirm(pkg.id, priceToman, needsPayment);
  
  // Show modal
  $('#modal-payment').classList.add('show');
  
  // Animate icon
  setTimeout(() => {
    $('#modal-payment .payment-icon').style.transform = 'scale(1.1)';
    setTimeout(() => {
      $('#modal-payment .payment-icon').style.transform = 'scale(1)';
    }, 200);
  }, 100);
}

function closePaymentModal() {
  $('#modal-payment').classList.remove('show');
  currentPackageData = null;
}

async function handlePaymentConfirm(packageId, priceToman, needsPayment) {
  if (needsPayment) {
    // Redirect to payment gateway
    closePaymentModal();
    
    // Show loading toast
    toast('<i class="fas fa-spinner fa-spin ml-2"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª...');
    
    // Log analytics
    await logEvent('payment_gateway_redirect', { 
      packageId, 
      priceToman,
      reason: 'insufficient_balance' 
    });
    
    // Simulate redirect (in real app, this would be actual payment gateway URL)
    setTimeout(() => {
      window.location.href = '/payment?package=' + packageId + '&amount=' + priceToman;
    }, 1000);
  } else {
    // Process payment with wallet balance
    closePaymentModal();
    startPurchaseCoins(packageId);
  }
}

  function showPayConfirm(btn){
    const pkgId = btn.dataset.id;
    const price = parseFloat(btn.dataset.price||'0');
    const wallet = Server.wallet.coins||0;
    $('#pay-popup-message').innerHTML = `Ù‚ÛŒÙ…Øª Ø¨Ø³ØªÙ‡: ${faNum(price)} ØªÙˆÙ…Ø§Ù†`;
    $('#pay-popup-wallet').innerHTML = `Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„: ${faNum(wallet)} ØªÙˆÙ…Ø§Ù†`;
    $('#pay-popup-confirm').onclick = ()=>{
      closeModal('#modal-pay-confirm');
      if(wallet >= price){
        startPurchaseCoins(pkgId);
      }else{
        window.location.href = '/payment';
      }
    };
    openModal('#modal-pay-confirm');
  }
  
  function renderVipStatusPill(){
    const s = Server.subscription;
    const pill = $('#vip-status-pill');
    if(s.status==='unknown'){ pill.innerHTML = '<i class="fas fa-circle-notch fa-spin ml-1"></i> Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª...'; return; }
    if(s.active){
      pill.innerHTML = `<i class="fas fa-check ml-1"></i> ${s.tier === 'pro' ? 'Ù¾Ø±Ùˆ' : 'Ù„Ø§ÛŒØª'} ØªØ§ ${s.expiry ? new Date(s.expiry).toLocaleDateString('fa-IR'):'â€”'}`;
    } else {
      pill.innerHTML = `<i class="fas fa-ban ml-1"></i> ØºÛŒØ±ÙØ¹Ø§Ù„`;
    }
  }
  
  function updateVipUI(){
    renderVipStatusPill();
    const meta = $('#vip-meta');
    const s = Server.subscription;
    if(s.active){
      meta.innerHTML = `<div class="chip"><i class="fas fa-rotate ml-1"></i> ØªÙ…Ø¯ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±: ${s.autoRenew?'Ø¨Ù„Ù‡':'Ø®ÛŒØ±'}</div>`;
    } else {
      meta.innerHTML = `<div class="text-sm opacity-80">Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ØªØ¨Ù„ÛŒØºØ§Øª Ùˆ Ù…Ø²Ø§ÛŒØ§ØŒ ÛŒÚ©ÛŒ Ø§Ø² Ù¾Ù„Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</div>`;
    }
    // Disable ad UI if VIP
    AdManager.refreshAll();
  }
  
  // ===== Payments & Subscription =====
  async function refreshWallet(){
    const data = await Net.jget('/api/wallet');
    if(data && typeof data.coins==='number'){ 
      Server.wallet.coins = data.coins; 
      $('#hdr-wallet').textContent = faNum(Server.wallet.coins); 
      $('#stat-wallet').textContent = faNum(Server.wallet.coins); 
      $('#wallet-balance').textContent = faNum(Server.wallet.coins); 
    }
  }
  
  async function refreshSubscription(){
    const data = await Net.jget('/api/subscription/me');
    if(data && typeof data.active==='boolean'){
      Server.subscription.active = data.active;
      Server.subscription.status = data.active ? 'active':'inactive';
      Server.subscription.expiry = data.expiry||null;
      Server.subscription.autoRenew = !!data.autoRenew;
      Server.subscription.plan = data.plan||null;
      Server.subscription.tier = data.tier||null;
      // Reflect to UI; gameplay VIP bonus already uses Server.subscription.active
      renderHeader(); renderDashboard(); renderVipStatusPill(); AdManager.refreshAll();
      
      // Update limits UI when VIP status changes
      updateLimitsUI();
    }
  }
  
  function genIdemKey(){ return 'idem_'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
  
async function startPurchaseCoins(pkgId){
  if(!online()){ toast('<i class="fas fa-wifi-slash ml-2"></i> Ø¢ÙÙ„Ø§ÛŒÙ† Ù‡Ø³ØªÛŒ'); return; }
  const pkg = (RemoteConfig.pricing.coins || []).find(p=>p.id===pkgId);
  if(!pkg){ toast('Ø¨Ø³ØªÙ‡ ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }

  const priceTmn = coinPriceToman(pkg);             // ØªÙˆÙ…Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ùˆ Ø±Ø³ÛŒØ¯
  const idem = genIdemKey();
  const btn = document.querySelector(`.buy-pkg[data-id="${pkgId}"]`);
  const normalLabel = `<i class="fas fa-credit-card ml-1"></i> Ù¾Ø±Ø¯Ø§Ø®Øª ${formatToman(priceTmn)}`;

  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´...';

  await logEvent('purchase_initiated', { kind:'coins', pkgId, priceCents:pkg.priceCents, priceToman:priceTmn, idem });

  const res = await Net.jpost('/api/payments/create', {
    idempotencyKey: idem,
    type:'coins',
    packageId: pkgId
  });

  if(!res || !res.txnId){
    btn.disabled = false;
    btn.innerHTML = normalLabel;
    toast('<i class="fas fa-triangle-exclamation ml-2"></i> Ø§ÛŒØ¬Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚');
    await logEvent('purchase_failed', { kind:'coins', pkgId, reason:'create_failed' });
    return;
  }

  const txnId = res.txnId;
  // Poll wallet until updated or timeout
  const before = Server.wallet.coins;
  let ok=false;
  for(let i=0;i<20;i++){
    await wait(1000);
    await refreshWallet();
    if(Server.wallet.coins!=null && (before==null || Server.wallet.coins>before)){ ok=true; break; }
  }

  btn.disabled = false;
  btn.innerHTML = normalLabel;

  if(ok){
    Server.wallet.lastTxnId = txnId;
    openReceipt({
      title:'Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯',
      rows:[
        ['Ú©Ø¯ ØªØ±Ø§Ú©Ù†Ø´', txnId],
        ['Ø¨Ø³ØªÙ‡', `${faNum(pkg.amount)} (+${pkg.bonus||0}%)`],
        ['Ù…Ø¨Ù„Øº', formatToman(priceTmn)],
        ['Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯', faNum(Server.wallet.coins)]
      ]
    });
    await logEvent('purchase_succeeded', { kind:'coins', pkgId, txnId, priceToman:priceTmn });
    SFX.coin();
  } else {
    openReceipt({
      title:'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯',
      rows:[
        ['Ú©Ø¯ ØªØ±Ø§Ú©Ù†Ø´', txnId],
        ['ÙˆØ¶Ø¹ÛŒØª', 'Ù‡Ù†ÙˆØ² ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡Ø› Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.']
      ]
    });
    await logEvent('purchase_failed', { kind:'coins', pkgId, txnId, reason:'confirm_timeout' });
  }
}

  
  function openReceipt({title, rows}){
    $('#receipt-body').innerHTML = `<div class="font-bold mb-2">${title}</div>` + rows.map(r=>`<div class="flex items-center justify-between"><span class="opacity-80">${r[0]}</span><span class="font-bold">${r[1]}</span></div>`).join('');
    openModal('#modal-receipt');
  }
  
  async function startPurchaseVip(tier){
    if(!online()){ toast('<i class="fas fa-wifi-slash ml-2"></i> Ø¢ÙÙ„Ø§ÛŒÙ† Ù‡Ø³ØªÛŒ'); return; }
    const pricing = RemoteConfig.pricing.vip[tier];
    if(!pricing){ toast('Ù¾Ù„Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }
    const idem = genIdemKey();
    const btn = (tier==='lite')?$('#buy-vip-lite'):$('#buy-vip-pro');
    btn.disabled = true; const prevHTML = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø§ÛŒØ¬Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´...';
    await logEvent('purchase_initiated', { kind:'vip', tier, priceCents:pricing.priceCents, idem });
    const res = await Net.jpost('/api/payments/create', { idempotencyKey: idem, type:'vip', tier });
    if(!res || !res.txnId){
      btn.disabled=false; btn.innerHTML = prevHTML; 
      toast('<i class="fas fa-triangle-exclamation ml-2"></i> Ø§ÛŒØ¬Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´ VIP Ù†Ø§Ù…ÙˆÙÙ‚'); 
      await logEvent('purchase_failed', { kind:'vip', tier, reason:'create_failed' }); 
      return;
    }
    const txnId = res.txnId;
    // Poll subscription
    let ok=false;
    for(let i=0;i<20;i++){ await wait(1200); await refreshSubscription(); if(Server.subscription.active){ ok=true; break; } }
    btn.disabled=false; btn.innerHTML = prevHTML;
    if(ok){
      await logEvent('purchase_succeeded', { kind:'vip', tier, txnId });
      await logEvent('vip_activated', { tier, expiry: Server.subscription.expiry||null });
      openReceipt({ title:'Ø§Ø´ØªØ±Ø§Ú© ÙØ¹Ø§Ù„ Ø´Ø¯ ğŸ‰', rows:[
        ['Ú©Ø¯ ØªØ±Ø§Ú©Ù†Ø´', txnId],
        ['Ù¾Ù„Ù†', tier==='lite'?'Ù„Ø§ÛŒØª':'Ù¾Ø±Ùˆ'],
        ['ØªØ§ ØªØ§Ø±ÛŒØ®', Server.subscription.expiry ? new Date(Server.subscription.expiry).toLocaleDateString('fa-IR') : 'â€”']
      ]});
      renderHeader(); renderDashboard(); AdManager.refreshAll(); shootConfetti();
    } else {
      await logEvent('purchase_failed', { kind:'vip', tier, txnId, reason:'confirm_timeout' });
      openReceipt({ title:'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©', rows:[['Ú©Ø¯ ØªØ±Ø§Ú©Ù†Ø´', txnId], ['ÙˆØ¶Ø¹ÛŒØª', 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...']] });
    }
  }
  
  // ===== Ads Manager =====
  const AdManager = {
    enabled(){ return RemoteConfig.ads.enabled && !Server.subscription.active; },
    getLocalAd(placement){
      const ads = State.ads?.[placement] || [];
      const now = Date.now();
      const province = Server.user.province || State.user.province;
      return ads.find(a => {
        const start = new Date(a.startDate).getTime();
        const end = new Date(a.endDate).getTime();
        const targets = a.provinces || [];
        return now >= start && now <= end && (targets.length === 0 || targets.includes(province));
      }) || null;
    },
    // Banner
    async renderBanner(){
      const slot = $('#ad-banner .ad-banner-inner'); if(!slot) return;
      slot.innerHTML = ''; // reserved height stays via parent
      const local = this.getLocalAd('banner');
      if(local){
        const w=document.createElement('a');
        w.href=local.landing; w.target='_blank';
        w.className='w-full h-full block relative';
        w.innerHTML=`<img src="${local.creative}" alt="banner ad" class="w-full h-full object-cover">`;
        const close=document.createElement('button'); close.className='ad-close'; close.innerHTML='<i class="fas fa-times"></i>';
        close.setAttribute('aria-label','Ø¨Ø³ØªÙ† Ø¨Ù†Ø±');
        close.onclick=()=>{ slot.innerHTML='<div class="ad-skeleton">Ø¨Ù†Ø± Ø¨Ø³ØªÙ‡ Ø´Ø¯</div>'; logEvent('ad_close',{placement:'banner', local:true}); };
        w.appendChild(close); slot.appendChild(w);
        logEvent('ad_impression',{placement:'banner', local:true});
        w.addEventListener('click',()=>logEvent('ad_click',{placement:'banner', local:true}),{once:true});
        return;
      }
      if(!this.enabled() || !RemoteConfig.ads.placements.banner){
        slot.innerHTML = `<div class="ad-skeleton">${Server.subscription.active ? 'ÙˆÛŒâ€ŒØ¢ÛŒâ€ŒÙ¾ÛŒ: Ø¨Ø¯ÙˆÙ† ØªØ¨Ù„ÛŒØº' : 'ØªØ¨Ù„ÛŒØº ØºÛŒØ±ÙØ¹Ø§Ù„'}</div>`;
        return;
      }
      // Try remote, else fallback card
      try{
        const res = await Net.jget('/api/ads?placement=banner&province='+encodeURIComponent(Server.user.province||State.user.province));
        if(res && res.html){
          const w = document.createElement('div'); w.className='w-full h-full relative';
          w.innerHTML = res.html;
          const close = document.createElement('button'); close.className='ad-close'; close.innerHTML='<i class="fas fa-times"></i>'; close.setAttribute('aria-label','Ø¨Ø³ØªÙ† Ø¨Ù†Ø±');
          close.onclick=()=>{ slot.innerHTML=`<div class="ad-skeleton">Ø¨Ù†Ø± Ø¨Ø³ØªÙ‡ Ø´Ø¯</div>`; logEvent('ad_close',{placement:'banner'}); };
          w.appendChild(close);
          slot.appendChild(w);
          logEvent('ad_impression',{placement:'banner'});
          w.addEventListener('click',()=>logEvent('ad_click',{placement:'banner'}),{once:true});
          return;
        }
      }catch{}
      // Fallback
      slot.innerHTML = `<a href="#" class="w-full h-full flex items-center justify-between px-4" aria-label="Ø§Ø³Ù¾Ø§Ù†Ø³Ø± Ù…Ø­Ù„ÛŒ">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-amber-300 to-orange-400"></div>
          <div class="text-sm"><div class="font-bold">Ú©Ø¯ ØªØ®ÙÛŒÙ Ù‡Ù…Ø´Ù‡Ø±ÛŒ</div><div class="opacity-80">SANANDAJ10</div></div>
        </div>
        <i class="fas fa-arrow-left opacity-80"></i>
      </a>`;
      logEvent('ad_impression',{placement:'banner', fallback:true});
    },
    // Native
    async renderNative(selector){
      const slot = document.querySelector(selector); if(!slot) return;
      slot.innerHTML = '<div class="ad-skeleton">ØªØ¨Ù„ÛŒØº Ù‡Ù…Ø³Ø§Ù†</div>';
      const local=this.getLocalAd('native');
      if(local){
        slot.innerHTML=`<div class="w-full flex items-center gap-3 p-3 relative">
            <img src="${local.creative}" class="w-16 h-16 rounded-2xl object-cover" alt="ad">
            <div class="flex-1">
              <div class="font-bold">ØªØ¨Ù„ÛŒØº Ø§Ø³Ù¾Ø§Ù†Ø³Ø±ÛŒ</div>
              <div class="text-xs opacity-80">${new URL(local.landing).hostname}</div>
            </div>
            <a role="button" href="${local.landing}" class="btn btn-primary w-auto px-4 py-2 text-sm" aria-label="Ù…Ø´Ø§Ù‡Ø¯Ù‡">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>
          </div>`;
        logEvent('ad_impression',{placement:'native', local:true});
        slot.querySelector('a')?.addEventListener('click',()=>logEvent('ad_click',{placement:'native', local:true}),{once:true});
        return;
      }
      if(!this.enabled() || !RemoteConfig.ads.placements.native){ slot.innerHTML = '<div class="ad-skeleton">â€”</div>'; return; }
      try{
        const res = await Net.jget('/api/ads?placement=native&province='+encodeURIComponent(Server.user.province||State.user.province));
        if(res && res.title){
          slot.innerHTML = `<div class="w-full flex items-center gap-3 p-3">
            <img src="${res.image||'https://picsum.photos/seed/ad/88/88'}" class="w-16 h-16 rounded-2xl object-cover" alt="ad">
            <div class="flex-1">
              <div class="font-bold">${res.title}</div>
              <div class="text-xs opacity-80">${res.desc||'Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ ÙˆÛŒÚ˜Ù‡ Ø§Ù…Ø±ÙˆØ²'}</div>
            </div>
            <a role="button" href="${res.ctaUrl||'#'}" class="btn btn-primary w-auto px-4 py-2 text-sm" aria-label="Ù…Ø´Ø§Ù‡Ø¯Ù‡">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>
          </div>`;
          logEvent('ad_impression',{placement:'native'});
          slot.querySelector('a')?.addEventListener('click', ()=>logEvent('ad_click',{placement:'native'}), {once:true});
          return;
        }
      }catch{}
      // Fallback to sponsor
      slot.innerHTML = $('#sponsor-card').outerHTML;
      logEvent('ad_impression',{placement:'native', fallback:true});
    },
    // Interstitial (frequency capping)
    async maybeShowInterstitial(trigger){
      if(!this.enabled() || !RemoteConfig.ads.placements.interstitial) return;
      const now = Date.now();
      const caps = RemoteConfig.ads.freqCaps; const sess = RemoteConfig.ads.session;
      if(sess.interstitialShown >= caps.interstitialPerSession) return;
      if(now - sess.lastInterstitialAt < RemoteConfig.ads.interstitialCooldownMs) return;
      sess.interstitialShown++; sess.lastInterstitialAt=now;
      const modal = $('#modal-interstitial'); const frame = $('#interstitial-frame');
      const local = this.getLocalAd('interstitial');
      logEvent('ad_impression',{placement:'interstitial', trigger, local:!!local});
      if(local){
        frame.src = local.creative;
      } else {
        let url = null; try{ const res = await Net.jget('/api/ads?placement=interstitial&province='+encodeURIComponent(Server.user.province||State.user.province)); url = res?.url||null; }catch{}
        frame.src = url || 'about:blank';
        if(!url){ frame.srcdoc = `<style>body{margin:0;display:flex;align-items:center;justify-content:center;background:#111;color:#fff;font-family:sans-serif}</style><div>ØªØ¨Ù„ÛŒØº Ù…Ø­Ù„ÛŒ</div>`; }
      }
      modal.classList.add('show');
      let closed=false;
      function close(){ if(closed) return; closed=true; modal.classList.remove('show'); frame.src='about:blank'; logEvent('ad_close',{placement:'interstitial'}); }
      $('#interstitial-close').onclick = close;
      setTimeout(()=>{ if(!closed){ close(); } }, 10_000);
    },
    // Rewarded
    async showRewarded({reward='coins', amount=20}={}){
      if(!this.enabled() || !RemoteConfig.ads.placements.rewarded){ toast('ØªØ¨Ù„ÛŒØº Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª'); return false; }
      const sess = RemoteConfig.ads.session; if(sess.rewardedShown >= RemoteConfig.ads.freqCaps.rewardedPerSession){ toast('Ø³Ù‚Ù ØªÙ…Ø§Ø´Ø§ÛŒ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ù…Ø±ÙˆØ² ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡'); return false; }
      if(Server.subscription.active){ toast('Ø¯Ø± VIP ØªØ¨Ù„ÛŒØºØ§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯'); return false; }
      sess.rewardedShown++;
      const modal = $('#modal-rewarded'); const vid = $('#rewarded-video'); const claim = $('#rewarded-claim'); const cd = $('#rewarded-countdown');
      const local = this.getLocalAd('rewarded');
      let src = null;
      if(local){
        src = local.creative;
      } else {
        try{ const res = await Net.jget('/api/ads?placement=rewarded&province='+encodeURIComponent(Server.user.province||State.user.province)); src = res?.video||null; }catch{}
      }
      if(!src){
        vid.removeAttribute('src'); vid.querySelector('source').src=''; vid.load();
        cd.textContent = 'Ø§Ø³Ù¾Ø§Ù†Ø³Ø± Ù…Ø­Ù„ÛŒ â€” Ù¾Ø®Ø´ Ù†Ù…Ø§Ø¯ÛŒÙ†';
      } else {
        vid.querySelector('source').src = src; vid.load();
      }
      claim.disabled = true; let canClaimAt = Date.now()+RemoteConfig.ads.rewardedMinWatchMs;
      const t = setInterval(()=>{
        const left = Math.max(0, Math.ceil((canClaimAt - Date.now())/1000));
        cd.textContent = left>0 ? `Ù¾Ø³ Ø§Ø² ${faNum(left)} Ø«Ø§Ù†ÛŒÙ‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ù¾Ø§Ø¯Ø§Ø´ Ø¨Ú¯ÛŒØ±ÛŒ` : 'Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ù¾Ø§Ø¯Ø§Ø´ Ø¨Ú¯ÛŒØ±ÛŒ';
        if(left<=0){ claim.disabled=false; clearInterval(t); }
      }, 250);
      modal.classList.add('show');
      return new Promise(resolve=>{
        function cleanup(ok){ modal.classList.remove('show'); vid.pause(); claim.disabled=true; resolve(!!ok); }
        $('#rewarded-close').onclick=()=>{ logEvent('ad_close',{placement:'rewarded'}); cleanup(false); };
        claim.onclick=async ()=>{
          cleanup(true);
          if(reward==='coins'){ State.coins += amount; renderTopBars(); saveState(); }
          if(reward==='life'){ State.lives += 1; renderTopBars(); saveState(); }
          await logEvent('ad_completed',{placement:'rewarded', reward, amount});
          await logEvent('reward_granted',{reward, amount});
          const rewardName = reward==='coins'?'Ø³Ú©Ù‡':'Ú©Ù„ÛŒØ¯';
          toast(`<i class="fas fa-check ml-1"></i> Ù¾Ø§Ø¯Ø§Ø´ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: ${faNum(amount)} ${rewardName}`);
          SFX.coin();
        };
      });
    },
    async refreshAll(){
      this.renderBanner();
      this.renderNative('#ad-native-dashboard');
      this.renderNative('#ad-native-lb');
    }
  };
  
  // ===== Notifications / Modals / Theme =====
  function openModal(sel){ const m=$(sel); m.classList.add('show'); }
  function closeModal(sel){ const m=$(sel); m.classList.remove('show'); }
  $('#set-sound')?.addEventListener('change', e=>{ State.settings.sound = e.target.checked; saveState(); });
  $('#set-haptics')?.addEventListener('change', e=>{ State.settings.haptics = e.target.checked; saveState(); });
  $('#set-theme')?.addEventListener('change', e=>{
    const night = e.target.checked; State.theme = night ? 'night' : 'ocean';
    document.documentElement.setAttribute('data-theme', State.theme); saveState();
  });
  
  // Lifelines
  let used5050=false, usedSkip=false, paused=false;
  function life5050(){
    if(used5050) return toast('ÛµÛ°â€“ÛµÛ° Ø±Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯ÛŒ ğŸ˜…');
    used5050=true;
    const correct = State.quiz.list[State.quiz.idx].a;
    const idxs = [0,1,2,3].filter(i=>i!==correct).sort(()=>Math.random()-0.5).slice(0,2);
    idxs.forEach(i=>{ const el=$$('#choices .choice')[i]; if(el){ el.style.opacity=.35; el.style.pointerEvents='none'; } });
  }
  function lifeSkip(){
    if(usedSkip) return toast('Ù¾Ø±Ø´ ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± Ù…Ø¬Ø§Ø²Ù‡');
    usedSkip=true; clearInterval(State.quiz.timer);
    const cur = State.quiz.list[State.quiz.idx];
    State.quiz.results.push({ q: cur.q, ok:false, correct: cur.c[cur.a], you:'â€” (Ù¾Ø±Ø´)' });
    nextQuestion();
  }
  function lifePause(){
    if(paused){ paused=false; resetTimer(State.quiz.remain); $('#life-pause').innerHTML='<i class="fas fa-pause"></i> Ù…Ú©Ø«'; return; }
    paused=true; clearInterval(State.quiz.timer); $('#life-pause').innerHTML='<i class="fas fa-play"></i> Ø§Ø¯Ø§Ù…Ù‡';
  }
  
  // ===== Setup Sheet =====
  function openSetupSheet(){
    const cWrap=$('#cat-wrap'); const dWrap=$('#diff-wrap');
    cWrap.innerHTML=''; dWrap.innerHTML='';
    let selCat='Ù‡Ù…Ù‡', selDiff='Ø¢Ø³Ø§Ù†';
    ['Ù‡Ù…Ù‡',...cats].forEach(c=>{
      const b=document.createElement('button');
      b.className='w-full py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20';
      if (c === selCat) b.classList.add('selected-setup-item');
      b.textContent=c; b.dataset.val=c; cWrap.appendChild(b);
    });
    ['Ù‡Ù…Ù‡',...diffs].forEach(d=>{
      const b=document.createElement('button');
      b.className='w-full py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20';
      if (d === selDiff) b.classList.add('selected-setup-item');
      b.textContent=d; b.dataset.val=d; dWrap.appendChild(b);
    });
    cWrap.onclick = (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      cWrap.querySelectorAll('button').forEach(x=>x.classList.remove('selected-setup-item'));
      btn.classList.add('selected-setup-item'); selCat=btn.dataset.val;
    };
    dWrap.onclick = (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      dWrap.querySelectorAll('button').forEach(x=>x.classList.remove('selected-setup-item'));
      btn.classList.add('selected-setup-item'); selDiff=btn.dataset.val;
    };
    $('#range-count').oninput = e=> $('#setup-count').textContent=faNum(e.target.value);
    $('#setup-start').onclick=()=>{ closeSheet(); used5050=false; usedSkip=false; paused=false; startQuiz({cat:selCat,diff:selDiff,count:+$('#range-count').value}); navTo('quiz'); };
    openSheet();
  }
  function openSheet(){ $('#sheet-setup').classList.add('show'); }
  function closeSheet(){ $('#sheet-setup').classList.remove('show'); }
  
  // ===== Notifications =====
  function renderNotifications(){
    const list = $('#notif-list'); list.innerHTML='';
    State.notifications.forEach(n=>{
      const row=document.createElement('div'); row.className='bg-white/10 border border-white/20 rounded-xl px-4 py-3';
      row.innerHTML=`<div class="font-bold mb-1">${n.text}</div><div class="text-xs opacity-80">${n.time}</div>`;
      list.appendChild(row);
    });
    $('#notif-dot').style.display = 'none';
  }
  
  // ===== Share =====
  function shareResult(){
    const ok = State.quiz.results.filter(r=>r.ok).length, total=State.quiz.results.length;
    const text = `Ù…Ù† Ø¯Ø± Quiz WebApp Pro ${faNum(ok)}/${faNum(total)} Ù¾Ø§Ø³Ø® Ø¯Ø±Ø³Øª Ø¯Ø§Ø¯Ù… Ùˆ ${faNum(State.quiz.sessionEarned)} Ø§Ù…ØªÛŒØ§Ø² Ú¯Ø±ÙØªÙ…!`;
    const url = `https://t.me/share/url?url=${encodeURIComponent('https://t.me/your_bot')}&text=${encodeURIComponent(text)}`;
    try{ 
      if (navigator.share) {
        navigator.share({
          title: 'Ù†ØªÛŒØ¬Ù‡ Ù…Ø³Ø§Ø¨Ù‚Ù‡',
          text: text,
          url: 'https://t.me/your_bot'
        });
      } else {
        window.open(url,'_blank'); 
      }
    }catch{ navigator.clipboard.writeText(text); toast('Ù†ØªÛŒØ¬Ù‡ Ú©Ù¾ÛŒ Ø´Ø¯'); }
  }
  
  // ===== Support & Advertisers =====
  function renderSupportTickets() {
    const ticketsList = $('#tickets-list');
    ticketsList.innerHTML = '<div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text"></div>';
    
    // Simulate loading tickets
    setTimeout(() => {
      ticketsList.innerHTML = `
        <div class="ticket-item">
          <div class="flex justify-between items-start mb-1">
            <div class="font-bold">Ù…Ø´Ú©Ù„ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø®Øª</div>
            <span class="ticket-status status-pending">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ</span>
          </div>
          <div class="text-xs opacity-70 mb-2">Û±Û´Û°Û²/Û°Ûµ/Û±Û°</div>
          <div class="text-sm">Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ Ø§Ù…Ø§ Ø³Ú©Ù‡â€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù†Ø¯...</div>
        </div>
        <div class="ticket-item">
          <div class="flex justify-between items-start mb-1">
            <div class="font-bold">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª</div>
            <span class="ticket-status status-closed">Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡</span>
          </div>
          <div class="text-xs opacity-70 mb-2">Û±Û´Û°Û²/Û°Û´/Û²Ûµ</div>
          <div class="text-sm">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø³ØªÙ‡ Ø³ÙˆØ§Ù„Ø§Øª Ø¬Ø¯ÛŒØ¯...</div>
        </div>
      `;
    }, 1000);
  }
  
  // ===== Events =====
  // Delegate wallet package purchase buttons to handle re-renders
  $('#pkg-grid')?.addEventListener('click', (e) => {
    const btn = e.target.closest('.buy-pkg');
    if (!btn) return;
    e.preventDefault();
    showPaymentModal(btn.dataset.id);
  });
  $('#btn-play')?.addEventListener('click', openSetupSheet);
  $('#setup-close')?.addEventListener('click', closeSheet);
  $('#btn-daily')?.addEventListener('click', startDaily);
  $('#btn-back-lb')?.addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-back-shop')?.addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-quit')?.addEventListener('click', ()=>{
    State.duelOpponent = null;
    $('#duel-banner').classList.add('hidden');
    navTo('dashboard');
  });
  $('#btn-continue')?.addEventListener('click', ()=>{
    if(State.coins>=10){ State.coins-=10; State.lives=1; saveState(); $('#btn-continue').classList.add('hidden'); renderTopBars();
      resetTimer(15); $$('#choices .choice').forEach(el=>{ el.classList.remove('wrong','correct','pointer-events-none','opacity-70'); el.style.opacity=''; el.style.pointerEvents=''; }); State.quiz.answered=false;
    } else { toast('<i class="fas fa-exclamation-circle ml-2"></i>Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª'); }
  });
  $('#btn-claim-streak')?.addEventListener('click', claimStreak);
  $('#btn-invite')?.addEventListener('click', ()=>{
    const link=`https://t.me/share/url?url=${encodeURIComponent('https://t.me/your_bot?start=ref_'+State.user.id)}&text=${encodeURIComponent('Ø¨ÛŒØ§ ØªÙˆ Ù…Ø³Ø§Ø¨Ù‚Ù‡!')}`;
    try{
      if (navigator.share) {
        navigator.share({
          title: 'Ø¯Ø¹ÙˆØª Ø¨Ù‡ Ù…Ø³Ø§Ø¨Ù‚Ù‡',
          text: 'Ø¨ÛŒØ§ ØªÙˆ Ù…Ø³Ø§Ø¨Ù‚Ù‡!',
          url: `https://t.me/your_bot?start=ref_${State.user.id}`
        });
      } else {
        window.open(link,'_blank');
      }
    }catch{ navigator.clipboard.writeText(link); toast('<i class="fas fa-check-circle ml-2"></i>Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯'); }
  });
  $('#btn-advertisers')?.addEventListener('click', ()=>{
    navTo('support');
    document.querySelector('.support-tab[data-tab="advertiser"]')?.click();
  });
  // Delegate shop item purchases to handle dynamic re-renders
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-buy]');
    if (!btn) return;
    buy(btn.dataset.buy);
  });
  $$('nav [data-tab]').forEach(b=> b.addEventListener('click', e=>{
    const tab=e.currentTarget.dataset.tab; if(tab==='quiz'){ openSetupSheet(); } else navTo(tab);
  }));
  $('#btn-settings')?.addEventListener('click', ()=>{
    $('#set-sound').checked = !!State.settings.sound;
    $('#set-haptics').checked = !!State.settings.haptics;
    $('#set-theme').checked = (State.theme==='night');
    openModal('#modal-settings');
  });
  $('#btn-theme')?.addEventListener('click', ()=>{
    const next = (State.theme==='ocean')?'night':'ocean';
    State.theme=next; document.documentElement.setAttribute('data-theme', next); saveState();
  });
  $('#btn-notify')?.addEventListener('click', ()=>{ renderNotifications(); openModal('#modal-notify'); });
  $('[data-close="#modal-settings"]')?.addEventListener('click', ()=>closeModal('#modal-settings'));
  $('[data-close="#modal-notify"]')?.addEventListener('click', ()=>closeModal('#modal-notify'));
  $('#btn-edit-profile')?.addEventListener('click', ()=>{
    $('#inp-name').value = State.user.name;
    const sel = $('#sel-province');
    populateProvinceOptions(sel, 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù†');
    if(State.user.province){
      sel.value = State.user.province;
    }
    sel.disabled = true;
    $('#lbl-group').textContent = State.user.group || 'â€”';
    $('#inp-avatar').value = '';
    openModal('#modal-profile');
  });
  $('[data-close="#modal-profile"]')?.addEventListener('click', ()=>closeModal('#modal-profile'));
  $('#btn-save-profile')?.addEventListener('click', ()=>{
    const n = $('#inp-name').value.trim();
    if(n) State.user.name = n;

    // Ø§Ø³ØªØ§Ù† Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ù†ÛŒØ³ØªØŒ Ø¨Ù†Ø§Ø¨Ø±Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ø¢Ù† Ø°Ø®ÛŒØ±Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯

    const file = $('#inp-avatar').files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = () => { State.user.avatar = reader.result; finish(); };
      reader.readAsDataURL(file);
    } else {
      finish();
    }

    function finish(){
      saveState();
      renderHeader();
      renderDashboard();
      closeModal('#modal-profile');
      toast('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…');
    }
  });
  $('#btn-confirm-province')?.addEventListener('click', () => {
    const p = $('#first-province').value;
    if(!p){ toast('Ù„Ø·ÙØ§Ù‹ Ø§Ø³ØªØ§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
    State.user.province = p;
    saveState();
    renderDashboard();
    closeModal('#modal-province-select');
    toast('Ø§Ø³ØªØ§Ù† Ø«Ø¨Øª Ø´Ø¯ âœ…');
  });
  $('#btn-clear')?.addEventListener('click', ()=>{ if(confirm('Ù‡Ù…Ù‡Ù” Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });
  
  // Leaderboard Tabs
  $$('.leaderboard-tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      e.preventDefault();
      $$('.leaderboard-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      $$('.lb-content').forEach(content => content.classList.add('hidden'));
      $(`#lb-${tab.dataset.tab}`)?.classList.remove('hidden');
    });
  });
  
  // Match Types
  $$('.match-type-card').forEach(card => {
    card.addEventListener('click', () => {
      const matchType = card.dataset.match;
      if (matchType === 'duel') navTo('duel');
      else if (matchType === 'province') openModal('#modal-province-soon');
      else if (matchType === 'group') navTo('group');
    });
  });
  
  // Duel Friends list
  const duelFriends = [
    { id: 1, name: 'Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ', score: 12450, avatar: 'https://i.pravatar.cc/60?img=3' },
    { id: 2, name: 'Ø³Ø§Ø±Ø§ Ù…Ø­Ù…Ø¯ÛŒ', score: 9800, avatar: 'https://i.pravatar.cc/60?img=5' },
    { id: 3, name: 'Ø±Ø¶Ø§ Ù‚Ø§Ø³Ù…ÛŒ', score: 15200, avatar: 'https://i.pravatar.cc/60?img=8' },
    { id: 4, name: 'Ù…Ø±ÛŒÙ… Ø§Ø­Ù…Ø¯ÛŒ', score: 7650, avatar: 'https://i.pravatar.cc/60?img=11' }
  ];

  const randomPool = [
    { id: 5, name: 'Ø­Ø³ÛŒÙ† Ú©Ø±ÛŒÙ…ÛŒ', score: 13200, avatar: 'https://i.pravatar.cc/60?img=12' },
    { id: 6, name: 'Ù†Ú¯Ø§Ø± Ù…ÙˆØ³ÙˆÛŒ', score: 9100, avatar: 'https://i.pravatar.cc/60?img=13' },
    { id: 7, name: 'Ú©Ø§Ù…Ø±Ø§Ù† Ø¹Ù„ÛŒÙ¾ÙˆØ±', score: 10100, avatar: 'https://i.pravatar.cc/60?img=14' }
  ];

  function renderDuelFriends(){
    const list = $('#duel-friends-list');
    if(!list) return;
    list.innerHTML = '';
    duelFriends.forEach(friend => {
      const card = document.createElement('div');
      card.className = 'duel-opponent glass rounded-2xl p-4 flex items-center justify-between';
      card.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${friend.avatar}" class="w-12 h-12 rounded-full border-2 border-white/30" alt="opponent">
          <div>
            <div class="font-bold">${friend.name}</div>
            <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-star text-yellow-300"></i><span>Ø§Ù…ØªÛŒØ§Ø²: ${friend.score.toLocaleString('fa-IR')}</span></div>
          </div>
        </div>
        <button class="btn btn-duel text-sm w-auto px-4" data-id="${friend.id}">Ú†Ø§Ù„Ø´</button>`;
      list.appendChild(card);
    });
    list.querySelectorAll('button[data-id]').forEach(btn => {
      btn.addEventListener('click', () => challengeFriend(parseInt(btn.dataset.id)));
    });
  }

  function challengeFriend(id){
    const friend = duelFriends.find(f => f.id === id);
    if(!friend) return;
    toast(`Ø¯Ø¹ÙˆØª Ù†Ø¨Ø±Ø¯ Ø¨Ø±Ø§ÛŒ ${friend.name} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!`);
    logEvent('duel_challenge', { opponent: friend.name });
  }

  function startDuelMatch(opponent){
    State.duelOpponent = opponent;
    used5050=false; usedSkip=false; paused=false;
    startQuiz({cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ù…ØªÙˆØ³Ø·', count:5});
    logEvent('duel_start', { opponent: opponent.name });
    navTo('quiz');
  }

  renderDuelFriends();

  // Random Opponent Matching
  $('#btn-duel-random')?.addEventListener('click', async () => {
    const btn = $('#btn-duel-random');
    if(!btn) return;
    btn.disabled = true;
    vibrate(30);
    toast('Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÛŒÙ ØªØµØ§Ø¯ÙÛŒ...');
    await new Promise(res => setTimeout(res, 1500));
    const opponent = randomPool[Math.floor(Math.random()*randomPool.length)];
    toast(`Ø­Ø±ÛŒÙ ${opponent.name} Ù¾ÛŒØ¯Ø§ Ø´Ø¯!`);
    logEvent('duel_random_found', { opponent: opponent.name });
    duelFriends.unshift(opponent);
    renderDuelFriends();
    btn.disabled = false;
    startDuelMatch(opponent);
  });

  // Invite Link Copy
  $('#btn-duel-link')?.addEventListener('click', async () => {
    const inviter = State?.user?.name || 'guest';
    const link = `${location.origin}${location.pathname}?duel_invite=${encodeURIComponent(inviter)}`;
    try {
      if (navigator.share) {
        await navigator.share({
          title: 'Ø¯Ø¹ÙˆØª Ø¨Ù‡ Ù†Ø¨Ø±Ø¯',
          text: `${inviter} Ø´Ù…Ø§ Ø±Ø§ Ø¨Ù‡ Ù†Ø¨Ø±Ø¯ Ø¯Ø¹ÙˆØª Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª!`,
          url: link
        });
        toast('Ø¯Ø¹ÙˆØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ…');
      } else if (navigator.clipboard) {
        await navigator.clipboard.writeText(link);
        toast('Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ú©Ù¾ÛŒ Ø´Ø¯ âœ…');
      } else {
        prompt('Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯:', link);
      }
    } catch {
      try {
        await navigator.clipboard.writeText(link);
        toast('Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ú©Ù¾ÛŒ Ø´Ø¯ âœ…');
      } catch {
        prompt('Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯:', link);
      }
    }
    logEvent('duel_invite_link');
  });

  // Province Selection
  $$('[data-province]').forEach(card => {
    card.addEventListener('click', () => {
      const provinceId = card.dataset.province;
      const province = State.provinces.find(p => p.id === provinceId);
      toast(`Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø± Ù…Ø³Ø§Ø¨Ù‚Ù‡ ${province.name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!`);
      
      // Log analytics
      logEvent('province_match_join', { province: province.name });
    });
  });
  
  // Group Selection
  function renderGroupSelect() {
    const list = $('#group-select-list');
    if (!list) return;
    list.innerHTML = '';
    State.groups.forEach(g => {
      const card = document.createElement('div');
      card.className = 'location-card';
      card.innerHTML = `
        <div class="location-icon group-icon"><i class="fas fa-users"></i></div>
        <div class="flex-1"><div class="font-bold">${g.name}</div>
          <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-user"></i><span>Ù…Ø¯ÛŒØ±: ${g.admin}</span></div>
        </div>
        <div class="text-sm font-bold text-purple-300"><i class="fas fa-trophy"></i> ${faNum(g.score)}</div>`;
      card.addEventListener('click', () => showGroupDetail(g));
      list.appendChild(card);
    });
  }
  renderGroupSelect();
  $('#btn-create-group')?.addEventListener('click', openCreateGroup);
  $('#btn-view-group')?.addEventListener('click', () => {
    const myGroup = State.groups.find(g => g.name === State.user.group);
    if (myGroup) showGroupDetail(myGroup);
    else navTo('group');
  });
  
  // Back Buttons for New Pages
  $('#btn-back-duel')?.addEventListener('click', () => navTo('dashboard'));
  $('#btn-back-province')?.addEventListener('click', () => navTo('dashboard'));
  $('#btn-back-group')?.addEventListener('click', () => navTo('dashboard'));
  $('#btn-back-pass-missions')?.addEventListener('click', () => navTo('dashboard'));
  $('#btn-back-referral')?.addEventListener('click', () => navTo('dashboard'));
  $('#btn-back-support')?.addEventListener('click', () => navTo('dashboard'));
  
  // Wallet/VIP navigation
  $('#btn-open-wallet')?.addEventListener('click', ()=>navTo('wallet'));
  $('#btn-open-wallet-2')?.addEventListener('click', ()=>navTo('wallet'));
  $('#btn-open-vip')?.addEventListener('click', ()=>navTo('vip'));
  $('#go-wallet')?.addEventListener('click', ()=>navTo('wallet'));
  $('#go-vip')?.addEventListener('click', ()=>navTo('vip'));
  $('#btn-back-wallet')?.addEventListener('click', ()=>navTo('shop'));
  $('#btn-back-vip')?.addEventListener('click', ()=>navTo('shop'));
  
  // Leaderboard CTA
  $('#btn-view-leaderboard')?.addEventListener('click', ()=>{
    navTo('leaderboard');
  });
  
  // VIP purchase buttons
  $('#buy-vip-lite')?.addEventListener('click', ()=> startPurchaseVip('lite'));
  $('#buy-vip-pro')?.addEventListener('click', ()=> startPurchaseVip('pro'));
  
  // Detail Popup Events
  $('#detail-close')?.addEventListener('click', closeDetailPopup);
  $('#detail-overlay')?.addEventListener('click', closeDetailPopup);

  // Close modals (receipt)
  $$('[data-close="#modal-receipt"]').forEach(b=> b.addEventListener('click', ()=>closeModal('#modal-receipt')));
  $$('[data-close="#modal-pay-confirm"]').forEach(b=> b.addEventListener('click', ()=>closeModal('#modal-pay-confirm')));
  $$('[data-close="#modal-province-soon"]').forEach(b=> b.addEventListener('click', ()=>closeModal('#modal-province-soon')));

  // Game Limits CTAs
  $('#btn-buy-vip-limit')?.addEventListener('click', () => {
    navTo('vip');
  });

  $('#btn-reset-duel-limit')?.addEventListener('click', () => {
    if (State.lives <= 0) {
      toast('Ú©Ù„ÛŒØ¯ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª');
      return;
    }
    if (Server.limits.lives.used === 0) {
      toast('Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø±ÛŒØ³Øª Ù†ÛŒØ³Øª');
      return;
    }
    State.lives -= 1;
    renderTopBars();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const t = today.getTime();
    Server.limits.lives.used = 0;
    Server.limits.lives.lastReset = t;
    updateLimitsUI();
    checkLimitsReached();
    saveState();
    toast('<i class="fas fa-check-circle ml-2"></i>Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù†Ø¨Ø±Ø¯ Ø±ÛŒØ³Øª Ø´Ø¯');
  });

  $('#btn-reset-limits')?.addEventListener('click', async () => {
    if (State.lives <= 0) {
      toast('Ú©Ù„ÛŒØ¯ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª');
      return;
    }
    const btn = $('#btn-reset-limits');
    btn.disabled = true;
    try {
      const res = await fetch('/api/limits/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      const data = await res.json();
      if (res.ok && data?.success) {
        State.lives -= 1;
        renderTopBars();
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const t = today.getTime();
        Server.limits.matches.used = 0;
        Server.limits.lives.used = 0;
        Server.limits.energy.used = 0;
        Server.limits.matches.lastReset = t;
        Server.limits.lives.lastReset = t;
        Server.limits.energy.lastReset = t;
        updateLimitsUI();
        checkLimitsReached();
        saveState();
        toast('<i class="fas fa-check-circle ml-2"></i>Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ Ø±ÛŒØ³Øª Ø´Ø¯');
      } else {
        toast(data?.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø±ÛŒØ³Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª');
      }
    } catch {
      toast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
    } finally {
      btn.disabled = false;
    }
  });
  
  // Province Ranking
  $('#btn-view-ranking')?.addEventListener('click', () => {
    navTo('leaderboard');
    document.querySelector('.leaderboard-tab[data-tab="province"]')?.click();
  });
  
  // Referral
  $('#btn-copy-referral')?.addEventListener('click', () => {
    navigator.clipboard.writeText(State.referral.code);
    toast('<i class="fas fa-check-circle ml-2"></i>Ú©Ø¯ Ø¯Ø¹ÙˆØª Ú©Ù¾ÛŒ Ø´Ø¯!');
  });
  
  $('#btn-share-referral')?.addEventListener('click', () => {
    const link = `https://t.me/your_bot?start=ref_${State.user.id}`;
    const text = `Ø¨Ø§ Ú©Ø¯ Ø¯Ø¹ÙˆØª Ù…Ù† Ø¯Ø± Quiz WebApp Pro Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù† Ùˆ Ø¬Ø§ÛŒØ²Ù‡ Ø¨Ú¯ÛŒØ±! Ú©Ø¯: ${State.referral.code}`;
    
    try {
      if (navigator.share) {
        navigator.share({
          title: 'Ø¯Ø¹ÙˆØª Ø¨Ù‡ Quiz WebApp Pro',
          text: text,
          url: link
        });
      } else {
        window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`, '_blank');
      }
    } catch {
      navigator.clipboard.writeText(link);
      toast('<i class="fas fa-check-circle ml-2"></i>Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯!');
    }
  });
  
  // Support & Advertisers Tabs
  $$('.support-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      $$('.support-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      $$('.tab-content').forEach(content => content.classList.add('hidden'));
      $(`#${tab.dataset.tab}-content`).classList.remove('hidden');
      
      if (tab.dataset.tab === 'support') {
        renderSupportTickets();
      }
    });
  });
  
  // Support Form
  $('#support-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = $('#support-name').value.trim();
    const mobile = $('#support-mobile').value.trim();
    const message = $('#support-message').value.trim();
    
    if (!name || !mobile || !message) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
      return;
    }
    
    // Validate mobile number (simple validation)
    if (!/^09[0-9]{9}$/.test(mobile)) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
      return;
    }
    
    // Show loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';
    
    try {
      // Simulate API call
      await wait(1500);
      
      // In a real app, this would be:
      // const result = await Net.jpost('/api/support/tickets', { name, mobile, message });
      
      // Show success message
      toast('<i class="fas fa-check-circle ml-2"></i>ØªÛŒÚ©Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
      
      // Reset form
      e.target.reset();
      
      // Refresh tickets list
      renderSupportTickets();
      
      // Log analytics
      logEvent('support_ticket_created', { category: 'support' });
    } catch (error) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  });
  
  // Advertiser Form
  $('#advertiser-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const placement = $('#ad-placement').value;
    const budget = $('#ad-budget').value;
    const provinces = Array.from($('#ad-provinces').selectedOptions).map(option => option.value);
    const startDate = $('#ad-start').value;
    const endDate = $('#ad-end').value;
    const creative = $('#ad-creative').value.trim();
    const landing = $('#ad-landing').value.trim();
    
    if (!placement || !budget || !provinces.length || !startDate || !endDate || !creative || !landing) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
      return;
    }
    
    // Validate dates
    if (new Date(startDate) >= new Date(endDate)) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø´Ø¯');
      return;
    }
    
    // Show loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';
    
    try {
      // Simulate API call
      await wait(1500);

      // In a real app, this would be an API call
      const ad = { placement, budget: Number(budget), provinces, startDate, endDate, creative, landing };
      if(!State.ads[placement]) State.ads[placement] = [];
      State.ads[placement].push(ad);
      saveState();

      // Show success message
      toast('<i class="fas fa-check-circle ml-2"></i>Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ¨Ù„ÛŒØº Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');

      // Reset form
      e.target.reset();

      // Refresh ads
      AdManager.refreshAll();

      // Log analytics
      logEvent('ad_request_submitted', { category: 'advertiser', placement, budget });
    } catch (error) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  });
  
  // Share Result
  $('#btn-share')?.addEventListener('click', shareResult);
  $('#btn-again')?.addEventListener('click', openSetupSheet);
  $('#btn-back-results')?.addEventListener('click', ()=>{
    State.duelOpponent = null;
    $('#duel-banner').classList.add('hidden');
    navTo('dashboard');
  });
  
  // Lifeline buttons
  $('#life-5050')?.addEventListener('click', life5050);
  $('#life-skip')?.addEventListener('click', lifeSkip);
  $('#life-pause')?.addEventListener('click', lifePause);
  
  // Active Match Actions
  $$('.match-action').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const matchName = e.currentTarget.closest('.active-match-item').querySelector('.match-name').textContent;
      toast(`Ø¯Ø± ${matchName} Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯ÛŒØ¯!`);
    });
  });
  
  // ===== Init =====
async function init(){
    const loading = $('#loading');
    try{
      // Fallback provinces in case JSON fails to load
      const fallbackProvinces = [
        { id: '1', name: 'Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ', score: 15000, members: 120, region: 'Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÛŒ' },
        { id: '2', name: 'Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† ØºØ±Ø¨ÛŒ', score: 14500, members: 110, region: 'Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÛŒ' },
        { id: '3', name: 'Ø§Ø±Ø¯Ø¨ÛŒÙ„', score: 12000, members: 85, region: 'Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÛŒ' },
        { id: '4', name: 'Ø§ØµÙÙ‡Ø§Ù†', score: 18000, members: 180, region: 'Ù…Ø±Ú©Ø²ÛŒ' },
        { id: '5', name: 'Ø§Ù„Ø¨Ø±Ø²', score: 16000, members: 140, region: 'Ù…Ø±Ú©Ø²ÛŒ' },
        { id: '6', name: 'Ø§ÛŒÙ„Ø§Ù…', score: 11000, members: 70, region: 'ØºØ±Ø¨ÛŒ' },
        { id: '7', name: 'Ø¨ÙˆØ´Ù‡Ø±', score: 12500, members: 90, region: 'Ø¬Ù†ÙˆØ¨ÛŒ' },
        { id: '8', name: 'ØªÙ‡Ø±Ø§Ù†', score: 22000, members: 250, region: 'Ù…Ø±Ú©Ø²ÛŒ' },
        { id: '9', name: 'Ú†Ù‡Ø§Ø±Ù…Ø­Ø§Ù„ Ùˆ Ø¨Ø®ØªÛŒØ§Ø±ÛŒ', score: 11500, members: 75, region: 'Ù…Ø±Ú©Ø²ÛŒ' },
        { id: '10', name: 'Ø®Ø±Ø§Ø³Ø§Ù† Ø¬Ù†ÙˆØ¨ÛŒ', score: 10500, members: 65, region: 'Ø´Ø±Ù‚ÛŒ' },
        { id: '11', name: 'Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ', score: 17000, members: 160, region: 'Ø´Ø±Ù‚ÛŒ' },
        { id: '12', name: 'Ø®Ø±Ø§Ø³Ø§Ù† Ø´Ù…Ø§Ù„ÛŒ', score: 10000, members: 60, region: 'Ø´Ø±Ù‚ÛŒ' },
        { id: '13', name: 'Ø®ÙˆØ²Ø³ØªØ§Ù†', score: 16500, members: 150, region: 'Ø¬Ù†ÙˆØ¨ ØºØ±Ø¨ÛŒ' },
        { id: '14', name: 'Ø²Ù†Ø¬Ø§Ù†', score: 12000, members: 80, region: 'Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÛŒ' },
        { id: '15', name: 'Ø³Ù…Ù†Ø§Ù†', score: 11000, members: 70, region: 'Ù…Ø±Ú©Ø²ÛŒ' },
        { id: '16', name: 'Ø³ÛŒØ³ØªØ§Ù† Ùˆ Ø¨Ù„ÙˆÚ†Ø³ØªØ§Ù†', score: 13000, members: 95, region: 'Ø¬Ù†ÙˆØ¨ Ø´Ø±Ù‚ÛŒ' },
        { id: '17', name: 'ÙØ§Ø±Ø³', score: 17500, members: 165, region: 'Ø¬Ù†ÙˆØ¨ÛŒ' },
        { id: '18', name: 'Ù‚Ø²ÙˆÛŒÙ†', score: 12500, members: 85, region: 'Ù…Ø±Ú©Ø²ÛŒ' },
        { id: '19', name: 'Ù‚Ù…', score: 13500, members: 100, region: 'Ù…Ø±Ú©Ø²ÛŒ' },
        { id: '20', name: 'Ú©Ø±Ø¯Ø³ØªØ§Ù†', score: 14000, members: 105, region: 'ØºØ±Ø¨ÛŒ' },
        { id: '21', name: 'Ú©Ø±Ù…Ø§Ù†', score: 15000, members: 120, region: 'Ø¬Ù†ÙˆØ¨ Ø´Ø±Ù‚ÛŒ' },
        { id: '22', name: 'Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡', score: 13500, members: 100, region: 'ØºØ±Ø¨ÛŒ' },
        { id: '23', name: 'Ú©Ù‡Ú¯ÛŒÙ„ÙˆÛŒÙ‡ Ùˆ Ø¨ÙˆÛŒØ±Ø§Ø­Ù…Ø¯', score: 10500, members: 65, region: 'Ø¬Ù†ÙˆØ¨ ØºØ±Ø¨ÛŒ' },
        { id: '24', name: 'Ú¯Ù„Ø³ØªØ§Ù†', score: 12000, members: 80, region: 'Ø´Ù…Ø§Ù„ÛŒ' },
        { id: '25', name: 'Ú¯ÛŒÙ„Ø§Ù†', score: 15500, members: 125, region: 'Ø´Ù…Ø§Ù„ÛŒ' },
        { id: '26', name: 'Ù„Ø±Ø³ØªØ§Ù†', score: 12500, members: 85, region: 'ØºØ±Ø¨ÛŒ' },
        { id: '27', name: 'Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†', score: 16000, members: 135, region: 'Ø´Ù…Ø§Ù„ÛŒ' },
        { id: '28', name: 'Ù…Ø±Ú©Ø²ÛŒ', score: 13000, members: 95, region: 'Ù…Ø±Ú©Ø²ÛŒ' },
        { id: '29', name: 'Ù‡Ø±Ù…Ø²Ú¯Ø§Ù†', score: 14000, members: 105, region: 'Ø¬Ù†ÙˆØ¨ÛŒ' },
        { id: '30', name: 'Ù‡Ù…Ø¯Ø§Ù†', score: 13000, members: 90, region: 'ØºØ±Ø¨ÛŒ' },
        { id: '31', name: 'ÛŒØ²Ø¯', score: 14500, members: 110, region: 'Ù…Ø±Ú©Ø²ÛŒ' }
      ];

      try{
        // Try to load provinces from JSON file
        const resp = await fetch('./data/provinces.json');
        if(resp.ok){
          const loadedProvinces = await resp.json();
          if(loadedProvinces && loadedProvinces.length > 0){
            State.provinces = loadedProvinces;
          } else {
            State.provinces = fallbackProvinces;
          }
        } else {
          State.provinces = fallbackProvinces;
        }
      }catch(err){
        console.warn('Failed to load provinces from JSON, using fallback', err);
        State.provinces = fallbackProvinces;
      }

      // Ensure provinces are populated
      if(!State.provinces || State.provinces.length === 0){
        State.provinces = fallbackProvinces;
      }

      renderHeader(); renderDashboard(); navTo('dashboard');

      // Check if user needs to select province
      if(!State.user.province){
        const sel = $('#first-province');
        if(sel){
          populateProvinceOptions(sel, 'Ø§Ø³ØªØ§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
          
          // Double-check that options were added
          if(sel.options.length <= 1){ // Only placeholder
            // Manually add provinces if populateProvinceOptions failed
            State.provinces.forEach(p => {
              const option = document.createElement('option');
              option.value = p.name;
              option.textContent = p.name;
              sel.appendChild(option);
            });
          }
          
          openModal('#modal-province-select');
        }
      }

      // Start daily reset timer
      checkDailyReset();
      setInterval(checkDailyReset, 1000);

      // Server bootstrap: wallet + subscription then ads
      await Promise.all([refreshWallet(), refreshSubscription()]);
      renderHeader(); renderDashboard();
      AdManager.refreshAll();

      // Set up ESC key to close payment modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && $('#modal-payment').classList.contains('show')) {
          closePaymentModal();
        }
      });

      // Log session start
      logEvent('session_start', {
        screen_width: window.screen.width,
        screen_height: window.screen.height,
        user_agent: navigator.userAgent
      });

      // Banner should be present from first print
      if(!localStorage.getItem(STORAGE_KEY)){ setTimeout(()=>toast('Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒ Â«Ø´Ø±ÙˆØ¹ Ú©ÙˆÛŒÛŒØ²Â» Ø¨Ø²Ù† âœ¨'), 800); }

      // Re-render wallet display if user changes connectivity
      window.addEventListener('online', ()=>{ $('#wallet-offline')?.classList.add('hidden'); AdManager.refreshAll(); });
      window.addEventListener('offline', ()=>{ $('#wallet-offline')?.classList.remove('hidden'); });

      // Show popup ad on open
      AdManager.maybeShowInterstitial('app_open');
    }catch(err){
      console.error('Initialization failed', err);
      toast('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡');
    }finally{
      loading.classList.add('hidden');
    }
  }
  init();


  



  
  </script>
</body>
</html>