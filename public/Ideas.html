<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Quiz WebApp Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{ 
      --brand1:#3b82f6; 
      --brand2:#06b6d4; 
      --brand3:#10b981;
      --accent1:#fde047;
      --accent2:#fb923c;
      --accent3:#a78bfa;
      --accent4:#ec4899;
    }
    *{ font-family: 'Vazirmatn', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body{ 
      background: radial-gradient(1200px 800px at 80% -10%, rgba(255,255,255,0.25), transparent 50%),
                   radial-gradient(1000px 700px at 0% 100%, rgba(255,255,255,0.15), transparent 50%),
                   linear-gradient(135deg, var(--brand1), var(--brand2), var(--brand3));
      min-height: 100vh;
      overflow-x: hidden;
    }
    .glass{ 
      background: rgba(255,255,255,0.15); 
      backdrop-filter: blur(20px); 
      -webkit-backdrop-filter: blur(20px); 
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
    }
    .glass-dark{ 
      background: rgba(0,0,0,0.2); 
      backdrop-filter: blur(20px); 
      -webkit-backdrop-filter: blur(20px); 
      border: 1px solid rgba(255,255,255,0.15);
    }
    .btn{ 
      @apply w-full py-4 rounded-2xl font-bold shadow-lg active:scale-[0.98] transition-all duration-300 transform hover:scale-[1.02];
    }
    .btn-primary{ 
      background: linear-gradient(135deg, var(--accent1), var(--accent2)); 
      color:#111827;
      box-shadow: 0 4px 15px rgba(251, 146, 60, 0.4);
    }
    .btn-secondary{ 
      background: linear-gradient(135deg, var(--accent3), var(--accent4)); 
      color:#fff;
      box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
    }
    .btn-tertiary{ 
      background: linear-gradient(135deg, #60a5fa, #6366f1); 
      color:#fff;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
    .safe{ padding-bottom: env(safe-area-inset-bottom); }
    .ring-anim{ transition: stroke-dashoffset .2s linear; }
    /* Choice states */
    .choice{ 
      @apply w-full text-right px-5 py-4 rounded-2xl border border-white/20 bg-white/10 hover:bg-white/20 transition-all duration-300 flex items-center gap-3 transform hover:scale-[1.02];
    }
    .choice.correct{ 
      @apply bg-green-500/20 border-green-400/60;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    }
    .choice.wrong{ 
      @apply bg-rose-500/20 border-rose-400/60;
      box-shadow: 0 0 20px rgba(244, 63, 94, 0.3);
    }
    .chip{ 
      @apply inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-white/10 border border-white/20;
    }
    .divider{ 
      @apply h-px w-full bg-white/20 my-3;
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.3);
    }
    .gradient-text {
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .nav-item {
      position: relative;
      transition: all 0.3s ease;
    }
    .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      border-radius: 3px 3px 0 0;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
  </style>
</head>
<body class="min-h-screen text-white flex flex-col">
  <!-- Header -->
  <header class="glass sticky top-0 z-30 w-full px-4 py-3 flex items-center justify-between shadow-lg">
    <div class="flex items-center gap-3">
      <div class="relative">
        <img id="hdr-avatar" src="https://i.pravatar.cc/80?img=12" class="w-12 h-12 rounded-full border-2 border-white/30 shadow-md" alt="avatar" />
        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
      </div>
      <div>
        <div id="hdr-name" class="font-bold text-lg">Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†</div>
        <div class="text-xs text-white/80 flex items-center gap-1">
          <i class="fas fa-star text-yellow-300"></i>
          <span>Ø§Ù…ØªÛŒØ§Ø²: <span id="hdr-score" class="font-bold">0</span></span>
        </div>
      </div>
    </div>
    <button id="btn-notify" class="relative px-4 py-2 rounded-xl bg-white/10 border border-white/20 text-sm hover:bg-white/20 transition-all duration-300">
      <i class="fas fa-bell"></i>
      <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs">3</span>
    </button>
  </header>
  <!-- Pages container -->
  <main id="pages" class="flex-1 w-full max-w-md mx-auto p-4 space-y-5">
    <!-- DASHBOARD -->
    <section id="page-dashboard" class="space-y-5">
      <!-- Profile Card -->
      <div class="glass rounded-3xl p-6 shadow-xl card-hover">
        <div class="flex items-center gap-4 mb-4">
          <div class="relative">
            <img id="profile-avatar" src="https://i.pravatar.cc/120?img=12" class="w-20 h-20 rounded-full border-4 border-white/30 shadow-lg" alt="avatar" />
            <div class="absolute bottom-0 right-0 w-8 h-8 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center border-2 border-white">
              <i class="fas fa-crown text-white text-sm"></i>
            </div>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <h2 id="profile-name" class="text-2xl font-extrabold">Ø²Ú©ÛŒ</h2>
              <span id="vip-badge" class="chip bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold hidden">VIP</span>
            </div>
            <div class="text-sm text-white/80 flex items-center gap-1 mt-1">
              <i class="fas fa-trophy text-yellow-300"></i>
              <span>Ø±ØªØ¨Ù‡ Ø´Ù…Ø§: <span id="rank" class="font-bold">â€”</span></span>
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="glass rounded-2xl p-4 card-hover">
            <div class="text-2xl font-extrabold text-yellow-300" id="stat-score">0</div>
            <div class="text-xs opacity-80 mt-1">Ø§Ù…ØªÛŒØ§Ø²</div>
          </div>
          <div class="glass rounded-2xl p-4 card-hover">
            <div class="text-2xl font-extrabold text-emerald-300" id="stat-coins">0</div>
            <div class="text-xs opacity-80 mt-1">Ø³Ú©Ù‡</div>
          </div>
          <div class="glass rounded-2xl p-4 card-hover">
            <div class="text-2xl font-extrabold text-rose-300" id="stat-lives">3</div>
            <div class="text-xs opacity-80 mt-1">Ø¬Ø§Ù†</div>
          </div>
        </div>
      </div>
      <!-- Streak & Sponsor -->
      <div class="glass rounded-3xl p-5 card-hover">
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="text-sm opacity-90 flex items-center gap-1">
              <i class="fas fa-fire text-orange-400"></i>
              <span>Ø§Ø³ØªØ±ÛŒÚ© Ø±ÙˆØ²Ø§Ù†Ù‡</span>
            </div>
            <div class="text-2xl font-extrabold"><span id="streak">0</span> Ø±ÙˆØ²</div>
          </div>
          <button id="btn-claim-streak" class="btn btn-primary w-auto px-5 py-2 text-sm pulse">
            <i class="fas fa-gift ml-1"></i> Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø¯Ø§Ø´
          </button>
        </div>
        <div class="w-full h-3 bg-white/15 rounded-full mt-3 overflow-hidden">
          <div id="streak-bar" class="h-3 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
        <div class="text-xs mt-3 opacity-80 flex items-start gap-1">
          <i class="fas fa-info-circle mt-0.5"></i>
          <span>Ù‡Ø± Ø±ÙˆØ² Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†ÛŒ Ù¾Ø§Ø¯Ø§Ø´ Ø¨ÛŒØ´ØªØ± Ù…ÛŒØ´Ù‡. Ø§Ú¯Ù‡ Ø¬Ø§ Ø¨Ù…ÙˆÙ†ÛŒ ØµÙØ± Ù…ÛŒØ´Ù‡ ğŸ˜¬</span>
        </div>
      </div>
      <!-- Actions -->
      <div class="space-y-4">
        <button class="btn btn-primary text-lg" id="btn-play">
          <i class="fas fa-gamepad ml-2"></i> Ø´Ø±ÙˆØ¹ Ù…Ø³Ø§Ø¨Ù‚Ù‡
        </button>
        <div class="grid grid-cols-2 gap-4">
          <button class="btn btn-secondary" id="btn-shop">
            <i class="fas fa-shopping-cart ml-2"></i> ÙØ±ÙˆØ´Ú¯Ø§Ù‡
          </button>
          <button class="btn btn-tertiary" id="btn-leaderboard">
            <i class="fas fa-chart-line ml-2"></i> Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯
          </button>
        </div>
        <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2" id="btn-invite">
          <i class="fas fa-user-plus"></i>
          <span>Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù† (+Ø³Ú©Ù‡)</span>
        </button>
      </div>
      <div class="glass rounded-3xl p-4 text-center text-sm">
        <div class="flex items-center justify-center gap-2">
          <i class="fas fa-bolt text-yellow-300"></i>
          <span>Ø§Ø³Ù¾Ø§Ù†Ø³Ø± Ø§Ù…Ø±ÙˆØ²: <span class="font-bold">Ú©Ø§ÙÙ‡ XYZ</span></span>
        </div>
        <div class="mt-2">
          Ú©Ø¯ ØªØ®ÙÛŒÙ: <span class="font-mono bg-white/20 px-2 py-1 rounded">SANANDAJ10</span>
        </div>
      </div>
    </section>
    <!-- QUIZ PAGE -->
    <section id="page-quiz" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6 shadow-xl">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2 text-sm">
            <span id="quiz-cat" class="chip">
              <i class="fas fa-folder ml-1"></i> Ø¹Ù…ÙˆÙ…ÛŒ
            </span>
            <span id="quiz-diff" class="chip">
              <i class="fas fa-signal ml-1"></i> Ø¢Ø³ÙˆÙ†
            </span>
          </div>
          <div class="flex items-center gap-2 text-sm">
            <span class="chip">
              <i class="fas fa-heart text-red-400 ml-1"></i> <span id="lives">3</span>
            </span>
            <span class="chip">
              <i class="fas fa-coins text-yellow-300 ml-1"></i> <span id="coins">0</span>
            </span>
          </div>
        </div>
        <div class="mt-4 flex items-center justify-center">
          <div class="relative">
            <svg width="140" height="140" viewBox="0 0 140 140" class="-rotate-90">
              <circle cx="70" cy="70" r="64" stroke="rgba(255,255,255,.2)" stroke-width="12" fill="none"/>
              <circle id="timer-ring" cx="70" cy="70" r="64" stroke="url(#gradient)" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="402.124" stroke-dashoffset="0" class="ring-anim"/>
              <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#fde047" />
                  <stop offset="100%" stop-color="#fb923c" />
                </linearGradient>
              </defs>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="text-3xl font-extrabold" id="timer-text">30</div>
            </div>
          </div>
        </div>
        <h3 id="question" class="text-xl font-bold mt-4 leading-8 text-center"></h3>
      </div>
      <div id="choices" class="space-y-4"></div>
      <div class="flex items-center gap-4">
        <button id="btn-quit" class="flex-1 py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2">
          <i class="fas fa-times"></i>
          <span>Ø®Ø±ÙˆØ¬</span>
        </button>
        <button id="btn-continue" class="hidden flex-1 py-4 rounded-2xl bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold flex items-center justify-center gap-2">
          <i class="fas fa-coins"></i>
          <span>Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ 10 Ø³Ú©Ù‡</span>
        </button>
      </div>
    </section>
    <!-- LEADERBOARD -->
    <section id="page-leaderboard" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-trophy text-yellow-300"></i>
          <span>Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ Ù‡ÙØªÚ¯ÛŒ</span>
        </h3>
        <div id="lb-list" class="space-y-3"></div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2" id="btn-back-lb">
        <i class="fas fa-arrow-right"></i>
        <span>Ø¨Ø§Ø²Ú¯Ø´Øª</span>
      </button>
    </section>
    <!-- SHOP / VIP -->
    <section id="page-shop" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6 space-y-4">
        <h3 class="text-2xl font-extrabold flex items-center gap-2">
          <i class="fas fa-shopping-bag text-purple-300"></i>
          <span>ÙØ±ÙˆØ´Ú¯Ø§Ù‡</span>
        </h3>
        <div class="grid grid-cols-2 gap-4">
          <div class="glass-dark rounded-2xl p-5 card-hover">
            <div class="text-center mb-3">
              <div class="w-12 h-12 mx-auto rounded-full bg-red-500/20 flex items-center justify-center mb-2">
                <i class="fas fa-heart text-red-400 text-xl"></i>
              </div>
              <div class="font-bold text-lg">Ø¬Ø§Ù† +1</div>
              <div class="text-sm opacity-80 mt-1">Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</div>
            </div>
            <button class="btn btn-primary text-sm" data-buy="life">
              <i class="fas fa-coins ml-1"></i> Ø®Ø±ÛŒØ¯ 30ğŸ’°
            </button>
          </div>
          <div class="glass-dark rounded-2xl p-5 card-hover">
            <div class="text-center mb-3">
              <div class="w-12 h-12 mx-auto rounded-full bg-blue-500/20 flex items-center justify-center mb-2">
                <i class="fas fa-bolt text-blue-400 text-xl"></i>
              </div>
              <div class="font-bold text-lg">Ø¨ÙˆØ³Øª Ø§Ù…ØªÛŒØ§Ø² x2</div>
              <div class="text-sm opacity-80 mt-1">ØªØ§ 10 Ø¯Ù‚ÛŒÙ‚Ù‡</div>
            </div>
            <button class="btn btn-secondary text-sm" data-buy="boost">
              <i class="fas fa-coins ml-1"></i> Ø®Ø±ÛŒØ¯ 50ğŸ’°
            </button>
          </div>
          <div class="glass-dark rounded-2xl p-5 col-span-2 card-hover">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center">
                  <i class="fas fa-crown text-white text-2xl"></i>
                </div>
                <div>
                  <div class="font-bold text-lg">Ø§Ø´ØªØ±Ø§Ú© VIP (Ù…Ø§Ù‡Ø§Ù†Ù‡)</div>
                  <div class="text-sm opacity-80 mt-1">+Ø¬Ø§Ù† Ø±ÙˆØ²Ø§Ù†Ù‡ØŒ +Ø§Ø³ØªØ±ÛŒÚ©ØŒ +Ø¬Ø§Ù…â€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡</div>
                </div>
              </div>
              <button class="btn btn-tertiary w-auto px-4" data-buy="vip">
                <i class="fas fa-coins ml-1"></i> Ø®Ø±ÛŒØ¯ 200ğŸ’°
              </button>
            </div>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2" id="btn-back-shop">
        <i class="fas fa-arrow-right"></i>
        <span>Ø¨Ø§Ø²Ú¯Ø´Øª</span>
      </button>
    </section>
  </main>
  <!-- Bottom Nav -->
  <nav class="glass safe sticky bottom-0 z-30 w-full shadow-lg">
    <div class="max-w-md mx-auto grid grid-cols-3">
      <button class="py-4 text-center hover:bg-white/10 transition-all duration-300 nav-item" data-tab="dashboard">
        <i class="fas fa-home text-xl mb-1"></i>
        <div class="text-xs">Ø®Ø§Ù†Ù‡</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition-all duration-300 nav-item" data-tab="quiz">
        <i class="fas fa-gamepad text-xl mb-1"></i>
        <div class="text-xs">Ù…Ø³Ø§Ø¨Ù‚Ù‡</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition-all duration-300 nav-item" data-tab="leaderboard">
        <i class="fas fa-chart-line text-xl mb-1"></i>
        <div class="text-xs">Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯</div>
      </button>
    </div>
  </nav>
  <script>
  // === Minimal state/store ===
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const State = {
    user: { id: 'guest', name: 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†', avatar: 'https://i.pravatar.cc/120?img=12' },
    score: 0,
    coins: 100,
    lives: 3,
    vip: false,
    streak: 0,
    lastClaim: 0,
    boostUntil: 0,
    leaderboard: [
      { id: 'u1', name: 'Ø¢Ø±ØªÛŒÙ†', score: 18200 },
      { id: 'u2', name: 'Ø³Ù…Ø§Ù†Ù‡', score: 16500 },
      { id: 'u3', name: 'Ù…Ø§Ù†ÛŒ', score: 14950 },
      { id: 'u4', name: 'Ù†ÛŒÚ©Ø§', score: 13200 },
    ],
    quiz: { duration:30, remain:30, timer:null, inProgress:false, correctIndex:-1, answered:false }
  };
  const STORAGE_KEY = 'quiz_webapp_pro_state_v1';
  function loadState(){
    try{
      const s = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
      if(s){ Object.assign(State, s); }
    }catch{}
  }
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(State)); }
  // Try Telegram WebApp user
  try{
    if(window.Telegram && Telegram.WebApp){
      Telegram.WebApp.ready();
      const u = Telegram.WebApp.initDataUnsafe?.user;
      if(u){
        State.user.id = String(u.id);
        State.user.name = [u.first_name, u.last_name].filter(Boolean).join(' ');
        if(u.username) State.user.name += ` (@${u.username})`;
        $('#profile-name').textContent = State.user.name;
      }
    }
  }catch{}
  loadState();
  // === UI bindings ===
  function fmt(n){ return new Intl.NumberFormat('fa-IR').format(n); }
  function renderHeader(){
    $('#hdr-name').textContent = State.user.name;
    $('#hdr-score').textContent = fmt(State.score);
    $('#hdr-avatar').src = State.user.avatar;
  }
  function renderDashboard(){
    $('#profile-name').textContent = State.user.name;
    $('#profile-avatar').src = State.user.avatar;
    $('#stat-score').textContent = fmt(State.score);
    $('#stat-coins').textContent = fmt(State.coins);
    $('#stat-lives').textContent = State.lives;
    $('#vip-badge').classList.toggle('hidden', !State.vip);
    $('#streak').textContent = State.streak;
    const pct = clamp((State.streak%7)/7*100,0,100);
    $('#streak-bar').style.width = pct + '%';
  }
  function renderTopBars(){
    $('#lives').textContent = State.lives;
    $('#coins').textContent = fmt(State.coins);
  }
  function navTo(page){
    ['dashboard','quiz','leaderboard','shop'].forEach(p=>{
      $('#page-'+p)?.classList.add('hidden');
    });
    $('#page-'+page)?.classList.remove('hidden');
    $('#page-'+page)?.classList.add('fade-in');
    // highlight tab
    $$('nav [data-tab]').forEach(b=>{
      b.classList.toggle('bg-white/10', b.dataset.tab===page);
      b.classList.toggle('active', b.dataset.tab===page);
    });
    if(page==='dashboard') renderDashboard();
    if(page==='leaderboard') renderLeaderboard();
  }
  // === Quiz Logic ===
  const localQuestions = [
    { q:'Ù¾Ø§ÛŒØªØ®Øª Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§ Ú©Ø¯Ø§Ù… Ø§Ø³ØªØŸ', c:['Ù…Ù„Ø¨ÙˆØ±Ù†','Ø³ÛŒØ¯Ù†ÛŒ','Ù¾Ø±Øª','Ú©Ø§Ù†Ø¨Ø±Ø§'], a:3, cat:'Ø¬ØºØ±Ø§ÙÛŒØ§', diff:'Ø¢Ø³ÙˆÙ†' },
    { q:'Ù‚Ù‡Ø±Ù…Ø§Ù† Ø¬Ø§Ù… Ø¬Ù‡Ø§Ù†ÛŒ ÙÙˆØªØ¨Ø§Ù„ Û±Û¹Û¹Û¸ØŸ', c:['Ø¢Ù„Ù…Ø§Ù†','Ø¨Ø±Ø²ÛŒÙ„','ÙØ±Ø§Ù†Ø³Ù‡','Ø§ÛŒØªØ§Ù„ÛŒØ§'], a:2, cat:'ÙˆØ±Ø²Ø´', diff:'Ù…ØªÙˆØ³Ø·' },
    { q:'Ø¯Ø± Ø¯Ù†ÛŒØ§ÛŒ Â«Ù‡Ø±ÛŒ Ù¾Ø§ØªØ±Â» Ù†Ú¯Ù‡Ø¨Ø§Ù† Ø¢Ø²Ú©Ø§Ø¨Ø§Ù† Ú†ÛŒØ³ØªØŸ', c:['Ø¯ÛŒÙˆØ§Ù†Ù‡â€ŒØ³Ø§Ø²','ØºÙˆÙ„','Ø§Ú˜Ø¯Ù‡Ø§','Ú©ÙˆØªÙˆÙ„Ù‡Ù” Ø®Ø§Ù†Ú¯ÛŒ'], a:0, cat:'Ø³Ø±Ú¯Ø±Ù…ÛŒ', diff:'Ø¢Ø³ÙˆÙ†' },
    { q:'Ø¹Ø¯Ø¯ Ï€ ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø§ØŸ', c:['Û²Ù«Û·','Û³Ù«Û±Û´','Û³Ù«Û´Û±','Û²Ù«Û±Û´'], a:1, cat:'Ø¹Ù„Ù…', diff:'Ø¢Ø³ÙˆÙ†' },
    { q:'Ú©Ø¯Ø§Ù… Ù‡Ù†Ø±Ù…Ù†Ø¯ Ù†Ù‚Ø§Ø´ÛŒ Â«Ø´Ø¨ Ù¾Ø±Ø³ØªØ§Ø±Ù‡Â» Ø±Ø§ Ú©Ø´ÛŒØ¯Ù‡ØŸ', c:['Ù¾ÛŒÚ©Ø§Ø³Ùˆ','ÙˆÙ†â€ŒÚ¯ÙˆÚ¯','Ù…ÙˆÙ†Ú©','Ø¯Ø§ÙˆÛŒÙ†Ú†ÛŒ'], a:1, cat:'Ù‡Ù†Ø±', diff:'Ù…ØªÙˆØ³Ø·' },
  ];
  async function fetchQuestion(){
    // Try OpenTDB; fallback to local
    try{
      const url = 'https://opentdb.com/api.php?amount=1&type=multiple&encode=url3986';
      const r = await fetch(url, { cache:'no-store' });
      const j = await r.json();
      if(j?.results?.length){
        const it = j.results[0];
        const decode = s => decodeURIComponent(s||'').replace(/&(#\d+|[a-z]+);/gi, m=>{ const t=document.createElement('textarea'); t.innerHTML=m; return t.value; });
        const q = decode(it.question);
        const correct = decode(it.correct_answer);
        const choices = [...it.incorrect_answers.map(decode), correct].sort(()=>Math.random()-0.5);
        return { q, c:choices, a: choices.indexOf(correct), cat: it.category||'Ø¹Ù…ÙˆÙ…ÛŒ', diff: it.difficulty||'â€”' };
      }
    }catch(e){ /* offline or blocked */ }
    // fallback
    return localQuestions[Math.floor(Math.random()*localQuestions.length)];
  }
  function resetTimer(seconds){
    const circ = 2*Math.PI*64; // 402.124
    const ring = $('#timer-ring');
    ring.setAttribute('stroke-dasharray', circ);
    ring.style.strokeDashoffset = '0';
    $('#timer-text').textContent = seconds;
    State.quiz.duration = seconds;
    State.quiz.remain = seconds;
    if(State.quiz.timer) clearInterval(State.quiz.timer);
    State.quiz.timer = setInterval(()=>{
      State.quiz.remain -= 1;
      const r = clamp(State.quiz.remain,0,seconds);
      $('#timer-text').textContent = r;
      const off = circ * (1 - r/seconds);
      ring.style.strokeDashoffset = String(off);
      if(r<=0){ clearInterval(State.quiz.timer); lockChoices(); showContinue(); }
    }, 1000);
  }
  function lockChoices(){
    $$('#choices .choice').forEach(el=> el.classList.add('pointer-events-none','opacity-70'));
  }
  function showContinue(){
    if(State.lives<=0){ $('#btn-continue').classList.remove('hidden'); }
  }
  async function startQuiz(){
    State.quiz.inProgress = true; State.quiz.answered = false; $('#btn-continue').classList.add('hidden');
    renderTopBars();
    const q = await fetchQuestion();
    State.quiz.correctIndex = q.a;
    $('#quiz-cat').innerHTML = `<i class="fas fa-folder ml-1"></i> ${q.cat}`;
    $('#quiz-diff').innerHTML = `<i class="fas fa-signal ml-1"></i> ${typeof q.diff==='string' ? q.diff : 'â€”'}`;
    $('#question').textContent = q.q;
    const box = $('#choices'); box.innerHTML='';
    q.c.forEach((txt,idx)=>{
      const btn = document.createElement('button');
      btn.className='choice';
      btn.innerHTML = `<span class="chip">${String.fromCharCode(65+idx)}</span><span>${txt}</span>`;
      btn.addEventListener('click', ()=> selectAnswer(idx));
      box.appendChild(btn);
    });
    resetTimer(30);
  }
  function selectAnswer(idx){
    if(State.quiz.answered) return;
    State.quiz.answered = true;
    clearInterval(State.quiz.timer);
    const correct = State.quiz.correctIndex;
    const list = $$('#choices .choice');
    list.forEach((el,i)=>{
      el.classList.add(i===correct? 'correct':'wrong');
    });
    lockChoices();
    // scoring with time bonus & VIP/boost
    const base = idx===correct ? 100 : 0;
    const timeBonus = idx===correct ? Math.floor( (State.quiz.remain/State.quiz.duration) * 50 ) : 0;
    const boostActive = Date.now() < State.boostUntil;
    const vipBonus = State.vip ? 20 : 0;
    const total = Math.floor((base + timeBonus + vipBonus) * (boostActive?2:1));
    if(base>0){
      State.score += total;
      State.coins += 5; // small coin for correct
    } else {
      State.lives -= 1;
      if(State.lives<=0) showContinue();
    }
    saveState(); renderHeader(); renderTopBars();
  }
  // === Leaderboard ===
  function renderLeaderboard(){
    const me = { id: State.user.id, name: State.user.name, score: State.score };
    const arr = [...State.leaderboard.filter(x=>x.id!==me.id), me].sort((a,b)=>b.score-a.score).slice(0,20);
    const wrap = $('#lb-list'); wrap.innerHTML='';
    arr.forEach((u,i)=>{
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between bg-white/10 border border-white/20 rounded-xl px-4 py-3 card-hover';
      
      let rankIcon = '';
      if(i === 0) rankIcon = '<i class="fas fa-trophy text-yellow-300"></i>';
      else if(i === 1) rankIcon = '<i class="fas fa-medal text-gray-300"></i>';
      else if(i === 2) rankIcon = '<i class="fas fa-award text-amber-700"></i>';
      else rankIcon = `<span class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">${i+1}</span>`;
      
      row.innerHTML = `<div class="flex items-center gap-3">
        ${rankIcon}
        <div>
          <div class="font-bold">${u.name}</div>
          <div class="text-xs opacity-80 flex items-center gap-1">
            <i class="fas fa-star text-yellow-300"></i>
            <span>${fmt(u.score)}</span>
          </div>
        </div>
      </div>`;
      wrap.appendChild(row);
    });
  }
  // === Shop ===
  function buy(item){
    const price = { life:30, boost:50, vip:200 }[item];
    if(State.coins < price){ 
      // Create a modern toast notification instead of alert
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 glass px-6 py-3 rounded-2xl text-white font-bold z-50 fade-in';
      toast.innerHTML = '<i class="fas fa-exclamation-circle ml-2"></i>Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
      return; 
    }
    State.coins -= price;
    if(item==='life') State.lives += 1;
    if(item==='boost') State.boostUntil = Date.now() + 10*60*1000; // 10 min
    if(item==='vip') State.vip = true;
    saveState(); renderDashboard(); renderTopBars(); $('#vip-badge').classList.toggle('hidden', !State.vip);
    
    // Success toast
    const toast = document.createElement('div');
    toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 glass px-6 py-3 rounded-2xl text-white font-bold z-50 fade-in';
    toast.innerHTML = '<i class="fas fa-check-circle ml-2"></i>Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
  // === Streak ===
  function claimStreak(){
    const nowDay = Math.floor(Date.now()/86400000);
    if(State.lastClaim === nowDay){ 
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 glass px-6 py-3 rounded-2xl text-white font-bold z-50 fade-in';
      toast.innerHTML = '<i class="fas fa-info-circle ml-2"></i>Ø§Ù…Ø±ÙˆØ² Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒ';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
      return; 
    }
    const yesterday = nowDay - 1;
    if(State.lastClaim === yesterday) State.streak += 1; else State.streak = 1;
    State.lastClaim = nowDay;
    const reward = 5 * State.streak; // grows with streak
    State.coins += reward; State.score += reward*10;
    saveState(); renderDashboard(); renderHeader();
    
    const toast = document.createElement('div');
    toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 glass px-6 py-3 rounded-2xl text-white font-bold z-50 fade-in';
    toast.innerHTML = `<i class="fas fa-gift ml-2"></i>Ù¾Ø§Ø¯Ø§Ø´ Ø§Ù…Ø±ÙˆØ²: ${reward} Ø³Ú©Ù‡ ğŸ‰`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
  // === Invite ===
  function doInvite(){
    const link = `https://t.me/share/url?url=${encodeURIComponent('https://t.me/your_bot?start=ref_'+State.user.id)}&text=${encodeURIComponent('Ø¨ÛŒØ§ ØªÙˆ Ù…Ø³Ø§Ø¨Ù‚Ù‡!')}`;
    try{ window.open(link, '_blank'); }catch{ navigator.clipboard.writeText(link); 
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 glass px-6 py-3 rounded-2xl text-white font-bold z-50 fade-in';
      toast.innerHTML = '<i class="fas fa-check-circle ml-2"></i>Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  }
  // === Events ===
  $('#btn-play').addEventListener('click', ()=>{ navTo('quiz'); startQuiz(); });
  $('#btn-leaderboard').addEventListener('click', ()=>{ navTo('leaderboard'); });
  $('#btn-shop').addEventListener('click', ()=>{ navTo('shop'); });
  $('#btn-back-lb').addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-back-shop').addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-quit').addEventListener('click', ()=>{ navTo('dashboard'); });
  $('#btn-continue').addEventListener('click', ()=>{
    if(State.coins>=10){ State.coins-=10; State.lives=1; saveState(); $('#btn-continue').classList.add('hidden'); renderTopBars(); resetTimer(15); $$('#choices .choice').forEach(el=>{ el.classList.remove('wrong','correct','pointer-events-none','opacity-70'); }); State.quiz.answered=false; }
    else {
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 glass px-6 py-3 rounded-2xl text-white font-bold z-50 fade-in';
      toast.innerHTML = '<i class="fas fa-exclamation-circle ml-2"></i>Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  });
  $('#btn-claim-streak').addEventListener('click', claimStreak);
  $('#btn-invite').addEventListener('click', doInvite);
  $$('[data-buy]').forEach(b=> b.addEventListener('click', e=> buy(e.currentTarget.dataset.buy)));
  $$('nav [data-tab]').forEach(b=> b.addEventListener('click', e=>{
    const tab = e.currentTarget.dataset.tab;
    if(tab==='quiz'){ navTo('quiz'); startQuiz(); } else navTo(tab);
  }));
  // Init
  renderHeader(); renderDashboard(); navTo('dashboard');
  </script>
</body>
</html>