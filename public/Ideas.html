<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="ocean">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Quiz WebApp Pro — نسخه فارسی</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <meta name="theme-color" content="#3b82f6" />
  <style>
    :root{
      --brand1:#3b82f6; --brand2:#06b6d4; --brand3:#10b981;
      --accent1:#fde047; --accent2:#fb923c; --accent3:#a78bfa; --accent4:#ec4899;
      --text:#ffffff; --card:rgba(255,255,255,0.15); --cardBorder:rgba(255,255,255,0.30);
      --adBannerH:80px;
    }
    html[data-theme="ocean"] body{
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(255,255,255,0.25), transparent 50%),
        radial-gradient(1000px 700px at 0% 100%, rgba(255,255,255,0.15), transparent 50%),
        linear-gradient(135deg, var(--brand1), var(--brand2), var(--brand3));
    }
    html[data-theme="night"]{
      --brand1:#0f172a; --brand2:#1e293b; --brand3:#312e81;
      --accent1:#22d3ee; --accent2:#6366f1; --accent3:#a78bfa; --accent4:#f472b6;
    }
    html[data-theme="night"] body{
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(255,255,255,0.08), transparent 50%),
        radial-gradient(1000px 700px at 0% 100%, rgba(255,255,255,0.06), transparent 50%),
        linear-gradient(135deg, #0f172a, #1e293b, #312e81);
    }
    *{ font-family:'Vazirmatn',system-ui,-apple-system,Segoe UI,Roboto,sans-serif }
    body{ color:var(--text); min-height:100vh; overflow-x:hidden }
    .glass{ background:var(--card); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:1px solid var(--cardBorder); box-shadow:0 8px 32px rgba(31,38,135,.2) }
    .glass-dark{ background:rgba(0,0,0,.2); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,.15) }
    .card-hover{ transition:all .3s ease }
    .card-hover:hover{ transform:translateY(-5px); box-shadow:0 12px 40px rgba(31,38,135,.3) }
    .nav-item{ position:relative; transition:all .3s ease }
    .nav-item.active::after{ content:''; position:absolute; bottom:0; right:0; left:0; height:3px; background:linear-gradient(90deg,var(--accent1),var(--accent2)); border-radius:3px 3px 0 0 }
    .safe{ padding-bottom: env(safe-area-inset-bottom) }
    .fade-in{ animation:fadeIn .45s ease forwards } @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .pulse{ animation:pulse 2s infinite } @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    /* Buttons */
    .btn{ width:100%; padding:1rem 1.25rem; border-radius:1rem; font-weight:800; box-shadow:0 10px 20px rgba(0,0,0,.12); transition:transform .2s ease, box-shadow .2s ease; min-height:44px; display:flex; align-items:center; justify-content:center }
    .btn:active{ transform:scale(.98) }
    .btn-primary{ background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#111827; box-shadow:0 8px 24px rgba(251,146,60,.35) }
    .btn-secondary{ background:linear-gradient(135deg,var(--accent3),var(--accent4)); color:#fff; box-shadow:0 8px 24px rgba(236,72,153,.35) }
    .btn-tertiary{ background:linear-gradient(135deg,#60a5fa,#6366f1); color:#fff; box-shadow:0 8px 24px rgba(99,102,241,.35) }
    .btn-province{ background:linear-gradient(135deg,#34d399,#10b981); color:#fff; box-shadow:0 8px 24px rgba(16,185,129,.35) }
    .btn-group{ background:linear-gradient(135deg,#c084fc,#a78bfa); color:#fff; box-shadow:0 8px 24px rgba(167,139,250,.35) }
    .btn-duel{ background:linear-gradient(135deg,#f87171,#ef4444); color:#fff; box-shadow:0 8px 24px rgba(239,68,68,.35) }
    .btn-inline{ width:auto; min-width:160px; }
    @media(max-width:639px){
      .btn-inline{ width:100%; }
    }
    .chip{ display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; border-radius:999px; font-size:.85rem; font-weight:700; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:10rem }
    @keyframes chipAttention{ 0%,100%{transform:translateY(0); box-shadow:0 0 0 0 rgba(250,204,21,0)} 50%{transform:translateY(-3px); box-shadow:0 12px 30px rgba(250,204,21,0.35)} }
    .chip.attention{ animation:chipAttention .6s ease; box-shadow:0 0 0 2px rgba(250,204,21,0.35); }
    .divider{ height:1px; width:100%; background:rgba(255,255,255,.20); margin:.75rem 0 }
    .choice{ width:100%; text-align:right; padding:1rem 1.1rem; border-radius:1rem; border:1px solid rgba(255,255,255,.20); background:rgba(255,255,255,.10); transition:all .2s ease; display:flex; align-items:center; gap:.75rem; min-height:44px }
    .choice:hover{ background:rgba(255,255,255,.20); transform:translateY(-1px) }
    .choice.correct{ background:rgba(16,185,129,.25); border-color:rgba(16,185,129,.7); box-shadow:0 0 18px rgba(16,185,129,.35) }
    .choice.wrong{ background:rgba(244,63,94,.25); border-color:rgba(244,63,94,.7); box-shadow:0 0 18px rgba(244,63,94,.35) }
    .lifeline-btn{ position:relative; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; gap:.5rem; padding:.8rem .75rem; border-radius:1.2rem; background:linear-gradient(150deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06)); border:1px solid rgba(255,255,255,0.24); box-shadow:0 12px 30px rgba(15,23,42,0.16); transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease; min-height:0; text-align:center; }
    .lifeline-btn:hover{ transform:translateY(-3px); box-shadow:0 18px 36px rgba(15,23,42,0.2); border-color:rgba(255,255,255,0.3); }
    .lifeline-btn:active{ transform:translateY(-1px); }
    .lifeline-btn:disabled{ opacity:.6; cursor:not-allowed; box-shadow:none; transform:none; border-color:rgba(255,255,255,0.16); }
    .lifeline-icon{ width:2.2rem; height:2.2rem; border-radius:.75rem; display:flex; align-items:center; justify-content:center; font-size:1rem; color:#0f172a; background:linear-gradient(135deg,var(--accent1),var(--accent2)); box-shadow:0 9px 22px rgba(14,116,144,0.26); }
    .lifeline-btn:disabled .lifeline-icon{ background:linear-gradient(135deg, rgba(34,197,94,0.28), rgba(16,185,129,0.24)); color:#d1fae5; box-shadow:none; }
    .lifeline-details{ display:flex; flex-direction:column; gap:.2rem; }
    .lifeline-title{ font-weight:800; font-size:.9rem; letter-spacing:-0.01em; }
    .lifeline-sub{ font-size:.72rem; opacity:.88; line-height:1.35; }
    .lifeline-footer{ display:flex; flex-direction:column; align-items:center; gap:.24rem; }
    .lifeline-cost{ display:inline-flex; align-items:center; gap:.25rem; padding:.26rem .7rem; border-radius:999px; font-weight:700; font-size:.76rem; background:rgba(17,24,39,0.2); border:1px solid rgba(255,255,255,0.22); color:#facc15; box-shadow:0 8px 20px rgba(15,23,42,0.2); }
    .lifeline-cost i{ color:#facc15; }
    .lifeline-cost.not-enough{ background:rgba(127,29,29,0.34); color:#fecaca; border-color:rgba(248,113,113,0.38); box-shadow:0 0 0 1px rgba(248,113,113,0.3); }
    .lifeline-status{ font-size:.66rem; font-weight:700; display:flex; align-items:center; gap:.3rem; color:#bbf7d0; background:rgba(34,197,94,0.26); border:1px solid rgba(34,197,94,0.36); border-radius:999px; padding:.24rem .7rem; }
    .lifeline-btn[data-insufficient="true"]{ border-color:rgba(248,113,113,0.38); box-shadow:0 0 0 1px rgba(248,113,113,0.25) inset; }
    .lifeline-btn[data-insufficient="true"] .lifeline-icon{ background:linear-gradient(135deg, rgba(248,113,113,0.35), rgba(239,68,68,0.32)); color:#fff; box-shadow:none; }
    .lifeline-btn[data-insufficient="true"] .lifeline-title{ color:#fee2e2; }
    .lifeline-btn[data-insufficient="true"] .lifeline-sub{ color:rgba(255,255,255,0.78); }
    .lifelines-grid{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:.7rem; align-items:stretch; }
    .lifeline-btn{ width:100%; }
    @media(max-width:639px){
      .lifelines-grid{ gap:.35rem; padding-inline:.2rem; }
      .lifeline-btn{ padding:.7rem .55rem; border-radius:1.1rem; min-height:110px; box-shadow:0 6px 18px rgba(15,23,42,0.14); }
      .lifeline-icon{ width:1.9rem; height:1.9rem; border-radius:.7rem; font-size:.9rem; }
      .lifeline-title{ font-size:.82rem; }
      .lifeline-sub{ font-size:.64rem; line-height:1.28; }
      .lifeline-footer{ gap:.18rem; }
      .lifeline-cost{ padding:.2rem .5rem; font-size:.66rem; }
      .lifeline-status{ font-size:.6rem; padding:.2rem .5rem; }
    }
    @media(min-width:640px){
      .lifelines-grid{ gap:.9rem; }
      .lifeline-btn{ padding:1rem .85rem; min-height:140px; }
    }
    @keyframes timerGlow{ 0%,100%{filter:drop-shadow(0 0 0 rgba(250,204,21,0));} 50%{filter:drop-shadow(0 0 14px rgba(250,204,21,0.75));} }
    @keyframes timerTextGlow{ 0%,100%{color:#fff; text-shadow:none;} 50%{color:#fde047; text-shadow:0 0 12px rgba(250,204,21,0.85);} }
    #timer-ring.timer-boost{ animation:timerGlow .85s ease; }
    #timer-text.timer-boost{ animation:timerTextGlow .85s ease; }
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:70; padding:1rem }
    .modal.show{ display:grid }
    .sheet{ position:fixed; inset-inline:0; bottom:0; transform:translateY(100%); transition:transform .35s ease; z-index:60 }
    .sheet.show{ transform:translateY(0) }
    .confetti{ position:fixed; inset:0; pointer-events:none; z-index:80 }
    .selected-setup-item { background: linear-gradient(135deg, var(--accent1), var(--accent2)) !important; color: #111827 !important; border-color: transparent !important; font-weight: 700; box-shadow: 0 0 15px rgba(251, 146, 60, 0.4) !important; }
    .leaderboard-tab { transition: all 0.3s ease; position: relative; cursor:pointer; }
    .leaderboard-tab.active { background: rgba(255, 255, 255, 0.2); border-radius: 0.75rem; }
    .leaderboard-tab.active::after { content: ''; position: absolute; bottom: -0.5rem; right: 50%; transform: translateX(50%); width: 50%; height: 3px; background: linear-gradient(90deg, var(--accent1), var(--accent2)); border-radius: 3px 3px 0 0; }
    .detail-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: var(--card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--cardBorder); border-radius: 1.5rem; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); z-index: 100; max-width: 90%; width: 400px; max-height: 90vh; overflow-y: auto; opacity: 0; transition: all 0.3s ease; padding: 1.5rem; }
    .detail-popup.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .detail-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 99; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
    .detail-overlay.show { opacity: 1; pointer-events: all; }
    .match-card { background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05)); border-radius: 1.5rem; padding: 1.25rem; margin-bottom: 1rem; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.1); }
    .match-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2); border-color: rgba(255, 255, 255, 0.2); }
    .duel-avatars { display: flex; justify-content: space-between; align-items: center; margin: 1rem 0; }
    .duel-avatar { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
    .duel-vs { font-size: 1.5rem; font-weight: 800; color: var(--accent2); }
    .location-card { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 1rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.15); transition: all 0.3s ease; cursor: pointer; min-height:44px }
    .location-card:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-3px); }
    #btn-view-group[data-empty="true"]{ border-style:dashed; border-color:rgba(255,255,255,0.35); background:linear-gradient(135deg, rgba(236,72,153,0.18), rgba(59,130,246,0.18)); box-shadow:0 18px 35px rgba(14,116,144,0.25); }
    #btn-view-group[data-empty="true"] .location-icon{ background:linear-gradient(135deg, rgba(236,72,153,0.4), rgba(59,130,246,0.4)); color:#fff; }
    #btn-view-group[data-empty="true"] .group-card-title{ color:#fff; }
    #btn-view-group[data-empty="true"] .group-card-value{ color:#f8fafc; opacity:0.95; }
    #btn-view-group[data-empty="true"] .group-card-empty{ opacity:0.95; }
    .group-card-empty{ transition:opacity .3s ease; }
    .location-icon { width: 3rem; height: 3rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
    .province-icon { background: linear-gradient(135deg, #34d399, #10b981); }
    .group-icon { background: linear-gradient(135deg, #c084fc, #a78bfa); }
    .no-group-card{ background:linear-gradient(135deg, rgba(59,130,246,0.22), rgba(167,139,250,0.2)); border:1px dashed rgba(255,255,255,0.35); backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px); border-radius:1.5rem; box-shadow:0 22px 45px rgba(15,23,42,0.28); }
    .no-group-card .cta-icon{ width:3rem; height:3rem; border-radius:1rem; background:rgba(255,255,255,0.18); display:flex; align-items:center; justify-content:center; font-size:1.35rem; color:#fff; box-shadow:0 12px 28px rgba(30,64,175,0.25); }
    .no-group-card p{ line-height:1.8; }
    @media(max-width:639px){
      .no-group-card{ text-align:center; }
      .no-group-card .cta-icon{ margin:0 auto; }
    }
    .rank-badge{
      width:2.5rem; height:2.5rem; border-radius:0.75rem;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size:1rem;
      background:rgba(255,255,255,0.15);
      border:1px solid rgba(255,255,255,0.3);
    }
    .match-types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .match-type-card { background: rgba(255, 255, 255, 0.1); border-radius: 1rem; padding: 1rem; text-align: center; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(255, 255, 255, 0.15); min-height:44px }
    .match-type-card:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-5px); }
    .match-type-card.active { background: linear-gradient(135deg, var(--accent1), var(--accent2)); color: #111827; border-color: transparent; }
    .match-type-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .active-matches { margin-top: 1.5rem; }
    .active-match-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-radius: 1rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.15); margin-bottom: 0.75rem; transition: all 0.3s ease; min-height:44px }
    .active-match-item:hover { background: rgba(255, 255, 255, 0.2); }
    .match-info { display: flex; align-items: center; gap: 0.75rem; }
    .match-avatar { width: 2.5rem; height: 2.5rem; border-radius: 50%; object-fit: cover; }
    .match-details { display: flex; flex-direction: column; }
    .match-name { font-weight: 700; }
    .match-status { font-size: 0.75rem; opacity: 0.8; }
    .match-action { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 700; background: linear-gradient(135deg, var(--accent1), var(--accent2)); color: #111827; cursor: pointer; transition: all 0.2s ease; min-height:44px }
    .match-action:hover { transform: scale(1.05); }
    .duel-entry-card{ position:relative; overflow:hidden; width:100%; display:grid; grid-template-columns:auto 1fr auto; grid-template-areas:'icon content cta'; align-items:center; gap:clamp(.7rem, .9vw, 1.1rem); border-radius:clamp(1rem, .9vw + .85rem, 1.45rem); padding:clamp(.72rem, .85rem + .4vw, 1.15rem); border:1px solid rgba(255,255,255,0.22); background:linear-gradient(145deg, rgba(248,113,113,0.92), rgba(244,63,94,0.94), rgba(236,72,153,0.88)); box-shadow:0 18px 45px rgba(244,63,94,0.25); cursor:pointer; transition:transform .3s ease, box-shadow .3s ease, border-color .3s ease; text-align:right; color:#fff; }
    .duel-entry-card::before{ content:''; position:absolute; inset:-38% 42% auto auto; width:clamp(140px, 28vw, 220px); height:clamp(140px, 28vw, 220px); background:radial-gradient(circle at center, rgba(255,255,255,0.55), rgba(255,255,255,0)); opacity:.65; transform:rotate(20deg); pointer-events:none; transition:opacity .3s ease, transform .3s ease; }
    .duel-entry-card:hover{ transform:translateY(-3px); box-shadow:0 22px 55px rgba(244,63,94,0.3); border-color:rgba(255,255,255,0.45); }
    .duel-entry-card:hover::before{ opacity:1; transform:rotate(12deg) translate(-10px,-10px); }
    .duel-entry-card:focus-visible{ outline:3px solid rgba(255,255,255,0.65); outline-offset:4px; }
    .duel-entry-icon{ grid-area:icon; width:clamp(44px, 11vw, 58px); height:clamp(44px, 11vw, 58px); border-radius:clamp(15px, 3vw, 20px); display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.18); box-shadow:0 10px 24px rgba(0,0,0,0.18); font-size:clamp(1.15rem, .95rem + .5vw, 1.55rem); position:relative; z-index:1; }
    .duel-entry-content{ grid-area:content; display:flex; flex-direction:column; gap:clamp(.28rem, .4vw, .45rem); position:relative; z-index:1; }
    .duel-entry-heading{ display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:.4rem .6rem; }
    .duel-entry-title{ font-size:clamp(1rem, .88rem + .35vw, 1.22rem); font-weight:800; letter-spacing:-0.01em; }
    .duel-entry-badge{ display:inline-flex; align-items:center; gap:.3rem; padding:.22rem .55rem; border-radius:999px; font-size:clamp(.64rem, .6rem + .22vw, .78rem); font-weight:700; background:rgba(255,255,255,0.22); box-shadow:0 8px 18px rgba(15,23,42,0.14); }
    .duel-entry-badge i{ font-size:clamp(.7rem, .62rem + .22vw, .84rem); }
    .duel-entry-sub{ font-size:clamp(.74rem, .68rem + .24vw, .9rem); line-height:1.45; opacity:.92; max-width:clamp(18rem, 48vw, 26rem); }
    .duel-entry-cta{ grid-area:cta; display:inline-flex; align-items:center; justify-content:center; gap:clamp(.3rem, .4vw, .5rem); font-weight:800; background:rgba(255,255,255,0.18); padding:clamp(.38rem, .32rem + .22vw, .55rem) clamp(.68rem, .55rem + .35vw, .95rem); border-radius:999px; box-shadow:0 9px 20px rgba(15,23,42,0.18); position:relative; z-index:1; transition:background .3s ease, color .3s ease, transform .3s ease; }
    .duel-entry-card:hover .duel-entry-cta{ background:#fff; color:#111827; transform:translateX(-3px); }
    @media(max-width:639px){
      .duel-entry-card{ grid-template-columns:auto 1fr; grid-template-areas:'icon content' 'cta cta'; align-items:center; gap:clamp(.55rem, 1.4vw + .3rem, .85rem); padding:clamp(.65rem, 2.4vw + .38rem, .95rem); border-radius:clamp(.9rem, 2.6vw + .7rem, 1.25rem); box-shadow:0 14px 38px rgba(244,63,94,0.26); }
      .duel-entry-card::before{ inset:-46% 56% auto auto; width:clamp(120px, 50vw, 180px); height:clamp(120px, 50vw, 180px); }
      .duel-entry-heading{ width:100%; gap:.35rem .5rem; }
      .duel-entry-sub{ max-width:100%; }
      .duel-entry-cta{ justify-self:stretch; width:100%; margin-top:.15rem; padding:.5rem .8rem; font-size:.88rem; }
      .duel-entry-card:hover .duel-entry-cta{ transform:translateY(-1px); }
    }
    @media(max-width:480px){
      .duel-entry-card{ gap:.5rem; padding:.65rem .85rem; }
      .duel-entry-icon{ width:clamp(40px, 17vw, 48px); height:clamp(40px, 17vw, 48px); border-radius:clamp(12px, 6vw, 16px); font-size:clamp(1rem, .85rem + .4vw, 1.25rem); }
      .duel-entry-title{ font-size:clamp(.95rem, .85rem + .32vw, 1.12rem); }
      .duel-entry-sub{ font-size:.78rem; }
      .duel-entry-cta{ font-size:.84rem; padding:.46rem .75rem; }
    }
    @media(max-width:380px){
      .duel-entry-card{ grid-template-columns:minmax(0,1fr); grid-template-areas:'icon' 'content' 'cta'; align-items:flex-start; }
      .duel-entry-icon{ justify-self:flex-start; margin-bottom:.2rem; }
      .duel-entry-content{ width:100%; }
      .duel-entry-cta{ justify-content:center; font-size:.82rem; }
    }
    /* Ads: fixed placeholders to keep CLS at 0 */
    .ad-banner-slot{ position:sticky; bottom:56px; /* leave room for bottom nav */ height:var(--adBannerH); z-index:40; }
    .ad-banner-inner{ height:100%; max-width:420px; margin:0 auto; display:flex; align-items:center; justify-content:center; border-radius:14px; border:1px dashed rgba(255,255,255,.25); background:rgba(0,0,0,.15) }
    .ad-native-slot{ min-height:110px; border-radius:16px; border:1px dashed rgba(255,255,255,.25); background:rgba(0,0,0,.12); display:flex; align-items:center; justify-content:center; }
    .ad-skeleton{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#fff; opacity:.7; font-weight:700; }
    .ad-close{ position:absolute; top:.4rem; left:.4rem; background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.2); width:32px;height:32px;border-radius:999px; display:flex;align-items:center;justify-content:center }
    .interstitial{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:90; padding:1.2rem }
    .interstitial.show{ display:grid }
    .interstitial-card{ position:relative; width:min(420px,96vw); height:min(70vh,520px); border-radius:20px; overflow:hidden; }
    .rewarded{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:90; padding:1.2rem }
    .rewarded.show{ display:grid }
    .rewarded-card{ position:relative; width:min(420px,96vw); height:min(70vh,520px); border-radius:20px; overflow:hidden; }
    .vip-frame{ box-shadow:0 0 0 3px rgba(251,191,36,.9), 0 0 20px rgba(251,191,36,.35) inset; border-radius:999px }
    .province-frame{ box-shadow:0 0 0 3px rgba(16,185,129,.9), 0 0 20px rgba(16,185,129,.35) inset; border-radius:999px }
    @media(min-width:640px){ .ad-banner-slot{ bottom:64px } }

    .duel-opponent{ gap:1rem; }
    .duel-opponent-action{ display:flex; align-items:center; }
    .duel-opponent-action .btn{ min-width:140px; }
    #duel-friends-list{ max-height:min(20rem,60vh); }

    @media(max-width:640px){
      .match-types{ grid-template-columns:1fr; }
      .duel-opponent{ flex-direction:column; align-items:stretch; text-align:right; }
      .duel-opponent-action{ width:100%; }
      .duel-opponent-action .btn{ width:100%; min-width:0; }
    }

    @media(min-width:641px) and (max-width:1024px){
      .match-types{ grid-template-columns:repeat(2,1fr); }
    }
    /* Game Limits UI */
    .limit-card{ background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.15); }
    .limit-bar{ height:8px; width:100%; background:rgba(255,255,255,0.2); border-radius:4px; overflow:hidden; margin-top:0.5rem }
    .limit-progress{ height:100%; background:linear-gradient(90deg,var(--accent1),var(--accent2)); border-radius:4px; transition:width 0.5s ease }
    /* Province Pass */
    .pass-card{ background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.15); }
    .pass-free{ border-left:3px solid var(--accent3) }
    .pass-premium{ border-left:3px solid var(--accent1) }
    .mission-item{ display:flex; align-items:center; justify-content:space-between; padding:0.75rem; background:rgba(255,255,255,0.1); border-radius:0.75rem; margin-bottom:0.5rem }
    .mission-item.completed{ opacity:0.6 }
    .mission-reward{ font-size:0.8rem; display:flex; align-items:center; gap:0.25rem }
    /* Referral */
    .referral-code{ background:rgba(255,255,255,0.1); border-radius:0.75rem; padding:0.75rem 1rem; font-family:monospace; font-size:1.1rem; text-align:center; margin:0.5rem 0 }
    .referral-tier{ display:flex; align-items:center; justify-content:space-between; padding:0.75rem; background:rgba(255,255,255,0.1); border-radius:0.75rem; margin-bottom:0.5rem }
    /* Support & Advertisers */
    .form-group{ margin-bottom:1rem }
    .form-label{ display:block; margin-bottom:0.5rem; font-weight:500 }
    .form-input{ width:100%; padding:0.75rem; border-radius:0.75rem; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:var(--text); min-height:44px }
    .form-textarea{ width:100%; padding:0.75rem; border-radius:0.75rem; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:var(--text); min-height:100px; resize:vertical }
    .ticket-item{ background:rgba(255,255,255,0.1); border-radius:0.75rem; padding:1rem; margin-bottom:0.75rem }
    .ticket-status{ display:inline-block; padding:0.25rem 0.5rem; border-radius:999px; font-size:0.75rem; font-weight:700 }
    .status-open{ background:rgba(251,191,36,0.2); color:var(--accent1) }
    .status-closed{ background:rgba(16,185,129,0.2); color:#10b981 }
    .status-pending{ background:rgba(167,139,250,0.2); color:#a78bfa }
    .advertiser-form{ background:rgba(255,255,255,0.05); padding:1.5rem; border-radius:1.5rem; border:1px solid rgba(255,255,255,0.2); }
    .advertiser-form .form-input,
    .advertiser-form .form-textarea,
    .advertiser-form select{
      background:rgba(255,255,255,0.15);
      border:1px solid rgba(255,255,255,0.3);
      transition:all .3s ease;
    }
    .advertiser-form .form-input:focus,
    .advertiser-form .form-textarea:focus,
    .advertiser-form select:focus{
      background:rgba(255,255,255,0.25);
      border-color:var(--accent1);
      box-shadow:0 0 0 3px rgba(251,146,60,0.4);
      outline:none;
    }
    /* Loading skeleton */
    .skeleton{ background:linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%); background-size:200% 100%; animation:skeleton-loading 1.5s infinite }
    @keyframes skeleton-loading{ 0%{ background-position:200% 0 } 100%{ background-position:-200% 0 } }
    .skeleton-text{ height:1rem; border-radius:0.25rem; margin-bottom:0.5rem }
    .skeleton-title{ height:1.5rem; width:70%; border-radius:0.25rem; margin-bottom:1rem }
    .skeleton-button{ height:44px; border-radius:1rem; width:100% }
    /* Loading Screen */
    #loading{ position:fixed; inset:0; background:linear-gradient(135deg, var(--brand1), var(--brand2), var(--brand3)); display:flex; align-items:center; justify-content:center; z-index:9999; flex-direction:column; gap:1rem; transition:opacity 0.5s ease; }
    #loading.hidden{ opacity:0; pointer-events:none; }
    .loading-spinner{ width:60px; height:60px; border:4px solid rgba(255,255,255,0.3); border-top:4px solid white; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{ 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

    /* --- Shop refresh --- */
.ribbon {
  position:absolute; top:.5rem; left:.5rem;
  background:linear-gradient(135deg,var(--accent1),var(--accent2));
  color:#111827; font-weight:800; font-size:.75rem; padding:.25rem .6rem;
  border-radius:999px; box-shadow:0 8px 24px rgba(251,146,60,.35)
}
#pkg-grid{ grid-auto-rows:1fr; }
.product-card { position:relative; }
.product-card:disabled { opacity:.55; cursor:not-allowed; }



/* Enhanced Payment Modal */
.payment-modal {
  position: fixed;
  inset: 0;
  display: none;
  place-items: center;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  z-index: 100;
  padding: 1rem;
  animation: fadeIn 0.3s ease;
}

.payment-modal.show {
  display: grid;
}

.payment-modal-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
  backdrop-filter: blur(30px);
  -webkit-backdrop-filter: blur(30px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 2rem;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-width: 420px;
  width: 100%;
  padding: 2rem;
  position: relative;
  overflow: hidden;
  animation: slideUp 0.4s ease;
}

.payment-modal-card::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(251, 146, 60, 0.1), transparent 70%);
  animation: rotate 20s linear infinite;
}

@keyframes slideUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.payment-header {
  text-align: center;
  margin-bottom: 2rem;
  position: relative;
  z-index: 1;
}

.payment-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 1rem;
  background: linear-gradient(135deg, var(--accent1), var(--accent2));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  color: #111827;
  box-shadow: 0 10px 30px rgba(251, 146, 60, 0.3);
  animation: pulse 2s infinite;
}

.payment-details {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 1rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  position: relative;
  z-index: 1;
}

.payment-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.payment-row:last-child {
  border-bottom: none;
}

.payment-label {
  opacity: 0.8;
  font-size: 0.9rem;
}

.payment-value {
  font-weight: 700;
  font-size: 1.1rem;
}

.payment-warning {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 0.75rem;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: none;
  position: relative;
  z-index: 1;
}

.payment-warning.show {
  display: block;
  animation: shake 0.5s ease;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.payment-actions {
  display: flex;
  gap: 1rem;
  position: relative;
  z-index: 1;
}

.payment-success-animation {
  position: absolute;
  inset: 0;
  display: none;
  place-items: center;
  background: rgba(16, 185, 129, 0.1);
  z-index: 10;
}

.payment-success-animation.show {
  display: grid;
}



/* --- Province select fixes --- */
#modal-province-select { z-index: 120 !important; }        /* بالاتر از بقیه مودال‌ها */
#modal-province-select .glass { overflow: visible !important; }
#first-province { pointer-events: auto; }                  /* اگر لایه‌ای روی select بود */


  </style>
</head>
<body class="min-h-screen text-white flex flex-col">

  <!-- Loading Screen -->
  <div id="loading">
    <div class="loading-spinner"></div>
    <div class="text-2xl font-bold">در حال بارگذاری...</div>
  </div>
  <!-- Header -->
  <header class="glass sticky top-0 z-30 w-full px-4 py-3 flex items-center justify-between shadow-lg">
    <div class="flex items-center gap-3">
      <div class="relative">
        <img id="hdr-avatar" src="https://i.pravatar.cc/80?img=12" class="w-12 h-12 rounded-full border-2 border-white/30 shadow-md" alt="avatar" />
        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
      </div>
      <div>
        <div id="hdr-name" class="font-bold text-lg">کاربر مهمان</div>
        <div class="text-xs text-white/80 flex items-center gap-2 flex-wrap">
          <span class="flex items-center gap-1"><i class="fas fa-star text-yellow-300"></i> امتیاز: <b id="hdr-score">۰</b></span>
          <span class="flex items-center gap-1" title="سکه بازی"><i class="fas fa-coins text-yellow-300"></i> <b id="hdr-gcoins">۰</b></span>
          <!-- Wallet (server) -->
          <span class="flex items-center gap-1" title="کیف پول (سرور)"><i class="fas fa-wallet text-emerald-300"></i> <b id="hdr-wallet">—</b></span>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <span id="vip-badge" class="chip bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold hidden" aria-live="polite">وی‌آی‌پی</span>
      <button type="button" id="btn-theme" class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 text-sm hover:bg-white/20 transition-all" title="تم" aria-label="تغییر تم">
        <i class="fas fa-moon"></i>
      </button>
      <button type="button" id="btn-settings" class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 text-sm hover:bg-white/20 transition-all" title="تنظیمات" aria-label="تنظیمات">
        <i class="fas fa-sliders-h"></i>
      </button>
      <button type="button" id="btn-notify" class="relative px-3 py-2 rounded-xl bg-white/10 border border-white/20 text-sm hover:bg-white/20 transition-all" title="اعلان‌ها" aria-label="اعلان‌ها">
        <i class="fas fa-bell"></i>
        <span id="notif-dot" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs">۳</span>
      </button>
    </div>
  </header>
  <!-- Banner Ad Placeholder (CLS-safe) -->
  <div id="ad-banner" class="ad-banner-slot safe">
    <div class="ad-banner-inner relative overflow-hidden max-w-md">
      <div class="ad-skeleton w-full text-center select-none">محل بنر ۳۲۰×۵۰/۱۰۰</div>
    </div>
  </div>
  <!-- Pages -->
  <main id="pages" class="flex-1 w-full max-w-md mx-auto p-4 space-y-5">
    <!-- DASHBOARD -->
    <section id="page-dashboard" class="space-y-5">
      <!-- Profile -->
      <div class="glass rounded-3xl p-6 shadow-xl card-hover">
        <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6 mb-4">
          <div class="relative w-24 h-24 sm:w-20 sm:h-20">
            <img id="profile-avatar" src="https://i.pravatar.cc/120?img=12" class="w-full h-full rounded-full border-4 border-white/30 shadow-lg" alt="avatar" />
            <div class="absolute bottom-0 right-0 w-8 h-8 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center border-2 border-white">
              <i class="fas fa-crown text-white text-sm"></i>
            </div>
          </div>
          <div class="flex-1 text-center sm:text-right">
            <div class="flex justify-center sm:justify-start items-center gap-2">
              <h2 id="profile-name" class="text-2xl font-extrabold">زکی</h2>
              <span id="vip-chip" class="chip bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold hidden">وی‌آی‌پی</span>
            </div>
            <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-white/80">
              <div class="flex items-center justify-center sm:justify-start gap-1">
                <i class="fas fa-flag text-yellow-300"></i>
                <span>رتبه کشوری: <span id="rank-country" class="font-bold">—</span></span>
              </div>
              <div class="flex items-center justify-center sm:justify-start gap-1">
                <i class="fas fa-map-marker-alt text-emerald-300"></i>
                <span>رتبه استان: <span id="rank-province" class="font-bold">—</span></span>
              </div>
              <div class="flex items-center justify-center sm:justify-start gap-1">
                <i class="fas fa-location-dot text-sky-300"></i>
                <span>استان شما: <span id="user-province">—</span></span>
              </div>
              <div id="btn-view-group" class="location-card col-span-1 sm:col-span-2 mt-1 sm:mt-0" data-empty="true">
                <div class="location-icon group-icon">
                  <i class="fas fa-user-plus"></i>
                </div>
                <div class="flex-1 text-right">
                  <div class="group-card-title font-bold">گروه شما</div>
                  <div class="group-card-value text-sm opacity-90" id="user-group">—</div>
                  <div id="user-group-empty-hint" class="group-card-empty text-xs opacity-80 hidden mt-1 flex items-center gap-1 justify-end sm:justify-start sm:flex-row-reverse">
                    <i class="fas fa-circle-info"></i>
                    <span>هنوز عضو هیچ گروهی نشده‌ای</span>
                  </div>
                </div>
                <i class="fas fa-chevron-left opacity-70"></i>
              </div>
              <div class="flex items-center justify-center sm:justify-start gap-1 col-span-1 sm:col-span-2">
                <i class="fas fa-swords text-rose-300"></i>
                <div class="flex flex-wrap justify-center sm:justify-start items-center gap-2">
                  <span class="chip text-green-300 bg-green-500/20 border-green-500/30"><i class="fas fa-trophy"></i><span id="duel-wins">۰</span> برد</span>
                  <span class="chip text-rose-300 bg-rose-500/20 border-rose-500/30"><i class="fas fa-skull"></i><span id="duel-losses">۰</span> باخت</span>
                </div>
              </div>
            </div>
          </div>
          <button id="btn-edit-profile" class="btn btn-secondary w-full sm:w-auto mt-4 sm:mt-0 text-sm">ویرایش</button>
        </div>
        <div class="divider"></div>
        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="glass rounded-2xl p-4 card-hover">
            <div class="text-2xl font-extrabold text-yellow-300" id="stat-score">۰</div>
            <div class="text-xs opacity-80 mt-1">امتیاز</div>
          </div>
          <div class="glass rounded-2xl p-4 card-hover" title="سکه بازی (لوکال)">
            <div class="text-2xl font-extrabold text-emerald-300" id="stat-coins">۰</div>
            <div class="text-xs opacity-80 mt-1">سکه بازی</div>
          </div>
          <div class="glass rounded-2xl p-4 card-hover">
            <div class="text-2xl font-extrabold text-rose-300" id="stat-lives">۳</div>
            <div class="text-xs opacity-80 mt-1">کلید</div>
          </div>
          <div class="glass rounded-2xl p-4 card-hover col-span-3" title="کیف پول (سرور)">
            <div class="flex items-center justify-between">
              <div class="text-sm opacity-90 flex items-center gap-2">
                <i class="fas fa-wallet text-emerald-300"></i>
                <span>کیف پول</span>
              </div>
              <div class="text-xl font-extrabold" id="stat-wallet">—</div>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2">
              <button id="go-wallet" class="btn btn-primary text-sm w-full px-4 py-3" aria-label="رفتن به خرید سکه"><i class="fas fa-coins ml-2"></i> خرید سکه</button>
              <button id="go-vip" class="btn btn-tertiary text-sm w-full px-4 py-3" aria-label="رفتن به اشتراک VIP"><i class="fas fa-crown ml-2"></i> اشتراک VIP</button>
            </div>
          </div>
        </div>
        <div id="no-group-hint" class="hidden mt-5">
          <div class="no-group-card flex flex-col sm:flex-row sm:items-center gap-5 p-5">
            <div class="flex flex-col sm:flex-row sm:items-start items-center gap-3 sm:flex-1 text-center sm:text-right">
              <div class="cta-icon">
                <i class="fas fa-user-group"></i>
              </div>
              <div class="space-y-2">
                <div class="text-lg font-extrabold">عضویت در گروهی ندارید</div>
                <p class="text-sm opacity-90">برای شرکت در نبردهای تیمی و دریافت امتیازهای ویژه، یکی از گروه‌های فعال را انتخاب کنید یا گروه تازه‌ای بسازید.</p>
              </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
              <button id="btn-go-groups" class="btn btn-tertiary btn-inline text-sm"><i class="fas fa-users ml-2"></i> مشاهده گروه‌ها</button>
              <button id="btn-create-group-cta" class="btn btn-group btn-inline text-sm"><i class="fas fa-plus ml-2"></i> ایجاد گروه جدید</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Game Limits -->
      <div class="glass rounded-3xl p-5 card-hover">
        <div class="flex items-center justify-between mb-3">
          <div class="text-lg font-bold flex items-center gap-2">
            <i class="fas fa-hourglass-half text-amber-300"></i>
            <span>محدودیت‌های روزانه</span>
          </div>
          <div class="text-xs opacity-80" id="daily-reset-timer">ریست در ۲۳:۵۹:۵۹</div>
        </div>
        
        <div class="space-y-3">
          <!-- Matches Limit -->
          <div class="limit-card">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <i class="fas fa-gamepad text-purple-300"></i>
                <span>کوییز روزانه</span>
              </div>
              <span class="text-sm"><span id="matches-used">0</span>/<span id="matches-limit">5</span></span>
            </div>
            <div class="limit-bar">
              <div id="matches-progress" class="limit-progress" style="width:0%"></div>
            </div>
            <div class="mt-3">
              <button id="btn-reset-match-limit" class="btn btn-secondary text-sm w-full py-2">
                <i class="fas fa-key ml-1"></i> حذف محدودیت با 10 کلید
              </button>
            </div>
          </div>

          <!-- Duel Limit -->
          <div class="limit-card">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <i class="fas fa-hand-fist text-rose-400"></i>
                <span>نبرد تن به تن</span>
              </div>
              <span class="text-sm"><span id="duels-used">0</span>/<span id="duels-limit">3</span></span>
            </div>
            <div class="limit-bar">
              <div id="duels-progress" class="limit-progress" style="width:0%"></div>
            </div>
            <div class="mt-3">
              <button id="btn-reset-duel-limit" class="btn btn-secondary text-sm w-full py-2">
              <i class="fas fa-key ml-1"></i> حذف محدودیت با 10 کلید
              </button>
            </div>
          </div>

          <!-- Group Battle Limit -->
          <div class="limit-card">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <i class="fas fa-users text-indigo-300"></i>
                <span>نبرد گروهی</span>
              </div>
              <span class="text-sm"><span id="group-battles-used">0</span>/<span id="group-battles-limit">2</span></span>
            </div>
            <div class="limit-bar">
              <div id="group-battles-progress" class="limit-progress" style="width:0%"></div>
            </div>
            <div class="mt-3">
              <button id="btn-reset-group-limit" class="btn btn-secondary text-sm w-full py-2">
                <i class="fas fa-key ml-1"></i> حذف محدودیت با 10 کلید
              </button>
            </div>
          </div>
        </div>
        
        <!-- Limit Reached CTAs (hidden by default) -->
        <div id="limit-reached-ctas" class="hidden mt-4 space-y-2">
          <div class="text-center text-sm opacity-90 mb-2">به محدودیت روزانه رسیدی!</div>
          <button id="btn-buy-vip-limit" class="btn btn-tertiary text-sm w-full px-4 py-3">
            <i class="fas fa-crown ml-2"></i> خرید VIP و افزایش محدودیت‌ها
          </button>
          <button id="btn-reset-limits" class="btn btn-secondary text-sm w-full px-4 py-3">
            <i class="fas fa-key ml-2"></i> حذف محدودیت با 10 کلید
          </button>
        </div>
      </div>
      
      <!-- Native Ad (CLS-safe placeholder) -->
      <div id="ad-native-dashboard" class="ad-native-slot relative overflow-hidden">
        <div class="ad-skeleton">تبلیغ همسان</div>
      </div>
      
      <!-- Daily -->
      <div class="glass rounded-3xl p-5 card-hover">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm opacity-90 flex items-center gap-1">
              <i class="fas fa-bolt text-yellow-300"></i>
              <span>چالش روز</span>
            </div>
            <div class="text-lg font-bold">۵ سؤال تصادفی • جایزه: ۵۰💰</div>
          </div>
          <button id="btn-daily" class="btn btn-primary w-auto px-6 py-3">شروع</button>
        </div>
      </div>
      
      <!-- Streak -->
      <div class="glass rounded-3xl p-5 card-hover">
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="text-sm opacity-90 flex items-center gap-1">
              <i class="fas fa-fire text-orange-400"></i>
              <span>استریک روزانه</span>
            </div>
            <div class="text-2xl font-extrabold"><span id="streak">۰</span> روز</div>
          </div>
          <button id="btn-claim-streak" class="btn btn-primary w-auto px-5 py-2 pulse" aria-label="دریافت پاداش استریک">
            <i class="fas fa-gift ml-1"></i> دریافت پاداش
          </button>
        </div>
        <div class="w-full h-3 bg-white/15 rounded-full mt-3 overflow-hidden">
          <div id="streak-bar" class="h-3 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
        <div class="text-xs mt-3 opacity-80 flex items-start gap-1">
          <i class="fas fa-info-circle mt-0.5"></i>
          <span>هر روز وارد بشی پاداش می‌گیری؛ اگر جا بمونی صفر می‌شه 😬</span>
        </div>
      </div>
      
      <!-- Province Ranking -->
      <div class="glass rounded-3xl p-5 card-hover">
        <div class="flex items-center justify-between mb-4">
          <div class="text-lg font-bold flex items-center gap-2">
            <i class="fas fa-flag text-green-300"></i>
            <span>رتبه استان شما</span>
          </div>
          <div class="text-xs opacity-80">فصل ۱ • هفته ۱</div>
        </div>

        <div id="province-top" class="grid grid-cols-2 gap-3 mb-4"></div>
        <div id="my-province-rank" class="flex justify-center mb-4"></div>
        <div class="text-sm text-center opacity-80 mb-4">
          هر امتیازی که می‌گیرید، گامی برای صعود استان‌تان به رتبه‌های بالاتر است.
        </div>

        <button id="btn-view-ranking" class="btn btn-province w-full">
          <i class="fas fa-ranking-star ml-2"></i> مشاهده رتبه‌بندی
        </button>
      </div>
      
      <!-- Match Types -->
      <div class="glass rounded-3xl p-5">
        <h3 class="text-xl font-extrabold mb-4 flex items-center gap-2">
          <i class="fas fa-gamepad text-purple-300"></i>
          <span>مسابقات</span>
        </h3>
        <div class="match-types">
          <div class="match-type-card" data-match="duel">
            <div class="match-type-icon text-red-400">
              <i class="fas fa-hand-fist"></i>
            </div>
            <div class="font-bold">نبرد با دوستان</div>
          </div>
          <div class="match-type-card" data-match="province">
            <div class="match-type-icon text-green-400">
              <i class="fas fa-map-marked-alt"></i>
            </div>
            <div class="font-bold">مسابقه استانی</div>
          </div>
          <div class="match-type-card" data-match="group">
            <div class="match-type-icon text-purple-400">
              <i class="fas fa-users"></i>
            </div>
            <div class="font-bold">مسابقه گروهی</div>
          </div>
        </div>
        <div class="active-matches">
          <div class="text-sm font-bold mb-2 opacity-90">درخواست های نبرد</div>
          <div class="active-match-item">
            <div class="match-info">
              <img src="https://i.pravatar.cc/50?img=3" class="match-avatar" alt="opponent">
              <div class="match-details">
                <div class="match-name">علی رضایی</div>
                <div class="match-status">در انتظار پاسخ</div>
              </div>
            </div>
            <button class="match-action">پذیرفتن</button>
          </div>
          <div class="active-match-item">
            <div class="match-info">
              <div class="location-icon province-icon">
                <i class="fas fa-map-marked-alt"></i>
              </div>
              <div class="match-details">
                <div class="match-name">مسابقه استان کردستان</div>
                <div class="match-status">شروع در ۲۰:۰۰</div>
              </div>
            </div>
            <button class="match-action">ثبت‌نام</button>
          </div>
        </div>
      </div>
      
      <!-- Quick -->
      <div class="space-y-4">
        <button class="btn btn-primary text-lg" id="btn-play">
          <i class="fas fa-gamepad ml-2"></i> شروع کوییز
        </button>
        <div class="grid grid-cols-2 gap-4">
          <button type="button" class="btn btn-secondary" id="btn-shop" data-tab="shop">
            <i class="fas fa-shopping-cart ml-2"></i> فروشگاه
          </button>
          <button type="button" class="btn btn-tertiary" id="btn-leaderboard" data-tab="leaderboard">
            <i class="fas fa-chart-line ml-2"></i> لیدربورد
          </button>
        </div>
        <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-invite">
          <i class="fas fa-user-plus"></i>
          <span>دعوت دوستان (+سکه)</span>
        </button>
      </div>
      
      <!-- Sponsor (also used as native fallback) -->
      <div class="glass rounded-3xl p-4 text-center text-sm" id="sponsor-card">
        <div class="flex items-center justify-center gap-2">
          <i class="fas fa-bolt text-yellow-300"></i>
          <span>اسپانسر امروز: <span class="font-bold">کافه XYZ</span></span>
        </div>
        <div class="mt-2">
          کد تخفیف: <span class="font-mono bg-white/20 px-2 py-1 rounded">SANANDAJ10</span>
        </div>
      </div>
      <button id="btn-advertisers" class="btn btn-tertiary w-full">
        درخواست تبلیغ
      </button>
    </section>
    
    <!-- QUIZ -->
    <section id="page-quiz" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6 shadow-xl">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2 text-sm gap-2">
          <div class="flex items-center gap-2 flex-wrap justify-center sm:justify-start">
            <span id="quiz-cat" class="chip"><i class="fas fa-folder ml-1"></i> عمومی</span>
            <span id="quiz-diff" class="chip"><i class="fas fa-signal ml-1"></i> آسان</span>
            <span class="chip"><i class="fas fa-hashtag ml-1"></i> <span id="qnum">۱</span>/<span id="qtotal">۵</span></span>
          </div>
          <div class="flex items-center gap-2 justify-center sm:justify-end">
            <span class="chip"><i class="fas fa-key text-yellow-400 ml-1"></i> <span id="lives">۳</span></span>
            <span class="chip"><i class="fas fa-coins text-yellow-300 ml-1"></i> <span id="coins">۰</span></span>
          </div>
        </div>
        <div id="duel-banner" class="hidden mb-2 flex items-center justify-center">
          <span class="chip"><i class="fas fa-hand-fist text-red-400 ml-1"></i><span id="duel-opponent-name"></span></span>
        </div>
        <div class="mt-2 flex items-center justify-center">
          <div class="relative w-[140px] h-[140px]">
            <svg width="140" height="140" viewBox="0 0 140 140" class="-rotate-90 block">
              <circle cx="70" cy="70" r="64" stroke="rgba(255,255,255,.2)" stroke-width="12" fill="none"/>
              <circle id="timer-ring" cx="70" cy="70" r="64" stroke="url(#gradient)" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="402.124" stroke-dashoffset="0"/>
              <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#fde047" />
                  <stop offset="100%" stop-color="#fb923c" />
                </linearGradient>
              </defs>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="text-3xl font-extrabold leading-none" id="timer-text">۳۰</div>
            </div>
          </div>
        </div>
        <h3 id="question" class="text-xl font-bold mt-4 leading-8 text-center"></h3>
      </div>
      
      <!-- Lifelines -->
      <div class="lifelines-grid">
        <button id="life-5050" class="lifeline-btn" type="button" aria-label="کمک ۵۰–۵۰">
          <div class="lifeline-icon"><i class="fas fa-percent"></i></div>
          <div class="lifeline-details">
            <div class="lifeline-title">۵۰–۵۰</div>
            <div class="lifeline-sub">حذف دو گزینهٔ نادرست</div>
          </div>
          <div class="lifeline-footer">
            <div class="lifeline-cost"><i class="fas fa-key"></i><span>۳ کلید</span></div>
            <div class="lifeline-status hidden"><i class="fas fa-check ml-1"></i> ۵۰–۵۰ فعال شد</div>
          </div>
        </button>
        <button id="life-skip" class="lifeline-btn" type="button" aria-label="پرش به سؤال بعدی">
          <div class="lifeline-icon"><i class="fas fa-forward"></i></div>
          <div class="lifeline-details">
            <div class="lifeline-title">پرش به سؤال بعدی</div>
            <div class="lifeline-sub">یک‌بار می‌توانی سؤال را رد کنی</div>
          </div>
          <div class="lifeline-footer">
            <div class="lifeline-cost"><i class="fas fa-key"></i><span>۳ کلید</span></div>
            <div class="lifeline-status hidden"><i class="fas fa-check ml-1"></i> سؤال بعدی فعال شد</div>
          </div>
        </button>
        <button id="life-pause" class="lifeline-btn" type="button" aria-label="افزودن زمان">
          <div class="lifeline-icon"><i class="fas fa-stopwatch"></i></div>
          <div class="lifeline-details">
            <div class="lifeline-title">افزودن ۱۰ ثانیه</div>
            <div class="lifeline-sub">۱۰ ثانیه زمان بیشتر برای این سؤال</div>
          </div>
          <div class="lifeline-footer">
            <div class="lifeline-cost"><i class="fas fa-key"></i><span>۳ کلید</span></div>
            <div class="lifeline-status hidden"><i class="fas fa-bolt ml-1"></i> ۱۰ ثانیه اضافه شد</div>
          </div>
        </button>
      </div>
      
      <div id="choices" class="space-y-4"></div>
      
      <div class="flex flex-col sm:flex-row items-center gap-4">
        <button id="btn-quit" class="w-full sm:flex-1 py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2">
          <i class="fas fa-arrow-right"></i> خروج
        </button>
      </div>
    </section>
    
    <!-- RESULTS -->
    <section id="page-results" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6 text-center">
        <div class="text-2xl font-extrabold mb-2">نتیجهٔ مسابقه</div>
        <div class="text-sm opacity-80 mb-4">خلاصهٔ عملکردت 👇</div>
        <!-- Duel result (shown only when playing a duel) -->
        <div id="duel-result" class="hidden mb-4">
          <div class="duel-avatars">
            <div class="duel-avatar">
              <img id="duel-avatar-you" class="w-16 h-16 rounded-full border-2 border-white/30" alt="you">
              <div id="duel-name-you" class="text-sm"></div>
            </div>
            <div class="duel-vs">VS</div>
            <div class="duel-avatar">
              <img id="duel-avatar-opponent" class="w-16 h-16 rounded-full border-2 border-white/30" alt="opponent">
              <div id="duel-name-opponent" class="text-sm"></div>
            </div>
          </div>
          <div id="duel-winner" class="font-bold mt-2"></div>
          <div id="duel-stats" class="text-sm opacity-90 mt-1 leading-6"></div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="glass rounded-2xl p-4">
            <div class="text-xl font-extrabold text-emerald-300" id="res-correct">۰</div>
            <div class="text-xs opacity-80 mt-1">درست</div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="text-xl font-extrabold text-rose-300" id="res-wrong">۰</div>
            <div class="text-xs opacity-80 mt-1">نادرست</div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="text-xl font-extrabold text-yellow-300" id="res-earned">۰</div>
            <div class="text-xs opacity-80 mt-1">امتیاز کسب‌شده</div>
          </div>
        </div>
        <div class="divider"></div>
        <div id="res-list" class="text-right space-y-2 max-h-64 overflow-auto pr-2"></div>
        <!-- Leaderboard CTA -->
        <div class="mt-4 grid grid-cols-1 gap-3">
          <button id="btn-view-leaderboard" class="btn btn-secondary w-full px-4 py-3" aria-label="مشاهده رتبه‌بندی">
            <i class="fas fa-trophy ml-2"></i> مشاهده رتبه‌بندی
          </button>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <button id="btn-share" class="btn btn-secondary"><i class="fas fa-share-nodes ml-2"></i> اشتراک نتیجه</button>
        <button id="btn-again" class="btn btn-primary"><i class="fas fa-rotate-left ml-2"></i> بازی دوباره</button>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-results">
        <i class="fas fa-home"></i> بازگشت به خانه
      </button>
    </section>
    
    <!-- LEADERBOARD -->
    <section id="page-leaderboard" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-trophy text-yellow-300"></i>
          <span>لیدربورد هفتگی</span>
        </h3>
        <!-- تب‌های لیدربورد -->
        <div class="flex justify-between mb-6 bg-white/10 rounded-xl p-1">
          <button type="button" class="leaderboard-tab flex-1 py-2 px-3 rounded-lg text-center font-medium active" data-tab="individual">
            افراد
          </button>
          <button type="button" class="leaderboard-tab flex-1 py-2 px-3 rounded-lg text-center font-medium" data-tab="province">
            استان‌ها
          </button>
          <button type="button" class="leaderboard-tab flex-1 py-2 px-3 rounded-lg text-center font-medium" data-tab="group">
            گروه‌ها
          </button>
        </div>
        <!-- محتوای لیدربورد -->
        <div id="lb-individual" class="lb-content">
          <div id="lb-list" class="space-y-3"></div>
          <!-- Native ad inline -->
          <div id="ad-native-lb" class="ad-native-slot mt-4 relative overflow-hidden">
            <div class="ad-skeleton">تبلیغ همسان</div>
          </div>
        </div>
        <div id="lb-province" class="lb-content hidden">
          <div id="my-province-rank-lb" class="flex justify-center mb-4"></div>
          <div id="province-list" class="space-y-3"></div>
        </div>
        <div id="lb-group" class="lb-content hidden">
          <div id="group-list" class="space-y-3"></div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-lb">
        <i class="fas fa-arrow-right"></i> بازگشت
      </button>
    </section>
    
    <!-- SHOP -->
<!-- SHOP (Minimal) -->
<section id="page-shop" class="hidden space-y-5">
  <div class="glass rounded-3xl overflow-hidden">
    <!-- نوار بالای فروشگاه -->
    <div class="bg-white/10 border-b border-white/15 px-5 py-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
      <div class="flex items-center gap-2 flex-wrap">
        <span class="chip"><i class="fas fa-coins ml-1"></i> سکه بازی: <b id="shop-gcoins">۰</b></span>
        <span class="chip"><i class="fas fa-wallet ml-1"></i> کیف پول: <b id="shop-wallet">—</b></span>
      </div>
      <button id="btn-open-wallet" class="btn btn-primary w-full sm:w-auto px-4 py-2 text-sm"><i class="fas fa-plus-circle ml-1"></i> شارژ کیف پول</button>
    </div>

    <!-- محتوا -->
    <div class="p-5 space-y-6">
      <!-- بسته‌های کلید -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-lg font-extrabold flex items-center gap-2">
            <i class="fas fa-key text-pink-300"></i><span>کلیدها</span>
          </h4>
          <span class="chip"><i class="fas fa-key ml-1"></i> شما: <b id="keys-count">۰</b></span>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
          <!-- k1 -->
          <button class="product-card glass-dark rounded-2xl p-3 border border-white/15 hover:bg-white/15 transition text-right min-h-[92px] flex flex-col justify-between" data-buy-key="k1" title="خرید ۱ کلید">
            <div class="text-xs opacity-80">بسته کوچک</div>
            <div class="font-extrabold text-lg"><span data-amount>۱</span> کلید</div>
            <div class="text-xs opacity-90"><i class="fas fa-coins text-yellow-300 ml-1"></i> <span data-price>۳۰</span> سکه</div>
          </button>

          <!-- k3 -->
          <button class="product-card glass-dark rounded-2xl p-3 border border-white/15 hover:bg-white/15 transition text-right min-h-[92px] flex flex-col justify-between" data-buy-key="k3" title="خرید ۳ کلید">
            <div class="ribbon">به‌صرفه</div>
            <div class="text-xs opacity-80">بسته اقتصادی</div>
            <div class="font-extrabold text-lg"><span data-amount>۳</span> کلید</div>
            <div class="text-xs opacity-90"><i class="fas fa-coins text-yellow-300 ml-1"></i> <span data-price>۸۰</span> سکه</div>
          </button>

          <!-- k10 -->
          <button class="product-card glass-dark rounded-2xl p-3 border border-white/15 hover:bg-white/15 transition text-right min-h-[92px] flex flex-col justify-between" data-buy-key="k10" title="خرید ۱۰ کلید">
            <div class="text-xs opacity-80">بسته بزرگ</div>
            <div class="font-extrabold text-lg"><span data-amount>۱۰</span> کلید</div>
            <div class="text-xs opacity-90"><i class="fas fa-coins text-yellow-300 ml-1"></i> <span data-price>۲۵۰</span> سکه</div>
          </button>
        </div>

        <div class="text-xs opacity-70 mt-2">کلید با «سکهٔ بازی» پرداخت می‌شه، نه کیف پول.</div>
      </div>

      <!-- VIP -->
      <div class="glass-dark rounded-2xl p-5 card-hover">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 text-center sm:text-right">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center">
              <i class="fas fa-crown text-white text-xl"></i>
            </div>
            <div>
              <div class="font-bold text-lg">اشتراک VIP</div>
              <div class="text-sm opacity-80 mt-1">حذف تبلیغات • سقف روزانه بیشتر • امتیاز اضافه</div>
            </div>
          </div>
          <button id="btn-open-vip" class="btn btn-tertiary w-full sm:w-auto px-4 text-sm"><i class="fas fa-crown ml-1"></i> مشاهده پلن‌ها</button>
        </div>
      </div>

      <!-- Coins (Wallet) -->
      <div class="glass-dark rounded-2xl p-5 card-hover">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 text-center sm:text-right">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-full bg-gradient-to-r from-emerald-400 to-green-500 flex items-center justify-center">
              <i class="fas fa-wallet text-white text-xl"></i>
            </div>
            <div>
              <div class="font-bold text-lg">خرید سکه (کیف پول)</div>
              <div class="text-sm opacity-80 mt-1">بسته‌های ۱۰۰/۵۰۰/۱۲۰۰/۳۰۰۰ با بونوس</div>
            </div>
          </div>
          <button id="btn-open-wallet-2" class="btn btn-primary w-full sm:w-auto px-4 text-sm"><i class="fas fa-coins ml-1"></i> خرید سکه</button>
        </div>
      </div>
    </div>
  </div>

  <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-shop">
    <i class="fas fa-arrow-right"></i> بازگشت
  </button>
</section>


    
    <!-- WALLET (Buy Coins) -->
    <section id="page-wallet" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-2xl font-extrabold flex items-center gap-2">
            <i class="fas fa-wallet text-emerald-300"></i>
            <span>خرید سکه</span>
          </h3>
          <div class="chip" title="موجودی کیف پول (سرور)"><i class="fas fa-coins text-yellow-300 ml-1"></i> <b id="wallet-balance">—</b></div>
        </div>
        <div id="wallet-offline" class="hidden bg-rose-500/20 border border-rose-400/40 text-rose-50 text-sm rounded-xl p-3 mb-3">
          <i class="fas fa-wifi-slash ml-1"></i> آفلاین هستی؛ خرید غیرفعال است.
        </div>
        <div id="pkg-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
        <div class="text-xs opacity-80 mt-3">پس از ایجاد تراکنش، نتیجه از سرور تأیید شده و رسید نمایش داده می‌شود. لطفاً چند ثانیه صبر کن.</div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-wallet">
        <i class="fas fa-arrow-right"></i> بازگشت
      </button>
    </section>
    
    <!-- VIP Subscription -->
    <section id="page-vip" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-2xl font-extrabold flex items-center gap-2">
            <i class="fas fa-crown text-yellow-300"></i>
            <span>اشتراک وی‌آی‌پی</span>
          </h3>
          <div id="vip-status-pill" class="chip"><i class="fas fa-circle-notch fa-spin ml-1"></i> بررسی وضعیت...</div>
        </div>
        <div class="mt-3 grid grid-cols-1 gap-3">
          <!-- VIP Lite -->
          <div class="glass-dark rounded-2xl p-4">
            <div class="flex justify-between items-center mb-2">
              <div class="font-bold text-lg flex items-center gap-2">
                <i class="fas fa-crown text-amber-300"></i>
                <span>وی‌آی‌پی لایت</span>
              </div>
              <div class="font-bold">۹۹,۰۰۰ تومان / ماه</div>
            </div>
            <ul class="text-sm opacity-90 space-y-1 list-disc pr-5 mb-3">
              <li>حذف تبلیغات بنری</li>
              <li>دو برابر محدودیت روزانه مسابقه/کلید</li>
            </ul>
            <button id="buy-vip-lite" class="btn btn-secondary w-full" aria-label="خرید اشتراک VIP لایت">خرید اشتراک</button>
          </div>
          
          <!-- VIP Pro -->
          <div class="glass-dark rounded-2xl p-4 border-2 border-amber-400/30">
            <div class="flex justify-between items-center mb-2">
              <div class="font-bold text-lg flex items-center gap-2">
                <i class="fas fa-crown text-yellow-300"></i>
                <span>وی‌آی‌پی پرو</span>
              </div>
              <div class="font-bold">۱۹۹,۰۰۰ تومان / ماه</div>
            </div>
            <ul class="text-sm opacity-90 space-y-1 list-disc pr-5 mb-3">
              <li>حذف تمام تبلیغات (بنری، همسان، میانی، ویدیویی)</li>
              <li>دو برابر محدودیت روزانه مسابقه/کلید</li>
              <li>دو برابر امتیاز در رویدادها</li>
              <li>قاب آواتار ویژه استان</li>
              <li>محدودیت بسیار بالا برای مسابقه/کلید</li>
            </ul>
            <button id="buy-vip-pro" class="btn btn-primary w-full" aria-label="خرید اشتراک VIP پرو">خرید اشتراک</button>
          </div>
          
          <div id="vip-meta" class="text-sm opacity-90"></div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-vip">
        <i class="fas fa-arrow-right"></i> بازگشت
      </button>
    </section>
    
    <!-- DUEL SETUP -->
    <section id="page-duel" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-hand-fist text-red-400"></i>
          <span>نبرد با دوستان</span>
        </h3>
        <div class="space-y-4">
          <div class="text-center">
            <div class="inline-flex items-center gap-2 px-3 py-2 mb-4 rounded-2xl bg-white/10 border border-white/20 text-sm" aria-live="polite">
              <i class="fas fa-hourglass-half text-amber-300"></i>
              <span>نبرد باقی‌مانده امروز: <span id="duel-limit-remaining">۳</span> / <span id="duel-limit-total">۳</span></span>
            </div>
            <p class="mb-4">دوست خود را برای نبرد انتخاب کنید</p>
            <div class="flex flex-wrap justify-center gap-3 mb-4">
              <button id="btn-duel-random" class="btn btn-duel w-auto px-5 py-2 flex items-center gap-2">
                <i class="fas fa-shuffle"></i><span>حریف تصادفی</span>
              </button>
              <button id="btn-duel-link" class="btn btn-tertiary w-auto px-5 py-2 flex items-center gap-2">
                <i class="fas fa-link"></i><span>لینک دعوت</span>
              </button>
            </div>
            <div id="duel-friends-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-duel">
        <i class="fas fa-arrow-right"></i> بازگشت
      </button>
    </section>
    
    <!-- PROVINCE SETUP -->
    <section id="page-province" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-map-marked-alt text-green-400"></i>
          <span>مسابقه استانی</span>
        </h3>
        <div class="space-y-4">
          <div class="text-center">
            <p class="mb-4">استان خود را برای مسابقه انتخاب کنید</p>
            <div class="space-y-3 max-h-80 overflow-y-auto pr-2">
              <div class="location-card" data-province="1">
                <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
                <div class="flex-1">
                  <div class="font-bold">تهران</div>
                  <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>۱۲۴ شرکت‌کننده</span></div>
                </div>
                <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> ۱۸,۵۰۰</div>
              </div>
              <div class="location-card" data-province="2">
                <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
                <div class="flex-1">
                  <div class="font-bold">اصفهان</div>
                  <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>۹۸ شرکت‌کننده</span></div>
                </div>
                <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> ۱۵,۲۰۰</div>
              </div>
              <div class="location-card" data-province="3">
                <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
                <div class="flex-1">
                  <div class="font-bold">خراسان رضوی</div>
                  <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>۱۱۲ شرکت‌کننده</span></div>
                </div>
                <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> ۱۶,۸۰۰</div>
              </div>
              <div class="location-card" data-province="4">
                <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
                <div class="flex-1">
                  <div class="font-bold">فارس</div>
                  <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>۸۷ شرکت‌کننده</span></div>
                </div>
                <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> ۱۴,۳۰۰</div>
              </div>
              <div class="location-card" data-province="5">
                <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
                <div class="flex-1">
                  <div class="font-bold">کردستان</div>
                  <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>۱۰۵ شرکت‌کننده</span></div>
                </div>
                <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> ۱۵,۹۰۰</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-province">
        <i class="fas fa-arrow-right"></i> بازگشت
      </button>
    </section>
    
    <!-- GROUP SETUP -->
    <section id="page-group" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-users text-purple-400"></i>
          <span>مسابقه گروهی</span>
        </h3>
        <div class="space-y-4">
          <div class="text-center">
            <p class="mb-4">گروه خود را برای مسابقه انتخاب کنید</p>
            <button id="btn-create-group" class="btn btn-group w-full mb-4"><i class="fas fa-plus ml-2"></i> ایجاد گروه جدید</button>
            <div id="group-select-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-group">
        <i class="fas fa-arrow-right"></i> بازگشت
      </button>
    </section>
    
    <!-- PROVINCE PASS MISSIONS -->
    <section id="page-pass-missions" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-2xl font-extrabold flex items-center gap-2">
            <i class="fas fa-flag text-green-300"></i>
            <span>مأموریت‌های استان پاس</span>
          </h3>
          <div class="text-xs opacity-80">فصل ۱ • هفته ۱</div>
        </div>
        
        <div class="mb-6">
          <h4 class="font-bold mb-3 flex items-center gap-2">
            <i class="fas fa-calendar-day text-blue-300"></i>
            <span>مأموریت‌های روزانه</span>
          </h4>
          <div class="space-y-2">
            <div class="mission-item">
              <div>
                <div class="font-medium">برنده ۳ مسابقه</div>
                <div class="text-xs opacity-70">پاداش: ۱۰ XP رایگان + ۵ XP پریمیوم</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-star text-yellow-300"></i>
                <span>۰/۳</span>
              </div>
            </div>
            <div class="mission-item">
              <div>
                <div class="font-medium">پاسخ به ۱۰ سؤال</div>
                <div class="text-xs opacity-70">پاداش: ۵ XP رایگان + ۳ XP پریمیوم</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-star text-yellow-300"></i>
                <span>۰/۱۰</span>
              </div>
            </div>
            <div class="mission-item completed">
              <div>
                <div class="font-medium">اشتراک نتیجه در شبکه‌های اجتماعی</div>
                <div class="text-xs opacity-70">پاداش: ۵ XP رایگان + ۳ XP پریمیوم</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-check-circle text-green-300"></i>
                <span>انجام شد</span>
              </div>
            </div>
          </div>
        </div>
        
        <div>
          <h4 class="font-bold mb-3 flex items-center gap-2">
            <i class="fas fa-calendar-week text-purple-300"></i>
            <span>مأموریت‌های هفتگی</span>
          </h4>
          <div class="space-y-2">
            <div class="mission-item">
              <div>
                <div class="font-medium">کسب ۵۰۰ امتیاز در مسابقات استانی</div>
                <div class="text-xs opacity-70">پاداش: ۲۰ XP رایگان + ۱۵ XP پریمیوم</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-star text-yellow-300"></i>
                <span>۰/۵۰۰</span>
              </div>
            </div>
            <div class="mission-item">
              <div>
                <div class="font-medium">دعوت ۲ دوست جدید</div>
                <div class="text-xs opacity-70">پاداش: ۱۵ XP رایگان + ۱۰ XP پریمیوم</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-star text-yellow-300"></i>
                <span>۰/۲</span>
              </div>
            </div>
            <div class="mission-item">
              <div>
                <div class="font-medium">خرید از فروشگاه (هر آیتمی)</div>
                <div class="text-xs opacity-70">پاداش: ۱۰ XP رایگان + ۱۰ XP پریمیوم</div>
              </div>
              <div class="mission-reward">
                <i class="fas fa-star text-yellow-300"></i>
                <span>۰/۱</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-pass-missions">
        <i class="fas fa-arrow-right"></i> بازگشت
      </button>
    </section>
    
    <!-- REFERRAL -->
    <section id="page-referral" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-user-plus text-blue-300"></i>
          <span>دعوت دوستان و کسب جایزه</span>
        </h3>
        
        <div class="text-center mb-6">
          <div class="text-lg font-bold mb-2">کد دعوت شما</div>
          <div class="referral-code">QUIZ5F8A2B</div>
          <button class="btn btn-primary w-full mt-3" id="btn-copy-referral">
            <i class="fas fa-copy ml-2"></i> کپی کد دعوت
          </button>
        </div>
        
        <div class="mb-6">
          <h4 class="font-bold mb-3 flex items-center gap-2">
            <i class="fas fa-gift text-yellow-300"></i>
            <span>جایزه‌های دعوت</span>
          </h4>
          <div class="space-y-3">
            <div class="referral-tier">
              <div>
                <div class="font-medium">دعوت مستقیم (سطح ۱)</div>
                <div class="text-xs opacity-70">هر دوست: ۵۰ سکه</div>
              </div>
              <div class="text-sm font-bold text-yellow-300">۷ روز اول</div>
            </div>
            <div class="referral-tier">
              <div>
                <div class="font-medium">دعوت غیرمستقیم (سطح ۲)</div>
                <div class="text-xs opacity-70">هر دوست: ۲۰ سکه</div>
              </div>
              <div class="text-sm font-bold text-yellow-300">۷ روز اول</div>
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <h4 class="font-bold mb-3 flex items-center gap-2">
            <i class="fas fa-users text-green-300"></i>
            <span>دوستان دعوت شده</span>
          </h4>
          <div class="space-y-3">
            <div class="glass-dark rounded-2xl p-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img src="https://i.pravatar.cc/50?img=1" class="w-10 h-10 rounded-full border-2 border-white/30" alt="friend">
                <div>
                  <div class="font-bold">سارا اکبری</div>
                  <div class="text-xs opacity-70">۲ روز پیش</div>
                </div>
              </div>
              <div class="text-sm font-bold text-green-300">+۵۰💰</div>
            </div>
            <div class="glass-dark rounded-2xl p-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img src="https://i.pravatar.cc/50?img=2" class="w-10 h-10 rounded-full border-2 border-white/30" alt="friend">
                <div>
                  <div class="font-bold">رضا کریمی</div>
                  <div class="text-xs opacity-70">۵ روز پیش</div>
                </div>
              </div>
              <div class="text-sm font-bold text-green-300">+۵۰💰</div>
            </div>
          </div>
        </div>
        
        <div class="text-center">
          <button class="btn btn-secondary w-full" id="btn-share-referral">
            <i class="fas fa-share-nodes ml-2"></i> اشتراک گذاری لینک دعوت
          </button>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-referral">
        <i class="fas fa-arrow-right"></i> بازگشت
      </button>
    </section>
    
    <!-- SUPPORT & ADVERTISERS -->
    <section id="page-support" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-5 flex items-center gap-2">
          <i class="fas fa-headset text-blue-300"></i>
          <span>پشتیبانی و تبلیغات</span>
        </h3>
        
        <!-- Tabs -->
        <div class="flex justify-between mb-6 bg-white/10 rounded-xl p-1">
          <button class="support-tab flex-1 py-2 px-3 rounded-lg text-center font-medium active" data-tab="support">
            پشتیبانی
          </button>
          <button class="support-tab flex-1 py-2 px-3 rounded-lg text-center font-medium" data-tab="advertiser">
            درخواست تبلیغ
          </button>
        </div>
        
        <!-- Support Content -->
        <div id="support-content" class="tab-content">
          <div class="mb-6">
            <h4 class="font-bold mb-3 flex items-center gap-2">
              <i class="fas fa-ticket-alt text-amber-300"></i>
              <span>ارسال تیکت پشتیبانی</span>
            </h4>
            <form id="support-form" class="space-y-4">
              <div class="form-group">
                <label class="form-label" for="support-name">نام و نام خانوادگی</label>
                <input type="text" id="support-name" class="form-input" placeholder="نام خود را وارد کنید" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="support-mobile">شماره موبایل</label>
                <input type="tel" id="support-mobile" class="form-input" placeholder="۰۹۱۲۳۴۵۶۷۸۹" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="support-message">پیام</label>
                <textarea id="support-message" class="form-textarea" placeholder="مشکل یا پیشنهاد خود را بنویسید..." required></textarea>
              </div>
              <button type="submit" class="btn btn-primary w-full">
                <i class="fas fa-paper-plane ml-2"></i> ارسال تیکت
              </button>
            </form>
          </div>
          
          <div>
            <h4 class="font-bold mb-3 flex items-center gap-2">
              <i class="fas fa-history text-purple-300"></i>
              <span>تیکت‌های من</span>
            </h4>
            <div id="tickets-list" class="space-y-3">
              <div class="ticket-item">
                <div class="flex justify-between items-start mb-1">
                  <div class="font-bold">مشکل در پرداخت</div>
                  <span class="ticket-status status-pending">در حال بررسی</span>
                </div>
                <div class="text-xs opacity-70 mb-2">۱۴۰۲/۰۵/۱۰</div>
                <div class="text-sm">پرداخت انجام شد اما سکه‌ها اضافه نشدند...</div>
              </div>
              <div class="ticket-item">
                <div class="flex justify-between items-start mb-1">
                  <div class="font-bold">پیشنهاد برای سوالات</div>
                  <span class="ticket-status status-closed">بسته شده</span>
                </div>
                <div class="text-xs opacity-70 mb-2">۱۴۰۲/۰۴/۲۵</div>
                <div class="text-sm">پیشنهاد اضافه کردن دسته سوالات جدید...</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Advertiser Content -->
        <div id="advertiser-content" class="tab-content hidden">
          <div class="mb-6 glass rounded-2xl p-6">
            <h4 class="font-bold mb-4 flex items-center gap-2">
              <i class="fas fa-bullhorn text-green-300"></i>
              <span>درخواست تبلیغ</span>
            </h4>
            <form id="advertiser-form" class="space-y-4 advertiser-form">
              <div class="form-group">
                <label class="form-label" for="ad-placement">نوع تبلیغ</label>
                <select id="ad-placement" class="form-input" required>
                  <option value="">انتخاب کنید</option>
                  <option value="banner">بنری</option>
                  <option value="native">همسان</option>
                  <option value="interstitial">میانی</option>
                  <option value="rewarded">ویدیویی</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="ad-budget">بودجه (تومان)</label>
                <input type="number" id="ad-budget" class="form-input" placeholder="مثال: ۵۰۰۰۰۰۰" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="ad-provinces">استان‌های هدف</label>
                <select id="ad-provinces" class="form-input" multiple required>
                  <option value="تهران">تهران</option>
                  <option value="اصفهان">اصفهان</option>
                  <option value="خراسان رضوی">خراسان رضوی</option>
                  <option value="فارس">فارس</option>
                  <option value="کردستان">کردستان</option>
                  <option value="آذربایجان شرقی">آذربایجان شرقی</option>
                  <option value="آذربایجان غربی">آذربایجان غربی</option>
                  <option value="مازندران">مازندران</option>
                  <option value="گیلان">گیلان</option>
                  <option value="خوزستان">خوزستان</option>
                </select>
                <div class="text-xs opacity-70 mt-1">برای انتخاب چند استان، کلید Ctrl را نگه دارید</div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div class="form-group">
                  <label class="form-label" for="ad-start">تاریخ شروع</label>
                  <input type="date" id="ad-start" class="form-input" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="ad-end">تاریخ پایان</label>
                  <input type="date" id="ad-end" class="form-input" required>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label" for="ad-creative">لینک کریتیو</label>
                <input type="url" id="ad-creative" class="form-input" placeholder="https://example.com/ad-image.jpg" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="ad-landing">لینک مقصد</label>
                <input type="url" id="ad-landing" class="form-input" placeholder="https://example.com" required>
              </div>
              <button type="submit" class="btn btn-primary w-full">
                <i class="fas fa-paper-plane ml-2"></i> ارسال درخواست
              </button>
            </form>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition flex items-center justify-center gap-2" id="btn-back-support">
        <i class="fas fa-arrow-right"></i> بازگشت
      </button>
    </section>
  </main>
  
  <!-- Bottom Nav -->
  <nav class="glass safe sticky bottom-0 z-50 w-full shadow-lg">
    <div class="max-w-md mx-auto grid grid-cols-5">
      <button class="py-4 text-center hover:bg-white/10 transition nav-item" data-tab="dashboard" aria-label="خانه">
        <i class="fas fa-home text-xl mb-1"></i>
        <div class="text-xs">خانه</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition nav-item" data-tab="quiz" aria-label="مسابقه">
        <i class="fas fa-gamepad text-xl mb-1"></i>
        <div class="text-xs">مسابقه</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition nav-item" data-tab="leaderboard" aria-label="لیدربورد">
        <i class="fas fa-chart-line text-xl mb-1"></i>
        <div class="text-xs">لیدربورد</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition nav-item" data-tab="shop" aria-label="فروشگاه">
        <i class="fas fa-store text-xl mb-1"></i>
        <div class="text-xs">فروشگاه</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition nav-item" data-tab="support" aria-label="پشتیبانی">
        <i class="fas fa-headset text-xl mb-1"></i>
        <div class="text-xs">پشتیبانی</div>
      </button>
    </div>
  </nav>
  
  <!-- Setup Sheet -->
  <div id="sheet-setup" class="sheet">
    <div class="glass rounded-t-3xl p-5 max-w-md mx-auto">
      <div class="flex items-center justify-between mb-3">
        <div class="text-xl font-extrabold">شروع کوییز</div>
        <button id="setup-close" class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20"><i class="fas fa-times"></i></button>
      </div>
      <div class="grid grid-cols-3 gap-2 mb-4" id="cat-wrap"></div>
      <div class="grid grid-cols-3 gap-2 mb-4" id="diff-wrap"></div>
      <div class="flex items-center justify-between text-sm mb-3 opacity-90">
        <div>تعداد سؤال: <span id="setup-count">۵</span></div>
        <input id="range-count" type="range" min="3" max="12" value="5" class="w-48" aria-label="تعداد سوال">
      </div>
      <button type="button" id="setup-duel" class="duel-entry-card mt-4" aria-label="ورود سریع به نبرد تن‌به‌تن">
        <div class="duel-entry-icon">
          <i class="fas fa-swords"></i>
        </div>
        <div class="duel-entry-content">
          <div class="duel-entry-heading">
            <span class="duel-entry-title">نبرد تن‌به‌تن</span>
            <span class="duel-entry-badge"><i class="fas fa-bolt"></i> رقابت لحظه‌ای</span>
          </div>
          <p class="duel-entry-sub">آماده یک چالش مستقیم هستی؟ بلافاصله وارد اتاق نبرد شو و دوستت را به مبارزه دعوت کن.</p>
        </div>
        <div class="duel-entry-cta">
          <span>ورود</span>
          <i class="fas fa-arrow-left"></i>
        </div>
      </button>
      <button id="setup-start" class="btn btn-primary"><i class="fas fa-play ml-2"></i> شروع</button>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div id="modal-settings" class="modal">
    <div class="glass rounded-3xl p-5 w-full max-w-md">
      <div class="flex items-center justify-between mb-4">
        <div class="text-xl font-extrabold">تنظیمات</div>
        <button class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20" data-close="#modal-settings"><i class="fas fa-times"></i></button>
      </div>
      <div class="space-y-3">
        <label class="flex items-center justify-between">
          <span>صدا</span>
          <input type="checkbox" id="set-sound" class="w-5 h-5 accent-emerald-400">
        </label>
        <label class="flex items-center justify-between">
          <span>لرزش</span>
          <input type="checkbox" id="set-haptics" class="w-5 h-5 accent-emerald-400">
        </label>
        <label class="flex items-center justify-between">
          <span>تم شب (Night)</span>
          <input type="checkbox" id="set-theme" class="w-5 h-5 accent-emerald-400">
        </label>
        <div>
          <label class="flex items-center justify-between">
            <span>غیرفعال کردن درخواست نبرد</span>
            <input type="checkbox" id="set-block-duels" class="w-5 h-5 accent-emerald-400">
          </label>
          <p class="text-xs opacity-70 mt-1 pr-1">با فعال کردن این گزینه، هیچ درخواست نبرد تن‌به‌تن دریافت نخواهید کرد.</p>
        </div>
      </div>
      <div class="divider"></div>
      <button id="btn-clear" class="w-full py-3 rounded-xl bg-white/10 border border-white/20">پاک‌سازی داده‌ها (ریست)</button>
    </div>
  </div>
  
  <!-- Notifications Modal -->
  <div id="modal-notify" class="modal">
    <div class="glass rounded-3xl p-5 w-full max-w-md">
      <div class="flex items-center justify-between mb-4">
        <div class="text-xl font-extrabold">اعلان‌ها</div>
        <button class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20" data-close="#modal-notify"><i class="fas fa-times"></i></button>
      </div>
      <div id="notif-list" class="space-y-3 text-sm"></div>
    </div>
  </div>

  <!-- Province Select Modal -->
  <div id="modal-province-select" class="modal">
    <div class="glass rounded-3xl p-5 w-full max-w-md text-center">
      <div class="text-xl font-extrabold mb-4">انتخاب استان</div>
      <select id="first-province" class="w-full p-3 rounded-xl bg-white/10 border border-white/20 mb-4">
        <option value="" disabled selected>استان خود را انتخاب کنید</option>
      </select>
      <button id="btn-confirm-province" class="btn btn-province">تایید</button>
    </div>
  </div>

  <!-- Province Coming Soon Modal -->
  <div id="modal-province-soon" class="modal">
    <div class="glass rounded-3xl p-5 w-full max-w-md text-center">
      <div class="flex items-center justify-between mb-4">
        <div class="text-xl font-extrabold">مسابقه استانی</div>
        <button class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20" data-close="#modal-province-soon"><i class="fas fa-times"></i></button>
      </div>
      <div class="mb-4">این بخش به زودی فعال می‌شود.</div>
      <button class="btn btn-primary" data-close="#modal-province-soon">باشه</button>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="modal-profile" class="modal">
    <div class="glass rounded-3xl p-5 w-full max-w-md">
      <div class="flex items-center justify-between mb-4">
        <div class="text-xl font-extrabold">ویرایش پروفایل</div>
        <button class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20" data-close="#modal-profile"><i class="fas fa-times"></i></button>
      </div>
      <div class="space-y-3">
        <label class="block text-sm opacity-90">نام</label>
        <input id="inp-name" class="w-full p-3 rounded-xl bg-white/10 border border-white/20" placeholder="نام شما">
        <label class="block text-sm opacity-90">استان</label>
        <select id="sel-province" class="w-full p-3 rounded-xl bg-white/10 border border-white/20" disabled></select>
        <label class="block text-sm opacity-90">گروه شما</label>
        <div id="lbl-group" class="w-full p-3 rounded-xl bg-white/10 border border-white/20"></div>
        <label class="block text-sm opacity-90">عکس پروفایل</label>
        <input id="inp-avatar" type="file" accept="image/*" class="w-full p-3 rounded-xl bg-white/10 border border-white/20">
      </div>
      <div class="divider"></div>
      <button id="btn-save-profile" class="btn btn-primary">ذخیره</button>
    </div>
  </div>
  
  <!-- Transaction Receipt Modal -->
  <div id="modal-receipt" class="modal" aria-modal="true" role="dialog" aria-label="رسید تراکنش">
    <div class="glass rounded-3xl p-5 w-full max-w-md relative">
      <div class="flex items-center justify-between mb-3">
        <div class="text-xl font-extrabold">رسید تراکنش</div>
        <button class="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20" data-close="#modal-receipt"><i class="fas fa-times"></i></button>
      </div>
      <div id="receipt-body" class="space-y-2 text-sm"></div>
      <div class="divider"></div>
      <button class="btn btn-primary" data-close="#modal-receipt">باشه</button>
    </div>
  </div>

  <!-- Payment Confirm Modal -->
<!-- Enhanced Payment Modal -->
<div id="modal-payment" class="payment-modal" aria-modal="true" role="dialog" aria-label="تایید پرداخت">
  <div class="payment-modal-card">
    <div class="payment-header">
      <div class="payment-icon">
        <i class="fas fa-coins"></i>
      </div>
      <h3 class="text-2xl font-extrabold mb-2">تایید خرید سکه</h3>
      <p class="text-sm opacity-80">لطفاً جزئیات خرید را بررسی کنید</p>
    </div>
    
    <div class="payment-details">
      <div class="payment-row">
        <span class="payment-label">بسته انتخابی</span>
        <span class="payment-value" id="payment-package-name">-</span>
      </div>
      <div class="payment-row">
        <span class="payment-label">تعداد سکه</span>
        <span class="payment-value text-yellow-300" id="payment-coins-amount">-</span>
      </div>
      <div class="payment-row">
        <span class="payment-label">قیمت</span>
        <span class="payment-value" id="payment-price">-</span>
      </div>
      <div class="payment-row">
        <span class="payment-label">موجودی کیف پول</span>
        <span class="payment-value" id="payment-wallet-balance">-</span>
      </div>
    </div>
    
    <div class="payment-warning" id="payment-warning">
      <div class="flex items-center gap-2">
        <i class="fas fa-exclamation-triangle text-red-400"></i>
        <span>موجودی کیف پول شما کافی نیست. به درگاه پرداخت هدایت می‌شوید.</span>
      </div>
    </div>
    
    <div class="payment-actions">
      <button class="btn glass-dark border-white/20 flex-1" onclick="closePaymentModal()">
        انصراف
      </button>
      <button id="payment-confirm-btn" class="btn btn-primary flex-1">
        <i class="fas fa-check ml-2"></i>
        تایید و پرداخت
      </button>
    </div>
    
    <div class="payment-success-animation">
      <div class="text-center">
        <i class="fas fa-check-circle text-6xl text-green-400 mb-4"></i>
        <p class="text-xl font-bold">پرداخت موفق!</p>
      </div>
    </div>
  </div>
</div>

  <!-- Interstitial Ad -->
  <div id="modal-interstitial" class="interstitial" aria-modal="true" role="dialog" aria-label="تبلیغ میانی">
    <div class="interstitial-card glass w-full h-full max-w-md max-h-[80vh]">
      <button id="interstitial-close" class="ad-close" aria-label="بستن تبلیغ"><i class="fas fa-times"></i></button>
      <iframe id="interstitial-frame" title="Interstitial Ad" class="w-full h-full" sandbox="allow-scripts allow-same-origin" loading="lazy"></iframe>
    </div>
  </div>
  
  <!-- Rewarded Ad -->
  <div id="modal-rewarded" class="rewarded" aria-modal="true" role="dialog" aria-label="تبلیغ ویدیویی">
    <div class="rewarded-card glass w-full h-full max-w-md max-h-[80vh] relative">
      <button id="rewarded-close" class="ad-close" aria-label="بستن ویدیو"><i class="fas fa-times"></i></button>
      <video id="rewarded-video" class="w-full h-full object-cover" playsinline controls preload="metadata">
        <source src="" type="video/mp4">
      </video>
      <div class="absolute bottom-2 right-2 left-2 flex items-center justify-between">
        <div id="rewarded-countdown" class="chip">در حال بارگذاری...</div>
        <button id="rewarded-claim" class="btn btn-primary w-auto px-4 py-2 disabled:opacity-50" disabled aria-label="دریافت پاداش">دریافت پاداش</button>
      </div>
    </div>
  </div>
  
  <!-- Detail Popup -->
  <div id="detail-popup" class="detail-popup">
    <div class="flex justify-between items-start mb-4">
      <h3 class="text-xl font-extrabold" id="detail-title">جزئیات</h3>
      <button id="detail-close" class="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 transition">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="detail-content" class="space-y-4"></div>
  </div>
  <div id="detail-overlay" class="detail-overlay"></div>
  
  <!-- Confetti -->
  <canvas id="confetti" class="confetti"></canvas>
  
  <script>
  // Anti-cheating: Detect devtools
  (function() {
    const threshold = 160;
    const checkDevTools = () => {
      const widthThreshold = window.outerWidth - window.innerWidth > threshold;
      const heightThreshold = window.outerHeight - window.innerHeight > threshold;
      if (widthThreshold || heightThreshold) {
        alert('لطفاً ابزارهای توسعه‌دهنده را ببندید. تقلب مجاز نیست!');
        window.location.reload();
      }
    };
    setInterval(checkDevTools, 2000);
  })();
  // ===== Helpers =====
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  // Ensure all buttons default to type="button" to avoid unintended form submits
  function ensureButtonType(root=document){
    root.querySelectorAll('button:not([type])').forEach(btn=>btn.type='button');
  }
  ensureButtonType();
  new MutationObserver(m=>{
    m.forEach(mu=>{
      mu.addedNodes.forEach(node=>{
        if(node.nodeType!==Node.ELEMENT_NODE) return;
        if(node.matches && node.matches('button:not([type])')) node.type='button';
        if(node.querySelectorAll) ensureButtonType(node);
      });
    });
  }).observe(document.body,{childList:true,subtree:true});
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const faNum = n => (n===null||n===undefined||Number.isNaN(Number(n))) ? '—' : Number(n).toLocaleString('fa-IR');
  const enNum = n => Number(n).toLocaleString('en-US');
function populateProvinceOptions(selectEl, placeholder){
    if(!selectEl) return;

    // Save the currently selected value if any
    const prevValue = selectEl.value;
    selectEl.innerHTML = '';

    if(placeholder){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = placeholder;
      opt.disabled = true;
      opt.selected = true;
      selectEl.appendChild(opt);
    }

    // Check if provinces exist
    if(!State.provinces || State.provinces.length === 0){
      console.warn('No provinces available to populate');
      return;
    }

    State.provinces
      .slice()
      .sort((a,b)=>a.name.localeCompare(b.name, 'fa'))
      .forEach(p => {
        const option = document.createElement('option');
        option.value = p.name;
        option.textContent = p.name;
        selectEl.appendChild(option);
      });

    // Restore previous selection if it exists
    if(prevValue && Array.from(selectEl.options).some(opt => opt.value === prevValue)){
      selectEl.value = prevValue;
    }
  }





  
  const vibrate = ms => { try{ if(State.settings.haptics && navigator.vibrate) navigator.vibrate(ms) }catch{} };
  const toast = (html, ms=2200) => {
    const t=document.createElement('div');
    t.className='fixed top-20 left-1/2 -translate-x-1/2 glass px-5 py-3 rounded-2xl text-white font-bold z-50 fade-in';
    t.innerHTML=html; document.body.appendChild(t); setTimeout(()=>t.remove(), ms);
  };
  const wait = ms => new Promise(r=>setTimeout(r,ms));
  const online = () => navigator.onLine;
  // Minimal sounds
  const SFX = (()=>{ let ctx; const mk=()=>ctx||(ctx=new (window.AudioContext||window.webkitAudioContext)());
    const beep=(f=880,d=0.12,t='sine')=>{ if(!State.settings.sound) return; const a=mk(); const o=a.createOscillator(); const g=a.createGain();
      o.type=t; o.frequency.value=f; o.connect(g); g.connect(a.destination); g.gain.setValueAtTime(0.001,a.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2,a.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.001,a.currentTime+d);
      o.start(); o.stop(a.currentTime+d+0.02);
    };
    return { correct:()=>{beep(880); setTimeout(()=>beep(1320,0.1,'triangle'),90)}, wrong:()=>beep(160,0.25,'sawtooth'), tick:()=>beep(660,0.05), coin:()=>{beep(1200,0.08); setTimeout(()=>beep(1600,0.08),70)} };
  })();
  function shootConfetti(){
    const canvas = $('#confetti'); const ctx = canvas.getContext('2d');
    const W = canvas.width = innerWidth, H = canvas.height = innerHeight;
    const pieces = Array.from({length: 120}, ()=>({
      x: Math.random()*W, y: -20-Math.random()*H, r: 4+Math.random()*6,
      c: ['#fde047','#fb923c','#a78bfa','#ec4899','#34d399'][Math.floor(Math.random()*5)],
      v: 1+Math.random()*3, a: Math.random()*Math.PI*2
    }));
    let t=0, run=true;
    (function anim(){
      if(!run) return; ctx.clearRect(0,0,W,H);
      for(const p of pieces){
        ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        p.y += p.v; p.x += Math.sin(p.a+t/15); if(p.y>H+10) p.y=-10;
      }
      t++; const id=requestAnimationFrame(anim); setTimeout(()=>{run=false; cancelAnimationFrame(id); ctx.clearRect(0,0,W,H)}, 2200);
    })();
  }
  
  // ===== Remote Config (in-file) =====
// === RemoteConfig (اصلاح‌شده) ===
const RemoteConfig = {
  ab: (Math.random() < 0.5) ? 'A' : 'B',

  provinceTargeting: { enabled: true, allow: ['تهران','کردستان','آذربایجان غربی','اصفهان'] },

  ads: {
    enabled: true,
    placements: { banner:true, native:true, interstitial:true, rewarded:true },
    freqCaps: { interstitialPerSession: 2, rewardedPerSession: 3 },
    interstitialCooldownMs: 60_000,
    rewardedMinWatchMs: 7_000,
    session: { interstitialShown: 0, rewardedShown: 0, lastInterstitialAt: 0 }
  },

  pricing: {
    // نرخ تبدیل دلاری برای مواقعی که priceToman نداشتیم (اختیاری)
    usdToToman: 70_000,

    // ← این بخش به تومان به‌روزرسانی شد
    coins: [
      { id:'c100',  amount:100,  bonus:0,  priceToman: 59_000,   priceCents:199  },
      { id:'c500',  amount:500,  bonus:5,  priceToman: 239_000,  priceCents:799  },
      { id:'c1200', amount:1200, bonus:12, priceToman: 459_000,  priceCents:1499 },
      { id:'c3000', amount:3000, bonus:25, priceToman: 899_000,  priceCents:2999 }
    ],

    vip: {
      lite: { id:'vip_lite', priceCents:299 },
      pro:  { id:'vip_pro',  priceCents:599 }
    },

    // بسته‌های «کلید» (پرداخت با سکهٔ بازی)
    keys: [
      { id:'k1',  amount:1,  priceGame:30  }, // بسته کوچک
      { id:'k3',  amount:3,  priceGame:80  }, // بسته اقتصادی
      { id:'k10', amount:10, priceGame:250 }  // بسته بزرگ
    ]
  },

  abOverrides: {
    A: { ads:{ freqCaps:{ interstitialPerSession:2 } } },
    B: { ads:{ freqCaps:{ interstitialPerSession:1 } } }
  },

  gameLimits: {
    matches: { daily: 5, vipMultiplier: 2, recoveryTime: 2 * 60 * 60 * 1000 }, // 2 hours
    duels:   { daily: 3, vipMultiplier: 2, recoveryTime: 30 * 60 * 1000 },     // 30 minutes
    lives:   { daily: 3, vipMultiplier: 2, recoveryTime: 30 * 60 * 1000 },     // 30 minutes
    groupBattles: { daily: 2, vipMultiplier: 2, recoveryTime: 60 * 60 * 1000 }, // 1 hour
    energy:  { daily: 10, vipMultiplier: 2, recoveryTime: 15 * 60 * 1000 }     // 15 minutes
  }
};



// === Patch ایمن برای RemoteConfig.pricing.keys ===
// اگر keys نباشه/خالی یا نامعتبر باشه، با دیفالت‌ها پر و نرمالایز می‌کنه.
// خروجی: آرایه‌ی keys نهایی (مرتب و سالم)
function patchPricingKeys(RemoteConfig){
  const defaults = [
    { id:'k1',  amount:1,  priceGame:30,  label:'بسته کوچک'     },
    { id:'k3',  amount:3,  priceGame:80,  label:'بسته اقتصادی'   },
    { id:'k10', amount:10, priceGame:250, label:'بسته بزرگ'      }
  ];

  if (!RemoteConfig.pricing) RemoteConfig.pricing = {};

  const packs = RemoteConfig.pricing.keys;
  const bad = (p)=> typeof p?.amount!=='number' || typeof p?.priceGame!=='number' || p.amount<=0 || p.priceGame<=0;

  if (!Array.isArray(packs) || packs.length===0 || packs.some(bad)){
    RemoteConfig.pricing.keys = defaults;
  } else {
    RemoteConfig.pricing.keys = packs
      .map(p => ({
        id: String(p.id || ('k' + p.amount)),
        amount: +p.amount,
        priceGame: +p.priceGame,
        label: p.label || (p.amount<=1 ? 'بسته کوچک' : p.amount<=3 ? 'بسته اقتصادی' : 'بسته بزرگ')
      }))
      .filter(p => p.amount>0 && p.priceGame>0)
      .sort((a,b)=> a.amount - b.amount);
  }

  return RemoteConfig.pricing.keys;
}

// ⚡️ بلافاصله بعد از تعریف RemoteConfig صدا بزن:
patchPricingKeys(RemoteConfig);

  // Merge AB overrides
  (function applyAB(){
    const o = RemoteConfig.abOverrides[RemoteConfig.ab];
    if(!o) return;
    function deepMerge(t,s){ for(const k in s){ if(typeof s[k]==='object'&&s[k]){ t[k]=t[k]||{}; deepMerge(t[k],s[k]); } else { t[k]=s[k]; } } }
    deepMerge(RemoteConfig, o);
  })();
  
  // ===== Analytics =====
  async function logEvent(name, payload={}){
    try{
      await fetch('/api/analytics', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ 
          name, 
          ts: Date.now(), 
          province: Server.user.province,
          vipPlan: Server.subscription.plan,
          vipActive: Server.subscription.active,
          ...payload 
        })
      }).catch(()=>{});
    }catch{}
  }
  
  // ===== Server State (Wallet + Subscription only from server) =====
  const Server = {
    wallet: { coins: null, lastTxnId: null },
    subscription: { active:false, status:'unknown', expiry:null, autoRenew:false, plan:null, tier:null },
    user: { province:'تهران' }, // can be set by your auth bootstrap
    limits: {
      matches: { used: 0, lastReset: 0, lastRecovery: 0 },
      duels: { used: 0, lastReset: 0, lastRecovery: 0 },
      lives: { used: 0, lastReset: 0, lastRecovery: 0 },
      groupBattles: { used: 0, lastReset: 0, lastRecovery: 0 },
      energy: { used: 0, lastReset: 0, lastRecovery: 0 }
    },
    pass: {
      freeXp: 0,
      premiumXp: 0,
      season: 1,
      week: 1,
      missions: {
        daily: [],
        weekly: []
      }
    }
  };
  
  // ===== Network (timeouts + JSON helpers) =====
  const Net = {
    async jget(url, timeoutMs=8000){
      const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, {cache:'no-store', signal:ctrl.signal});
        const txt = await res.text(); if(!txt) return null;
        try{ return JSON.parse(txt); }catch{ return null; }
      }catch{ return null; } finally{ clearTimeout(t); }
    },
    async jpost(url, data, timeoutMs=12000){
      const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data), signal:ctrl.signal});
        const txt = await res.text(); if(!txt) return null;
        try{ return JSON.parse(txt); }catch{ return null; }
      }catch{ return null; } finally{ clearTimeout(t); }
    }
  };
  
  // ===== App State (legacy gameplay remains local) =====
  const STORAGE_KEY='quiz_webapp_pro_state_v2_fa';
  const State = {
    user:{ id:'guest', name:'کاربر مهمان', avatar:'https://i.pravatar.cc/120?img=12', province:'', group:'' },
    score:0, coins:120, lives:3, vip:false, // vip will be overridden by server
    streak:0, lastClaim:0, boostUntil:0,
    theme:'ocean',
    duelOpponent:null,
    duelWins:0,
    duelLosses:0,
    achievements:{ firstWin:false, tenCorrect:false, streak3:false, vipBought:false },
    settings:{ sound:true, haptics:true, blockDuels:false },
    leaderboard:[
      { id:'u1', name:'آرتین', score:18200, province:'تهران', group:'قهرمانان دانش' },
      { id:'u2', name:'سمانه', score:16500, province:'اصفهان', group:'متفکران جوان' },
      { id:'u3', name:'مانی', score:14950, province:'خراسان رضوی', group:'چالش‌برانگیزان' },
      { id:'u4', name:'نیکا', score:13200, province:'فارس', group:'دانش‌آموزان نخبه' },
    ],
    provinces: [], // populated from data/provinces.json
    groups: [
      { id: 'g1', name: 'قهرمانان دانش', score: 22100, members: 23, admin: 'علی رضایی', created: '۱۴۰۲/۰۲/۱۵', memberList: ['علی رضایی','سارا اکبری','رضا کریمی'], matches:[{opponent:'متفکران جوان', time:'۱۴۰۳/۰۵/۲۵ ۱۸:۰۰'}], requests: [] },
      { id: 'g2', name: 'متفکران جوان', score: 19800, members: 18, admin: 'سارا محمدی', created: '۱۴۰۲/۰۳/۲۰', memberList: ['سارا محمدی','مهدی احمدی'], matches:[{opponent:'پیشروان علم', time:'۱۴۰۳/۰۵/۳۰ ۱۹:۰۰'}], requests: [] },
      { id: 'g3', name: 'چالش‌برانگیزان', score: 20500, members: 21, admin: 'رضا قاسمی', created: '۱۴۰۲/۰۱/۱۰', memberList: ['رضا قاسمی'], matches:[], requests: [] },
      { id: 'g4', name: 'دانش‌آموزان نخبه', score: 18700, members: 15, admin: 'مریم احمدی', created: '۱۴۰۲/۰۴/۰۵', memberList: ['مریم احمدی'], matches:[], requests: [] },
      { id: 'g5', name: 'پیشروان علم', score: 21300, members: 27, admin: 'امیر حسینی', created: '۱۴۰۲/۰۲/۲۸', memberList: ['امیر حسینی'], matches:[{opponent:'قهرمانان دانش', time:'۱۴۰۳/۰۶/۰۲ ۲۰:۰۰'}], requests: [] },
    ],
    ads: { banner: [], native: [], interstitial: [], rewarded: [] },
    quiz:{
      inProgress:false, answered:false, correctIndex:-1,
      duration:30, remain:30, timer:null,
      list:[], idx:0, cat:'عمومی', diff:'آسان',
      sessionEarned:0, results:[]
    },
    notifications:[
      { id:'n1', text:'جام هفتگی از ساعت ۲۰:۰۰ شروع می‌شود. آماده‌ای؟', time:'امروز' },
      { id:'n2', text:'بستهٔ سوالات «ادبیات فارسی» اضافه شد!', time:'دیروز' },
      { id:'n3', text:'با دعوت هر دوست ۲۰💰 هدیه بگیر!', time:'۲ روز پیش' }
    ],
    referral: {
      code: 'QUIZ5F8A2B',
      referred: [
        { id: 'u1', name: 'سارا اکبری', date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), reward: 50 },
        { id: 'u2', name: 'رضا کریمی', date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), reward: 50 }
      ]
    }
  };


  // Helper functions for group management
function isUserGroupAdmin() {
  return State.groups.some(g => g.admin === State.user.name);
}

function getUserGroup() {
  return State.groups.find(g => g.memberList?.includes(State.user.name));
}

function isUserInGroup() {
  return !!State.user.group || !!getUserGroup();
}
  
  const cats = ['عمومی','علم','جغرافیای ایران','ادبیات فارسی','تاریخ ایران','سینما و موسیقی ایران','ورزش ایران','تکنولوژی'];
  const diffs = ['آسان','متوسط','سخت'];
  const LIFELINE_COST = 3;
  const TIMER_CIRC = 2 * Math.PI * 64;
  
  function loadState(){ 
    try{ 
      const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); 
      if(s) Object.assign(State,s); 
      
      // Load server state if available
      const serverState = JSON.parse(localStorage.getItem('server_state') || '{}');
      if (serverState.limits) Object.assign(Server.limits, serverState.limits);
      if (!Server.limits.duels) {
        Server.limits.duels = { used: 0, lastReset: 0, lastRecovery: 0 };
      }
      if (serverState.pass) Object.assign(Server.pass, serverState.pass);
    }catch{}
    State.duelOpponent = null;
  }
  
  function saveState(){ 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(State)); 
    localStorage.setItem('server_state', JSON.stringify({
      limits: Server.limits,
      pass: Server.pass
    }));
  }
  
  loadState();
  document.documentElement.setAttribute('data-theme', State.theme || 'ocean');

  const qs = new URLSearchParams(location.search);
  const duelInviter = qs.get('duel_invite');
  if(duelInviter && !State.settings.blockDuels){
    toast(`${duelInviter} شما را به نبرد دعوت کرده است!`);
  }

  // Telegram WebApp (optional)
  try{
    if(window.Telegram && Telegram.WebApp){
      Telegram.WebApp.ready();
      const u = Telegram.WebApp.initDataUnsafe?.user;
      if(u){
        State.user.id = String(u.id);
        State.user.name = [u.first_name,u.last_name].filter(Boolean).join(' ');
        if(u.username) State.user.name += ` (@${u.username})`;
      }
    }
    }catch{}

    (function setupProvinceSelect(){
    // 1) اگر خالی بود، استان‌ها را مقداردهی کن
    function bootstrapProvinces(){
      const NAMES = [
        "آذربایجان شرقی","آذربایجان غربی","اردبیل","اصفهان","البرز","ایلام","بوشهر","تهران",
        "چهارمحال و بختیاری","خراسان جنوبی","خراسان رضوی","خراسان شمالی","خوزستان","زنجان","سمنان",
        "سیستان و بلوچستان","فارس","قزوین","قم","کردستان","کرمان","کرمانشاه","کهگیلویه و بویراحمد",
        "گلستان","گیلان","لرستان","مازندران","مرکزی","هرمزگان","همدان","یزد"
      ];
      if (!Array.isArray(State.provinces) || State.provinces.length !== NAMES.length) {
        State.provinces = NAMES.map(n => ({ name:n, score:0, members:0, region:'' }));
      }
    }

    function openModal(sel){ document.querySelector(sel).classList.add('show'); }
    function closeModal(sel){ document.querySelector(sel).classList.remove('show'); }

    function fillAllProvinceSelects(){
      bootstrapProvinces();
      populateProvinceOptions(document.getElementById('first-province'), 'استان خود را انتخاب کنید');
      const editSel = document.getElementById('sel-province');
      populateProvinceOptions(editSel);
      if (editSel) editSel.value = State.user.province || '';
    }

    // 2) پر کردن سلکت‌ها در شروع
    fillAllProvinceSelects();

    // 3) اگر کاربر هنوز استان ندارد، مودال را باز کن
    if (!State.user.province) {
      openModal('#modal-province-select');
      setTimeout(()=>document.getElementById('first-province')?.focus(), 50);
    }

    // 4) دکمهٔ تایید استان
    document.getElementById('btn-confirm-province')?.addEventListener('click', () => {
      const sel = document.getElementById('first-province');
      const val = sel?.value || '';
      if (!val) { toast('لطفاً یک استان انتخاب کن'); return; }
      State.user.province = val;
      saveState();
      renderHeader();
      renderDashboard();
      closeModal('#modal-province-select');
      toast('استان شما ذخیره شد');
    });

    // 5) هنگام باز کردن «ویرایش پروفایل» مطمئن شو لیست به‌روز است
    document.getElementById('btn-edit-profile')?.addEventListener('click', () => {
      fillAllProvinceSelects();
      openModal('#modal-profile');
    });
  })();

    // ===== Question Bank (تماماً فارسی) =====
    const qBank = [
      { q:'پایتخت ایران چیست؟', c:['تهران','اصفهان','شیراز','تبریز'], a:0, cat:'جغرافیای ایران', diff:'آسان' },
    { q:'مرتفع‌ترین کوه ایران کدام است؟', c:['سبلان','زاگرس','دماوند','تفتان'], a:2, cat:'جغرافیای ایران', diff:'آسان' },
    { q:'دریاچهٔ ارومیه در کدام استان‌ها قرار دارد؟', c:['آذربایجان شرقی و غربی','کردستان و همدان','خراسان رضوی و شمالی','فارس و بوشهر'], a:0, cat:'جغرافیای ایران', diff:'متوسط' },
    { q:'رود کارون عمدتاً در کدام استان جریان دارد؟', c:['خوزستان','هرمزگان','سیستان و بلوچستان','گیلان'], a:0, cat:'جغرافیای ایران', diff:'آسان' },
    { q:'سی‌وسه‌پل در کدام شهر است؟', c:['شیراز','تبریز','اصفهان','کرمان'], a:2, cat:'جغرافیای ایران', diff:'آسان' },
    { q:'شاهنامه اثر کیست؟', c:['حافظ','سعدی','مولوی','فردوسی'], a:3, cat:'ادبیات فارسی', diff:'آسان' },
    { q:'تخلص خواجه شمس‌الدین محمد چیست؟', c:['سنایی','حافظ','خیام','جامی'], a:1, cat:'ادبیات فارسی', diff:'آسان' },
    { q:'کتاب «گلستان» را چه کسی نوشته است؟', c:['نظامی','سعدی','عطار','مولوی'], a:1, cat:'ادبیات فارسی', diff:'آسان' },
    { q:'مصراع «بنی‌آدم اعضای یک پیکرند» از کیست؟', c:['حافظ','سعدی','فردوسی','نظامی'], a:1, cat:'ادبیات فارسی', diff:'آسان' },
    { q:'کدام شاعر به رباعی‌سرایی مشهور است؟', c:['خیام','حافظ','مولوی','صائب'], a:0, cat:'ادبیات فارسی', diff:'متوسط' },
    { q:'بنیان‌گذار هخامنشیان چه کسی بود؟', c:['داریوش بزرگ','کمبوجیه','کوروش بزرگ','خشایارشاه'], a:2, cat:'تاریخ ایران', diff:'متوسط' },
    { q:'نوروز در تقویم جلالی برابر است با روزِ ...', c:['اول اردیبهشت','اول فروردین','سی‌ام اسفند','پانزدهم فروردین'], a:1, cat:'تاریخ ایران', diff:'آسان' },
    { q:'نادرشاه افشار در کدام قرن حکمرانی کرد؟', c:['نهم هجری','یازدهم هجری','دوازدهم هجری','سیزدهم هجری'], a:2, cat:'تاریخ ایران', diff:'متوسط' },
    { q:'اولین اسکار سینمای ایران برای کدام فیلم بود؟', c:['جدایی نادر از سیمین','فروشنده','طعم گیلاس','بچه‌های آسمان'], a:0, cat:'سینما و موسیقی ایران', diff:'متوسط' },
    { q:'کارگردان فیلم «فروشنده» کیست؟', c:['اصغر فرهادی','مجید مجیدی','عباس کیارستمی','رخشان بنی‌اعتماد'], a:0, cat:'سینما و موسیقی ایران', diff:'آسان' },
    { q:'ساز «تار» جزو کدام دسته است؟', c:['سازهای بادی','سازهای زهی مضرابی','سازهای کوبه‌ای','الکترونیک'], a:1, cat:'سینما و موسیقی ایران', diff:'متوسط' },
    { q:'دربی مشهور تهران بین کدام تیم‌هاست؟', c:['سپاهان و ذوب‌آهن','تراکتور و ماشین‌سازی','پرسپولیس و استقلال','ملوان و ملوان نوین'], a:2, cat:'ورزش ایران', diff:'آسان' },
    { q:'ایران چند بار قهرمان جام ملت‌های آسیا شده است؟', c:['دو بار','سه بار','چهار بار','یک بار'], a:1, cat:'ورزش ایران', diff:'متوسط' },
    { q:'قهرمان نامدار کشتی آزاد با لقب «پلنگ» کیست؟', c:['حسان یزدانی','علیرضا دبیر','رسول خادم','عباس جدیدی'], a:0, cat:'ورزش ایران', diff:'آسان' },
    { q:'واحد رسمی پول ایران چیست؟', c:['تومان','ریال','درهم','منات'], a:1, cat:'عمومی', diff:'آسان' },
    { q:'کد پستی ایران چند رقمی است؟', c:['۸','۹','۱۰','۱۲'], a:2, cat:'عمومی', diff:'آسان' },
    { q:'عنصر با نماد Au کدام است؟', c:['نقره','آلومینیوم','طلا','آرگون'], a:2, cat:'علم', diff:'آسان' },
    { q:'قانون دوم نیوتن؟', c:['F=ma','E=mc²','V=IR','pV=nRT'], a:0, cat:'علم', diff:'آسان' },
    { q:'نور در خلأ تقریباً با چه سرعتی حرکت می‌کند؟', c:['۳۰۰ کیلومتر/ثانیه','۳٬۰۰۰ کیلومتر/ثانیه','۳۰۰٬۰۰۰ کیلومتر/ثانیه','۳٬۰۰۰٬۰۰۰ کیلومتر/ثانیه'], a:2, cat:'علم', diff:'متوسط' },
    { q:'زبانِ اجراشونده در مرورگر وب؟', c:['پایتون','جاوااسکریپت','جاوا','C#'], a:1, cat:'تکنولوژی', diff:'آسان' },
    { q:'ابزار رایجِ کنترل نسخهٔ کد؟', c:['Docker','Git','NPM','Webpack'], a:1, cat:'تکنولوژی', diff:'متوسط' },
    { q:'عدد پی (π) تقریباً برابر است با ...', c:['۲٫۷','۳٫۱۴','۳٫۴۱','۲٫۱۴'], a:1, cat:'عمومی', diff:'آسان' },
    { q:'پایتخت ژاپن کدام است؟', c:['اوساکا','توکیو','کیوتو','ساپورو'], a:1, cat:'عمومی', diff:'آسان' },
    { q:'پایتخت کانادا کدام است؟', c:['تورنتو','اوتاوا','مونترال','ونکوور'], a:1, cat:'عمومی', diff:'متوسط' },
    { q:'کدام سبک هنری به پیکاسو نسبت داده می‌شود؟', c:['رمانتیسم','امپرسیونیسم','کوبیسم','رئالیسم'], a:2, cat:'عمومی', diff:'متوسط' },
    { q:'اثر «شبِ پرستاره» اثر کیست؟', c:['پیکاسو','ون‌گوگ','مونک','داوینچی'], a:1, cat:'عمومی', diff:'متوسط' },
    { q:'فاصلهٔ نقطهٔ پنالتی تا دروازه در فوتبال؟', c:['۱۰ متر','۱۱ متر','۱۲ متر','۹ متر'], a:1, cat:'عمومی', diff:'آسان' }
  ];
  
  // ===== Game Limits Management =====
  function checkDailyReset() {
    const now = Date.now();
    const today = new Date(now);
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    // Check if we need to reset daily limits
    if (Server.limits.matches.lastReset < today.getTime()) {
      Server.limits.matches.used = 0;
      Server.limits.matches.lastReset = today.getTime();
    }

    if (Server.limits.duels.lastReset < today.getTime()) {
      Server.limits.duels.used = 0;
      Server.limits.duels.lastReset = today.getTime();
    }

    if (Server.limits.lives.lastReset < today.getTime()) {
      Server.limits.lives.used = 0;
      Server.limits.lives.lastReset = today.getTime();
    }

    if (Server.limits.groupBattles.lastReset < today.getTime()) {
      Server.limits.groupBattles.used = 0;
      Server.limits.groupBattles.lastReset = today.getTime();
    }

    if (Server.limits.energy.lastReset < today.getTime()) {
      Server.limits.energy.used = 0;
      Server.limits.energy.lastReset = today.getTime();
    }
    
    // Update UI
    updateLimitsUI();
    
    // Update daily reset timer
    updateDailyResetTimer(tomorrow.getTime() - now);
    
    // Check recovery timers
    updateRecoveryTimers();
    
    // Check if any limit is reached
    checkLimitsReached();
  }
  
  function updateLimitsUI() {
    const vipMultiplier = Server.subscription.active ? 
      (Server.subscription.tier === 'pro' ? 3 : 2) : 1;
    
    // Matches
    const matchesLimit = RemoteConfig.gameLimits.matches.daily * vipMultiplier;
    const matchesUsed = Server.limits.matches.used;
    const matchesPct = Math.min(100, (matchesUsed / matchesLimit) * 100);
    $('#matches-used').textContent = faNum(matchesUsed);
    $('#matches-limit').textContent = faNum(matchesLimit);
    $('#matches-progress').style.width = `${matchesPct}%`;
    
    // Duels
    const duelsLimit = RemoteConfig.gameLimits.duels.daily * vipMultiplier;
    const duelsUsed = Server.limits.duels.used;
    const duelsPct = Math.min(100, (duelsUsed / duelsLimit) * 100);
    $('#duels-used').textContent = faNum(duelsUsed);
    $('#duels-limit').textContent = faNum(duelsLimit);
    $('#duels-progress').style.width = `${duelsPct}%`;
    const duelRemainingEl = $('#duel-limit-remaining');
    const duelTotalEl = $('#duel-limit-total');
    if (duelRemainingEl && duelTotalEl) {
      duelRemainingEl.textContent = faNum(Math.max(duelsLimit - duelsUsed, 0));
      duelTotalEl.textContent = faNum(duelsLimit);
    }

    // Group Battles
    const groupLimit = RemoteConfig.gameLimits.groupBattles.daily * vipMultiplier;
    const groupUsed = Server.limits.groupBattles.used;
    const groupPct = Math.min(100, (groupUsed / groupLimit) * 100);
    $('#group-battles-used').textContent = faNum(groupUsed);
    $('#group-battles-limit').textContent = faNum(groupLimit);
    $('#group-battles-progress').style.width = `${groupPct}%`;

    // Energy (UI elements may be absent)
    const energyUsedEl = $('#energy-used');
    const energyLimitEl = $('#energy-limit');
    const energyProgEl = $('#energy-progress');
    if (energyUsedEl && energyLimitEl && energyProgEl) {
      const energyLimit = RemoteConfig.gameLimits.energy.daily * vipMultiplier;
      const energyUsed = Server.limits.energy.used;
      const energyPct = Math.min(100, (energyUsed / energyLimit) * 100);
      energyUsedEl.textContent = faNum(energyUsed);
      energyLimitEl.textContent = faNum(energyLimit);
      energyProgEl.style.width = `${energyPct}%`;
    }
  }
  
  function updateDailyResetTimer(msUntilReset) {
    const hours = Math.floor(msUntilReset / (1000 * 60 * 60));
    const minutes = Math.floor((msUntilReset % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((msUntilReset % (1000 * 60)) / 1000);
    
    $('#daily-reset-timer').textContent = `ریست در ${faNum(hours)}:${faNum(minutes).padStart(2, '0')}:${faNum(seconds).padStart(2, '0')}`;
  }
  
  function updateRecoveryTimers() {
    const now = Date.now();

    // Energy recovery
    const energyTimer = $('#energy-recovery-timer');
    if (energyTimer) {
      if (Server.limits.energy.used > 0) {
        const energyRecoveryTime = RemoteConfig.gameLimits.energy.recoveryTime;
        const timeUntilEnergyRecovery = energyRecoveryTime - (now - Server.limits.energy.lastRecovery);

        if (timeUntilEnergyRecovery > 0) {
          const minutes = Math.floor(timeUntilEnergyRecovery / (1000 * 60));
          const seconds = Math.floor((timeUntilEnergyRecovery % (1000 * 60)) / 1000);
          energyTimer.textContent = `بازیابی بعدی: ${faNum(minutes)}:${faNum(seconds).padStart(2, '0')}`;
        } else {
          energyTimer.textContent = 'بازیابی بعدی: اکنون';
        }
      } else {
        energyTimer.textContent = 'بازیابی بعدی: --:--';
      }
    }
  }
  
  function checkLimitsReached() {
    const vipMultiplier = Server.subscription.active ? 
      (Server.subscription.tier === 'pro' ? 3 : 2) : 1;
    
    const matchesLimit = RemoteConfig.gameLimits.matches.daily * vipMultiplier;
    const duelsLimit = RemoteConfig.gameLimits.duels.daily * vipMultiplier;
    const groupLimit = RemoteConfig.gameLimits.groupBattles.daily * vipMultiplier;

    const matchesReached = Server.limits.matches.used >= matchesLimit;
    const duelsReached = Server.limits.duels.used >= duelsLimit;
    const groupReached = Server.limits.groupBattles.used >= groupLimit;
    const energyLimit = RemoteConfig.gameLimits.energy.daily * vipMultiplier;
    const energyReached = $('#energy-used') ? Server.limits.energy.used >= energyLimit : false;

    // Show/hide limit reached CTAs
    $('#limit-reached-ctas').classList.toggle('hidden', !(matchesReached || duelsReached || groupReached || energyReached));

    
    // Log analytics if limit reached
    if (matchesReached && !State.limitsLogged?.matches) {
      logEvent('limit_reached', { type: 'matches', limit: matchesLimit });
      State.limitsLogged = State.limitsLogged || {};
      State.limitsLogged.matches = true;
    }
    
    if (duelsReached && !State.limitsLogged?.duels) {
      logEvent('limit_reached', { type: 'duels', limit: duelsLimit });
      State.limitsLogged = State.limitsLogged || {};
      State.limitsLogged.duels = true;
    }

    if (groupReached && !State.limitsLogged?.groupBattles) {
      logEvent('limit_reached', { type: 'groupBattles', limit: groupLimit });
      State.limitsLogged = State.limitsLogged || {};
      State.limitsLogged.groupBattles = true;
    }
    
    if (energyReached && !State.limitsLogged?.energy) {
      logEvent('limit_reached', { type: 'energy', limit: energyLimit });
      State.limitsLogged = State.limitsLogged || {};
      State.limitsLogged.energy = true;
    }
  }

  function useGameResource(type) {
    if (type === 'energy') return true;
    const now = Date.now();

    // Check if we can use the resource
    const vipMultiplier = Server.subscription.active ?
      (Server.subscription.tier === 'pro' ? 3 : 2) : 1;

    const limit = RemoteConfig.gameLimits[type].daily * vipMultiplier;

    if (Server.limits[type].used >= limit) {
      return false;
    }

    // Use the resource
    Server.limits[type].used++;
    Server.limits[type].lastRecovery = now;

    // Update UI
    updateLimitsUI();
    checkLimitsReached();

    // Save state
    saveState();

    return true;
  }

  function recoverGameResource(type) {
    if (type === 'energy') return false;
    const now = Date.now();

    // Check if we can recover
    if (Server.limits[type].used <= 0) {
      return false;
    }

    // Check recovery time
    const recoveryTime = RemoteConfig.gameLimits[type].recoveryTime;
    const timeSinceLastRecovery = now - Server.limits[type].lastRecovery;

    if (timeSinceLastRecovery < recoveryTime) {
      return false;
    }

    // Recover the resource
    Server.limits[type].used--;
    Server.limits[type].lastRecovery = now;

    // Update UI
    updateLimitsUI();
    checkLimitsReached();

    // Save state
    saveState();

    return true;
  }
  
  // ===== Rendering (legacy + wallet/sub from server) =====
  function renderHeader(){
    $('#hdr-name').textContent = State.user.name;
    $('#hdr-score').textContent = faNum(State.score);
    $('#hdr-gcoins').textContent = faNum(State.coins);
    $('#hdr-avatar').src = State.user.avatar;
    
    // Apply province frame if user has it
    if (Server.pass.provinceFrame) {
      $('#hdr-avatar').classList.add('province-frame');
    } else {
      $('#hdr-avatar').classList.remove('province-frame');
    }
    
    // Apply VIP frame if user is VIP
    if (Server.subscription.active) {
      $('#hdr-avatar').classList.add('vip-frame');
    } else {
      $('#hdr-avatar').classList.remove('vip-frame');
    }
    
    // server numbers:
    $('#hdr-wallet').textContent = (Server.wallet.coins==null?'—':faNum(Server.wallet.coins));
    const vip = Server.subscription.active===true;
    $('#vip-badge').classList.toggle('hidden', !vip);
  }
  
  function renderDashboard(){
    $('#profile-name').textContent = State.user.name;
    $('#profile-avatar').src = State.user.avatar;
    
    // Apply frames
    if (Server.pass.provinceFrame) {
      $('#profile-avatar').classList.add('province-frame');
    } else {
      $('#profile-avatar').classList.remove('province-frame');
    }
    
    if (Server.subscription.active) {
      $('#profile-avatar').classList.add('vip-frame');
    } else {
      $('#profile-avatar').classList.remove('vip-frame');
    }
    
    $('#stat-score').textContent = faNum(State.score);
    $('#stat-coins').textContent = faNum(State.coins);
    $('#stat-lives').textContent = faNum(State.lives);
    $('#vip-chip').classList.toggle('hidden', !Server.subscription.active);
    $('#streak').textContent = faNum(State.streak);
    $('#stat-wallet').textContent = (Server.wallet.coins==null?'—':faNum(Server.wallet.coins));
    const pct = clamp((State.streak%7)/7*100,0,100);
    $('#streak-bar').style.width = pct + '%';
    
    // Top provinces and rank
    const provincesSorted = [...State.provinces].sort((a,b)=>b.score-a.score);
    const topWrap = $('#province-top');
    if(topWrap){
      topWrap.innerHTML = provincesSorted.slice(0,2).map((p,i)=>{
        let badgeClass = 'bg-white/20';
        if(i===0) badgeClass = 'bg-gradient-to-br from-yellow-200 to-yellow-400 text-gray-900';
        else if(i===1) badgeClass = 'bg-gradient-to-br from-gray-300 to-gray-400 text-gray-900';
        return `
        <div class="glass rounded-xl p-3 flex flex-col items-center text-center card-hover">
          <span class="rank-badge ${badgeClass} mb-2">${faNum(i+1)}</span>
          <div class="font-bold">${p.name}</div>
          <div class="text-xs opacity-80 mt-1">${faNum(p.score)} امتیاز</div>
        </div>`;}).join('');
    }

    const myProvRankEl = $('#my-province-rank');
    const userProvince = State.user.province;
    const myProvIdx = provincesSorted.findIndex(p=>p.name===userProvince);
    if(myProvRankEl){
      if(userProvince){
        myProvRankEl.innerHTML = `<span class="chip"><i class="fas fa-flag text-green-300 ml-1"></i> رتبه استان شما: ${faNum(myProvIdx+1)}</span>`;
      }else{
        myProvRankEl.innerHTML = '<span class="chip">استان شما تعیین نشده</span>';
      }
    }

    // rank
    const me = { id: State.user.id, score: State.score, province: State.user.province };
    const arr = [...State.leaderboard.filter(x=>x.id!==me.id), {id:me.id,name:State.user.name,score:me.score,province:me.province}].sort((a,b)=>b.score-a.score);
    const countryIdx = arr.findIndex(x=>x.id===me.id);
    $('#rank-country').textContent = countryIdx>=0 ? faNum(countryIdx+1) : '—';

    const provArr = arr.filter(x=>x.province===me.province);
    const provIdx = provArr.findIndex(x=>x.id===me.id);
    $('#rank-province').textContent = provIdx>=0 ? faNum(provIdx+1) : '—';
    $('#user-province').textContent = me.province || '—';
    const userGroupObj = getUserGroup();
    const groupName = userGroupObj?.name || State.user.group || '';
    const hasGroup = !!groupName;
    $('#user-group').textContent = hasGroup ? groupName : 'بدون گروه';
    $('#user-group-empty-hint')?.classList.toggle('hidden', hasGroup);
    const groupCard = $('#btn-view-group');
    if(groupCard){
      groupCard.dataset.empty = hasGroup ? 'false' : 'true';
      const groupIcon = groupCard.querySelector('.location-icon i');
      if(groupIcon){
        groupIcon.classList.toggle('fa-users', hasGroup);
        groupIcon.classList.toggle('fa-user-plus', !hasGroup);
      }
    }
    $('#no-group-hint')?.classList.toggle('hidden', hasGroup);
    $('#duel-wins').textContent = faNum(State.duelWins);
    $('#duel-losses').textContent = faNum(State.duelLosses);

    // Update limits UI
    updateLimitsUI();
  }
  
  function renderTopBars(){
    $('#lives').textContent = faNum(State.lives);
    $('#coins').textContent = faNum(State.coins);
    updateLifelineStates();
  }

  function animateKeyChip(){
    const chip = $('#lives')?.closest('.chip');
    if(!chip) return;
    chip.classList.remove('attention');
    void chip.offsetWidth;
    chip.classList.add('attention');
    setTimeout(()=>chip.classList.remove('attention'), 650);
  }

  function updateLifelineStates(){
    const hasKeys = State.lives >= LIFELINE_COST;
    ['life-5050','life-skip','life-pause'].forEach(id=>{
      const btn = $('#'+id);
      if(!btn) return;
      if(btn.disabled){
        btn.dataset.insufficient = 'false';
        const costEl = btn.querySelector('.lifeline-cost');
        if(costEl) costEl.classList.remove('not-enough');
        return;
      }
      btn.dataset.insufficient = hasKeys ? 'false' : 'true';
      const costEl = btn.querySelector('.lifeline-cost');
      if(costEl) costEl.classList.toggle('not-enough', !hasKeys);
    });
  }

  function spendLifelineCost(){
    if(State.lives < LIFELINE_COST){
      toast(`برای استفاده از این قابلیت به ${faNum(LIFELINE_COST)} کلید نیاز داری`);
      animateKeyChip();
      return false;
    }
    State.lives -= LIFELINE_COST;
    renderTopBars();
    saveState();
    animateKeyChip();
    return true;
  }

  function markLifelineUsed(id){
    const btn = typeof id === 'string' ? $('#'+id) : id;
    if(!btn) return;
    btn.disabled = true;
    btn.dataset.used = 'true';
    btn.dataset.insufficient = 'false';
    const costEl = btn.querySelector('.lifeline-cost');
    if(costEl){
      costEl.classList.remove('not-enough');
      costEl.classList.add('hidden');
    }
    const statusEl = btn.querySelector('.lifeline-status');
    if(statusEl) statusEl.classList.remove('hidden');
    updateLifelineStates();
  }

  function resetLifelinesUI(){
    ['life-5050','life-skip','life-pause'].forEach(id=>{
      const btn = $('#'+id);
      if(!btn) return;
      btn.disabled = false;
      btn.dataset.used = 'false';
      btn.dataset.insufficient = 'false';
      const costEl = btn.querySelector('.lifeline-cost');
      if(costEl){
        costEl.classList.remove('hidden','not-enough');
      }
      const statusEl = btn.querySelector('.lifeline-status');
      if(statusEl){
        statusEl.classList.add('hidden');
      }
    });
    updateLifelineStates();
  }

  updateLifelineStates();
  
  function navTo(page){
    ['dashboard','quiz','leaderboard','shop','wallet','vip','results','duel','province','group','pass-missions','referral','support'].forEach(p=>$('#page-'+p)?.classList.add('hidden'));
    $('#page-'+page)?.classList.remove('hidden'); $('#page-'+page)?.classList.add('fade-in');
    $$('nav [data-tab]').forEach(b=>{ b.classList.toggle('bg-white/10', b.dataset.tab===page); b.classList.toggle('active', b.dataset.tab===page); });
    if(page==='dashboard') { renderDashboard(); AdManager.renderNative('#ad-native-dashboard'); }
    if(page==='leaderboard'){ renderLeaderboard(); AdManager.renderNative('#ad-native-lb'); }
    if(page==='wallet'){ buildPackages(); }
    if(page==='vip'){ updateVipUI(); }
  }
  
  // ===== Leaderboard / Details (unchanged + detail popups) =====
  function renderLeaderboard(){
    const me = { id: State.user.id, name: State.user.name, score: State.score };
    const arr = [...State.leaderboard.filter(x=>x.id!==me.id), me].sort((a,b)=>b.score-a.score).slice(0,50);
    const wrap = $('#lb-list'); wrap.innerHTML='';
    arr.forEach((u,i)=>{
      const row=document.createElement('div');
      row.className='flex items-center justify-between bg-white/10 border border-white/20 rounded-xl px-4 py-3 card-hover';
      const rank=i+1;
      let badgeClass='bg-white/20';
      if(rank===1) badgeClass='bg-gradient-to-br from-yellow-200 to-yellow-400 text-gray-900';
      else if(rank===2) badgeClass='bg-gradient-to-br from-gray-300 to-gray-400 text-gray-900';
      else if(rank===3) badgeClass='bg-gradient-to-br from-amber-600 to-amber-700 text-gray-900';
      const rankBadge=`<span class="rank-badge ${badgeClass}">${faNum(rank)}</span>`;
      row.innerHTML=`<div class="flex items-center gap-3">${rankBadge}
        <div><div class="font-bold">${u.name}</div>
        <div class="text-xs opacity-80 flex items-center gap-1"><i class="fas fa-star text-yellow-300"></i><span>${faNum(u.score)}</span></div></div></div>`;
      row.addEventListener('click', () => showUserDetail({...u, nationalRank:rank}));
      wrap.appendChild(row);
    });
    
    // provinces
    const provinceList = $('#province-list'); provinceList.innerHTML='';
    const provincesSorted = [...State.provinces].sort((a,b)=>b.score-a.score);
    provincesSorted.forEach((p,i)=>{
      const row=document.createElement('div');
      row.className='location-card';
      const rank=i+1;
      let badgeClass='bg-white/20';
      if(rank===1) badgeClass='bg-gradient-to-br from-yellow-200 to-yellow-400 text-gray-900';
      else if(rank===2) badgeClass='bg-gradient-to-br from-gray-300 to-gray-400 text-gray-900';
      else if(rank===3) badgeClass='bg-gradient-to-br from-amber-600 to-amber-700 text-gray-900';
      row.innerHTML=`<span class="rank-badge ${badgeClass}">${faNum(rank)}</span>
        <div class="location-icon province-icon"><i class="fas fa-map-marked-alt"></i></div>
        <div class="flex-1"><div class="font-bold">${p.name}</div>
        <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-users"></i><span>${faNum(p.members)} شرکت‌کننده</span></div></div>
        <div class="text-sm font-bold text-green-300"><i class="fas fa-trophy"></i> ${faNum(p.score)}</div>`;
      if(p.name===State.user.province){
        row.classList.add('ring-2','ring-green-300');
        setTimeout(()=>row.scrollIntoView({behavior:'smooth',block:'center'}),0);
      }
      row.addEventListener('click', () => showProvinceDetail({...p, rank}));
      provinceList.appendChild(row);
    });

    const myProvRankElLb = $('#my-province-rank-lb');
    if(myProvRankElLb){
      const myProvIdx = provincesSorted.findIndex(p=>p.name===State.user.province);
      if(State.user.province && myProvIdx !== -1){
        myProvRankElLb.innerHTML = `<span class="chip"><i class="fas fa-flag text-green-300 ml-1"></i> رتبه استان شما: ${faNum(myProvIdx+1)}</span>`;
      }else{
        myProvRankElLb.innerHTML = '<span class="chip">استان شما تعیین نشده</span>';
      }
    }
    
    // groups
    const groupList = $('#group-list'); groupList.innerHTML='';
    State.groups.sort((a,b)=>b.score-a.score).forEach((g,i)=>{
      const row=document.createElement('div');
      row.className='location-card';
      const rank=i+1;
        let badgeClass='bg-white/20';
        if(rank===1) badgeClass='bg-gradient-to-br from-yellow-200 to-yellow-400 text-gray-900';
        else if(rank===2) badgeClass='bg-gradient-to-br from-gray-300 to-gray-400 text-gray-900';
        else if(rank===3) badgeClass='bg-gradient-to-br from-amber-600 to-amber-700 text-gray-900';
        row.innerHTML=`<span class="rank-badge ${badgeClass}">${faNum(rank)}</span>
        <div class="location-icon group-icon"><i class="fas fa-users"></i></div>
        <div class="flex-1"><div class="font-bold">${g.name}</div>
        <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-user"></i><span>مدیر: ${g.admin}</span></div></div>
        <div class="text-sm font-bold text-purple-300"><i class="fas fa-trophy"></i> ${faNum(g.score)}</div>`;
      row.addEventListener('click', () => showGroupDetail({...g, rank}));
      groupList.appendChild(row);
    });
  }
  
  function showDetailPopup(title, content) { 
    $('#detail-title').textContent = title; 
    $('#detail-content').innerHTML = content; 
    $('#detail-popup').classList.add('show'); 
    $('#detail-overlay').classList.add('show'); 
  }
  
  function closeDetailPopup() { 
    $('#detail-popup').classList.remove('show'); 
    $('#detail-overlay').classList.remove('show'); 
  }
  
  function showUserDetail(user) {
    const currentGroupName = getUserGroup()?.name || State.user.group || '';
    const all = [...State.leaderboard, { id: State.user.id, name: State.user.name, score: State.score, province: State.user.province, group: currentGroupName }].sort((a,b)=>b.score-a.score);
    const nationalRank = user.nationalRank || (all.findIndex(x => x.id === user.id) + 1);
    const provinceRank = all.filter(x => x.province === user.province).sort((a,b)=>b.score-a.score).findIndex(x => x.id === user.id) + 1;
    const content = `
      <div class="flex flex-col items-center mb-4">
        <img src="${user.avatar || `https://i.pravatar.cc/120?u=${encodeURIComponent(user.name)}`}" class="w-20 h-20 rounded-full border-4 border-white/30 shadow-lg mb-3" alt="avatar">
        <h4 class="text-xl font-bold">${user.name}</h4>
        <div class="text-sm opacity-80 mt-1">کاربر فعال</div>
      </div>
      <div class="space-y-3">
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-star text-yellow-300"></i>امتیاز کل</span><span class="font-bold text-yellow-300">${faNum(user.score)}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-map-marker-alt text-pink-400"></i>استان</span><span class="font-bold">${user.province || '—'}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-users text-blue-300"></i>گروه</span><span class="font-bold">${user.group || '—'}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-globe text-yellow-300"></i>رتبه کشوری</span><span class="font-bold text-yellow-300">${faNum(nationalRank)}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-flag text-green-300"></i>رتبه استانی</span><span class="font-bold text-green-300">${faNum(provinceRank)}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80 flex items-center gap-2"><i class="fas fa-calendar-alt"></i>تاریخ عضویت</span><span class="font-bold">${user.joined || '۱۴۰۲/۰۱/۱۵'}</span></div>
      </div>
      <button id="btn-user-duel" class="btn btn-duel w-full mt-4" aria-label="درخواست نبرد تن به تن"><i class="fas fa-swords ml-2"></i> درخواست نبرد</button>`;
    showDetailPopup('جزئیات کاربر', content);
    $('#btn-user-duel')?.addEventListener('click', () => {
      toast(`درخواست نبرد برای ${user.name} ارسال شد`);
      logEvent('duel_request', { from: State.user.name, to: user.name });
      closeDetailPopup();
    });
  }
  
  function showProvinceDetail(province) {
    const content = `
      <div class="flex flex-col items-center mb-4">
        <div class="w-20 h-20 rounded-full bg-gradient-to-r from-green-400 to-emerald-500 flex items-center justify-center mb-3"><i class="fas fa-map-marked-alt text-white text-2xl"></i></div>
        <h4 class="text-xl font-bold">${province.name}</h4>
        <div class="text-sm opacity-80 mt-1">${province.region}</div>
      </div>
      <div class="space-y-3">
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80">امتیاز کل</span><span class="font-bold text-green-300">${faNum(province.score)}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80">تعداد شرکت‌کنندگان</span><span class="font-bold">${faNum(province.members)}</span></div>
      </div>`;
    showDetailPopup('جزئیات استان', content);
  }
  
  function showGroupDetail(group) {
    const userGroup = getUserGroup();
    const currentGroupName = userGroup?.name || State.user.group || '';
    const isAdmin = group.admin === State.user.name;
    const isMember = (userGroup?.id === group.id) || State.user.group === group.name;
    const requested = group.requests?.includes(State.user.id);
    let content = `
      <div class="flex flex-col items-center mb-4">
        <div class="w-20 h-20 rounded-full bg-gradient-to-r from-purple-400 to-indigo-500 flex items-center justify-center mb-3"><i class="fas fa-users text-white text-2xl"></i></div>
        <h4 class="text-xl font-bold">${group.name}</h4>
        <div class="text-sm opacity-80 mt-1">گروه دانشی</div>
      </div>
      <div class="space-y-3">
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80">امتیاز کل</span><span class="font-bold text-purple-300">${faNum(group.score)}</span></div>
        <div class="flex justify-between items-center glass rounded-xl p-3"><span class="opacity-80">تعداد اعضا</span><span class="font-bold">${faNum(group.members)}</span></div>
      </div>`;

    const membersHtml = (group.memberList || []).map(m=>`<div class="glass rounded-xl p-2 text-sm flex items-center gap-2"><i class="fas fa-user text-blue-200"></i>${m}</div>`).join('');
    content += `
      <div class="mt-4">
        ${isAdmin ? `<input id="new-member-name" class="form-input mb-2" placeholder="نام عضو جدید">
        <button id="btn-add-member" class="btn btn-group w-full"><i class="fas fa-user-plus ml-2"></i> افزودن عضو</button>` : ''}
        <h5 class="font-bold mb-2${isAdmin ? ' mt-4' : ''}">اعضای گروه</h5>
        <div id="member-list" class="space-y-2">${membersHtml || '<div class="text-sm opacity-80">عضوی ثبت نشده است</div>'}</div>
      </div>`;

    const matchesHtml = (group.matches || []).map(m=>`<div class="glass rounded-xl p-2 text-sm flex justify-between"><span>${m.opponent}</span><span>${m.time}</span></div>`).join('');
    content += `
      <div class="mt-4">
        <h5 class="font-bold mb-2">نبردهای پیش‌رو</h5>
        <div class="space-y-2">${matchesHtml || '<div class="text-sm opacity-80">نبردی برنامه‌ریزی نشده است</div>'}</div>
      </div>`;

    if (isAdmin) {
      content += `
        <div class="grid sm:grid-cols-2 gap-3 mt-4">
          <button id="btn-request-duel" class="btn btn-duel w-full"><i class="fas fa-swords ml-2"></i> درخواست نبرد</button>
          <button id="btn-delete-group-detail" class="btn btn-secondary w-full"><i class="fas fa-trash ml-2"></i> حذف گروه</button>
        </div>`;
    } else if (isMember) {
      content += `
        <div class="glass rounded-2xl p-3 mt-4 text-center text-sm opacity-80">
          <i class="fas fa-info-circle ml-1"></i> شما عضو گروه «${group.name}» هستید. در صورت خروج برای بازگشت نیاز به تایید مدیر خواهید داشت.
        </div>
        <button id="btn-leave-group-detail" class="btn btn-secondary w-full mt-3">
          <i class="fas fa-sign-out-alt ml-2"></i> خروج از گروه
        </button>`;
    } else if (!isMember && !isUserInGroup()) {
      content += `
        <button id="btn-join-group" class="btn btn-group w-full mt-4" ${requested ? 'disabled' : ''}>
          <i class="fas fa-user-plus ml-2"></i> ${requested ? 'در انتظار تایید' : 'درخواست عضویت'}
        </button>`;
    } else if (!isMember && isUserInGroup()) {
      const joinedGroupLabel = currentGroupName ? `«${currentGroupName}»` : 'گروه فعلی خود';
      content += `
        <div class="glass rounded-2xl p-3 mt-4 text-center text-sm opacity-80">
          <i class="fas fa-info-circle ml-1"></i> شما در حال حاضر عضو ${joinedGroupLabel} هستید
        </div>`;
    }

    showDetailPopup('جزئیات گروه', content);

    $('#btn-join-group')?.addEventListener('click', () => requestJoinGroup(group.id));
    $('#btn-add-member')?.addEventListener('click', () => {
      const name = $('#new-member-name').value.trim();
      if(!name){ toast('نام عضو جدید را وارد کنید'); return; }
      group.memberList = group.memberList || [];
      group.memberList.push(name);
      group.members += 1;
      $('#member-list').innerHTML += `<div class="glass rounded-xl p-2 text-sm flex items-center gap-2"><i class="fas fa-user text-blue-200"></i>${name}</div>`;
      $('#new-member-name').value='';
      toast(`عضو ${name} اضافه شد`);
      renderGroupSelect();
    });
    $('#btn-request-duel')?.addEventListener('click', () => openDuelRequest(group));
    $('#btn-delete-group-detail')?.addEventListener('click', () => {
      if (confirm('آیا از حذف گروه اطمینان دارید؟ این عمل غیرقابل بازگشت است.')) {
        deleteGroup(group.id);
        closeDetailPopup();
      }
    });
    $('#btn-leave-group-detail')?.addEventListener('click', () => {
      if (confirm('آیا از خروج از این گروه اطمینان دارید؟')) {
        leaveGroup(group.id);
        closeDetailPopup();
      }
    });
  }

function requestJoinGroup(groupId){
  // Check if user is already in a group
  if (isUserInGroup()) {
    toast('شما در حال حاضر عضو یک گروه هستید. ابتدا باید از گروه فعلی خارج شوید.');
    return;
  }
  
  const group = State.groups.find(g=>g.id===groupId);
  if(!group) return;
  group.requests = group.requests || [];
  if(group.requests.includes(State.user.id)){
    toast('درخواست شما قبلا ثبت شده است');
    return;
  }
  group.requests.push(State.user.id);
  toast(`درخواست عضویت به ${group.name} ارسال شد`);
  logEvent('group_join_request', { group: group.name });
  closeDetailPopup();
}

  function openDuelRequest(group){
    const opponents = State.groups.filter(g=>g.id!==group.id);
    if(opponents.length===0){
      toast('گروه دیگری برای نبرد موجود نیست');
      return;
    }
    const cards = opponents.map(g=>`
      <div class="location-card" data-opp="${g.id}">
        <div class="location-icon group-icon"><i class="fas fa-users"></i></div>
        <div class="flex-1"><div class="font-bold">${g.name}</div>
          <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-user"></i><span>مدیر: ${g.admin}</span></div>
        </div>
      </div>`).join('');
    const content = `
      <div class="space-y-3">${cards}</div>
      <button id="btn-back-duel-select" class="btn btn-secondary w-full mt-4"><i class="fas fa-arrow-right ml-2"></i> بازگشت</button>`;
    showDetailPopup('انتخاب گروه رقیب', content);
    $$('[data-opp]').forEach(el=>{
      el.addEventListener('click',()=>{
        const target = State.groups.find(g=>g.id===el.dataset.opp);
        toast(`درخواست نبرد به ${target.name} ارسال شد`);
        logEvent('group_duel_request', {from: group.name, to: target.name});
        closeDetailPopup();
      });
    });
    $('#btn-back-duel-select')?.addEventListener('click',()=>showGroupDetail(group));
  }

function openCreateGroup(){
  // Check if user is already in a group
  if (isUserInGroup()) {
    toast('شما در حال حاضر عضو یک گروه هستید. ابتدا باید از گروه فعلی خارج شوید.');
    return;
  }
  
  const content = `
    <div class="space-y-4">
      <input id="new-group-name" class="form-input" placeholder="نام گروه">
      <div id="invite-container" class="hidden space-y-2">
        <label class="block text-sm opacity-90">لینک دعوت</label>
        <div class="flex">
          <input id="new-group-link" class="form-input flex-1" readonly>
          <button id="btn-copy-link" class="btn btn-secondary ml-2"><i class="fas fa-copy"></i></button>
        </div>
        <div class="text-xs opacity-80">این لینک را برای دعوت دوستان خود به اشتراک بگذارید</div>
      </div>
      <button id="btn-save-group" class="btn btn-group w-full"><i class="fas fa-check ml-2"></i> ایجاد گروه</button>
    </div>`;
  showDetailPopup('ایجاد گروه جدید', content);
  $('#btn-save-group').addEventListener('click', () => {
    const name = $('#new-group-name').value.trim();
    if(!name){ toast('نام گروه را وارد کنید'); return; }
    const newGroup = {
      id: 'g'+(State.groups.length+1),
      name,
      score: 0,
      members: 1,
      admin: State.user.name,
      created: new Date().toLocaleDateString('fa-IR'),
      memberList: [State.user.name],
      requests: [],
      matches: []
    };
    State.groups.push(newGroup);
    State.user.group = name;
    saveState();
    renderGroupSelect();
    renderDashboard();
    logEvent('group_created', { group: name });
    const link = location.origin + '/?join=' + newGroup.id;
    $('#new-group-link').value = link;
    $('#invite-container').classList.remove('hidden');
    $('#btn-copy-link').addEventListener('click', () => {
      navigator.clipboard.writeText(link);
      toast('لینک کپی شد');
    });
    $('#btn-save-group').disabled = true;
    toast('گروه با موفقیت ایجاد شد');
  });
}
  
  // ===== Quiz Flow (legacy) =====
  function buildSet(cat, diff, count){
    let pool = qBank.filter(q => (cat==='همه' || q.cat===cat) && (diff==='همه' || q.diff===diff));
    if(pool.length < count) pool = qBank.slice(); // fallback
    return pool.sort(()=>Math.random()-0.5).slice(0, count);
  }
  
  function updateTimerVisual(){
    const ring = $('#timer-ring');
    const text = $('#timer-text');
    if(!ring || !text) return;
    const total = Math.max(1, State.quiz.duration);
    const remain = clamp(State.quiz.remain, 0, total);
    text.textContent = faNum(remain);
    ring.style.strokeDashoffset = String(TIMER_CIRC * (1 - (remain / total)));
  }

  function resetTimer(seconds){
    const ring = $('#timer-ring');
    if(ring) ring.setAttribute('stroke-dasharray', String(TIMER_CIRC));
    State.quiz.duration = seconds;
    State.quiz.remain = seconds;
    updateTimerVisual();
    if(State.quiz.timer) clearInterval(State.quiz.timer);
    State.quiz.timer = setInterval(()=>{
      State.quiz.remain -= 1;
      if(State.quiz.remain <= 5 && State.quiz.remain > 0) SFX.tick();
      if(State.quiz.remain <= 0){
        State.quiz.remain = 0;
        updateTimerVisual();
        clearInterval(State.quiz.timer);
        lockChoices();
        const ended = registerAnswer(-1);
        if(!ended){
          setTimeout(nextQuestion, 900);
        }
        return;
      }
      updateTimerVisual();
    },1000);
  }

  function addExtraTime(extra){
    if(!Number.isFinite(extra) || extra <= 0) return;
    State.quiz.remain += extra;
    State.quiz.duration += extra;
    updateTimerVisual();
    const ring = $('#timer-ring');
    if(ring){
      ring.classList.remove('timer-boost');
      if(ring.getBBox) ring.getBBox();
      requestAnimationFrame(()=>{
        ring.classList.add('timer-boost');
        setTimeout(()=>ring.classList.remove('timer-boost'), 900);
      });
    }
    const text = $('#timer-text');
    if(text){
      text.classList.remove('timer-boost');
      void text.offsetWidth;
      text.classList.add('timer-boost');
      setTimeout(()=>text.classList.remove('timer-boost'), 900);
    }
  }
  
  function renderQuestionUI(q){
    $('#quiz-cat').innerHTML = `<i class="fas fa-folder ml-1"></i> ${q.cat}`;
    $('#quiz-diff').innerHTML = `<i class="fas fa-signal ml-1"></i> ${q.diff}`;
    $('#qnum').textContent = faNum(State.quiz.idx+1);
    $('#qtotal').textContent = faNum(State.quiz.list.length);
    $('#question').textContent = q.q;
    const box = $('#choices'); box.innerHTML='';
    q.c.forEach((txt,idx)=>{
      const btn = document.createElement('button');
      btn.className='choice'; btn.setAttribute('aria-label','گزینه '+faNum(idx+1));
      btn.innerHTML = `<span class="chip">${faNum(idx+1)}</span><span>${txt}</span>`;
      btn.addEventListener('click', ()=> selectAnswer(idx));
      box.appendChild(btn);
    });
  }
  
  function startQuiz({cat, diff, count}){
    used5050=false; usedSkip=false; usedTimeBoost=false;
    resetLifelinesUI();
    State.quiz.cat=cat; State.quiz.diff=diff;
    State.quiz.list = buildSet(cat, diff, count).map(q=>({ ...q }));
    State.quiz.idx = 0; State.quiz.sessionEarned = 0; State.quiz.results=[];
    State.quiz.inProgress = true; State.quiz.answered=false;
    renderTopBars();
    const q = State.quiz.list[0];
    renderQuestionUI(q);
    resetTimer(diff==='سخت'?20:diff==='متوسط'?25:30);

    if(State.duelOpponent){
      $('#duel-opponent-name').textContent = State.duelOpponent.name;
      $('#duel-banner').classList.remove('hidden');
    } else {
      $('#duel-banner').classList.add('hidden');
    }

    // Log analytics
    logEvent('quiz_start', { category: cat, difficulty: diff, questionCount: count });
  }
  
  function lockChoices(){ $$('#choices .choice').forEach(el=> el.classList.add('pointer-events-none','opacity-70')); }
  
  function registerAnswer(idx){
    const q = State.quiz.list[State.quiz.idx] || {};
    const correct = q.a;
    const ok = (idx===correct);
    const base = ok ? 100 : 0;
    const timeBonus = ok ? Math.floor((State.quiz.remain/State.quiz.duration)*50) : 0;
    const boostActive = Date.now() < State.boostUntil;
    const vipBonus = Server.subscription.active ? 20 : 0; // VIP from server
    const earned = Math.floor((base + timeBonus + vipBonus) * (boostActive?2:1));
    let shouldEnd = false;

    if(ok){
      State.score += earned; State.coins += 5; State.quiz.sessionEarned += earned; SFX.correct(); vibrate(30);
    } else {
      State.lives -= 1;
      // Use a life from the limit
      useGameResource('lives');
      SFX.wrong(); vibrate([10,30,10]);
      if(State.lives<=0) shouldEnd = true;
    }

    State.quiz.results.push({ q:q.q, ok, correct: q.c[correct], you: idx>=0 ? q.c[idx] : '—' });
    saveState(); renderHeader(); renderTopBars();

    // Log analytics
    logEvent('question_answered', {
      correct: ok,
      timeSpent: State.quiz.duration - State.quiz.remain,
      category: q.cat,
      difficulty: q.diff
    });

    if(shouldEnd){
      endQuiz();
      return true;
    }

    return false;
  }
  
  function selectAnswer(idx){
    if(State.quiz.answered) return;
    State.quiz.answered = true; clearInterval(State.quiz.timer);
    const correct = State.quiz.list[State.quiz.idx].a;
    const list = $$('#choices .choice');
    list.forEach((el,i)=> el.classList.add(i===correct? 'correct':'wrong'));
    lockChoices();
    const ended = registerAnswer(idx);
    if(!ended){
      setTimeout(nextQuestion, 900);
    }
  }
  
  function nextQuestion(){
    State.quiz.answered=false;
    State.quiz.idx++;
    if(State.quiz.idx >= State.quiz.list.length){
      endQuiz();
      return;
    }
    const q = State.quiz.list[State.quiz.idx];
    renderQuestionUI(q);
    resetTimer(State.quiz.diff==='سخت'?20:State.quiz.diff==='متوسط'?25:30);
  }
  
  async function endQuiz(){
    State.quiz.inProgress=false;
    const correctCount = State.quiz.results.filter(r=>r.ok).length;
    if(correctCount>0 && !State.achievements.firstWin){ 
      State.achievements.firstWin=true; 
      toast('<i class="fas fa-award ml-2"></i>نشان «اولین برد» آزاد شد!'); 
      shootConfetti(); 
    }
    if(correctCount>=10 && !State.achievements.tenCorrect){ 
      State.achievements.tenCorrect=true; 
      toast('<i class="fas fa-medal ml-2"></i>نشان «۱۰ پاسخ درست»!'); 
    }
    $('#res-correct').textContent = faNum(correctCount);
    $('#res-wrong').textContent = faNum(State.quiz.results.length - correctCount);
    $('#res-earned').textContent = faNum(State.quiz.sessionEarned);
    const wrap = $('#res-list'); wrap.innerHTML='';
    State.quiz.results.forEach((r,i)=>{
      const row=document.createElement('div'); row.className='bg-white/10 border border-white/20 rounded-xl px-3 py-2';
      row.innerHTML=`<div class="text-sm font-bold mb-1">${faNum(i+1)}. ${r.q}</div>
        <div class="text-xs ${r.ok?'text-emerald-300':'text-rose-300'}">${r.ok?'درست':'نادرست'}</div>
        <div class="text-xs opacity-90">پاسخ صحیح: ${r.correct}</div>
        <div class="text-xs opacity-70">پاسخ شما: ${r.you}</div>`;
      wrap.appendChild(row);
    });
    if(State.duelOpponent){
      const total = State.quiz.list.length;
      const opponentCorrect = Math.floor(Math.random()*(total+1));
      const opponentWrong = total - opponentCorrect;
      const opponentEarned = opponentCorrect * 120;
      const yourCorrect = correctCount;
      const yourWrong = total - correctCount;
      const yourEarned = State.quiz.sessionEarned;
      const youName = State.user?.name || 'شما';
      const oppName = State.duelOpponent.name;
      $('#duel-avatar-you').src = State.user?.avatar || 'https://i.pravatar.cc/60?img=1';
      $('#duel-name-you').textContent = youName;
      $('#duel-avatar-opponent').src = State.duelOpponent.avatar || '';
      $('#duel-name-opponent').textContent = oppName;
      let winnerText = 'مسابقه مساوی شد!';
      if (yourEarned > opponentEarned) {
        winnerText = `${youName} برنده شد!`;
        State.duelWins++;
      }
      else if (yourEarned < opponentEarned) {
        winnerText = `${oppName} برنده شد!`;
        State.duelLosses++;
      }
      $('#duel-winner').textContent = winnerText;
      $('#duel-stats').innerHTML = `${youName}: ${faNum(yourCorrect)} درست، ${faNum(yourWrong)} نادرست، ${faNum(yourEarned)} امتیاز<br>${oppName}: ${faNum(opponentCorrect)} درست، ${faNum(opponentWrong)} نادرست، ${faNum(opponentEarned)} امتیاز`;
      $('#duel-result').classList.remove('hidden');
      renderDashboard();
    } else {
      $('#duel-result').classList.add('hidden');
    }
    saveState();
    navTo('results');
    AdManager.maybeShowInterstitial('post_quiz');
  }
  
  // ===== Streak / Daily (legacy) =====
  function claimStreak(){
    const nowDay = Math.floor(Date.now()/86400000);
    if(State.lastClaim === nowDay){ toast('<i class="fas fa-info-circle ml-2"></i>امروز قبلاً دریافت کردی'); return; }
    const yesterday = nowDay - 1;
    if(State.lastClaim === yesterday) State.streak += 1; else State.streak = 1;
    State.lastClaim = nowDay;
    const reward = 5 * State.streak;
    State.coins += reward; State.score += reward*10;
    saveState(); renderDashboard(); renderHeader();
    toast(`<i class="fas fa-gift ml-2"></i>پاداش امروز: ${faNum(reward)}💰 🎉`);
    if(State.streak>=3 && !State.achievements.streak3){ State.achievements.streak3=true; toast('<i class="fas fa-fire ml-2"></i>نشان «استریک ۳ روزه»!'); }
  }
  
  function startDaily(){
    const seed = Math.floor(Date.now()/86400000);
    const pool = qBank.slice().map((q,i)=>({q, k: Math.sin((i+1)*seed)*10000})).sort((a,b)=>a.k-b.k).map(o=>o.q);
    State.lives = Math.max(State.lives, 1);
    used5050=false; usedSkip=false; usedTimeBoost=false;
    resetLifelinesUI();
    State.quiz.cat='عمومی'; State.quiz.diff='متوسط'; State.quiz.list=pool.slice(0,5);
    State.quiz.idx=0; State.quiz.sessionEarned=0; State.quiz.results=[]; State.quiz.inProgress=true; State.quiz.answered=false;
    navTo('quiz'); renderTopBars(); renderQuestionUI(State.quiz.list[0]); resetTimer(25);
  }
  
  // ===== Shop (legacy soft-currency), VIP button rerouted =====

// ===== Shop (Keys) =====
function renderShop(){
  // موجودی‌ها
  if ($('#shop-gcoins'))  $('#shop-gcoins').textContent  = faNum(State.coins);
  if ($('#shop-wallet'))  $('#shop-wallet').textContent  = (Server.wallet.coins==null?'—':faNum(Server.wallet.coins));
  if ($('#keys-count'))   $('#keys-count').textContent   = faNum(State.keys || 0);

  // بسته‌ها را از RemoteConfig بخوان و دکمه‌ها را آپدیت کن
  const packs = RemoteConfig.pricing.keys || [];
  packs.forEach(p => {
    const el = document.querySelector(`[data-buy-key="${p.id}"]`);
    if(!el) return;
    el.querySelector('[data-amount]').textContent = faNum(p.amount);
    el.querySelector('[data-price]').textContent  = faNum(p.priceGame);
    const cant = State.coins < p.priceGame;
    el.disabled = cant;
    el.title = cant ? 'سکهٔ بازی کافی نیست' : `خرید ${faNum(p.amount)} کلید`;
  });

  // نشان «به‌صرفه‌ترین» را روی بهترین نسبت قیمت/تعداد بگذار
  const best = packs.reduce((a,b)=> (a.priceGame/a.amount <= b.priceGame/b.amount) ? a : b, packs[0]);
  document.querySelectorAll('.product-card .ribbon.auto').forEach(n=>n.remove());
  if (best) {
    const bestBtn = document.querySelector(`[data-buy-key="${best.id}"]`);
    if (bestBtn && !bestBtn.querySelector('.ribbon')) {
      const badge = document.createElement('div');
      badge.className = 'ribbon auto';
      badge.textContent = 'به‌صرفه‌ترین';
      bestBtn.appendChild(badge);
    }
  }
}


function buyKeys(packId){
  const pack = RemoteConfig.pricing.keys.find(p => p.id === packId);
  if (!pack){ toast('بستهٔ کلید یافت نشد'); return; }

  if (State.coins < pack.priceGame){
    toast('<i class="fas fa-exclamation-circle ml-2"></i> سکهٔ بازی کافی نیست'); 
    return;
  }

  State.coins -= pack.priceGame;
  State.keys = (State.keys || 0) + pack.amount;

  saveState();
  renderHeader();       // برای آپدیت سکه در هدر
  renderDashboard();    // اگر داشبورد باز بود
  renderTopBars();      // اگر داخل مسابقه‌ای
  renderShop();         // آپدیت خود فروشگاه

  SFX.coin();
  toast(`<i class="fas fa-check-circle ml-2"></i> ${faNum(pack.amount)} کلید خریداری شد`);
  logEvent('purchase_item', { item:'keys', pack: pack.id, amount: pack.amount, price: pack.priceGame });
}

// لیسنر کلی برای دکمه‌های خرید کلید (event delegation)
document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-buy-key]');
  if (!btn) return;
  buyKeys(btn.dataset.buyKey);
});


  function buy(item){
    const price = { life:30, boost:50, hint:20, streak:40 }[item];
    if(price==null) return;
    if(State.coins < price){ toast('<i class="fas fa-exclamation-circle ml-2"></i>سکه کافی نیست'); return; }
    State.coins -= price;
    if(item==='life') State.lives += 1;
    if(item==='boost') State.boostUntil = Date.now() + 10*60*1000;
    if(item==='hint') { /* Hint logic */ }
    if(item==='streak') { /* Streak protection logic */ }
    saveState(); renderDashboard(); renderTopBars();
    SFX.coin(); toast('<i class="fas fa-check-circle ml-2"></i>خرید با موفقیت انجام شد');
    
    // Log analytics
    logEvent('purchase_item', { item, price });
  }
  
  // ===== Wallet (server) =====
function buildPackages(){
  const grid = $('#pkg-grid');
  grid.innerHTML = '';

  // نرخ تبدیل پشتیبان برای وقتی priceToman نباشه
  const usdToToman = RemoteConfig?.pricing?.usdToToman || 70_000;

  // آماده‌سازی پکیج‌ها با محاسبه‌ی قیمت تومانی و ارزش هر پکیج
  const packs = (RemoteConfig?.pricing?.coins || []).map(p => {
    const bonus = Number(p.bonus || 0);
    const priceToman = (typeof p.priceToman === 'number' && p.priceToman > 0)
      ? p.priceToman
      : Math.round(((p.priceCents || 0) / 100) * usdToToman);

    const received = p.amount + Math.floor(p.amount * bonus / 100); // مقدار دریافتی
    const valueScore = priceToman > 0 ? (received / priceToman) : 0; // سکه به ازای هر تومان

    return { ...p, bonus, priceToman, received, valueScore };
  });

  if (!packs.length){
    grid.innerHTML = `<div class="glass-dark rounded-2xl p-4 text-center opacity-80">
      در حال حاضر بسته‌ای موجود نیست
    </div>`;
    return;
  }

  // پیدا کردن به‌صرفه‌ترین بسته
  const best = packs.reduce((a,b) => (a.valueScore >= b.valueScore ? a : b), packs[0]);

  // رندر کارت‌ها
  packs.forEach(pkg => {
    const card = document.createElement('div');
    card.className = 'glass-dark rounded-2xl p-4 card-hover flex flex-col justify-between relative h-full';

    const bonusBadge = pkg.bonus
      ? `<span class="chip bg-white/20"><i class="fas fa-gift ml-1"></i> ${faNum(pkg.bonus)}%</span>`
      : '';

    const bestRibbon = (pkg.id === best.id)
      ? `<div class="ribbon">به‌صرفه‌ترین</div>`
      : '';

    card.innerHTML = `
      ${bestRibbon}
      <div class="flex items-center justify-between">
        <div class="text-lg font-bold">${faNum(pkg.amount)} سکه</div>
        ${bonusBadge}
      </div>
      <div class="text-sm opacity-80 mt-1">${faNum(pkg.received)} دریافتی</div>

      <button class="btn btn-primary mt-3 buy-pkg"
              data-id="${pkg.id}"
              aria-label="خرید بسته ${faNum(pkg.amount)} سکه">
        پرداخت ${faNum(pkg.priceToman)} <span class="text-xs">تومان</span>
      </button>
    `;

    grid.appendChild(card);
  });

  // وضعیت کیف پول و آفلاین
  $('#wallet-balance').textContent = (Server.wallet.coins == null ? '—' : faNum(Server.wallet.coins));
  $('#wallet-offline').classList.toggle('hidden', online());
}




// Enhanced Payment Modal Functions
let currentPackageData = null;

function showPaymentModal(packageId) {
  const pkg = RemoteConfig.pricing.coins.find(p => p.id === packageId);
  if (!pkg) {
    toast('بسته یافت نشد');
    return;
  }
  
  currentPackageData = pkg;
  
  // Calculate price in Toman
  const priceToman = pkg.priceToman || Math.round(((pkg.priceCents || 0) / 100) * (RemoteConfig.pricing.usdToToman || 70000));
  const totalCoins = pkg.amount + Math.floor(pkg.amount * (pkg.bonus || 0) / 100);
  const walletBalance = Server.wallet.coins || 0;
  
  // Update modal content
  $('#payment-package-name').textContent = `بسته ${faNum(pkg.amount)} سکه`;
  $('#payment-coins-amount').textContent = `${faNum(totalCoins)} سکه`;
  $('#payment-price').textContent = `${faNum(priceToman)} تومان`;
  $('#payment-wallet-balance').textContent = `${faNum(walletBalance)} تومان`;
  
  // Check if wallet balance is sufficient
  const needsPayment = walletBalance < priceToman;
  $('#payment-warning').classList.toggle('show', needsPayment);
  
  // Update button text based on balance
  const confirmBtn = $('#payment-confirm-btn');
  if (needsPayment) {
    confirmBtn.innerHTML = '<i class="fas fa-credit-card ml-2"></i> رفتن به درگاه پرداخت';
  } else {
    confirmBtn.innerHTML = '<i class="fas fa-check ml-2"></i> تایید و پرداخت';
  }
  
  // Set up click handler
  confirmBtn.onclick = () => handlePaymentConfirm(pkg.id, priceToman, needsPayment);
  
  // Show modal
  $('#modal-payment').classList.add('show');
  
  // Animate icon
  setTimeout(() => {
    $('#modal-payment .payment-icon').style.transform = 'scale(1.1)';
    setTimeout(() => {
      $('#modal-payment .payment-icon').style.transform = 'scale(1)';
    }, 200);
  }, 100);
}

function closePaymentModal() {
  $('#modal-payment').classList.remove('show');
  currentPackageData = null;
}

async function handlePaymentConfirm(packageId, priceToman, needsPayment) {
  if (needsPayment) {
    // Redirect to payment gateway
    closePaymentModal();
    
    // Show loading toast
    toast('<i class="fas fa-spinner fa-spin ml-2"></i> در حال انتقال به درگاه پرداخت...');
    
    // Log analytics
    await logEvent('payment_gateway_redirect', { 
      packageId, 
      priceToman,
      reason: 'insufficient_balance' 
    });
    
    // Simulate redirect (in real app, this would be actual payment gateway URL)
    setTimeout(() => {
      window.location.href = '/payment?package=' + packageId + '&amount=' + priceToman;
    }, 1000);
  } else {
    // Process payment with wallet balance
    closePaymentModal();
    startPurchaseCoins(packageId);
  }
}

  function showPayConfirm(btn){
    const pkgId = btn.dataset.id;
    const price = parseFloat(btn.dataset.price||'0');
    const wallet = Server.wallet.coins||0;
    $('#pay-popup-message').innerHTML = `قیمت بسته: ${faNum(price)} تومان`;
    $('#pay-popup-wallet').innerHTML = `موجودی کیف پول: ${faNum(wallet)} تومان`;
    $('#pay-popup-confirm').onclick = ()=>{
      closeModal('#modal-pay-confirm');
      if(wallet >= price){
        startPurchaseCoins(pkgId);
      }else{
        window.location.href = '/payment';
      }
    };
    openModal('#modal-pay-confirm');
  }
  
  function renderVipStatusPill(){
    const s = Server.subscription;
    const pill = $('#vip-status-pill');
    if(s.status==='unknown'){ pill.innerHTML = '<i class="fas fa-circle-notch fa-spin ml-1"></i> بررسی وضعیت...'; return; }
    if(s.active){
      pill.innerHTML = `<i class="fas fa-check ml-1"></i> ${s.tier === 'pro' ? 'پرو' : 'لایت'} تا ${s.expiry ? new Date(s.expiry).toLocaleDateString('fa-IR'):'—'}`;
    } else {
      pill.innerHTML = `<i class="fas fa-ban ml-1"></i> غیرفعال`;
    }
  }
  
  function updateVipUI(){
    renderVipStatusPill();
    const meta = $('#vip-meta');
    const s = Server.subscription;
    if(s.active){
      meta.innerHTML = `<div class="chip"><i class="fas fa-rotate ml-1"></i> تمدید خودکار: ${s.autoRenew?'بله':'خیر'}</div>`;
    } else {
      meta.innerHTML = `<div class="text-sm opacity-80">برای حذف تبلیغات و مزایا، یکی از پلن‌ها را انتخاب کن.</div>`;
    }
    // Disable ad UI if VIP
    AdManager.refreshAll();
  }
  
  // ===== Payments & Subscription =====
  async function refreshWallet(){
    const data = await Net.jget('/api/wallet');
    if(data && typeof data.coins==='number'){ 
      Server.wallet.coins = data.coins; 
      $('#hdr-wallet').textContent = faNum(Server.wallet.coins); 
      $('#stat-wallet').textContent = faNum(Server.wallet.coins); 
      $('#wallet-balance').textContent = faNum(Server.wallet.coins); 
    }
  }
  
  async function refreshSubscription(){
    const data = await Net.jget('/api/subscription/me');
    if(data && typeof data.active==='boolean'){
      Server.subscription.active = data.active;
      Server.subscription.status = data.active ? 'active':'inactive';
      Server.subscription.expiry = data.expiry||null;
      Server.subscription.autoRenew = !!data.autoRenew;
      Server.subscription.plan = data.plan||null;
      Server.subscription.tier = data.tier||null;
      // Reflect to UI; gameplay VIP bonus already uses Server.subscription.active
      renderHeader(); renderDashboard(); renderVipStatusPill(); AdManager.refreshAll();
      
      // Update limits UI when VIP status changes
      updateLimitsUI();
    }
  }
  
  function genIdemKey(){ return 'idem_'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
  
async function startPurchaseCoins(pkgId){
  if(!online()){ toast('<i class="fas fa-wifi-slash ml-2"></i> آفلاین هستی'); return; }
  const pkg = (RemoteConfig.pricing.coins || []).find(p=>p.id===pkgId);
  if(!pkg){ toast('بسته یافت نشد'); return; }

  const priceTmn = coinPriceToman(pkg);             // تومان برای نمایش و رسید
  const idem = genIdemKey();
  const btn = document.querySelector(`.buy-pkg[data-id="${pkgId}"]`);
  const normalLabel = `<i class="fas fa-credit-card ml-1"></i> پرداخت ${formatToman(priceTmn)}`;

  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> در حال ایجاد تراکنش...';

  await logEvent('purchase_initiated', { kind:'coins', pkgId, priceCents:pkg.priceCents, priceToman:priceTmn, idem });

  const res = await Net.jpost('/api/payments/create', {
    idempotencyKey: idem,
    type:'coins',
    packageId: pkgId
  });

  if(!res || !res.txnId){
    btn.disabled = false;
    btn.innerHTML = normalLabel;
    toast('<i class="fas fa-triangle-exclamation ml-2"></i> ایجاد تراکنش ناموفق');
    await logEvent('purchase_failed', { kind:'coins', pkgId, reason:'create_failed' });
    return;
  }

  const txnId = res.txnId;
  // Poll wallet until updated or timeout
  const before = Server.wallet.coins;
  let ok=false;
  for(let i=0;i<20;i++){
    await wait(1000);
    await refreshWallet();
    if(Server.wallet.coins!=null && (before==null || Server.wallet.coins>before)){ ok=true; break; }
  }

  btn.disabled = false;
  btn.innerHTML = normalLabel;

  if(ok){
    Server.wallet.lastTxnId = txnId;
    openReceipt({
      title:'خرید سکه موفق بود',
      rows:[
        ['کد تراکنش', txnId],
        ['بسته', `${faNum(pkg.amount)} (+${pkg.bonus||0}%)`],
        ['مبلغ', formatToman(priceTmn)],
        ['موجودی جدید', faNum(Server.wallet.coins)]
      ]
    });
    await logEvent('purchase_succeeded', { kind:'coins', pkgId, txnId, priceToman:priceTmn });
    SFX.coin();
  } else {
    openReceipt({
      title:'در انتظار تایید',
      rows:[
        ['کد تراکنش', txnId],
        ['وضعیت', 'هنوز تایید نشده؛ چند لحظه بعد دوباره بررسی می‌شود.']
      ]
    });
    await logEvent('purchase_failed', { kind:'coins', pkgId, txnId, reason:'confirm_timeout' });
  }
}

  
  function openReceipt({title, rows}){
    $('#receipt-body').innerHTML = `<div class="font-bold mb-2">${title}</div>` + rows.map(r=>`<div class="flex items-center justify-between"><span class="opacity-80">${r[0]}</span><span class="font-bold">${r[1]}</span></div>`).join('');
    openModal('#modal-receipt');
  }
  
  async function startPurchaseVip(tier){
    if(!online()){ toast('<i class="fas fa-wifi-slash ml-2"></i> آفلاین هستی'); return; }
    const pricing = RemoteConfig.pricing.vip[tier];
    if(!pricing){ toast('پلن یافت نشد'); return; }
    const idem = genIdemKey();
    const btn = (tier==='lite')?$('#buy-vip-lite'):$('#buy-vip-pro');
    btn.disabled = true; const prevHTML = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> ایجاد تراکنش...';
    await logEvent('purchase_initiated', { kind:'vip', tier, priceCents:pricing.priceCents, idem });
    const res = await Net.jpost('/api/payments/create', { idempotencyKey: idem, type:'vip', tier });
    if(!res || !res.txnId){
      btn.disabled=false; btn.innerHTML = prevHTML; 
      toast('<i class="fas fa-triangle-exclamation ml-2"></i> ایجاد تراکنش VIP ناموفق'); 
      await logEvent('purchase_failed', { kind:'vip', tier, reason:'create_failed' }); 
      return;
    }
    const txnId = res.txnId;
    // Poll subscription
    let ok=false;
    for(let i=0;i<20;i++){ await wait(1200); await refreshSubscription(); if(Server.subscription.active){ ok=true; break; } }
    btn.disabled=false; btn.innerHTML = prevHTML;
    if(ok){
      await logEvent('purchase_succeeded', { kind:'vip', tier, txnId });
      await logEvent('vip_activated', { tier, expiry: Server.subscription.expiry||null });
      openReceipt({ title:'اشتراک فعال شد 🎉', rows:[
        ['کد تراکنش', txnId],
        ['پلن', tier==='lite'?'لایت':'پرو'],
        ['تا تاریخ', Server.subscription.expiry ? new Date(Server.subscription.expiry).toLocaleDateString('fa-IR') : '—']
      ]});
      renderHeader(); renderDashboard(); AdManager.refreshAll(); shootConfetti();
    } else {
      await logEvent('purchase_failed', { kind:'vip', tier, txnId, reason:'confirm_timeout' });
      openReceipt({ title:'در انتظار تایید اشتراک', rows:[['کد تراکنش', txnId], ['وضعیت', 'در حال پردازش...']] });
    }
  }
  
  // ===== Ads Manager =====
  const AdManager = {
    enabled(){ return RemoteConfig.ads.enabled && !Server.subscription.active; },
    getLocalAd(placement){
      const ads = State.ads?.[placement] || [];
      const now = Date.now();
      const province = Server.user.province || State.user.province;
      return ads.find(a => {
        const start = new Date(a.startDate).getTime();
        const end = new Date(a.endDate).getTime();
        const targets = a.provinces || [];
        return now >= start && now <= end && (targets.length === 0 || targets.includes(province));
      }) || null;
    },
    // Banner
    async renderBanner(){
      const slot = $('#ad-banner .ad-banner-inner'); if(!slot) return;
      slot.innerHTML = ''; // reserved height stays via parent
      const local = this.getLocalAd('banner');
      if(local){
        const w=document.createElement('a');
        w.href=local.landing; w.target='_blank';
        w.className='w-full h-full block relative';
        w.innerHTML=`<img src="${local.creative}" alt="banner ad" class="w-full h-full object-cover">`;
        const close=document.createElement('button'); close.className='ad-close'; close.innerHTML='<i class="fas fa-times"></i>';
        close.setAttribute('aria-label','بستن بنر');
        close.onclick=()=>{ slot.innerHTML='<div class="ad-skeleton">بنر بسته شد</div>'; logEvent('ad_close',{placement:'banner', local:true}); };
        w.appendChild(close); slot.appendChild(w);
        logEvent('ad_impression',{placement:'banner', local:true});
        w.addEventListener('click',()=>logEvent('ad_click',{placement:'banner', local:true}),{once:true});
        return;
      }
      if(!this.enabled() || !RemoteConfig.ads.placements.banner){
        slot.innerHTML = `<div class="ad-skeleton">${Server.subscription.active ? 'وی‌آی‌پی: بدون تبلیغ' : 'تبلیغ غیرفعال'}</div>`;
        return;
      }
      // Try remote, else fallback card
      try{
        const res = await Net.jget('/api/ads?placement=banner&province='+encodeURIComponent(Server.user.province||State.user.province));
        if(res && res.html){
          const w = document.createElement('div'); w.className='w-full h-full relative';
          w.innerHTML = res.html;
          const close = document.createElement('button'); close.className='ad-close'; close.innerHTML='<i class="fas fa-times"></i>'; close.setAttribute('aria-label','بستن بنر');
          close.onclick=()=>{ slot.innerHTML=`<div class="ad-skeleton">بنر بسته شد</div>`; logEvent('ad_close',{placement:'banner'}); };
          w.appendChild(close);
          slot.appendChild(w);
          logEvent('ad_impression',{placement:'banner'});
          w.addEventListener('click',()=>logEvent('ad_click',{placement:'banner'}),{once:true});
          return;
        }
      }catch{}
      // Fallback
      slot.innerHTML = `<a href="#" class="w-full h-full flex items-center justify-between px-4" aria-label="اسپانسر محلی">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-amber-300 to-orange-400"></div>
          <div class="text-sm"><div class="font-bold">کد تخفیف همشهری</div><div class="opacity-80">SANANDAJ10</div></div>
        </div>
        <i class="fas fa-arrow-left opacity-80"></i>
      </a>`;
      logEvent('ad_impression',{placement:'banner', fallback:true});
    },
    // Native
    async renderNative(selector){
      const slot = document.querySelector(selector); if(!slot) return;
      slot.innerHTML = '<div class="ad-skeleton">تبلیغ همسان</div>';
      const local=this.getLocalAd('native');
      if(local){
        slot.innerHTML=`<div class="w-full flex items-center gap-3 p-3 relative">
            <img src="${local.creative}" class="w-16 h-16 rounded-2xl object-cover" alt="ad">
            <div class="flex-1">
              <div class="font-bold">تبلیغ اسپانسری</div>
              <div class="text-xs opacity-80">${new URL(local.landing).hostname}</div>
            </div>
            <a role="button" href="${local.landing}" class="btn btn-primary w-auto px-4 py-2 text-sm" aria-label="مشاهده">مشاهده</a>
          </div>`;
        logEvent('ad_impression',{placement:'native', local:true});
        slot.querySelector('a')?.addEventListener('click',()=>logEvent('ad_click',{placement:'native', local:true}),{once:true});
        return;
      }
      if(!this.enabled() || !RemoteConfig.ads.placements.native){ slot.innerHTML = '<div class="ad-skeleton">—</div>'; return; }
      try{
        const res = await Net.jget('/api/ads?placement=native&province='+encodeURIComponent(Server.user.province||State.user.province));
        if(res && res.title){
          slot.innerHTML = `<div class="w-full flex items-center gap-3 p-3">
            <img src="${res.image||'https://picsum.photos/seed/ad/88/88'}" class="w-16 h-16 rounded-2xl object-cover" alt="ad">
            <div class="flex-1">
              <div class="font-bold">${res.title}</div>
              <div class="text-xs opacity-80">${res.desc||'پیشنهاد ویژه امروز'}</div>
            </div>
            <a role="button" href="${res.ctaUrl||'#'}" class="btn btn-primary w-auto px-4 py-2 text-sm" aria-label="مشاهده">مشاهده</a>
          </div>`;
          logEvent('ad_impression',{placement:'native'});
          slot.querySelector('a')?.addEventListener('click', ()=>logEvent('ad_click',{placement:'native'}), {once:true});
          return;
        }
      }catch{}
      // Fallback to sponsor
      slot.innerHTML = $('#sponsor-card').outerHTML;
      logEvent('ad_impression',{placement:'native', fallback:true});
    },
    // Interstitial (frequency capping)
    async maybeShowInterstitial(trigger){
      if(!this.enabled() || !RemoteConfig.ads.placements.interstitial) return;
      const now = Date.now();
      const caps = RemoteConfig.ads.freqCaps; const sess = RemoteConfig.ads.session;
      if(sess.interstitialShown >= caps.interstitialPerSession) return;
      if(now - sess.lastInterstitialAt < RemoteConfig.ads.interstitialCooldownMs) return;
      sess.interstitialShown++; sess.lastInterstitialAt=now;
      const modal = $('#modal-interstitial'); const frame = $('#interstitial-frame');
      const local = this.getLocalAd('interstitial');
      logEvent('ad_impression',{placement:'interstitial', trigger, local:!!local});
      if(local){
        frame.src = local.creative;
      } else {
        let url = null; try{ const res = await Net.jget('/api/ads?placement=interstitial&province='+encodeURIComponent(Server.user.province||State.user.province)); url = res?.url||null; }catch{}
        frame.src = url || 'about:blank';
        if(!url){ frame.srcdoc = `<style>body{margin:0;display:flex;align-items:center;justify-content:center;background:#111;color:#fff;font-family:sans-serif}</style><div>تبلیغ محلی</div>`; }
      }
      modal.classList.add('show');
      let closed=false;
      function close(){ if(closed) return; closed=true; modal.classList.remove('show'); frame.src='about:blank'; logEvent('ad_close',{placement:'interstitial'}); }
      $('#interstitial-close').onclick = close;
      setTimeout(()=>{ if(!closed){ close(); } }, 10_000);
    },
    // Rewarded
    async showRewarded({reward='coins', amount=20}={}){
      if(!this.enabled() || !RemoteConfig.ads.placements.rewarded){ toast('تبلیغ در دسترس نیست'); return false; }
      const sess = RemoteConfig.ads.session; if(sess.rewardedShown >= RemoteConfig.ads.freqCaps.rewardedPerSession){ toast('سقف تماشای ویدیو امروز تکمیل شده'); return false; }
      if(Server.subscription.active){ toast('در VIP تبلیغات نمایش داده نمی‌شود'); return false; }
      sess.rewardedShown++;
      const modal = $('#modal-rewarded'); const vid = $('#rewarded-video'); const claim = $('#rewarded-claim'); const cd = $('#rewarded-countdown');
      const local = this.getLocalAd('rewarded');
      let src = null;
      if(local){
        src = local.creative;
      } else {
        try{ const res = await Net.jget('/api/ads?placement=rewarded&province='+encodeURIComponent(Server.user.province||State.user.province)); src = res?.video||null; }catch{}
      }
      if(!src){
        vid.removeAttribute('src'); vid.querySelector('source').src=''; vid.load();
        cd.textContent = 'اسپانسر محلی — پخش نمادین';
      } else {
        vid.querySelector('source').src = src; vid.load();
      }
      claim.disabled = true; let canClaimAt = Date.now()+RemoteConfig.ads.rewardedMinWatchMs;
      const t = setInterval(()=>{
        const left = Math.max(0, Math.ceil((canClaimAt - Date.now())/1000));
        cd.textContent = left>0 ? `پس از ${faNum(left)} ثانیه می‌توانی پاداش بگیری` : 'می‌توانی پاداش بگیری';
        if(left<=0){ claim.disabled=false; clearInterval(t); }
      }, 250);
      modal.classList.add('show');
      return new Promise(resolve=>{
        function cleanup(ok){ modal.classList.remove('show'); vid.pause(); claim.disabled=true; resolve(!!ok); }
        $('#rewarded-close').onclick=()=>{ logEvent('ad_close',{placement:'rewarded'}); cleanup(false); };
        claim.onclick=async ()=>{
          cleanup(true);
          if(reward==='coins'){ State.coins += amount; renderTopBars(); saveState(); }
          if(reward==='life'){ State.lives += 1; renderTopBars(); saveState(); }
          await logEvent('ad_completed',{placement:'rewarded', reward, amount});
          await logEvent('reward_granted',{reward, amount});
          const rewardName = reward==='coins'?'سکه':'کلید';
          toast(`<i class="fas fa-check ml-1"></i> پاداش دریافت شد: ${faNum(amount)} ${rewardName}`);
          SFX.coin();
        };
      });
    },
    async refreshAll(){
      this.renderBanner();
      this.renderNative('#ad-native-dashboard');
      this.renderNative('#ad-native-lb');
    }
  };
  
  // ===== Notifications / Modals / Theme =====
  function openModal(sel){ const m=$(sel); m.classList.add('show'); }
  function closeModal(sel){ const m=$(sel); m.classList.remove('show'); }
  $('#set-sound')?.addEventListener('change', e=>{ State.settings.sound = e.target.checked; saveState(); });
  $('#set-haptics')?.addEventListener('change', e=>{ State.settings.haptics = e.target.checked; saveState(); });
  $('#set-block-duels')?.addEventListener('change', e=>{ State.settings.blockDuels = e.target.checked; saveState(); });
  $('#set-theme')?.addEventListener('change', e=>{
    const night = e.target.checked; State.theme = night ? 'night' : 'ocean';
    document.documentElement.setAttribute('data-theme', State.theme); saveState();
  });
  
  // Lifelines
  let used5050=false, usedSkip=false, usedTimeBoost=false;
  function life5050(){
    if(used5050) return toast('۵۰–۵۰ را قبلاً استفاده کردی 😅');
    if(!spendLifelineCost()) return;
    used5050=true;
    markLifelineUsed('life-5050');
    const correct = State.quiz.list[State.quiz.idx].a;
    const idxs = [0,1,2,3].filter(i=>i!==correct).sort(()=>Math.random()-0.5).slice(0,2);
    idxs.forEach(i=>{ const el=$$('#choices .choice')[i]; if(el){ el.style.opacity=.35; el.style.pointerEvents='none'; } });
    toast('<i class="fas fa-percent ml-1"></i> دو گزینه حذف شد');
    SFX.coin();
  }
  function lifeSkip(){
    if(usedSkip) return toast('پرش فقط یک‌بار مجازه');
    if(!spendLifelineCost()) return;
    usedSkip=true;
    markLifelineUsed('life-skip');
    clearInterval(State.quiz.timer);
    const cur = State.quiz.list[State.quiz.idx];
    State.quiz.results.push({ q: cur.q, ok:false, correct: cur.c[cur.a], you:'— (پرش)' });
    saveState();
    toast('<i class="fas fa-forward ml-1"></i> به سؤال بعدی رفتی');
    nextQuestion();
  }
  function lifePause(){
    if(usedTimeBoost) return toast('فقط یک‌بار می‌توانی زمان اضافه کنی');
    if(!spendLifelineCost()) return;
    usedTimeBoost=true;
    markLifelineUsed('life-pause');
    addExtraTime(10);
    saveState();
    toast(`<i class="fas fa-stopwatch ml-1"></i> ${faNum(10)} ثانیه به زمانت اضافه شد`);
    SFX.coin();
  }
  
  // ===== Setup Sheet =====
  function openSetupSheet(){
    const cWrap=$('#cat-wrap'); const dWrap=$('#diff-wrap');
    cWrap.innerHTML=''; dWrap.innerHTML='';
    let selCat='همه', selDiff='آسان';
    ['همه',...cats].forEach(c=>{
      const b=document.createElement('button');
      b.className='w-full py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20';
      if (c === selCat) b.classList.add('selected-setup-item');
      b.textContent=c; b.dataset.val=c; cWrap.appendChild(b);
    });
    ['همه',...diffs].forEach(d=>{
      const b=document.createElement('button');
      b.className='w-full py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20';
      if (d === selDiff) b.classList.add('selected-setup-item');
      b.textContent=d; b.dataset.val=d; dWrap.appendChild(b);
    });
    cWrap.onclick = (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      cWrap.querySelectorAll('button').forEach(x=>x.classList.remove('selected-setup-item'));
      btn.classList.add('selected-setup-item'); selCat=btn.dataset.val;
    };
    dWrap.onclick = (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      dWrap.querySelectorAll('button').forEach(x=>x.classList.remove('selected-setup-item'));
      btn.classList.add('selected-setup-item'); selDiff=btn.dataset.val;
    };
    $('#range-count').oninput = e=> $('#setup-count').textContent=faNum(e.target.value);
  $('#setup-start').onclick=()=>{ closeSheet(); used5050=false; usedSkip=false; usedTimeBoost=false; startQuiz({cat:selCat,diff:selDiff,count:+$('#range-count').value}); navTo('quiz'); };
  $('#setup-duel')?.addEventListener('click', ()=>{
    logEvent('open_duel_from_setup');
    closeSheet();
    navTo('duel');
  });
    openSheet();
  }
  function openSheet(){ $('#sheet-setup').classList.add('show'); }
  function closeSheet(){ $('#sheet-setup').classList.remove('show'); }
  
  // ===== Notifications =====
  function renderNotifications(){
    const list = $('#notif-list'); list.innerHTML='';
    State.notifications.forEach(n=>{
      const row=document.createElement('div'); row.className='bg-white/10 border border-white/20 rounded-xl px-4 py-3';
      row.innerHTML=`<div class="font-bold mb-1">${n.text}</div><div class="text-xs opacity-80">${n.time}</div>`;
      list.appendChild(row);
    });
    $('#notif-dot').style.display = 'none';
  }
  
  // ===== Share =====
  function shareResult(){
    const ok = State.quiz.results.filter(r=>r.ok).length, total=State.quiz.results.length;
    const text = `من در Quiz WebApp Pro ${faNum(ok)}/${faNum(total)} پاسخ درست دادم و ${faNum(State.quiz.sessionEarned)} امتیاز گرفتم!`;
    const url = `https://t.me/share/url?url=${encodeURIComponent('https://t.me/your_bot')}&text=${encodeURIComponent(text)}`;
    try{ 
      if (navigator.share) {
        navigator.share({
          title: 'نتیجه مسابقه',
          text: text,
          url: 'https://t.me/your_bot'
        });
      } else {
        window.open(url,'_blank'); 
      }
    }catch{ navigator.clipboard.writeText(text); toast('نتیجه کپی شد'); }
  }
  
  // ===== Support & Advertisers =====
  function renderSupportTickets() {
    const ticketsList = $('#tickets-list');
    ticketsList.innerHTML = '<div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text"></div>';
    
    // Simulate loading tickets
    setTimeout(() => {
      ticketsList.innerHTML = `
        <div class="ticket-item">
          <div class="flex justify-between items-start mb-1">
            <div class="font-bold">مشکل در پرداخت</div>
            <span class="ticket-status status-pending">در حال بررسی</span>
          </div>
          <div class="text-xs opacity-70 mb-2">۱۴۰۲/۰۵/۱۰</div>
          <div class="text-sm">پرداخت انجام شد اما سکه‌ها اضافه نشدند...</div>
        </div>
        <div class="ticket-item">
          <div class="flex justify-between items-start mb-1">
            <div class="font-bold">پیشنهاد برای سوالات</div>
            <span class="ticket-status status-closed">بسته شده</span>
          </div>
          <div class="text-xs opacity-70 mb-2">۱۴۰۲/۰۴/۲۵</div>
          <div class="text-sm">پیشنهاد اضافه کردن دسته سوالات جدید...</div>
        </div>
      `;
    }, 1000);
  }
  
  // ===== Events =====
  // Delegate wallet package purchase buttons to handle re-renders
  $('#pkg-grid')?.addEventListener('click', (e) => {
    const btn = e.target.closest('.buy-pkg');
    if (!btn) return;
    e.preventDefault();
    showPaymentModal(btn.dataset.id);
  });
  $('#btn-play')?.addEventListener('click', openSetupSheet);
  $('#setup-close')?.addEventListener('click', closeSheet);
  $('#btn-daily')?.addEventListener('click', startDaily);
  $('#btn-back-lb')?.addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-back-shop')?.addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-quit')?.addEventListener('click', ()=>{
    State.duelOpponent = null;
    $('#duel-banner').classList.add('hidden');
    navTo('dashboard');
  });
  $('#btn-claim-streak')?.addEventListener('click', claimStreak);
  $('#btn-invite')?.addEventListener('click', ()=>{
    const link=`https://t.me/share/url?url=${encodeURIComponent('https://t.me/your_bot?start=ref_'+State.user.id)}&text=${encodeURIComponent('بیا تو مسابقه!')}`;
    try{
      if (navigator.share) {
        navigator.share({
          title: 'دعوت به مسابقه',
          text: 'بیا تو مسابقه!',
          url: `https://t.me/your_bot?start=ref_${State.user.id}`
        });
      } else {
        window.open(link,'_blank');
      }
    }catch{ navigator.clipboard.writeText(link); toast('<i class="fas fa-check-circle ml-2"></i>لینک کپی شد'); }
  });
  $('#btn-advertisers')?.addEventListener('click', ()=>{
    navTo('support');
    document.querySelector('.support-tab[data-tab="advertiser"]')?.click();
  });
  // Delegate shop item purchases to handle dynamic re-renders
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-buy]');
    if (!btn) return;
    buy(btn.dataset.buy);
  });
  $$('nav [data-tab]').forEach(b=> b.addEventListener('click', e=>{
    const tab=e.currentTarget.dataset.tab; if(tab==='quiz'){ openSetupSheet(); } else navTo(tab);
  }));
  $('#btn-settings')?.addEventListener('click', ()=>{
    $('#set-sound').checked = !!State.settings.sound;
    $('#set-haptics').checked = !!State.settings.haptics;
    $('#set-block-duels').checked = !!State.settings.blockDuels;
    $('#set-theme').checked = (State.theme==='night');
    openModal('#modal-settings');
  });
  $('#btn-theme')?.addEventListener('click', ()=>{
    const next = (State.theme==='ocean')?'night':'ocean';
    State.theme=next; document.documentElement.setAttribute('data-theme', next); saveState();
  });
  $('#btn-notify')?.addEventListener('click', ()=>{ renderNotifications(); openModal('#modal-notify'); });
  $('[data-close="#modal-settings"]')?.addEventListener('click', ()=>closeModal('#modal-settings'));
  $('[data-close="#modal-notify"]')?.addEventListener('click', ()=>closeModal('#modal-notify'));
  $('#btn-edit-profile')?.addEventListener('click', ()=>{
    $('#inp-name').value = State.user.name;
    const sel = $('#sel-province');
    populateProvinceOptions(sel, 'انتخاب استان');
    if(State.user.province){
      sel.value = State.user.province;
    }
    sel.disabled = true;
    const currentGroupName = getUserGroup()?.name || State.user.group || '—';
    $('#lbl-group').textContent = currentGroupName || '—';
    $('#inp-avatar').value = '';
    openModal('#modal-profile');
  });
  $('[data-close="#modal-profile"]')?.addEventListener('click', ()=>closeModal('#modal-profile'));
  $('#btn-save-profile')?.addEventListener('click', ()=>{
    const n = $('#inp-name').value.trim();
    if(n) State.user.name = n;

    // استان قابل تغییر نیست، بنابراین مقدار آن ذخیره نمی‌شود

    const file = $('#inp-avatar').files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = () => { State.user.avatar = reader.result; finish(); };
      reader.readAsDataURL(file);
    } else {
      finish();
    }

    function finish(){
      saveState();
      renderHeader();
      renderDashboard();
      closeModal('#modal-profile');
      toast('ذخیره شد ✅');
    }
  });
  $('#btn-confirm-province')?.addEventListener('click', () => {
    const p = $('#first-province').value;
    if(!p){ toast('لطفاً استان خود را انتخاب کنید'); return; }
    State.user.province = p;
    saveState();
    renderDashboard();
    closeModal('#modal-province-select');
    toast('استان ثبت شد ✅');
  });
  $('#btn-clear')?.addEventListener('click', ()=>{ if(confirm('همهٔ داده‌ها حذف شود؟')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });
  
  // Leaderboard Tabs
  $$('.leaderboard-tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      e.preventDefault();
      $$('.leaderboard-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      $$('.lb-content').forEach(content => content.classList.add('hidden'));
      $(`#lb-${tab.dataset.tab}`)?.classList.remove('hidden');
    });
  });
  
  // Match Types
  $$('.match-type-card').forEach(card => {
    card.addEventListener('click', () => {
      const matchType = card.dataset.match;
      if (matchType === 'duel') navTo('duel');
      else if (matchType === 'province') openModal('#modal-province-soon');
      else if (matchType === 'group') navTo('group');
    });
  });
  
  // Duel Friends list
  const duelFriends = [
    { id: 1, name: 'علی رضایی', score: 12450, avatar: 'https://i.pravatar.cc/60?img=3' },
    { id: 2, name: 'سارا محمدی', score: 9800, avatar: 'https://i.pravatar.cc/60?img=5' },
    { id: 3, name: 'رضا قاسمی', score: 15200, avatar: 'https://i.pravatar.cc/60?img=8' },
    { id: 4, name: 'مریم احمدی', score: 7650, avatar: 'https://i.pravatar.cc/60?img=11' }
  ];

  const randomPool = [
    { id: 5, name: 'حسین کریمی', score: 13200, avatar: 'https://i.pravatar.cc/60?img=12' },
    { id: 6, name: 'نگار موسوی', score: 9100, avatar: 'https://i.pravatar.cc/60?img=13' },
    { id: 7, name: 'کامران علیپور', score: 10100, avatar: 'https://i.pravatar.cc/60?img=14' }
  ];

  function renderDuelFriends(){
    const list = $('#duel-friends-list');
    if(!list) return;
    list.innerHTML = '';
    if(duelFriends.length === 0){
      list.innerHTML = '<div class="glass rounded-2xl p-4 text-sm opacity-80 text-center">فعلاً دوستی برای نبرد در دسترس نیست.</div>';
      return;
    }
    duelFriends.forEach(friend => {
      const card = document.createElement('div');
      card.className = 'duel-opponent glass rounded-2xl p-4 flex items-center justify-between';
      card.innerHTML = `
        <div class="duel-opponent-info flex items-center gap-3 flex-1">
          <img src="${friend.avatar}" class="w-12 h-12 rounded-full border-2 border-white/30" alt="opponent">
          <div>
            <div class="font-bold">${friend.name}</div>
            <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-star text-yellow-300"></i><span>امتیاز: ${faNum(friend.score)}</span></div>
          </div>
        </div>
        <div class="duel-opponent-action">
          <button class="btn btn-duel text-sm w-auto px-4" data-id="${friend.id}" aria-label="شروع نبرد با ${friend.name}">چالش</button>
        </div>`;
      list.appendChild(card);
    });
    list.querySelectorAll('button[data-id]').forEach(btn => {
      btn.addEventListener('click', () => challengeFriend(parseInt(btn.dataset.id)));
    });
  }

  function challengeFriend(id){
    const friend = duelFriends.find(f => f.id === id);
    if(!friend) return;
    logEvent('duel_challenge', { opponent: friend.name });
    const started = startDuelMatch(friend);
    if(started){
      const idx = duelFriends.findIndex(f => f.id === friend.id);
      if(idx > 0){
        const [item] = duelFriends.splice(idx,1);
        duelFriends.unshift(item);
        renderDuelFriends();
      }
      toast(`نبرد با ${friend.name} شروع شد!`);
    }
  }

  function startDuelMatch(opponent){
    if(!useGameResource('duels')){
      toast('به محدودیت نبرد تن‌به‌تن امروز رسیدی');
      logEvent('duel_limit_reached', { opponent: opponent?.name });
      return false;
    }
    State.duelOpponent = opponent;
    used5050=false; usedSkip=false; usedTimeBoost=false;
    startQuiz({cat:'عمومی', diff:'متوسط', count:5});
    logEvent('duel_start', { opponent: opponent.name });
    navTo('quiz');
    return true;
  }

  renderDuelFriends();

  // Random Opponent Matching
  $('#btn-duel-random')?.addEventListener('click', async () => {
    const btn = $('#btn-duel-random');
    if(!btn) return;
    btn.disabled = true;
    vibrate(30);
    toast('در حال جستجوی حریف تصادفی...');
    await new Promise(res => setTimeout(res, 1500));
    const opponent = randomPool[Math.floor(Math.random()*randomPool.length)];
    toast(`حریف ${opponent.name} پیدا شد!`);
    logEvent('duel_random_found', { opponent: opponent.name });
    const started = startDuelMatch(opponent);
    if(started){
      const existingIdx = duelFriends.findIndex(f => f.id === opponent.id);
      if(existingIdx >= 0){ duelFriends.splice(existingIdx,1); }
      duelFriends.unshift(opponent);
      renderDuelFriends();
    }
    btn.disabled = false;
  });

  // Invite Link Copy
  $('#btn-duel-link')?.addEventListener('click', async () => {
    const inviter = State?.user?.name || 'guest';
    const link = `${location.origin}${location.pathname}?duel_invite=${encodeURIComponent(inviter)}`;
    try {
      if (navigator.share) {
        await navigator.share({
          title: 'دعوت به نبرد',
          text: `${inviter} شما را به نبرد دعوت کرده است!`,
          url: link
        });
        toast('دعوت ارسال شد ✅');
      } else if (navigator.clipboard) {
        await navigator.clipboard.writeText(link);
        toast('لینک دعوت کپی شد ✅');
      } else {
        prompt('این لینک را کپی کنید:', link);
      }
    } catch {
      try {
        await navigator.clipboard.writeText(link);
        toast('لینک دعوت کپی شد ✅');
      } catch {
        prompt('این لینک را کپی کنید:', link);
      }
    }
    logEvent('duel_invite_link');
  });

  // Province Selection
  $$('[data-province]').forEach(card => {
    card.addEventListener('click', () => {
      const provinceId = card.dataset.province;
      const province = State.provinces.find(p => p.id === provinceId);
      toast(`ثبت‌نام در مسابقه ${province.name} با موفقیت انجام شد!`);
      
      // Log analytics
      logEvent('province_match_join', { province: province.name });
    });
  });
  
  // Group Selection
function renderGroupSelect() {
  const list = $('#group-select-list');
  if (!list) return;
  list.innerHTML = '';
  
  // Hide create button if user already has a group
  const createBtn = $('#btn-create-group');
  if (createBtn) {
    createBtn.style.display = isUserInGroup() ? 'none' : 'block';
  }
  
  // Add user's current group info if they have one
  if (isUserInGroup()) {
    const userGroup = getUserGroup() || State.groups.find(g => g.name === State.user.group);
    if (userGroup) {
      const isAdmin = userGroup.admin === State.user.name;
      const infoCard = document.createElement('div');
      infoCard.className = 'glass rounded-2xl p-4 mb-4 text-center';
      infoCard.innerHTML = `
        <div class="text-lg font-bold mb-2">گروه فعلی شما</div>
        <div class="text-xl font-bold text-purple-300 mb-2">${userGroup.name}</div>
        <div class="text-sm opacity-80 mb-3">شما ${isAdmin ? 'مدیر' : 'عضو'} این گروه هستید</div>
        <button id="btn-leave-delete-group" class="btn ${isAdmin ? 'btn-duel' : 'btn-secondary'} w-full">
          <i class="fas fa-${isAdmin ? 'trash' : 'sign-out-alt'} ml-2"></i>
          ${isAdmin ? 'حذف گروه' : 'خروج از گروه'}
        </button>
      `;
      list.appendChild(infoCard);
      
      // Add event listener for leave/delete button
      $('#btn-leave-delete-group')?.addEventListener('click', () => {
        const confirmMsg = isAdmin 
          ? 'آیا از حذف گروه اطمینان دارید؟ این عمل غیرقابل بازگشت است.'
          : 'آیا از خروج از گروه اطمینان دارید؟';
        
        if (confirm(confirmMsg)) {
          if (isAdmin) {
            deleteGroup(userGroup.id);
          } else {
            leaveGroup(userGroup.id);
          }
        }
      });
      
      return; // Don't show other groups if user is already in one
    }
  }
  
  // Show available groups only if user is not in any group
  State.groups.forEach(g => {
    const card = document.createElement('div');
    card.className = 'location-card';
    card.innerHTML = `
      <div class="location-icon group-icon"><i class="fas fa-users"></i></div>
      <div class="flex-1"><div class="font-bold">${g.name}</div>
        <div class="text-sm opacity-80 flex items-center gap-1"><i class="fas fa-user"></i><span>مدیر: ${g.admin}</span></div>
      </div>
      <div class="text-sm font-bold text-purple-300"><i class="fas fa-trophy"></i> ${faNum(g.score)}</div>`;
    card.addEventListener('click', () => showGroupDetail(g));
    list.appendChild(card);
  });
}




function deleteGroup(groupId) {
  const groupIndex = State.groups.findIndex(g => g.id === groupId);
  if (groupIndex === -1) return;
  
  const group = State.groups[groupIndex];
  
  // Remove group from state
  State.groups.splice(groupIndex, 1);
  
  // Clear user's group assignment
  State.user.group = '';
  
  saveState();
  renderGroupSelect();
  renderDashboard();
  
  toast('<i class="fas fa-check-circle ml-2"></i> گروه با موفقیت حذف شد');
  logEvent('group_deleted', { group: group.name });
}

function leaveGroup(groupId) {
  const group = State.groups.find(g => g.id === groupId);
  if (!group) return;
  
  // Remove user from member list
  group.memberList = group.memberList?.filter(m => m !== State.user.name) || [];
  group.members = Math.max(0, group.members - 1);
  
  // Clear user's group assignment
  State.user.group = '';
  
  saveState();
  renderGroupSelect();
  renderDashboard();
  
  toast('<i class="fas fa-check-circle ml-2"></i> از گروه خارج شدید');
  logEvent('group_left', { group: group.name });
}

  renderGroupSelect();
  $('#btn-create-group')?.addEventListener('click', openCreateGroup);
  $('#btn-view-group')?.addEventListener('click', () => {
    const myGroup = getUserGroup() || State.groups.find(g => g.name === State.user.group);
    if (myGroup) {
      showGroupDetail(myGroup);
    } else {
      renderGroupSelect();
      navTo('group');
    }
  });
  $('#btn-go-groups')?.addEventListener('click', () => {
    renderGroupSelect();
    navTo('group');
    logEvent('cta_group_browse');
  });
  $('#btn-create-group-cta')?.addEventListener('click', () => {
    renderGroupSelect();
    navTo('group');
    openCreateGroup();
    logEvent('cta_group_create');
  });
  
  // Back Buttons for New Pages
  $('#btn-back-duel')?.addEventListener('click', () => navTo('dashboard'));
  $('#btn-back-province')?.addEventListener('click', () => navTo('dashboard'));
  $('#btn-back-group')?.addEventListener('click', () => navTo('dashboard'));
  $('#btn-back-pass-missions')?.addEventListener('click', () => navTo('dashboard'));
  $('#btn-back-referral')?.addEventListener('click', () => navTo('dashboard'));
  $('#btn-back-support')?.addEventListener('click', () => navTo('dashboard'));
  
  // Wallet/VIP navigation
  $('#btn-open-wallet')?.addEventListener('click', ()=>navTo('wallet'));
  $('#btn-open-wallet-2')?.addEventListener('click', ()=>navTo('wallet'));
  $('#btn-open-vip')?.addEventListener('click', ()=>navTo('vip'));
  $('#go-wallet')?.addEventListener('click', ()=>navTo('wallet'));
  $('#go-vip')?.addEventListener('click', ()=>navTo('vip'));
  $('#btn-back-wallet')?.addEventListener('click', ()=>navTo('shop'));
  $('#btn-back-vip')?.addEventListener('click', ()=>navTo('shop'));
  
  // Leaderboard CTA
  $('#btn-view-leaderboard')?.addEventListener('click', ()=>{
    navTo('leaderboard');
  });
  
  // VIP purchase buttons
  $('#buy-vip-lite')?.addEventListener('click', ()=> startPurchaseVip('lite'));
  $('#buy-vip-pro')?.addEventListener('click', ()=> startPurchaseVip('pro'));
  
  // Detail Popup Events
  $('#detail-close')?.addEventListener('click', closeDetailPopup);
  $('#detail-overlay')?.addEventListener('click', closeDetailPopup);

  // Close modals (receipt)
  $$('[data-close="#modal-receipt"]').forEach(b=> b.addEventListener('click', ()=>closeModal('#modal-receipt')));
  $$('[data-close="#modal-pay-confirm"]').forEach(b=> b.addEventListener('click', ()=>closeModal('#modal-pay-confirm')));
  $$('[data-close="#modal-province-soon"]').forEach(b=> b.addEventListener('click', ()=>closeModal('#modal-province-soon')));

  // Game Limits CTAs
  $('#btn-buy-vip-limit')?.addEventListener('click', () => {
    navTo('vip');
  });

  $('#btn-reset-match-limit')?.addEventListener('click', () => {
    if (State.lives <= 0) {
      toast('کلید کافی نیست');
      return;
    }
    if (Server.limits.matches.used === 0) {
      toast('نیازی به ریست نیست');
      return;
    }
    State.lives -= 1;
    renderTopBars();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const t = today.getTime();
    Server.limits.matches.used = 0;
    Server.limits.matches.lastReset = t;
    updateLimitsUI();
    checkLimitsReached();
    saveState();
    toast('<i class="fas fa-check-circle ml-2"></i>محدودیت کوییز روزانه ریست شد');
  });

  $('#btn-reset-duel-limit')?.addEventListener('click', () => {
    if (State.lives <= 0) {
      toast('کلید کافی نیست');
      return;
    }
    if (Server.limits.duels.used === 0) {
      toast('نیازی به ریست نیست');
      return;
    }
    State.lives -= 1;
    renderTopBars();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const t = today.getTime();
    Server.limits.duels.used = 0;
    Server.limits.duels.lastReset = t;
    updateLimitsUI();
    checkLimitsReached();
    saveState();
    toast('<i class="fas fa-check-circle ml-2"></i>محدودیت نبرد ریست شد');
  });

  $('#btn-reset-group-limit')?.addEventListener('click', () => {
    if (State.lives <= 0) {
      toast('کلید کافی نیست');
      return;
    }
    if (Server.limits.groupBattles.used === 0) {
      toast('نیازی به ریست نیست');
      return;
    }
    State.lives -= 1;
    renderTopBars();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const t = today.getTime();
    Server.limits.groupBattles.used = 0;
    Server.limits.groupBattles.lastReset = t;
    updateLimitsUI();
    checkLimitsReached();
    saveState();
    toast('<i class="fas fa-check-circle ml-2"></i>محدودیت نبرد گروهی ریست شد');
  });

  $('#btn-reset-limits')?.addEventListener('click', async () => {
    if (State.lives <= 0) {
      toast('کلید کافی نیست');
      return;
    }
    const btn = $('#btn-reset-limits');
    btn.disabled = true;
    try {
      const res = await fetch('/api/limits/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      const data = await res.json();
      if (res.ok && data?.success) {
        State.lives -= 1;
        renderTopBars();
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const t = today.getTime();
        Server.limits.matches.used = 0;
        Server.limits.duels.used = 0;
        Server.limits.lives.used = 0;
        Server.limits.groupBattles.used = 0;
        Server.limits.energy.used = 0;
        Server.limits.matches.lastReset = t;
        Server.limits.duels.lastReset = t;
        Server.limits.lives.lastReset = t;
        Server.limits.groupBattles.lastReset = t;
        Server.limits.energy.lastReset = t;
        updateLimitsUI();
        checkLimitsReached();
        saveState();
        toast('<i class="fas fa-check-circle ml-2"></i>محدودیت‌ها ریست شد');
      } else {
        toast(data?.message || 'خطا در ریست محدودیت');
      }
    } catch {
      toast('خطا در ارتباط با سرور');
    } finally {
      btn.disabled = false;
    }
  });
  
  // Province Ranking
  $('#btn-view-ranking')?.addEventListener('click', () => {
    navTo('leaderboard');
    document.querySelector('.leaderboard-tab[data-tab="province"]')?.click();
  });
  
  // Referral
  $('#btn-copy-referral')?.addEventListener('click', () => {
    navigator.clipboard.writeText(State.referral.code);
    toast('<i class="fas fa-check-circle ml-2"></i>کد دعوت کپی شد!');
  });
  
  $('#btn-share-referral')?.addEventListener('click', () => {
    const link = `https://t.me/your_bot?start=ref_${State.user.id}`;
    const text = `با کد دعوت من در Quiz WebApp Pro ثبت‌نام کن و جایزه بگیر! کد: ${State.referral.code}`;
    
    try {
      if (navigator.share) {
        navigator.share({
          title: 'دعوت به Quiz WebApp Pro',
          text: text,
          url: link
        });
      } else {
        window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`, '_blank');
      }
    } catch {
      navigator.clipboard.writeText(link);
      toast('<i class="fas fa-check-circle ml-2"></i>لینک کپی شد!');
    }
  });
  
  // Support & Advertisers Tabs
  $$('.support-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      $$('.support-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      $$('.tab-content').forEach(content => content.classList.add('hidden'));
      $(`#${tab.dataset.tab}-content`).classList.remove('hidden');
      
      if (tab.dataset.tab === 'support') {
        renderSupportTickets();
      }
    });
  });
  
  // Support Form
  $('#support-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = $('#support-name').value.trim();
    const mobile = $('#support-mobile').value.trim();
    const message = $('#support-message').value.trim();
    
    if (!name || !mobile || !message) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>لطفاً تمام فیلدها را پر کنید');
      return;
    }
    
    // Validate mobile number (simple validation)
    if (!/^09[0-9]{9}$/.test(mobile)) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>شماره موبایل نامعتبر است');
      return;
    }
    
    // Show loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> در حال ارسال...';
    
    try {
      // Simulate API call
      await wait(1500);
      
      // In a real app, this would be:
      // const result = await Net.jpost('/api/support/tickets', { name, mobile, message });
      
      // Show success message
      toast('<i class="fas fa-check-circle ml-2"></i>تیکت شما با موفقیت ارسال شد');
      
      // Reset form
      e.target.reset();
      
      // Refresh tickets list
      renderSupportTickets();
      
      // Log analytics
      logEvent('support_ticket_created', { category: 'support' });
    } catch (error) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>خطا در ارسال تیکت. لطفاً دوباره تلاش کنید');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  });
  
  // Advertiser Form
  $('#advertiser-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const placement = $('#ad-placement').value;
    const budget = $('#ad-budget').value;
    const provinces = Array.from($('#ad-provinces').selectedOptions).map(option => option.value);
    const startDate = $('#ad-start').value;
    const endDate = $('#ad-end').value;
    const creative = $('#ad-creative').value.trim();
    const landing = $('#ad-landing').value.trim();
    
    if (!placement || !budget || !provinces.length || !startDate || !endDate || !creative || !landing) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>لطفاً تمام فیلدها را پر کنید');
      return;
    }
    
    // Validate dates
    if (new Date(startDate) >= new Date(endDate)) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>تاریخ پایان باید بعد از تاریخ شروع باشد');
      return;
    }
    
    // Show loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> در حال ارسال...';
    
    try {
      // Simulate API call
      await wait(1500);

      // In a real app, this would be an API call
      const ad = { placement, budget: Number(budget), provinces, startDate, endDate, creative, landing };
      if(!State.ads[placement]) State.ads[placement] = [];
      State.ads[placement].push(ad);
      saveState();

      // Show success message
      toast('<i class="fas fa-check-circle ml-2"></i>درخواست تبلیغ شما با موفقیت ذخیره شد');

      // Reset form
      e.target.reset();

      // Refresh ads
      AdManager.refreshAll();

      // Log analytics
      logEvent('ad_request_submitted', { category: 'advertiser', placement, budget });
    } catch (error) {
      toast('<i class="fas fa-exclamation-circle ml-2"></i>خطا در ارسال درخواست. لطفاً دوباره تلاش کنید');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  });
  
  // Share Result
  $('#btn-share')?.addEventListener('click', shareResult);
  $('#btn-again')?.addEventListener('click', openSetupSheet);
  $('#btn-back-results')?.addEventListener('click', ()=>{
    State.duelOpponent = null;
    $('#duel-banner').classList.add('hidden');
    navTo('dashboard');
  });
  
  // Lifeline buttons
  $('#life-5050')?.addEventListener('click', life5050);
  $('#life-skip')?.addEventListener('click', lifeSkip);
  $('#life-pause')?.addEventListener('click', lifePause);
  
  // Active Match Actions
  $$('.match-action').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const matchName = e.currentTarget.closest('.active-match-item').querySelector('.match-name').textContent;
      toast(`در ${matchName} ثبت‌نام شدید!`);
    });
  });
  
  // ===== Init =====
async function init(){
    const loading = $('#loading');
    try{
      // Fallback provinces in case JSON fails to load
      const fallbackProvinces = [
        { id: '1', name: 'آذربایجان شرقی', score: 15000, members: 120, region: 'شمال غربی' },
        { id: '2', name: 'آذربایجان غربی', score: 14500, members: 110, region: 'شمال غربی' },
        { id: '3', name: 'اردبیل', score: 12000, members: 85, region: 'شمال غربی' },
        { id: '4', name: 'اصفهان', score: 18000, members: 180, region: 'مرکزی' },
        { id: '5', name: 'البرز', score: 16000, members: 140, region: 'مرکزی' },
        { id: '6', name: 'ایلام', score: 11000, members: 70, region: 'غربی' },
        { id: '7', name: 'بوشهر', score: 12500, members: 90, region: 'جنوبی' },
        { id: '8', name: 'تهران', score: 22000, members: 250, region: 'مرکزی' },
        { id: '9', name: 'چهارمحال و بختیاری', score: 11500, members: 75, region: 'مرکزی' },
        { id: '10', name: 'خراسان جنوبی', score: 10500, members: 65, region: 'شرقی' },
        { id: '11', name: 'خراسان رضوی', score: 17000, members: 160, region: 'شرقی' },
        { id: '12', name: 'خراسان شمالی', score: 10000, members: 60, region: 'شرقی' },
        { id: '13', name: 'خوزستان', score: 16500, members: 150, region: 'جنوب غربی' },
        { id: '14', name: 'زنجان', score: 12000, members: 80, region: 'شمال غربی' },
        { id: '15', name: 'سمنان', score: 11000, members: 70, region: 'مرکزی' },
        { id: '16', name: 'سیستان و بلوچستان', score: 13000, members: 95, region: 'جنوب شرقی' },
        { id: '17', name: 'فارس', score: 17500, members: 165, region: 'جنوبی' },
        { id: '18', name: 'قزوین', score: 12500, members: 85, region: 'مرکزی' },
        { id: '19', name: 'قم', score: 13500, members: 100, region: 'مرکزی' },
        { id: '20', name: 'کردستان', score: 14000, members: 105, region: 'غربی' },
        { id: '21', name: 'کرمان', score: 15000, members: 120, region: 'جنوب شرقی' },
        { id: '22', name: 'کرمانشاه', score: 13500, members: 100, region: 'غربی' },
        { id: '23', name: 'کهگیلویه و بویراحمد', score: 10500, members: 65, region: 'جنوب غربی' },
        { id: '24', name: 'گلستان', score: 12000, members: 80, region: 'شمالی' },
        { id: '25', name: 'گیلان', score: 15500, members: 125, region: 'شمالی' },
        { id: '26', name: 'لرستان', score: 12500, members: 85, region: 'غربی' },
        { id: '27', name: 'مازندران', score: 16000, members: 135, region: 'شمالی' },
        { id: '28', name: 'مرکزی', score: 13000, members: 95, region: 'مرکزی' },
        { id: '29', name: 'هرمزگان', score: 14000, members: 105, region: 'جنوبی' },
        { id: '30', name: 'همدان', score: 13000, members: 90, region: 'غربی' },
        { id: '31', name: 'یزد', score: 14500, members: 110, region: 'مرکزی' }
      ];

      try{
        // Try to load provinces from JSON file
        const resp = await fetch('./data/provinces.json');
        if(resp.ok){
          const loadedProvinces = await resp.json();
          if(loadedProvinces && loadedProvinces.length > 0){
            State.provinces = loadedProvinces;
          } else {
            State.provinces = fallbackProvinces;
          }
        } else {
          State.provinces = fallbackProvinces;
        }
      }catch(err){
        console.warn('Failed to load provinces from JSON, using fallback', err);
        State.provinces = fallbackProvinces;
      }

      // Ensure provinces are populated
      if(!State.provinces || State.provinces.length === 0){
        State.provinces = fallbackProvinces;
      }

      renderHeader(); renderDashboard(); navTo('dashboard');

      // Check if user needs to select province
      if(!State.user.province){
        const sel = $('#first-province');
        if(sel){
          populateProvinceOptions(sel, 'استان خود را انتخاب کنید');
          
          // Double-check that options were added
          if(sel.options.length <= 1){ // Only placeholder
            // Manually add provinces if populateProvinceOptions failed
            State.provinces.forEach(p => {
              const option = document.createElement('option');
              option.value = p.name;
              option.textContent = p.name;
              sel.appendChild(option);
            });
          }
          
          openModal('#modal-province-select');
        }
      }

      // Start daily reset timer
      checkDailyReset();
      setInterval(checkDailyReset, 1000);

      // Server bootstrap: wallet + subscription then ads
      await Promise.all([refreshWallet(), refreshSubscription()]);
      renderHeader(); renderDashboard();
      AdManager.refreshAll();

      // Set up ESC key to close payment modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && $('#modal-payment').classList.contains('show')) {
          closePaymentModal();
        }
      });

      // Log session start
      logEvent('session_start', {
        screen_width: window.screen.width,
        screen_height: window.screen.height,
        user_agent: navigator.userAgent
      });

      // Banner should be present from first print
      if(!localStorage.getItem(STORAGE_KEY)){ setTimeout(()=>toast('برای شروع روی «شروع کوییز» بزن ✨'), 800); }

      // Re-render wallet display if user changes connectivity
      window.addEventListener('online', ()=>{ $('#wallet-offline')?.classList.add('hidden'); AdManager.refreshAll(); });
      window.addEventListener('offline', ()=>{ $('#wallet-offline')?.classList.remove('hidden'); });

      // Show popup ad on open
      AdManager.maybeShowInterstitial('app_open');
    }catch(err){
      console.error('Initialization failed', err);
      toast('خطا در راه‌اندازی برنامه');
    }finally{
      loading.classList.add('hidden');
    }
  }
  init();


  



  
  </script>
</body>
</html>
