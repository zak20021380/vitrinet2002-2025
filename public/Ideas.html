<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Quiz WebApp Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{ 
      --brand1:#3b82f6; 
      --brand2:#06b6d4; 
      --brand3:#10b981;
      --accent1:#fde047;
      --accent2:#fb923c;
      --accent3:#a78bfa;
      --accent4:#ec4899;
    }
    *{ font-family: 'Vazirmatn', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body{ 
      background: radial-gradient(1200px 800px at 80% -10%, rgba(255,255,255,0.25), transparent 50%),
                   radial-gradient(1000px 700px at 0% 100%, rgba(255,255,255,0.15), transparent 50%),
                   linear-gradient(135deg, var(--brand1), var(--brand2), var(--brand3));
      min-height: 100vh;
      overflow-x: hidden;
    }
    .glass{ 
      background: rgba(255,255,255,0.15); 
      backdrop-filter: blur(20px); 
      -webkit-backdrop-filter: blur(20px); 
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
    }
    .glass-dark{ 
      background: rgba(0,0,0,0.2); 
      backdrop-filter: blur(20px); 
      -webkit-backdrop-filter: blur(20px); 
      border: 1px solid rgba(255,255,255,0.15);
    }
    .btn{ 
      @apply w-full py-4 rounded-2xl font-bold shadow-lg active:scale-[0.98] transition-all duration-300 transform hover:scale-[1.02];
    }
    .btn-primary{ 
      background: linear-gradient(135deg, var(--accent1), var(--accent2)); 
      color:#111827;
      box-shadow: 0 4px 15px rgba(251, 146, 60, 0.4);
    }
    .btn-secondary{ 
      background: linear-gradient(135deg, var(--accent3), var(--accent4)); 
      color:#fff;
      box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
    }
    .btn-tertiary{ 
      background: linear-gradient(135deg, #60a5fa, #6366f1); 
      color:#fff;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
    .safe{ padding-bottom: env(safe-area-inset-bottom); }
    .ring-anim{ transition: stroke-dashoffset .2s linear; }
    /* Choice states */
    .choice{ 
      @apply w-full text-right px-5 py-4 rounded-2xl border border-white/20 bg-white/10 hover:bg-white/20 transition-all duration-300 flex items-center gap-3 transform hover:scale-[1.02];
    }
    .choice.correct{ 
      @apply bg-green-500/20 border-green-400/60;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    }
    .choice.wrong{ 
      @apply bg-rose-500/20 border-rose-400/60;
      box-shadow: 0 0 20px rgba(244, 63, 94, 0.3);
    }
    .chip{ 
      @apply inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-white/10 border border-white/20;
    }
    .divider{ 
      @apply h-px w-full bg-white/20 my-3;
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.3);
    }
    .gradient-text {
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .nav-item {
      position: relative;
      transition: all 0.3s ease;
    }
    .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      border-radius: 3px 3px 0 0;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-up {
      animation: slideUp 0.4s ease forwards;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .bounce {
      animation: bounce 1s ease infinite;
    }
    .achievement-unlock {
      animation: achievementPulse 0.6s ease;
    }
    @keyframes achievementPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .tab-active {
      background: rgba(255,255,255,0.2);
      border-bottom: 3px solid var(--accent1);
    }
    .category-card {
      transition: all 0.3s ease;
    }
    .category-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: var(--accent1);
      position: absolute;
      animation: confetti-fall 3s linear forwards;
    }
    @keyframes confetti-fall {
      to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
    .progress-ring {
      transform: rotate(-90deg);
    }
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      min-width: 300px;
      text-align: center;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .achievement-badge {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin: 0 auto;
    }
    .locked {
      filter: grayscale(100%);
      opacity: 0.5;
    }
    .sparkle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: sparkle 1.5s linear infinite;
    }
    @keyframes sparkle {
      0% { transform: scale(0) rotate(0deg); opacity: 1; }
      100% { transform: scale(1.5) rotate(180deg); opacity: 0; }
    }
  </style>
</head>
<body class="min-h-screen text-white flex flex-col">
  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50"></div>

  <!-- Header -->
  <header class="glass sticky top-0 z-30 w-full px-4 py-3 flex items-center justify-between shadow-lg">
    <div class="flex items-center gap-3">
      <div class="relative">
        <img id="hdr-avatar" src="https://i.pravatar.cc/80?img=12" class="w-12 h-12 rounded-full border-2 border-white/30 shadow-md" alt="avatar" />
        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
      </div>
      <div>
        <div id="hdr-name" class="font-bold text-lg">Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†</div>
        <div class="text-xs text-white/80 flex items-center gap-1">
          <i class="fas fa-star text-yellow-300"></i>
          <span>Ø§Ù…ØªÛŒØ§Ø²: <span id="hdr-score" class="font-bold">0</span></span>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-settings" class="relative px-3 py-2 rounded-xl bg-white/10 border border-white/20 text-sm hover:bg-white/20 transition-all duration-300">
        <i class="fas fa-cog"></i>
      </button>
      <button id="btn-notify" class="relative px-3 py-2 rounded-xl bg-white/10 border border-white/20 text-sm hover:bg-white/20 transition-all duration-300">
        <i class="fas fa-bell"></i>
        <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs">3</span>
      </button>
    </div>
  </header>

  <!-- Pages container -->
  <main id="pages" class="flex-1 w-full max-w-md mx-auto p-4 space-y-5">
    <!-- DASHBOARD -->
    <section id="page-dashboard" class="space-y-5">
      <!-- Profile Card -->
      <div class="glass rounded-3xl p-6 shadow-xl card-hover">
        <div class="flex items-center gap-4 mb-4">
          <div class="relative">
            <img id="profile-avatar" src="https://i.pravatar.cc/120?img=12" class="w-20 h-20 rounded-full border-4 border-white/30 shadow-lg" alt="avatar" />
            <div class="absolute bottom-0 right-0 w-8 h-8 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center border-2 border-white">
              <i class="fas fa-crown text-white text-sm"></i>
            </div>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <h2 id="profile-name" class="text-2xl font-extrabold">Ø²Ú©ÛŒ</h2>
              <span id="vip-badge" class="chip bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold hidden">VIP</span>
            </div>
            <div class="text-sm text-white/80 flex items-center gap-1 mt-1">
              <i class="fas fa-trophy text-yellow-300"></i>
              <span>Ø±ØªØ¨Ù‡ Ø´Ù…Ø§: <span id="rank" class="font-bold">â€”</span></span>
            </div>
          </div>
          <button id="btn-profile" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-all">
            <i class="fas fa-user"></i>
          </button>
        </div>
        <div class="divider"></div>
        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="glass rounded-2xl p-4 card-hover">
            <div class="text-2xl font-extrabold text-yellow-300" id="stat-score">0</div>
            <div class="text-xs opacity-80 mt-1">Ø§Ù…ØªÛŒØ§Ø²</div>
          </div>
          <div class="glass rounded-2xl p-4 card-hover">
            <div class="text-2xl font-extrabold text-emerald-300" id="stat-coins">0</div>
            <div class="text-xs opacity-80 mt-1">Ø³Ú©Ù‡</div>
          </div>
          <div class="glass rounded-2xl p-4 card-hover">
            <div class="text-2xl font-extrabold text-rose-300" id="stat-lives">3</div>
            <div class="text-xs opacity-80 mt-1">Ø¬Ø§Ù†</div>
          </div>
        </div>
      </div>

      <!-- Daily Challenge -->
      <div class="glass rounded-3xl p-5 card-hover">
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="text-sm opacity-90 flex items-center gap-1">
              <i class="fas fa-calendar-day text-purple-400"></i>
              <span>Ú†Ø§Ù„Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡</span>
            </div>
            <div class="text-xl font-extrabold mt-1">Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø¹Ù„Ù…ÛŒ</div>
          </div>
          <div class="text-center">
            <div class="text-xs opacity-80">Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡</div>
            <div id="daily-timer" class="font-mono font-bold">12:45:30</div>
          </div>
        </div>
        <div class="flex items-center justify-between mt-4">
          <div class="flex items-center gap-2">
            <div class="chip">
              <i class="fas fa-trophy text-yellow-300 ml-1"></i> 100 Ø§Ù…ØªÛŒØ§Ø²
            </div>
            <div class="chip">
              <i class="fas fa-coins text-yellow-300 ml-1"></i> 50 Ø³Ú©Ù‡
            </div>
          </div>
          <button id="btn-daily" class="btn btn-primary w-auto px-5 py-2 text-sm">
            <i class="fas fa-play ml-1"></i> Ø´Ø±ÙˆØ¹
          </button>
        </div>
      </div>

      <!-- Streak & Sponsor -->
      <div class="glass rounded-3xl p-5 card-hover">
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="text-sm opacity-90 flex items-center gap-1">
              <i class="fas fa-fire text-orange-400"></i>
              <span>Ø§Ø³ØªØ±ÛŒÚ© Ø±ÙˆØ²Ø§Ù†Ù‡</span>
            </div>
            <div class="text-2xl font-extrabold"><span id="streak">0</span> Ø±ÙˆØ²</div>
          </div>
          <button id="btn-claim-streak" class="btn btn-primary w-auto px-5 py-2 text-sm pulse">
            <i class="fas fa-gift ml-1"></i> Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø¯Ø§Ø´
          </button>
        </div>
        <div class="w-full h-3 bg-white/15 rounded-full mt-3 overflow-hidden">
          <div id="streak-bar" class="h-3 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
        <div class="text-xs mt-3 opacity-80 flex items-start gap-1">
          <i class="fas fa-info-circle mt-0.5"></i>
          <span>Ù‡Ø± Ø±ÙˆØ² Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†ÛŒ Ù¾Ø§Ø¯Ø§Ø´ Ø¨ÛŒØ´ØªØ± Ù…ÛŒØ´Ù‡. Ø§Ú¯Ù‡ Ø¬Ø§ Ø¨Ù…ÙˆÙ†ÛŒ ØµÙØ± Ù…ÛŒØ´Ù‡ ğŸ˜¬</span>
        </div>
      </div>

      <!-- Achievements Preview -->
      <div class="glass rounded-3xl p-5">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold flex items-center gap-2">
            <i class="fas fa-medal text-yellow-300"></i>
            <span>Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§</span>
          </h3>
          <button id="btn-all-achievements" class="text-sm text-white/80 hover:text-white">
            Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡ <i class="fas fa-chevron-left text-xs mr-1"></i>
          </button>
        </div>
        <div id="achievements-preview" class="grid grid-cols-4 gap-3">
          <!-- Achievements will be loaded here -->
        </div>
      </div>

      <!-- Actions -->
      <div class="space-y-4">
        <button class="btn btn-primary text-lg" id="btn-play">
          <i class="fas fa-gamepad ml-2"></i> Ø´Ø±ÙˆØ¹ Ù…Ø³Ø§Ø¨Ù‚Ù‡
        </button>
        <div class="grid grid-cols-2 gap-4">
          <button class="btn btn-secondary" id="btn-shop">
            <i class="fas fa-shopping-cart ml-2"></i> ÙØ±ÙˆØ´Ú¯Ø§Ù‡
          </button>
          <button class="btn btn-tertiary" id="btn-leaderboard">
            <i class="fas fa-chart-line ml-2"></i> Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯
          </button>
        </div>
        <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2" id="btn-invite">
          <i class="fas fa-user-plus"></i>
          <span>Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù† (+Ø³Ú©Ù‡)</span>
        </button>
      </div>
      <div class="glass rounded-3xl p-4 text-center text-sm">
        <div class="flex items-center justify-center gap-2">
          <i class="fas fa-bolt text-yellow-300"></i>
          <span>Ø§Ø³Ù¾Ø§Ù†Ø³Ø± Ø§Ù…Ø±ÙˆØ²: <span class="font-bold">Ú©Ø§ÙÙ‡ XYZ</span></span>
        </div>
        <div class="mt-2">
          Ú©Ø¯ ØªØ®ÙÛŒÙ: <span class="font-mono bg-white/20 px-2 py-1 rounded">SANANDAJ10</span>
        </div>
      </div>
    </section>

    <!-- CATEGORIES PAGE -->
    <section id="page-categories" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h2 class="text-2xl font-extrabold mb-4 text-center">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡</h2>
        <div class="grid grid-cols-2 gap-4" id="categories-grid">
          <!-- Categories will be loaded here -->
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2" id="btn-back-categories">
        <i class="fas fa-arrow-right"></i>
        <span>Ø¨Ø§Ø²Ú¯Ø´Øª</span>
      </button>
    </section>

    <!-- QUIZ PAGE -->
    <section id="page-quiz" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6 shadow-xl">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2 text-sm">
            <span id="quiz-cat" class="chip">
              <i class="fas fa-folder ml-1"></i> Ø¹Ù…ÙˆÙ…ÛŒ
            </span>
            <span id="quiz-diff" class="chip">
              <i class="fas fa-signal ml-1"></i> Ø¢Ø³ÙˆÙ†
            </span>
          </div>
          <div class="flex items-center gap-2 text-sm">
            <span class="chip">
              <i class="fas fa-heart text-red-400 ml-1"></i> <span id="lives">3</span>
            </span>
            <span class="chip">
              <i class="fas fa-coins text-yellow-300 ml-1"></i> <span id="coins">0</span>
            </span>
          </div>
        </div>
        <div class="mt-4 flex items-center justify-center">
          <div class="relative">
            <svg width="140" height="140" viewBox="0 0 140 140" class="progress-ring">
              <circle cx="70" cy="70" r="64" stroke="rgba(255,255,255,.2)" stroke-width="12" fill="none"/>
              <circle id="timer-ring" cx="70" cy="70" r="64" stroke="url(#gradient)" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="402.124" stroke-dashoffset="0" class="ring-anim"/>
              <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#fde047" />
                  <stop offset="100%" stop-color="#fb923c" />
                </linearGradient>
              </defs>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="text-3xl font-extrabold" id="timer-text">30</div>
            </div>
          </div>
        </div>
        <h3 id="question" class="text-xl font-bold mt-4 leading-8 text-center"></h3>
      </div>
      <div id="choices" class="space-y-4"></div>
      <div class="flex items-center gap-4">
        <button id="btn-quit" class="flex-1 py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2">
          <i class="fas fa-times"></i>
          <span>Ø®Ø±ÙˆØ¬</span>
        </button>
        <button id="btn-continue" class="hidden flex-1 py-4 rounded-2xl bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold flex items-center justify-center gap-2">
          <i class="fas fa-coins"></i>
          <span>Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ 10 Ø³Ú©Ù‡</span>
        </button>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="page-leaderboard" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-2xl font-extrabold flex items-center gap-2">
            <i class="fas fa-trophy text-yellow-300"></i>
            <span>Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯</span>
          </h3>
          <div class="flex items-center gap-2 text-sm">
            <button class="chip tab-active" data-period="weekly">Ù‡ÙØªÚ¯ÛŒ</button>
            <button class="chip" data-period="monthly">Ù…Ø§Ù‡Ø§Ù†Ù‡</button>
            <button class="chip" data-period="all">Ù‡Ù…Ù‡ Ø²Ù…Ø§Ù†</button>
          </div>
        </div>
        <div id="lb-list" class="space-y-3"></div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2" id="btn-back-lb">
        <i class="fas fa-arrow-right"></i>
        <span>Ø¨Ø§Ø²Ú¯Ø´Øª</span>
      </button>
    </section>

    <!-- SHOP / VIP -->
    <section id="page-shop" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6 space-y-4">
        <h3 class="text-2xl font-extrabold flex items-center gap-2">
          <i class="fas fa-shopping-bag text-purple-300"></i>
          <span>ÙØ±ÙˆØ´Ú¯Ø§Ù‡</span>
        </h3>
        
        <!-- Special Offers -->
        <div class="glass-dark rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-bold flex items-center gap-2">
              <i class="fas fa-fire text-orange-400"></i>
              <span>Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ ÙˆÛŒÚ˜Ù‡</span>
            </h4>
            <div class="text-xs bg-red-500 px-2 py-1 rounded-full">Ù…Ø­Ø¯ÙˆØ¯</div>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center">
              <i class="fas fa-gem text-white text-2xl"></i>
            </div>
            <div class="flex-1">
              <div class="font-bold">Ø¨Ø³ØªÙ‡ Ø§Ù„Ù…Ø§Ø³ÛŒ</div>
              <div class="text-sm opacity-80">500 Ø³Ú©Ù‡ + 10 Ø¬Ø§Ù† + VIP Ù‡ÙØªÚ¯ÛŒ</div>
            </div>
            <div class="text-center">
              <div class="text-xs line-through opacity-60">300ğŸ’°</div>
              <div class="font-bold">199ğŸ’°</div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="glass-dark rounded-2xl p-5 card-hover">
            <div class="text-center mb-3">
              <div class="w-12 h-12 mx-auto rounded-full bg-red-500/20 flex items-center justify-center mb-2">
                <i class="fas fa-heart text-red-400 text-xl"></i>
              </div>
              <div class="font-bold text-lg">Ø¬Ø§Ù† +1</div>
              <div class="text-sm opacity-80 mt-1">Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</div>
            </div>
            <button class="btn btn-primary text-sm" data-buy="life">
              <i class="fas fa-coins ml-1"></i> Ø®Ø±ÛŒØ¯ 30ğŸ’°
            </button>
          </div>
          <div class="glass-dark rounded-2xl p-5 card-hover">
            <div class="text-center mb-3">
              <div class="w-12 h-12 mx-auto rounded-full bg-blue-500/20 flex items-center justify-center mb-2">
                <i class="fas fa-bolt text-blue-400 text-xl"></i>
              </div>
              <div class="font-bold text-lg">Ø¨ÙˆØ³Øª Ø§Ù…ØªÛŒØ§Ø² x2</div>
              <div class="text-sm opacity-80 mt-1">ØªØ§ 10 Ø¯Ù‚ÛŒÙ‚Ù‡</div>
            </div>
            <button class="btn btn-secondary text-sm" data-buy="boost">
              <i class="fas fa-coins ml-1"></i> Ø®Ø±ÛŒØ¯ 50ğŸ’°
            </button>
          </div>
          <div class="glass-dark rounded-2xl p-5 card-hover">
            <div class="text-center mb-3">
              <div class="w-12 h-12 mx-auto rounded-full bg-yellow-500/20 flex items-center justify-center mb-2">
                <i class="fas fa-coins text-yellow-400 text-xl"></i>
              </div>
              <div class="font-bold text-lg">Ø³Ú©Ù‡ +100</div>
              <div class="text-sm opacity-80 mt-1">Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§</div>
            </div>
            <button class="btn btn-tertiary text-sm" data-buy="coins">
              <i class="fas fa-coins ml-1"></i> Ø®Ø±ÛŒØ¯ 20ğŸ’°
            </button>
          </div>
          <div class="glass-dark rounded-2xl p-5 card-hover">
            <div class="text-center mb-3">
              <div class="w-12 h-12 mx-auto rounded-full bg-green-500/20 flex items-center justify-center mb-2">
                <i class="fas fa-infinity text-green-400 text-xl"></i>
              </div>
              <div class="font-bold text-lg">Ø­Ø°Ù ØªØ¨Ù„ÛŒØºØ§Øª</div>
              <div class="text-sm opacity-80 mt-1">Ù‡Ù…ÛŒØ´Ú¯ÛŒ</div>
            </div>
            <button class="btn btn-primary text-sm" data-buy="noads">
              <i class="fas fa-coins ml-1"></i> Ø®Ø±ÛŒØ¯ 100ğŸ’°
            </button>
          </div>
        </div>
        
        <div class="glass-dark rounded-2xl p-5 card-hover">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center">
                <i class="fas fa-crown text-white text-2xl"></i>
              </div>
              <div>
                <div class="font-bold text-lg">Ø§Ø´ØªØ±Ø§Ú© VIP (Ù…Ø§Ù‡Ø§Ù†Ù‡)</div>
                <div class="text-sm opacity-80 mt-1">+Ø¬Ø§Ù† Ø±ÙˆØ²Ø§Ù†Ù‡ØŒ +Ø§Ø³ØªØ±ÛŒÚ©ØŒ +Ø¬Ø§Ù…â€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡</div>
              </div>
            </div>
            <button class="btn btn-tertiary w-auto px-4" data-buy="vip">
              <i class="fas fa-coins ml-1"></i> Ø®Ø±ÛŒØ¯ 200ğŸ’°
            </button>
          </div>
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2" id="btn-back-shop">
        <i class="fas fa-arrow-right"></i>
        <span>Ø¨Ø§Ø²Ú¯Ø´Øª</span>
      </button>
    </section>

    <!-- PROFILE PAGE -->
    <section id="page-profile" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <div class="flex flex-col items-center mb-6">
          <div class="relative mb-4">
            <img id="profile-page-avatar" src="https://i.pravatar.cc/150?img=12" class="w-24 h-24 rounded-full border-4 border-white/30 shadow-lg" alt="avatar" />
            <div class="absolute bottom-0 right-0 w-10 h-10 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center border-2 border-white">
              <i class="fas fa-crown text-white"></i>
            </div>
          </div>
          <h2 id="profile-page-name" class="text-2xl font-extrabold">Ø²Ú©ÛŒ</h2>
          <div class="text-sm text-white/80 mt-1">@zaki_user</div>
          <div class="flex items-center gap-2 mt-2">
            <span id="profile-vip-badge" class="chip bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold hidden">VIP</span>
            <span class="chip">
              <i class="fas fa-calendar-alt ml-1"></i> Ø¹Ø¶Ùˆ Ø§Ø² ÙØ±ÙˆØ±Ø¯ÛŒÙ† Û±Û´Û°Û²
            </span>
          </div>
        </div>
        
        <div class="divider"></div>
        
        <div class="grid grid-cols-3 gap-4 text-center mb-6">
          <div>
            <div class="text-2xl font-extrabold text-yellow-300" id="profile-score">0</div>
            <div class="text-xs opacity-80 mt-1">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„</div>
          </div>
          <div>
            <div class="text-2xl font-extrabold text-emerald-300" id="profile-coins">0</div>
            <div class="text-xs opacity-80 mt-1">Ø³Ú©Ù‡</div>
          </div>
          <div>
            <div class="text-2xl font-extrabold text-rose-300" id="profile-level">1</div>
            <div class="text-xs opacity-80 mt-1">Ø³Ø·Ø­</div>
          </div>
        </div>
        
        <div class="mb-6">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm font-bold">Ù¾ÛŒØ´Ø±ÙØª Ø³Ø·Ø­</div>
            <div class="text-xs opacity-80"><span id="profile-exp">0</span> / <span id="profile-exp-needed">100</span> XP</div>
          </div>
          <div class="w-full h-3 bg-white/15 rounded-full overflow-hidden">
            <div id="profile-exp-bar" class="h-3 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full transition-all duration-500" style="width:0%"></div>
          </div>
        </div>
        
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i class="fas fa-gamepad text-blue-400"></i>
              <span>Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</span>
            </div>
            <div class="font-bold" id="profile-games">0</div>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i class="fas fa-percentage text-green-400"></i>
              <span>Ø¯Ù‚Øª Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</span>
            </div>
            <div class="font-bold" id="profile-accuracy">0%</div>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i class="fas fa-fire text-orange-400"></i>
              <span>Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ø³ØªØ±ÛŒÚ©</span>
            </div>
            <div class="font-bold" id="profile-best-streak">0</div>
          </div>
        </div>
      </div>
      
      <div class="glass rounded-3xl p-6">
        <h3 class="text-xl font-extrabold mb-4 flex items-center gap-2">
          <i class="fas fa-chart-pie text-purple-300"></i>
          <span>Ø¢Ù…Ø§Ø± Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</span>
        </h3>
        <div id="category-stats" class="space-y-3">
          <!-- Category stats will be loaded here -->
        </div>
      </div>
      
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2" id="btn-back-profile">
        <i class="fas fa-arrow-right"></i>
        <span>Ø¨Ø§Ø²Ú¯Ø´Øª</span>
      </button>
    </section>

    <!-- ACHIEVEMENTS PAGE -->
    <section id="page-achievements" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-4 flex items-center gap-2">
          <i class="fas fa-medal text-yellow-300"></i>
          <span>Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§</span>
        </h3>
        <div class="flex items-center justify-between mb-4">
          <div class="text-sm">
            <span class="font-bold" id="achievements-unlocked">0</span> Ø§Ø² <span id="achievements-total">0</span> Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§
          </div>
          <div class="text-xs opacity-80">
            <i class="fas fa-filter ml-1"></i>
            <span>ÙÛŒÙ„ØªØ±:</span>
            <select id="achievement-filter" class="bg-transparent border-b border-white/30">
              <option value="all">Ù‡Ù…Ù‡</option>
              <option value="unlocked">Ø¨Ø§Ø² Ø´Ø¯Ù‡</option>
              <option value="locked">Ù‚ÙÙ„ Ø´Ø¯Ù‡</option>
            </select>
          </div>
        </div>
        <div id="achievements-list" class="space-y-4">
          <!-- Achievements will be loaded here -->
        </div>
      </div>
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2" id="btn-back-achievements">
        <i class="fas fa-arrow-right"></i>
        <span>Ø¨Ø§Ø²Ú¯Ø´Øª</span>
      </button>
    </section>

    <!-- SETTINGS PAGE -->
    <section id="page-settings" class="hidden space-y-5">
      <div class="glass rounded-3xl p-6">
        <h3 class="text-2xl font-extrabold mb-4 flex items-center gap-2">
          <i class="fas fa-cog text-blue-300"></i>
          <span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
        </h3>
        
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center">
                <i class="fas fa-volume-up text-blue-400"></i>
              </div>
              <div>
                <div class="font-bold">Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ ØµÙˆØªÛŒ</div>
                <div class="text-xs opacity-80">Ù¾Ø®Ø´ ØµØ¯Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒ</div>
              </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="sound-toggle" class="sr-only peer" checked>
              <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
            </label>
          </div>
          
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center">
                <i class="fas fa-language text-purple-400"></i>
              </div>
              <div>
                <div class="font-bold">Ø²Ø¨Ø§Ù†</div>
                <div class="text-xs opacity-80">Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ø¨Ø§Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡</div>
              </div>
            </div>
            <select id="language-select" class="bg-white/10 border border-white/20 rounded-xl px-3 py-2 text-sm">
              <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
              <option value="en">English</option>
            </select>
          </div>
          
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center">
                <i class="fas fa-bell text-yellow-400"></i>
              </div>
              <div>
                <div class="font-bold">Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</div>
                <div class="text-xs opacity-80">Ø¯Ø±ÛŒØ§ÙØª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†</div>
              </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="notification-toggle" class="sr-only peer" checked>
              <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
            </label>
          </div>
          
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                <i class="fas fa-moon text-green-400"></i>
              </div>
              <div>
                <div class="font-bold">Ø­Ø§Ù„Øª Ø´Ø¨</div>
                <div class="text-xs opacity-80">Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ ØªÛŒØ±Ù‡â€ŒØªØ±</div>
              </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="darkmode-toggle" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
            </label>
          </div>
        </div>
        
        <div class="divider my-4"></div>
        
        <div class="space-y-3">
          <button class="w-full py-3 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2">
            <i class="fas fa-question-circle"></i>
            <span>Ø±Ø§Ù‡Ù†Ù…Ø§ Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</span>
          </button>
          <button class="w-full py-3 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2">
            <i class="fas fa-shield-alt"></i>
            <span>Ø³ÛŒØ§Ø³Øª Ø­ÙØ¸ Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ</span>
          </button>
          <button class="w-full py-3 rounded-xl bg-rose-500/20 border border-rose-500/30 hover:bg-rose-500/30 transition-all duration-300 flex items-center justify-center gap-2">
            <i class="fas fa-sign-out-alt"></i>
            <span>Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</span>
          </button>
        </div>
      </div>
      
      <button class="w-full py-4 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/20 transition-all duration-300 flex items-center justify-center gap-2" id="btn-back-settings">
        <i class="fas fa-arrow-right"></i>
        <span>Ø¨Ø§Ø²Ú¯Ø´Øª</span>
      </button>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav class="glass safe sticky bottom-0 z-30 w-full shadow-lg">
    <div class="max-w-md mx-auto grid grid-cols-4">
      <button class="py-4 text-center hover:bg-white/10 transition-all duration-300 nav-item" data-tab="dashboard">
        <i class="fas fa-home text-xl mb-1"></i>
        <div class="text-xs">Ø®Ø§Ù†Ù‡</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition-all duration-300 nav-item" data-tab="categories">
        <i class="fas fa-th-large text-xl mb-1"></i>
        <div class="text-xs">Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition-all duration-300 nav-item" data-tab="quiz">
        <i class="fas fa-gamepad text-xl mb-1"></i>
        <div class="text-xs">Ù…Ø³Ø§Ø¨Ù‚Ù‡</div>
      </button>
      <button class="py-4 text-center hover:bg-white/10 transition-all duration-300 nav-item" data-tab="leaderboard">
        <i class="fas fa-chart-line text-xl mb-1"></i>
        <div class="text-xs">Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯</div>
      </button>
    </div>
  </nav>

  <!-- Tutorial Modal -->
  <div id="tutorial-modal" class="modal">
    <div class="glass rounded-3xl p-6 max-w-md mx-4 slide-up">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-extrabold">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h3>
        <button id="close-tutorial" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="space-y-4 mb-6">
        <div class="flex items-start gap-3">
          <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center flex-shrink-0 mt-1">
            <span class="font-bold">1</span>
          </div>
          <div>
            <div class="font-bold">Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø¯Ø§Ø¯Ù†</div>
            <div class="text-sm opacity-80">Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ "Ø´Ø±ÙˆØ¹ Ù…Ø³Ø§Ø¨Ù‚Ù‡" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ Ùˆ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯.</div>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-1">
            <span class="font-bold">2</span>
          </div>
          <div>
            <div class="font-bold">Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ø³Ú©Ù‡</div>
            <div class="text-sm opacity-80">Ø¨Ø§ Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§ØªØŒ Ø³Ú©Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø± ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¢ÛŒØªÙ… Ø¨Ø®Ø±ÛŒØ¯.</div>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center flex-shrink-0 mt-1">
            <span class="font-bold">3</span>
          </div>
          <div>
            <div class="font-bold">Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§</div>
            <div class="text-sm opacity-80">Ø¨Ø§ Ø§Ù†Ø¬Ø§Ù… ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„ÙØŒ Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.</div>
          </div>
        </div>
      </div>
      <button id="start-tutorial" class="btn btn-primary">
        <i class="fas fa-play ml-2"></i> Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
      </button>
    </div>
  </div>

  <script>
  // === Minimal state/store ===
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const State = {
    user: { id: 'guest', name: 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†', avatar: 'https://i.pravatar.cc/120?img=12', username: 'zaki_user' },
    score: 0,
    coins: 100,
    lives: 3,
    vip: false,
    streak: 0,
    lastClaim: 0,
    boostUntil: 0,
    level: 1,
    exp: 0,
    gamesPlayed: 0,
    correctAnswers: 0,
    bestStreak: 0,
    soundEnabled: true,
    notificationsEnabled: true,
    darkMode: false,
    language: 'fa',
    leaderboard: [
      { id: 'u1', name: 'Ø¢Ø±ØªÛŒÙ†', score: 18200 },
      { id: 'u2', name: 'Ø³Ù…Ø§Ù†Ù‡', score: 16500 },
      { id: 'u3', name: 'Ù…Ø§Ù†ÛŒ', score: 14950 },
      { id: 'u4', name: 'Ù†ÛŒÚ©Ø§', score: 13200 },
    ],
    achievements: [
      { id: 'first_win', name: 'Ø§ÙˆÙ„ÛŒÙ† Ù¾ÛŒØ±ÙˆØ²ÛŒ', desc: 'Ø¨Ø±Ù†Ø¯Ù‡ Ø§ÙˆÙ„ÛŒÙ† Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø®ÙˆØ¯ Ø´Ùˆ', icon: 'fa-trophy', unlocked: false },
      { id: 'streak_3', name: 'Ø¢ØªØ´ÛŒÙ†', desc: 'Ø¨Ù‡ Ø§Ø³ØªØ±ÛŒÚ© Û³ Ø±ÙˆØ²Ù‡ Ø¨Ø±Ø³', icon: 'fa-fire', unlocked: false },
      { id: 'streak_7', name: 'Ù‡ÙØªÙ‡ Ø·Ù„Ø§ÛŒÛŒ', desc: 'Ø¨Ù‡ Ø§Ø³ØªØ±ÛŒÚ© Û· Ø±ÙˆØ²Ù‡ Ø¨Ø±Ø³', icon: 'fa-fire', unlocked: false },
      { id: 'score_1000', name: 'Ù…Ø¨ØªØ¯ÛŒ', desc: 'Ø¨Ù‡ Û±Û°Û°Û° Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø³', icon: 'fa-star', unlocked: false },
      { id: 'score_5000', name: 'Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ', desc: 'Ø¨Ù‡ ÛµÛ°Û°Û° Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø³', icon: 'fa-star', unlocked: false },
      { id: 'perfect_10', name: 'Ú©Ø§Ù…Ù„', desc: 'Û±Û° Ø³ÙˆØ§Ù„ Ù…ØªÙˆØ§Ù„ÛŒ Ø¯Ø±Ø³Øª Ù¾Ø§Ø³Ø® Ø¨Ø¯Ù‡', icon: 'fa-check-circle', unlocked: false },
      { id: 'category_master', name: 'Ø§Ø³ØªØ§Ø¯ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§', desc: 'Ø¯Ø± ØªÙ…Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ Ø¨Ø§Ø²ÛŒ Ú©Ù†', icon: 'fa-th-large', unlocked: false },
      { id: 'vip', name: 'VIP', desc: 'Ø§Ø´ØªØ±Ø§Ú© VIP ØªÙ‡ÛŒÙ‡ Ú©Ù†', icon: 'fa-crown', unlocked: false },
    ],
    categoryStats: {
      'Ø¹Ù…ÙˆÙ…ÛŒ': { played: 0, correct: 0 },
      'Ø¬ØºØ±Ø§ÙÛŒØ§': { played: 0, correct: 0 },
      'ÙˆØ±Ø²Ø´': { played: 0, correct: 0 },
      'Ø¹Ù„Ù…': { played: 0, correct: 0 },
      'ØªØ§Ø±ÛŒØ®': { played: 0, correct: 0 },
      'Ù‡Ù†Ø±': { played: 0, correct: 0 },
      'Ø³Ø±Ú¯Ø±Ù…ÛŒ': { played: 0, correct: 0 },
    },
    selectedCategory: null,
    quiz: { duration:30, remain:30, timer:null, inProgress:false, correctIndex:-1, answered:false, consecutiveCorrect:0 },
    showTutorial: true
  };
  const STORAGE_KEY = 'quiz_webapp_pro_state_v1';
  function loadState(){
    try{
      const s = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
      if(s){ Object.assign(State, s); }
    }catch{}
  }
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(State)); }
  // Try Telegram WebApp user
  try{
    if(window.Telegram && Telegram.WebApp){
      Telegram.WebApp.ready();
      const u = Telegram.WebApp.initDataUnsafe?.user;
      if(u){
        State.user.id = String(u.id);
        State.user.name = [u.first_name, u.last_name].filter(Boolean).join(' ');
        if(u.username) State.user.username = u.username;
        $('#profile-name').textContent = State.user.name;
      }
    }
  }catch{}
  loadState();
  // === UI bindings ===
  function fmt(n){ return new Intl.NumberFormat('fa-IR').format(n); }
  function renderHeader(){
    $('#hdr-name').textContent = State.user.name;
    $('#hdr-score').textContent = fmt(State.score);
    $('#hdr-avatar').src = State.user.avatar;
  }
  function renderDashboard(){
    $('#profile-name').textContent = State.user.name;
    $('#profile-avatar').src = State.user.avatar;
    $('#stat-score').textContent = fmt(State.score);
    $('#stat-coins').textContent = fmt(State.coins);
    $('#stat-lives').textContent = State.lives;
    $('#vip-badge').classList.toggle('hidden', !State.vip);
    $('#streak').textContent = State.streak;
    const pct = clamp((State.streak%7)/7*100,0,100);
    $('#streak-bar').style.width = pct + '%';
    
    // Update achievements preview
    renderAchievementsPreview();
    
    // Update daily challenge timer
    updateDailyChallengeTimer();
  }
  function renderTopBars(){
    $('#lives').textContent = State.lives;
    $('#coins').textContent = fmt(State.coins);
  }
  function navTo(page){
    ['dashboard','categories','quiz','leaderboard','shop','profile','achievements','settings'].forEach(p=>{
      $('#page-'+p)?.classList.add('hidden');
    });
    $('#page-'+page)?.classList.remove('hidden');
    $('#page-'+page)?.classList.add('fade-in');
    // highlight tab
    $$('nav [data-tab]').forEach(b=>{
      b.classList.toggle('bg-white/10', b.dataset.tab===page);
      b.classList.toggle('active', b.dataset.tab===page);
    });
    if(page==='dashboard') renderDashboard();
    if(page==='leaderboard') renderLeaderboard();
    if(page==='shop') renderShop();
    if(page==='profile') renderProfile();
    if(page==='achievements') renderAchievements();
    if(page==='settings') renderSettings();
    if(page==='categories') renderCategories();
  }
  function showToast(message, type = 'info', duration = 3000) {
    const toastContainer = $('#toast-container');
    const toast = document.createElement('div');
    
    // Set icon based on type
    let icon = 'fa-info-circle';
    let bgColor = 'bg-blue-500/80';
    
    if (type === 'success') {
      icon = 'fa-check-circle';
      bgColor = 'bg-green-500/80';
    } else if (type === 'error') {
      icon = 'fa-exclamation-circle';
      bgColor = 'bg-red-500/80';
    } else if (type === 'warning') {
      icon = 'fa-exclamation-triangle';
      bgColor = 'bg-yellow-500/80';
    }
    
    toast.className = `glass ${bgColor} px-6 py-4 rounded-2xl text-white font-bold z-50 flex items-center gap-3 mb-3 fade-in`;
    toast.innerHTML = `<i class="fas ${icon} text-xl"></i><span>${message}</span>`;
    
    toastContainer.appendChild(toast);
    
    // Remove toast after duration
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      toast.style.transition = 'all 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }
  function createConfetti() {
    const colors = ['#fde047', '#fb923c', '#a78bfa', '#ec4899', '#60a5fa', '#34d399'];
    const confettiCount = 50;
    
    for (let i = 0; i < confettiCount; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = `${Math.random() * 100}%`;
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.width = `${Math.random() * 10 + 5}px`;
      confetti.style.height = confetti.style.width;
      confetti.style.opacity = Math.random() * 0.8 + 0.2;
      confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
      confetti.style.animationDelay = `${Math.random() * 0.5}s`;
      document.body.appendChild(confetti);
      
      // Remove confetti after animation
      setTimeout(() => confetti.remove(), 5000);
    }
  }
  function checkAchievements() {
    let newAchievement = false;
    
    // First win
    if (State.gamesPlayed > 0 && !State.achievements.find(a => a.id === 'first_win').unlocked) {
      State.achievements.find(a => a.id === 'first_win').unlocked = true;
      unlockAchievement('first_win');
      newAchievement = true;
    }
    
    // Streak achievements
    if (State.streak >= 3 && !State.achievements.find(a => a.id === 'streak_3').unlocked) {
      State.achievements.find(a => a.id === 'streak_3').unlocked = true;
      unlockAchievement('streak_3');
      newAchievement = true;
    }
    
    if (State.streak >= 7 && !State.achievements.find(a => a.id === 'streak_7').unlocked) {
      State.achievements.find(a => a.id === 'streak_7').unlocked = true;
      unlockAchievement('streak_7');
      newAchievement = true;
    }
    
    // Score achievements
    if (State.score >= 1000 && !State.achievements.find(a => a.id === 'score_1000').unlocked) {
      State.achievements.find(a => a.id === 'score_1000').unlocked = true;
      unlockAchievement('score_1000');
      newAchievement = true;
    }
    
    if (State.score >= 5000 && !State.achievements.find(a => a.id === 'score_5000').unlocked) {
      State.achievements.find(a => a.id === 'score_5000').unlocked = true;
      unlockAchievement('score_5000');
      newAchievement = true;
    }
    
    // Perfect streak
    if (State.quiz.consecutiveCorrect >= 10 && !State.achievements.find(a => a.id === 'perfect_10').unlocked) {
      State.achievements.find(a => a.id === 'perfect_10').unlocked = true;
      unlockAchievement('perfect_10');
      newAchievement = true;
    }
    
    // Category master
    const allCategoriesPlayed = Object.values(State.categoryStats).every(stat => stat.played > 0);
    if (allCategoriesPlayed && !State.achievements.find(a => a.id === 'category_master').unlocked) {
      State.achievements.find(a => a.id === 'category_master').unlocked = true;
      unlockAchievement('category_master');
      newAchievement = true;
    }
    
    // VIP achievement
    if (State.vip && !State.achievements.find(a => a.id === 'vip').unlocked) {
      State.achievements.find(a => a.id === 'vip').unlocked = true;
      unlockAchievement('vip');
      newAchievement = true;
    }
    
    if (newAchievement) {
      saveState();
    }
  }
  function unlockAchievement(id) {
    const achievement = State.achievements.find(a => a.id === id);
    if (!achievement) return;
    
    // Show achievement unlocked notification
    const toast = document.createElement('div');
    toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 glass px-6 py-4 rounded-2xl text-white font-bold z-50 flex items-center gap-3 achievement-unlock';
    toast.innerHTML = `
      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center">
        <i class="fas ${achievement.icon} text-white text-xl"></i>
      </div>
      <div>
        <div class="font-bold">Ø¯Ø³ØªØ§ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯!</div>
        <div class="text-sm">${achievement.name}</div>
      </div>
    `;
    document.body.appendChild(toast);
    
    // Create confetti
    createConfetti();
    
    // Play sound if enabled
    if (State.soundEnabled) {
      // In a real app, you would play an achievement sound here
      console.log('Playing achievement sound');
    }
    
    // Remove toast after delay
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px) translateX(-50%)';
      toast.style.transition = 'all 0.5s ease';
      setTimeout(() => toast.remove(), 500);
    }, 3000);
  }
  function renderAchievementsPreview() {
    const container = $('#achievements-preview');
    container.innerHTML = '';
    
    // Show first 4 unlocked achievements, or first 4 if none unlocked
    const unlocked = State.achievements.filter(a => a.unlocked).slice(0, 4);
    const toShow = unlocked.length > 0 ? unlocked : State.achievements.slice(0, 4);
    
    toShow.forEach(achievement => {
      const div = document.createElement('div');
      div.className = 'flex flex-col items-center';
      
      const badge = document.createElement('div');
      badge.className = `achievement-badge ${achievement.unlocked ? 'bg-gradient-to-r from-yellow-400 to-orange-500' : 'bg-gray-500/20 locked'}`;
      badge.innerHTML = `<i class="fas ${achievement.icon} ${achievement.unlocked ? 'text-white' : 'text-gray-400'}"></i>`;
      
      const name = document.createElement('div');
      name.className = 'text-xs mt-1 text-center';
      name.textContent = achievement.name;
      
      div.appendChild(badge);
      div.appendChild(name);
      container.appendChild(div);
    });
  }
  function renderAchievements() {
    const container = $('#achievements-list');
    container.innerHTML = '';
    
    const filter = $('#achievement-filter').value;
    let achievements = State.achievements;
    
    if (filter === 'unlocked') {
      achievements = achievements.filter(a => a.unlocked);
    } else if (filter === 'locked') {
      achievements = achievements.filter(a => !a.unlocked);
    }
    
    $('#achievements-unlocked').textContent = State.achievements.filter(a => a.unlocked).length;
    $('#achievements-total').textContent = State.achievements.length;
    
    achievements.forEach(achievement => {
      const div = document.createElement('div');
      div.className = `glass rounded-2xl p-4 flex items-center gap-4 ${achievement.unlocked ? '' : 'opacity-60'}`;
      
      const badge = document.createElement('div');
      badge.className = `achievement-badge ${achievement.unlocked ? 'bg-gradient-to-r from-yellow-400 to-orange-500' : 'bg-gray-500/20'}`;
      badge.innerHTML = `<i class="fas ${achievement.icon} ${achievement.unlocked ? 'text-white' : 'text-gray-400'}"></i>`;
      
      const info = document.createElement('div');
      info.className = 'flex-1';
      info.innerHTML = `
        <div class="font-bold">${achievement.name}</div>
        <div class="text-sm opacity-80">${achievement.desc}</div>
      `;
      
      const status = document.createElement('div');
      status.className = 'text-sm';
      status.innerHTML = achievement.unlocked ? 
        '<span class="text-green-400"><i class="fas fa-check-circle ml-1"></i>Ø¨Ø§Ø² Ø´Ø¯Ù‡</span>' : 
        '<span class="text-gray-400"><i class="fas fa-lock ml-1"></i>Ù‚ÙÙ„ Ø´Ø¯Ù‡</span>';
      
      div.appendChild(badge);
      div.appendChild(info);
      div.appendChild(status);
      container.appendChild(div);
    });
  }
  function renderProfile() {
    $('#profile-page-name').textContent = State.user.name;
    $('#profile-page-avatar').src = State.user.avatar;
    $('#profile-vip-badge').classList.toggle('hidden', !State.vip);
    $('#profile-score').textContent = fmt(State.score);
    $('#profile-coins').textContent = fmt(State.coins);
    $('#profile-level').textContent = State.level;
    $('#profile-exp').textContent = State.exp;
    
    // Calculate exp needed for next level
    const expNeeded = State.level * 100;
    $('#profile-exp-needed').textContent = expNeeded;
    $('#profile-exp-bar').style.width = `${(State.exp / expNeeded) * 100}%`;
    
    $('#profile-games').textContent = State.gamesPlayed;
    $('#profile-best-streak').textContent = State.bestStreak;
    
    // Calculate accuracy
    const accuracy = State.gamesPlayed > 0 ? Math.round((State.correctAnswers / State.gamesPlayed) * 100) : 0;
    $('#profile-accuracy').textContent = `${accuracy}%`;
    
    // Render category stats
    const categoryStatsContainer = $('#category-stats');
    categoryStatsContainer.innerHTML = '';
    
    Object.entries(State.categoryStats).forEach(([category, stats]) => {
      if (stats.played === 0) return;
      
      const div = document.createElement('div');
      div.className = 'flex items-center justify-between';
      
      const catName = document.createElement('div');
      catName.className = 'text-sm';
      catName.textContent = category;
      
      const catStats = document.createElement('div');
      catStats.className = 'text-xs opacity-80';
      const accuracy = stats.played > 0 ? Math.round((stats.correct / stats.played) * 100) : 0;
      catStats.textContent = `${stats.correct}/${stats.played} (${accuracy}%)`;
      
      div.appendChild(catName);
      div.appendChild(catStats);
      categoryStatsContainer.appendChild(div);
    });
  }
  function renderSettings() {
    $('#sound-toggle').checked = State.soundEnabled;
    $('#notification-toggle').checked = State.notificationsEnabled;
    $('#darkmode-toggle').checked = State.darkMode;
    $('#language-select').value = State.language;
  }
  function renderCategories() {
    const container = $('#categories-grid');
    container.innerHTML = '';
    
    const categories = [
      { id: 'general', name: 'Ø¹Ù…ÙˆÙ…ÛŒ', icon: 'fa-globe', color: 'blue' },
      { id: 'geography', name: 'Ø¬ØºØ±Ø§ÙÛŒØ§', icon: 'fa-map-marked-alt', color: 'green' },
      { id: 'sports', name: 'ÙˆØ±Ø²Ø´', icon: 'fa-football-ball', color: 'orange' },
      { id: 'science', name: 'Ø¹Ù„Ù…', icon: 'fa-flask', color: 'purple' },
      { id: 'history', name: 'ØªØ§Ø±ÛŒØ®', icon: 'fa-landmark', color: 'yellow' },
      { id: 'art', name: 'Ù‡Ù†Ø±', icon: 'fa-palette', color: 'pink' },
      { id: 'entertainment', name: 'Ø³Ø±Ú¯Ø±Ù…ÛŒ', icon: 'fa-film', color: 'red' },
    ];
    
    categories.forEach(category => {
      const div = document.createElement('div');
      div.className = `category-card glass rounded-2xl p-5 flex flex-col items-center justify-center cursor-pointer`;
      
      const icon = document.createElement('div');
      icon.className = `w-16 h-16 rounded-full bg-${category.color}-500/20 flex items-center justify-center mb-3`;
      icon.innerHTML = `<i class="fas ${category.icon} text-${category.color}-400 text-2xl"></i>`;
      
      const name = document.createElement('div');
      name.className = 'font-bold text-lg';
      name.textContent = category.name;
      
      div.appendChild(icon);
      div.appendChild(name);
      
      div.addEventListener('click', () => {
        State.selectedCategory = category;
        navTo('quiz');
        startQuiz();
      });
      
      container.appendChild(div);
    });
  }
  function renderShop() {
    // Shop items are already in HTML, just update button states based on coins
    $$('[data-buy]').forEach(btn => {
      const item = btn.dataset.buy;
      const price = { life:30, boost:50, coins:20, noads:100, vip:200 }[item];
      
      if (State.coins < price) {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    });
  }
  function updateDailyChallengeTimer() {
    // Calculate time until next day
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(0, 0, 0, 0);
    
    const diff = tomorrow - now;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    $('#daily-timer').textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Update every second
    setTimeout(updateDailyChallengeTimer, 1000);
  }
  // === Quiz Logic ===
  const localQuestions = {
    'general': [
      { q:'Ù¾Ø§ÛŒØªØ®Øª Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§ Ú©Ø¯Ø§Ù… Ø§Ø³ØªØŸ', c:['Ù…Ù„Ø¨ÙˆØ±Ù†','Ø³ÛŒØ¯Ù†ÛŒ','Ù¾Ø±Øª','Ú©Ø§Ù†Ø¨Ø±Ø§'], a:3, cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ø¢Ø³ÙˆÙ†' },
      { q:'Ú©Ø¯Ø§Ù… Ø³ÛŒØ§Ø±Ù‡ Ø¯Ø± Ù…Ù†Ø¸ÙˆÙ…Ù‡ Ø´Ù…Ø³ÛŒ Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† Ø§Ø³ØªØŸ', c:['Ø²Ù…ÛŒÙ†','Ù…Ø´ØªØ±ÛŒ','Ø²Ø­Ù„','Ø§ÙˆØ±Ø§Ù†ÙˆØ³'], a:1, cat:'Ø¹Ù…ÙˆÙ…ÛŒ', diff:'Ø¢Ø³ÙˆÙ†' },
    ],
    'geography': [
      { q:'Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒØªØ±ÛŒÙ† Ø±ÙˆØ¯ Ø¬Ù‡Ø§Ù† Ú©Ø¯Ø§Ù… Ø§Ø³ØªØŸ', c:['Ø¢Ù…Ø§Ø²ÙˆÙ†','Ù†ÛŒÙ„','ÛŒØ§Ù†Ú¯â€ŒØªØ³Ù‡','Ù…ÛŒØ³ÛŒØ³ÛŒÙ¾ÛŒ'], a:1, cat:'Ø¬ØºØ±Ø§ÙÛŒØ§', diff:'Ù…ØªÙˆØ³Ø·' },
      { q:'Ú©Ø´ÙˆØ±ÛŒ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¬Ù…Ø¹ÛŒØª Ø¬Ù‡Ø§Ù†ØŸ', c:['Ù‡Ù†Ø¯','Ú†ÛŒÙ†','Ø¢Ù…Ø±ÛŒÚ©Ø§','Ø§Ù†Ø¯ÙˆÙ†Ø²ÛŒ'], a:1, cat:'Ø¬ØºØ±Ø§ÙÛŒØ§', diff:'Ø¢Ø³ÙˆÙ†' },
    ],
    'sports': [
      { q:'Ù‚Ù‡Ø±Ù…Ø§Ù† Ø¬Ø§Ù… Ø¬Ù‡Ø§Ù†ÛŒ ÙÙˆØªØ¨Ø§Ù„ Û±Û¹Û¹Û¸ØŸ', c:['Ø¢Ù„Ù…Ø§Ù†','Ø¨Ø±Ø²ÛŒÙ„','ÙØ±Ø§Ù†Ø³Ù‡','Ø§ÛŒØªØ§Ù„ÛŒØ§'], a:2, cat:'ÙˆØ±Ø²Ø´', diff:'Ù…ØªÙˆØ³Ø·' },
      { q:'Ø¯Ø± Ú©Ø¯Ø§Ù… ÙˆØ±Ø²Ø´ Ø§Ø² Ø§ØµØ·Ù„Ø§Ø­ "Ø§Ø³Ù„Ù… Ø¯Ø§Ù†Ú©" Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŸ', c:['ØªÙ†ÛŒØ³','Ø¨Ø³Ú©ØªØ¨Ø§Ù„','ÙÙˆØªØ¨Ø§Ù„','ÙˆØ§Ù„ÛŒØ¨Ø§Ù„'], a:1, cat:'ÙˆØ±Ø²Ø´', diff:'Ø¢Ø³ÙˆÙ†' },
    ],
    'science': [
      { q:'Ø¹Ø¯Ø¯ Ï€ ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø§ØŸ', c:['Û²Ù«Û·','Û³Ù«Û±Û´','Û³Ù«Û´Û±','Û²Ù«Û±Û´'], a:1, cat:'Ø¹Ù„Ù…', diff:'Ø¢Ø³ÙˆÙ†' },
      { q:'Ø³Ø±Ø¹Øª Ù†ÙˆØ± Ø¯Ø± Ø®Ù„Ø§Ø¡ Ú†Ù‚Ø¯Ø± Ø§Ø³ØªØŸ', c:['Û²Û¹Û¹Ù¬Û·Û¹Û² Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ø¨Ø± Ø«Ø§Ù†ÛŒÙ‡','Û²Û¹Û¹Ù¬Û·Û¹Û² Ù…ØªØ± Ø¨Ø± Ø«Ø§Ù†ÛŒÙ‡','Û²Û¹Û¹Ù¬Û·Û¹Û² Ù…Ø§ÛŒÙ„ Ø¨Ø± Ø«Ø§Ù†ÛŒÙ‡','Û²Û¹Û¹Ù¬Û·Û¹Û² Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ø¨Ø± Ø³Ø§Ø¹Øª'], a:0, cat:'Ø¹Ù„Ù…', diff:'Ø³Ø®Øª' },
    ],
    'history': [
      { q:'Ø¬Ù†Ú¯ Ø¬Ù‡Ø§Ù†ÛŒ Ø¯ÙˆÙ… Ø¯Ø± Ú†Ù‡ Ø³Ø§Ù„ÛŒ Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØªØŸ', c:['Û±Û¹Û´Û³','Û±Û¹Û´Û´','Û±Û¹Û´Ûµ','Û±Û¹Û´Û¶'], a:2, cat:'ØªØ§Ø±ÛŒØ®', diff:'Ø¢Ø³ÙˆÙ†' },
      { q:'Ø§ÙˆÙ„ÛŒÙ† Ø±Ø¦ÛŒØ³ Ø¬Ù…Ù‡ÙˆØ± Ø¢Ù…Ø±ÛŒÚ©Ø§ Ú†Ù‡ Ú©Ø³ÛŒ Ø¨ÙˆØ¯ØŸ', c:['ØªÙˆÙ…Ø§Ø³ Ø¬ÙØ±Ø³ÙˆÙ†','Ø¬ÙˆØ±Ø¬ ÙˆØ§Ø´Ù†Ú¯ØªÙ†','Ø¢Ø¨Ø±Ø§Ù‡Ø§Ù… Ù„ÛŒÙ†Ú©Ù„Ù†','Ø¨Ù†Ø¬Ø§Ù…ÛŒÙ† ÙØ±Ø§Ù†Ú©Ù„ÛŒÙ†'], a:1, cat:'ØªØ§Ø±ÛŒØ®', diff:'Ø¢Ø³ÙˆÙ†' },
    ],
    'art': [
      { q:'Ú©Ø¯Ø§Ù… Ù‡Ù†Ø±Ù…Ù†Ø¯ Ù†Ù‚Ø§Ø´ÛŒ Â«Ø´Ø¨ Ù¾Ø±Ø³ØªØ§Ø±Ù‡Â» Ø±Ø§ Ú©Ø´ÛŒØ¯Ù‡ØŸ', c:['Ù¾ÛŒÚ©Ø§Ø³Ùˆ','ÙˆÙ†â€ŒÚ¯ÙˆÚ¯','Ù…ÙˆÙ†Ú©','Ø¯Ø§ÙˆÛŒÙ†Ú†ÛŒ'], a:1, cat:'Ù‡Ù†Ø±', diff:'Ù…ØªÙˆØ³Ø·' },
      { q:'Ù…ÙˆÙ†Ø§ Ù„ÛŒØ²Ø§ Ø§Ø«Ø± Ú©Ø¯Ø§Ù… Ù‡Ù†Ø±Ù…Ù†Ø¯ Ø§Ø³ØªØŸ', c:['Ù…ÛŒÚ©Ù„Ø¢Ù†Ú˜','Ø±Ø§ÙØ§Ø¦Ù„','Ù„Ø¦ÙˆÙ†Ø§Ø±Ø¯Ùˆ Ø¯Ø§ÙˆÛŒÙ†Ú†ÛŒ','Ø¯ÙˆÙ†Ø§ØªÙ„Ùˆ'], a:2, cat:'Ù‡Ù†Ø±', diff:'Ø¢Ø³ÙˆÙ†' },
    ],
    'entertainment': [
      { q:'Ø¯Ø± Ø¯Ù†ÛŒØ§ÛŒ Â«Ù‡Ø±ÛŒ Ù¾Ø§ØªØ±Â» Ù†Ú¯Ù‡Ø¨Ø§Ù† Ø¢Ø²Ú©Ø§Ø¨Ø§Ù† Ú†ÛŒØ³ØªØŸ', c:['Ø¯ÛŒÙˆØ§Ù†Ù‡â€ŒØ³Ø§Ø²','ØºÙˆÙ„','Ø§Ú˜Ø¯Ù‡Ø§','Ú©ÙˆØªÙˆÙ„Ù‡Ù” Ø®Ø§Ù†Ú¯ÛŒ'], a:0, cat:'Ø³Ø±Ú¯Ø±Ù…ÛŒ', diff:'Ø¢Ø³ÙˆÙ†' },
      { q:'Ú©Ø¯Ø§Ù… ÙÛŒÙ„Ù… Ø¨Ø±Ù†Ø¯Ù‡ Ø§Ø³Ú©Ø§Ø± Ø¨Ù‡ØªØ±ÛŒÙ† ÙÛŒÙ„Ù… Ø¯Ø± Ø³Ø§Ù„ Û²Û°Û²Û° Ø´Ø¯ØŸ', c:['Ù¾Ø§Ø±Ø§Ø³Ø§ÛŒØª','Û±Û¹Û±Û·','Ø¬ÙˆÚ©Ø±','Ø±ÙˆÛŒØ§ÛŒ Ø³Ø¨Ø²'], a:0, cat:'Ø³Ø±Ú¯Ø±Ù…ÛŒ', diff:'Ù…ØªÙˆØ³Ø·' },
    ]
  };
  
  async function fetchQuestion() {
    // If a category is selected, use local questions for that category
    if (State.selectedCategory) {
      const catQuestions = localQuestions[State.selectedCategory.id] || localQuestions['general'];
      return catQuestions[Math.floor(Math.random() * catQuestions.length)];
    }
    
    // Try OpenTDB; fallback to local
    try{
      const url = 'https://opentdb.com/api.php?amount=1&type=multiple&encode=url3986';
      const r = await fetch(url, { cache:'no-store' });
      const j = await r.json();
      if(j?.results?.length){
        const it = j.results[0];
        const decode = s => decodeURIComponent(s||'').replace(/&(#\d+|[a-z]+);/gi, m=>{ const t=document.createElement('textarea'); t.innerHTML=m; return t.value; });
        const q = decode(it.question);
        const correct = decode(it.correct_answer);
        const choices = [...it.incorrect_answers.map(decode), correct].sort(()=>Math.random()-0.5);
        return { q, c:choices, a: choices.indexOf(correct), cat: it.category||'Ø¹Ù…ÙˆÙ…ÛŒ', diff: it.difficulty||'â€”' };
      }
    }catch(e){ /* offline or blocked */ }
    // fallback
    return localQuestions['general'][Math.floor(Math.random()*localQuestions['general'].length)];
  }
  function resetTimer(seconds){
    const circ = 2*Math.PI*64; // 402.124
    const ring = $('#timer-ring');
    ring.setAttribute('stroke-dasharray', circ);
    ring.style.strokeDashoffset = '0';
    $('#timer-text').textContent = seconds;
    State.quiz.duration = seconds;
    State.quiz.remain = seconds;
    if(State.quiz.timer) clearInterval(State.quiz.timer);
    State.quiz.timer = setInterval(()=>{
      State.quiz.remain -= 1;
      const r = clamp(State.quiz.remain,0,seconds);
      $('#timer-text').textContent = r;
      const off = circ * (1 - r/seconds);
      ring.style.strokeDashoffset = String(off);
      if(r<=0){ clearInterval(State.quiz.timer); lockChoices(); showContinue(); }
    }, 1000);
  }
  function lockChoices(){
    $$('#choices .choice').forEach(el=> el.classList.add('pointer-events-none','opacity-70'));
  }
  function showContinue(){
    if(State.lives<=0){ $('#btn-continue').classList.remove('hidden'); }
  }
  async function startQuiz(){
    State.quiz.inProgress = true; 
    State.quiz.answered = false; 
    $('#btn-continue').classList.add('hidden');
    renderTopBars();
    const q = await fetchQuestion();
    State.quiz.correctIndex = q.a;
    $('#quiz-cat').innerHTML = `<i class="fas fa-folder ml-1"></i> ${q.cat}`;
    $('#quiz-diff').innerHTML = `<i class="fas fa-signal ml-1"></i> ${typeof q.diff==='string' ? q.diff : 'â€”'}`;
    $('#question').textContent = q.q;
    const box = $('#choices'); box.innerHTML='';
    q.c.forEach((txt,idx)=>{
      const btn = document.createElement('button');
      btn.className='choice';
      btn.innerHTML = `<span class="chip">${String.fromCharCode(65+idx)}</span><span>${txt}</span>`;
      btn.addEventListener('click', ()=> selectAnswer(idx));
      box.appendChild(btn);
    });
    resetTimer(30);
  }
  function selectAnswer(idx){
    if(State.quiz.answered) return;
    State.quiz.answered = true;
    clearInterval(State.quiz.timer);
    const correct = State.quiz.correctIndex;
    const list = $$('#choices .choice');
    list.forEach((el,i)=>{
      el.classList.add(i===correct? 'correct':'wrong');
    });
    lockChoices();
    
    // Update category stats
    if (State.selectedCategory) {
      const catName = State.selectedCategory.name;
      if (State.categoryStats[catName]) {
        State.categoryStats[catName].played += 1;
        if (idx === correct) {
          State.categoryStats[catName].correct += 1;
        }
      }
    }
    
    // scoring with time bonus & VIP/boost
    const base = idx===correct ? 100 : 0;
    const timeBonus = idx===correct ? Math.floor( (State.quiz.remain/State.quiz.duration) * 50 ) : 0;
    const boostActive = Date.now() < State.boostUntil;
    const vipBonus = State.vip ? 20 : 0;
    const total = Math.floor((base + timeBonus + vipBonus) * (boostActive?2:1));
    
    if(base>0){
      State.score += total;
      State.coins += 5; // small coin for correct
      State.correctAnswers += 1;
      State.quiz.consecutiveCorrect += 1;
      
      // Add experience
      State.exp += 10;
      checkLevelUp();
      
      // Play success sound if enabled
      if (State.soundEnabled) {
        // In a real app, you would play a success sound here
        console.log('Playing success sound');
      }
    } else {
      State.lives -= 1;
      State.quiz.consecutiveCorrect = 0;
      
      // Play failure sound if enabled
      if (State.soundEnabled) {
        // In a real app, you would play a failure sound here
        console.log('Playing failure sound');
      }
      
      if(State.lives<=0) showContinue();
    }
    
    State.gamesPlayed += 1;
    saveState(); 
    renderHeader(); 
    renderTopBars();
    
    // Check for achievements
    checkAchievements();
    
    // Update best streak
    if (State.streak > State.bestStreak) {
      State.bestStreak = State.streak;
    }
  }
  function checkLevelUp() {
    const expNeeded = State.level * 100;
    if (State.exp >= expNeeded) {
      State.level += 1;
      State.exp = State.exp - expNeeded;
      
      // Show level up notification
      showToast(`Ø³Ø·Ø­ ${State.level} Ø±Ø³ÛŒØ¯ÛŒ!`, 'success');
      
      // Reward coins for leveling up
      const coinsReward = State.level * 10;
      State.coins += coinsReward;
      showToast(`${coinsReward} Ø³Ú©Ù‡ Ø¬Ø§ÛŒØ²Ù‡ Ú¯Ø±ÙØªÛŒ!`, 'success');
      
      // Create confetti
      createConfetti();
      
      // Play level up sound if enabled
      if (State.soundEnabled) {
        // In a real app, you would play a level up sound here
        console.log('Playing level up sound');
      }
    }
  }
  // === Leaderboard ===
  function renderLeaderboard(period = 'weekly') {
    const me = { id: State.user.id, name: State.user.name, score: State.score };
    const arr = [...State.leaderboard.filter(x=>x.id!==me.id), me].sort((a,b)=>b.score-a.score).slice(0,20);
    const wrap = $('#lb-list'); wrap.innerHTML='';
    
    // Update tab buttons
    $$('[data-period]').forEach(btn => {
      btn.classList.toggle('tab-active', btn.dataset.period === period);
    });
    
    arr.forEach((u,i)=>{
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between bg-white/10 border border-white/20 rounded-xl px-4 py-3 card-hover';
      
      let rankIcon = '';
      if(i === 0) rankIcon = '<i class="fas fa-trophy text-yellow-300"></i>';
      else if(i === 1) rankIcon = '<i class="fas fa-medal text-gray-300"></i>';
      else if(i === 2) rankIcon = '<i class="fas fa-award text-amber-700"></i>';
      else rankIcon = `<span class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">${i+1}</span>`;
      
      row.innerHTML = `<div class="flex items-center gap-3">
        ${rankIcon}
        <div>
          <div class="font-bold">${u.name}</div>
          <div class="text-xs opacity-80 flex items-center gap-1">
            <i class="fas fa-star text-yellow-300"></i>
            <span>${fmt(u.score)}</span>
          </div>
        </div>
      </div>`;
      wrap.appendChild(row);
    });
  }
  // === Shop ===
  function buy(item){
    const price = { life:30, boost:50, coins:20, noads:100, vip:200 }[item];
    if(State.coins < price){ 
      showToast('Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª', 'error');
      return; 
    }
    State.coins -= price;
    if(item==='life') State.lives += 1;
    if(item==='boost') State.boostUntil = Date.now() + 10*60*1000; // 10 min
    if(item==='vip') State.vip = true;
    if(item==='coins') State.coins += 100; // Add 100 coins
    if(item==='noads') {
      // In a real app, you would implement ad removal here
      showToast('ØªØ¨Ù„ÛŒØºØ§Øª Ø­Ø°Ù Ø´Ø¯!', 'success');
    }
    
    saveState(); 
    renderDashboard(); 
    renderTopBars(); 
    $('#vip-badge').classList.toggle('hidden', !State.vip);
    
    showToast('Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success');
    
    // Check for VIP achievement
    if (item === 'vip') {
      checkAchievements();
    }
  }
  // === Streak ===
  function claimStreak(){
    const nowDay = Math.floor(Date.now()/86400000);
    if(State.lastClaim === nowDay){ 
      showToast('Ø§Ù…Ø±ÙˆØ² Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒ', 'warning');
      return; 
    }
    const yesterday = nowDay - 1;
    if(State.lastClaim === yesterday) State.streak += 1; else State.streak = 1;
    State.lastClaim = nowDay;
    const reward = 5 * State.streak; // grows with streak
    State.coins += reward; 
    State.score += reward*10;
    saveState(); 
    renderDashboard(); 
    renderHeader();
    
    showToast(`Ù¾Ø§Ø¯Ø§Ø´ Ø§Ù…Ø±ÙˆØ²: ${reward} Ø³Ú©Ù‡ ğŸ‰`, 'success');
    
    // Check for streak achievements
    checkAchievements();
  }
  // === Invite ===
  function doInvite(){
    const link = `https://t.me/share/url?url=${encodeURIComponent('https://t.me/your_bot?start=ref_'+State.user.id)}&text=${encodeURIComponent('Ø¨ÛŒØ§ ØªÙˆ Ù…Ø³Ø§Ø¨Ù‚Ù‡!')}`;
    try{ window.open(link, '_blank'); }catch{ navigator.clipboard.writeText(link); 
      showToast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
    }
  }
  // === Daily Challenge ===
  function startDailyChallenge() {
    // In a real app, this would start a special daily challenge
    showToast('Ú†Ø§Ù„Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯', 'info');
  }
  // === Events ===
  $('#btn-play').addEventListener('click', ()=>{ navTo('categories'); });
  $('#btn-daily').addEventListener('click', startDailyChallenge);
  $('#btn-leaderboard').addEventListener('click', ()=>{ navTo('leaderboard'); });
  $('#btn-shop').addEventListener('click', ()=>{ navTo('shop'); });
  $('#btn-profile').addEventListener('click', ()=>{ navTo('profile'); });
  $('#btn-all-achievements').addEventListener('click', ()=>{ navTo('achievements'); });
  $('#btn-settings').addEventListener('click', ()=>{ navTo('settings'); });
  $('#btn-back-categories').addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-back-lb').addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-back-shop').addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-back-profile').addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-back-achievements').addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-back-settings').addEventListener('click', ()=> navTo('dashboard'));
  $('#btn-quit').addEventListener('click', ()=>{ navTo('dashboard'); });
  $('#btn-continue').addEventListener('click', ()=>{
    if(State.coins>=10){ 
      State.coins-=10; 
      State.lives=1; 
      saveState(); 
      $('#btn-continue').classList.add('hidden'); 
      renderTopBars(); 
      resetTimer(15); 
      $$('#choices .choice').forEach(el=>{ 
        el.classList.remove('wrong','correct','pointer-events-none','opacity-70'); 
      }); 
      State.quiz.answered=false; 
    } else {
      showToast('Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª', 'error');
    }
  });
  $('#btn-claim-streak').addEventListener('click', claimStreak);
  $('#btn-invite').addEventListener('click', doInvite);
  $$('[data-buy]').forEach(b=> b.addEventListener('click', e=> buy(e.currentTarget.dataset.buy)));
  $$('nav [data-tab]').forEach(b=> b.addEventListener('click', e=>{
    const tab = e.currentTarget.dataset.tab;
    if(tab==='quiz'){ navTo('categories'); } else navTo(tab);
  }));
  $$('[data-period]').forEach(b=> b.addEventListener('click', e=> renderLeaderboard(e.currentTarget.dataset.period)));
  
  // Settings event listeners
  $('#sound-toggle').addEventListener('change', e => {
    State.soundEnabled = e.target.checked;
    saveState();
  });
  
  $('#notification-toggle').addEventListener('change', e => {
    State.notificationsEnabled = e.target.checked;
    saveState();
  });
  
  $('#darkmode-toggle').addEventListener('change', e => {
    State.darkMode = e.target.checked;
    saveState();
    // In a real app, you would apply dark mode styles here
    showToast('Ø­Ø§Ù„Øª Ø´Ø¨ ' + (State.darkMode ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„') + ' Ø´Ø¯', 'info');
  });
  
  $('#language-select').addEventListener('change', e => {
    State.language = e.target.value;
    saveState();
    // In a real app, you would change the language here
    showToast('Ø²Ø¨Ø§Ù† Ø¨Ù‡ ' + (State.language === 'fa' ? 'ÙØ§Ø±Ø³ÛŒ' : 'English') + ' ØªØºÛŒÛŒØ± Ú©Ø±Ø¯', 'info');
  });
  
  $('#achievement-filter').addEventListener('change', renderAchievements);
  
  // Tutorial modal events
  $('#close-tutorial').addEventListener('click', () => {
    $('#tutorial-modal').classList.remove('active');
    State.showTutorial = false;
    saveState();
  });
  
  $('#start-tutorial').addEventListener('click', () => {
    $('#tutorial-modal').classList.remove('active');
    State.showTutorial = false;
    saveState();
    navTo('categories');
  });
  
  // Init
  renderHeader(); 
  renderDashboard(); 
  navTo('dashboard');
  
  // Show tutorial if it's the first time
  if (State.showTutorial) {
    $('#tutorial-modal').classList.add('active');
  }
  
  // Check for achievements on load
  checkAchievements();
  </script>
</body>
</html>