<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ورود فروشنده | ویترینت</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(115deg, #e0fdfa 0%, #f8fafc 60%, #d4fbe8 100%);
      min-height: 100vh;
    }
    .glass {
      background: rgba(255,255,255,0.95);
      box-shadow: 0 10px 38px #10b98118, 0 2px 10px #0ea5e915;
      border-radius: 1.7rem;
      backdrop-filter: blur(14px);
      margin-top: 42px;
    }
    .brand-btn {
      background: linear-gradient(90deg, #10b981 10%, #0ea5e9 100%);
      color: #fff !important;
      font-weight: bold;
      border-radius: 1.2rem;
      transition: all .16s;
      box-shadow: 0 2px 12px #10b98120;
    }
    .brand-btn:hover { filter: brightness(1.1);}
    .fadein { animation: fadein .65s;}
    @keyframes fadein {
      from { opacity: 0; transform: translateY(32px);}
      to   { opacity: 1; transform: translateY(0);}
    }
    .header-logo {
      font-weight: bold;
      font-size: 2rem;
      background: linear-gradient(90deg,#10b981 40%,#0ea5e9 70%);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      letter-spacing:1.4px;
      margin-bottom: 1.1rem;
      text-align: center;
      display: block;
      text-decoration: none;
    }
    .header-nav{transition:max-height .3s ease,padding .3s ease;}
    /* استایل مودال جدید */
    .modal-bg {
      background: rgba(22,22,22,0.20);
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      z-index: 100;
      transition: background 0.2s;
    }
    .modal-content {
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 18px 48px #10b9811a;
      padding: 2.1rem 1.6rem 1.4rem 1.6rem;
      max-width: 350px; width: 95vw;
      text-align: center;
      animation: fadein .36s;
      position: relative;
    }
    .modal-content h3 {
      font-size: 1.2rem;
      color: #0ea5e9;
      font-weight: 900;
      margin-bottom: 8px;
      letter-spacing: -.3px;
    }
    .modal-content p {
      color: #64748b;
      font-size: 0.98rem;
      margin-bottom: 16px;
    }
    .modal-content input {
      direction: ltr;
      text-align: left;
    }
    .modal-close-x {
      position: absolute;
      left: 1.1rem;
      top: 1.1rem;
      color: #a0aec0;
      background: none;
      border: none;
      font-size: 1.7rem;
      line-height: 1;
      cursor: pointer;
      transition: color .14s;
    }
    .modal-close-x:hover { color: #0ea5e9;}
    .info-box {
      background: #ecfeff;
      color: #0369a1;
      font-size: 0.88rem;
      border-radius: 1rem;
      padding: 0.75rem 1rem;
      line-height: 1.9;
    }
    .success-box {
      background: #ecfdf5;
      color: #0f766e;
      font-size: 0.88rem;
      border-radius: 1rem;
      padding: 0.75rem 1rem;
      line-height: 1.9;
    }
    .otp-input {
      letter-spacing: 0.45rem;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 800;
      direction: ltr;
    }
    .otp-helper button {
      color: #0ea5e9;
      font-weight: 700;
    }
    .otp-helper button:hover {
      color: #10b981;
    }
    @media (max-width: 640px) {
      .glass {padding: 1.1rem .6rem !important;}
      .header-logo {font-size: 1.4rem;}
      .header-nav {max-height:0; padding-top:0; padding-bottom:0; overflow:hidden;}
      #nav-toggle:checked + .header-nav {max-height:12rem; padding-top:.5rem; padding-bottom:.5rem;}
      .modal-content {padding: 1.3rem .5rem 1rem .5rem;}
    }
  </style>
  <script src="/nav-active.js" defer></script>
</head>
<body class="text-gray-800">

  <!-- هدر شیشه‌ای -->
  <header class="w-full bg-white/90 shadow-sm backdrop-blur-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-3 sm:px-6 py-2 sm:py-3 flex flex-col sm:flex-row items-center sm:justify-between gap-y-2">
      <div class="flex items-center justify-between w-full sm:w-auto">
        <a href="../index.html" class="header-logo font-bold text-[1.55rem] sm:text-[1.9rem] md:text-[2.05rem] bg-gradient-to-l from-[#11d6ad] via-[#10b981] to-[#2db4e8] bg-clip-text text-transparent" style="letter-spacing:1.7px;">ویترینت</a>
        <label for="nav-toggle" class="sm:hidden text-gray-700 text-2xl cursor-pointer p-2">&#9776;</label>
      </div>
      <input type="checkbox" id="nav-toggle" class="hidden peer">
      <nav class="header-nav flex flex-col sm:flex-row items-center justify-end gap-2 sm:gap-4 w-full sm:w-auto text-[0.9rem] sm:text-base">
        <a href="../index.html" class="block px-3 py-2 sm:px-3 sm:py-0 text-gray-700 hover:text-[#10b981] font-bold transition">خانه</a>
        <a href="categories.html" class="block px-3 py-2 sm:px-3 sm:py-0 text-gray-700 hover:text-[#0ea5e9] font-bold transition">دسته‌بندی</a>
        <a href="login.html" class="block px-3 py-2 sm:px-3 sm:py-0 text-gray-700 hover:text-[#0ea5e9] font-bold transition">ورود</a>
      </nav>
    </div>
  </header>

  <!-- فرم ورود -->
  <main class="max-w-xl mx-auto min-h-screen flex flex-col justify-center items-center px-2" style="margin-top:36px;">
    <section class="glass border rounded-2xl shadow-2xl p-6 sm:p-10 w-full fadein" id="login-section">
      <a href="../index.html" class="header-logo">ویترینت</a>
      <h2 class="text-2xl sm:text-3xl font-extrabold text-[#10b981] mb-7 text-center">ورود به حساب فروشنده</h2>
      <form id="login-form" class="space-y-6" autocomplete="on" novalidate>
        <div>
          <label class="block text-sm font-bold mb-1" for="phone">شماره موبایل <span class="text-red-500">*</span></label>
          <input type="text" id="phone" maxlength="11" inputmode="numeric"
            class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200 bg-gray-50 text-left ltr"
            placeholder="09121234567" required />
        </div>
        <div>
          <label class="block text-sm font-bold mb-1" for="password">رمز عبور <span class="text-red-500">*</span></label>
          <div class="relative">
            <input type="password" id="password"
              class="w-full p-3 pl-10 border rounded-xl focus:ring-2 focus:ring-green-200 bg-gray-50"
              placeholder="رمز عبور" required autocomplete="current-password" />
            <button type="button" id="toggle-password"
              class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
              <svg id="eye-open" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              <svg id="eye-closed" class="w-5 h-5 hidden" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18"/>
              </svg>
            </button>
          </div>
        </div>
        <button type="submit" class="w-full brand-btn text-white py-3 rounded-xl font-bold text-lg shadow-md hover:opacity-90 transition mt-2">ورود</button>
        <div class="flex flex-row-reverse justify-between items-center mt-2">
          <button type="button" id="forgot-btn" class="flex items-center gap-1 text-xs text-[#0ea5e9] underline hover:text-[#10b981] font-bold transition">
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 15v2m0 4a9 9 0 1 0-9-9m9 13a4 4 0 0 1-4-4h8a4 4 0 0 1-4 4z" stroke-linecap="round" stroke-linejoin="round"/></svg>
            فراموشی رمز عبور؟
          </button>
          <span class="text-xs text-gray-500">رمز را فراموش کردید؟</span>
        </div>
        <div id="error-message" class="text-red-500 text-center text-sm mt-1 min-h-[22px]"></div>
      </form>
      <div class="text-center text-sm mt-5">
        <span>فروشنده جدید هستید؟ </span>
        <a href="../post.html" class="text-[#0ea5e9] underline hover:text-[#10b981] font-bold">ساخت حساب فروشندگی</a>
      </div>
    </section>
  </main>

  <!-- Modal: فراموشی رمز عبور -->
  <div id="modal-bg" class="modal-bg hidden">
    <div class="modal-content">
      <button type="button" class="modal-close-x" id="modal-close" title="بستن">&times;</button>
      <h3>بازیابی رمز عبور</h3>
      <p id="forgot-description" class="leading-relaxed text-sm sm:text-base">شماره موبایل خود را وارد کنید تا کد تأیید برایتان ارسال شود.</p>
      <form id="forgot-form" class="space-y-4">
        <div id="forgot-step-phone" class="space-y-3">
          <input type="text" id="forgot-phone" maxlength="11" inputmode="numeric"
            class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200 bg-gray-50 text-left ltr"
            placeholder="مثلاً 09123456789" required />
        </div>
        <div id="forgot-step-otp" class="space-y-3 hidden">
          <div class="text-sm text-gray-600 leading-relaxed">
            کد ۴ رقمی ارسال‌شده به شمارهٔ <span id="otp-phone" class="font-semibold text-gray-900"></span> را وارد کنید.
          </div>
          <input type="text" id="forgot-otp" maxlength="4" inputmode="numeric"
            class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200 bg-gray-50 otp-input"
            placeholder="----" />
          <div class="flex items-center justify-between text-[0.7rem] sm:text-xs text-gray-500 otp-helper">
            <button type="button" id="otp-edit" class="transition">ویرایش شماره</button>
            <button type="button" id="otp-resend" class="transition">ارسال مجدد کد</button>
          </div>
        </div>
        <div id="forgot-step-reset" class="space-y-3 hidden">
          <div>
            <input type="password" id="new-password"
              class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200 bg-gray-50"
              placeholder="رمز عبور جدید" />
          </div>
          <div>
            <input type="password" id="confirm-password"
              class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-200 bg-gray-50"
              placeholder="تکرار رمز عبور" />
          </div>
        </div>
        <div id="forgot-info" class="info-box text-xs sm:text-sm hidden"></div>
        <div id="forgot-success" class="success-box text-xs sm:text-sm hidden"></div>
        <div id="forgot-error" class="text-red-500 text-xs min-h-[22px]"></div>
        <button type="submit" id="forgot-submit" class="brand-btn text-white py-3 px-5 rounded-xl font-bold text-base w-full">ارسال کد تأیید</button>
        <button type="button" id="modal-cancel" class="w-full text-gray-500 mt-1 font-bold hover:text-[#0ea5e9] transition">انصراف</button>
      </form>
    </div>
  </div>

  <!-- فوتر -->
  <footer class="mt-20 bg-white border-t text-center text-sm text-gray-500 py-4">
    © 2025 <span class="font-bold text-[#10b981]">ویترینت</span> | همه حقوق محفوظ است.
  </footer>

<script>
  // --- المان‌های صفحه ---
  const phoneInput  = document.getElementById('phone');
  const form        = document.getElementById('login-form');
  const errorBox    = document.getElementById('error-message');
  const forgotBtn   = document.getElementById('forgot-btn');
  const modalBg     = document.getElementById('modal-bg');
  const modalClose  = document.getElementById('modal-close');
  const modalCancel = document.getElementById('modal-cancel');
  const forgotForm  = document.getElementById('forgot-form');
  const forgotPhone = document.getElementById('forgot-phone');
  const forgotError = document.getElementById('forgot-error');
  const forgotDescription = document.getElementById('forgot-description');
  const forgotSubmit = document.getElementById('forgot-submit');
  const forgotInfo = document.getElementById('forgot-info');
  const forgotSuccess = document.getElementById('forgot-success');
  const stepPhone = document.getElementById('forgot-step-phone');
  const stepOtp = document.getElementById('forgot-step-otp');
  const stepReset = document.getElementById('forgot-step-reset');
  const otpPhone = document.getElementById('otp-phone');
  const otpInput = document.getElementById('forgot-otp');
  const otpEdit = document.getElementById('otp-edit');
  const otpResend = document.getElementById('otp-resend');
  const newPasswordInput = document.getElementById('new-password');
  const confirmPasswordInput = document.getElementById('confirm-password');
  const passwordInput = document.getElementById('password');
  const togglePassword = document.getElementById('toggle-password');
  const eyeOpen = document.getElementById('eye-open');
  const eyeClosed = document.getElementById('eye-closed');

  togglePassword.addEventListener('click', () => {
    const isHidden = passwordInput.type === 'password';
    passwordInput.type = isHidden ? 'text' : 'password';
    eyeOpen.classList.toggle('hidden', isHidden);
    eyeClosed.classList.toggle('hidden', !isHidden);
    passwordInput.focus();
  });

  // --- محدود کردن شماره موبایل به 11 رقم ---
  phoneInput.addEventListener('input', () => {
    phoneInput.value = phoneInput.value.replace(/[^0-9]/g, '').slice(0, 11);
  });

  // --- ارسال فرم لاگین ---
  form.addEventListener('submit', async e => {
    e.preventDefault();
    errorBox.textContent = '';

    const phone    = phoneInput.value.trim();
    const password = passwordInput.value;

    if (phone.length !== 11 || !phone.startsWith('09')) {
      errorBox.textContent = 'شماره موبایل معتبر وارد کنید.';
      return;
    }

    try {
      const res = await fetch('http://localhost:5000/api/auth/login', {
        method: 'POST',
        credentials: 'include', // ارسال/دریافت کوکی HttpOnly
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone, password })
      });
      const data = await res.json();

      if (!res.ok) {
        errorBox.textContent = data.message || 'ورود ناموفق بود.';
      } else {
        // موفقیت: تصمیم‌گیری برای پنل مناسب
        // Decide panel by category (consistent with public/verify.html)
        const SERVICE_CATEGORIES = ["خدمات","زیبایی","تالار و مجالس","خودرو","ورزشی"];

        const catRaw   = (data?.seller?.category ?? "").trim();
        const category = catRaw.normalize("NFC");
        const isServiceByCat  = SERVICE_CATEGORIES.includes(category);
        const isServiceByType = (data?.seller?.type === "service");
        const isServiceSeller = isServiceByType || isServiceByCat;

        const panel   = isServiceSeller
          ? "../service-seller-panel/s-seller-panel.html"
          : "dashboard.html";

        const shopurl = (data?.seller?.shopurl ?? "").trim();
        const target  = shopurl
          ? `${panel}?shopurl=${encodeURIComponent(shopurl)}`
          : panel;

        window.location.href = target;
      }
    } catch (err) {
      console.error('خطا در ورود:', err);
      errorBox.textContent = 'خطا در ارتباط با سرور.';
    }
  });

  // --- مدال فراموشی رمز ---
  const OTP_CODE = '1234';
  let forgotStep = 1;
  let storedPhone = '';

  const setInfoMessage = msg => {
    if (msg) {
      forgotInfo.textContent = msg;
      forgotInfo.classList.remove('hidden');
    } else {
      forgotInfo.textContent = '';
      forgotInfo.classList.add('hidden');
    }
  };

  const setSuccessMessage = msg => {
    if (msg) {
      forgotSuccess.textContent = msg;
      forgotSuccess.classList.remove('hidden');
    } else {
      forgotSuccess.textContent = '';
      forgotSuccess.classList.add('hidden');
    }
  };

  const maskPhone = phone => phone.replace(/(\d{4})(\d{3})(\d{4})/, '$1-$2-$3');

  const setForgotStep = step => {
    forgotStep = step;
    stepPhone.classList.toggle('hidden', step !== 1);
    stepOtp.classList.toggle('hidden', step !== 2);
    stepReset.classList.toggle('hidden', step !== 3);
    const isDone = step === 4;
    forgotError.textContent = '';
    if (!isDone) setSuccessMessage('');

    if (step === 1) {
      forgotDescription.textContent = 'شماره موبایل ثبت‌شده در ویترینت را وارد کنید تا کد تأیید برای شما پیامک شود.';
      forgotSubmit.textContent = 'ارسال کد تأیید';
      setInfoMessage('برای نسخهٔ نمایشی، کد تأیید «1234» است.');
      setTimeout(() => forgotPhone.focus(), 0);
    } else if (step === 2) {
      forgotDescription.textContent = 'کد ۴ رقمی ارسال‌شده به شمارهٔ زیر را وارد کنید.';
      forgotSubmit.textContent = 'تأیید کد';
      otpPhone.textContent = storedPhone ? maskPhone(storedPhone) : '';
      otpInput.value = '';
      setInfoMessage(`کد نمایشی: ${OTP_CODE}`);
      setTimeout(() => otpInput.focus(), 0);
    } else if (step === 3) {
      forgotDescription.textContent = 'رمز عبور جدیدی تعیین کنید.';
      forgotSubmit.textContent = 'ثبت رمز جدید';
      newPasswordInput.value = '';
      confirmPasswordInput.value = '';
      setInfoMessage('رمز عبور باید حداقل ۶ کاراکتر باشد.');
      setTimeout(() => newPasswordInput.focus(), 0);
    } else if (step === 4) {
      forgotDescription.textContent = 'رمز عبور جدید با موفقیت ثبت شد.';
      forgotSubmit.textContent = 'بازگشت به ورود';
      setInfoMessage('');
      setSuccessMessage('اکنون می‌توانید با رمز جدید وارد شوید.');
    }
  };

  const resetForgotFlow = () => {
    storedPhone = '';
    forgotForm.reset();
    setForgotStep(1);
  };

  forgotBtn.addEventListener('click', () => {
    modalBg.classList.remove('hidden');
    resetForgotFlow();
  });
  modalClose.addEventListener('click', () => {
    modalBg.classList.add('hidden');
    resetForgotFlow();
  });
  modalCancel.addEventListener('click', () => {
    modalBg.classList.add('hidden');
    resetForgotFlow();
  });
  modalBg.addEventListener('click', e => {
    if (e.target === modalBg) {
      modalBg.classList.add('hidden');
      resetForgotFlow();
    }
  });

  // --- محدود کردن شماره در فراموشی رمز ---
  forgotPhone.addEventListener('input', () => {
    forgotPhone.value = forgotPhone.value.replace(/[^0-9]/g, '').slice(0, 11);
    forgotError.textContent = '';
  });

  otpInput?.addEventListener('input', () => {
    otpInput.value = otpInput.value.replace(/[^0-9]/g, '').slice(0, 4);
  });

  otpEdit?.addEventListener('click', () => {
    setForgotStep(1);
    if (storedPhone) {
      forgotPhone.value = storedPhone;
      setTimeout(() => forgotPhone.setSelectionRange(0, forgotPhone.value.length), 0);
    }
  });

  otpResend?.addEventListener('click', () => {
    setSuccessMessage(`کد جدید ارسال شد (کد نمایشی: ${OTP_CODE}).`);
  });

  // --- ارسال فرم فراموشی رمز ---
  forgotForm.addEventListener('submit', e => {
    e.preventDefault();

    if (forgotStep === 1) {
      const p = forgotPhone.value.trim();
      if (p.length !== 11 || !p.startsWith('09')) {
        forgotError.textContent = 'شماره موبایل معتبر وارد کنید.';
        return;
      }
      storedPhone = p;
      setForgotStep(2);
      setSuccessMessage(`کد تأیید برای شمارهٔ شما ارسال شد (کد نمایشی: ${OTP_CODE}).`);
      return;
    }

    if (forgotStep === 2) {
      const code = otpInput.value.trim();
      if (code.length !== 4) {
        forgotError.textContent = 'کد تأیید ۴ رقمی را کامل وارد کنید.';
        return;
      }
      if (code !== OTP_CODE) {
        forgotError.textContent = 'کد واردشده صحیح نیست.';
        return;
      }
      setForgotStep(3);
      return;
    }

    if (forgotStep === 3) {
      const newPass = newPasswordInput.value.trim();
      const confirmPass = confirmPasswordInput.value.trim();

      if (newPass.length < 6) {
        forgotError.textContent = 'رمز عبور باید حداقل ۶ کاراکتر باشد.';
        return;
      }
      if (newPass !== confirmPass) {
        forgotError.textContent = 'رمز و تکرار آن یکسان نیست.';
        return;
      }

      phoneInput.value = storedPhone;
      passwordInput.value = newPass;
      setForgotStep(4);
      return;
    }

    if (forgotStep === 4) {
      modalBg.classList.add('hidden');
      resetForgotFlow();
    }
  });
</script>


</body>
</html>
