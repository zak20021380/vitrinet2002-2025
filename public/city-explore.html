<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>شهر رو بگرد | ویترینت</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
  <script src="/js/runtime-config.js" defer></script>
  <script src="/js/analytics.js" defer></script>
  <script src="/nav-active.js" defer></script>
  <style>
    :root {
      --brand-sky: #0ea5e9;
      --brand-mint: #10b981;
      --text-strong: #0f172a;
      --surface: #ffffff;
      --muted: #94a3b8;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
      --shadow-card: 0 12px 36px rgba(14, 165, 233, 0.09);
      --radius-lg: 1.1rem;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Vazirmatn', 'Montserrat', sans-serif;
      background: #f8fafc;
      color: var(--text-strong);
      letter-spacing: normal;
    }

    a { color: inherit; text-decoration: none; }

    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255, 255, 255, 0.94);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid #e2e8f0;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
    }

    .main-shell { max-width: 1200px; margin: 0 auto; padding: 1.25rem 1rem; }
    .header-inner { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; flex-wrap: wrap; }
    .logo { display: inline-flex; align-items: center; gap: 0.75rem; font-weight: 900; color: var(--brand-mint); }
    .logo svg { width: 42px; height: 42px; filter: drop-shadow(0 8px 18px rgba(16, 185, 129, 0.35)); }

    .pill { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.65rem 1rem; border-radius: 999px; background: linear-gradient(90deg, rgba(16,185,129,0.1), rgba(14,165,233,0.1)); color: var(--brand-mint); font-weight: 800; box-shadow: inset 0 1px 0 rgba(255,255,255,0.7); }

    .actions { display: flex; align-items: center; gap: 0.6rem; flex-wrap: wrap; justify-content: flex-end; }
    .btn { border: none; cursor: pointer; font-weight: 800; border-radius: 999px; transition: transform 0.15s ease, box-shadow 0.2s ease; }
    .btn-ghost { padding: 0.75rem 1.25rem; background: #fff; color: var(--brand-mint); border: 1px solid rgba(16, 185, 129, 0.18); box-shadow: var(--shadow-soft); }
    .btn-primary { padding: 0.8rem 1.45rem; background: linear-gradient(120deg, var(--brand-sky), var(--brand-mint)); color: #fff; box-shadow: 0 16px 40px rgba(14,165,233,0.35); }
    .btn:active { transform: translateY(1px) scale(.99); }

    main { max-width: 1100px; margin: 0 auto; padding: 2rem 1rem 3rem; }
    h1 { margin: 0 0 1rem; text-align: center; font-size: clamp(1.6rem, 2vw + 1rem, 2.5rem); background: linear-gradient(120deg, var(--brand-mint), var(--brand-sky)); color: transparent; -webkit-background-clip: text; background-clip: text; letter-spacing: -0.02em; }

    .area-row { display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem 0; }
    .areas-scroll { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.25rem; scrollbar-width: thin; }
    .areas-scroll::-webkit-scrollbar { height: 8px; }
    .areas-scroll::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.5); border-radius: 999px; }
    .area-btn { border: none; background: #fff; color: var(--brand-mint); padding: 0.75rem 1.15rem; border-radius: 999px; font-weight: 800; white-space: nowrap; box-shadow: var(--shadow-soft); transition: all 0.2s ease; }
    .area-btn:hover, .area-btn.active { background: linear-gradient(120deg, var(--brand-mint), var(--brand-sky)); color: #fff; box-shadow: 0 14px 36px rgba(14, 165, 233, 0.25); }

    .filter-row { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; justify-content: space-between; margin: 1.5rem 0 1rem; }
    .search { flex: 1 1 260px; display: flex; align-items: center; background: #fff; border-radius: 999px; padding: 0.2rem 0.75rem; border: 1px solid #e2e8f0; box-shadow: var(--shadow-soft); }
    .search input { width: 100%; padding: 0.75rem; border: none; outline: none; background: transparent; font-size: 1rem; }
    .select-wrap { position: relative; min-width: 180px; }
    .category-select { width: 100%; padding: 0.85rem 1rem; padding-right: 2.8rem; border-radius: 999px; border: 1px solid #dfe7ef; background: #fff; color: var(--text-strong); font-weight: 700; text-align: right; appearance: none; outline: none; box-shadow: var(--shadow-soft); direction: rtl; }
    .category-select:focus { border-color: rgba(14,165,233,0.6); box-shadow: 0 14px 30px rgba(14,165,233,0.18); }
    .select-wrap::after { content: '\ea4e'; font-family: 'remixicon'; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--brand-mint); font-size: 1.3rem; pointer-events: none; }

    .center-actions { display: flex; gap: 0.65rem; flex-wrap: wrap; justify-content: center; }
    .center-btn { background: #fff; color: var(--brand-mint); border: 1px solid rgba(16,185,129,0.2); padding: 0.8rem 1.35rem; border-radius: 999px; font-weight: 800; box-shadow: var(--shadow-soft); transition: all 0.18s ease; }
    .center-btn:hover, .center-btn.active { background: linear-gradient(120deg, var(--brand-mint), var(--brand-sky)); color: #fff; box-shadow: 0 18px 36px rgba(14,165,233,0.22); }

    .shops-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1rem; }
    .shop-card { position: relative; display: flex; flex-direction: column; gap: 0.75rem; background: #fff; border-radius: var(--radius-lg); padding: 0.9rem; box-shadow: var(--shadow-card); border: 1px solid #e2e8f0; transition: transform 0.18s ease, box-shadow 0.18s ease; }
    .shop-card:hover { transform: translateY(-4px); box-shadow: 0 16px 38px rgba(15, 23, 42, 0.12); }
    .shop-thumb { position: relative; width: 100%; aspect-ratio: 4 / 3; border-radius: 0.85rem; overflow: hidden; background: #f8fafc; }
    .shop-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; transition: transform 0.2s ease; }
    .shop-card:hover .shop-thumb img { transform: scale(1.03); }
    .tag-row { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
    .badge { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; border-radius: 999px; font-weight: 800; font-size: 0.8rem; }
    .badge.green { background: rgba(16,185,129,0.1); color: #0f9a8b; }
    .badge.blue { background: rgba(14,165,233,0.1); color: var(--brand-sky); }
    .shop-name { margin: 0; font-size: 1.05rem; font-weight: 800; text-align: center; color: var(--text-strong); }
    .shop-address { text-align: center; font-weight: 700; color: #0f9a8b; font-size: 0.95rem; }
    .shop-meta { display: flex; align-items: center; justify-content: center; gap: 0.35rem; color: #475569; font-weight: 600; font-size: 0.85rem; }
    .shop-footer { display: flex; align-items: center; justify-content: space-between; color: var(--brand-sky); font-weight: 800; font-size: 0.9rem; }

    .selected-center { display: inline-flex; align-items: center; gap: 0.45rem; background: #fff; color: var(--brand-sky); padding: 0.65rem 1rem; border-radius: 999px; border: 1px solid rgba(14,165,233,0.2); box-shadow: var(--shadow-soft); font-weight: 800; }

    /* Centers modal */
    .centers-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 1200; }
    .centers-modal.active { display: flex; }
    .centers-overlay { position: absolute; inset: 0; background: rgba(15,23,42,0.35); backdrop-filter: blur(6px); }
    .centers-content { position: relative; width: min(100%, 760px); background: #fff; border-radius: 1.5rem; padding: 1.5rem 1.75rem; box-shadow: 0 24px 60px rgba(15,23,42,0.22); border: 1px solid #e2e8f0; max-height: calc(100dvh - 2rem); overflow: hidden; display: flex; flex-direction: column; gap: 1rem; }
    .centers-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.85rem; overflow: auto; padding-right: 0.35rem; }
    .center-item { display: flex; align-items: center; gap: 0.65rem; padding: 0.8rem; background: #f8fafc; border-radius: 1rem; border: 1px solid #e2e8f0; box-shadow: var(--shadow-soft); }
    .center-name { flex: 1; text-align: right; font-weight: 800; color: var(--text-strong); }
    .center-info-btn { border: none; padding: 0.5rem 0.9rem; border-radius: 999px; background: linear-gradient(120deg, var(--brand-sky), var(--brand-mint)); color: #fff; font-weight: 800; cursor: pointer; box-shadow: 0 12px 28px rgba(14,165,233,0.25); }
    .modal-close { position: absolute; inset-inline-end: 1rem; top: 1rem; background: #fff; border: 1px solid #e2e8f0; width: 42px; height: 42px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: var(--shadow-soft); color: var(--text-strong); }
    .modal-handle { width: 90px; height: 6px; border-radius: 999px; background: #cbd5e1; margin: 0 auto; }
    .mobile-close-btn { display: none; }

    /* Center info popup */
    .center-info-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 1300; }
    .center-info-modal.active { display: flex; }
    .center-card { position: relative; background: #fff; border-radius: 1.25rem; padding: 1.5rem; width: min(100%, 420px); box-shadow: 0 24px 60px rgba(15,23,42,0.2); border: 1px solid #e2e8f0; }
    .center-card h3 { margin: 0; font-size: 1.15rem; color: var(--brand-mint); }
    .center-card p { margin: 0.4rem 0 0; color: #475569; font-weight: 700; line-height: 1.7; }
    .center-info-close { position: absolute; inset-inline-start: 0.75rem; top: 0.75rem; background: transparent; border: none; font-size: 1.6rem; cursor: pointer; color: var(--muted); }

    footer { margin-top: 2.5rem; text-align: center; color: #94a3b8; padding: 2rem 1rem 1.5rem; background: linear-gradient(180deg, rgba(255,255,255,0), #eef9f4); font-weight: 700; }

    /* Desktop areas become wrapped grid */
    @media (min-width: 1024px) {
      .areas-scroll { flex-wrap: wrap; overflow: visible; justify-content: center; }
      .areas-scroll::-webkit-scrollbar { display: none; }
    }

    /* Mobile tweaks */
    @media (max-width: 640px) {
      .main-shell { padding: 1rem 0.85rem; }
      .filter-row { flex-direction: column; align-items: stretch; }
      .select-wrap { width: 100%; }
      .center-actions { flex-direction: column; }
      .centers-content { border-radius: 1.4rem 1.4rem 0 0; padding-bottom: 4.5rem; max-height: 90dvh; }
      .centers-modal { align-items: flex-end; }
      .mobile-close-btn { display: block; position: sticky; bottom: 0; width: calc(100% + 3.5rem); margin-inline: -1.75rem; margin-top: 0.75rem; padding: 1rem 1.25rem; border: none; border-radius: 0 0 1.4rem 1.4rem; background: #0f9a8b; color: #fff; font-weight: 800; cursor: pointer; box-shadow: 0 -6px 24px rgba(15,23,42,0.16); }
      .modal-close { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="main-shell header-inner">
      <a href="index.html" class="logo" aria-label="ویترینت">
        <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" role="presentation">
          <defs>
            <linearGradient id="vtMarkGradient" x1="0%" y1="100%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#0ea5e9" />
              <stop offset="55%" stop-color="#10b981" />
            </linearGradient>
          </defs>
          <circle cx="24" cy="24" r="22" fill="url(#vtMarkGradient)" />
          <path d="M15.5 16h4.7l4.3 10.6L28.8 16h4.7L26 33h-4.2L15.5 16Z" fill="#0f172a" fill-opacity="0.9" />
          <path d="M18.2 17.6 24 31.1l5.8-13.5" fill="none" stroke="#22c55e" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <div>
          <div style="font-size:1.2rem;">Vitreenet</div>
          <div style="font-size:0.95rem; color:#0f9a8b;">ویترینت</div>
        </div>
      </a>
      <div class="pill" id="headerCity">سنندج</div>
      <div class="actions">
        <a class="btn btn-ghost" href="login.html">ورود</a>
        <a class="btn btn-primary" href="post.html">ثبت فروشگاه</a>
      </div>
    </div>
  </header>

  <main>
    <section class="text-center">
      <h1>مغازه‌های شهر رو بگرد!</h1>
      <div class="center-actions">
        <button class="center-btn" id="all-centers-btn" type="button">همه مراکز خرید</button>
        <button class="center-btn" id="more-centers-btn" type="button">مشاهده همه مراکز</button>
      </div>
      <div id="selectedCenterIndicator" class="selected-center" style="margin-top:0.8rem; display:none;">
        <span class="ri-map-pin-2-line" aria-hidden="true"></span>
        <span>مرکز خرید انتخاب شده:</span>
        <span id="selectedCenterName"></span>
      </div>
    </section>

    <section class="area-row" aria-label="مناطق معروف">
      <div class="areas-scroll" id="areasShort"></div>
    </section>

    <section class="filter-row">
      <div class="search">
        <span class="ri-search-line" style="color:#0ea5e9; font-size:1.2rem; padding-inline:0.5rem;"></span>
        <input id="searchInput" type="text" placeholder="جستجوی نام یا آدرس مغازه..." aria-label="جستجو" />
      </div>
      <div class="select-wrap">
        <select id="categorySelect" class="category-select">
          <option value="">همه فروشگاه ها</option>
        </select>
      </div>
    </section>

    <section aria-live="polite">
      <div id="shopsList" class="shops-grid"></div>
      <div id="noResult" style="display:none; text-align:center; color:#94a3b8; font-weight:800; padding:2rem;">هیچ مغازه‌ای پیدا نشد!</div>
    </section>
  </main>

  <div id="centersModal" class="centers-modal" role="dialog" aria-modal="true" aria-labelledby="centersTitle" aria-describedby="centersDesc">
    <div id="centersModalOverlay" class="centers-overlay"></div>
    <div class="centers-content">
      <button id="closeCentersModal" class="modal-close" aria-label="بستن">&times;</button>
      <div class="modal-handle" aria-hidden="true"></div>
      <div>
        <h2 id="centersTitle" style="margin:0 0 0.35rem; font-size:1.35rem; color:var(--brand-sky);">مراکز خرید سنندج</h2>
        <p id="centersDesc" style="margin:0; color:#475569; font-weight:700;">برای مشاهده فروشگاه‌های هر مرکز خرید، نام مرکز را انتخاب کنید.</p>
      </div>
      <div id="centersList" class="centers-grid"></div>
      <button id="closeCentersModalMobile" type="button" class="mobile-close-btn">بستن</button>
    </div>
  </div>

  <div id="centerInfoModal" class="center-info-modal" role="dialog" aria-modal="true" aria-labelledby="centerInfoTitle">
    <div id="centerInfoOverlay" class="centers-overlay"></div>
    <div class="center-card">
      <button id="closeCenterInfo" class="center-info-close" aria-label="بستن">&times;</button>
      <h3 id="centerInfoTitle"></h3>
      <p class="text-sm" id="centerInfoAddress"></p>
      <p id="centerInfoEmpty" class="text-sm" style="display:none;">آدرسی برای این مرکز خرید ثبت نشده است.</p>
    </div>
  </div>

  <footer>© 2025 ویترینت | همه حقوق محفوظ است.</footer>

  <script>
    const API_BASE = 'http://localhost:5000/api';
    const API_ORIGIN = 'http://localhost:5000';

    const CATEGORY_OPTIONS = [
      { value: '', label: 'همه فروشگاه ها' },
      { value: 'پوشاک', label: 'پوشاک' },
      { value: 'خوراک', label: 'خوراک' },
      { value: 'خدمات', label: 'خدمات' },
      { value: 'دیجیتال', label: 'دیجیتال' },
      { value: 'زیبایی', label: 'زیبایی' },
      { value: 'کتاب و تحریر', label: 'کتاب و تحریر' },
      { value: 'لوازم خانگی', label: 'لوازم خانگی' },
      { value: 'ورزشی', label: 'ورزشی' },
      { value: 'تالار و مجالس', label: 'تالار و مجالس' },
      { value: 'قنادی و شیرینی', label: 'قنادی و شیرینی' },
      { value: 'گل و گیاه', label: 'گل و گیاه' },
      { value: 'خودرو', label: 'خودرو' }
    ];

    const debounce = (fn, delay = 550) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    };

    const FALLBACK_CENTERS = [
      { id: 'baneta', title: 'بانتا', order: 0 },
      { id: 'ferdowsi', title: 'فردوسی', order: 1 },
      { id: 'sanacenter', title: 'سنه سنتر', order: 2 },
      { id: 'tanakora', title: 'تاناکورا', order: 3 },
      { id: 'almas', title: 'الماس غرب', order: 4 },
      { id: 'abidar', title: 'آبیدر', order: 5 },
      { id: 'navid', title: 'نوید', order: 6 },
      { id: 'ghezel', title: 'قزل قایا', order: 7 },
      { id: 'shahrak', title: 'شهرک بهاران', order: 8 },
      { id: 'azadi', title: 'میدان آزادی', order: 9 },
      { id: 'masjed', title: 'خیابان مسجد جامع', order: 10 },
      { id: 'mellat', title: 'پارک ملت', order: 11 },
      { id: 'salar', title: 'سالار', order: 12 },
      { id: 'parastar', title: 'پرستار', order: 13 },
      { id: 'emam', title: 'بلوار امام', order: 14 },
      { id: 'ghadir', title: 'قدیر', order: 15 },
      { id: 'shohada', title: 'بلوار شهدا', order: 16 },
    ];

    let AREAS = [];
    let centersLoaded = false;
    let centersLoadingPromise = null;
    let current = { area: null, category: '', search: '' };

    const normalizeForSearch = text => {
      if (!text) return '';
      return text.toString().trim().toLowerCase().replace(/ي/g, 'ی').replace(/ك/g, 'ک');
    };

    const slugifyCenter = (title, fallback = 'center') => {
      const base = normalizeForSearch(title || '').replace(/[^\p{L}\p{N}\s-]+/gu, '');
      if (!base) return fallback;
      return base.trim().replace(/\s+/g, '-');
    };

    const sortCenters = list => [...list].sort((a, b) => {
      const orderA = Number.isFinite(a?.order) ? a.order : 0;
      const orderB = Number.isFinite(b?.order) ? b.order : 0;
      if (orderA !== orderB) return orderA - orderB;
      return (a?.name || '').localeCompare(b?.name || '', 'fa');
    });

    const buildCenterKeywords = center => {
      const keywords = new Set();
      const add = value => { const normalized = normalizeForSearch(value); if (normalized) keywords.add(normalized); };
      add(center.title); add(center.name); add(center.tag); add(center.location);
      if (center.slug) { add(center.slug.replace(/-/g, ' ')); add(center.slug.replace(/-/g, '')); }
      return Array.from(keywords);
    };

    const normalizeCenterRecord = (center, index = 0) => {
      if (!center) return null;
      const rawId = center.centerId || center._id || center.id || center._id?.$oid || '';
      const title = center.title || center.name || center.label || '';
      const slug = slugifyCenter(title || rawId || `center-${index}`, `center-${index}`);
      const id = rawId ? String(rawId) : (center.id ? String(center.id) : slug);
      const order = Number.isFinite(Number(center.order)) ? Number(center.order) : (Number.isFinite(Number(center.rank)) ? Number(center.rank) : (Number.isFinite(Number(center.position)) ? Number(center.position) : (center.orderIndex ?? index)));
      const record = { id, name: title || slug, title: title || slug, slug, location: center.location || center.address || '', tag: center.tag || center.badge || '', stores: Number.isFinite(Number(center.stores)) ? Number(center.stores) : (Number(center.shopCount) || 0), order, raw: center };
      record.matchKeywords = buildCenterKeywords(record);
      return record;
    };

    async function loadCentersFromBackend(force = false) {
      if (force) { centersLoaded = false; centersLoadingPromise = null; }
      if (centersLoaded && !force) return AREAS;
      if (!centersLoadingPromise) {
        centersLoadingPromise = (async () => {
          try {
            const res = await fetch(`${API_BASE}/shopping-centers`);
            if (res.ok) {
              const data = await res.json();
              if (Array.isArray(data) && data.length) {
                const normalized = data.map((center, idx) => normalizeCenterRecord(center, idx)).filter(Boolean);
                if (normalized.length) { AREAS = sortCenters(normalized); centersLoaded = true; return AREAS; }
              }
            }
          } catch (err) {
            console.warn('loadCentersFromBackend error:', err);
          }
          AREAS = sortCenters(FALLBACK_CENTERS.map((center, idx) => normalizeCenterRecord(center, idx)).filter(Boolean));
          centersLoaded = true; return AREAS;
        })().finally(() => { centersLoadingPromise = null; });
      }
      return centersLoadingPromise;
    }

    const detectCenterForShop = shop => {
      if (!shop || !AREAS.length) return null;
      const haystack = normalizeForSearch([shop.address, shop.desc, shop.storename, shop.customAddress, shop.location].filter(Boolean).join(' '));
      if (!haystack) return null;
      return AREAS.find(area => area.matchKeywords?.some(keyword => haystack.includes(keyword))) || null;
    };

    const escapeHtml = value => {
      if (value === null || value === undefined) return '';
      return String(value).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    };

    const resolveShopImage = src => {
      if (!src) return 'https://via.placeholder.com/640x360.png?text=Shop';
      const str = String(src);
      if (str.startsWith('http://') || str.startsWith('https://') || str.startsWith('data:')) return str;
      return `${API_ORIGIN}/${str.replace(/^\/+/, '')}`;
    };

    const allCentersBtn = document.getElementById('all-centers-btn');
    const selectedCenterIndicator = document.getElementById('selectedCenterIndicator');
    const selectedCenterName = document.getElementById('selectedCenterName');

    function getAreaNameById(id) {
      if (!id) return '';
      const found = AREAS.find(area => area.id === id);
      return found ? found.name : id;
    }

    function updateSelectedCenterIndicator() {
      if (!selectedCenterIndicator || !selectedCenterName) return;
      if (current.area) {
        selectedCenterName.textContent = getAreaNameById(current.area);
        selectedCenterIndicator.style.display = 'inline-flex';
      } else {
        selectedCenterIndicator.style.display = 'none';
        selectedCenterName.textContent = '';
      }
      if (allCentersBtn) {
        allCentersBtn.classList.toggle('active', !current.area);
        allCentersBtn.setAttribute('aria-pressed', !current.area ? 'true' : 'false');
      }
    }

    function renderAreasShort(selected = null) {
      const container = document.getElementById('areasShort');
      container.innerHTML = '';
      const activeArea = selected ?? current.area;
      if (!AREAS.length) {
        const placeholder = document.createElement('div');
        placeholder.textContent = 'در حال بارگذاری مراکز خرید...';
        placeholder.style.color = '#0f9a8b';
        placeholder.style.fontWeight = '700';
        container.appendChild(placeholder);
        updateSelectedCenterIndicator();
        return;
      }
      sortCenters(AREAS).slice(0, 6).forEach(area => {
        const btn = document.createElement('button');
        btn.className = 'area-btn' + (activeArea === area.id ? ' active' : '');
        btn.textContent = area.name;
        btn.type = 'button';
        btn.onclick = () => { current.area = (current.area === area.id) ? null : area.id; renderAreasShort(current.area); loadAllShops(); };
        container.appendChild(btn);
      });
      updateSelectedCenterIndicator();
    }

    function populateCategories() {
      const select = document.getElementById('categorySelect');
      if (!select) return;
      select.innerHTML = '';
      CATEGORY_OPTIONS.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option.value; opt.textContent = option.label; select.appendChild(opt);
      });
    }

    const categorySelect = document.getElementById('categorySelect');
    const searchInput = document.getElementById('searchInput');
    populateCategories();

    if (categorySelect) {
      categorySelect.addEventListener('change', () => { current.category = categorySelect.value; loadAllShops(); });
    }

    if (searchInput) {
      const debouncedSearch = debounce(value => { current.search = value; loadAllShops(); }, 550);
      searchInput.addEventListener('input', event => debouncedSearch(event.target.value));
    }

    if (allCentersBtn) {
      allCentersBtn.onclick = () => { current.area = null; renderAreasShort(); loadAllShops(); window.scrollTo({ top: document.getElementById('areasShort').offsetTop - 40, behavior: 'smooth' }); };
    }

    const centersModal = document.getElementById('centersModal');
    const centersList = document.getElementById('centersList');
    const centersModalOverlay = document.getElementById('centersModalOverlay');
    const openCentersBtn = document.getElementById('more-centers-btn');
    const closeCentersBtn = document.getElementById('closeCentersModal');
    const closeCentersBtnMobile = document.getElementById('closeCentersModalMobile');
    const centerInfoModal = document.getElementById('centerInfoModal');
    const centerInfoOverlay = document.getElementById('centerInfoOverlay');
    const closeCenterInfoBtn = document.getElementById('closeCenterInfo');
    const centerInfoTitle = document.getElementById('centerInfoTitle');
    const centerInfoAddress = document.getElementById('centerInfoAddress');
    const centerInfoEmpty = document.getElementById('centerInfoEmpty');

    function openCentersModal() {
      centersModal.classList.add('active');
      document.body.classList.add('overflow-hidden');
    }

    function closeCentersModal() {
      centersModal.classList.remove('active');
      centerInfoModal?.classList.remove('active');
      document.body.classList.remove('overflow-hidden');
    }

    function openCenterInfoModal(area) {
      if (!centerInfoModal || !area) return;
      const location = (area.location || '').trim();
      centerInfoTitle.textContent = area.name || 'مرکز خرید';
      if (location) {
        centerInfoAddress.textContent = location;
        centerInfoAddress.style.display = 'block';
        centerInfoEmpty.style.display = 'none';
      } else {
        centerInfoAddress.textContent = '';
        centerInfoAddress.style.display = 'none';
        centerInfoEmpty.style.display = 'block';
      }
      centerInfoModal.classList.add('active');
      document.body.classList.add('overflow-hidden');
    }

    function closeCenterInfoModal() {
      centerInfoModal?.classList.remove('active');
      if (!centersModal.classList.contains('active')) {
        document.body.classList.remove('overflow-hidden');
      }
    }

    function renderCentersModal() {
      if (!centersList) return;
      centersList.innerHTML = '';
      if (!AREAS.length) {
        const placeholder = document.createElement('div');
        placeholder.textContent = 'در حال بارگذاری مراکز خرید...';
        placeholder.style.textAlign = 'center';
        placeholder.style.padding = '1rem';
        placeholder.style.color = '#0f9a8b';
        placeholder.style.fontWeight = '700';
        centersList.appendChild(placeholder);
        return;
      }
      sortCenters(AREAS).forEach(area => {
        const item = document.createElement('div');
        item.className = 'center-item';

        const selectBtn = document.createElement('button');
        selectBtn.type = 'button';
        selectBtn.className = 'center-name';
        selectBtn.textContent = area.name;
        selectBtn.onclick = () => { current.area = area.id; renderAreasShort(area.id); loadAllShops(); closeCentersModal(); window.scrollTo({ top: document.getElementById('areasShort').offsetTop - 40, behavior: 'smooth' }); };

        const infoBtn = document.createElement('button');
        infoBtn.type = 'button';
        infoBtn.className = 'center-info-btn';
        infoBtn.textContent = 'آدرس';
        infoBtn.addEventListener('click', event => { event.stopPropagation(); openCenterInfoModal(area); });

        item.appendChild(selectBtn);
        item.appendChild(infoBtn);
        centersList.appendChild(item);
      });
    }

    if (openCentersBtn) {
      openCentersBtn.addEventListener('click', async () => { await loadCentersFromBackend(); renderCentersModal(); openCentersModal(); });
    }

    [centersModalOverlay, closeCentersBtn, closeCentersBtnMobile].forEach(el => { if (el) el.addEventListener('click', closeCentersModal); });
    [centerInfoOverlay, closeCenterInfoBtn].forEach(el => { if (el) el.addEventListener('click', closeCenterInfoModal); });

    document.addEventListener('keydown', event => {
      if (event.key === 'Escape') {
        if (centersModal.classList.contains('active')) closeCentersModal();
        if (centerInfoModal?.classList.contains('active')) closeCenterInfoModal();
      }
    });

    async function loadAllShops() {
      const list = document.getElementById('shopsList');
      const empty = document.getElementById('noResult');
      if (!list || !empty) return;
      empty.style.display = 'none';
      list.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#0f9a8b;font-weight:800;padding:1.2rem;">در حال بارگذاری...</div>';
      try {
        const res = await fetch(`${API_BASE}/shops`);
        if (!res.ok) throw new Error('خطا در دریافت فروشگاه‌ها');
        const data = await res.json();
        const shopsArray = Array.isArray(data) ? data : Array.isArray(data?.shops) ? data.shops : Array.isArray(data?.data) ? data.data : [];
        const enriched = shopsArray.map(shop => {
          const center = detectCenterForShop(shop);
          return { ...shop, centerId: center?.id || null, centerName: center?.name || '', centerLocation: center?.location || '', centerTag: center?.tag || '' };
        });

        const searchTerm = normalizeForSearch(current.search);
        const categoryFilter = normalizeForSearch(current.category);

        const filtered = enriched.filter(shop => {
          const matchesCenter = !current.area || shop.centerId === current.area;
          const matchesCategory = !categoryFilter || normalizeForSearch(shop.category) === categoryFilter;
          const matchesSearch = !searchTerm || [shop.storename, shop.address, shop.centerName, shop.category].some(field => normalizeForSearch(field).includes(searchTerm));
          return matchesCenter && matchesCategory && matchesSearch;
        });

        list.innerHTML = '';
        if (!filtered.length) { empty.style.display = 'block'; return; }

        filtered.forEach(shop => {
          const areaName = shop.centerName || '';
          const categoryLabel = shop.category || '';
          const storeName = shop.storename || 'بدون نام';
          const address = shop.address || '';
          const phone = shop.phone || '';
          const imageSrc = resolveShopImage(shop.boardImage || shop.banner);
          const card = document.createElement('a');
          card.href = `shop.html?shopurl=${encodeURIComponent(shop.shopurl || '')}`;
          card.className = 'shop-card';
          card.setAttribute('aria-label', `مشاهده ${escapeHtml(storeName)}`);
          card.innerHTML = `
            <div class="shop-thumb">
              <img src="${imageSrc}" alt="${escapeHtml(storeName)}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/640x360.png?text=Shop';" />
            </div>
            <div class="tag-row">
              <span class="badge green">${escapeHtml(categoryLabel)}</span>
              <span class="badge blue" title="${escapeHtml(shop.centerLocation || '')}">${escapeHtml(areaName || 'سایر مراکز')}</span>
            </div>
            <h4 class="shop-name">${escapeHtml(storeName)}</h4>
            <div class="shop-address">${escapeHtml(address)}</div>
            ${phone ? `<div class="shop-meta"><span class="ri-phone-line" aria-hidden="true"></span><span>${escapeHtml(phone)}</span></div>` : ''}
            <div class="shop-footer"><span>مشاهده فروشگاه</span><span aria-hidden="true">↗</span></div>
          `;
          list.appendChild(card);
        });
      } catch (e) {
        list.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#ef4444;font-weight:800;padding:1.2rem;">مشکل در ارتباط با سرور!</div>';
        console.error(e);
      }
    }

    (async () => {
      await loadCentersFromBackend();
      renderAreasShort();
      renderCentersModal();
      updateSelectedCenterIndicator();
      await loadAllShops();
    })();
  </script>
</body>
</html>
