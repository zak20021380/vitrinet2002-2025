<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>پیام‌ها با مدیر</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-xl mx-auto bg-white rounded shadow p-4">
    <h2 class="text-lg font-bold mb-4">گفتگو با مدیر</h2>
    <div id="msgs" class="h-96 overflow-y-auto border rounded p-2 mb-2"></div>
    <div class="flex gap-2">
      <input id="msgInput" class="flex-1 border rounded p-2" placeholder="پیام">
      <button id="sendBtn" class="bg-green-500 text-white px-4 rounded">ارسال</button>
    </div>
  </div>
<script>
let userId = null;

async function getUserId(){
  if(userId) return userId;
  try{
    const res = await fetch('/api/user/profile', {credentials:'include'});
    const data = await res.json();
    if(res.ok && data._id) userId = data._id;
  }catch(e){}
  return userId;
}

async function fetchMsgs(){
  if(!await getUserId()) return;
  const res = await fetch(`/api/messages/${userId}`, {credentials:'include'});
  const data = await res.json();
  const box = document.getElementById('msgs');
  if(!Array.isArray(data) || data.length===0){
    box.innerHTML = '<div class="text-center text-gray-400 py-10">پیامی وجود ندارد</div>';
    return;
  }
  box.innerHTML = data.map(m=>{
    const role = m.senderRole || m.senderId?.role || (m.senderModel === 'Admin' ? 'admin' : 'user');
    const isMe = m.senderId?._id === userId || role === 'user';
    let label = m.senderName || (role === 'admin' ? 'مدیر سایت' : 'کاربر');
    if (isMe) label = 'شما';
    const align  = isMe ? 'text-right' : 'text-left';
    const bubble = isMe ? 'bg-green-100' : 'bg-gray-200';
    return `<div class="${align}">
      <div class="inline-block px-2 py-1 rounded ${bubble}">
        <span class="text-[11px] font-bold text-gray-500 mr-1">${label}</span>${m.message}
      </div>
      <div class="text-xs text-gray-400">${new Date(m.timestamp).toLocaleString('fa-IR')}</div>
    </div>`;
  }).join('');
  box.scrollTop = box.scrollHeight;
}
async function send(){
  if(!await getUserId()) return;
  const msg = document.getElementById('msgInput').value.trim();
  if(!msg) return;
  await fetch('/api/messages/send', {method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:msg})});
  document.getElementById('msgInput').value='';
  fetchMsgs();
}
document.getElementById('sendBtn').addEventListener('click', send);
fetchMsgs();
setInterval(fetchMsgs,5000);
</script>
</body>
</html>
