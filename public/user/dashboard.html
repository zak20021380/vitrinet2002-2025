  <!DOCTYPE html>
  <html lang="fa" dir="rtl">
  <head>
<meta name="referrer" content="no-referrer">

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>داشبورد کاربر | ویترینت</title>
    <script>
      (function() {
        const originalWarn = console.warn;
        console.warn = (...args) => {
          const first = args[0];
          if (typeof first === 'string' && first.includes('cdn.tailwindcss.com should not be used in production')) {
            return;
          }
          originalWarn(...args);
        };
        window.addEventListener('DOMContentLoaded', () => {
          console.warn = originalWarn;
        });
      })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@800&display=swap" rel="stylesheet"/>
    <style>
      body { font-family:'Vazirmatn',sans-serif; background: linear-gradient(110deg,#e0f7fa 0%,#f9fafb 100%); min-height:100vh;}
      .glass { background:rgba(255,255,255,0.97); backdrop-filter: blur(14px); border-radius:1.6rem; box-shadow:0 7px 32px #10b9811a, 0 3px 11px #0ea5e91a;}
      .primary-text { color: #10b981; }
      .brand-btn {
        background: linear-gradient(91deg,#10b981 0%,#0ea5e9 85%);
        color: #fff !important;
        box-shadow: 0 2px 14px #10b98125;
        transition: all .16s;
      }
      .brand-btn:hover { filter:brightness(1.08);}
      .fadein { animation:fadein .8s;}
      @keyframes fadein { from{opacity:0; transform:translateY(32px);} to{opacity:1; transform:translateY(0);} }
      @keyframes slideUp { from{opacity:0; transform:translateY(100%);} to{opacity:1; transform:translateY(0);} }
      ::placeholder {color:#a0aec0;}
      .tab-active { color:#10b981 !important; font-weight:900; background: #e6fcf7; }
      .scrollbar-hide::-webkit-scrollbar {display:none;}
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none;}
      .avatar-bg { background:linear-gradient(120deg,#10b981 65%,#0ea5e9 100%); }
      .menu-btn { transition: background .16s; }
      .menu-btn.active { background: #e6fcf7; color: #10b981; }
      .filter-btn { transition: all .2s ease; }
      .filter-btn.active { background-color: #3b82f6; color: #fff; border-color: transparent; }
      .quick-action {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 1rem;
        min-height: 110px;
        padding: 1.25rem 1rem;
        text-align: center;
        color: #374151;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.65rem;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        transition: all .2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .quick-action:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.12);
        background: #fafafa;
        border-color: #10b98120;
      }
      .quick-action:focus-visible {
        outline: 2px solid #10b981;
        outline-offset: 2px;
      }
      .quick-action-icon {
        width: 36px;
        height: 36px;
        stroke: #10b981;
        stroke-width: 1.5;
        fill: none;
        transition: all .2s ease;
      }
      .quick-action:hover .quick-action-icon {
        stroke: #059669;
        transform: scale(1.08);
      }
      .quick-action-label {
        line-height: 1.4;
        letter-spacing: -0.01em;
      }
      .quick-action-more {
        background: #f9fafb;
        border: 1px dashed #d1d5db;
        color: #6b7280;
        font-size: 0.85rem;
      }
      .quick-action-more:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        color: #4b5563;
      }
      .quick-action-more .quick-action-icon {
        stroke: #9ca3af;
      }
      /* Profile Edit Modal */
      .profile-modal-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.25rem;
        background: rgba(15, 23, 42, 0.55);
        backdrop-filter: blur(6px);
        z-index: 1600;
        opacity: 0;
        transition: opacity 0.28s ease;
      }
      .profile-modal-overlay.active {
        opacity: 1;
      }
      .profile-modal-card {
        width: 100%;
        max-width: 520px;
        background: linear-gradient(145deg, #ffffff, #f8fafc);
        border-radius: 1.5rem;
        box-shadow: 0 24px 65px rgba(15, 23, 42, 0.18);
        position: relative;
        padding: 1.75rem;
        transform: translateY(24px) scale(0.98);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
      }
      .profile-modal-overlay.active .profile-modal-card {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      .profile-modal-close {
        position: absolute;
        top: 1rem;
        left: 1rem;
        width: 38px;
        height: 38px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        border: none;
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .profile-modal-close:hover {
        background: rgba(239, 68, 68, 0.16);
        transform: translateY(-2px);
      }
      /* Profile Section */
      .profile-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .profile-card {
        border-radius: 1.75rem;
        padding: 2rem;
        background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(249,250,251,0.97));
        box-shadow: 0 15px 40px rgba(15, 23, 42, 0.08);
      }
      .profile-hero {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        flex-wrap: wrap;
      }
      .profile-avatar-large {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        background: linear-gradient(135deg, #10b981, #0ea5e9);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: 800;
        box-shadow: 0 12px 35px rgba(16, 185, 129, 0.35);
      }
      .profile-hello {
        color: #94a3b8;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      .profile-fullname {
        font-size: 1.65rem;
        font-weight: 900;
        margin: 0;
        color: #0f172a;
      }
      .profile-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
      }
      .profile-badge {
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 700;
        background: rgba(16, 185, 129, 0.12);
        color: #0f766e;
      }
      .profile-badge--outline {
        background: transparent;
        border: 1px dashed rgba(14, 165, 233, 0.5);
        color: #0ea5e9;
      }
      .profile-edit-btn {
        margin-right: auto;
        padding: 0.65rem 1.25rem;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #0ea5e9, #6366f1);
        color: #fff;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.25);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .profile-edit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(79, 70, 229, 0.35);
      }
      .profile-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-top: 1.75rem;
      }
      .profile-info-card {
        display: flex;
        gap: 0.85rem;
        align-items: center;
        padding: 1rem 1.1rem;
        border-radius: 1.25rem;
        border: 1.5px solid rgba(15, 23, 42, 0.06);
        background: #fff;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
      }
      .profile-info-icon {
        width: 42px;
        height: 42px;
        border-radius: 14px;
        background: rgba(16, 185, 129, 0.12);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #0f766e;
      }
      .profile-info-label {
        font-size: 0.8rem;
        color: #94a3b8;
        margin-bottom: 0.1rem;
      }
      .profile-info-value {
        font-size: 1rem;
        font-weight: 800;
        color: #0f172a;
        word-break: break-word;
      }
      .profile-secondary {
        display: grid;
        gap: 1.25rem;
      }
      @media (min-width: 1024px) {
        .profile-secondary { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      }
      .profile-subcard {
        border-radius: 1.5rem;
        padding: 1.5rem;
        background: #fff;
        border: 1px solid rgba(15, 23, 42, 0.05);
        box-shadow: 0 10px 35px rgba(15, 23, 42, 0.08);
      }
      .profile-subcard h3 {
        margin: 0 0 0.5rem;
        font-size: 1.1rem;
        font-weight: 800;
        color: #0f172a;
      }
      .profile-progress-track {
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: rgba(226, 232, 240, 0.8);
        overflow: hidden;
        margin: 0.75rem 0;
      }
      .profile-progress-fill {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, #0ea5e9, #10b981);
        transition: width 0.4s ease;
      }
      .profile-progress-note {
        font-size: 0.9rem;
        color: #475569;
        margin: 0;
      }
      .profile-quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
      }
      .profile-quick-action {
        border: 1px solid rgba(14, 165, 233, 0.15);
        border-radius: 1rem;
        padding: 0.9rem 1rem;
        background: linear-gradient(135deg, rgba(14, 165, 233, 0.08), rgba(16, 185, 129, 0.08));
        color: #0f172a;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        cursor: pointer;
        transition: all 0.25s ease;
      }
      .profile-quick-action:hover {
        transform: translateY(-2px);
        border-color: rgba(14, 165, 233, 0.4);
        box-shadow: 0 10px 25px rgba(14, 165, 233, 0.15);
      }
      .profile-quick-action svg {
        width: 22px;
        height: 22px;
      }
      .profile-tips {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        color: #475569;
      }
      .profile-tips li {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-weight: 600;
      }
      .profile-tips svg {
        flex-shrink: 0;
        color: #10b981;
      }
      @media (max-width: 640px) {
        .profile-card { padding: 1.5rem; }
        .profile-avatar-large { width: 78px; height: 78px; font-size: 2rem; }
        .profile-edit-btn { width: 100%; text-align: center; }
      }
      /* کارت های رزرو حرفه‌ای و مدرن */
      .booking-card {
        position: relative;
        overflow: hidden;
        border-radius: 1.5rem;
        padding: 0;
        background: #ffffff;
        border: 2px solid rgba(15, 23, 42, 0.06);
        box-shadow: 0 4px 20px rgba(15, 23, 42, 0.06);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 1.5rem;
      }

      .booking-card::before {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        width: 5px;
        height: 100%;
        background: linear-gradient(180deg, #0ea5e9, #10b981);
        opacity: 1;
      }

      .booking-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(15, 23, 42, 0.12);
        border-color: rgba(15, 23, 42, 0.1);
      }

      .booking-card--pending::before { background: linear-gradient(180deg, #fbbf24, #f97316); }
      .booking-card--confirmed::before { background: linear-gradient(180deg, #10b981, #059669); }
      .booking-card--completed::before { background: linear-gradient(180deg, #6366f1, #2563eb); }
      .booking-card--cancelled::before { background: linear-gradient(180deg, #ef4444, #dc2626); }
      .booking-card--default::before { background: linear-gradient(180deg, #94a3b8, #64748b); }

      /* Header Section */
      .booking-card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(241, 245, 249, 0.4), rgba(248, 250, 252, 0.4));
        border-bottom: 1px solid rgba(15, 23, 42, 0.05);
      }

      .booking-service-icon-wrapper {
        flex-shrink: 0;
      }

      .booking-service-icon {
        width: 56px;
        height: 56px;
        border-radius: 1rem;
        background: linear-gradient(135deg, #dbeafe, #ddd6fe);
        color: #4f46e5;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
      }

      .booking-header-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .booking-service-name {
        flex: 1;
        min-width: 0;
      }

      .booking-service-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
      }

      .booking-service-title {
        font-size: 1.35rem;
        font-weight: 800;
        color: #1e293b;
        line-height: 1.3;
        margin: 0;
        word-wrap: break-word;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 700;
        letter-spacing: 0.02em;
        border: 2px solid transparent;
        white-space: nowrap;
        align-self: flex-start;
      }

      .status-badge--pending { color: #92400e; background: #fef3c7; border-color: #fcd34d; }
      .status-badge--confirmed { color: #065f46; background: #d1fae5; border-color: #34d399; }
      .status-badge--completed { color: #312e81; background: #e0e7ff; border-color: #a5b4fc; }
      .status-badge--cancelled { color: #991b1b; background: #fee2e2; border-color: #fca5a5; }
      .status-badge--default { color: #1f2937; background: #f3f4f6; border-color: #e5e7eb; }

      /* Info Grid */
      .booking-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1px;
        background: rgba(15, 23, 42, 0.05);
        border-bottom: 1px solid rgba(15, 23, 42, 0.05);
      }

      .booking-info-item {
        display: flex;
        align-items: flex-start;
        gap: 0.875rem;
        padding: 1.25rem 1.5rem;
        background: #ffffff;
      }

      .booking-info-icon {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        border-radius: 0.75rem;
        background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .booking-info-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .booking-info-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .booking-info-value {
        font-size: 0.95rem;
        font-weight: 700;
        color: #1e293b;
        word-wrap: break-word;
      }

      .booking-info-link {
        color: #3b82f6;
        text-decoration: none;
        transition: color 0.2s;
      }

      .booking-info-link:hover {
        color: #2563eb;
        text-decoration: underline;
      }

      /* Actions */
      .booking-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        padding: 1.5rem;
        background: #fafbfc;
      }

      .booking-action-btn {
        flex: 1;
        min-width: 140px;
        border-radius: 0.75rem;
        padding: 0.875rem 1.25rem;
        font-weight: 700;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        white-space: nowrap;
      }

      .booking-action-btn--primary {
        background: linear-gradient(135deg, #3b82f6, #6366f1);
        color: #fff;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .booking-action-btn--primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      }

      .booking-action-btn--danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: #fff;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }

      .booking-action-btn--danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
      }

      .booking-action-btn--ghost {
        background: #ffffff;
        color: #b91c1c;
        border: 2px solid #fca5a5;
      }

      .booking-action-btn--ghost:hover {
        background: #fee2e2;
        border-color: #dc2626;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .booking-card {
          border-radius: 1.25rem;
          margin-bottom: 1.25rem;
        }

        .booking-card-header {
          flex-direction: column;
          align-items: flex-start;
          padding: 1.25rem;
          gap: 1rem;
        }

        .booking-header-content {
          width: 100%;
          gap: 0.75rem;
        }

        .booking-service-icon {
          width: 50px;
          height: 50px;
        }

        .booking-service-title {
          font-size: 1.15rem;
        }

        .status-badge {
          width: 100%;
          justify-content: center;
          padding: 0.625rem 1rem;
        }

        .booking-info-grid {
          grid-template-columns: 1fr;
        }

        .booking-info-item {
          padding: 1rem 1.25rem;
        }

        .booking-info-icon {
          width: 36px;
          height: 36px;
        }

        .booking-actions {
          flex-direction: column;
          padding: 1.25rem;
        }

        .booking-action-btn {
          width: 100%;
          min-width: auto;
          padding: 1rem 1.25rem;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 480px) {
        .booking-card-header {
          padding: 1rem;
        }

        .booking-service-icon {
          width: 44px;
          height: 44px;
        }

        .booking-service-title {
          font-size: 1.05rem;
        }

        .booking-info-item {
          padding: 0.875rem 1rem;
          gap: 0.75rem;
        }

        .booking-info-icon {
          width: 32px;
          height: 32px;
        }

        .booking-info-label {
          font-size: 0.7rem;
        }

        .booking-info-value {
          font-size: 0.875rem;
        }

        .booking-actions {
          padding: 1rem;
        }
      }
      /* مودال اقدامات بیشتر */
      .more-actions-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .more-actions-modal.active {
        display: flex;
        animation: fadein .2s ease;
      }
      .more-actions-content {
        background: white;
        border-radius: 1.25rem;
        padding: 1.75rem 1.5rem;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        animation: slideUp .3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .more-actions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .more-actions-close {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #f3f4f6;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background .2s;
      }
      .more-actions-close:hover {
        background: #e5e7eb;
      }
      .more-actions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }
      .more-action-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border-radius: 0.75rem;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        text-decoration: none;
        color: #374151;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all .2s ease;
        cursor: pointer;
      }
      .more-action-item:hover {
        background: #f3f4f6;
        border-color: #10b98130;
        transform: translateY(-1px);
      }
      .more-action-icon {
        width: 22px;
        height: 22px;
        stroke: #6b7280;
        stroke-width: 1.8;
        fill: none;
        flex-shrink: 0;
      }
      /* Header Styles - Modern & Professional */
      .main-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(16, 185, 129, 0.1);
        box-shadow: 0 4px 24px rgba(16, 185, 129, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .main-header.scrolled {
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 6px 32px rgba(16, 185, 129, 0.12);
      }
      .logo-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        transition: transform 0.3s ease;
      }
      .logo-container:hover {
        transform: scale(1.05);
      }
      .logo-icon {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
        position: relative;
        overflow: hidden;
      }
      .logo-icon::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, transparent 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .logo-container:hover .logo-icon::before {
        opacity: 1;
      }
      .logo-text {
        font-family: 'Vazirmatn', sans-serif;
        font-size: 1.5rem;
        font-weight: 900;
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.02em;
      }
      .nav-links {
        display: flex;
        align-items: center;
        gap: 2rem;
      }
      .nav-link {
        position: relative;
        font-weight: 600;
        font-size: 0.95rem;
        color: #4b5563;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
      }
      .nav-link::before {
        content: '';
        position: absolute;
        bottom: 0;
        right: 50%;
        width: 0;
        height: 2px;
        background: linear-gradient(90deg, #10b981, #0ea5e9);
        transition: all 0.3s ease;
        transform: translateX(50%);
      }
      .nav-link:hover {
        color: #10b981;
        background: rgba(16, 185, 129, 0.05);
      }
      .nav-link:hover::before {
        width: 80%;
      }
      .nav-link.active {
        color: #10b981;
        background: rgba(16, 185, 129, 0.1);
      }
      .header-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .profile-button {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.5rem 1.25rem 0.5rem 0.625rem;
        border-radius: 100px;
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-family: 'Vazirmatn', sans-serif;
      }
      .profile-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.35);
      }
      .profile-button:active {
        transform: translateY(0);
      }
      .profile-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.125rem;
        font-weight: 800;
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }
      .profile-name {
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
        letter-spacing: -0.01em;
      }
      .notification-btn {
        position: relative;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: rgba(16, 185, 129, 0.08);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      .notification-btn:hover {
        background: rgba(16, 185, 129, 0.15);
        transform: scale(1.05);
      }
      .notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        font-size: 0.7rem;
        font-weight: 800;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        animation: badgePulse 2s ease-in-out infinite;
      }
      @keyframes badgePulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }

      /* Notification Panel Styles */
      .notification-panel {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        width: 95%;
        max-width: 420px;
        max-height: 70vh;
        background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(16, 185, 129, 0.15), 0 0 0 1px rgba(16, 185, 129, 0.1);
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        z-index: 999;
        overflow: hidden;
        backdrop-filter: blur(20px);
      }
      .notification-panel.active {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }
      .notification-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem;
        border-bottom: 2px solid rgba(16, 185, 129, 0.1);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(14, 165, 233, 0.05) 100%);
      }
      .notification-panel-title {
        font-size: 1.125rem;
        font-weight: 800;
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0;
      }
      .notification-panel-close {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: rgba(239, 68, 68, 0.1);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      .notification-panel-close:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: rotate(90deg);
      }
      .notification-list {
        padding: 0.5rem;
        max-height: calc(70vh - 80px);
        overflow-y: auto;
        overflow-x: hidden;
      }
      .notification-list::-webkit-scrollbar {
        width: 6px;
      }
      .notification-list::-webkit-scrollbar-track {
        background: rgba(16, 185, 129, 0.05);
        border-radius: 10px;
      }
      .notification-list::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        border-radius: 10px;
      }
      .notification-item {
        background: white;
        border-radius: 14px;
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        border: 1px solid rgba(16, 185, 129, 0.1);
        transition: all 0.3s ease;
        position: relative;
        animation: slideIn 0.4s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      .notification-item:hover {
        transform: translateX(-4px);
        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.12);
        border-color: rgba(16, 185, 129, 0.3);
      }
      .notification-item.unread {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(14, 165, 233, 0.05) 100%);
        border-color: rgba(16, 185, 129, 0.2);
      }
      .notification-item.unread::before {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        border-radius: 0 14px 14px 0;
      }
      .notification-content {
        display: flex;
        gap: 1rem;
        align-items: start;
      }
      .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
      }
      .notification-icon svg {
        stroke: white;
      }
      .notification-body {
        flex: 1;
        min-width: 0;
      }
      .notification-message {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #374151;
        margin: 0 0 0.5rem 0;
        word-wrap: break-word;
      }
      .notification-time {
        font-size: 0.8rem;
        color: #9ca3af;
        display: flex;
        align-items: center;
        gap: 0.375rem;
      }
      .notification-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
      }
      .notification-action-btn {
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Vazirmatn', sans-serif;
      }
      .notification-delete-btn {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
      }
      .notification-delete-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.05);
      }
      .notification-mark-read-btn {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
      }
      .notification-mark-read-btn:hover {
        background: rgba(16, 185, 129, 0.2);
        transform: scale(1.05);
      }
      .notification-empty {
        text-align: center;
        padding: 3rem 1.5rem;
      }
      .notification-empty-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem;
        opacity: 0.3;
      }
      .notification-empty-text {
        font-size: 1rem;
        color: #9ca3af;
        font-weight: 600;
      }
      .notification-loading {
        text-align: center;
        padding: 3rem 1.5rem;
      }
      .loading-spinner {
        width: 50px;
        height: 50px;
        margin: 0 auto 1rem;
        border: 4px solid rgba(16, 185, 129, 0.1);
        border-top-color: #10b981;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .notification-loading p {
        color: #9ca3af;
        font-size: 0.95rem;
      }

      /* Mobile Responsive Adjustments */
      @media (max-width: 480px) {
        .notification-panel {
          top: 70px;
          width: 92%;
          max-height: 75vh;
        }
        .notification-item {
          padding: 0.875rem 1rem;
        }
        .notification-icon {
          width: 36px;
          height: 36px;
        }
        .notification-message {
          font-size: 0.9rem;
        }
      }
      .menu-toggle {
        width: 40px;
        height: 40px;
        border-radius: 11px;
        background: rgba(16, 185, 129, 0.08);
        border: 1px solid rgba(16, 185, 129, 0.08);
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 0;
        transition: all 0.25s ease;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
      }
      .menu-toggle:hover {
        background: rgba(16, 185, 129, 0.15);
        border-color: rgba(16, 185, 129, 0.25);
        transform: scale(1.03);
      }
      .menu-toggle span {
        width: 18px;
        height: 2.25px;
        background: #0f766e;
        border-radius: 2px;
        transition: all 0.3s ease;
      }
      .menu-toggle:hover span {
        background: #059669;
      }

      /* Header Animation */
      @keyframes headerSlideDown {
        from {
          opacity: 0;
          transform: translateY(-100%);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .main-header {
        animation: headerSlideDown 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Responsive Header Styles */
      @media (max-width: 768px) {
        .main-header {
          padding: 0.875rem 1rem !important;
        }
        .logo-icon {
          width: 42px;
          height: 42px;
        }
        .logo-text {
          font-size: 1.25rem;
        }
        .nav-links {
          display: none;
        }
        .profile-name {
          display: none;
        }
        .profile-button {
          padding: 0.5rem;
          min-width: 44px;
          justify-content: center;
        }
        .notification-btn {
          width: 40px;
          height: 40px;
        }
        .menu-toggle {
          width: 36px;
          height: 36px;
        }
      }
      @media (max-width: 480px) {
        .main-header {
          padding: 0.75rem 0.875rem !important;
        }
        .logo-text {
          display: none;
        }
        .logo-icon {
          width: 40px;
          height: 40px;
        }
        .header-actions {
          gap: 0.5rem;
        }
        .notification-btn {
          width: 40px;
          height: 40px;
          display: flex !important;
        }
        .menu-toggle {
          width: 34px;
          height: 34px;
          border-radius: 10px;
          gap: 3px;
        }
        .menu-toggle span {
          width: 16px;
          height: 2px;
        }
      }
      @media (max-width: 360px) {
        .profile-avatar {
          width: 36px;
          height: 36px;
        }
        .menu-toggle {
          width: 36px;
          height: 36px;
        }
        .menu-toggle span {
          width: 18px;
        }
      }
      @media (max-width: 1023px) {
        .main-grid { grid-template-columns: 1fr !important; }
        .sidebar { display: none !important; }
      }
      @media (min-width: 1024px) {
        .mobile-sidebar,.sidebar-overlay { display: none !important;}
      }
      /* موبایل منو - Modern Design */
      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        /* Ensure overlay always sits above the mobile bottom nav */
        z-index: 1100;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .sidebar-overlay.open {
        display: block;
        opacity: 1;
      }
      .mobile-sidebar {
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        width: 78vw;
        max-width: 320px;
        background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
        /* Keep sidebar content above overlay and bottom nav */
        z-index: 1200;
        border-radius: 1.5rem 0 0 1.5rem;
        box-shadow: -4px 0 32px rgba(16, 185, 129, 0.12);
        padding: 1.75rem 1.25rem;
        overflow-y: auto;
        transform: translateX(100%);
        transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .mobile-sidebar.open {
        transform: translateX(0);
      }
      .mobile-sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        padding-bottom: 1.25rem;
        border-bottom: 2px solid rgba(16, 185, 129, 0.1);
      }
      .mobile-sidebar-close {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: rgba(239, 68, 68, 0.1);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      .mobile-sidebar-close:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: rotate(90deg);
      }
      .mobile-user-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1.25rem;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(14, 165, 233, 0.05) 100%);
        border-radius: 1rem;
        margin-bottom: 1.25rem;
      }
      .mobile-user-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        font-weight: 800;
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        margin-bottom: 1rem;
        border: 4px solid white;
      }
      .mobile-menu-section {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .mobile-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border-radius: 12px;
        background: white;
        border: 1.5px solid rgba(16, 185, 129, 0.08);
        font-weight: 600;
        font-size: 0.9rem;
        color: #4b5563;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
      }
      .mobile-menu-item:hover, .mobile-menu-item.active {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(14, 165, 233, 0.1) 100%);
        border-color: rgba(16, 185, 129, 0.3);
        color: #10b981;
        transform: translateX(-4px);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.15);
      }
    </style>
    <script src="/nav-active.js" defer></script>

<!-- TODO: فعال‌سازی پست‌هاگ را هنگام انتشار فراموش نکنید | TODO: Enable PostHog analytics when going live -->
<!--
<script>
  (function () {
    var config = window.POSTHOG_CONFIG || { enabled: false, apiKey: 'phc_YOUR_KEY_HERE', apiHost: 'https://analytics.vitreenet.ir' };
    if (!config.enabled) {
      return; // فعال نیست | Not enabled yet
    }
    try {
      (function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")),p.type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js";(r=t.getElementsByTagName("script")[0]),r.parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:u=e,u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==u._i&&(e+="."+u._i),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"};n="capture identify alias people.set people.set_once people.unset people.increment people.append people.union people.remove people.clear_opt_out_outcome register register_once unregister opt_out_capturing opt_in_capturing has_opted_out_capturing reset isFeatureEnabled onFeatureFlags reloadFeatureFlags group".split(" ");for(o=0;o<n.length;o++)g(u,n[o]);e._i.push([i,s,a])},e.__SV=1.1)})(document, window.posthog || []);
      window.posthog.init(config.apiKey, { api_host: config.apiHost, capture_pageview: true, advanced_disable_decide: true });
    } catch (error) {
      console.warn('PostHog init failed (preview mode):', error);
    }
  })();
</script>
-->

</head>
  <body class="text-gray-800 overflow-x-hidden">

    <!-- Header - Modern & Professional -->
    <header class="main-header fixed top-0 inset-x-0 z-20" style="padding: 1rem 1.5rem;">
      <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
        <!-- Header Actions (Left Side) -->
        <div class="header-actions">
          <!-- Mobile Menu Toggle -->
          <button id="hamBtn" class="menu-toggle lg:hidden" aria-label="منو" title="منو">
            <span></span>
            <span></span>
            <span></span>
            <span id="hamBadge" class="notification-badge hidden" style="top: -6px; right: -6px;">0</span>
          </button>

          <!-- Profile Button -->
          <button id="profileBtn" type="button" class="profile-button">
            <div class="profile-avatar">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <span class="profile-name">پروفایل من</span>
          </button>

          <!-- Notification Button -->
          <button id="notificationBtn" class="notification-btn" aria-label="اعلان‌ها" title="اعلان‌ها">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
            <span id="notificationBadge" class="notification-badge hidden">0</span>
          </button>
        </div>

        <!-- Navigation Links (Desktop) -->
        <nav class="nav-links flex-1 hidden md:flex justify-center">
          <a href="index.html" class="nav-link active">
            <span>داشبورد</span>
          </a>
          <a href="../index.html" class="nav-link">
            <span>صفحه اصلی</span>
          </a>
          <a href="#" class="nav-link" data-section="bookings">
            <span>رزروها</span>
          </a>
        </nav>

        <!-- Logo Section (Right Side) -->
        <a href="../index.html" class="logo-container" aria-label="بازگشت به خانه">
          <div class="logo-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M9 22V12h6v10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <span class="logo-text">ویترینت</span>
        </a>
      </div>
    </header>

    <!-- Notification Dropdown Panel -->
    <div id="notificationPanel" class="notification-panel">
      <div class="notification-panel-header">
        <h3 class="notification-panel-title">اعلان‌های من</h3>
        <button id="closeNotificationPanel" class="notification-panel-close" aria-label="بستن">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div id="notificationList" class="notification-list">
        <!-- Notifications will be loaded here -->
        <div class="notification-loading">
          <div class="loading-spinner"></div>
          <p>در حال بارگذاری اعلان‌ها...</p>
        </div>
      </div>
    </div>

    <!-- سایدبار موبایل - Modern Design -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <aside id="mobileSidebar" class="mobile-sidebar">
      <!-- Header Section -->
      <div class="mobile-sidebar-header">
        <h2 style="font-size: 1.25rem; font-weight: 800; background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">منوی اصلی</h2>
        <button id="closeSidebar" class="mobile-sidebar-close" title="بستن">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <!-- User Section -->
      <div class="mobile-user-section">
        <div class="mobile-user-avatar">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </div>
        <div class="text-lg font-bold primary-text text-center sidebar-user-name">&nbsp;</div>
        <div class="text-gray-500 text-sm text-center sidebar-user-mobile" dir="ltr">&nbsp;</div>
      </div>

      <!-- Menu Section -->
      <div class="mobile-menu-section">
        <button class="mobile-menu-item menu-btn active" data-section="dashboard">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
          </svg>
          <span>داشبورد</span>
        </button>

        <button class="mobile-menu-item menu-btn" data-section="profile">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <span>پروفایل من</span>
        </button>

        <button class="mobile-menu-item menu-btn" data-section="bookings">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <span>رزروهای من</span>
          <span id="bookings-badge-mobile" class="notification-badge hidden" style="position: static; margin-right: auto;">0</span>
        </button>

        <button class="mobile-menu-item menu-btn" data-section="favorites">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
          <span>علاقه‌مندی‌ها</span>
        </button>

        <button class="mobile-menu-item menu-btn" data-section="favshops">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
          <span>مغازه‌های محبوب</span>
        </button>

        <button class="mobile-menu-item menu-btn" data-section="messages">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <span>پیام‌ها</span>
          <span id="msgBadge-mobile" class="notification-badge hidden" style="position: static; margin-right: auto;">0</span>
        </button>
      </div>
    </aside>

    <main class="max-w-6xl mx-auto mt-32 mb-14 px-2 sm:px-4">
      <div class="grid main-grid grid-cols-3 gap-7">
        <!-- سایدبار دسکتاپ -->
        <aside class="glass sidebar flex-col items-center py-7 px-4 sm:px-8 mb-3 fadein hidden lg:flex">
          <div class="w-20 h-20 rounded-full avatar-bg flex items-center justify-center text-white text-4xl font-extrabold mb-2 select-none shadow-lg">
            VN
          </div>
        <div class="text-lg font-bold primary-text mt-2 mb-0.5 text-center sidebar-user-name">&nbsp;</div>
  <div class="text-gray-400 text-sm mb-3 text-center sidebar-user-mobile" dir="ltr">&nbsp;</div>

          <div class="flex flex-col gap-2 w-full mt-4 text-[15px]">
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition tab-active" data-section="dashboard"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#10b981"/><path d="M6 9l3 3 3-3" stroke="#fff" stroke-width="1.6"/></svg> داشبورد</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="profile"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#dbeafe"/><path d="M6 7a3 3 0 0 1 6 0c0 1.656-1.343 3-3 3s-3-1.344-3-3Zm6 6H6c0-1.656 2.343-3 3-3s3 1.344 3 3Z" fill="#3b82f6"/></svg> پروفایل من</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="favorites"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fce7f3"/><path d="M6.5 8A2.5 2.5 0 0 1 9 5.5 2.5 2.5 0 0 1 11.5 8C11.5 9.33 9 12 9 12S6.5 9.33 6.5 8Z" fill="#ec4899"/></svg> علاقه‌مندی‌ها</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="favshops"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#ffe4e6"/><path d="M6.5 8A2.5 2.5 0 0 1 9 5.5 2.5 2.5 0 0 1 11.5 8C11.5 9.33 9 12 9 12S6.5 9.33 6.5 8Z" fill="#f43f5e"/></svg> مغازه‌های محبوب من</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="bookings">
              📅 رزروهای من
              <span id="bookings-badge" class="inline-block mr-2 px-2 py-1 text-xs bg-red-500 text-white rounded-full hidden">0</span>
            </button>
            
  <!-- پیام‌ها -->
  <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition"
          data-section="messages">
    <svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fef2f2"/><path d="M6 6h6v6H6z" fill="#ef4444"/></svg>
    پیام‌ها
    <span id="msgBadge" class="ml-1 text-xs font-extrabold text-red-500"></span>
  </button>




          </div>
        
        </aside>
        <!-- محتوای سمت چپ -->
        <section id="mainContent" class="col-span-2 flex flex-col gap-7 fadein">
          <!-- اینجا محتوای داینامیک لود میشه -->
        </section>
      </div>
    </main>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="profile-modal-overlay hidden" aria-hidden="true">
      <div class="profile-modal-card" role="dialog" aria-modal="true" aria-labelledby="editProfileTitle">
        <button type="button" class="profile-modal-close" data-dismiss="edit-modal" aria-label="بستن">
          ×
        </button>
        <div class="flex items-center gap-3 mb-2">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-emerald-500 to-cyan-500 flex items-center justify-center text-white font-black text-xl shadow-lg">
            <span id="editInitialsPreview">VN</span>
          </div>
          <div>
            <h3 id="editProfileTitle" class="text-xl font-black text-gray-800">ویرایش اطلاعات کاربری</h3>
            <p class="text-sm text-gray-500">فعلاً فقط نام و نام خانوادگی قابل ویرایش است.</p>
          </div>
        </div>

        <form id="editProfileForm" class="mt-4 space-y-4">
          <div>
            <label for="editFirstName" class="block text-sm font-semibold text-gray-700 mb-1">نام</label>
            <input id="editFirstName" name="firstName" type="text" class="w-full rounded-xl border border-gray-200 bg-white px-3 py-3 text-gray-800 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 transition" placeholder="مثلاً حمیده" required />
          </div>
          <div>
            <label for="editLastName" class="block text-sm font-semibold text-gray-700 mb-1">نام خانوادگی</label>
            <input id="editLastName" name="lastName" type="text" class="w-full rounded-xl border border-gray-200 bg-white px-3 py-3 text-gray-800 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 transition" placeholder="مثلاً آذرمیخت" required />
          </div>

          <div id="editProfileStatus" class="text-sm font-semibold text-emerald-600 hidden"></div>

          <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 pt-2">
            <button type="submit" class="flex-1 brand-btn py-3 rounded-2xl font-black text-base shadow-md">ذخیره تغییرات</button>
            <button type="button" class="flex-1 sm:flex-none px-4 py-3 rounded-2xl bg-gray-100 text-gray-700 font-bold border border-gray-200 hover:bg-gray-200 transition" data-dismiss="edit-modal">انصراف</button>
          </div>
        </form>
      </div>
    </div>
    <footer class="mt-14 bg-white border-t text-center text-xs sm:text-sm text-gray-400 py-5 rounded-t-3xl">
      © 2025 <span class="text-[#10b981] font-bold">Vitrinet</span> - همه حقوق محفوظ است.
    </footer>
    <script>
      // ==========================================
      // Header Scroll Effect & Navigation
      // ==========================================

      // Add scroll effect to header
      window.addEventListener('scroll', () => {
        const header = document.querySelector('.main-header');
        if (window.scrollY > 20) {
          header.classList.add('scrolled');
        } else {
          header.classList.remove('scrolled');
        }
      });

      // Handle navigation link clicks
      document.addEventListener('DOMContentLoaded', () => {
        const navLinks = document.querySelectorAll('.nav-link');

        navLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            const section = link.getAttribute('data-section');
            if (section) {
              e.preventDefault();

              // Remove active class from all links
              navLinks.forEach(l => l.classList.remove('active'));

              // Add active class to clicked link
              link.classList.add('active');

              // Trigger section change (if applicable)
              const menuBtn = document.querySelector(`button[data-section="${section}"]`);
              if (menuBtn) {
                menuBtn.click();
              }
            }
          });
        });

        initEditProfileModal();
      });

      // Bookings state
        let currentBookingFilter = 'all';
        let allBookings = [];

        let pollHandle = null;
        let bookingsData = [];
        let bookingsLoaded = false;
        const profileState = {
          isAuthenticated: false,
          user: {
            firstName: '',
            lastName: '',
            city: '',
            phone: ''
          }
        };

        const formatInitials = (firstName = '', lastName = '') => {
          const parts = [firstName.trim().charAt(0), lastName.trim().charAt(0)].filter(Boolean);
          return parts.length ? parts.join(' ') : 'VN';
        };

        function populateEditProfileForm() {
          const firstInput = document.getElementById('editFirstName');
          const lastInput = document.getElementById('editLastName');
          const initialsPreview = document.getElementById('editInitialsPreview');

          if (firstInput) firstInput.value = profileState.user.firstName || '';
          if (lastInput) lastInput.value = profileState.user.lastName || '';
          if (initialsPreview) {
            initialsPreview.textContent = formatInitials(profileState.user.firstName, profileState.user.lastName);
          }
        }

        function applyProfileStateToUI() {
          const { firstName, lastName, city, phone } = profileState.user;
          const isAuthenticated = Boolean(profileState.isAuthenticated);
          const fullNameRaw = `${firstName} ${lastName}`.trim();
          const fullName = isAuthenticated ? (fullNameRaw || 'کاربر ویترینت') : '';
          const initials = isAuthenticated ? formatInitials(firstName, lastName) : '';
          const maskedPhone = isAuthenticated && phone
            ? phone.toString().slice(0, 4) + '***' + phone.toString().slice(-3)
            : '';

          const hello = document.querySelector('.profile-hello');
          if (hello) hello.textContent = isAuthenticated && firstName ? `سلام ${firstName}` : '';

          const nameEls = document.querySelectorAll('.profile-fullname');
          nameEls.forEach(el => (el.textContent = fullName));

          const badgeCity = document.querySelector('.profile-badge.profile-badge--outline');
          if (badgeCity) badgeCity.textContent = isAuthenticated && city ? city : '';

          const avatar = document.querySelector('.profile-avatar-large');
          if (avatar) avatar.textContent = initials;

          const sidebarNames = document.querySelectorAll('.sidebar-user-name');
          sidebarNames.forEach(el => (el.textContent = fullName));

          document.querySelectorAll('.sidebar-user-mobile')
            .forEach(el => (el.textContent = maskedPhone));

          const initialsPreview = document.getElementById('editInitialsPreview');
          if (initialsPreview) initialsPreview.textContent = initials;
        }

        function openEditProfileModal() {
          const modal = document.getElementById('editProfileModal');
          const status = document.getElementById('editProfileStatus');
          if (!modal) return;
          populateEditProfileForm();
          if (status) {
            status.textContent = '';
            status.classList.add('hidden');
            status.classList.remove('text-red-500');
            status.classList.add('text-emerald-600');
          }
          modal.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
          requestAnimationFrame(() => {
            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
          });
        }

        function closeEditProfileModal() {
          const modal = document.getElementById('editProfileModal');
          const status = document.getElementById('editProfileStatus');
          if (!modal) return;
          modal.classList.remove('active');
          modal.setAttribute('aria-hidden', 'true');
          document.body.classList.remove('overflow-hidden');
          if (status) status.classList.add('hidden');
          setTimeout(() => modal.classList.add('hidden'), 220);
        }

        async function handleEditProfileSubmit(event) {
          event.preventDefault();
          const form = event.currentTarget;
          const firstInput = document.getElementById('editFirstName');
          const lastInput = document.getElementById('editLastName');
          const status = document.getElementById('editProfileStatus');
          const submitBtn = form.querySelector('button[type="submit"]');

          const firstName = firstInput?.value.trim() || '';
          const lastName = lastInput?.value.trim() || '';
          const phone = (profileState.user.phone || '').toString().trim();
          const name = `${firstName} ${lastName}`.trim();

          if (!firstName || !lastName) {
            if (status) {
              status.textContent = 'نام و نام خانوادگی را کامل وارد کنید.';
              status.classList.remove('hidden', 'text-emerald-600');
              status.classList.add('text-red-500');
            }
            return;
          }

          if (!phone) {
            if (status) {
              status.textContent = 'شماره تماس کاربر یافت نشد. لطفاً دوباره تلاش کنید.';
              status.classList.remove('hidden', 'text-emerald-600');
              status.classList.add('text-red-500');
            }
            return;
          }

          if (status) {
            status.textContent = 'در حال ذخیره...';
            status.classList.remove('hidden', 'text-red-500');
            status.classList.add('text-emerald-600');
          }

          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'در حال ذخیره...';
          }

          try {
            const res = await fetch('/api/user/profile', {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name,
                phone
              })
            });

            if (!res.ok) {
              throw new Error('ثبت اطلاعات انجام نشد. دوباره تلاش کنید.');
            }

            profileState.user.firstName = firstName;
            profileState.user.lastName = lastName;
            applyProfileStateToUI();

            if (status) {
              status.textContent = 'اطلاعات با موفقیت ذخیره شد.';
              status.classList.remove('text-red-500');
              status.classList.add('text-emerald-600');
            }

            setTimeout(() => closeEditProfileModal(), 600);
          } catch (error) {
            console.error('edit profile error:', error);
            if (status) {
              status.textContent = error?.message || 'خطا در ذخیره اطلاعات.';
              status.classList.remove('text-emerald-600');
              status.classList.remove('hidden');
              status.classList.add('text-red-500');
            }
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'ذخیره تغییرات';
            }
          }
        }

        function initEditProfileModal() {
          const modal = document.getElementById('editProfileModal');
          const form = document.getElementById('editProfileForm');
          if (!modal || !form) return;

          form.addEventListener('submit', handleEditProfileSubmit);

          document.querySelectorAll('[data-dismiss="edit-modal"]').forEach(btn => {
            btn.addEventListener('click', closeEditProfileModal);
          });

          modal.addEventListener('click', (event) => {
            if (event.target === modal) {
              closeEditProfileModal();
            }
          });
        }

        // داده‌ی دموی پروفایل
    async function loadProfileSection() {
      const formatDate = (value) => {
        if (!value) return '---';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '---';
        return date.toLocaleDateString('fa-IR', { day: 'numeric', month: 'short', year: 'numeric' });
      };

    let html = `
      <div class="glass px-6 py-7 fadein">
        <div class="text-center text-gray-400 py-12">در حال دریافت اطلاعات...</div>
      </div>`;
    document.getElementById('mainContent').innerHTML = html;

    try {
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',          // کوکی JWT
        headers: { 'Content-Type': 'application/json' }
      });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403)
          throw new Error('برای دسترسی به این بخش ابتدا وارد شوید.');
        throw new Error('دریافت اطلاعات با خطا مواجه شد!');
      }

      const user  = await res.json();
      const phone = user.phone || user.mobile || '';   // ✳️ فیکس: فیلد mobile هم پوشش داده شد
      const masked =
        phone ? phone.toString().slice(0, 4) + '***' + phone.toString().slice(-3) : '-';
      const firstName = (user.firstname || user.firstName || 'کاربر').toString().trim() || 'کاربر';
      const lastName = (user.lastname || user.lastName || '').toString().trim();
      const fullName = `${firstName} ${lastName}`.trim() || 'کاربر ویترینت';
      const initials = formatInitials(firstName, lastName);
      const city = (user.city || user.cityName || 'سنندج').toString().trim() || 'سنندج';
      const safeCity = city && city !== '---' ? city : 'سنندج';
      const memberSince = formatDate(user.createdAt || user.created_at || user.signupDate);
      const lastSeen = formatDate(user.lastLogin || user.last_seen || user.updatedAt || user.lastSeen);
      const filledFields = [firstName, lastName, safeCity, phone]
        .filter(Boolean).length;
      const completionProgress = Math.min(100, Math.round((filledFields / 4) * 100));
      const completionLabel = completionProgress >= 80
        ? 'پروفایل کامل'
        : completionProgress >= 50
          ? 'در حال تکمیل'
          : 'نیاز به تکمیل';
      const membershipLabel = user.role === 'seller'
        ? 'فروشنده تاییدشده'
        : 'کاربر تاییدشده';

      profileState.isAuthenticated = true;
      profileState.user = {
        firstName,
        lastName,
        city: safeCity,
        phone
      };

      html = `
        <section class="profile-section fadein">
          <div class="profile-card glass">
            <div class="profile-hero">
              <div class="profile-avatar-large">${initials}</div>
              <div>
                <p class="profile-hello">سلام ${firstName}</p>
                <h2 class="profile-fullname">${fullName}</h2>
                <div class="profile-badges">
                  <span class="profile-badge">${membershipLabel}</span>
                  <span class="profile-badge profile-badge--outline">${safeCity}</span>
                </div>
              </div>
              <button type="button" class="profile-edit-btn" data-action="edit-profile">ویرایش اطلاعات</button>
            </div>
            <div class="profile-info-grid">
              <div class="profile-info-card">
                <div class="profile-info-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M7 3h10a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" />
                    <path d="M12 18h.01" />
                    <path d="M9 6h6" />
                    <path d="M9 10h6" />
                  </svg>
                </div>
                <div>
                  <p class="profile-info-label">شماره تماس</p>
                  <p class="profile-info-value" dir="ltr">${masked}</p>
                </div>
              </div>
              <div class="profile-info-card">
                <div class="profile-info-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a7 7 0 0 0-7 7c0 5 7 13 7 13s7-8 7-13a7 7 0 0 0-7-7z" />
                    <circle cx="12" cy="9" r="2.5" />
                  </svg>
                </div>
                <div>
                  <p class="profile-info-label">شهر</p>
                  <p class="profile-info-value">${safeCity}</p>
                </div>
              </div>
              <div class="profile-info-card">
                <div class="profile-info-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 2v2" />
                    <path d="M16 2v2" />
                    <rect x="4" y="4" width="16" height="18" rx="2" />
                    <path d="M4 10h16" />
                    <path d="M9 14h.01" />
                    <path d="M9 18h.01" />
                    <path d="M13 14h.01" />
                    <path d="M13 18h.01" />
                    <path d="M17 14h.01" />
                  </svg>
                </div>
                <div>
                  <p class="profile-info-label">عضویت از</p>
                  <p class="profile-info-value">${memberSince}</p>
                </div>
              </div>
              <div class="profile-info-card">
                <div class="profile-info-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 6v6l4 2" />
                    <circle cx="12" cy="12" r="10" />
                  </svg>
                </div>
                <div>
                  <p class="profile-info-label">آخرین فعالیت</p>
                  <p class="profile-info-value">${lastSeen}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="profile-secondary">
            <div class="profile-subcard glass">
              <h3>دسترسی سریع</h3>
              <p class="text-sm text-gray-500">مسیرهای مهم داشبورد تنها با یک کلیک در دسترس شماست.</p>
              <div class="profile-quick-actions">
                <button type="button" class="profile-quick-action" data-target-section="bookings">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="4" />
                    <path d="M16 2v4" />
                    <path d="M8 2v4" />
                    <path d="M3 10h18" />
                  </svg>
                  رزروهای من
                </button>
                <button type="button" class="profile-quick-action" data-target-section="favorites">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                  </svg>
                  علاقه‌مندی‌ها
                </button>
                <button type="button" class="profile-quick-action" data-target-section="dashboard">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 13h8V3H3z" />
                    <path d="M13 21h8V11h-8z" />
                    <path d="M13 3h8v4h-8z" />
                    <path d="M3 17h8v4H3z" />
                  </svg>
                  بازگشت به داشبورد
                </button>
              </div>
            </div>
          </div>
        </section>`;
    } catch (e) {
      profileState.isAuthenticated = false;
      profileState.user = {
        firstName: '',
        lastName: '',
        city: '',
        phone: ''
      };
      html = `
        <div class="glass px-6 py-7 fadein">
          <div class="text-center text-red-400 py-12">
            برای دسترسی به این بخش ابتدا
            <a href="/login.html"
              class="inline-block px-3 py-1.5 mx-1 rounded-xl brand-btn text-white font-bold text-base transition hover:scale-105"
              style="text-decoration:none;">وارد شوید</a>
            .
          </div>
        </div>`;
    }

      document.getElementById('mainContent').innerHTML = html;
      applyProfileStateToUI();
      initProfileSectionInteractions();
    }

  function initProfileSectionInteractions() {
    document.querySelectorAll('[data-target-section]').forEach(btn => {
      btn.addEventListener('click', () => {
        const { targetSection } = btn.dataset;
        if (targetSection) {
          showSection(targetSection);
        }
      });
    });

      const editBtn = document.querySelector('[data-action="edit-profile"]');
      if (editBtn) {
        editBtn.addEventListener('click', () => {
          openEditProfileModal();
        });
      }
    }








      async function ensureUserPhone() {
        if (window.currentUserPhone) return window.currentUserPhone;

        try {
          const res = await fetch('/api/user/profile', {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!res.ok) return '';

          const user = await res.json();
          const phone = user.phone || user.mobile || '';
          window.currentUserPhone = phone;
          return phone;
        } catch (_) {
          return '';
        }
      }

      async function fetchBookings(phone) {
        const res = await fetch(`/api/bookings?phone=${encodeURIComponent(phone)}`, {
          method: 'GET',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          let message = 'خطا در دریافت رزروها';
          try {
            const data = await res.json();
            if (data && data.message) message = data.message;
          } catch (_) {}
          throw new Error(message);
        }

        const data = await res.json();
        return Array.isArray(data.items) ? data.items : [];
      }

      async function getBookings(force = false) {
        if (!force && bookingsLoaded) {
          return { data: bookingsData, hasPhone: true };
        }

        const phone = await ensureUserPhone();
        if (!phone) {
          bookingsData = [];
          bookingsLoaded = false;
          return { data: [], hasPhone: false };
        }

        try {
          bookingsData = await fetchBookings(phone);
          bookingsLoaded = true;
          return { data: bookingsData, hasPhone: true };
        } catch (err) {
          bookingsData = [];
          bookingsLoaded = false;
          throw err;
        }
      }

      function updateBookingsBadge() {
        const dataset = (Array.isArray(allBookings) && allBookings.length)
          ? allBookings
          : (Array.isArray(bookingsData) ? bookingsData : []);

        const pendingCount = dataset
          .filter(b => (b.status || '').toLowerCase() === 'pending')
          .length;

        const badges = document.querySelectorAll('#bookings-badge');
        if (!badges.length) return;

        badges.forEach(badge => {
          if (pendingCount > 0) {
            badge.textContent = pendingCount.toLocaleString('fa-IR');
            badge.classList.remove('hidden');
          } else {
            badge.textContent = '';
            badge.classList.add('hidden');
          }
        });
      }

      function updateBookingsBadgeDisplay() {
        updateBookingsBadge();
      }

      async function refreshBookingsBadge(force = false) {
        const badges = document.querySelectorAll('#bookings-badge');
        if (!badges.length) return;

        try {
          const result = await getBookings(force);
          if (!result.hasPhone) {
            badges.forEach(b => {
              b.textContent = '';
              b.classList.add('hidden');
            });
            allBookings = [];
            return;
          }
          allBookings = Array.isArray(result.data) ? result.data : [];
          updateBookingsBadge();
        } catch (err) {
          console.error('refreshBookingsBadge error:', err);
          badges.forEach(b => {
            b.textContent = '';
            b.classList.add('hidden');
          });
          allBookings = [];
        }
      }

      // Load user's bookings
      async function loadBookings() {
        try {
          const token = localStorage.getItem('token');

          // Check if user is actually logged in
          if (!token) {
            console.log('No auth token found, skipping bookings');
            bookingsLoaded = false;
            allBookings = [];
            bookingsData = [];
            renderBookings([]);
            updateBookingsBadge();
            return;
          }

          const response = await fetch('/api/user/bookings', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const payload = await response.json();
            const bookings = Array.isArray(payload)
              ? payload
              : (Array.isArray(payload?.items) ? payload.items : []);

            allBookings = bookings;
            bookingsData = bookings;
            bookingsLoaded = true;
            renderBookings(allBookings);
            updateBookingsBadge();
          } else if (response.status === 401) {
            // User not authenticated - this is OK, just don't show bookings
            console.log('User not authenticated for bookings');
            allBookings = [];
            bookingsData = [];
            bookingsLoaded = false;
            renderBookings([]);
            updateBookingsBadge();
          } else {
            console.error('Failed to load bookings:', response.status);
          }
        } catch (error) {
          console.error('Error loading bookings:', error);
        }
      }

      // Cancel a booking
      async function cancelBooking(bookingId) {
        // Confirm with user
        if (!confirm('آیا مطمئن هستید که می‌خواهید این رزرو را لغو کنید؟')) {
          return;
        }

        try {
          const token = localStorage.getItem('token');

          const response = await fetch(`/api/bookings/${bookingId}/cancel`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            alert('رزرو با موفقیت لغو شد');

            // Reload bookings to show updated status
            await loadBookings();
          } else {
            const error = await response.json();
            alert(error.message || 'خطا در لغو رزرو');
          }
        } catch (error) {
          console.error('Error cancelling booking:', error);
          alert('خطا در ارتباط با سرور. لطفاً دوباره تلاش کنید.');
        }
      }

      async function loadBookingsSection() {
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
    <!-- Bookings Section -->
    <div id="bookings-section" class="section hidden">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">رزروهای من</h2>
        
        <!-- Status Filter Buttons -->
        <div class="flex flex-wrap gap-3 mb-6">
          <button data-status="all" class="filter-btn active px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-all duration-200 ease-out">
            همه
          </button>
          <button data-status="pending" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            در انتظار تایید
          </button>
          <button data-status="confirmed" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            تایید شده
          </button>
          <button data-status="completed" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            انجام شده
          </button>
          <button data-status="cancelled" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            لغو شده
          </button>
        </div>
        
        <!-- Bookings Container -->
        <div id="bookings-container" class="space-y-4">
          <div class="text-center text-gray-400 py-12">در حال دریافت رزروها...</div>
        </div>
        
        <!-- Empty State -->
        <div id="no-bookings" class="text-center py-12 hidden">
          <div class="text-6xl mb-4">📅</div>
          <p class="text-gray-500 text-lg mb-2">شما هنوز رزروی ندارید</p>
          <p class="text-gray-400 mb-6">برای رزرو خدمات، از صفحه دایرکتوری سرویس‌ها بازدید کنید</p>
          <a href="http://localhost:5000/shops-by-category.html?cat=service" class="inline-block px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
            مشاهده خدمات
          </a>
        </div>
      </div>
    </div>
  `;

        const section = document.getElementById('bookings-section');
        if (section) section.classList.remove('hidden');

        // Add event listeners for filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const status = btn.dataset.status;
            filterBookings(status, e);
          });
        });

        const container = document.getElementById('bookings-container');
        const emptyState = document.getElementById('no-bookings');
        if (container) container.innerHTML = `<div class="text-center text-gray-400 py-12">در حال دریافت رزروها...</div>`;
        if (emptyState) emptyState.classList.add('hidden');

        try {
          const result = await getBookings(true);
          if (!result.hasPhone) {
            if (container) {
              container.innerHTML = `<div class="text-center text-red-400 py-12">برای مشاهده رزروها ابتدا وارد شوید یا شماره تماس خود را در پروفایل ثبت کنید.</div>`;
            }
            allBookings = [];
            updateBookingsBadge();
            return;
          }

          allBookings = Array.isArray(result.data) ? result.data : [];
          bookingsData = allBookings;
          updateBookingsBadge();
          filterBookings('all');
        } catch (err) {
          console.error('loadBookingsSection error:', err);
          if (container) {
            container.innerHTML = `<div class="text-center text-red-400 py-12">خطا در دریافت رزروها. لطفاً بعداً دوباره تلاش کنید.</div>`;
          }
          allBookings = [];
          updateBookingsBadge();
        }
      }

      function filterBookings(status, evt) {
        const normalized = (status || 'all').toLowerCase();
        currentBookingFilter = normalized;

        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active', 'bg-blue-500', 'text-white');
          btn.classList.add('border', 'border-gray-300');
        });

        const target = evt?.currentTarget || evt?.target || document.querySelector(`.filter-btn[data-status="${normalized}"]`);
        if (target) {
          target.classList.add('active', 'bg-blue-500', 'text-white');
          target.classList.remove('border', 'border-gray-300');
        }

        if (!Array.isArray(allBookings) || allBookings.length === 0) {
          renderBookings([]);
          return;
        }

        const filtered = normalized === 'all'
          ? allBookings
          : allBookings.filter(item => (item.status || '').toLowerCase() === normalized);

        if (!filtered.length) {
          const container = document.getElementById('bookings-container');
          const noBookings = document.getElementById('no-bookings');
          if (container && noBookings) {
            container.classList.remove('hidden');
            container.innerHTML = `<div class="text-center text-gray-400 py-10 transition-opacity duration-300 ease-out">رزروی با این وضعیت پیدا نشد.</div>`;
            noBookings.classList.add('hidden');
          }
          return;
        }

        renderBookings(filtered);
      }

      // تبدیل تاریخ میلادی به شمسی
      function gregorianToJalali(gDate) {
        try {
          let date;
          if (typeof gDate === 'string') {
            // Handle different date formats
            if (gDate.includes('/')) {
              const parts = gDate.split('/');
              if (parts.length === 3) {
                date = new Date(parts[2], parts[1] - 1, parts[0]);
              } else {
                date = new Date(gDate);
              }
            } else {
              date = new Date(gDate);
            }
          } else {
            date = new Date(gDate);
          }

          if (isNaN(date.getTime())) {
            return gDate; // Return original if invalid
          }

          const gy = date.getFullYear();
          const gm = date.getMonth() + 1;
          const gd = date.getDate();

          const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
          let jy = (gy <= 1600) ? 0 : 979;
          gy > 1600 ? (jy += 1, gy -= 1601) : gy -= 621;
          const gy2 = (gm > 2) ? (gy + 1) : gy;
          let days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
          jy += 33 * (parseInt(days / 12053));
          days %= 12053;
          jy += 4 * (parseInt(days / 1461));
          days %= 1461;
          jy += parseInt((days - 1) / 365);
          if (days > 365) days = (days - 1) % 365;

          const jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
          const jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));

          const monthNames = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];
          return `${jd} ${monthNames[jm - 1]} ${jy}`;
        } catch (err) {
          console.error('Error converting date:', err);
          return gDate;
        }
      }

      // Render bookings to the page
      function renderBookings(bookings) {
        const container = document.getElementById('bookings-container');
        const noBookings = document.getElementById('no-bookings');

        if (!container || !noBookings) {
          return;
        }

        if (!bookings || bookings.length === 0) {
          container.classList.add('hidden');
          container.innerHTML = '';
          noBookings.classList.remove('hidden');
          return;
        }

        container.classList.remove('hidden');
        noBookings.classList.add('hidden');

        container.innerHTML = bookings.map(booking => {
          const sellerLink = getSellerLink(booking);
          const normalizedStatus = (booking.status || '').toLowerCase();
          const persianDate = gregorianToJalali(booking.bookingDate);

          return `
    <div class="booking-card fadein ${getBookingStatusClass(booking.status)}">
      <!-- Header Section -->
      <div class="booking-card-header">
        <div class="booking-service-icon-wrapper">
          <div class="booking-service-icon">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
        </div>
        <div class="booking-header-content">
          <div class="booking-service-name">
            <span class="booking-service-label">نام خدمت</span>
            <h3 class="booking-service-title">${escapeHtml(booking.service)}</h3>
          </div>
          <span class="${getStatusBadgeClass(booking.status)}">
            ${getStatusLabel(booking.status)}
          </span>
        </div>
      </div>

      <!-- Info Grid -->
      <div class="booking-info-grid">
        <div class="booking-info-item">
          <div class="booking-info-icon">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </div>
          <div class="booking-info-content">
            <span class="booking-info-label">فروشگاه</span>
            ${sellerLink ?
              `<a href="${sellerLink}" class="booking-info-value booking-info-link" target="_blank" rel="noopener noreferrer">
                ${escapeHtml(booking.sellerName || 'فروشگاه')}
              </a>` :
              `<span class="booking-info-value missing-seller-link cursor-pointer">
                ${escapeHtml(booking.sellerName || 'فروشگاه')}
              </span>`
            }
          </div>
        </div>

        <div class="booking-info-item">
          <div class="booking-info-icon">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
          <div class="booking-info-content">
            <span class="booking-info-label">تاریخ رزرو</span>
            <span class="booking-info-value">${escapeHtml(persianDate)}</span>
          </div>
        </div>

        <div class="booking-info-item">
          <div class="booking-info-icon">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="booking-info-content">
            <span class="booking-info-label">ساعت شروع</span>
            <span class="booking-info-value">${escapeHtml(booking.startTime)}</span>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="booking-actions">
        <button type="button" data-booking-id="${booking._id}" class="booking-action-btn booking-action-btn--primary show-booking-details">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>جزئیات رزرو</span>
        </button>
        ${(normalizedStatus === 'pending' || normalizedStatus === 'confirmed') ? `
          <button type="button" data-booking-id="${booking._id}" class="booking-action-btn booking-action-btn--danger cancel-booking">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>لغو رزرو</span>
          </button>
        ` : ''}
        ${normalizedStatus === 'cancelled' ? `
          <button type="button" data-booking-id="${booking._id}" class="booking-action-btn booking-action-btn--ghost delete-booking">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            <span>حذف دائمی</span>
          </button>
        ` : ''}
      </div>
    </div>
  `;
        }).join('');

        // Add event listeners for booking action buttons
        container.querySelectorAll('.show-booking-details').forEach(btn => {
          btn.addEventListener('click', () => {
            const bookingId = btn.dataset.bookingId;
            showBookingDetails(bookingId);
          });
        });

        container.querySelectorAll('.cancel-booking').forEach(btn => {
          btn.addEventListener('click', () => {
            const bookingId = btn.dataset.bookingId;
            cancelBooking(bookingId);
          });
        });

        container.querySelectorAll('.delete-booking').forEach(btn => {
          btn.addEventListener('click', () => {
            const bookingId = btn.dataset.bookingId;
            deleteBooking(bookingId);
          });
        });

        container.querySelectorAll('.missing-seller-link').forEach(span => {
          span.addEventListener('click', () => {
            alert('لینک فروشگاه موجود نیست');
          });
        });
      }

      function getBookingStatusClass(status) {
        const classes = {
          'pending': 'booking-card--pending',
          'confirmed': 'booking-card--confirmed',
          'completed': 'booking-card--completed',
          'cancelled': 'booking-card--cancelled'
        };
        const key = (status || '').toLowerCase();
        return classes[key] || 'booking-card--default';
      }

      function getStatusBadgeClass(status) {
        const classes = {
          'pending': 'status-badge status-badge--pending',
          'confirmed': 'status-badge status-badge--confirmed',
          'completed': 'status-badge status-badge--completed',
          'cancelled': 'status-badge status-badge--cancelled'
        };
        const key = (status || '').toLowerCase();
        return classes[key] || 'status-badge status-badge--default';
      }

      function getStatusLabel(status) {
        const labels = {
          'pending': 'در انتظار تایید',
          'confirmed': 'تایید شده',
          'completed': 'انجام شده',
          'cancelled': 'لغو شده'
        };
        const key = (status || '').toLowerCase();
        return labels[key] || (status || 'نامشخص');
      }

      function getSellerLink(booking) {
        if (!booking) return '';

        const slug = typeof booking.sellerUrl === 'string'
          ? booking.sellerUrl.trim()
          : '';
        if (slug) {
          return `/service-shops.html?shopurl=${encodeURIComponent(slug)}`;
        }

        let sellerId = booking.sellerId;
        if (sellerId && typeof sellerId === 'object') {
          if (sellerId._id || sellerId.id) {
            sellerId = sellerId._id || sellerId.id;
          } else if (typeof sellerId.toString === 'function') {
            sellerId = sellerId.toString();
          } else {
            sellerId = '';
          }
        }
        if (typeof sellerId === 'string' && sellerId.trim()) {
          return `/service-shops.html?sellerId=${encodeURIComponent(sellerId.trim())}`;
        }

        return '';
      }

      async function cancelBooking(id) {
        if (!id) return;

        const confirmed = window.confirm('آیا از لغو این رزرو اطمینان دارید؟');
        if (!confirmed) return;

        const token = localStorage.getItem('token');
        if (!token) {
          alert('برای لغو رزرو ابتدا وارد حساب کاربری خود شوید.');
          return;
        }

        try {
          const response = await fetch(`/api/bookings/${encodeURIComponent(id)}/cancel`, {
            method: 'PUT',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const message = errorData.message || 'لغو رزرو با خطا مواجه شد.';
            alert(message);
            return;
          }

          bookingsData = Array.isArray(bookingsData)
            ? bookingsData.map(booking => booking._id === id ? { ...booking, status: 'cancelled' } : booking)
            : [];
          allBookings = bookingsData;

          filterBookings(currentBookingFilter || 'all');
          updateBookingsBadge();

          alert('رزرو با موفقیت لغو شد.');
        } catch (error) {
          console.error('cancelBooking error:', error);
          alert('لغو رزرو با خطای غیرمنتظره مواجه شد.');
        }
      }

      async function deleteBooking(id) {
        if (!id) return;

        const confirmed = window.confirm('با حذف دائمی، امکان بازیابی این رزرو وجود نخواهد داشت. ادامه می‌دهید؟');
        if (!confirmed) return;

        const token = localStorage.getItem('token');
        if (!token) {
          alert('برای حذف رزرو ابتدا وارد حساب کاربری خود شوید.');
          return;
        }

        try {
          const response = await fetch(`/api/bookings/${encodeURIComponent(id)}`, {
            method: 'DELETE',
            credentials: 'include',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const message = errorData.message || 'حذف رزرو با خطا مواجه شد.';
            alert(message);
            return;
          }

          bookingsData = Array.isArray(bookingsData)
            ? bookingsData.filter(booking => booking._id !== id)
            : [];
          allBookings = bookingsData;

          filterBookings(currentBookingFilter || 'all');
          updateBookingsBadge();

          alert('رزرو برای همیشه حذف شد.');
        } catch (error) {
          console.error('deleteBooking error:', error);
          alert('حذف رزرو با خطای غیرمنتظره مواجه شد.');
        }
      }

      // Show booking details modal
      function showBookingDetails(bookingId) {
        if (!bookingId) return;

        // Find the booking in our data
        const booking = allBookings.find(b => b._id === bookingId);
        if (!booking) {
          alert('اطلاعات رزرو یافت نشد');
          return;
        }

        // Format created date in Persian if available
        let createdDate = 'نامشخص';
        if (booking.createdAt) {
          try {
            const date = new Date(booking.createdAt);
            createdDate = date.toLocaleDateString('fa-IR', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch (e) {
            createdDate = booking.createdAt;
          }
        }

        // Format booking date to Shamsi (Persian) calendar
        let bookingDateShamsi = booking.bookingDate;
        if (booking.bookingDate) {
          try {
            // Try to parse the date - it might be in format like "2024-01-15" or "15/01/2024"
            let dateObj;
            if (booking.bookingDate.includes('-')) {
              // Format: YYYY-MM-DD
              dateObj = new Date(booking.bookingDate);
            } else if (booking.bookingDate.includes('/')) {
              // Format: DD/MM/YYYY or MM/DD/YYYY
              const parts = booking.bookingDate.split('/');
              if (parts.length === 3) {
                // Assume DD/MM/YYYY format
                dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
              }
            }

            if (dateObj && !isNaN(dateObj.getTime())) {
              bookingDateShamsi = dateObj.toLocaleDateString('fa-IR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              });
            }
          } catch (e) {
            // Keep original value if conversion fails
            bookingDateShamsi = booking.bookingDate;
          }
        }

        // Remove any existing modal
        document.getElementById('bookingDetailsModal')?.remove();

        const isMobileViewport = window.matchMedia('(max-width: 640px)').matches;
        const modalMaxHeight = isMobileViewport ? '98vh' : '92vh';
        const contentOffset = isMobileViewport ? 120 : 180;
        const contentMaxHeight = `calc(${modalMaxHeight} - ${contentOffset}px)`;

        // Create and insert modal
        document.body.insertAdjacentHTML('beforeend', `
          <div id="bookingDetailsModal" class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4" style="z-index:9999;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);animation:fadein .2s">
            <div class="bg-gradient-to-br from-white to-gray-50 rounded-t-3xl sm:rounded-3xl w-full sm:max-w-[650px] overflow-hidden shadow-2xl" style="z-index:10000;animation:slideUp .3s ease-out;max-height:${modalMaxHeight}">

              <!-- Header with Gradient -->
              <div class="sticky top-0 bg-gradient-to-r from-blue-600 via-blue-500 to-indigo-600 px-6 py-5 flex justify-between items-center shadow-lg" style="z-index:100">
                <div class="flex items-center gap-3">
                  <div class="bg-white/20 backdrop-blur-sm p-2 rounded-xl">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <h2 class="text-xl sm:text-2xl font-bold text-white drop-shadow-sm">جزئیات رزرو</h2>
                </div>
                <button class="close-booking-modal text-white/90 hover:text-white hover:bg-white/20 rounded-xl p-2.5 transition-all duration-200 backdrop-blur-sm">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>

              <!-- Content with Card Design -->
              <div class="p-5 sm:p-7 space-y-5 pb-28 sm:pb-7 overflow-y-auto" style="max-height:${contentMaxHeight}">

                <!-- Service Card -->
                <div class="bg-white rounded-2xl p-5 shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200">
                  <div class="flex items-start gap-3">
                    <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-2.5 rounded-xl shadow-md flex-shrink-0">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">خدمت درخواستی</div>
                      <div class="text-gray-900 text-lg font-bold">${escapeHtml(booking.service)}</div>
                    </div>
                  </div>
                </div>

                <!-- Shop Card -->
                <div class="bg-white rounded-2xl p-5 shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200">
                  <div class="flex items-start gap-3">
                    <div class="bg-gradient-to-br from-purple-500 to-pink-600 p-2.5 rounded-xl shadow-md flex-shrink-0">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">فروشگاه</div>
                      <div class="text-gray-800">
                        ${(() => {
                          const sellerLink = getSellerLink(booking);
                          if (sellerLink) {
                            return `<a href="${sellerLink}"
                                       class="text-blue-600 hover:text-blue-700 font-semibold inline-flex items-center gap-2 hover:gap-3 transition-all group"
                                       target="_blank" rel="noopener noreferrer">
                                      ${escapeHtml(booking.sellerName || 'فروشگاه')}
                                      <svg class="w-4 h-4 group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                      </svg>
                                    </a>`;
                          }
                          return `<span class="font-semibold text-gray-900">${escapeHtml(booking.sellerName || 'فروشگاه')}</span>`;
                        })()}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Date & Time Card -->
                <div class="bg-white rounded-2xl p-5 shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200">
                  <div class="flex items-start gap-3">
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 p-2.5 rounded-xl shadow-md flex-shrink-0">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">زمان رزرو</div>
                      <div class="space-y-3">
                        <div class="flex items-center gap-3 bg-gray-50 rounded-xl p-3">
                          <div class="bg-white p-2 rounded-lg shadow-sm">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                          </div>
                          <span class="text-gray-900 font-semibold">${escapeHtml(bookingDateShamsi)}</span>
                        </div>
                        <div class="flex items-center gap-3 bg-gray-50 rounded-xl p-3">
                          <div class="bg-white p-2 rounded-lg shadow-sm">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                          </div>
                          <span class="text-gray-900 font-semibold">${escapeHtml(booking.startTime)}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Status Card -->
                <div class="bg-white rounded-2xl p-5 shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200">
                  <div class="flex items-start gap-3">
                    <div class="bg-gradient-to-br from-orange-500 to-red-600 p-2.5 rounded-xl shadow-md flex-shrink-0">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">وضعیت رزرو</div>
                      <span class="inline-flex items-center px-4 py-2 rounded-xl text-sm font-bold shadow-sm ${getStatusBadgeClass(booking.status)}">
                        ${getStatusLabel(booking.status)}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Created Date Card -->
                <div class="bg-white rounded-2xl p-5 shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200">
                  <div class="flex items-start gap-3">
                    <div class="bg-gradient-to-br from-gray-500 to-gray-700 p-2.5 rounded-xl shadow-md flex-shrink-0">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">تاریخ ثبت رزرو</div>
                      <div class="text-gray-800 font-semibold">${escapeHtml(createdDate)}</div>
                    </div>
                  </div>
                </div>

                ${booking.customerName || booking.customerPhone ? `
                  <!-- Customer Info Card -->
                  <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-5 shadow-md border border-blue-100 hover:shadow-lg transition-shadow duration-200">
                    <div class="flex items-start gap-3">
                      <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-2.5 rounded-xl shadow-md flex-shrink-0">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                      </div>
                      <div class="flex-1">
                        <div class="text-xs font-bold text-blue-700 uppercase tracking-wider mb-3">اطلاعات مشتری</div>
                        <div class="space-y-2.5">
                          ${booking.customerName ? `
                            <div class="flex items-center gap-2 bg-white rounded-lg p-3 shadow-sm">
                              <svg class="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                              </svg>
                              <span class="text-gray-600 text-sm font-medium">نام:</span>
                              <span class="text-gray-900 font-semibold">${escapeHtml(booking.customerName)}</span>
                            </div>
                          ` : ''}
                          ${booking.customerPhone ? `
                            <div class="flex items-center gap-2 bg-white rounded-lg p-3 shadow-sm">
                              <svg class="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                              </svg>
                              <span class="text-gray-600 text-sm font-medium">تلفن:</span>
                              <span class="text-gray-900 font-semibold font-mono">${escapeHtml(booking.customerPhone)}</span>
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  </div>
                ` : ''}

              </div>

              <!-- Footer - Mobile Fixed with Gradient -->
              <div class="fixed sm:sticky bottom-0 left-0 right-0 bg-gradient-to-t from-white via-white to-transparent px-6 pt-4 pb-5 border-t border-gray-200 sm:rounded-b-3xl backdrop-blur-sm" style="box-shadow: 0 -4px 20px rgba(0,0,0,0.08);padding-bottom:calc(env(safe-area-inset-bottom,0px) + 20px)">
                <button
                  class="close-booking-modal w-full sm:w-auto px-8 py-3.5 bg-gradient-to-r from-gray-700 to-gray-900 text-white rounded-xl hover:from-gray-800 hover:to-black transition-all font-bold shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98] duration-200">
                  بستن
                </button>
              </div>

            </div>
          </div>
        `);

        // Add event listeners for modal close buttons
        document.querySelectorAll('.close-booking-modal').forEach(btn => {
          btn.addEventListener('click', closeBookingDetails);
        });

        // Also close when clicking the backdrop
        const modal = document.getElementById('bookingDetailsModal');
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeBookingDetails();
            }
          });
        }

        // Close on ESC key
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            closeBookingDetails();
          }
        };
        document.addEventListener('keydown', handleEscape);

        // Store handler for cleanup
        modal._escapeHandler = handleEscape;
      }

      // Close booking details modal
      function closeBookingDetails() {
        const modal = document.getElementById('bookingDetailsModal');
        if (modal && modal._escapeHandler) {
          document.removeEventListener('keydown', modal._escapeHandler);
        }
        modal?.remove();
      }

      // Helper to escape HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text == null ? '' : String(text);
        return div.innerHTML;
      }

      // داشبورد پیش‌فرض
  const dashboardSection = `
  <div class="glass flex flex-col md:flex-row items-center justify-between px-5 md:px-8 py-5 md:py-7 fadein gap-3 md:gap-0">
    <div>
      <div class="text-xl md:text-2xl font-black primary-text mb-1">👋 خوش آمدید، کاربر عزیز!</div>
      <div class="text-gray-500 text-sm md:text-base">امیدواریم تجربه‌ی خوبی داشته باشید.</div>
    </div>
  </div>
  <div class="glass p-5 md:p-7 fadein">
    <h2 class="text-base md:text-lg font-bold text-gray-700 mb-4 md:mb-5">دسترسی سریع</h2>
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-4">
      <!-- رزرو خدمات -->
      <a href="/service-directory.html" class="quick-action">
        <svg class="quick-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
          <path d="M8 14h.01"></path>
          <path d="M12 14h.01"></path>
          <path d="M16 14h.01"></path>
          <path d="M8 18h.01"></path>
          <path d="M12 18h.01"></path>
        </svg>
        <span class="quick-action-label">رزرو خدمات</span>
      </a>

      <!-- فروشگاه / محصولات -->
      <a href="/all-products.html" class="quick-action">
        <svg class="quick-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        <span class="quick-action-label">فروشگاه / محصولات</span>
      </a>

      <!-- پیام‌ها -->
      <button type="button" class="quick-action" data-section="messages">
        <svg class="quick-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          <line x1="9" y1="10" x2="15" y2="10"></line>
          <line x1="9" y1="14" x2="13" y2="14"></line>
        </svg>
        <span class="quick-action-label">پیام‌ها</span>
      </button>

      <!-- علاقه‌مندی‌ها -->
      <button type="button" class="quick-action" data-section="favorites">
        <svg class="quick-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
        <span class="quick-action-label">علاقه‌مندی‌ها</span>
      </button>

      <!-- رزروهای من -->
      <button type="button" class="quick-action" data-section="bookings">
        <svg class="quick-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <span class="quick-action-label">رزروهای من</span>
      </button>
    </div>
  </div>

  <!-- مودال اقدامات بیشتر -->
  <div id="moreActionsModal" class="more-actions-modal">
    <div class="more-actions-content">
      <div class="more-actions-header">
        <h3 class="text-lg font-bold text-gray-800">اقدامات بیشتر</h3>
        <button type="button" class="more-actions-close" id="closeMoreActions">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="more-actions-grid">
        <!-- رزروهای من -->
        <button type="button" class="more-action-item" data-section="bookings">
          <svg class="more-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          <span>رزروهای من</span>
        </button>

        <!-- فروشگاه‌ها -->
        <a href="/all-shops.html" class="more-action-item">
          <svg class="more-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          <span>فروشگاه‌ها</span>
        </a>

        <!-- جستجو -->
        <a href="/search.html" class="more-action-item">
          <svg class="more-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <span>جستجو</span>
        </a>

        <!-- تنظیمات -->
        <button type="button" class="more-action-item" data-section="profile">
          <svg class="more-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m5.2-13.2l-4.2 4.2m0 6l-4.2 4.2M23 12h-6m-6 0H5m13.2 5.2l-4.2-4.2m0-6l-4.2-4.2"></path>
          </svg>
          <span>تنظیمات</span>
        </button>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-5 fadein">
    <div id="favBoxClick" class="glass p-6 flex flex-col items-center text-center min-h-[135px] justify-center cursor-pointer hover:shadow-lg transition">
      <div class="text-[#0ea5e9] font-bold text-base mb-1">علاقه‌مندی‌های ثبت‌شده</div>
      <div class="text-4xl font-black primary-text mb-1" id="favCountDashboard">-</div>
    <a href="#" class="text-xs font-bold text-[#0ea5e9] hover:underline menu-btn mt-2" data-section="favorites">نمایش لیست</a>
    </div>
    <div id="recentFavsContainerWrapper" class="flex flex-col">
      <div id="recentFavsContainer"></div>
    </div>
  </div>
  `;





  function setupQuickActions() {
    // اقدامات سریع با data-section
    document.querySelectorAll('.quick-action[data-section]').forEach(action => {
      action.addEventListener('click', (event) => {
        event.preventDefault();
        const target = action.getAttribute('data-section');
        if (target) {
          showSection(target);
        }
      });
    });

    // دکمه "بیشتر..."
    const moreBtn = document.getElementById('moreActionsBtn');
    const modal = document.getElementById('moreActionsModal');
    const closeBtn = document.getElementById('closeMoreActions');

    if (moreBtn && modal) {
      moreBtn.addEventListener('click', () => {
        modal.classList.add('active');
      });
    }

    if (closeBtn && modal) {
      closeBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });
    }

    // بستن مودال با کلیک روی پس‌زمینه
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    }

    // اقدامات بیشتر در مودال
    document.querySelectorAll('.more-action-item[data-section]').forEach(item => {
      item.addEventListener('click', (event) => {
        event.preventDefault();
        const target = item.getAttribute('data-section');
        if (target) {
          modal.classList.remove('active');
          showSection(target);
        }
      });
    });

    // بستن مودال با کلید ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal && modal.classList.contains('active')) {
        modal.classList.remove('active');
      }
    });
  }

  async function renderRecentFavorites() {
    const container = document.getElementById('recentFavsContainer');
    container.innerHTML = `
      <div class="glass px-6 py-5 fadein">
        <div class="flex items-center justify-between mb-4">
          <span id="recentFavsTitle" class="text-lg font-bold primary-text cursor-pointer">علاقه‌مندی‌های اخیر شما</span>
          <a href="#" id="recentFavsShowAll" class="text-[#0ea5e9] hover:underline font-bold text-sm menu-btn">مشاهده همه</a>
        </div>
        <div class="flex flex-wrap gap-3 scrollbar-hide overflow-x-auto" id="recentFavsList">
          <div class="text-gray-400 text-center w-full py-3">در حال دریافت ...</div>
        </div>
      </div>
    `;

    try {
      // درخواست با کوکی و بدون هدر Authorization
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include', // کوکی‌ها (توکن) ارسال می‌شود
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!res.ok) throw new Error();

      const user = await res.json();
      const favs = Array.isArray(user.favorites) ? user.favorites : [];

      const favsList = container.querySelector("#recentFavsList");
      if (favs.length === 0) {
        favsList.innerHTML = `<div class="text-gray-400 text-center w-full py-3">هنوز علاقه‌مندی ثبت نکردی!</div>`;
      } else {
        favsList.innerHTML = favs.slice(-3).reverse().map(p => {
          const shop = (p.sellerId && typeof p.sellerId === 'object') ? p.sellerId : {};
          return `
            <div class="min-w-[170px] max-w-xs bg-[#e0fdfa] rounded-xl p-3 flex flex-col items-center text-center">
              <img src="${(p.images && p.images[0]) ? p.images[0] : '/assets/images/noimage.png'}" class="w-20 h-20 object-cover rounded-xl mb-2 shadow" alt="${p.title || ''}"/>
              <span class="text-[#10b981] text-base font-bold mb-1">${p.title || '-'}</span>
              <span class="text-xs text-gray-500 mb-1">${shop.storename ? `فروشگاه ${shop.storename}` : ''}</span>
              <span class="text-xs text-gray-600 mb-1">قیمت: ${p.price ? p.price.toLocaleString('fa-IR') + ' تومان' : '-'}</span>
              <a href="http://localhost:5000/product.html?id=${p._id}" class="mt-2 px-4 py-1.5 rounded-lg brand-btn text-xs font-bold inline-block" target="_blank" rel="noopener noreferrer">مشاهده محصول</a>
            </div>
          `;
        }).join('');
      }
    } catch (e) {
      const favsList = container.querySelector("#recentFavsList");
      favsList.innerHTML = `<div class="text-red-400 text-center w-full py-3">دریافت لیست علاقه‌مندی‌ها ناموفق بود.</div>`;
    }
  }






      // هندل کردن SPA و رسپانسیو
  function showSection(section) {
    const mainContent = document.getElementById('mainContent');
    // پاک کردن فعال بودن منوها
    document.querySelectorAll('.menu-btn').forEach(btn=>btn.classList.remove('tab-active'));
    // فعال کردن منوی فعلی
  document.querySelectorAll(`.menu-btn[data-section="${section}"]`).forEach(btn => btn.classList.add('tab-active'));
    // محتوا
    if(section === 'dashboard') {
      mainContent.innerHTML = dashboardSection;
      setupQuickActions();
      renderRecentFavorites(); // اینجا رندر داینامیک رو صدا بزن
      updateDashboardFavCount(); // اینم اضافه کن تا تعداد علاقه‌مندی درست بشه
    }
    else if(section === 'profile') loadProfileSection();
    else if(section === 'favorites') loadFavoritesSection();
    else if(section === 'favshops') loadFavShopsSection();
    else if(section === 'bookings') loadBookingsSection();
    else if(section === 'messages') loadMessagesSection();

    if(section === 'messages') startMsgPolling(); else stopMsgPolling();

    // اسکرول به بالا
    mainContent.scrollIntoView({behavior:'smooth',block:'start'});
  }


  async function updateDashboardFavCount() {
    try {
      // درخواست با کوکی (credentials: 'include')
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      if (!res.ok) {
        document.getElementById('favCountDashboard').textContent = '-';
        return;
      }
      const user = await res.json();
      document.getElementById('favCountDashboard').textContent =
        Array.isArray(user.favorites) ? user.favorites.length : '0';
    } catch (e) {
      document.getElementById('favCountDashboard').textContent = '-';
    }
  }


      // منوهای دسکتاپ و موبایل

  /* ——— هندل منوهای سایدبار (مستقیم) ——— */
  document.addEventListener('click', e => {
    const btn = e.target.closest('.menu-btn');
    if (!btn) return;
    e.preventDefault();
    showSection(btn.dataset.section);
    if (window.innerWidth < 1024) closeSidebar();
  });




      // سوییچ کردن با دکمه پروفایل
      document.getElementById('profileBtn').onclick=function(){
        showSection('profile');
        // Don't open sidebar when clicking profile - just show profile section
      };

      // همبرگر موبایل
      function openSidebar(){
        markNotificationsViewed();
        document.getElementById('mobileSidebar').classList.add('open');
        document.getElementById('sidebarOverlay').classList.add('open');
        document.body.style.overflow='hidden';
      }
      function closeSidebar(){
        document.getElementById('mobileSidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('open');
        document.body.style.overflow='';
      }
      const hamBtn = document.getElementById('hamBtn');
      if (hamBtn) {
        hamBtn.addEventListener('click', openSidebar);
      }
      document.getElementById('closeSidebar').onclick = closeSidebar;
      document.getElementById('sidebarOverlay').onclick = closeSidebar;
      document.addEventListener('keydown', function(e){
        if(e.key === "Escape"){
          closeSidebar();
        }
      });





  // به‌روزرسانی اطلاعات کاربر در سایدبار (موبایل + دسکتاپ)
  async function updateSidebarUser() {
    try {
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',          // ارسال توکن از طریق کوکی
        headers: { 'Content-Type': 'application/json' }
      });
      if (!res.ok) throw new Error();

      const user   = await res.json();

      /* ↙️ آی‌دی کاربر را برای فیلتر چت‌ها نگه می‌داریم */
      window.currentUserId = user._id;     

      const first  = user.firstname || user.firstName || 'کاربر';
      const last   = user.lastname  || user.lastName  || 'ویترینت';
        const phone  = user.phone     || user.mobile    || '';
        profileState.isAuthenticated = true;
        profileState.user = {
          ...profileState.user,
          firstName: first,
          lastName: last,
          phone
        };
        applyProfileStateToUI();

        window.currentUserPhone = phone;
        refreshBookingsBadge();
      } catch (_) {
      profileState.isAuthenticated = false;
      profileState.user = {
        firstName: '',
        lastName: '',
        city: '',
        phone: ''
      };
      applyProfileStateToUI();
    }
  }








  async function loadFavoritesSection() {
    let html = `<div class="glass px-6 py-7 fadein"><div class="text-center text-gray-400 py-12">در حال دریافت...</div></div>`;
    document.getElementById('mainContent').innerHTML = html;

    try {
      // درخواست با کوکی (credentials: 'include')
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include', // مهم!
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });

      if (!res.ok) throw new Error('دریافت پروفایل کاربر ناموفق بود!');
      const user = await res.json();
      const favs = user.favorites;

      if (!Array.isArray(favs) || favs.length === 0) {
        html = `<div class="glass px-6 py-7 fadein text-center text-gray-400">هیچ محصولی در علاقه‌مندی‌ها نیست.</div>`;
      } else {
        html = `
        <div class="glass px-6 py-7 fadein">
          <div class="text-xl font-black primary-text mb-5">علاقه‌مندی‌های من</div>
          <div class="flex flex-wrap gap-4">
            ${favs.map(p => {
              const shop = (p.sellerId && typeof p.sellerId === 'object') ? p.sellerId : {};
              return `
                <div class="min-w-[170px] max-w-xs bg-[#e0fdfa] rounded-xl p-3 flex flex-col items-center text-center">
                  <img src="${(p.images && p.images[0]) ? p.images[0] : '/assets/images/noimage.png'}" class="w-24 h-24 object-cover rounded-xl mb-2 shadow" alt="${p.title || ''}"/>
                  <span class="text-[#10b981] text-lg font-bold mb-1">${p.title || '-'}</span>
                  <span class="text-xs text-gray-500 mb-1">${shop.storename ? `فروشگاه ${shop.storename}` : ''}</span>
                  <span class="text-xs text-gray-600 mb-1">قیمت: ${p.price ? p.price.toLocaleString('fa-IR') + ' تومان' : '-'}</span>
                  <a href="http://localhost:5000/product.html?id=${p._id}" class="mt-2 px-4 py-1.5 rounded-lg brand-btn text-xs font-bold inline-block" target="_blank" rel="noopener noreferrer">مشاهده محصول</a>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        `;
      }
    } catch (e) {
      html = `<div class="glass px-6 py-7 fadein text-center text-red-400">${e.message}</div>`;
    }

    document.getElementById('mainContent').innerHTML = html;
  }

  async function loadFavShopsSection() {
    let html = `<div class="glass px-6 py-7 fadein"><div class="text-center text-gray-400 py-12">در حال دریافت...</div></div>`;
    document.getElementById('mainContent').innerHTML = html;

    try {
      const res = await fetch('/api/favorite-shops', {
        method: 'GET',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-cache' }
      });
      if (!res.ok) throw new Error('دریافت لیست ناموفق بود!');
      const shops = await res.json();

      // حذف مقادیر null/undefined برای جلوگیری از خطاهای دسترسی به خصوصیت
      const validShops = Array.isArray(shops) ? shops.filter(Boolean) : [];

      const resolveShopImage = (shop) => {
        const candidate = shop?.boardImage
          || shop?.coverImage
          || shop?.banner
          || (Array.isArray(shop?.images) ? shop.images[0] : shop?.image);
        const src = candidate || '/assets/images/shop-placeholder.svg';
        if (/^https?:/i.test(src) || src.startsWith('data:') || src.startsWith('//')) return src;
        if (src.startsWith('/')) return src;
        return `/${src.replace(/^\/+/, '')}`;
      };

      const buildShopLink = (shop) => {
        const slug = shop?.shopurl || shop?.shopUrl || shop?.slug;
        if (slug) return `/shop.html?shopurl=${encodeURIComponent(slug)}`;
        if (shop?._id) return `/shop.html?id=${encodeURIComponent(shop._id)}`;
        return '';
      };

      if (validShops.length === 0) {
        html = `<div class="glass px-6 py-7 fadein text-center text-gray-400">هیچ مغازه‌ای در لیست محبوب‌ها نیست.</div>`;
      } else {
        html = `
        <div class="glass px-6 py-7 fadein">
          <div class="text-xl font-black primary-text mb-5">مغازه‌های محبوب من</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            ${validShops.map(s => {
              const shop = s || {};
              const cover = resolveShopImage(shop);
              const linkUrl = buildShopLink(shop);
              const category = shop.category || shop.subcategory || 'دسته‌بندی ثبت نشده';
              return `
              <div class="relative overflow-hidden rounded-2xl bg-white border border-emerald-50 shadow-xl transition hover:-translate-y-1 hover:shadow-2xl flex flex-col">
                <div class="relative h-32 w-full overflow-hidden">
                  <img src="${cover}" alt="${shop.storename || 'فروشگاه'}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='/assets/images/shop-placeholder.svg'" />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-black/10"></div>
                  <span class="absolute top-3 left-3 bg-white/80 text-emerald-600 text-[11px] font-extrabold px-3 py-1 rounded-full shadow-sm">محبوب</span>
                </div>
                <div class="p-4 flex flex-col gap-2 text-right">
                  <div class="flex items-center justify-between gap-2 flex-wrap">
                    <span class="text-lg font-black text-slate-800">${shop.storename || '-'}</span>
                    <span class="text-[11px] px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">${category}</span>
                  </div>
                  ${shop.city || shop.address ? `<p class="text-xs text-gray-500 flex items-center gap-1"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-emerald-500"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/></svg>${[shop.city, shop.address].filter(Boolean).join('، ')}</p>` : ''}
                  <div class="flex gap-2 pt-2">
                    ${linkUrl ? `<a href="${linkUrl}" target="_blank" rel="noopener noreferrer" class="flex-1 brand-btn rounded-xl px-4 py-2 text-sm font-bold flex items-center justify-center gap-2 shadow-sm hover:shadow-lg"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 3h7v7m0-7L10 14"/><path stroke-linecap="round" stroke-linejoin="round" d="M5 5h4m-4 4h2m5 10H5a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h5l4 4v12c0 1.1-.9 2-2 2Z"/></svg>ورود به صفحه مغازه</a>` : ''}
                    ${shop._id ? `<button data-id="${shop._id}" class="removeFavShop px-4 py-2 rounded-xl border border-red-100 bg-red-50 text-red-600 text-sm font-bold transition hover:bg-red-100">حذف</button>` : ''}
                  </div>
                </div>
              </div>
              `;
            }).join('')}
          </div>
        </div>`;
      }
    } catch (e) {
      html = `<div class="glass px-6 py-7 fadein text-center text-red-400">${e.message}</div>`;
    }

    document.getElementById('mainContent').innerHTML = html;

    document.querySelectorAll('.removeFavShop').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        btn.disabled = true;
        try {
          await fetch(`/api/favorite-shops/${id}`, { method: 'DELETE', credentials: 'include' });
          loadFavShopsSection();
        } catch { btn.disabled = false; }
      });
    });
  }




  /* ─────────  پیام‌های کاربر  ───────── */
  /* ───────── بخش پیام‌های حرفه‌ای کاربر ───────── */
  const API_BASE  = '/api';           // طبق سرورت
  let chatsList   = [];               // لیست چت‌ها
  const LAST_NOTIF_KEY = 'userDashboard.lastNotificationsViewedAt';

  function getLastNotificationsViewedAt() {
    try {
      return Number(localStorage.getItem(LAST_NOTIF_KEY)) || 0;
    } catch (_) {
      return 0;
    }
  }

  function setLastNotificationsViewedNow() {
    try {
      localStorage.setItem(LAST_NOTIF_KEY, String(Date.now()));
    } catch (_) {
      /* ignore storage errors */
    }
  }
  let currentCid  = null;             // آی‌دی چت انتخاب شده
  let blockedSellers = [];            // فروشندگان مسدودشده

async function loadMessagesSection() {
  const box = document.getElementById('mainContent');
  box.innerHTML = `
    <div id="messages-section" class="glass px-4 py-7 fadein">
      <div class="flex items-center justify-between mb-4">
        <span class="text-xl font-black primary-text">پیام‌های من</span>
        <button class="open-admin-msg brand-btn text-sm px-3 py-1.5 rounded-xl">چت با مدیر سایت</button>
      </div>
      <div id="userChatsList" class="w-full min-h-[180px]"></div>
    </div>
  `;

  // Add event listener for admin message button
  const adminMsgBtn = document.querySelector('.open-admin-msg');
  if (adminMsgBtn) {
    adminMsgBtn.addEventListener('click', openAdminMsgModal);
  }

  await fetchBlockedSellers(); // فروشنده‌های مسدودشده را بگیر
  await fetchUserChats();  // لیست چت‌ها رو بگیر
  renderMessagesList();    // رندر کن
  startMsgPolling();       // polling شروع کن
}

  /* گرفتن لیست چت‌ها */
  /*  دریافت لیست چت‌های *خودِ کاربر*  */
/* گرفتن لیست چت‌ها (فقط لیست، بدون جزئیات پیام‌ها) */
async function fetchUserChats() {
  try {
    const res = await fetch(`${API_BASE}/chats/my`, {
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();

    const allChats = Array.isArray(data) ? data : (data.chats || []);
    const uid = window.currentUserId;

    chatsList = allChats.filter(c => {
      if (!uid) return false;
      if (c.type === 'admin' || c.type === 'user-admin' || c.type === 'admin-user') return true;
      if (c.userId && c.userId === uid) return true;
      if (Array.isArray(c.participants) && c.participants.some(p => {
        if (!p) return false;
        return (typeof p === 'string' && p === uid) ||
               (typeof p === 'object' && p._id === uid);
      })) return true;
      if (Array.isArray(c.users) && c.users.some(u => u._id === uid)) return true;
      return false;
    });


  } catch (e) {
    chatsList = [];
  }
}

async function loadMessages() {
  try {
    await fetchUserChats();
    updateBadge();
  } catch (error) {
    console.error('Error loading messages:', error);
  }
}


  /* رندر لیست چت‌ها (با شخص/مدیر/فروشنده و محصول مرتبط) */
/* رندر لیست چت‌ها (با شخص/مدیر/فروشنده و محصول مرتبط) */
/* رندر لیست چت‌ها (با شخص/مدیر/فروشنده و محصول مرتبط) */
/* رندر لیست چت‌ها (با شخص/مدیر/فروشنده و محصول مرتبط) */
/* رندر لیست چت‌ها (با شخص/مدیر/فروشنده و محصول مرتبط) */
/* رندر لیست چت‌ها (با شخص/مدیر/فروشنده و محصول مرتبط) */
function renderMessagesList() {
  const box = document.getElementById('userChatsList');
  console.log("لیست چت‌ها:", chatsList);

  if (!chatsList.length) {
    box.innerHTML = `<div class="text-gray-400 text-center py-8">هیچ گفتگویی نداری! از دکمه پیام جدید به مدیر استفاده کن.</div>`;
    return;
  }

  // شناسه کاربر فعلی
  const myId = window.currentUserId;

  box.innerHTML = chatsList.map(c => {
    console.log('ساختار چت در لیست:', c._id, c);

    let whom = 'مخاطب'; // پیش‌فرض
    let role = '';
    let sellerId = null;
    let storeName = '';
    let shopUrl = '';
    let isBlocked = false;

    if (Array.isArray(c.participants)) {
      const participant = c.participants.find(p => p && p._id !== myId);
      if (participant) {
        role = participant.role;
        sellerId = participant._id;
        storeName = participant.storename || '';
        shopUrl = participant.shopurl || '';
        whom = role === 'seller' ? 'فروشنده' : (role === 'admin' ? 'مدیر سایت' : (role === 'user' ? 'مشتری' : 'مخاطب'));
      }
    }

    if (role === 'seller' && sellerId) {
      isBlocked = blockedSellers.includes(sellerId);
    }

    if (!role && Array.isArray(c.participantsModel)) {
      if (c.participantsModel.includes('Admin')) {
        role = 'admin';
        whom = 'مدیر سایت';
      } else if (c.participantsModel.includes('Seller')) {
        role = 'seller';
        whom = 'فروشنده';
      }
    }

    // fallback از type
    if (!role && c.type) {
      if (c.type === 'user-seller' || c.type === 'seller-admin') {
        whom = 'فروشنده';
        role = 'seller';
        sellerId = c.sellerId;
    } else if (c.type === 'user-admin' || c.type === 'admin-user' || c.type === 'admin') {
      whom = 'مدیر سایت';
      role = 'admin';
    }
    }

    let whomDisplay = whom;
    if (role === 'seller' && sellerId) {
      const linkUrl = shopUrl ? `/store/${shopUrl}` : `/store.html?id=${sellerId}`;
      const linkText = storeName ? `فروشنده (${storeName})` : 'فروشنده';
      whomDisplay = `<a href="${linkUrl}" class="text-[#10b981] hover:text-blue-700 hover:underline font-semibold" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
    }

let prodBlock = '';
if (c.productId && c.productId.title) {
  const productUrl = `/product.html?id=${c.productId._id}`;
  prodBlock = `
    <div class="flex items-center gap-2 mt-2">
      <!-- فقط عکس لینک‌دار -->
      <a href="${productUrl}" target="_blank" rel="noopener noreferrer">
        <img src="${c.productId.images?.[0] || '/assets/images/noimage.png'}" 
             class="w-10 h-10 object-cover rounded-lg border" alt="">
      </a>
      <!-- اسم محصول بدون لینک -->
      <span class="text-xs text-gray-600">${c.productId.title}</span>
    </div>
  `;
}


    const last = c.messages?.[c.messages.length - 1] || {};
    const txt = (last.text || '-').slice(0, 45) + (last.text?.length > 45 ? '…' : '');
    const date = last.createdAt
      ? new Date(last.createdAt).toLocaleDateString('fa-IR', { year: '2-digit', month: '2-digit', day: '2-digit' })
      : '—';
    const unread = (c.messages || []).filter(m => !m.read && m.from !== 'user').length;

    let avatarText = '؟';
    if (whom && typeof whom === 'string') {
      avatarText = whom.slice(0, 2);
    }

return `
  <div class="chat-card flex items-start gap-3 p-3 mb-2 bg-[#f9fafb] rounded-xl shadow-sm hover:bg-[#e6fcf7] cursor-pointer transition ${isBlocked ? 'opacity-50' : ''}"
       data-chat-id="${c._id}">

    <!-- آواتار -->
    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#0ea5e9] to-[#10b981]
                flex items-center justify-center text-white font-bold text-lg shrink-0">
      ${avatarText}
    </div>

    <!-- بدنه -->
    <div class="flex-1 min-w-0">

      <!-- ❶ هِدِر کارت: اسم + نشان unread سمت راست، دکمه حذف سمت چپ  -->
      <div class="flex items-center justify-between flex-wrap gap-2">

        <!-- گروهِ اسم و نشان -->
        <div class="flex items-center gap-2">
          <span class="font-bold primary-text">${whomDisplay}</span>
          ${
            unread
              ? `<span class="inline-flex items-center justify-center
                         bg-red-500 text-white rounded-full w-5 h-5 text-xs">
                     ${unread}
                 </span>`
              : ""
          }
        </div>

        <!-- دکمه‌ها -->
        <div class="flex items-center gap-1">
          <button
            class="delete-chat px-2 py-0.5 text-xs rounded-xl bg-red-50 text-red-600 border border-red-100
                   hover:bg-red-200 hover:text-red-900 transition"
            data-chat-id="${c._id}">
            حذف
          </button>
          ${role === 'seller' && !isBlocked ? `<button class="block-seller px-2 py-0.5 text-xs rounded-xl bg-gray-100 text-gray-600 border border-gray-200 hover:bg-gray-200 transition" data-seller-id="${sellerId}">مسدودسازی فروشنده</button>` : ''}
          ${role === 'seller' && isBlocked ? `<span class="text-xs text-red-500">مسدود شده</span>` : ''}
        </div>
      </div>

      ${prodBlock}
      <div class="text-sm text-gray-700 mt-2">${txt}</div>
      <div class="text-xs text-gray-400 mt-1">${date}</div>
    </div>
  </div>
`;

  }).join('');

  // Add event listeners for chat cards and buttons
  setTimeout(() => {
    // Chat card click listeners
    document.querySelectorAll('.chat-card').forEach(card => {
      card.addEventListener('click', (e) => {
        // Don't open chat if clicking on buttons
        if (e.target.closest('.delete-chat') || e.target.closest('.block-seller')) {
          return;
        }
        const chatId = card.dataset.chatId;
        openChat(chatId);
      });
    });

    // Delete chat button listeners
    document.querySelectorAll('.delete-chat').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const chatId = btn.dataset.chatId;
        deleteChat(chatId);
      });
    });

    // Block seller button listeners
    document.querySelectorAll('.block-seller').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const sellerId = btn.dataset.sellerId;
        blockSeller(sellerId);
      });
    });
  }, 0);
}




  /* باز کردن مودال چت */
  /* باز کردن مودال چت (با دریافت جزئیات کامل) */
async function openChat(cid) {
  currentCid = cid;
  await showChatModal();
}

  /* ارسال پیام جدید به مدیر (ایجاد چت جدید اگر قبلا نداره) */
  // باز کردن مودال گفتگوی کاربر با مدیر (نسخه ساده)
async function openAdminMsgModal() {
  const uid = window.currentUserId;
  if (!uid) return alert('شناسه کاربر پیدا نشد!');

  // اول چت با admin رو ensure کن (اگر وجود نداشت، بساز)
  try {
    const res = await fetch(`${API_BASE}/chats/ensure`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recipientRole: 'admin' })  // بدون recipientId، چون admin پیش‌فرض
    });
    if (!res.ok) throw new Error('دریافت/ایجاد چت با مدیر ناموفق بود');
    const chat = await res.json();
    currentCid = chat._id;  // chatId رو ست کن
    showChatModal();        // مودال رو باز کن (که جزئیات رو لود می‌کنه)
  } catch (err) {
    alert('خطا: ' + err.message);
  }
}

  function closeAdminMsg() {
    document.getElementById('adminMsgModal')?.remove();
  }

  async function showAdminMsgModal(uid) {
    document.getElementById('adminMsgModal')?.remove();
    document.body.insertAdjacentHTML('beforeend', `
      <div id="adminMsgModal" class="fixed inset-0 z-50 flex items-center justify-center" style="backdrop-filter:blur(4px);background:#0003;animation:fadein .25s">
        <div class="bg-white rounded-2xl w-[98vw] max-w-md max-h-[93vh] flex flex-col shadow-xl border">
          <div class="px-4 py-3 border-b flex justify-between items-center">
            <span class="font-bold primary-text">گفتگو با مدیر سایت</span>
            <button class="close-admin-msg text-2xl font-black text-gray-400 hover:text-red-500 rounded-full w-8 h-8 flex items-center justify-center">×</button>
          </div>
          <div id="adminMsgBody" class="flex-1 overflow-y-auto p-4 space-y-4 text-[15px] scrollbar-hide bg-[#f9fafb]"></div>
          <div class="border-t p-3 flex gap-2 bg-white">
            <textarea id="adminMsgInput" rows="2" class="flex-1 border rounded-xl p-2 resize-none focus:outline-none" placeholder="پیام خود را وارد کنید"></textarea>
            <button class="send-admin-msg brand-btn px-5 py-2 rounded-xl font-bold shrink-0">ارسال</button>
          </div>
        </div>
      </div>
    `);

    // Add event listeners for admin modal buttons
    const closeBtn = document.querySelector('.close-admin-msg');
    if (closeBtn) {
      closeBtn.addEventListener('click', closeAdminMsg);
    }

    const sendBtn = document.querySelector('.send-admin-msg');
    if (sendBtn) {
      sendBtn.addEventListener('click', sendAdminMsg);
    }

    // Also allow sending message with Enter key
    const msgInput = document.getElementById('adminMsgInput');
    if (msgInput) {
      msgInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendAdminMsg();
        }
      });
    }

    renderAdminMsgs(uid);
  }

  async function renderAdminMsgs(uid) {
    const box = document.getElementById('adminMsgBody');
    if (!box) return;
    box.innerHTML = '<div class="text-center text-gray-400 py-6">در حال دریافت...</div>';
    try {
      const token = document.cookie.split('; ').find(r => r.startsWith('user_token='))?.split('=')[1];
      const res = await fetch(`${API_BASE}/messages/${uid}`, {
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { Authorization: 'Bearer ' + token })
        }
      });
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) throw new Error('دسترسی غیرمجاز');
        throw new Error('دریافت گفتگو ناموفق بود');
      }
      let data = await res.json();
      if (!Array.isArray(data)) data = [];
      data.sort((a,b)=> new Date(a.timestamp || a.createdAt) - new Date(b.timestamp || b.createdAt));
      box.innerHTML = data.map(m => {
        const rawRole =
          m.senderRole ||
          m.senderId?.role ||
          (typeof m.senderModel === 'string' ? m.senderModel.toLowerCase() : '') ||
          (typeof m.from === 'string' ? m.from.toLowerCase() : '');
        const role = (rawRole || '').toLowerCase();
        const isMe = m.senderId?._id === window.currentUserId || role === 'user';
        const label = isMe ? 'شما' : role === 'admin' ? 'مدیر سایت' : role === 'seller' ? 'فروشنده' : 'مشتری';
        const cls = isMe ? 'bg-[#e0fdfa] self-end' : 'bg-[#f3f4f6]';
        const time = new Date(m.timestamp || m.createdAt).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
        const align = isMe ? 'items-end' : 'items-start';
        const msgText = m.message || m.text || '';
        return `
          <div class="flex flex-col ${align}">
            <div class="${cls} rounded-xl px-3 py-2 max-w-[78%]">
              <span class="text-xs font-bold text-[#10b981]">${label}</span>
              <div>${msgText}</div>
              <div class="text-xs text-gray-400 mt-1 text-left">${time}</div>
            </div>
          </div>`;
      }).join('');
      box.scrollTop = box.scrollHeight;
    } catch (err) {
      box.innerHTML = '<div class="text-center text-red-500 py-6">امکان دریافت گفتگو وجود ندارد.</div>';
    }
  }

  async function sendAdminMsg() {
    const ta = document.getElementById('adminMsgInput');
    const text = ta.value.trim();
    if (!text) return;
    try {
      const token = document.cookie.split('; ').find(r => r.startsWith('user_token='))?.split('=')[1];
      const res = await fetch(`${API_BASE}/messages/send`, {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { Authorization: 'Bearer ' + token })
        },
        body: JSON.stringify({ message: text })
      });
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) throw new Error('دسترسی غیرمجاز');
        throw new Error('ارسال پیام ناموفق بود');
      }
      ta.value = '';
      renderAdminMsgs(window.currentUserId);
    } catch (err) {
      alert('خطا در ارسال پیام: ' + err.message);
    }
  }





  /* دریافت جزئیات کامل یک چت (شامل تمام پیام‌ها) */











  /* ساختار مودال چت */
/* ساختار مودال چت */
/* ساختار مودال چت */
/* ساختار مودال چت */
/* ساختار مودال چت */
/* ساختار مودال چت */
/* ساختار مودال چت */
async function ensureShopUrl(sid, existing) {
  if (existing) return existing;
  if (!sid) return '';
  try {
    const res = await fetch(`${API_BASE}/shopAppearance/${sid}`);
    if (!res.ok) return '';
    const data = await res.json();
    return data.customUrl || '';
  } catch {
    return '';
  }
}

/* ساختار مودال چت (async برای fetch جزئیات) */
async function showChatModal() {
  console.log("در حال نمایش مودال چت...");

  // دریافت جزئیات کامل چت از سرور
  const chat = await fetchChatDetails(currentCid);
  if (!chat) {
    alert('دریافت گفتگو ناموفق بود!');
    return;
  }

  // پس از دریافت، پیام‌های طرف مقابل را خوانده‌شده علامت بزن
  chat.messages.forEach(m => {
    if (m.from !== 'user') m.read = true;
  });

  console.log('messages:', chat.messages); // دیباگ

  // بروزرسانی لیست محلی
  const idx = chatsList.findIndex(c => c._id === currentCid);
  if (idx !== -1) chatsList[idx] = chat;
  updateBadge();

  console.log('ساختار چت کامل:', chat);

  // استخراج طرف مقابل
  let whom = 'مخاطب';
  let role = '';
  let sellerId = null;
  let storeName = '';
  let shopUrl = '';

  if (Array.isArray(chat.participants)) {
    const participant = chat.participants.find(p => p && p._id !== window.currentUserId);
    if (participant) {
      role = participant.role;
      sellerId = participant._id;
      storeName = participant.storename || '';
      shopUrl = participant.shopurl || '';
      whom = role === 'seller' ? 'فروشنده' : (role === 'admin' ? 'مدیر سایت' : (role === 'user' ? 'مشتری' : 'مخاطب'));
    }
  }

  if (!role && Array.isArray(chat.participantsModel)) {
    if (chat.participantsModel.includes('Admin')) {
      role = 'admin';
      whom = 'مدیر سایت';
    } else if (chat.participantsModel.includes('Seller')) {
      role = 'seller';
      whom = 'فروشنده';
    }
  }

  // fallback از type
  if (!role && chat.type) {
    if (chat.type === 'user-seller' || chat.type === 'seller-admin') {
      whom = 'فروشنده';
      role = 'seller';
      sellerId = chat.sellerId;
    } else if (chat.type === 'user-admin' || chat.type === 'admin-user' || chat.type === 'admin') {
      whom = 'مدیر سایت';
      role = 'admin';
    }
  }

  let whomDisplay = whom;
  let sellerLink = '';
  if (role === 'seller' && sellerId) {
    shopUrl = await ensureShopUrl(sellerId, shopUrl);
    const linkUrl = shopUrl ? `/shop.html?shopurl=${shopUrl}` : '';
    const linkText = storeName ? `مغازه ${storeName}` : `مغازه فروشنده`;
    sellerLink = linkUrl
      ? `<a href="${linkUrl}" target="_blank" rel="noopener noreferrer" class="text-[#0ea5e9] hover:text-blue-700 hover:underline ml-3 text-sm font-semibold">${linkText}</a>`
      : '';
  }

  let prodBlock = '';
  if (chat.productId && chat.productId.title) {
    const productUrl = `/product.html?id=${chat.productId._id}`;
    prodBlock = `
      <a href="${productUrl}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 bg-[#e0fdfa] px-2 py-1 rounded-lg my-2 hover:bg-[#d1f8f5] transition">
        <img src="${chat.productId.images?.[0] || '/assets/images/noimage.png'}" class="w-9 h-9 object-cover rounded-md border" alt="">
        <span class="text-xs text-gray-700">${chat.productId.title}</span>
      </a>
    `;
  }

  // مودال HTML
  // هنگام نمایش مودال، ناوبری پایین موبایل را پنهان می‌کنیم
  document.body.classList.add('hide-mobile-nav');
  document.body.insertAdjacentHTML('beforeend', `
    <div id="chatModal" class="fixed inset-0 z-50 flex items-center justify-center" style="backdrop-filter:blur(4px);background:#0003;animation:fadein .25s">
      <div class="bg-white rounded-2xl w-[98vw] max-w-md max-h-[93vh] flex flex-col shadow-xl border">
        <div class="px-4 py-3 border-b flex justify-between items-center gap-3">
          <div>
            <div class="flex items-center">
              <span class="font-bold primary-text">${whomDisplay}</span>
              ${sellerLink}
            </div>
            ${prodBlock}
          </div>
          <button class="close-chat-modal text-2xl font-black text-gray-400 hover:text-red-500 rounded-full w-8 h-8 flex items-center justify-center">×</button>
        </div>
        <div id="chatBody" class="flex-1 overflow-y-auto p-4 space-y-4 text-[15px] scrollbar-hide bg-[#f9fafb]"></div>
        <div class="border-t p-3 flex gap-2 bg-white">
          <textarea id="msgBox" rows="2" class="flex-1 border rounded-xl p-2 resize-none focus:outline-none" placeholder="پیام خود را وارد کنید"></textarea>
          <button class="send-msg brand-btn px-5 py-2 rounded-xl font-bold shrink-0">ارسال</button>
        </div>
      </div>
    </div>
  `);

  // Add event listeners for chat modal buttons
  const closeBtn = document.querySelector('.close-chat-modal');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeChat);
  }

  const sendBtn = document.querySelector('.send-msg');
  if (sendBtn) {
    sendBtn.addEventListener('click', sendMsg);
  }

  // Also allow sending message with Enter key
  const msgBox = document.getElementById('msgBox');
  if (msgBox) {
    msgBox.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMsg();
      }
    });
  }

  renderChat();
  setTimeout(() => document.getElementById('msgBox').focus(), 120);
}
  // بستن مودال چت
  function closeChat() {
    document.getElementById('chatModal')?.remove();
    document.body.classList.remove('hide-mobile-nav');
    currentCid = null;
  }

  async function fetchBlockedSellers() {
    try {
      const res = await fetch(`${API_BASE}/blocked-sellers`, { credentials: 'include' });
      const data = await res.json();
      blockedSellers = Array.isArray(data) ? data : [];
    } catch (e) {
      blockedSellers = [];
    }
  }

  async function blockSeller(sid) {
    if (!confirm('آیا مطمئن هستید که می‌خواهید این فروشنده را مسدود کنید؟')) return;
    try {
      const res = await fetch(`${API_BASE}/blocked-sellers/${sid}`, {
        method: 'POST',
        credentials: 'include'
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'خطا در مسدودسازی');
      if (!blockedSellers.includes(sid)) blockedSellers.push(sid);
      renderMessagesList();
    } catch (err) {
      alert('خطا در مسدودسازی: ' + err.message);
    }
  }

  /* رندر مکالمه داخل مودال */
/* رندر مکالمه داخل مودال */
function renderChat() {
  const chat = chatsList.find(c => c._id === currentCid);
  const target = document.getElementById('chatBody');
  if (!target) return;

  function getSenderRoleText(msg, isMe) {
    if (isMe) return 'شما';
    const raw =
      msg.senderRole ||
      msg?.sender?.role ||
      msg?.senderId?.role ||
      (typeof msg.senderModel === 'string' ? msg.senderModel.toLowerCase() : '') ||
      (typeof msg.from === 'string' ? msg.from.toLowerCase() : '');
    const role = (raw || '').toLowerCase();
    if (role === 'admin')  return 'مدیر سایت';
    if (role === 'seller') return 'فروشنده';
    if (role === 'user')   return 'مشتری';
    return 'مخاطب';
  }

  target.innerHTML = (chat.messages || []).map(m => {
    const roleHint = (m.senderRole || m?.senderId?.role || '').toLowerCase();
    const isMe =
      m.senderId?._id === window.currentUserId ||
      m.senderId === window.currentUserId ||
      roleHint === 'user' ||
      m.from === 'user' ||
      m.from === window.currentUserId;
    const cls = isMe ? 'bg-[#e0fdfa] self-end' : 'bg-[#f3f4f6]';
    const name = `<span class="text-xs font-bold text-[#10b981]">${getSenderRoleText(m, isMe)}</span>`;
    return `
      <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
        <div class="${cls} rounded-xl px-3 py-2 max-w-[78%]">
          ${name}
          <div>${m.text || ''}</div>
          <div class="text-xs text-gray-400 mt-1 text-left">${new Date(m.date || m.createdAt).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
      </div>
    `;
  }).join('');
  target.scrollTop = target.scrollHeight;
}



  /* ارسال پیام */
/**
 * ارسال پیام از طرف کاربر
 */
async function sendMsg() {
  const ta   = document.getElementById('msgBox');
  const text = ta.value.trim();
  if (!text) {
    alert('لطفاً متن پیام را وارد کنید');
    return;
  }

  // توکنِ کاربر (مشتری) را از کوکی خارج می‌کنیم
  const token = document.cookie
    .split('; ')
    .find(row => row.startsWith('user_token='))
    ?.split('=')[1];

  try {
    // به مسیر مخصوص reply کاربر بفرستیم
    const res = await fetch(`${API_BASE}/chats/${currentCid}/user-reply`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        ...(token && { Authorization: 'Bearer ' + token })
      },
      body: JSON.stringify({ text })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'خطا در ارسال پیام');

    // پس از موفقیت، textarea را پاک و لیست چت را به‌روز می‌کنیم
    ta.value = '';
    chatsList = chatsList.map(c => c._id === currentCid ? data : c);
    renderChat();
    updateBadge();

  } catch (err) {
    console.error('❌ sendMsg error:', err);
    alert('❌ خطا در ارسال پیام:\n' + err.message);
  }
}





async function deleteChat(cid) {
  if(!confirm('آیا از حذف این چت مطمئن هستید؟')) return;

  try {
    const res = await fetch(`${API_BASE}/chats/${cid}`, {
      method: 'DELETE',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'حذف چت ناموفق بود!');
    // حذف چت از لیست و رفرش
    chatsList = chatsList.filter(c => c._id !== cid);
    renderMessagesList();
    updateBadge();
    closeChat();
  } catch (err) {
    alert('خطا در حذف چت: ' + err.message);
  }
}




  /* badge پیام‌های خوانده نشده */
function getMessageTimestamp(message) {
  if (!message) return 0;
  const stamp = message.createdAt || message.sentAt || message.timestamp;
  if (stamp) {
    const date = new Date(stamp);
    const time = date.getTime();
    if (!Number.isNaN(time)) return time;
  }
  if (typeof message._id === 'string' && message._id.length >= 8) {
    const hex = message._id.slice(0, 8);
    const parsed = parseInt(hex, 16);
    if (!Number.isNaN(parsed)) return parsed * 1000;
  }
  return 0;
}

function updateBadge() {
  const lastViewed = getLastNotificationsViewedAt();
  const total = chatsList.reduce((count, chat) => {
    const messages = Array.isArray(chat.messages) ? chat.messages : [];
    const unread = messages.filter(m => {
      if (!m || m.from === 'user' || m.read) return false;
      const ts = getMessageTimestamp(m);
      if (ts === 0) return lastViewed === 0;
      return ts > lastViewed;
    });
    return count + unread.length;
  }, 0);

  const msgBadge = document.getElementById('msgBadge');
  if (msgBadge) {
    msgBadge.textContent = total > 0 ? total : '';
  }

  const hamBadge = document.getElementById('hamBadge');
  if (hamBadge) {
    if (total > 0) {
      hamBadge.textContent = total;
      hamBadge.classList.remove('hidden');
    } else {
      hamBadge.textContent = '';
      hamBadge.classList.add('hidden');
    }
  }
}

function markNotificationsViewed() {
  setLastNotificationsViewedNow();
  const msgBadge = document.getElementById('msgBadge');
  if (msgBadge) {
    msgBadge.textContent = '';
  }
  const hamBadge = document.getElementById('hamBadge');
  if (hamBadge) {
    hamBadge.textContent = '';
    hamBadge.classList.add('hidden');
  }
}


  /* بروزرسانی خودکار لیست و چت */
/* بروزرسانی خودکار لیست و چت */
function startMsgPolling(){
  if(pollHandle) clearInterval(pollHandle);
  pollHandle = setInterval(async()=>{
    await fetchUserChats();
    updateBadge();
    if(currentCid) {
      // اگر مودال باز است، جزئیات چت را دوباره fetch و رندر کن
      const chat = await fetchChatDetails(currentCid);
      if (chat) {
        const idx = chatsList.findIndex(c => c._id === currentCid);
        if (idx !== -1) chatsList[idx] = chat;
        renderChat();
      }
    } else {
      renderMessagesList();
    }
  },10000);
}
  function stopMsgPolling(){ if(pollHandle){clearInterval(pollHandle);pollHandle=null;} }
  /* ───────── پایان پیام‌های حرفه‌ای ───────── */








/* دریافت جزئیات کامل یک چت (شامل تمام پیام‌ها) */
/* دریافت جزئیات کامل یک چت (شامل تمام پیام‌ها) */
async function fetchChatDetails(cid) {
  const token = document.cookie.split('; ').find(row => row.startsWith('user_token='))?.split('=')[1];
  try {
    const res = await fetch(`${API_BASE}/chats/${cid}`, {
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        ...(token && { Authorization: 'Bearer ' + token })
      }
    });
    if (!res.ok) throw new Error('دریافت جزئیات چت ناموفق بود');
    const data = await res.json();
    return data;  // چت کامل با messages
  } catch (e) {
    console.error('❌ fetchChatDetails error:', e);
    return null;
  }
}

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      showSection('dashboard');
      updateSidebarUser();
      await loadMessages();
      await loadBookings();
    } catch (error) {
      console.error('Initialization error:', error);
    }
  });









  // --- داشبورد: کلیک باکس علاقه‌مندی و علاقه‌مندی‌های اخیر ---

  // ============= Notification System =============
  let notificationsData = [];
  let unreadCount = 0;

  // Toggle Notification Panel
  const notificationBtn = document.getElementById('notificationBtn');
  const notificationPanel = document.getElementById('notificationPanel');
  const closeNotificationPanel = document.getElementById('closeNotificationPanel');
  const notificationBadge = document.getElementById('notificationBadge');
  const notificationList = document.getElementById('notificationList');

  if (notificationBtn) {
    notificationBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleNotificationPanel();
    });
  }

  if (closeNotificationPanel) {
    closeNotificationPanel.addEventListener('click', (e) => {
      e.stopPropagation();
      hideNotificationPanel();
    });
  }

  // Close panel when clicking outside
  document.addEventListener('click', (e) => {
    if (notificationPanel && !notificationPanel.contains(e.target) &&
        !notificationBtn.contains(e.target)) {
      hideNotificationPanel();
    }
  });

  function toggleNotificationPanel() {
    if (notificationPanel.classList.contains('active')) {
      hideNotificationPanel();
    } else {
      showNotificationPanel();
    }
  }

  function showNotificationPanel() {
    notificationPanel.classList.add('active');
    loadNotifications();
  }

  function hideNotificationPanel() {
    notificationPanel.classList.remove('active');
  }

  // Fetch notifications from API
  async function loadNotifications() {
    const token = document.cookie.split('; ').find(row => row.startsWith('user_token='))?.split('=')[1];

    try {
      notificationList.innerHTML = `
        <div class="notification-loading">
          <div class="loading-spinner"></div>
          <p>در حال بارگذاری اعلان‌ها...</p>
        </div>
      `;

      const response = await fetch(`${API_BASE}/notifications`, {
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { Authorization: 'Bearer ' + token })
        }
      });

      // Gracefully handle unauthorized users so we don't spam the console
      if (response.status === 401) {
        notificationsData = [];
        notificationList.innerHTML = `
          <div class="notification-empty">
            <svg class="notification-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
            <p class="notification-empty-text">برای مشاهده اعلان‌ها ابتدا وارد شوید</p>
          </div>
        `;
        updateBadgeCount();
        return;
      }

      if (!response.ok) {
        throw new Error('Failed to fetch notifications');
      }

      notificationsData = await response.json();
      displayNotifications();
      updateBadgeCount();
    } catch (error) {
      console.error('Error loading notifications:', error);
      notificationList.innerHTML = `
        <div class="notification-empty">
          <svg class="notification-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
          <p class="notification-empty-text">خطا در بارگذاری اعلان‌ها</p>
        </div>
      `;
    }
  }

  // Display notifications in the panel
  function displayNotifications() {
    if (!notificationsData || notificationsData.length === 0) {
      notificationList.innerHTML = `
        <div class="notification-empty">
          <svg class="notification-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
          <p class="notification-empty-text">اعلانی وجود ندارد</p>
        </div>
      `;
      return;
    }

    const notificationsHTML = notificationsData.map(notification => {
      const timeAgo = getTimeAgo(new Date(notification.createdAt));
      const unreadClass = !notification.read ? 'unread' : '';

      return `
        <div class="notification-item ${unreadClass}" data-id="${notification._id}">
          <div class="notification-content">
            <div class="notification-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
              </svg>
            </div>
            <div class="notification-body">
              <p class="notification-message">${notification.message}</p>
              <div class="notification-time">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span>${timeAgo}</span>
              </div>
              <div class="notification-actions">
                ${!notification.read ? `
                  <button class="notification-action-btn notification-mark-read-btn" onclick="markNotificationAsRead('${notification._id}')">
                    خوانده شد
                  </button>
                ` : ''}
                <button class="notification-action-btn notification-delete-btn" onclick="deleteNotification('${notification._id}')">
                  حذف
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    notificationList.innerHTML = notificationsHTML;
  }

  // Update badge count
  function updateBadgeCount() {
    unreadCount = notificationsData.filter(n => !n.read).length;

    if (unreadCount > 0) {
      notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      notificationBadge.classList.remove('hidden');
    } else {
      notificationBadge.classList.add('hidden');
    }
  }

  // Mark notification as read
  window.markNotificationAsRead = async function(notificationId) {
    const token = document.cookie.split('; ').find(row => row.startsWith('user_token='))?.split('=')[1];

    try {
      const response = await fetch(`${API_BASE}/notifications/${notificationId}/read`, {
        method: 'PUT',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { Authorization: 'Bearer ' + token })
        }
      });

      if (!response.ok) {
        throw new Error('Failed to mark notification as read');
      }

      // Update local data
      const notification = notificationsData.find(n => n._id === notificationId);
      if (notification) {
        notification.read = true;
      }

      displayNotifications();
      updateBadgeCount();

      // Show success message
      showToast('اعلان به عنوان خوانده شده علامت‌گذاری شد', 'success');
    } catch (error) {
      console.error('Error marking notification as read:', error);
      showToast('خطا در علامت‌گذاری اعلان', 'error');
    }
  };

  // Delete notification
  window.deleteNotification = async function(notificationId) {
    const token = document.cookie.split('; ').find(row => row.startsWith('user_token='))?.split('=')[1];

    try {
      const response = await fetch(`${API_BASE}/notifications/${notificationId}`, {
        method: 'DELETE',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { Authorization: 'Bearer ' + token })
        }
      });

      if (!response.ok) {
        throw new Error('Failed to delete notification');
      }

      // Remove from local data
      notificationsData = notificationsData.filter(n => n._id !== notificationId);

      displayNotifications();
      updateBadgeCount();

      // Show success message
      showToast('اعلان با موفقیت حذف شد', 'success');
    } catch (error) {
      console.error('Error deleting notification:', error);
      showToast('خطا در حذف اعلان', 'error');
    }
  };

  // Helper function to show toast messages
  function showToast(message, type = 'info') {
    // You can implement a toast notification here
    console.log(`[${type.toUpperCase()}] ${message}`);
  }

  // Helper function to calculate time ago
  function getTimeAgo(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);

    if (diffInSeconds < 60) {
      return 'همین الان';
    } else if (diffInSeconds < 3600) {
      const minutes = Math.floor(diffInSeconds / 60);
      return `${minutes} دقیقه پیش`;
    } else if (diffInSeconds < 86400) {
      const hours = Math.floor(diffInSeconds / 3600);
      return `${hours} ساعت پیش`;
    } else if (diffInSeconds < 2592000) {
      const days = Math.floor(diffInSeconds / 86400);
      return `${days} روز پیش`;
    } else {
      const months = Math.floor(diffInSeconds / 2592000);
      return `${months} ماه پیش`;
    }
  }

  // Load notifications on page load and periodically refresh
  document.addEventListener('DOMContentLoaded', () => {
    // Initial load
    loadNotifications();

    // Refresh notifications every 30 seconds
    setInterval(() => {
      loadNotifications();
    }, 30000);
  });

  // ============= End Notification System =============

    </script>
  
<!-- TODO: افزودن رویدادهای PostHog پس از فعال‌سازی | TODO: Enable PostHog events after activation -->
<!--
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const safeCapture = window.safePosthogCapture || function () {};
    // ورود به داشبورد کاربری | User dashboard accessed
    // safeCapture('user_dashboard_accessed', { section: 'modern-dashboard' });
  });
</script>
-->

</body>
  </html>
