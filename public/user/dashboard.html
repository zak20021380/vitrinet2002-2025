  <!DOCTYPE html>
  <html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø± | ÙˆÛŒØªØ±ÛŒÙ†Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@800&display=swap" rel="stylesheet"/>
    <style>
      body { font-family:'Vazirmatn',sans-serif; background: linear-gradient(110deg,#e0f7fa 0%,#f9fafb 100%); min-height:100vh;}
      .glass { background:rgba(255,255,255,0.97); backdrop-filter: blur(14px); border-radius:1.6rem; box-shadow:0 7px 32px #10b9811a, 0 3px 11px #0ea5e91a;}
      .primary-text { color: #10b981; }
      .brand-btn {
        background: linear-gradient(91deg,#10b981 0%,#0ea5e9 85%);
        color: #fff !important;
        box-shadow: 0 2px 14px #10b98125;
        transition: all .16s;
      }
      .brand-btn:hover { filter:brightness(1.08);}
      .fadein { animation:fadein .8s;}
      @keyframes fadein { from{opacity:0; transform:translateY(32px);} to{opacity:1; transform:translateY(0);} }
      ::placeholder {color:#a0aec0;}
      .tab-active { color:#10b981 !important; font-weight:900; background: #e6fcf7; }
      .scrollbar-hide::-webkit-scrollbar {display:none;}
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none;}
      .avatar-bg { background:linear-gradient(120deg,#10b981 65%,#0ea5e9 100%); }
      .menu-btn { transition: background .16s; }
      .menu-btn.active { background: #e6fcf7; color: #10b981; }
      /* Ù‡Ù…Ø¨Ø±Ú¯Ø± */
      .ham {
        width: 2.3rem; height: 2.3rem; display: flex; align-items: center; justify-content: center;
        background: #10b9811a; border-radius: 50%; border: none; cursor: pointer;
        transition: background .2s;
      }
      .ham:hover { background: #0ea5e91a; }
      @media (max-width: 1023px) {
        .main-grid { grid-template-columns: 1fr !important; }
        .sidebar { display: none !important; }
      }
      @media (min-width: 1024px) {
        .mobile-sidebar,.sidebar-overlay { display: none !important;}
      }
      /* Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ù†Ùˆ */
      .sidebar-overlay {
        position:fixed; inset:0; background:rgba(0,0,0,0.18); z-index:50; display:none;
      }
      .sidebar-overlay.open {display:block; animation: fadein .25s;}
      .mobile-sidebar {
        position:fixed; top:0; right:0; height:100vh; width:85vw; max-width:350px;
        background:#fff; z-index:60;
        border-radius:1.6rem 0 0 1.6rem;
        box-shadow:-2px 0 34px #10b98123;
        padding:2.3rem 1.5rem 2.4rem 1.5rem;
        overflow-y:auto;
        transform:translateX(100%);
        transition: transform .25s cubic-bezier(.8,.2,.3,1.2);
      }
      .mobile-sidebar.open { transform:translateX(0);}
    </style>
  </head>
  <body class="text-gray-800 overflow-x-hidden">

    <!-- Header -->
    <header class="fixed top-0 inset-x-0 z-20 glass border-b shadow flex items-center justify-between px-6 py-3">
      <a href="index.html" class="flex items-center gap-2 select-none shrink-0">
        <img src="assets/images/logo.svg" alt="ÙˆÛŒØªØ±ÛŒÙ†Øª" class="w-9 h-9 sm:w-10 sm:h-10 hidden sm:block" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"/>
        <span class="font-extrabold text-lg md:text-2xl primary-text" style="display:none; font-family:'Poppins',sans-serif;">Vitrinet</span>
        <span class="font-extrabold text-lg md:text-2xl primary-text sm:hidden block" style="font-family:'Vazirmatn',sans-serif;">ÙˆÛŒØªØ±ÛŒÙ†Øª</span>
      </a>
      <nav class="flex items-center gap-4 text-base flex-shrink-0">
    <!-- Ù‡Ù…Ø¨Ø±Ú¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ + Ø¨ÙØ¬ -->
<button id="hamBtn"
        class="ham lg:hidden mr-1 relative"   
        title="Ù…Ù†Ùˆ">
  <!-- Ø¢ÛŒÚ©ÙˆÙ† Ø³Ù‡â€ŒØ®Ø· -->
  <svg width="24" height="24" fill="none" viewBox="0 0 24 24">
    <rect x="5" y="7" width="14" height="2" rx="1" fill="#10b981"/>
    <rect x="5" y="11" width="14" height="2" rx="1" fill="#10b981"/>
    <rect x="5" y="15" width="14" height="2" rx="1" fill="#10b981"/>
  </svg>

  <!-- ğŸ·ï¸   Ù†Ø´Ø§Ù† ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ø®Ø§Ù„ÛŒ Ùˆ Ù¾Ù†Ù‡Ø§Ù†) -->
  <span id="hamBadge"
        class="absolute -top-1.5 -left-1.5     
               bg-red-500 text-white text-[10px]
               w-4 h-4 rounded-full font-extrabold
               flex items-center justify-center
               hidden">0</span>
</button>

        <a href="index.html" class="text-gray-700 hover:text-[#10b981] font-bold">Ø®Ø§Ù†Ù‡</a>
        <button id="profileBtn" type="button" class="ml-2 flex items-center gap-2 px-3 py-1.5 rounded-2xl avatar-bg text-white font-bold text-base shadow-lg focus:outline-none hover:scale-105 transition-all" style="font-family:'Vazirmatn',sans-serif;">
          <span class="w-9 h-9 flex items-center justify-center rounded-full bg-white/10 text-2xl font-extrabold">Ú©â€ŒÙˆ</span>
          <span class="hidden sm:inline-block font-bold">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</span>
        </button>
      </nav>
    </header>

    <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <aside id="mobileSidebar" class="mobile-sidebar fadein">
      <button id="closeSidebar" class="absolute left-3 top-3 text-gray-400 hover:text-[#10b981] rounded-full p-1 transition" title="Ø¨Ø³ØªÙ†">
        <svg width="28" height="28" fill="none" viewBox="0 0 28 28"><circle cx="14" cy="14" r="14" fill="#f3f4f6"/><path d="M10.8 17.2l6.4-6.4M17.2 17.2l-6.4-6.4" stroke="#64748b" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
      <div class="w-20 h-20 rounded-full avatar-bg flex items-center justify-center text-white text-4xl font-extrabold mb-2 select-none shadow-lg mx-auto">
        VN
      </div>
  <div class="text-lg font-bold primary-text mt-2 mb-0.5 text-center sidebar-user-name">Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª</div>
  <div class="text-gray-400 text-sm mb-3 text-center sidebar-user-mobile" dir="ltr">0912***2345</div>

      <div class="flex flex-col gap-2 w-full mt-4 text-[15px]">
        <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition tab-active" data-section="dashboard"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#10b981"/><path d="M6 9l3 3 3-3" stroke="#fff" stroke-width="1.6"/></svg> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
        <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="profile"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#dbeafe"/><path d="M6 7a3 3 0 0 1 6 0c0 1.656-1.343 3-3 3s-3-1.344-3-3Zm6 6H6c0-1.656 2.343-3 3-3s3 1.344 3 3Z" fill="#3b82f6"/></svg> Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</button>
        <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="favorites"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fce7f3"/><path d="M6.5 8A2.5 2.5 0 0 1 9 5.5 2.5 2.5 0 0 1 11.5 8C11.5 9.33 9 12 9 12S6.5 9.33 6.5 8Z" fill="#ec4899"/></svg> Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</button>

  <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
  <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition"
          data-section="messages">
    <svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fef2f2"/><path d="M6 6h6v6H6z" fill="#ef4444"/></svg>
    Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    <span id="msgBadge" class="ml-1 text-xs font-extrabold text-red-500"></span>
  </button>

        
      </div>
  
    </aside>

    <main class="max-w-6xl mx-auto mt-32 mb-14 px-2 sm:px-4">
      <div class="grid main-grid grid-cols-3 gap-7">
        <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¯Ø³Ú©ØªØ§Ù¾ -->
        <aside class="glass sidebar flex-col items-center py-7 px-4 sm:px-8 mb-3 fadein hidden lg:flex">
          <div class="w-20 h-20 rounded-full avatar-bg flex items-center justify-center text-white text-4xl font-extrabold mb-2 select-none shadow-lg">
            VN
          </div>
        <div class="text-lg font-bold primary-text mt-2 mb-0.5 text-center sidebar-user-name">Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª</div>
  <div class="text-gray-400 text-sm mb-3 text-center sidebar-user-mobile" dir="ltr">0912***2345</div>

          <div class="flex flex-col gap-2 w-full mt-4 text-[15px]">
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition tab-active" data-section="dashboard"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#10b981"/><path d="M6 9l3 3 3-3" stroke="#fff" stroke-width="1.6"/></svg> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="profile"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#dbeafe"/><path d="M6 7a3 3 0 0 1 6 0c0 1.656-1.343 3-3 3s-3-1.344-3-3Zm6 6H6c0-1.656 2.343-3 3-3s3 1.344 3 3Z" fill="#3b82f6"/></svg> Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="favorites"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fce7f3"/><path d="M6.5 8A2.5 2.5 0 0 1 9 5.5 2.5 2.5 0 0 1 11.5 8C11.5 9.33 9 12 9 12S6.5 9.33 6.5 8Z" fill="#ec4899"/></svg> Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</button>
            
  <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
  <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition"
          data-section="messages">
    <svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fef2f2"/><path d="M6 6h6v6H6z" fill="#ef4444"/></svg>
    Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    <span id="msgBadge" class="ml-1 text-xs font-extrabold text-red-500"></span>
  </button>




          </div>
        
        </aside>
        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø³Ù…Øª Ú†Ù¾ -->
        <section id="mainContent" class="col-span-2 flex flex-col gap-7 fadein">
          <!-- Ø§ÛŒÙ†Ø¬Ø§ Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ù„ÙˆØ¯ Ù…ÛŒØ´Ù‡ -->
        </section>
      </div>
    </main>
    <footer class="mt-14 bg-white border-t text-center text-xs sm:text-sm text-gray-400 py-5 rounded-t-3xl">
      Â© 2025 <span class="text-[#10b981] font-bold">Vitrinet</span> - Ù‡Ù…Ù‡ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.
    </footer>
    <script>

      let pollHandle = null; 
      // Ø¯Ø§Ø¯Ù‡â€ŒÛŒ Ø¯Ù…ÙˆÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
  async function loadProfileSection() {
    let html = `
      <div class="glass px-6 py-7 fadein">
        <div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</div>
      </div>`;
    document.getElementById('mainContent').innerHTML = html;

    try {
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',          // Ú©ÙˆÚ©ÛŒ JWT
        headers: { 'Content-Type': 'application/json' }
      });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403)
          throw new Error('Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.');
        throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯!');
      }

      const user  = await res.json();
      const phone = user.phone || user.mobile || '';   // âœ³ï¸ ÙÛŒÚ©Ø³: ÙÛŒÙ„Ø¯ mobile Ù‡Ù… Ù¾ÙˆØ´Ø´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯
      const masked =
        phone ? phone.toString().slice(0, 4) + '***' + phone.toString().slice(-3) : '-';

      html = `
        <div class="glass px-6 py-7 fadein">
          <div class="flex flex-col sm:flex-row items-center gap-5 sm:gap-12 mb-6">
            <div class="w-24 h-24 rounded-full avatar-bg flex items-center justify-center text-white text-5xl font-extrabold shadow-xl">
              VN
            </div>
            <div>
              <div class="text-xl font-black primary-text mb-2">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-1 gap-x-7 text-[16px]">
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ù†Ø§Ù…:</span>
                  <span class="font-bold text-gray-800">${user.firstname || '-'}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</span>
                  <span class="font-bold text-gray-800">${user.lastname || '-'}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ø´Ù‡Ø±:</span>
                  <span class="font-bold text-gray-800">${user.city || '-'}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</span>
                  <span class="font-bold text-gray-800" dir="ltr">${masked}</span>
                </div>
              </div>
            </div>
          </div>
        </div>`;
    } catch (e) {
      html = `
        <div class="glass px-6 py-7 fadein">
          <div class="text-center text-red-400 py-12">
            Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø¨ØªØ¯Ø§
            <a href="/login.html"
              class="inline-block px-3 py-1.5 mx-1 rounded-xl brand-btn text-white font-bold text-base transition hover:scale-105"
              style="text-decoration:none;">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a>
            .
          </div>
        </div>`;
    }

    document.getElementById('mainContent').innerHTML = html;
  }








      // Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
  const dashboardSection = `
  <div class="glass flex flex-col md:flex-row items-center justify-between px-5 md:px-8 py-5 md:py-7 fadein gap-3 md:gap-0">
    <div>
      <div class="text-xl md:text-2xl font-black primary-text mb-1">ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ Ú©Ø§Ø±Ø¨Ø± Ø¹Ø²ÛŒØ²!</div>
      <div class="text-gray-500 text-sm md:text-base">Ø§Ù…ÛŒØ¯ÙˆØ§Ø±ÛŒÙ… ØªØ¬Ø±Ø¨Ù‡â€ŒÛŒ Ø®ÙˆØ¨ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.</div>
    </div>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-5 fadein">
    <div id="favBoxClick" class="glass p-6 flex flex-col items-center text-center min-h-[135px] justify-center cursor-pointer hover:shadow-lg transition">
      <div class="text-[#0ea5e9] font-bold text-base mb-1">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</div>
      <div class="text-4xl font-black primary-text mb-1" id="favCountDashboard">-</div>
    <a href="#" class="text-xs font-bold text-[#0ea5e9] hover:underline menu-btn mt-2" data-section="favorites">Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª</a>
    </div>
    <div id="recentFavsContainerWrapper" class="flex flex-col">
      <div id="recentFavsContainer"></div>
    </div>
  </div>
  `;





  async function renderRecentFavorites() {
    const container = document.getElementById('recentFavsContainer');
    container.innerHTML = `
      <div class="glass px-6 py-5 fadein">
        <div class="flex items-center justify-between mb-4">
          <span id="recentFavsTitle" class="text-lg font-bold primary-text cursor-pointer">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± Ø´Ù…Ø§</span>
          <a href="#" id="recentFavsShowAll" class="text-[#0ea5e9] hover:underline font-bold text-sm menu-btn">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡</a>
        </div>
        <div class="flex flex-wrap gap-3 scrollbar-hide overflow-x-auto" id="recentFavsList">
          <div class="text-gray-400 text-center w-full py-3">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ...</div>
        </div>
      </div>
    `;

    try {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ú©ÙˆÚ©ÛŒ Ùˆ Ø¨Ø¯ÙˆÙ† Ù‡Ø¯Ø± Authorization
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include', // Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ (ØªÙˆÚ©Ù†) Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!res.ok) throw new Error();

      const user = await res.json();
      const favs = Array.isArray(user.favorites) ? user.favorites : [];

      const favsList = container.querySelector("#recentFavsList");
      if (favs.length === 0) {
        favsList.innerHTML = `<div class="text-gray-400 text-center w-full py-3">Ù‡Ù†ÙˆØ² Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯ÛŒ!</div>`;
      } else {
        favsList.innerHTML = favs.slice(-3).reverse().map(p => {
          const shop = (p.sellerId && typeof p.sellerId === 'object') ? p.sellerId : {};
          return `
            <div class="min-w-[170px] max-w-xs bg-[#e0fdfa] rounded-xl p-3 flex flex-col items-center text-center">
              <img src="${(p.images && p.images[0]) ? p.images[0] : '/assets/images/noimage.png'}" class="w-20 h-20 object-cover rounded-xl mb-2 shadow" alt="${p.title || ''}"/>
              <span class="text-[#10b981] text-base font-bold mb-1">${p.title || '-'}</span>
              <span class="text-xs text-gray-500 mb-1">${shop.storename ? `ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ${shop.storename}` : ''}</span>
              <span class="text-xs text-gray-600 mb-1">Ù‚ÛŒÙ…Øª: ${p.price ? p.price.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†' : '-'}</span>
              <a href="http://localhost:5000/product.html?id=${p._id}" class="mt-2 px-4 py-1.5 rounded-lg brand-btn text-xs font-bold inline-block" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø­ØµÙˆÙ„</a>
            </div>
          `;
        }).join('');
      }
    } catch (e) {
      const favsList = container.querySelector("#recentFavsList");
      favsList.innerHTML = `<div class="text-red-400 text-center w-full py-3">Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.</div>`;
    }
  }






      // Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† SPA Ùˆ Ø±Ø³Ù¾Ø§Ù†Ø³ÛŒÙˆ
  function showSection(section) {
    const mainContent = document.getElementById('mainContent');
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ù…Ù†ÙˆÙ‡Ø§
    document.querySelectorAll('.menu-btn').forEach(btn=>btn.classList.remove('tab-active'));
    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù…Ù†ÙˆÛŒ ÙØ¹Ù„ÛŒ
  document.querySelectorAll(`.menu-btn[data-section="${section}"]`).forEach(btn => btn.classList.add('tab-active'));
    // Ù…Ø­ØªÙˆØ§
    if(section === 'dashboard') {
      mainContent.innerHTML = dashboardSection;
      renderRecentFavorites(); // Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù†Ø¯Ø± Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø±Ùˆ ØµØ¯Ø§ Ø¨Ø²Ù†
      updateDashboardFavCount(); // Ø§ÛŒÙ†Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† ØªØ§ ØªØ¹Ø¯Ø§Ø¯ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ø¯Ø±Ø³Øª Ø¨Ø´Ù‡
    }
    else if(section === 'profile') loadProfileSection();
    else if(section === 'favorites') loadFavoritesSection();
    else if(section === 'messages') loadMessagesSection();

    if(section === 'messages') startMsgPolling(); else stopMsgPolling();

    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¨Ø§Ù„Ø§
    mainContent.scrollIntoView({behavior:'smooth',block:'start'});
  }


  async function updateDashboardFavCount() {
    try {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ú©ÙˆÚ©ÛŒ (credentials: 'include')
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      if (!res.ok) {
        document.getElementById('favCountDashboard').textContent = '-';
        return;
      }
      const user = await res.json();
      document.getElementById('favCountDashboard').textContent =
        Array.isArray(user.favorites) ? user.favorites.length : '0';
    } catch (e) {
      document.getElementById('favCountDashboard').textContent = '-';
    }
  }


      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
      showSection('dashboard');
      updateSidebarUser(); 

      // --------   Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒÙ Ù†Ø´Ø§Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ   --------
(async () => {
  await fetchUserChats();  // ÙÙ‚Ø· Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
  updateBadge();           // Ø¹Ø¯Ø¯ Ø±Ø§ Ø±ÙˆÛŒ Ù‡Ù…Ø¨Ø±Ú¯Ø± Ùˆ Ù…Ù†Ùˆ Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ø¯
})();


      // Ù…Ù†ÙˆÙ‡Ø§ÛŒ Ø¯Ø³Ú©ØªØ§Ù¾ Ùˆ Ù…ÙˆØ¨Ø§ÛŒÙ„

  /* â€”â€”â€” Ù‡Ù†Ø¯Ù„ Ù…Ù†ÙˆÙ‡Ø§ÛŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± (Ù…Ø³ØªÙ‚ÛŒÙ…) â€”â€”â€” */
  document.querySelectorAll('.menu-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      e.preventDefault();
      showSection(btn.dataset.section);
      if (window.innerWidth < 1024) closeSidebar();
    });
  });




      // Ø³ÙˆÛŒÛŒÚ† Ú©Ø±Ø¯Ù† Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
      document.getElementById('profileBtn').onclick=function(){
        showSection('profile');
        if(window.innerWidth<1024){
          openSidebar();
        }
      };

      // Ù‡Ù…Ø¨Ø±Ú¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
      function openSidebar(){
        document.getElementById('mobileSidebar').classList.add('open');
        document.getElementById('sidebarOverlay').classList.add('open');
        document.body.style.overflow='hidden';
      }
      function closeSidebar(){
        document.getElementById('mobileSidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('open');
        document.body.style.overflow='';
      }
      document.getElementById('hamBtn').onclick = openSidebar;
      document.getElementById('closeSidebar').onclick = closeSidebar;
      document.getElementById('sidebarOverlay').onclick = closeSidebar;
      document.addEventListener('keydown', function(e){
        if(e.key === "Escape"){
          closeSidebar();
        }
      });





  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± (Ù…ÙˆØ¨Ø§ÛŒÙ„ + Ø¯Ø³Ú©ØªØ§Ù¾)
  async function updateSidebarUser() {
    try {
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',          // Ø§Ø±Ø³Ø§Ù„ ØªÙˆÚ©Ù† Ø§Ø² Ø·Ø±ÛŒÙ‚ Ú©ÙˆÚ©ÛŒ
        headers: { 'Content-Type': 'application/json' }
      });
      if (!res.ok) throw new Error();

      const user   = await res.json();

      /* â†™ï¸ Ø¢ÛŒâ€ŒØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ú†Øªâ€ŒÙ‡Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ… */
      window.currentUserId = user._id;     

      const first  = user.firstname || user.firstName || 'Ú©Ø§Ø±Ø¨Ø±';
      const last   = user.lastname  || user.lastName  || 'ÙˆÛŒØªØ±ÛŒÙ†Øª';
      const phone  = user.phone     || user.mobile    || '';
      const masked = phone
        ? phone.toString().slice(0, 4) + '***' + phone.toString().slice(-3)
        : '---';

      document.querySelectorAll('.sidebar-user-name')
              .forEach(el => (el.textContent = `${first} ${last}`));

      document.querySelectorAll('.sidebar-user-mobile')
              .forEach(el => (el.textContent = masked));
    } catch (_) {
      /* Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¨ÙˆØ¯ØŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø±Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø±Ù‡Ø§ Ú©Ù† */
    }
  }








  async function loadFavoritesSection() {
    let html = `<div class="glass px-6 py-7 fadein"><div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div></div>`;
    document.getElementById('mainContent').innerHTML = html;

    try {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ú©ÙˆÚ©ÛŒ (credentials: 'include')
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include', // Ù…Ù‡Ù…!
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });

      if (!res.ok) throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
      const user = await res.json();
      const favs = user.favorites;

      if (!Array.isArray(favs) || favs.length === 0) {
        html = `<div class="glass px-6 py-7 fadein text-center text-gray-400">Ù‡ÛŒÚ† Ù…Ø­ØµÙˆÙ„ÛŒ Ø¯Ø± Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ù†ÛŒØ³Øª.</div>`;
      } else {
        html = `
        <div class="glass px-6 py-7 fadein">
          <div class="text-xl font-black primary-text mb-5">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</div>
          <div class="flex flex-wrap gap-4">
            ${favs.map(p => {
              const shop = (p.sellerId && typeof p.sellerId === 'object') ? p.sellerId : {};
              return `
                <div class="min-w-[170px] max-w-xs bg-[#e0fdfa] rounded-xl p-3 flex flex-col items-center text-center">
                  <img src="${(p.images && p.images[0]) ? p.images[0] : '/assets/images/noimage.png'}" class="w-24 h-24 object-cover rounded-xl mb-2 shadow" alt="${p.title || ''}"/>
                  <span class="text-[#10b981] text-lg font-bold mb-1">${p.title || '-'}</span>
                  <span class="text-xs text-gray-500 mb-1">${shop.storename ? `ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ${shop.storename}` : ''}</span>
                  <span class="text-xs text-gray-600 mb-1">Ù‚ÛŒÙ…Øª: ${p.price ? p.price.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†' : '-'}</span>
                  <a href="http://localhost:5000/product.html?id=${p._id}" class="mt-2 px-4 py-1.5 rounded-lg brand-btn text-xs font-bold inline-block" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø­ØµÙˆÙ„</a>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        `;
      }
    } catch (e) {
      html = `<div class="glass px-6 py-7 fadein text-center text-red-400">${e.message}</div>`;
    }

    document.getElementById('mainContent').innerHTML = html;
  }




  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€  Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±  â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ø¨Ø®Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ú©Ø§Ø±Ø¨Ø± â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const API_BASE  = '/api';           // Ø·Ø¨Ù‚ Ø³Ø±ÙˆØ±Øª
  let chatsList   = [];               // Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§
  let currentCid  = null;             // Ø¢ÛŒâ€ŒØ¯ÛŒ Ú†Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡

async function loadMessagesSection() {
  const box = document.getElementById('mainContent');
  box.innerHTML = `
    <div class="glass px-4 py-7 fadein">
      <div class="flex items-center justify-between mb-4">
        <span class="text-xl font-black primary-text">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ù†</span>
        <button class="brand-btn text-sm px-3 py-1.5 rounded-xl" onclick="openAdminMsgModal()">Ú†Øª Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª</button>
      </div>
      <div id="userChatsList" class="w-full min-h-[180px]"></div>
    </div>
  `;
  await fetchUserChats();  // Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ Ø±Ùˆ Ø¨Ú¯ÛŒØ±
  renderMessagesList();    // Ø±Ù†Ø¯Ø± Ú©Ù†
  startMsgPolling();       // polling Ø´Ø±ÙˆØ¹ Ú©Ù†
}

  /* Ú¯Ø±ÙØªÙ† Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ */
  /*  Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ÛŒ *Ø®ÙˆØ¯Ù Ú©Ø§Ø±Ø¨Ø±*  */
/* Ú¯Ø±ÙØªÙ† Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (ÙÙ‚Ø· Ù„ÛŒØ³ØªØŒ Ø¨Ø¯ÙˆÙ† Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */
async function fetchUserChats() {
  try {
    const res = await fetch(`${API_BASE}/chats/my`, {
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();

    const allChats = Array.isArray(data) ? data : (data.chats || []);
    const uid = window.currentUserId;

    chatsList = allChats.filter(c => {
      if (!uid) return false;
      if (c.type === 'admin' || c.type === 'user-admin') return true;
      if (c.userId && c.userId === uid) return true;
      if (Array.isArray(c.participants) && c.participants.some(p => {
        if (!p) return false;
        return (typeof p === 'string' && p === uid) ||
               (typeof p === 'object' && p._id === uid);
      })) return true;
      if (Array.isArray(c.users) && c.users.some(u => u._id === uid)) return true;
      return false;
    });


  } catch (e) {
    chatsList = [];
  }
}


  /* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
function renderMessagesList() {
  const box = document.getElementById('userChatsList');
  console.log("Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§:", chatsList);

  if (!chatsList.length) {
    box.innerHTML = `<div class="text-gray-400 text-center py-8">Ù‡ÛŒÚ† Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒ! Ø§Ø² Ø¯Ú©Ù…Ù‡ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.</div>`;
    return;
  }

  // Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ
  const myId = window.currentUserId;

  box.innerHTML = chatsList.map(c => {
    console.log('Ø³Ø§Ø®ØªØ§Ø± Ú†Øª Ø¯Ø± Ù„ÛŒØ³Øª:', c._id, c);

    let whom = 'Ù…Ø®Ø§Ø·Ø¨'; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    let role = '';
    let sellerId = null;
    let storeName = '';
    let shopUrl = '';

    if (Array.isArray(c.participants)) {
      const participant = c.participants.find(p => p && p._id !== myId);
      if (participant) {
        role = participant.role;
        sellerId = participant._id;
        storeName = participant.storename || '';
        shopUrl = participant.shopurl || '';
        whom = role === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : (role === 'admin' ? 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª' : (role === 'user' ? 'Ú©Ø§Ø±Ø¨Ø±' : 'Ù…Ø®Ø§Ø·Ø¨'));
      }
    }

    // fallback Ø§Ø² type
    if (!role && c.type) {
      if (c.type === 'user-seller' || c.type === 'seller-admin') {
        whom = 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
        role = 'seller';
        sellerId = c.sellerId;
      } else if (c.type === 'user-admin') {
        whom = 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
        role = 'admin';
      }
    }

    let whomDisplay = whom;
    if (role === 'seller' && sellerId) {
      const linkUrl = shopUrl ? `/store/${shopUrl}` : `/store.html?id=${sellerId}`;
      const linkText = storeName ? `ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (${storeName})` : 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
      whomDisplay = `<a href="${linkUrl}" class="text-[#10b981] hover:text-blue-700 hover:underline font-semibold" target="_blank">${linkText}</a>`;
    }

let prodBlock = '';
if (c.productId && c.productId.title) {
  const productUrl = `/product.html?id=${c.productId._id}`;
  prodBlock = `
    <div class="flex items-center gap-2 mt-2">
      <!-- ÙÙ‚Ø· Ø¹Ú©Ø³ Ù„ÛŒÙ†Ú©â€ŒØ¯Ø§Ø± -->
      <a href="${productUrl}" target="_blank">
        <img src="${c.productId.images?.[0] || '/assets/images/noimage.png'}" 
             class="w-10 h-10 object-cover rounded-lg border" alt="">
      </a>
      <!-- Ø§Ø³Ù… Ù…Ø­ØµÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ù„ÛŒÙ†Ú© -->
      <span class="text-xs text-gray-600">${c.productId.title}</span>
    </div>
  `;
}


    const last = c.messages?.[c.messages.length - 1] || {};
    const txt = (last.text || '-').slice(0, 45) + (last.text?.length > 45 ? 'â€¦' : '');
    const date = last.createdAt
      ? new Date(last.createdAt).toLocaleDateString('fa-IR', { year: '2-digit', month: '2-digit', day: '2-digit' })
      : 'â€”';
    const unread = (c.messages || []).filter(m => !m.read && m.from !== 'user').length;

    let avatarText = 'ØŸ';
    if (whom && typeof whom === 'string') {
      avatarText = whom.slice(0, 2);
    }

return `
  <div class="flex items-start gap-3 p-3 mb-2 bg-[#f9fafb] rounded-xl shadow-sm hover:bg-[#e6fcf7] cursor-pointer transition"
       onclick="openChat('${c._id}')">

    <!-- Ø¢ÙˆØ§ØªØ§Ø± -->
    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#0ea5e9] to-[#10b981]
                flex items-center justify-center text-white font-bold text-lg shrink-0">
      ${avatarText}
    </div>

    <!-- Ø¨Ø¯Ù†Ù‡ -->
    <div class="flex-1 min-w-0">

      <!-- â¶ Ù‡ÙØ¯ÙØ± Ú©Ø§Ø±Øª: Ø§Ø³Ù… + Ù†Ø´Ø§Ù† unread Ø³Ù…Øª Ø±Ø§Ø³ØªØŒ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ø³Ù…Øª Ú†Ù¾  -->
      <div class="flex items-center justify-between flex-wrap gap-2">

        <!-- Ú¯Ø±ÙˆÙ‡Ù Ø§Ø³Ù… Ùˆ Ù†Ø´Ø§Ù† -->
        <div class="flex items-center gap-2">
          <span class="font-bold primary-text">${whomDisplay}</span>
          ${
            unread
              ? `<span class="inline-flex items-center justify-center
                         bg-red-500 text-white rounded-full w-5 h-5 text-xs">
                     ${unread}
                 </span>`
              : ""
          }
        </div>

        <!-- Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù -->
        <button
          class="px-2 py-0.5 text-xs rounded-xl bg-red-50 text-red-600 border border-red-100
                 hover:bg-red-200 hover:text-red-900 transition"
          onclick="event.stopPropagation(); deleteChat('${c._id}')">
          Ø­Ø°Ù
        </button>
      </div>

      ${prodBlock}
      <div class="text-sm text-gray-700 mt-2">${txt}</div>
      <div class="text-xs text-gray-400 mt-1">${date}</div>
    </div>
  </div>
`;

  }).join('');
}




  /* Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
  /* Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ú†Øª (Ø¨Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„) */
async function openChat(cid) {
  currentCid = cid;
  await showChatModal();
}

  /* Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù…Ø¯ÛŒØ± (Ø§ÛŒØ¬Ø§Ø¯ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§ Ù†Ø¯Ø§Ø±Ù‡) */
  // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ú¯ÙØªÚ¯ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…Ø¯ÛŒØ± (Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡)
async function openAdminMsgModal() {
  const uid = window.currentUserId;
  if (!uid) return alert('Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!');

  // Ø§ÙˆÙ„ Ú†Øª Ø¨Ø§ admin Ø±Ùˆ ensure Ú©Ù† (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Ø¨Ø³Ø§Ø²)
  try {
    const res = await fetch(`${API_BASE}/chats/ensure`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recipientRole: 'admin' })  // Ø¨Ø¯ÙˆÙ† recipientIdØŒ Ú†ÙˆÙ† admin Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    });
    if (!res.ok) throw new Error('Ø¯Ø±ÛŒØ§ÙØª/Ø§ÛŒØ¬Ø§Ø¯ Ú†Øª Ø¨Ø§ Ù…Ø¯ÛŒØ± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
    const chat = await res.json();
    currentCid = chat._id;  // chatId Ø±Ùˆ Ø³Øª Ú©Ù†
    showChatModal();        // Ù…ÙˆØ¯Ø§Ù„ Ø±Ùˆ Ø¨Ø§Ø² Ú©Ù† (Ú©Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ùˆ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù‡)
  } catch (err) {
    alert('Ø®Ø·Ø§: ' + err.message);
  }
}

  function closeAdminMsg() {
    document.getElementById('adminMsgModal')?.remove();
  }

  async function showAdminMsgModal(uid) {
    document.getElementById('adminMsgModal')?.remove();
    document.body.insertAdjacentHTML('beforeend', `
      <div id="adminMsgModal" class="fixed inset-0 z-50 flex items-center justify-center" style="backdrop-filter:blur(4px);background:#0003;animation:fadein .25s">
        <div class="bg-white rounded-2xl w-[98vw] max-w-md max-h-[93vh] flex flex-col shadow-xl border">
          <div class="px-4 py-3 border-b flex justify-between items-center">
            <span class="font-bold primary-text">Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª</span>
            <button onclick="closeAdminMsg()" class="text-2xl font-black text-gray-400 hover:text-red-500 rounded-full w-8 h-8 flex items-center justify-center">Ã—</button>
          </div>
          <div id="adminMsgBody" class="flex-1 overflow-y-auto p-4 space-y-4 text-[15px] scrollbar-hide bg-[#f9fafb]"></div>
          <div class="border-t p-3 flex gap-2 bg-white">
            <textarea id="adminMsgInput" rows="2" class="flex-1 border rounded-xl p-2 resize-none focus:outline-none" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"></textarea>
            <button onclick="sendAdminMsg()" class="brand-btn px-5 py-2 rounded-xl font-bold shrink-0">Ø§Ø±Ø³Ø§Ù„</button>
          </div>
        </div>
      </div>
    `);
    renderAdminMsgs(uid);
  }

  async function renderAdminMsgs(uid) {
    const box = document.getElementById('adminMsgBody');
    if (!box) return;
    box.innerHTML = '<div class="text-center text-gray-400 py-6">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div>';
    try {
      const token = document.cookie.split('; ').find(r => r.startsWith('user_token='))?.split('=')[1];
      const res = await fetch(`${API_BASE}/messages/${uid}`, {
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { Authorization: 'Bearer ' + token })
        }
      });
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) throw new Error('Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²');
        throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙØªÚ¯Ùˆ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
      }
      let data = await res.json();
      if (!Array.isArray(data)) data = [];
      data.sort((a,b)=> new Date(a.timestamp || a.createdAt) - new Date(b.timestamp || b.createdAt));
      box.innerHTML = data.map(m => {
        const role = m.senderRole || m.senderId?.role || (m.senderModel === 'Admin' ? 'admin' : 'user');
        const isMe = role === 'user';
        const label = isMe ? 'Ø´Ù…Ø§' : 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
        const cls = isMe ? 'bg-[#e0fdfa] self-end' : 'bg-[#f3f4f6]';
        const time = new Date(m.timestamp || m.createdAt).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
        const align = isMe ? 'items-end' : 'items-start';
        const msgText = m.message || m.text || '';
        return `
          <div class="flex flex-col ${align}">
            <div class="${cls} rounded-xl px-3 py-2 max-w-[78%]">
              <span class="text-xs font-bold text-[#10b981]">${label}</span>
              <div>${msgText}</div>
              <div class="text-xs text-gray-400 mt-1 text-left">${time}</div>
            </div>
          </div>`;
      }).join('');
      box.scrollTop = box.scrollHeight;
    } catch (err) {
      box.innerHTML = '<div class="text-center text-red-500 py-6">Ø§Ù…Ú©Ø§Ù† Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙØªÚ¯Ùˆ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>';
    }
  }

  async function sendAdminMsg() {
    const ta = document.getElementById('adminMsgInput');
    const text = ta.value.trim();
    if (!text) return;
    try {
      const token = document.cookie.split('; ').find(r => r.startsWith('user_token='))?.split('=')[1];
      const res = await fetch(`${API_BASE}/messages/send`, {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { Authorization: 'Bearer ' + token })
        },
        body: JSON.stringify({ message: text })
      });
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) throw new Error('Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²');
        throw new Error('Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
      }
      ta.value = '';
      renderAdminMsgs(window.currentUserId);
    } catch (err) {
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: ' + err.message);
    }
  }





  /* Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ ÛŒÚ© Ú†Øª (Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */











  /* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª (async Ø¨Ø±Ø§ÛŒ fetch Ø¬Ø²Ø¦ÛŒØ§Øª) */
async function showChatModal() {
  console.log("Ø¯Ø± Ø­Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ú†Øª...");

  // Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ Ú†Øª Ø§Ø² Ø³Ø±ÙˆØ±
  const chat = await fetchChatDetails(currentCid);
  if (!chat) {
    alert('Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙØªÚ¯Ùˆ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
    return;
  }

  console.log('messages:', chat.messages); // Ø¯ÛŒØ¨Ø§Ú¯

  // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ù…Ø­Ù„ÛŒ
  const idx = chatsList.findIndex(c => c._id === currentCid);
  if (idx !== -1) chatsList[idx] = chat;

  console.log('Ø³Ø§Ø®ØªØ§Ø± Ú†Øª Ú©Ø§Ù…Ù„:', chat);

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„
  let whom = 'Ù…Ø®Ø§Ø·Ø¨';
  let role = '';
  let sellerId = null;
  let storeName = '';
  let shopUrl = '';

  if (Array.isArray(chat.participants)) {
    const participant = chat.participants.find(p => p && p._id !== window.currentUserId);
    if (participant) {
      role = participant.role;
      sellerId = participant._id;
      storeName = participant.storename || '';
      shopUrl = participant.shopurl || '';
      whom = role === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : (role === 'admin' ? 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª' : (role === 'user' ? 'Ú©Ø§Ø±Ø¨Ø±' : 'Ù…Ø®Ø§Ø·Ø¨'));
    }
  }

  // fallback Ø§Ø² type
  if (!role && chat.type) {
    if (chat.type === 'user-seller' || chat.type === 'seller-admin') {
      whom = 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
      role = 'seller';
      sellerId = chat.sellerId;
    } else if (chat.type === 'user-admin') {
      whom = 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
      role = 'admin';
    }
  }

  let whomDisplay = whom;
  let sellerLink = '';
  if (role === 'seller' && sellerId) {
    const linkUrl = shopUrl ? `/store/${shopUrl}` : `/store.html?id=${sellerId}`;
    const linkText = storeName ? `Ù…ØºØ§Ø²Ù‡ ${storeName}` : `Ù…ØºØ§Ø²Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡`;
    sellerLink = `<a href="${linkUrl}" target="_blank" class="text-[#0ea5e9] hover:text-blue-700 hover:underline ml-3 text-sm font-semibold">${linkText}</a>`;
  }

  let prodBlock = '';
  if (chat.productId && chat.productId.title) {
    const productUrl = `/product.html?id=${chat.productId._id}`;
    prodBlock = `
      <a href="${productUrl}" target="_blank" class="flex items-center gap-2 bg-[#e0fdfa] px-2 py-1 rounded-lg my-2 hover:bg-[#d1f8f5] transition">
        <img src="${chat.productId.images?.[0] || '/assets/images/noimage.png'}" class="w-9 h-9 object-cover rounded-md border" alt="">
        <span class="text-xs text-gray-700">${chat.productId.title}</span>
      </a>
    `;
  }

  // Ù…ÙˆØ¯Ø§Ù„ HTML
  document.body.insertAdjacentHTML('beforeend', `
    <div id="chatModal" class="fixed inset-0 z-50 flex items-center justify-center" style="backdrop-filter:blur(4px);background:#0003;animation:fadein .25s">
      <div class="bg-white rounded-2xl w-[98vw] max-w-md max-h-[93vh] flex flex-col shadow-xl border">
        <div class="px-4 py-3 border-b flex justify-between items-center gap-3">
          <div>
            <div class="flex items-center">
              <span class="font-bold primary-text">${whomDisplay}</span>
              ${sellerLink}
            </div>
            ${prodBlock}
          </div>
          <button onclick="closeChat()" class="text-2xl font-black text-gray-400 hover:text-red-500 rounded-full w-8 h-8 flex items-center justify-center">Ã—</button>
        </div>
        <div id="chatBody" class="flex-1 overflow-y-auto p-4 space-y-4 text-[15px] scrollbar-hide bg-[#f9fafb]"></div>
        <div class="border-t p-3 flex gap-2 bg-white">
          <textarea id="msgBox" rows="2" class="flex-1 border rounded-xl p-2 resize-none focus:outline-none" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"></textarea>
          <button onclick="sendMsg()" class="brand-btn px-5 py-2 rounded-xl font-bold shrink-0">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
      </div>
    </div>
  `);
  renderChat();
  setTimeout(() => document.getElementById('msgBox').focus(), 120);
}
  // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ú†Øª
  function closeChat() {
    document.getElementById('chatModal')?.remove();
    currentCid = null;
  }

  /* Ø±Ù†Ø¯Ø± Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ */
/* Ø±Ù†Ø¯Ø± Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ */
function renderChat() {
  const chat = chatsList.find(c => c._id === currentCid);
  const target = document.getElementById('chatBody');
  if (!target) return;

  function getSenderRoleText(msg, isMe) {
    if (isMe) return 'Ø´Ù…Ø§';
    const role =
      msg.senderRole ||
      msg?.sender?.role ||
      msg?.senderId?.role ||
      (msg.senderModel === 'Admin' ? 'admin' :
       msg.senderModel === 'Seller' ? 'seller' :
       msg.senderModel === 'User' ? 'user' : msg?.from);
    if (role === 'admin')  return 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
    if (role === 'seller') return 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
    if (role === 'user')   return 'Ù…Ø´ØªØ±ÛŒ';
    return 'Ù…Ø®Ø§Ø·Ø¨';
  }

  target.innerHTML = (chat.messages || []).map(m => {
    const isMe = m.senderId?._id === window.currentUserId || m.senderRole === 'user' || m.from === 'user' || m.from === window.currentUserId;
    const cls = isMe ? 'bg-[#e0fdfa] self-end' : 'bg-[#f3f4f6]';
    const name = `<span class="text-xs font-bold text-[#10b981]">${getSenderRoleText(m, isMe)}</span>`;
    return `
      <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
        <div class="${cls} rounded-xl px-3 py-2 max-w-[78%]">
          ${name}
          <div>${m.text || ''}</div>
          <div class="text-xs text-gray-400 mt-1 text-left">${new Date(m.date || m.createdAt).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
      </div>
    `;
  }).join('');
  target.scrollTop = target.scrollHeight;
}



  /* Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… */
/**
 * Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø² Ø·Ø±Ù Ú©Ø§Ø±Ø¨Ø±
 */
async function sendMsg() {
  const ta   = document.getElementById('msgBox');
  const text = ta.value.trim();
  if (!text) {
    alert('Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }

  // ØªÙˆÚ©Ù†Ù Ú©Ø§Ø±Ø¨Ø± (Ù…Ø´ØªØ±ÛŒ) Ø±Ø§ Ø§Ø² Ú©ÙˆÚ©ÛŒ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
  const token = document.cookie
    .split('; ')
    .find(row => row.startsWith('user_token='))
    ?.split('=')[1];

  try {
    // Ø¨Ù‡ Ù…Ø³ÛŒØ± Ù…Ø®ØµÙˆØµ reply Ú©Ø§Ø±Ø¨Ø± Ø¨ÙØ±Ø³ØªÛŒÙ…
    const res = await fetch(`${API_BASE}/chats/${currentCid}/user-reply`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        ...(token && { Authorization: 'Bearer ' + token })
      },
      body: JSON.stringify({ text })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…');

    // Ù¾Ø³ Ø§Ø² Ù…ÙˆÙÙ‚ÛŒØªØŒ textarea Ø±Ø§ Ù¾Ø§Ú© Ùˆ Ù„ÛŒØ³Øª Ú†Øª Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    ta.value = '';
    chatsList = chatsList.map(c => c._id === currentCid ? data : c);
    renderChat();
    updateBadge();

  } catch (err) {
    console.error('âŒ sendMsg error:', err);
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…:\n' + err.message);
  }
}





async function deleteChat(cid) {
  if(!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú†Øª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

  try {
    const res = await fetch(`${API_BASE}/chats/${cid}`, {
      method: 'DELETE',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'Ø­Ø°Ù Ú†Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
    // Ø­Ø°Ù Ú†Øª Ø§Ø² Ù„ÛŒØ³Øª Ùˆ Ø±ÙØ±Ø´
    chatsList = chatsList.filter(c => c._id !== cid);
    renderMessagesList();
    updateBadge();
    closeChat();
  } catch (err) {
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú†Øª: ' + err.message);
  }
}




  /* badge Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡ */
function updateBadge() {
  const total = chatsList.reduce(
      (n, c) => n + (c.messages || []).filter(m => !m.read && m.from !== 'user').length,
      0);

  /* ğŸ”¸ Ù†Ø´Ø§Ù† Ú©Ù†Ø§Ø± Ú¯Ø²ÛŒÙ†Ù‡Ù” Â«Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§Â» Ø¯Ø± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± (Ù‡Ù…Ø§Ù† Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ) */
  document.getElementById('msgBadge').textContent = total > 0 ? total : '';

  /* ğŸ”¸ Ù†Ø´Ø§Ù† Ø±ÙˆÛŒ Ù‡Ù…Ø¨Ø±Ú¯Ø± â€“ Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯Ù‡ */
  const hamBadge = document.getElementById('hamBadge');
  if (hamBadge) {
    if (total > 0) {
      hamBadge.textContent = total;
      hamBadge.classList.remove('hidden');   // Ù†Ù…Ø§ÛŒØ´
    } else {
      hamBadge.classList.add('hidden');      // Ù¾Ù†Ù‡Ø§Ù†â€ŒØ³Ø§Ø²ÛŒ
    }
  }
}


  /* Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù„ÛŒØ³Øª Ùˆ Ú†Øª */
/* Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù„ÛŒØ³Øª Ùˆ Ú†Øª */
function startMsgPolling(){
  if(pollHandle) clearInterval(pollHandle);
  pollHandle = setInterval(async()=>{
    await fetchUserChats();
    updateBadge();
    if(currentCid) {
      // Ø§Ú¯Ø± Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ú†Øª Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ fetch Ùˆ Ø±Ù†Ø¯Ø± Ú©Ù†
      const chat = await fetchChatDetails(currentCid);
      if (chat) {
        const idx = chatsList.findIndex(c => c._id === currentCid);
        if (idx !== -1) chatsList[idx] = chat;
        renderChat();
      }
    } else {
      renderMessagesList();
    }
  },10000);
}
  function stopMsgPolling(){ if(pollHandle){clearInterval(pollHandle);pollHandle=null;} }
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ù¾Ø§ÛŒØ§Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */








/* Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ ÛŒÚ© Ú†Øª (Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */
/* Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ ÛŒÚ© Ú†Øª (Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */
async function fetchChatDetails(cid) {
  const token = document.cookie.split('; ').find(row => row.startsWith('user_token='))?.split('=')[1];
  try {
    const res = await fetch(`${API_BASE}/chats/${cid}`, {
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        ...(token && { Authorization: 'Bearer ' + token })
      }
    });
    if (!res.ok) throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú†Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
    const data = await res.json();
    return data;  // Ú†Øª Ú©Ø§Ù…Ù„ Ø¨Ø§ messages
  } catch (e) {
    console.error('âŒ fetchChatDetails error:', e);
    return null;
  }
}









  // --- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯: Ú©Ù„ÛŒÚ© Ø¨Ø§Ú©Ø³ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ùˆ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± --- 




    </script>
  </body>
  </html>
