  <!DOCTYPE html>
  <html lang="fa" dir="rtl">
  <head>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net data:; connect-src 'self'; img-src 'self' data:; base-uri 'self'; form-action 'self'; upgrade-insecure-requests; block-all-mixed-content">
<meta name="referrer" content="no-referrer">
    <script src="/security.js" defer></script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø± | ÙˆÛŒØªØ±ÛŒÙ†Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@800&display=swap" rel="stylesheet"/>
    <style>
      body { font-family:'Vazirmatn',sans-serif; background: linear-gradient(110deg,#e0f7fa 0%,#f9fafb 100%); min-height:100vh;}
      .glass { background:rgba(255,255,255,0.97); backdrop-filter: blur(14px); border-radius:1.6rem; box-shadow:0 7px 32px #10b9811a, 0 3px 11px #0ea5e91a;}
      .primary-text { color: #10b981; }
      .brand-btn {
        background: linear-gradient(91deg,#10b981 0%,#0ea5e9 85%);
        color: #fff !important;
        box-shadow: 0 2px 14px #10b98125;
        transition: all .16s;
      }
      .brand-btn:hover { filter:brightness(1.08);}
      .fadein { animation:fadein .8s;}
      @keyframes fadein { from{opacity:0; transform:translateY(32px);} to{opacity:1; transform:translateY(0);} }
      @keyframes slideUp { from{opacity:0; transform:translateY(100%);} to{opacity:1; transform:translateY(0);} }
      ::placeholder {color:#a0aec0;}
      .tab-active { color:#10b981 !important; font-weight:900; background: #e6fcf7; }
      .scrollbar-hide::-webkit-scrollbar {display:none;}
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none;}
      .avatar-bg { background:linear-gradient(120deg,#10b981 65%,#0ea5e9 100%); }
      .menu-btn { transition: background .16s; }
      .menu-btn.active { background: #e6fcf7; color: #10b981; }
      .filter-btn { transition: all .2s ease; }
      .filter-btn.active { background-color: #3b82f6; color: #fff; border-color: transparent; }
      .quick-action {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 1rem;
        min-height: 110px;
        padding: 1.25rem 1rem;
        text-align: center;
        color: #374151;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.65rem;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        transition: all .2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .quick-action:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.12);
        background: #fafafa;
        border-color: #10b98120;
      }
      .quick-action:focus-visible {
        outline: 2px solid #10b981;
        outline-offset: 2px;
      }
      .quick-action-icon {
        width: 36px;
        height: 36px;
        stroke: #10b981;
        stroke-width: 1.5;
        fill: none;
        transition: all .2s ease;
      }
      .quick-action:hover .quick-action-icon {
        stroke: #059669;
        transform: scale(1.08);
      }
      .quick-action-label {
        line-height: 1.4;
        letter-spacing: -0.01em;
      }
      .quick-action-more {
        background: #f9fafb;
        border: 1px dashed #d1d5db;
        color: #6b7280;
        font-size: 0.85rem;
      }
      .quick-action-more:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        color: #4b5563;
      }
      .quick-action-more .quick-action-icon {
        stroke: #9ca3af;
      }
      /* Ú©Ø§Ø±Øª Ù‡Ø§ÛŒ Ø±Ø²Ø±Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ùˆ Ù…Ø¯Ø±Ù† */
      .booking-card {
        position: relative;
        overflow: hidden;
        border-radius: 1.5rem;
        padding: 0;
        background: #ffffff;
        border: 2px solid rgba(15, 23, 42, 0.06);
        box-shadow: 0 4px 20px rgba(15, 23, 42, 0.06);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 1.5rem;
      }

      .booking-card::before {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        width: 5px;
        height: 100%;
        background: linear-gradient(180deg, #0ea5e9, #10b981);
        opacity: 1;
      }

      .booking-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(15, 23, 42, 0.12);
        border-color: rgba(15, 23, 42, 0.1);
      }

      .booking-card--pending::before { background: linear-gradient(180deg, #fbbf24, #f97316); }
      .booking-card--confirmed::before { background: linear-gradient(180deg, #10b981, #059669); }
      .booking-card--completed::before { background: linear-gradient(180deg, #6366f1, #2563eb); }
      .booking-card--cancelled::before { background: linear-gradient(180deg, #ef4444, #dc2626); }
      .booking-card--default::before { background: linear-gradient(180deg, #94a3b8, #64748b); }

      /* Header Section */
      .booking-card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(241, 245, 249, 0.4), rgba(248, 250, 252, 0.4));
        border-bottom: 1px solid rgba(15, 23, 42, 0.05);
      }

      .booking-service-icon-wrapper {
        flex-shrink: 0;
      }

      .booking-service-icon {
        width: 56px;
        height: 56px;
        border-radius: 1rem;
        background: linear-gradient(135deg, #dbeafe, #ddd6fe);
        color: #4f46e5;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
      }

      .booking-header-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .booking-service-name {
        flex: 1;
        min-width: 0;
      }

      .booking-service-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
      }

      .booking-service-title {
        font-size: 1.35rem;
        font-weight: 800;
        color: #1e293b;
        line-height: 1.3;
        margin: 0;
        word-wrap: break-word;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 700;
        letter-spacing: 0.02em;
        border: 2px solid transparent;
        white-space: nowrap;
        align-self: flex-start;
      }

      .status-badge--pending { color: #92400e; background: #fef3c7; border-color: #fcd34d; }
      .status-badge--confirmed { color: #065f46; background: #d1fae5; border-color: #34d399; }
      .status-badge--completed { color: #312e81; background: #e0e7ff; border-color: #a5b4fc; }
      .status-badge--cancelled { color: #991b1b; background: #fee2e2; border-color: #fca5a5; }
      .status-badge--default { color: #1f2937; background: #f3f4f6; border-color: #e5e7eb; }

      /* Info Grid */
      .booking-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1px;
        background: rgba(15, 23, 42, 0.05);
        border-bottom: 1px solid rgba(15, 23, 42, 0.05);
      }

      .booking-info-item {
        display: flex;
        align-items: flex-start;
        gap: 0.875rem;
        padding: 1.25rem 1.5rem;
        background: #ffffff;
      }

      .booking-info-icon {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        border-radius: 0.75rem;
        background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .booking-info-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .booking-info-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .booking-info-value {
        font-size: 0.95rem;
        font-weight: 700;
        color: #1e293b;
        word-wrap: break-word;
      }

      .booking-info-link {
        color: #3b82f6;
        text-decoration: none;
        transition: color 0.2s;
      }

      .booking-info-link:hover {
        color: #2563eb;
        text-decoration: underline;
      }

      /* Actions */
      .booking-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        padding: 1.5rem;
        background: #fafbfc;
      }

      .booking-action-btn {
        flex: 1;
        min-width: 140px;
        border-radius: 0.75rem;
        padding: 0.875rem 1.25rem;
        font-weight: 700;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        white-space: nowrap;
      }

      .booking-action-btn--primary {
        background: linear-gradient(135deg, #3b82f6, #6366f1);
        color: #fff;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .booking-action-btn--primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      }

      .booking-action-btn--danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: #fff;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }

      .booking-action-btn--danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
      }

      .booking-action-btn--ghost {
        background: #ffffff;
        color: #b91c1c;
        border: 2px solid #fca5a5;
      }

      .booking-action-btn--ghost:hover {
        background: #fee2e2;
        border-color: #dc2626;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .booking-card {
          border-radius: 1.25rem;
          margin-bottom: 1.25rem;
        }

        .booking-card-header {
          flex-direction: column;
          align-items: flex-start;
          padding: 1.25rem;
          gap: 1rem;
        }

        .booking-header-content {
          width: 100%;
          gap: 0.75rem;
        }

        .booking-service-icon {
          width: 50px;
          height: 50px;
        }

        .booking-service-title {
          font-size: 1.15rem;
        }

        .status-badge {
          width: 100%;
          justify-content: center;
          padding: 0.625rem 1rem;
        }

        .booking-info-grid {
          grid-template-columns: 1fr;
        }

        .booking-info-item {
          padding: 1rem 1.25rem;
        }

        .booking-info-icon {
          width: 36px;
          height: 36px;
        }

        .booking-actions {
          flex-direction: column;
          padding: 1.25rem;
        }

        .booking-action-btn {
          width: 100%;
          min-width: auto;
          padding: 1rem 1.25rem;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 480px) {
        .booking-card-header {
          padding: 1rem;
        }

        .booking-service-icon {
          width: 44px;
          height: 44px;
        }

        .booking-service-title {
          font-size: 1.05rem;
        }

        .booking-info-item {
          padding: 0.875rem 1rem;
          gap: 0.75rem;
        }

        .booking-info-icon {
          width: 32px;
          height: 32px;
        }

        .booking-info-label {
          font-size: 0.7rem;
        }

        .booking-info-value {
          font-size: 0.875rem;
        }

        .booking-actions {
          padding: 1rem;
        }
      }
      /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø¨ÛŒØ´ØªØ± */
      .more-actions-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .more-actions-modal.active {
        display: flex;
        animation: fadein .2s ease;
      }
      .more-actions-content {
        background: white;
        border-radius: 1.25rem;
        padding: 1.75rem 1.5rem;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        animation: slideUp .3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .more-actions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .more-actions-close {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #f3f4f6;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background .2s;
      }
      .more-actions-close:hover {
        background: #e5e7eb;
      }
      .more-actions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }
      .more-action-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border-radius: 0.75rem;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        text-decoration: none;
        color: #374151;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all .2s ease;
        cursor: pointer;
      }
      .more-action-item:hover {
        background: #f3f4f6;
        border-color: #10b98130;
        transform: translateY(-1px);
      }
      .more-action-icon {
        width: 22px;
        height: 22px;
        stroke: #6b7280;
        stroke-width: 1.8;
        fill: none;
        flex-shrink: 0;
      }
      /* Header Styles - Modern & Professional */
      .main-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(16, 185, 129, 0.1);
        box-shadow: 0 4px 24px rgba(16, 185, 129, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .main-header.scrolled {
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 6px 32px rgba(16, 185, 129, 0.12);
      }
      .logo-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        transition: transform 0.3s ease;
      }
      .logo-container:hover {
        transform: scale(1.05);
      }
      .logo-icon {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
        position: relative;
        overflow: hidden;
      }
      .logo-icon::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, transparent 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .logo-container:hover .logo-icon::before {
        opacity: 1;
      }
      .logo-text {
        font-family: 'Vazirmatn', sans-serif;
        font-size: 1.5rem;
        font-weight: 900;
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.02em;
      }
      .nav-links {
        display: flex;
        align-items: center;
        gap: 2rem;
      }
      .nav-link {
        position: relative;
        font-weight: 600;
        font-size: 0.95rem;
        color: #4b5563;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
      }
      .nav-link::before {
        content: '';
        position: absolute;
        bottom: 0;
        right: 50%;
        width: 0;
        height: 2px;
        background: linear-gradient(90deg, #10b981, #0ea5e9);
        transition: all 0.3s ease;
        transform: translateX(50%);
      }
      .nav-link:hover {
        color: #10b981;
        background: rgba(16, 185, 129, 0.05);
      }
      .nav-link:hover::before {
        width: 80%;
      }
      .nav-link.active {
        color: #10b981;
        background: rgba(16, 185, 129, 0.1);
      }
      .header-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .profile-button {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.5rem 1.25rem 0.5rem 0.625rem;
        border-radius: 100px;
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-family: 'Vazirmatn', sans-serif;
      }
      .profile-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.35);
      }
      .profile-button:active {
        transform: translateY(0);
      }
      .profile-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.125rem;
        font-weight: 800;
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }
      .profile-name {
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
        letter-spacing: -0.01em;
      }
      .notification-btn {
        position: relative;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: rgba(16, 185, 129, 0.08);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      .notification-btn:hover {
        background: rgba(16, 185, 129, 0.15);
        transform: scale(1.05);
      }
      .notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        font-size: 0.7rem;
        font-weight: 800;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      }
      .menu-toggle {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: rgba(16, 185, 129, 0.08);
        border: none;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 5px;
        padding: 0;
        transition: all 0.3s ease;
      }
      .menu-toggle:hover {
        background: rgba(16, 185, 129, 0.15);
        transform: scale(1.05);
      }
      .menu-toggle span {
        width: 20px;
        height: 2.5px;
        background: #10b981;
        border-radius: 2px;
        transition: all 0.3s ease;
      }
      .menu-toggle:hover span {
        background: #059669;
      }

      /* Header Animation */
      @keyframes headerSlideDown {
        from {
          opacity: 0;
          transform: translateY(-100%);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .main-header {
        animation: headerSlideDown 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Responsive Header Styles */
      @media (max-width: 768px) {
        .main-header {
          padding: 0.875rem 1rem !important;
        }
        .logo-icon {
          width: 42px;
          height: 42px;
        }
        .logo-text {
          font-size: 1.25rem;
        }
        .nav-links {
          display: none;
        }
        .profile-name {
          display: none;
        }
        .profile-button {
          padding: 0.5rem;
          min-width: 44px;
          justify-content: center;
        }
        .notification-btn {
          width: 40px;
          height: 40px;
        }
        .menu-toggle {
          width: 40px;
          height: 40px;
        }
      }
      @media (max-width: 480px) {
        .main-header {
          padding: 0.75rem 0.875rem !important;
        }
        .logo-text {
          display: none;
        }
        .logo-icon {
          width: 40px;
          height: 40px;
        }
        .header-actions {
          gap: 0.5rem;
        }
        .notification-btn {
          display: none !important;
        }
      }
      @media (max-width: 360px) {
        .profile-avatar {
          width: 36px;
          height: 36px;
        }
        .menu-toggle {
          width: 36px;
          height: 36px;
        }
        .menu-toggle span {
          width: 18px;
        }
      }
      @media (max-width: 1023px) {
        .main-grid { grid-template-columns: 1fr !important; }
        .sidebar { display: none !important; }
      }
      @media (min-width: 1024px) {
        .mobile-sidebar,.sidebar-overlay { display: none !important;}
      }
      /* Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ù†Ùˆ - Modern Design */
      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        z-index: 100;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .sidebar-overlay.open {
        display: block;
        opacity: 1;
      }
      .mobile-sidebar {
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        width: 85vw;
        max-width: 380px;
        background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
        z-index: 110;
        border-radius: 1.75rem 0 0 1.75rem;
        box-shadow: -4px 0 48px rgba(16, 185, 129, 0.15);
        padding: 2rem 1.5rem;
        overflow-y: auto;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }
      .mobile-sidebar.open {
        transform: translateX(0);
      }
      .mobile-sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid rgba(16, 185, 129, 0.1);
      }
      .mobile-sidebar-close {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: rgba(239, 68, 68, 0.1);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      .mobile-sidebar-close:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: rotate(90deg);
      }
      .mobile-user-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(14, 165, 233, 0.05) 100%);
        border-radius: 1.25rem;
        margin-bottom: 1.5rem;
      }
      .mobile-user-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        font-weight: 800;
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        margin-bottom: 1rem;
        border: 4px solid white;
      }
      .mobile-menu-section {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .mobile-menu-item {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        padding: 1rem 1.25rem;
        border-radius: 14px;
        background: white;
        border: 2px solid rgba(16, 185, 129, 0.08);
        font-weight: 600;
        font-size: 0.95rem;
        color: #4b5563;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
      }
      .mobile-menu-item:hover, .mobile-menu-item.active {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(14, 165, 233, 0.1) 100%);
        border-color: rgba(16, 185, 129, 0.3);
        color: #10b981;
        transform: translateX(-4px);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.15);
      }
    </style>
    <script src="/nav-active.js" defer></script>

<!-- TODO: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø³Øªâ€ŒÙ‡Ø§Ú¯ Ø±Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø§Ù†ØªØ´Ø§Ø± ÙØ±Ø§Ù…ÙˆØ´ Ù†Ú©Ù†ÛŒØ¯ | TODO: Enable PostHog analytics when going live -->
<!--
<script>
  (function () {
    var config = window.POSTHOG_CONFIG || { enabled: false, apiKey: 'phc_YOUR_KEY_HERE', apiHost: 'https://analytics.vitreenet.ir' };
    if (!config.enabled) {
      return; // ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª | Not enabled yet
    }
    try {
      (function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")),p.type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js";(r=t.getElementsByTagName("script")[0]),r.parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:u=e,u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==u._i&&(e+="."+u._i),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"};n="capture identify alias people.set people.set_once people.unset people.increment people.append people.union people.remove people.clear_opt_out_outcome register register_once unregister opt_out_capturing opt_in_capturing has_opted_out_capturing reset isFeatureEnabled onFeatureFlags reloadFeatureFlags group".split(" ");for(o=0;o<n.length;o++)g(u,n[o]);e._i.push([i,s,a])},e.__SV=1.1)})(document, window.posthog || []);
      window.posthog.init(config.apiKey, { api_host: config.apiHost, capture_pageview: true, advanced_disable_decide: true });
    } catch (error) {
      console.warn('PostHog init failed (preview mode):', error);
    }
  })();
</script>
-->

</head>
  <body class="text-gray-800 overflow-x-hidden">

    <!-- Header - Modern & Professional -->
    <header class="main-header fixed top-0 inset-x-0 z-20" style="padding: 1rem 1.5rem;">
      <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
        <!-- Header Actions (Left Side) -->
        <div class="header-actions">
          <!-- Mobile Menu Toggle -->
          <button id="hamBtn" class="menu-toggle lg:hidden" aria-label="Ù…Ù†Ùˆ" title="Ù…Ù†Ùˆ">
            <span></span>
            <span></span>
            <span></span>
            <span id="hamBadge" class="notification-badge hidden" style="top: -6px; right: -6px;">0</span>
          </button>

          <!-- Profile Button -->
          <button id="profileBtn" type="button" class="profile-button">
            <div class="profile-avatar">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <span class="profile-name">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</span>
          </button>

          <!-- Notification Button -->
          <button class="notification-btn hidden md:flex" aria-label="Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§" title="Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
            <span id="notificationBadge" class="notification-badge hidden">0</span>
          </button>
        </div>

        <!-- Navigation Links (Desktop) -->
        <nav class="nav-links flex-1 hidden md:flex justify-center">
          <a href="index.html" class="nav-link active">
            <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
          </a>
          <a href="../index.html" class="nav-link">
            <span>ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</span>
          </a>
          <a href="#" class="nav-link" data-section="bookings">
            <span>Ø±Ø²Ø±ÙˆÙ‡Ø§</span>
          </a>
        </nav>

        <!-- Logo Section (Right Side) -->
        <a href="index.html" class="logo-container" aria-label="Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡">
          <div class="logo-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M9 22V12h6v10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <span class="logo-text">ÙˆÛŒØªØ±ÛŒÙ†Øª</span>
        </a>
      </div>
    </header>

    <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ - Modern Design -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <aside id="mobileSidebar" class="mobile-sidebar">
      <!-- Header Section -->
      <div class="mobile-sidebar-header">
        <h2 style="font-size: 1.25rem; font-weight: 800; background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ</h2>
        <button id="closeSidebar" class="mobile-sidebar-close" title="Ø¨Ø³ØªÙ†">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <!-- User Section -->
      <div class="mobile-user-section">
        <div class="mobile-user-avatar">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </div>
        <div class="text-lg font-bold primary-text text-center sidebar-user-name">Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª</div>
        <div class="text-gray-500 text-sm text-center sidebar-user-mobile" dir="ltr">0912***2345</div>
      </div>

      <!-- Menu Section -->
      <div class="mobile-menu-section">
        <button class="mobile-menu-item menu-btn active" data-section="dashboard">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
          </svg>
          <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
        </button>

        <button class="mobile-menu-item menu-btn" data-section="profile">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <span>Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</span>
        </button>

        <button class="mobile-menu-item menu-btn" data-section="bookings">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <span>Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒ Ù…Ù†</span>
          <span id="bookings-badge-mobile" class="notification-badge hidden" style="position: static; margin-right: auto;">0</span>
        </button>

        <button class="mobile-menu-item menu-btn" data-section="favorites">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
          <span>Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</span>
        </button>

        <button class="mobile-menu-item menu-btn" data-section="favshops">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
          <span>Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø¨ÙˆØ¨</span>
        </button>

        <button class="mobile-menu-item menu-btn" data-section="messages">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <span>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</span>
          <span id="msgBadge-mobile" class="notification-badge hidden" style="position: static; margin-right: auto;">0</span>
        </button>
      </div>
    </aside>

    <main class="max-w-6xl mx-auto mt-32 mb-14 px-2 sm:px-4">
      <div class="grid main-grid grid-cols-3 gap-7">
        <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¯Ø³Ú©ØªØ§Ù¾ -->
        <aside class="glass sidebar flex-col items-center py-7 px-4 sm:px-8 mb-3 fadein hidden lg:flex">
          <div class="w-20 h-20 rounded-full avatar-bg flex items-center justify-center text-white text-4xl font-extrabold mb-2 select-none shadow-lg">
            VN
          </div>
        <div class="text-lg font-bold primary-text mt-2 mb-0.5 text-center sidebar-user-name">Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª</div>
  <div class="text-gray-400 text-sm mb-3 text-center sidebar-user-mobile" dir="ltr">0912***2345</div>

          <div class="flex flex-col gap-2 w-full mt-4 text-[15px]">
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition tab-active" data-section="dashboard"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#10b981"/><path d="M6 9l3 3 3-3" stroke="#fff" stroke-width="1.6"/></svg> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="profile"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#dbeafe"/><path d="M6 7a3 3 0 0 1 6 0c0 1.656-1.343 3-3 3s-3-1.344-3-3Zm6 6H6c0-1.656 2.343-3 3-3s3 1.344 3 3Z" fill="#3b82f6"/></svg> Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="favorites"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fce7f3"/><path d="M6.5 8A2.5 2.5 0 0 1 9 5.5 2.5 2.5 0 0 1 11.5 8C11.5 9.33 9 12 9 12S6.5 9.33 6.5 8Z" fill="#ec4899"/></svg> Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="favshops"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#ffe4e6"/><path d="M6.5 8A2.5 2.5 0 0 1 9 5.5 2.5 2.5 0 0 1 11.5 8C11.5 9.33 9 12 9 12S6.5 9.33 6.5 8Z" fill="#f43f5e"/></svg> Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø¨ÙˆØ¨ Ù…Ù†</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="bookings">
              ğŸ“… Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒ Ù…Ù†
              <span id="bookings-badge" class="inline-block mr-2 px-2 py-1 text-xs bg-red-500 text-white rounded-full hidden">0</span>
            </button>
            
  <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
  <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition"
          data-section="messages">
    <svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fef2f2"/><path d="M6 6h6v6H6z" fill="#ef4444"/></svg>
    Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    <span id="msgBadge" class="ml-1 text-xs font-extrabold text-red-500"></span>
  </button>




          </div>
        
        </aside>
        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø³Ù…Øª Ú†Ù¾ -->
        <section id="mainContent" class="col-span-2 flex flex-col gap-7 fadein">
          <!-- Ø§ÛŒÙ†Ø¬Ø§ Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ù„ÙˆØ¯ Ù…ÛŒØ´Ù‡ -->
        </section>
      </div>
    </main>
    <footer class="mt-14 bg-white border-t text-center text-xs sm:text-sm text-gray-400 py-5 rounded-t-3xl">
      Â© 2025 <span class="text-[#10b981] font-bold">Vitrinet</span> - Ù‡Ù…Ù‡ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.
    </footer>
    <script>
      // ==========================================
      // Header Scroll Effect & Navigation
      // ==========================================

      // Add scroll effect to header
      window.addEventListener('scroll', () => {
        const header = document.querySelector('.main-header');
        if (window.scrollY > 20) {
          header.classList.add('scrolled');
        } else {
          header.classList.remove('scrolled');
        }
      });

      // Handle navigation link clicks
      document.addEventListener('DOMContentLoaded', () => {
        const navLinks = document.querySelectorAll('.nav-link');

        navLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            const section = link.getAttribute('data-section');
            if (section) {
              e.preventDefault();

              // Remove active class from all links
              navLinks.forEach(l => l.classList.remove('active'));

              // Add active class to clicked link
              link.classList.add('active');

              // Trigger section change (if applicable)
              const menuBtn = document.querySelector(`button[data-section="${section}"]`);
              if (menuBtn) {
                menuBtn.click();
              }
            }
          });
        });
      });

      // Bookings state
      let currentBookingFilter = 'all';
      let allBookings = [];

      let pollHandle = null;
      let bookingsData = [];
      let bookingsLoaded = false;
      // Ø¯Ø§Ø¯Ù‡â€ŒÛŒ Ø¯Ù…ÙˆÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
  async function loadProfileSection() {
    let html = `
      <div class="glass px-6 py-7 fadein">
        <div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</div>
      </div>`;
    document.getElementById('mainContent').innerHTML = html;

    try {
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',          // Ú©ÙˆÚ©ÛŒ JWT
        headers: { 'Content-Type': 'application/json' }
      });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403)
          throw new Error('Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.');
        throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯!');
      }

      const user  = await res.json();
      const phone = user.phone || user.mobile || '';   // âœ³ï¸ ÙÛŒÚ©Ø³: ÙÛŒÙ„Ø¯ mobile Ù‡Ù… Ù¾ÙˆØ´Ø´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯
      const masked =
        phone ? phone.toString().slice(0, 4) + '***' + phone.toString().slice(-3) : '-';

      html = `
        <div class="glass px-6 py-7 fadein">
          <div class="flex flex-col sm:flex-row items-center gap-5 sm:gap-12 mb-6">
            <div class="w-24 h-24 rounded-full avatar-bg flex items-center justify-center text-white text-5xl font-extrabold shadow-xl">
              VN
            </div>
            <div>
              <div class="text-xl font-black primary-text mb-2">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-1 gap-x-7 text-[16px]">
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ù†Ø§Ù…:</span>
                  <span class="font-bold text-gray-800">${user.firstname || '-'}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</span>
                  <span class="font-bold text-gray-800">${user.lastname || '-'}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ø´Ù‡Ø±:</span>
                  <span class="font-bold text-gray-800">${user.city || '-'}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</span>
                  <span class="font-bold text-gray-800" dir="ltr">${masked}</span>
                </div>
              </div>
            </div>
          </div>
        </div>`;
    } catch (e) {
      html = `
        <div class="glass px-6 py-7 fadein">
          <div class="text-center text-red-400 py-12">
            Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø¨ØªØ¯Ø§
            <a href="/login.html"
              class="inline-block px-3 py-1.5 mx-1 rounded-xl brand-btn text-white font-bold text-base transition hover:scale-105"
              style="text-decoration:none;">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a>
            .
          </div>
        </div>`;
    }

    document.getElementById('mainContent').innerHTML = html;
  }








      async function ensureUserPhone() {
        if (window.currentUserPhone) return window.currentUserPhone;

        try {
          const res = await fetch('/api/user/profile', {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!res.ok) return '';

          const user = await res.json();
          const phone = user.phone || user.mobile || '';
          window.currentUserPhone = phone;
          return phone;
        } catch (_) {
          return '';
        }
      }

      async function fetchBookings(phone) {
        const res = await fetch(`/api/bookings?phone=${encodeURIComponent(phone)}`, {
          method: 'GET',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          let message = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ø±ÙˆÙ‡Ø§';
          try {
            const data = await res.json();
            if (data && data.message) message = data.message;
          } catch (_) {}
          throw new Error(message);
        }

        const data = await res.json();
        return Array.isArray(data.items) ? data.items : [];
      }

      async function getBookings(force = false) {
        if (!force && bookingsLoaded) {
          return { data: bookingsData, hasPhone: true };
        }

        const phone = await ensureUserPhone();
        if (!phone) {
          bookingsData = [];
          bookingsLoaded = false;
          return { data: [], hasPhone: false };
        }

        try {
          bookingsData = await fetchBookings(phone);
          bookingsLoaded = true;
          return { data: bookingsData, hasPhone: true };
        } catch (err) {
          bookingsData = [];
          bookingsLoaded = false;
          throw err;
        }
      }

      function updateBookingsBadge() {
        const dataset = (Array.isArray(allBookings) && allBookings.length)
          ? allBookings
          : (Array.isArray(bookingsData) ? bookingsData : []);

        const pendingCount = dataset
          .filter(b => (b.status || '').toLowerCase() === 'pending')
          .length;

        const badges = document.querySelectorAll('#bookings-badge');
        if (!badges.length) return;

        badges.forEach(badge => {
          if (pendingCount > 0) {
            badge.textContent = pendingCount.toLocaleString('fa-IR');
            badge.classList.remove('hidden');
          } else {
            badge.textContent = '';
            badge.classList.add('hidden');
          }
        });
      }

      function updateBookingsBadgeDisplay() {
        updateBookingsBadge();
      }

      async function refreshBookingsBadge(force = false) {
        const badges = document.querySelectorAll('#bookings-badge');
        if (!badges.length) return;

        try {
          const result = await getBookings(force);
          if (!result.hasPhone) {
            badges.forEach(b => {
              b.textContent = '';
              b.classList.add('hidden');
            });
            allBookings = [];
            return;
          }
          allBookings = Array.isArray(result.data) ? result.data : [];
          updateBookingsBadge();
        } catch (err) {
          console.error('refreshBookingsBadge error:', err);
          badges.forEach(b => {
            b.textContent = '';
            b.classList.add('hidden');
          });
          allBookings = [];
        }
      }

      // Load user's bookings
      async function loadBookings() {
        try {
          const token = localStorage.getItem('token');

          // Check if user is actually logged in
          if (!token) {
            console.log('No auth token found, skipping bookings');
            bookingsLoaded = false;
            allBookings = [];
            bookingsData = [];
            renderBookings([]);
            updateBookingsBadge();
            return;
          }

          const response = await fetch('/api/user/bookings', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const payload = await response.json();
            const bookings = Array.isArray(payload)
              ? payload
              : (Array.isArray(payload?.items) ? payload.items : []);

            allBookings = bookings;
            bookingsData = bookings;
            bookingsLoaded = true;
            renderBookings(allBookings);
            updateBookingsBadge();
          } else if (response.status === 401) {
            // User not authenticated - this is OK, just don't show bookings
            console.log('User not authenticated for bookings');
            allBookings = [];
            bookingsData = [];
            bookingsLoaded = false;
            renderBookings([]);
            updateBookingsBadge();
          } else {
            console.error('Failed to load bookings:', response.status);
          }
        } catch (error) {
          console.error('Error loading bookings:', error);
        }
      }

      // Cancel a booking
      async function cancelBooking(bookingId) {
        // Confirm with user
        if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø±Ø²Ø±Ùˆ Ø±Ø§ Ù„ØºÙˆ Ú©Ù†ÛŒØ¯ØŸ')) {
          return;
        }

        try {
          const token = localStorage.getItem('token');

          const response = await fetch(`/api/bookings/${bookingId}/cancel`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            alert('Ø±Ø²Ø±Ùˆ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ØºÙˆ Ø´Ø¯');

            // Reload bookings to show updated status
            await loadBookings();
          } else {
            const error = await response.json();
            alert(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ø±Ø²Ø±Ùˆ');
          }
        } catch (error) {
          console.error('Error cancelling booking:', error);
          alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
        }
      }

      async function loadBookingsSection() {
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
    <!-- Bookings Section -->
    <div id="bookings-section" class="section hidden">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒ Ù…Ù†</h2>
        
        <!-- Status Filter Buttons -->
        <div class="flex flex-wrap gap-3 mb-6">
          <button data-status="all" class="filter-btn active px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-all duration-200 ease-out">
            Ù‡Ù…Ù‡
          </button>
          <button data-status="pending" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯
          </button>
          <button data-status="confirmed" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡
          </button>
          <button data-status="completed" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡
          </button>
          <button data-status="cancelled" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            Ù„ØºÙˆ Ø´Ø¯Ù‡
          </button>
        </div>
        
        <!-- Bookings Container -->
        <div id="bookings-container" class="space-y-4">
          <div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ø±ÙˆÙ‡Ø§...</div>
        </div>
        
        <!-- Empty State -->
        <div id="no-bookings" class="text-center py-12 hidden">
          <div class="text-6xl mb-4">ğŸ“…</div>
          <p class="text-gray-500 text-lg mb-2">Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø±Ø²Ø±ÙˆÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>
          <p class="text-gray-400 mb-6">Ø¨Ø±Ø§ÛŒ Ø±Ø²Ø±Ùˆ Ø®Ø¯Ù…Ø§ØªØŒ Ø§Ø² ØµÙØ­Ù‡ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ú©Ù†ÛŒØ¯</p>
          <a href="/service-directory.html" class="inline-block px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
            Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø®Ø¯Ù…Ø§Øª
          </a>
        </div>
      </div>
    </div>
  `;

        const section = document.getElementById('bookings-section');
        if (section) section.classList.remove('hidden');

        // Add event listeners for filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const status = btn.dataset.status;
            filterBookings(status, e);
          });
        });

        const container = document.getElementById('bookings-container');
        const emptyState = document.getElementById('no-bookings');
        if (container) container.innerHTML = `<div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ø±ÙˆÙ‡Ø§...</div>`;
        if (emptyState) emptyState.classList.add('hidden');

        try {
          const result = await getBookings(true);
          if (!result.hasPhone) {
            if (container) {
              container.innerHTML = `<div class="text-center text-red-400 py-12">Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ø²Ø±ÙˆÙ‡Ø§ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.</div>`;
            }
            allBookings = [];
            updateBookingsBadge();
            return;
          }

          allBookings = Array.isArray(result.data) ? result.data : [];
          bookingsData = allBookings;
          updateBookingsBadge();
          filterBookings('all');
        } catch (err) {
          console.error('loadBookingsSection error:', err);
          if (container) {
            container.innerHTML = `<div class="text-center text-red-400 py-12">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ø±ÙˆÙ‡Ø§. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</div>`;
          }
          allBookings = [];
          updateBookingsBadge();
        }
      }

      function filterBookings(status, evt) {
        const normalized = (status || 'all').toLowerCase();
        currentBookingFilter = normalized;

        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active', 'bg-blue-500', 'text-white');
          btn.classList.add('border', 'border-gray-300');
        });

        const target = evt?.currentTarget || evt?.target || document.querySelector(`.filter-btn[data-status="${normalized}"]`);
        if (target) {
          target.classList.add('active', 'bg-blue-500', 'text-white');
          target.classList.remove('border', 'border-gray-300');
        }

        if (!Array.isArray(allBookings) || allBookings.length === 0) {
          renderBookings([]);
          return;
        }

        const filtered = normalized === 'all'
          ? allBookings
          : allBookings.filter(item => (item.status || '').toLowerCase() === normalized);

        if (!filtered.length) {
          const container = document.getElementById('bookings-container');
          const noBookings = document.getElementById('no-bookings');
          if (container && noBookings) {
            container.classList.remove('hidden');
            container.innerHTML = `<div class="text-center text-gray-400 py-10 transition-opacity duration-300 ease-out">Ø±Ø²Ø±ÙˆÛŒ Ø¨Ø§ Ø§ÛŒÙ† ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</div>`;
            noBookings.classList.add('hidden');
          }
          return;
        }

        renderBookings(filtered);
      }

      // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
      function gregorianToJalali(gDate) {
        try {
          let date;
          if (typeof gDate === 'string') {
            // Handle different date formats
            if (gDate.includes('/')) {
              const parts = gDate.split('/');
              if (parts.length === 3) {
                date = new Date(parts[2], parts[1] - 1, parts[0]);
              } else {
                date = new Date(gDate);
              }
            } else {
              date = new Date(gDate);
            }
          } else {
            date = new Date(gDate);
          }

          if (isNaN(date.getTime())) {
            return gDate; // Return original if invalid
          }

          const gy = date.getFullYear();
          const gm = date.getMonth() + 1;
          const gd = date.getDate();

          const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
          let jy = (gy <= 1600) ? 0 : 979;
          gy > 1600 ? (jy += 1, gy -= 1601) : gy -= 621;
          const gy2 = (gm > 2) ? (gy + 1) : gy;
          let days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
          jy += 33 * (parseInt(days / 12053));
          days %= 12053;
          jy += 4 * (parseInt(days / 1461));
          days %= 1461;
          jy += parseInt((days - 1) / 365);
          if (days > 365) days = (days - 1) % 365;

          const jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
          const jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));

          const monthNames = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±', 'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'];
          return `${jd} ${monthNames[jm - 1]} ${jy}`;
        } catch (err) {
          console.error('Error converting date:', err);
          return gDate;
        }
      }

      // Render bookings to the page
      function renderBookings(bookings) {
        const container = document.getElementById('bookings-container');
        const noBookings = document.getElementById('no-bookings');

        if (!container || !noBookings) {
          return;
        }

        if (!bookings || bookings.length === 0) {
          container.classList.add('hidden');
          container.innerHTML = '';
          noBookings.classList.remove('hidden');
          return;
        }

        container.classList.remove('hidden');
        noBookings.classList.add('hidden');

        container.innerHTML = bookings.map(booking => {
          const sellerLink = getSellerLink(booking);
          const normalizedStatus = (booking.status || '').toLowerCase();
          const persianDate = gregorianToJalali(booking.bookingDate);

          return `
    <div class="booking-card fadein ${getBookingStatusClass(booking.status)}">
      <!-- Header Section -->
      <div class="booking-card-header">
        <div class="booking-service-icon-wrapper">
          <div class="booking-service-icon">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
        </div>
        <div class="booking-header-content">
          <div class="booking-service-name">
            <span class="booking-service-label">Ù†Ø§Ù… Ø®Ø¯Ù…Øª</span>
            <h3 class="booking-service-title">${escapeHtml(booking.service)}</h3>
          </div>
          <span class="${getStatusBadgeClass(booking.status)}">
            ${getStatusLabel(booking.status)}
          </span>
        </div>
      </div>

      <!-- Info Grid -->
      <div class="booking-info-grid">
        <div class="booking-info-item">
          <div class="booking-info-icon">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </div>
          <div class="booking-info-content">
            <span class="booking-info-label">ÙØ±ÙˆØ´Ú¯Ø§Ù‡</span>
            ${sellerLink ?
              `<a href="${sellerLink}" class="booking-info-value booking-info-link" target="_blank" rel="noopener noreferrer">
                ${escapeHtml(booking.sellerName || 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}
              </a>` :
              `<span class="booking-info-value missing-seller-link cursor-pointer">
                ${escapeHtml(booking.sellerName || 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}
              </span>`
            }
          </div>
        </div>

        <div class="booking-info-item">
          <div class="booking-info-icon">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
          <div class="booking-info-content">
            <span class="booking-info-label">ØªØ§Ø±ÛŒØ® Ø±Ø²Ø±Ùˆ</span>
            <span class="booking-info-value">${escapeHtml(persianDate)}</span>
          </div>
        </div>

        <div class="booking-info-item">
          <div class="booking-info-icon">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="booking-info-content">
            <span class="booking-info-label">Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹</span>
            <span class="booking-info-value">${escapeHtml(booking.startTime)}</span>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="booking-actions">
        <button type="button" data-booking-id="${booking._id}" class="booking-action-btn booking-action-btn--primary show-booking-details">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ø²Ø±Ùˆ</span>
        </button>
        ${(normalizedStatus === 'pending' || normalizedStatus === 'confirmed') ? `
          <button type="button" data-booking-id="${booking._id}" class="booking-action-btn booking-action-btn--danger cancel-booking">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>Ù„ØºÙˆ Ø±Ø²Ø±Ùˆ</span>
          </button>
        ` : ''}
        ${normalizedStatus === 'cancelled' ? `
          <button type="button" data-booking-id="${booking._id}" class="booking-action-btn booking-action-btn--ghost delete-booking">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            <span>Ø­Ø°Ù Ø¯Ø§Ø¦Ù…ÛŒ</span>
          </button>
        ` : ''}
      </div>
    </div>
  `;
        }).join('');

        // Add event listeners for booking action buttons
        container.querySelectorAll('.show-booking-details').forEach(btn => {
          btn.addEventListener('click', () => {
            const bookingId = btn.dataset.bookingId;
            showBookingDetails(bookingId);
          });
        });

        container.querySelectorAll('.cancel-booking').forEach(btn => {
          btn.addEventListener('click', () => {
            const bookingId = btn.dataset.bookingId;
            cancelBooking(bookingId);
          });
        });

        container.querySelectorAll('.delete-booking').forEach(btn => {
          btn.addEventListener('click', () => {
            const bookingId = btn.dataset.bookingId;
            deleteBooking(bookingId);
          });
        });

        container.querySelectorAll('.missing-seller-link').forEach(span => {
          span.addEventListener('click', () => {
            alert('Ù„ÛŒÙ†Ú© ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª');
          });
        });
      }

      function getBookingStatusClass(status) {
        const classes = {
          'pending': 'booking-card--pending',
          'confirmed': 'booking-card--confirmed',
          'completed': 'booking-card--completed',
          'cancelled': 'booking-card--cancelled'
        };
        const key = (status || '').toLowerCase();
        return classes[key] || 'booking-card--default';
      }

      function getStatusBadgeClass(status) {
        const classes = {
          'pending': 'status-badge status-badge--pending',
          'confirmed': 'status-badge status-badge--confirmed',
          'completed': 'status-badge status-badge--completed',
          'cancelled': 'status-badge status-badge--cancelled'
        };
        const key = (status || '').toLowerCase();
        return classes[key] || 'status-badge status-badge--default';
      }

      function getStatusLabel(status) {
        const labels = {
          'pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯',
          'confirmed': 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡',
          'completed': 'Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡',
          'cancelled': 'Ù„ØºÙˆ Ø´Ø¯Ù‡'
        };
        const key = (status || '').toLowerCase();
        return labels[key] || (status || 'Ù†Ø§Ù…Ø´Ø®Øµ');
      }

      function getSellerLink(booking) {
        if (!booking) return '';

        const slug = typeof booking.sellerUrl === 'string'
          ? booking.sellerUrl.trim()
          : '';
        if (slug) {
          return `/service-shops.html?shopurl=${encodeURIComponent(slug)}`;
        }

        let sellerId = booking.sellerId;
        if (sellerId && typeof sellerId === 'object') {
          if (sellerId._id || sellerId.id) {
            sellerId = sellerId._id || sellerId.id;
          } else if (typeof sellerId.toString === 'function') {
            sellerId = sellerId.toString();
          } else {
            sellerId = '';
          }
        }
        if (typeof sellerId === 'string' && sellerId.trim()) {
          return `/service-shops.html?sellerId=${encodeURIComponent(sellerId.trim())}`;
        }

        return '';
      }

      async function cancelBooking(id) {
        if (!id) return;

        const confirmed = window.confirm('Ø¢ÛŒØ§ Ø§Ø² Ù„ØºÙˆ Ø§ÛŒÙ† Ø±Ø²Ø±Ùˆ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ');
        if (!confirmed) return;

        const token = localStorage.getItem('token');
        if (!token) {
          alert('Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø±Ø²Ø±Ùˆ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.');
          return;
        }

        try {
          const response = await fetch(`/api/bookings/${encodeURIComponent(id)}/cancel`, {
            method: 'PUT',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const message = errorData.message || 'Ù„ØºÙˆ Ø±Ø²Ø±Ùˆ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.';
            alert(message);
            return;
          }

          bookingsData = Array.isArray(bookingsData)
            ? bookingsData.map(booking => booking._id === id ? { ...booking, status: 'cancelled' } : booking)
            : [];
          allBookings = bookingsData;

          filterBookings(currentBookingFilter || 'all');
          updateBookingsBadge();

          alert('Ø±Ø²Ø±Ùˆ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ØºÙˆ Ø´Ø¯.');
        } catch (error) {
          console.error('cancelBooking error:', error);
          alert('Ù„ØºÙˆ Ø±Ø²Ø±Ùˆ Ø¨Ø§ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.');
        }
      }

      async function deleteBooking(id) {
        if (!id) return;

        const confirmed = window.confirm('Ø¨Ø§ Ø­Ø°Ù Ø¯Ø§Ø¦Ù…ÛŒØŒ Ø§Ù…Ú©Ø§Ù† Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§ÛŒÙ† Ø±Ø²Ø±Ùˆ ÙˆØ¬ÙˆØ¯ Ù†Ø®ÙˆØ§Ù‡Ø¯ Ø¯Ø§Ø´Øª. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ');
        if (!confirmed) return;

        const token = localStorage.getItem('token');
        if (!token) {
          alert('Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø±Ø²Ø±Ùˆ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.');
          return;
        }

        try {
          const response = await fetch(`/api/bookings/${encodeURIComponent(id)}`, {
            method: 'DELETE',
            credentials: 'include',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const message = errorData.message || 'Ø­Ø°Ù Ø±Ø²Ø±Ùˆ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.';
            alert(message);
            return;
          }

          bookingsData = Array.isArray(bookingsData)
            ? bookingsData.filter(booking => booking._id !== id)
            : [];
          allBookings = bookingsData;

          filterBookings(currentBookingFilter || 'all');
          updateBookingsBadge();

          alert('Ø±Ø²Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ø­Ø°Ù Ø´Ø¯.');
        } catch (error) {
          console.error('deleteBooking error:', error);
          alert('Ø­Ø°Ù Ø±Ø²Ø±Ùˆ Ø¨Ø§ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.');
        }
      }

      // Show booking details modal
      function showBookingDetails(bookingId) {
        if (!bookingId) return;

        // Find the booking in our data
        const booking = allBookings.find(b => b._id === bookingId);
        if (!booking) {
          alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø²Ø±Ùˆ ÛŒØ§ÙØª Ù†Ø´Ø¯');
          return;
        }

        // Format created date in Persian if available
        let createdDate = 'Ù†Ø§Ù…Ø´Ø®Øµ';
        if (booking.createdAt) {
          try {
            const date = new Date(booking.createdAt);
            createdDate = date.toLocaleDateString('fa-IR', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch (e) {
            createdDate = booking.createdAt;
          }
        }

        // Format booking date to Shamsi (Persian) calendar
        let bookingDateShamsi = booking.bookingDate;
        if (booking.bookingDate) {
          try {
            // Try to parse the date - it might be in format like "2024-01-15" or "15/01/2024"
            let dateObj;
            if (booking.bookingDate.includes('-')) {
              // Format: YYYY-MM-DD
              dateObj = new Date(booking.bookingDate);
            } else if (booking.bookingDate.includes('/')) {
              // Format: DD/MM/YYYY or MM/DD/YYYY
              const parts = booking.bookingDate.split('/');
              if (parts.length === 3) {
                // Assume DD/MM/YYYY format
                dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
              }
            }

            if (dateObj && !isNaN(dateObj.getTime())) {
              bookingDateShamsi = dateObj.toLocaleDateString('fa-IR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              });
            }
          } catch (e) {
            // Keep original value if conversion fails
            bookingDateShamsi = booking.bookingDate;
          }
        }

        // Remove any existing modal
        document.getElementById('bookingDetailsModal')?.remove();

        const isMobileViewport = window.matchMedia('(max-width: 640px)').matches;
        const modalMaxHeight = isMobileViewport ? '98vh' : '92vh';
        const contentOffset = isMobileViewport ? 120 : 180;
        const contentMaxHeight = `calc(${modalMaxHeight} - ${contentOffset}px)`;

        // Create and insert modal
        document.body.insertAdjacentHTML('beforeend', `
          <div id="bookingDetailsModal" class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4" style="z-index:9999;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);animation:fadein .2s">
            <div class="bg-gradient-to-br from-white to-gray-50 rounded-t-3xl sm:rounded-3xl w-full sm:max-w-[650px] overflow-hidden shadow-2xl" style="z-index:10000;animation:slideUp .3s ease-out;max-height:${modalMaxHeight}">

              <!-- Header with Gradient -->
              <div class="sticky top-0 bg-gradient-to-r from-blue-600 via-blue-500 to-indigo-600 px-6 py-5 flex justify-between items-center shadow-lg" style="z-index:100">
                <div class="flex items-center gap-3">
                  <div class="bg-white/20 backdrop-blur-sm p-2 rounded-xl">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <h2 class="text-xl sm:text-2xl font-bold text-white drop-shadow-sm">Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ø²Ø±Ùˆ</h2>
                </div>
                <button class="close-booking-modal text-white/90 hover:text-white hover:bg-white/20 rounded-xl p-2.5 transition-all duration-200 backdrop-blur-sm">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>

              <!-- Content with Card Design -->
              <div class="p-5 sm:p-7 space-y-5 pb-28 sm:pb-7 overflow-y-auto" style="max-height:${contentMaxHeight}">

                <!-- Service Card -->
                <div class="bg-white rounded-2xl p-5 shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200">
                  <div class="flex items-start gap-3">
                    <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-2.5 rounded-xl shadow-md flex-shrink-0">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Ø®Ø¯Ù…Øª Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ</div>
                      <div class="text-gray-900 text-lg font-bold">${escapeHtml(booking.service)}</div>
                    </div>
                  </div>
                </div>

                <!-- Shop Card -->
                <div class="bg-white rounded-2xl p-5 shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200">
                  <div class="flex items-start gap-3">
                    <div class="bg-gradient-to-br from-purple-500 to-pink-600 p-2.5 rounded-xl shadow-md flex-shrink-0">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">ÙØ±ÙˆØ´Ú¯Ø§Ù‡</div>
                      <div class="text-gray-800">
                        ${(() => {
                          const sellerLink = getSellerLink(booking);
                          if (sellerLink) {
                            return `<a href="${sellerLink}"
                                       class="text-blue-600 hover:text-blue-700 font-semibold inline-flex items-center gap-2 hover:gap-3 transition-all group"
                                       target="_blank" rel="noopener noreferrer">
                                      ${escapeHtml(booking.sellerName || 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}
                                      <svg class="w-4 h-4 group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                      </svg>
                                    </a>`;
                          }
                          return `<span class="font-semibold text-gray-900">${escapeHtml(booking.sellerName || 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}</span>`;
                        })()}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Date & Time Card -->
                <div class="bg-white rounded-2xl p-5 shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200">
                  <div class="flex items-start gap-3">
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 p-2.5 rounded-xl shadow-md flex-shrink-0">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Ø²Ù…Ø§Ù† Ø±Ø²Ø±Ùˆ</div>
                      <div class="space-y-3">
                        <div class="flex items-center gap-3 bg-gray-50 rounded-xl p-3">
                          <div class="bg-white p-2 rounded-lg shadow-sm">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                          </div>
                          <span class="text-gray-900 font-semibold">${escapeHtml(bookingDateShamsi)}</span>
                        </div>
                        <div class="flex items-center gap-3 bg-gray-50 rounded-xl p-3">
                          <div class="bg-white p-2 rounded-lg shadow-sm">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                          </div>
                          <span class="text-gray-900 font-semibold">${escapeHtml(booking.startTime)}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Status Card -->
                <div class="bg-white rounded-2xl p-5 shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200">
                  <div class="flex items-start gap-3">
                    <div class="bg-gradient-to-br from-orange-500 to-red-600 p-2.5 rounded-xl shadow-md flex-shrink-0">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">ÙˆØ¶Ø¹ÛŒØª Ø±Ø²Ø±Ùˆ</div>
                      <span class="inline-flex items-center px-4 py-2 rounded-xl text-sm font-bold shadow-sm ${getStatusBadgeClass(booking.status)}">
                        ${getStatusLabel(booking.status)}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Created Date Card -->
                <div class="bg-white rounded-2xl p-5 shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200">
                  <div class="flex items-start gap-3">
                    <div class="bg-gradient-to-br from-gray-500 to-gray-700 p-2.5 rounded-xl shadow-md flex-shrink-0">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </div>
                    <div class="flex-1">
                      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª Ø±Ø²Ø±Ùˆ</div>
                      <div class="text-gray-800 font-semibold">${escapeHtml(createdDate)}</div>
                    </div>
                  </div>
                </div>

                ${booking.customerName || booking.customerPhone ? `
                  <!-- Customer Info Card -->
                  <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-5 shadow-md border border-blue-100 hover:shadow-lg transition-shadow duration-200">
                    <div class="flex items-start gap-3">
                      <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-2.5 rounded-xl shadow-md flex-shrink-0">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                      </div>
                      <div class="flex-1">
                        <div class="text-xs font-bold text-blue-700 uppercase tracking-wider mb-3">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ</div>
                        <div class="space-y-2.5">
                          ${booking.customerName ? `
                            <div class="flex items-center gap-2 bg-white rounded-lg p-3 shadow-sm">
                              <svg class="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                              </svg>
                              <span class="text-gray-600 text-sm font-medium">Ù†Ø§Ù…:</span>
                              <span class="text-gray-900 font-semibold">${escapeHtml(booking.customerName)}</span>
                            </div>
                          ` : ''}
                          ${booking.customerPhone ? `
                            <div class="flex items-center gap-2 bg-white rounded-lg p-3 shadow-sm">
                              <svg class="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                              </svg>
                              <span class="text-gray-600 text-sm font-medium">ØªÙ„ÙÙ†:</span>
                              <span class="text-gray-900 font-semibold font-mono">${escapeHtml(booking.customerPhone)}</span>
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  </div>
                ` : ''}

              </div>

              <!-- Footer - Mobile Fixed with Gradient -->
              <div class="fixed sm:sticky bottom-0 left-0 right-0 bg-gradient-to-t from-white via-white to-transparent px-6 pt-4 pb-5 border-t border-gray-200 sm:rounded-b-3xl backdrop-blur-sm" style="box-shadow: 0 -4px 20px rgba(0,0,0,0.08);padding-bottom:calc(env(safe-area-inset-bottom,0px) + 20px)">
                <button
                  class="close-booking-modal w-full sm:w-auto px-8 py-3.5 bg-gradient-to-r from-gray-700 to-gray-900 text-white rounded-xl hover:from-gray-800 hover:to-black transition-all font-bold shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98] duration-200">
                  Ø¨Ø³ØªÙ†
                </button>
              </div>

            </div>
          </div>
        `);

        // Add event listeners for modal close buttons
        document.querySelectorAll('.close-booking-modal').forEach(btn => {
          btn.addEventListener('click', closeBookingDetails);
        });

        // Also close when clicking the backdrop
        const modal = document.getElementById('bookingDetailsModal');
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeBookingDetails();
            }
          });
        }

        // Close on ESC key
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            closeBookingDetails();
          }
        };
        document.addEventListener('keydown', handleEscape);

        // Store handler for cleanup
        modal._escapeHandler = handleEscape;
      }

      // Close booking details modal
      function closeBookingDetails() {
        const modal = document.getElementById('bookingDetailsModal');
        if (modal && modal._escapeHandler) {
          document.removeEventListener('keydown', modal._escapeHandler);
        }
        modal?.remove();
      }

      // Helper to escape HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text == null ? '' : String(text);
        return div.innerHTML;
      }

      // Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
  const dashboardSection = `
  <div class="glass flex flex-col md:flex-row items-center justify-between px-5 md:px-8 py-5 md:py-7 fadein gap-3 md:gap-0">
    <div>
      <div class="text-xl md:text-2xl font-black primary-text mb-1">ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ Ú©Ø§Ø±Ø¨Ø± Ø¹Ø²ÛŒØ²!</div>
      <div class="text-gray-500 text-sm md:text-base">Ø§Ù…ÛŒØ¯ÙˆØ§Ø±ÛŒÙ… ØªØ¬Ø±Ø¨Ù‡â€ŒÛŒ Ø®ÙˆØ¨ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.</div>
    </div>
  </div>
  <div class="glass p-5 md:p-7 fadein">
    <h2 class="text-base md:text-lg font-bold text-gray-700 mb-4 md:mb-5">Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹</h2>
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-4">
      <!-- Ø±Ø²Ø±Ùˆ Ø®Ø¯Ù…Ø§Øª -->
      <a href="/service-directory.html" class="quick-action">
        <svg class="quick-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
          <path d="M8 14h.01"></path>
          <path d="M12 14h.01"></path>
          <path d="M16 14h.01"></path>
          <path d="M8 18h.01"></path>
          <path d="M12 18h.01"></path>
        </svg>
        <span class="quick-action-label">Ø±Ø²Ø±Ùˆ Ø®Ø¯Ù…Ø§Øª</span>
      </a>

      <!-- ÙØ±ÙˆØ´Ú¯Ø§Ù‡ / Ù…Ø­ØµÙˆÙ„Ø§Øª -->
      <a href="/all-products.html" class="quick-action">
        <svg class="quick-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        <span class="quick-action-label">ÙØ±ÙˆØ´Ú¯Ø§Ù‡ / Ù…Ø­ØµÙˆÙ„Ø§Øª</span>
      </a>

      <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
      <button type="button" class="quick-action" data-section="messages">
        <svg class="quick-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          <line x1="9" y1="10" x2="15" y2="10"></line>
          <line x1="9" y1="14" x2="13" y2="14"></line>
        </svg>
        <span class="quick-action-label">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</span>
      </button>

      <!-- Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ -->
      <button type="button" class="quick-action" data-section="favorites">
        <svg class="quick-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
        <span class="quick-action-label">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</span>
      </button>

      <!-- Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒ Ù…Ù† -->
      <button type="button" class="quick-action" data-section="bookings">
        <svg class="quick-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <span class="quick-action-label">Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒ Ù…Ù†</span>
      </button>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø¨ÛŒØ´ØªØ± -->
  <div id="moreActionsModal" class="more-actions-modal">
    <div class="more-actions-content">
      <div class="more-actions-header">
        <h3 class="text-lg font-bold text-gray-800">Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø¨ÛŒØ´ØªØ±</h3>
        <button type="button" class="more-actions-close" id="closeMoreActions">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="more-actions-grid">
        <!-- Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒ Ù…Ù† -->
        <button type="button" class="more-action-item" data-section="bookings">
          <svg class="more-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          <span>Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒ Ù…Ù†</span>
        </button>

        <!-- ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ -->
        <a href="/all-shops.html" class="more-action-item">
          <svg class="more-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          <span>ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§</span>
        </a>

        <!-- Ø¬Ø³ØªØ¬Ùˆ -->
        <a href="/search.html" class="more-action-item">
          <svg class="more-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <span>Ø¬Ø³ØªØ¬Ùˆ</span>
        </a>

        <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
        <button type="button" class="more-action-item" data-section="profile">
          <svg class="more-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m5.2-13.2l-4.2 4.2m0 6l-4.2 4.2M23 12h-6m-6 0H5m13.2 5.2l-4.2-4.2m0-6l-4.2-4.2"></path>
          </svg>
          <span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
        </button>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-5 fadein">
    <div id="favBoxClick" class="glass p-6 flex flex-col items-center text-center min-h-[135px] justify-center cursor-pointer hover:shadow-lg transition">
      <div class="text-[#0ea5e9] font-bold text-base mb-1">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</div>
      <div class="text-4xl font-black primary-text mb-1" id="favCountDashboard">-</div>
    <a href="#" class="text-xs font-bold text-[#0ea5e9] hover:underline menu-btn mt-2" data-section="favorites">Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª</a>
    </div>
    <div id="recentFavsContainerWrapper" class="flex flex-col">
      <div id="recentFavsContainer"></div>
    </div>
  </div>
  `;





  function setupQuickActions() {
    // Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø³Ø±ÛŒØ¹ Ø¨Ø§ data-section
    document.querySelectorAll('.quick-action[data-section]').forEach(action => {
      action.addEventListener('click', (event) => {
        event.preventDefault();
        const target = action.getAttribute('data-section');
        if (target) {
          showSection(target);
        }
      });
    });

    // Ø¯Ú©Ù…Ù‡ "Ø¨ÛŒØ´ØªØ±..."
    const moreBtn = document.getElementById('moreActionsBtn');
    const modal = document.getElementById('moreActionsModal');
    const closeBtn = document.getElementById('closeMoreActions');

    if (moreBtn && modal) {
      moreBtn.addEventListener('click', () => {
        modal.classList.add('active');
      });
    }

    if (closeBtn && modal) {
      closeBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });
    }

    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    }

    // Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„
    document.querySelectorAll('.more-action-item[data-section]').forEach(item => {
      item.addEventListener('click', (event) => {
        event.preventDefault();
        const target = item.getAttribute('data-section');
        if (target) {
          modal.classList.remove('active');
          showSection(target);
        }
      });
    });

    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§ Ú©Ù„ÛŒØ¯ ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal && modal.classList.contains('active')) {
        modal.classList.remove('active');
      }
    });
  }

  async function renderRecentFavorites() {
    const container = document.getElementById('recentFavsContainer');
    container.innerHTML = `
      <div class="glass px-6 py-5 fadein">
        <div class="flex items-center justify-between mb-4">
          <span id="recentFavsTitle" class="text-lg font-bold primary-text cursor-pointer">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± Ø´Ù…Ø§</span>
          <a href="#" id="recentFavsShowAll" class="text-[#0ea5e9] hover:underline font-bold text-sm menu-btn">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡</a>
        </div>
        <div class="flex flex-wrap gap-3 scrollbar-hide overflow-x-auto" id="recentFavsList">
          <div class="text-gray-400 text-center w-full py-3">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ...</div>
        </div>
      </div>
    `;

    try {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ú©ÙˆÚ©ÛŒ Ùˆ Ø¨Ø¯ÙˆÙ† Ù‡Ø¯Ø± Authorization
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include', // Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ (ØªÙˆÚ©Ù†) Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!res.ok) throw new Error();

      const user = await res.json();
      const favs = Array.isArray(user.favorites) ? user.favorites : [];

      const favsList = container.querySelector("#recentFavsList");
      if (favs.length === 0) {
        favsList.innerHTML = `<div class="text-gray-400 text-center w-full py-3">Ù‡Ù†ÙˆØ² Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯ÛŒ!</div>`;
      } else {
        favsList.innerHTML = favs.slice(-3).reverse().map(p => {
          const shop = (p.sellerId && typeof p.sellerId === 'object') ? p.sellerId : {};
          return `
            <div class="min-w-[170px] max-w-xs bg-[#e0fdfa] rounded-xl p-3 flex flex-col items-center text-center">
              <img src="${(p.images && p.images[0]) ? p.images[0] : '/assets/images/noimage.png'}" class="w-20 h-20 object-cover rounded-xl mb-2 shadow" alt="${p.title || ''}"/>
              <span class="text-[#10b981] text-base font-bold mb-1">${p.title || '-'}</span>
              <span class="text-xs text-gray-500 mb-1">${shop.storename ? `ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ${shop.storename}` : ''}</span>
              <span class="text-xs text-gray-600 mb-1">Ù‚ÛŒÙ…Øª: ${p.price ? p.price.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†' : '-'}</span>
              <a href="http://localhost:5000/product.html?id=${p._id}" class="mt-2 px-4 py-1.5 rounded-lg brand-btn text-xs font-bold inline-block" target="_blank" rel="noopener noreferrer">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø­ØµÙˆÙ„</a>
            </div>
          `;
        }).join('');
      }
    } catch (e) {
      const favsList = container.querySelector("#recentFavsList");
      favsList.innerHTML = `<div class="text-red-400 text-center w-full py-3">Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.</div>`;
    }
  }






      // Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† SPA Ùˆ Ø±Ø³Ù¾Ø§Ù†Ø³ÛŒÙˆ
  function showSection(section) {
    const mainContent = document.getElementById('mainContent');
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ù…Ù†ÙˆÙ‡Ø§
    document.querySelectorAll('.menu-btn').forEach(btn=>btn.classList.remove('tab-active'));
    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù…Ù†ÙˆÛŒ ÙØ¹Ù„ÛŒ
  document.querySelectorAll(`.menu-btn[data-section="${section}"]`).forEach(btn => btn.classList.add('tab-active'));
    // Ù…Ø­ØªÙˆØ§
    if(section === 'dashboard') {
      mainContent.innerHTML = dashboardSection;
      setupQuickActions();
      renderRecentFavorites(); // Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù†Ø¯Ø± Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø±Ùˆ ØµØ¯Ø§ Ø¨Ø²Ù†
      updateDashboardFavCount(); // Ø§ÛŒÙ†Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† ØªØ§ ØªØ¹Ø¯Ø§Ø¯ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ø¯Ø±Ø³Øª Ø¨Ø´Ù‡
    }
    else if(section === 'profile') loadProfileSection();
    else if(section === 'favorites') loadFavoritesSection();
    else if(section === 'favshops') loadFavShopsSection();
    else if(section === 'bookings') loadBookingsSection();
    else if(section === 'messages') loadMessagesSection();

    if(section === 'messages') startMsgPolling(); else stopMsgPolling();

    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¨Ø§Ù„Ø§
    mainContent.scrollIntoView({behavior:'smooth',block:'start'});
  }


  async function updateDashboardFavCount() {
    try {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ú©ÙˆÚ©ÛŒ (credentials: 'include')
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      if (!res.ok) {
        document.getElementById('favCountDashboard').textContent = '-';
        return;
      }
      const user = await res.json();
      document.getElementById('favCountDashboard').textContent =
        Array.isArray(user.favorites) ? user.favorites.length : '0';
    } catch (e) {
      document.getElementById('favCountDashboard').textContent = '-';
    }
  }


      // Ù…Ù†ÙˆÙ‡Ø§ÛŒ Ø¯Ø³Ú©ØªØ§Ù¾ Ùˆ Ù…ÙˆØ¨Ø§ÛŒÙ„

  /* â€”â€”â€” Ù‡Ù†Ø¯Ù„ Ù…Ù†ÙˆÙ‡Ø§ÛŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± (Ù…Ø³ØªÙ‚ÛŒÙ…) â€”â€”â€” */
  document.addEventListener('click', e => {
    const btn = e.target.closest('.menu-btn');
    if (!btn) return;
    e.preventDefault();
    showSection(btn.dataset.section);
    if (window.innerWidth < 1024) closeSidebar();
  });




      // Ø³ÙˆÛŒÛŒÚ† Ú©Ø±Ø¯Ù† Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
      document.getElementById('profileBtn').onclick=function(){
        showSection('profile');
        if(window.innerWidth<1024){
          openSidebar();
        }
      };

      // Ù‡Ù…Ø¨Ø±Ú¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
      function openSidebar(){
        markNotificationsViewed();
        document.getElementById('mobileSidebar').classList.add('open');
        document.getElementById('sidebarOverlay').classList.add('open');
        document.body.style.overflow='hidden';
      }
      function closeSidebar(){
        document.getElementById('mobileSidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('open');
        document.body.style.overflow='';
      }
      const hamBtn = document.getElementById('hamBtn');
      if (hamBtn) {
        hamBtn.addEventListener('click', openSidebar);
      }
      document.getElementById('closeSidebar').onclick = closeSidebar;
      document.getElementById('sidebarOverlay').onclick = closeSidebar;
      document.addEventListener('keydown', function(e){
        if(e.key === "Escape"){
          closeSidebar();
        }
      });





  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± (Ù…ÙˆØ¨Ø§ÛŒÙ„ + Ø¯Ø³Ú©ØªØ§Ù¾)
  async function updateSidebarUser() {
    try {
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',          // Ø§Ø±Ø³Ø§Ù„ ØªÙˆÚ©Ù† Ø§Ø² Ø·Ø±ÛŒÙ‚ Ú©ÙˆÚ©ÛŒ
        headers: { 'Content-Type': 'application/json' }
      });
      if (!res.ok) throw new Error();

      const user   = await res.json();

      /* â†™ï¸ Ø¢ÛŒâ€ŒØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ú†Øªâ€ŒÙ‡Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ… */
      window.currentUserId = user._id;     

      const first  = user.firstname || user.firstName || 'Ú©Ø§Ø±Ø¨Ø±';
      const last   = user.lastname  || user.lastName  || 'ÙˆÛŒØªØ±ÛŒÙ†Øª';
      const phone  = user.phone     || user.mobile    || '';
      const masked = phone
        ? phone.toString().slice(0, 4) + '***' + phone.toString().slice(-3)
        : '---';

      document.querySelectorAll('.sidebar-user-name')
              .forEach(el => (el.textContent = `${first} ${last}`));

      document.querySelectorAll('.sidebar-user-mobile')
              .forEach(el => (el.textContent = masked));

      window.currentUserPhone = phone;
      refreshBookingsBadge();
    } catch (_) {
      /* Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¨ÙˆØ¯ØŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø±Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø±Ù‡Ø§ Ú©Ù† */
    }
  }








  async function loadFavoritesSection() {
    let html = `<div class="glass px-6 py-7 fadein"><div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div></div>`;
    document.getElementById('mainContent').innerHTML = html;

    try {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ú©ÙˆÚ©ÛŒ (credentials: 'include')
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include', // Ù…Ù‡Ù…!
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });

      if (!res.ok) throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
      const user = await res.json();
      const favs = user.favorites;

      if (!Array.isArray(favs) || favs.length === 0) {
        html = `<div class="glass px-6 py-7 fadein text-center text-gray-400">Ù‡ÛŒÚ† Ù…Ø­ØµÙˆÙ„ÛŒ Ø¯Ø± Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ù†ÛŒØ³Øª.</div>`;
      } else {
        html = `
        <div class="glass px-6 py-7 fadein">
          <div class="text-xl font-black primary-text mb-5">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</div>
          <div class="flex flex-wrap gap-4">
            ${favs.map(p => {
              const shop = (p.sellerId && typeof p.sellerId === 'object') ? p.sellerId : {};
              return `
                <div class="min-w-[170px] max-w-xs bg-[#e0fdfa] rounded-xl p-3 flex flex-col items-center text-center">
                  <img src="${(p.images && p.images[0]) ? p.images[0] : '/assets/images/noimage.png'}" class="w-24 h-24 object-cover rounded-xl mb-2 shadow" alt="${p.title || ''}"/>
                  <span class="text-[#10b981] text-lg font-bold mb-1">${p.title || '-'}</span>
                  <span class="text-xs text-gray-500 mb-1">${shop.storename ? `ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ${shop.storename}` : ''}</span>
                  <span class="text-xs text-gray-600 mb-1">Ù‚ÛŒÙ…Øª: ${p.price ? p.price.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†' : '-'}</span>
                  <a href="http://localhost:5000/product.html?id=${p._id}" class="mt-2 px-4 py-1.5 rounded-lg brand-btn text-xs font-bold inline-block" target="_blank" rel="noopener noreferrer">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø­ØµÙˆÙ„</a>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        `;
      }
    } catch (e) {
      html = `<div class="glass px-6 py-7 fadein text-center text-red-400">${e.message}</div>`;
    }

    document.getElementById('mainContent').innerHTML = html;
  }

  async function loadFavShopsSection() {
    let html = `<div class="glass px-6 py-7 fadein"><div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div></div>`;
    document.getElementById('mainContent').innerHTML = html;

    try {
      const res = await fetch('/api/favorite-shops', {
        method: 'GET',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-cache' }
      });
      if (!res.ok) throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
      const shops = await res.json();

      if (!Array.isArray(shops) || shops.length === 0) {
        html = `<div class="glass px-6 py-7 fadein text-center text-gray-400">Ù‡ÛŒÚ† Ù…ØºØ§Ø²Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ù„ÛŒØ³Øª Ù…Ø­Ø¨ÙˆØ¨â€ŒÙ‡Ø§ Ù†ÛŒØ³Øª.</div>`;
      } else {
        html = `
        <div class="glass px-6 py-7 fadein">
          <div class="text-xl font-black primary-text mb-5">Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø¨ÙˆØ¨ Ù…Ù†</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            ${shops.map(s => `
              <div class="bg-white rounded-xl shadow border border-gray-100 p-4 flex flex-col gap-2 text-center">
                <span class="text-lg font-bold text-[#10b981]">${s.storename || '-'}</span>
                <span class="text-xs text-gray-500">${s.category || ''}</span>
                <button data-id="${s._id}" class="removeFavShop mt-2 px-3 py-1.5 rounded-lg bg-red-50 text-red-600 border border-red-100 text-sm">Ø­Ø°Ù Ø§Ø² Ù…Ø­Ø¨ÙˆØ¨â€ŒÙ‡Ø§</button>
              </div>
            `).join('')}
          </div>
        </div>`;
      }
    } catch (e) {
      html = `<div class="glass px-6 py-7 fadein text-center text-red-400">${e.message}</div>`;
    }

    document.getElementById('mainContent').innerHTML = html;

    document.querySelectorAll('.removeFavShop').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        btn.disabled = true;
        try {
          await fetch(`/api/favorite-shops/${id}`, { method: 'DELETE', credentials: 'include' });
          loadFavShopsSection();
        } catch { btn.disabled = false; }
      });
    });
  }




  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€  Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±  â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ø¨Ø®Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ú©Ø§Ø±Ø¨Ø± â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const API_BASE  = '/api';           // Ø·Ø¨Ù‚ Ø³Ø±ÙˆØ±Øª
  let chatsList   = [];               // Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§
  const LAST_NOTIF_KEY = 'userDashboard.lastNotificationsViewedAt';

  function getLastNotificationsViewedAt() {
    try {
      return Number(localStorage.getItem(LAST_NOTIF_KEY)) || 0;
    } catch (_) {
      return 0;
    }
  }

  function setLastNotificationsViewedNow() {
    try {
      localStorage.setItem(LAST_NOTIF_KEY, String(Date.now()));
    } catch (_) {
      /* ignore storage errors */
    }
  }
  let currentCid  = null;             // Ø¢ÛŒâ€ŒØ¯ÛŒ Ú†Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
  let blockedSellers = [];            // ÙØ±ÙˆØ´Ù†Ø¯Ú¯Ø§Ù† Ù…Ø³Ø¯ÙˆØ¯Ø´Ø¯Ù‡

async function loadMessagesSection() {
  const box = document.getElementById('mainContent');
  box.innerHTML = `
    <div id="messages-section" class="glass px-4 py-7 fadein">
      <div class="flex items-center justify-between mb-4">
        <span class="text-xl font-black primary-text">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ù†</span>
        <button class="open-admin-msg brand-btn text-sm px-3 py-1.5 rounded-xl">Ú†Øª Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª</button>
      </div>
      <div id="userChatsList" class="w-full min-h-[180px]"></div>
    </div>
  `;

  // Add event listener for admin message button
  const adminMsgBtn = document.querySelector('.open-admin-msg');
  if (adminMsgBtn) {
    adminMsgBtn.addEventListener('click', openAdminMsgModal);
  }

  await fetchBlockedSellers(); // ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø³Ø¯ÙˆØ¯Ø´Ø¯Ù‡ Ø±Ø§ Ø¨Ú¯ÛŒØ±
  await fetchUserChats();  // Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ Ø±Ùˆ Ø¨Ú¯ÛŒØ±
  renderMessagesList();    // Ø±Ù†Ø¯Ø± Ú©Ù†
  startMsgPolling();       // polling Ø´Ø±ÙˆØ¹ Ú©Ù†
}

  /* Ú¯Ø±ÙØªÙ† Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ */
  /*  Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ÛŒ *Ø®ÙˆØ¯Ù Ú©Ø§Ø±Ø¨Ø±*  */
/* Ú¯Ø±ÙØªÙ† Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (ÙÙ‚Ø· Ù„ÛŒØ³ØªØŒ Ø¨Ø¯ÙˆÙ† Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */
async function fetchUserChats() {
  try {
    const res = await fetch(`${API_BASE}/chats/my`, {
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();

    const allChats = Array.isArray(data) ? data : (data.chats || []);
    const uid = window.currentUserId;

    chatsList = allChats.filter(c => {
      if (!uid) return false;
      if (c.type === 'admin' || c.type === 'user-admin' || c.type === 'admin-user') return true;
      if (c.userId && c.userId === uid) return true;
      if (Array.isArray(c.participants) && c.participants.some(p => {
        if (!p) return false;
        return (typeof p === 'string' && p === uid) ||
               (typeof p === 'object' && p._id === uid);
      })) return true;
      if (Array.isArray(c.users) && c.users.some(u => u._id === uid)) return true;
      return false;
    });


  } catch (e) {
    chatsList = [];
  }
}

async function loadMessages() {
  try {
    await fetchUserChats();
    updateBadge();
  } catch (error) {
    console.error('Error loading messages:', error);
  }
}


  /* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
function renderMessagesList() {
  const box = document.getElementById('userChatsList');
  console.log("Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§:", chatsList);

  if (!chatsList.length) {
    box.innerHTML = `<div class="text-gray-400 text-center py-8">Ù‡ÛŒÚ† Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒ! Ø§Ø² Ø¯Ú©Ù…Ù‡ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.</div>`;
    return;
  }

  // Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ
  const myId = window.currentUserId;

  box.innerHTML = chatsList.map(c => {
    console.log('Ø³Ø§Ø®ØªØ§Ø± Ú†Øª Ø¯Ø± Ù„ÛŒØ³Øª:', c._id, c);

    let whom = 'Ù…Ø®Ø§Ø·Ø¨'; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    let role = '';
    let sellerId = null;
    let storeName = '';
    let shopUrl = '';
    let isBlocked = false;

    if (Array.isArray(c.participants)) {
      const participant = c.participants.find(p => p && p._id !== myId);
      if (participant) {
        role = participant.role;
        sellerId = participant._id;
        storeName = participant.storename || '';
        shopUrl = participant.shopurl || '';
        whom = role === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : (role === 'admin' ? 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª' : (role === 'user' ? 'Ù…Ø´ØªØ±ÛŒ' : 'Ù…Ø®Ø§Ø·Ø¨'));
      }
    }

    if (role === 'seller' && sellerId) {
      isBlocked = blockedSellers.includes(sellerId);
    }

    if (!role && Array.isArray(c.participantsModel)) {
      if (c.participantsModel.includes('Admin')) {
        role = 'admin';
        whom = 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
      } else if (c.participantsModel.includes('Seller')) {
        role = 'seller';
        whom = 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
      }
    }

    // fallback Ø§Ø² type
    if (!role && c.type) {
      if (c.type === 'user-seller' || c.type === 'seller-admin') {
        whom = 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
        role = 'seller';
        sellerId = c.sellerId;
    } else if (c.type === 'user-admin' || c.type === 'admin-user' || c.type === 'admin') {
      whom = 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
      role = 'admin';
    }
    }

    let whomDisplay = whom;
    if (role === 'seller' && sellerId) {
      const linkUrl = shopUrl ? `/store/${shopUrl}` : `/store.html?id=${sellerId}`;
      const linkText = storeName ? `ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (${storeName})` : 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
      whomDisplay = `<a href="${linkUrl}" class="text-[#10b981] hover:text-blue-700 hover:underline font-semibold" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
    }

let prodBlock = '';
if (c.productId && c.productId.title) {
  const productUrl = `/product.html?id=${c.productId._id}`;
  prodBlock = `
    <div class="flex items-center gap-2 mt-2">
      <!-- ÙÙ‚Ø· Ø¹Ú©Ø³ Ù„ÛŒÙ†Ú©â€ŒØ¯Ø§Ø± -->
      <a href="${productUrl}" target="_blank" rel="noopener noreferrer">
        <img src="${c.productId.images?.[0] || '/assets/images/noimage.png'}" 
             class="w-10 h-10 object-cover rounded-lg border" alt="">
      </a>
      <!-- Ø§Ø³Ù… Ù…Ø­ØµÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ù„ÛŒÙ†Ú© -->
      <span class="text-xs text-gray-600">${c.productId.title}</span>
    </div>
  `;
}


    const last = c.messages?.[c.messages.length - 1] || {};
    const txt = (last.text || '-').slice(0, 45) + (last.text?.length > 45 ? 'â€¦' : '');
    const date = last.createdAt
      ? new Date(last.createdAt).toLocaleDateString('fa-IR', { year: '2-digit', month: '2-digit', day: '2-digit' })
      : 'â€”';
    const unread = (c.messages || []).filter(m => !m.read && m.from !== 'user').length;

    let avatarText = 'ØŸ';
    if (whom && typeof whom === 'string') {
      avatarText = whom.slice(0, 2);
    }

return `
  <div class="chat-card flex items-start gap-3 p-3 mb-2 bg-[#f9fafb] rounded-xl shadow-sm hover:bg-[#e6fcf7] cursor-pointer transition ${isBlocked ? 'opacity-50' : ''}"
       data-chat-id="${c._id}">

    <!-- Ø¢ÙˆØ§ØªØ§Ø± -->
    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#0ea5e9] to-[#10b981]
                flex items-center justify-center text-white font-bold text-lg shrink-0">
      ${avatarText}
    </div>

    <!-- Ø¨Ø¯Ù†Ù‡ -->
    <div class="flex-1 min-w-0">

      <!-- â¶ Ù‡ÙØ¯ÙØ± Ú©Ø§Ø±Øª: Ø§Ø³Ù… + Ù†Ø´Ø§Ù† unread Ø³Ù…Øª Ø±Ø§Ø³ØªØŒ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ø³Ù…Øª Ú†Ù¾  -->
      <div class="flex items-center justify-between flex-wrap gap-2">

        <!-- Ú¯Ø±ÙˆÙ‡Ù Ø§Ø³Ù… Ùˆ Ù†Ø´Ø§Ù† -->
        <div class="flex items-center gap-2">
          <span class="font-bold primary-text">${whomDisplay}</span>
          ${
            unread
              ? `<span class="inline-flex items-center justify-center
                         bg-red-500 text-white rounded-full w-5 h-5 text-xs">
                     ${unread}
                 </span>`
              : ""
          }
        </div>

        <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
        <div class="flex items-center gap-1">
          <button
            class="delete-chat px-2 py-0.5 text-xs rounded-xl bg-red-50 text-red-600 border border-red-100
                   hover:bg-red-200 hover:text-red-900 transition"
            data-chat-id="${c._id}">
            Ø­Ø°Ù
          </button>
          ${role === 'seller' && !isBlocked ? `<button class="block-seller px-2 py-0.5 text-xs rounded-xl bg-gray-100 text-gray-600 border border-gray-200 hover:bg-gray-200 transition" data-seller-id="${sellerId}">Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</button>` : ''}
          ${role === 'seller' && isBlocked ? `<span class="text-xs text-red-500">Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡</span>` : ''}
        </div>
      </div>

      ${prodBlock}
      <div class="text-sm text-gray-700 mt-2">${txt}</div>
      <div class="text-xs text-gray-400 mt-1">${date}</div>
    </div>
  </div>
`;

  }).join('');

  // Add event listeners for chat cards and buttons
  setTimeout(() => {
    // Chat card click listeners
    document.querySelectorAll('.chat-card').forEach(card => {
      card.addEventListener('click', (e) => {
        // Don't open chat if clicking on buttons
        if (e.target.closest('.delete-chat') || e.target.closest('.block-seller')) {
          return;
        }
        const chatId = card.dataset.chatId;
        openChat(chatId);
      });
    });

    // Delete chat button listeners
    document.querySelectorAll('.delete-chat').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const chatId = btn.dataset.chatId;
        deleteChat(chatId);
      });
    });

    // Block seller button listeners
    document.querySelectorAll('.block-seller').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const sellerId = btn.dataset.sellerId;
        blockSeller(sellerId);
      });
    });
  }, 0);
}




  /* Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
  /* Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ú†Øª (Ø¨Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„) */
async function openChat(cid) {
  currentCid = cid;
  await showChatModal();
}

  /* Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù…Ø¯ÛŒØ± (Ø§ÛŒØ¬Ø§Ø¯ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§ Ù†Ø¯Ø§Ø±Ù‡) */
  // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ú¯ÙØªÚ¯ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…Ø¯ÛŒØ± (Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡)
async function openAdminMsgModal() {
  const uid = window.currentUserId;
  if (!uid) return alert('Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!');

  // Ø§ÙˆÙ„ Ú†Øª Ø¨Ø§ admin Ø±Ùˆ ensure Ú©Ù† (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Ø¨Ø³Ø§Ø²)
  try {
    const res = await fetch(`${API_BASE}/chats/ensure`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recipientRole: 'admin' })  // Ø¨Ø¯ÙˆÙ† recipientIdØŒ Ú†ÙˆÙ† admin Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    });
    if (!res.ok) throw new Error('Ø¯Ø±ÛŒØ§ÙØª/Ø§ÛŒØ¬Ø§Ø¯ Ú†Øª Ø¨Ø§ Ù…Ø¯ÛŒØ± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
    const chat = await res.json();
    currentCid = chat._id;  // chatId Ø±Ùˆ Ø³Øª Ú©Ù†
    showChatModal();        // Ù…ÙˆØ¯Ø§Ù„ Ø±Ùˆ Ø¨Ø§Ø² Ú©Ù† (Ú©Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ùˆ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù‡)
  } catch (err) {
    alert('Ø®Ø·Ø§: ' + err.message);
  }
}

  function closeAdminMsg() {
    document.getElementById('adminMsgModal')?.remove();
  }

  async function showAdminMsgModal(uid) {
    document.getElementById('adminMsgModal')?.remove();
    document.body.insertAdjacentHTML('beforeend', `
      <div id="adminMsgModal" class="fixed inset-0 z-50 flex items-center justify-center" style="backdrop-filter:blur(4px);background:#0003;animation:fadein .25s">
        <div class="bg-white rounded-2xl w-[98vw] max-w-md max-h-[93vh] flex flex-col shadow-xl border">
          <div class="px-4 py-3 border-b flex justify-between items-center">
            <span class="font-bold primary-text">Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª</span>
            <button class="close-admin-msg text-2xl font-black text-gray-400 hover:text-red-500 rounded-full w-8 h-8 flex items-center justify-center">Ã—</button>
          </div>
          <div id="adminMsgBody" class="flex-1 overflow-y-auto p-4 space-y-4 text-[15px] scrollbar-hide bg-[#f9fafb]"></div>
          <div class="border-t p-3 flex gap-2 bg-white">
            <textarea id="adminMsgInput" rows="2" class="flex-1 border rounded-xl p-2 resize-none focus:outline-none" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"></textarea>
            <button class="send-admin-msg brand-btn px-5 py-2 rounded-xl font-bold shrink-0">Ø§Ø±Ø³Ø§Ù„</button>
          </div>
        </div>
      </div>
    `);

    // Add event listeners for admin modal buttons
    const closeBtn = document.querySelector('.close-admin-msg');
    if (closeBtn) {
      closeBtn.addEventListener('click', closeAdminMsg);
    }

    const sendBtn = document.querySelector('.send-admin-msg');
    if (sendBtn) {
      sendBtn.addEventListener('click', sendAdminMsg);
    }

    // Also allow sending message with Enter key
    const msgInput = document.getElementById('adminMsgInput');
    if (msgInput) {
      msgInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendAdminMsg();
        }
      });
    }

    renderAdminMsgs(uid);
  }

  async function renderAdminMsgs(uid) {
    const box = document.getElementById('adminMsgBody');
    if (!box) return;
    box.innerHTML = '<div class="text-center text-gray-400 py-6">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div>';
    try {
      const token = document.cookie.split('; ').find(r => r.startsWith('user_token='))?.split('=')[1];
      const res = await fetch(`${API_BASE}/messages/${uid}`, {
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { Authorization: 'Bearer ' + token })
        }
      });
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) throw new Error('Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²');
        throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙØªÚ¯Ùˆ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
      }
      let data = await res.json();
      if (!Array.isArray(data)) data = [];
      data.sort((a,b)=> new Date(a.timestamp || a.createdAt) - new Date(b.timestamp || b.createdAt));
      box.innerHTML = data.map(m => {
        const rawRole =
          m.senderRole ||
          m.senderId?.role ||
          (typeof m.senderModel === 'string' ? m.senderModel.toLowerCase() : '') ||
          (typeof m.from === 'string' ? m.from.toLowerCase() : '');
        const role = (rawRole || '').toLowerCase();
        const isMe = m.senderId?._id === window.currentUserId || role === 'user';
        const label = isMe ? 'Ø´Ù…Ø§' : role === 'admin' ? 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª' : role === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : 'Ù…Ø´ØªØ±ÛŒ';
        const cls = isMe ? 'bg-[#e0fdfa] self-end' : 'bg-[#f3f4f6]';
        const time = new Date(m.timestamp || m.createdAt).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
        const align = isMe ? 'items-end' : 'items-start';
        const msgText = m.message || m.text || '';
        return `
          <div class="flex flex-col ${align}">
            <div class="${cls} rounded-xl px-3 py-2 max-w-[78%]">
              <span class="text-xs font-bold text-[#10b981]">${label}</span>
              <div>${msgText}</div>
              <div class="text-xs text-gray-400 mt-1 text-left">${time}</div>
            </div>
          </div>`;
      }).join('');
      box.scrollTop = box.scrollHeight;
    } catch (err) {
      box.innerHTML = '<div class="text-center text-red-500 py-6">Ø§Ù…Ú©Ø§Ù† Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙØªÚ¯Ùˆ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>';
    }
  }

  async function sendAdminMsg() {
    const ta = document.getElementById('adminMsgInput');
    const text = ta.value.trim();
    if (!text) return;
    try {
      const token = document.cookie.split('; ').find(r => r.startsWith('user_token='))?.split('=')[1];
      const res = await fetch(`${API_BASE}/messages/send`, {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { Authorization: 'Bearer ' + token })
        },
        body: JSON.stringify({ message: text })
      });
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) throw new Error('Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²');
        throw new Error('Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
      }
      ta.value = '';
      renderAdminMsgs(window.currentUserId);
    } catch (err) {
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: ' + err.message);
    }
  }





  /* Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ ÛŒÚ© Ú†Øª (Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */











  /* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
async function ensureShopUrl(sid, existing) {
  if (existing) return existing;
  if (!sid) return '';
  try {
    const res = await fetch(`${API_BASE}/shopAppearance/${sid}`);
    if (!res.ok) return '';
    const data = await res.json();
    return data.customUrl || '';
  } catch {
    return '';
  }
}

/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª (async Ø¨Ø±Ø§ÛŒ fetch Ø¬Ø²Ø¦ÛŒØ§Øª) */
async function showChatModal() {
  console.log("Ø¯Ø± Ø­Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ú†Øª...");

  // Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ Ú†Øª Ø§Ø² Ø³Ø±ÙˆØ±
  const chat = await fetchChatDetails(currentCid);
  if (!chat) {
    alert('Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙØªÚ¯Ùˆ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
    return;
  }

  // Ù¾Ø³ Ø§Ø² Ø¯Ø±ÛŒØ§ÙØªØŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ø±Ø§ Ø®ÙˆØ§Ù†Ø¯Ù‡â€ŒØ´Ø¯Ù‡ Ø¹Ù„Ø§Ù…Øª Ø¨Ø²Ù†
  chat.messages.forEach(m => {
    if (m.from !== 'user') m.read = true;
  });

  console.log('messages:', chat.messages); // Ø¯ÛŒØ¨Ø§Ú¯

  // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ù…Ø­Ù„ÛŒ
  const idx = chatsList.findIndex(c => c._id === currentCid);
  if (idx !== -1) chatsList[idx] = chat;
  updateBadge();

  console.log('Ø³Ø§Ø®ØªØ§Ø± Ú†Øª Ú©Ø§Ù…Ù„:', chat);

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„
  let whom = 'Ù…Ø®Ø§Ø·Ø¨';
  let role = '';
  let sellerId = null;
  let storeName = '';
  let shopUrl = '';

  if (Array.isArray(chat.participants)) {
    const participant = chat.participants.find(p => p && p._id !== window.currentUserId);
    if (participant) {
      role = participant.role;
      sellerId = participant._id;
      storeName = participant.storename || '';
      shopUrl = participant.shopurl || '';
      whom = role === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : (role === 'admin' ? 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª' : (role === 'user' ? 'Ù…Ø´ØªØ±ÛŒ' : 'Ù…Ø®Ø§Ø·Ø¨'));
    }
  }

  if (!role && Array.isArray(chat.participantsModel)) {
    if (chat.participantsModel.includes('Admin')) {
      role = 'admin';
      whom = 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
    } else if (chat.participantsModel.includes('Seller')) {
      role = 'seller';
      whom = 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
    }
  }

  // fallback Ø§Ø² type
  if (!role && chat.type) {
    if (chat.type === 'user-seller' || chat.type === 'seller-admin') {
      whom = 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
      role = 'seller';
      sellerId = chat.sellerId;
    } else if (chat.type === 'user-admin' || chat.type === 'admin-user' || chat.type === 'admin') {
      whom = 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
      role = 'admin';
    }
  }

  let whomDisplay = whom;
  let sellerLink = '';
  if (role === 'seller' && sellerId) {
    shopUrl = await ensureShopUrl(sellerId, shopUrl);
    const linkUrl = shopUrl ? `/shop.html?shopurl=${shopUrl}` : '';
    const linkText = storeName ? `Ù…ØºØ§Ø²Ù‡ ${storeName}` : `Ù…ØºØ§Ø²Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡`;
    sellerLink = linkUrl
      ? `<a href="${linkUrl}" target="_blank" rel="noopener noreferrer" class="text-[#0ea5e9] hover:text-blue-700 hover:underline ml-3 text-sm font-semibold">${linkText}</a>`
      : '';
  }

  let prodBlock = '';
  if (chat.productId && chat.productId.title) {
    const productUrl = `/product.html?id=${chat.productId._id}`;
    prodBlock = `
      <a href="${productUrl}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 bg-[#e0fdfa] px-2 py-1 rounded-lg my-2 hover:bg-[#d1f8f5] transition">
        <img src="${chat.productId.images?.[0] || '/assets/images/noimage.png'}" class="w-9 h-9 object-cover rounded-md border" alt="">
        <span class="text-xs text-gray-700">${chat.productId.title}</span>
      </a>
    `;
  }

  // Ù…ÙˆØ¯Ø§Ù„ HTML
  document.body.insertAdjacentHTML('beforeend', `
    <div id="chatModal" class="fixed inset-0 z-50 flex items-center justify-center" style="backdrop-filter:blur(4px);background:#0003;animation:fadein .25s">
      <div class="bg-white rounded-2xl w-[98vw] max-w-md max-h-[93vh] flex flex-col shadow-xl border">
        <div class="px-4 py-3 border-b flex justify-between items-center gap-3">
          <div>
            <div class="flex items-center">
              <span class="font-bold primary-text">${whomDisplay}</span>
              ${sellerLink}
            </div>
            ${prodBlock}
          </div>
          <button class="close-chat-modal text-2xl font-black text-gray-400 hover:text-red-500 rounded-full w-8 h-8 flex items-center justify-center">Ã—</button>
        </div>
        <div id="chatBody" class="flex-1 overflow-y-auto p-4 space-y-4 text-[15px] scrollbar-hide bg-[#f9fafb]"></div>
        <div class="border-t p-3 flex gap-2 bg-white">
          <textarea id="msgBox" rows="2" class="flex-1 border rounded-xl p-2 resize-none focus:outline-none" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"></textarea>
          <button class="send-msg brand-btn px-5 py-2 rounded-xl font-bold shrink-0">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
      </div>
    </div>
  `);

  // Add event listeners for chat modal buttons
  const closeBtn = document.querySelector('.close-chat-modal');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeChat);
  }

  const sendBtn = document.querySelector('.send-msg');
  if (sendBtn) {
    sendBtn.addEventListener('click', sendMsg);
  }

  // Also allow sending message with Enter key
  const msgBox = document.getElementById('msgBox');
  if (msgBox) {
    msgBox.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMsg();
      }
    });
  }

  renderChat();
  setTimeout(() => document.getElementById('msgBox').focus(), 120);
}
  // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ú†Øª
  function closeChat() {
    document.getElementById('chatModal')?.remove();
    currentCid = null;
  }

  async function fetchBlockedSellers() {
    try {
      const res = await fetch(`${API_BASE}/blocked-sellers`, { credentials: 'include' });
      const data = await res.json();
      blockedSellers = Array.isArray(data) ? data : [];
    } catch (e) {
      blockedSellers = [];
    }
  }

  async function blockSeller(sid) {
    if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø±Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ù†ÛŒØ¯ØŸ')) return;
    try {
      const res = await fetch(`${API_BASE}/blocked-sellers/${sid}`, {
        method: 'POST',
        credentials: 'include'
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ');
      if (!blockedSellers.includes(sid)) blockedSellers.push(sid);
      renderMessagesList();
    } catch (err) {
      alert('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ: ' + err.message);
    }
  }

  /* Ø±Ù†Ø¯Ø± Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ */
/* Ø±Ù†Ø¯Ø± Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ */
function renderChat() {
  const chat = chatsList.find(c => c._id === currentCid);
  const target = document.getElementById('chatBody');
  if (!target) return;

  function getSenderRoleText(msg, isMe) {
    if (isMe) return 'Ø´Ù…Ø§';
    const raw =
      msg.senderRole ||
      msg?.sender?.role ||
      msg?.senderId?.role ||
      (typeof msg.senderModel === 'string' ? msg.senderModel.toLowerCase() : '') ||
      (typeof msg.from === 'string' ? msg.from.toLowerCase() : '');
    const role = (raw || '').toLowerCase();
    if (role === 'admin')  return 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
    if (role === 'seller') return 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
    if (role === 'user')   return 'Ù…Ø´ØªØ±ÛŒ';
    return 'Ù…Ø®Ø§Ø·Ø¨';
  }

  target.innerHTML = (chat.messages || []).map(m => {
    const roleHint = (m.senderRole || m?.senderId?.role || '').toLowerCase();
    const isMe =
      m.senderId?._id === window.currentUserId ||
      m.senderId === window.currentUserId ||
      roleHint === 'user' ||
      m.from === 'user' ||
      m.from === window.currentUserId;
    const cls = isMe ? 'bg-[#e0fdfa] self-end' : 'bg-[#f3f4f6]';
    const name = `<span class="text-xs font-bold text-[#10b981]">${getSenderRoleText(m, isMe)}</span>`;
    return `
      <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
        <div class="${cls} rounded-xl px-3 py-2 max-w-[78%]">
          ${name}
          <div>${m.text || ''}</div>
          <div class="text-xs text-gray-400 mt-1 text-left">${new Date(m.date || m.createdAt).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
      </div>
    `;
  }).join('');
  target.scrollTop = target.scrollHeight;
}



  /* Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… */
/**
 * Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø² Ø·Ø±Ù Ú©Ø§Ø±Ø¨Ø±
 */
async function sendMsg() {
  const ta   = document.getElementById('msgBox');
  const text = ta.value.trim();
  if (!text) {
    alert('Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }

  // ØªÙˆÚ©Ù†Ù Ú©Ø§Ø±Ø¨Ø± (Ù…Ø´ØªØ±ÛŒ) Ø±Ø§ Ø§Ø² Ú©ÙˆÚ©ÛŒ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
  const token = document.cookie
    .split('; ')
    .find(row => row.startsWith('user_token='))
    ?.split('=')[1];

  try {
    // Ø¨Ù‡ Ù…Ø³ÛŒØ± Ù…Ø®ØµÙˆØµ reply Ú©Ø§Ø±Ø¨Ø± Ø¨ÙØ±Ø³ØªÛŒÙ…
    const res = await fetch(`${API_BASE}/chats/${currentCid}/user-reply`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        ...(token && { Authorization: 'Bearer ' + token })
      },
      body: JSON.stringify({ text })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…');

    // Ù¾Ø³ Ø§Ø² Ù…ÙˆÙÙ‚ÛŒØªØŒ textarea Ø±Ø§ Ù¾Ø§Ú© Ùˆ Ù„ÛŒØ³Øª Ú†Øª Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    ta.value = '';
    chatsList = chatsList.map(c => c._id === currentCid ? data : c);
    renderChat();
    updateBadge();

  } catch (err) {
    console.error('âŒ sendMsg error:', err);
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…:\n' + err.message);
  }
}





async function deleteChat(cid) {
  if(!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú†Øª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

  try {
    const res = await fetch(`${API_BASE}/chats/${cid}`, {
      method: 'DELETE',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'Ø­Ø°Ù Ú†Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
    // Ø­Ø°Ù Ú†Øª Ø§Ø² Ù„ÛŒØ³Øª Ùˆ Ø±ÙØ±Ø´
    chatsList = chatsList.filter(c => c._id !== cid);
    renderMessagesList();
    updateBadge();
    closeChat();
  } catch (err) {
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú†Øª: ' + err.message);
  }
}




  /* badge Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡ */
function getMessageTimestamp(message) {
  if (!message) return 0;
  const stamp = message.createdAt || message.sentAt || message.timestamp;
  if (stamp) {
    const date = new Date(stamp);
    const time = date.getTime();
    if (!Number.isNaN(time)) return time;
  }
  if (typeof message._id === 'string' && message._id.length >= 8) {
    const hex = message._id.slice(0, 8);
    const parsed = parseInt(hex, 16);
    if (!Number.isNaN(parsed)) return parsed * 1000;
  }
  return 0;
}

function updateBadge() {
  const lastViewed = getLastNotificationsViewedAt();
  const total = chatsList.reduce((count, chat) => {
    const messages = Array.isArray(chat.messages) ? chat.messages : [];
    const unread = messages.filter(m => {
      if (!m || m.from === 'user' || m.read) return false;
      const ts = getMessageTimestamp(m);
      if (ts === 0) return lastViewed === 0;
      return ts > lastViewed;
    });
    return count + unread.length;
  }, 0);

  const msgBadge = document.getElementById('msgBadge');
  if (msgBadge) {
    msgBadge.textContent = total > 0 ? total : '';
  }

  const hamBadge = document.getElementById('hamBadge');
  if (hamBadge) {
    if (total > 0) {
      hamBadge.textContent = total;
      hamBadge.classList.remove('hidden');
    } else {
      hamBadge.textContent = '';
      hamBadge.classList.add('hidden');
    }
  }
}

function markNotificationsViewed() {
  setLastNotificationsViewedNow();
  const msgBadge = document.getElementById('msgBadge');
  if (msgBadge) {
    msgBadge.textContent = '';
  }
  const hamBadge = document.getElementById('hamBadge');
  if (hamBadge) {
    hamBadge.textContent = '';
    hamBadge.classList.add('hidden');
  }
}


  /* Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù„ÛŒØ³Øª Ùˆ Ú†Øª */
/* Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù„ÛŒØ³Øª Ùˆ Ú†Øª */
function startMsgPolling(){
  if(pollHandle) clearInterval(pollHandle);
  pollHandle = setInterval(async()=>{
    await fetchUserChats();
    updateBadge();
    if(currentCid) {
      // Ø§Ú¯Ø± Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ú†Øª Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ fetch Ùˆ Ø±Ù†Ø¯Ø± Ú©Ù†
      const chat = await fetchChatDetails(currentCid);
      if (chat) {
        const idx = chatsList.findIndex(c => c._id === currentCid);
        if (idx !== -1) chatsList[idx] = chat;
        renderChat();
      }
    } else {
      renderMessagesList();
    }
  },10000);
}
  function stopMsgPolling(){ if(pollHandle){clearInterval(pollHandle);pollHandle=null;} }
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ù¾Ø§ÛŒØ§Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */








/* Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ ÛŒÚ© Ú†Øª (Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */
/* Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ ÛŒÚ© Ú†Øª (Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */
async function fetchChatDetails(cid) {
  const token = document.cookie.split('; ').find(row => row.startsWith('user_token='))?.split('=')[1];
  try {
    const res = await fetch(`${API_BASE}/chats/${cid}`, {
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        ...(token && { Authorization: 'Bearer ' + token })
      }
    });
    if (!res.ok) throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú†Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
    const data = await res.json();
    return data;  // Ú†Øª Ú©Ø§Ù…Ù„ Ø¨Ø§ messages
  } catch (e) {
    console.error('âŒ fetchChatDetails error:', e);
    return null;
  }
}

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      showSection('dashboard');
      updateSidebarUser();
      await loadMessages();
      await loadBookings();
    } catch (error) {
      console.error('Initialization error:', error);
    }
  });









  // --- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯: Ú©Ù„ÛŒÚ© Ø¨Ø§Ú©Ø³ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ùˆ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± --- 




    </script>
  
<!-- TODO: Ø§ÙØ²ÙˆØ¯Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ PostHog Ù¾Ø³ Ø§Ø² ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ | TODO: Enable PostHog events after activation -->
<!--
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const safeCapture = window.safePosthogCapture || function () {};
    // ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø±ÛŒ | User dashboard accessed
    // safeCapture('user_dashboard_accessed', { section: 'modern-dashboard' });
  });
</script>
-->

</body>
  </html>
