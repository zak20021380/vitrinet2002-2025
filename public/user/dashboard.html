  <!DOCTYPE html>
  <html lang="fa" dir="rtl">
  <head>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net data:; connect-src 'self'; img-src 'self' data:; base-uri 'self'; form-action 'self'; upgrade-insecure-requests; block-all-mixed-content">
<meta name="referrer" content="no-referrer">
    <script src="/security.js" defer></script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø± | ÙˆÛŒØªØ±ÛŒÙ†Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@800&display=swap" rel="stylesheet"/>
    <style>
      body { font-family:'Vazirmatn',sans-serif; background: linear-gradient(110deg,#e0f7fa 0%,#f9fafb 100%); min-height:100vh;}
      .glass { background:rgba(255,255,255,0.97); backdrop-filter: blur(14px); border-radius:1.6rem; box-shadow:0 7px 32px #10b9811a, 0 3px 11px #0ea5e91a;}
      .primary-text { color: #10b981; }
      .brand-btn {
        background: linear-gradient(91deg,#10b981 0%,#0ea5e9 85%);
        color: #fff !important;
        box-shadow: 0 2px 14px #10b98125;
        transition: all .16s;
      }
      .brand-btn:hover { filter:brightness(1.08);}
      .fadein { animation:fadein .8s;}
      @keyframes fadein { from{opacity:0; transform:translateY(32px);} to{opacity:1; transform:translateY(0);} }
      ::placeholder {color:#a0aec0;}
      .tab-active { color:#10b981 !important; font-weight:900; background: #e6fcf7; }
      .scrollbar-hide::-webkit-scrollbar {display:none;}
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none;}
      .avatar-bg { background:linear-gradient(120deg,#10b981 65%,#0ea5e9 100%); }
      .menu-btn { transition: background .16s; }
      .menu-btn.active { background: #e6fcf7; color: #10b981; }
      .filter-btn { transition: all .2s ease; }
      .filter-btn.active { background-color: #3b82f6; color: #fff; border-color: transparent; }
      /* Ù‡Ù…Ø¨Ø±Ú¯Ø± */
      .ham {
        width: 2.3rem; height: 2.3rem; display: flex; align-items: center; justify-content: center;
        background: #10b9811a; border-radius: 50%; border: none; cursor: pointer;
        transition: background .2s;
      }
      .ham:hover { background: #0ea5e91a; }
      @media (max-width: 1023px) {
        .main-grid { grid-template-columns: 1fr !important; }
        .sidebar { display: none !important; }
      }
      @media (min-width: 1024px) {
        .mobile-sidebar,.sidebar-overlay { display: none !important;}
      }
      /* Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ù†Ùˆ */
      .sidebar-overlay {
        position:fixed; inset:0; background:rgba(0,0,0,0.18); z-index:50; display:none;
      }
      .sidebar-overlay.open {display:block; animation: fadein .25s;}
      .mobile-sidebar {
        position:fixed; top:0; right:0; height:100vh; width:85vw; max-width:350px;
        background:#fff; z-index:60;
        border-radius:1.6rem 0 0 1.6rem;
        box-shadow:-2px 0 34px #10b98123;
        padding:2.3rem 1.5rem 2.4rem 1.5rem;
        overflow-y:auto;
        transform:translateX(100%);
        transition: transform .25s cubic-bezier(.8,.2,.3,1.2);
      }
      .mobile-sidebar.open { transform:translateX(0);}

      /* --- Booking details modal redesign --- */
      body.booking-modal-open { overflow: hidden; }

      .mobile-bottom-nav,
      .bottom-nav { z-index: 1000; }

      .booking-modal-backdrop {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        background: rgba(15, 23, 42, 0.62);
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        z-index: 9999;
        animation: booking-modal-backdrop-fade-in 0.2s ease-out forwards;
      }

      .booking-modal-backdrop.is-mobile {
        align-items: flex-end;
        padding: 0;
      }

      .booking-modal-backdrop.closing {
        animation: booking-modal-backdrop-fade-out 0.2s ease-in forwards;
      }

      .booking-modal-content {
        position: relative;
        width: min(100%, 600px);
        max-height: calc(100vh - 120px);
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 80%);
        border-radius: 28px;
        box-shadow: 0 22px 70px rgba(15, 23, 42, 0.25), 0 10px 28px rgba(14, 165, 233, 0.12);
        border: 1px solid rgba(226, 232, 240, 0.8);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transform-origin: center;
        animation: booking-modal-scale-in 0.28s cubic-bezier(0.25, 0.9, 0.35, 1) forwards;
      }

      .booking-modal-content:focus {
        outline: none;
      }

      .booking-modal-content.closing {
        animation: booking-modal-scale-out 0.24s cubic-bezier(0.35, 0, 0.8, 0.4) forwards;
      }

      .booking-modal-header {
        background: linear-gradient(135deg, #2563eb 0%, #7c3aed 48%, #0ea5e9 100%);
        padding: 1.8rem 2rem 1.6rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        color: #fff;
      }

      .booking-modal-header .header-info {
        display: flex;
        align-items: center;
        gap: 1.1rem;
      }

      .booking-modal-header .header-icon {
        width: 3.25rem;
        height: 3.25rem;
        border-radius: 1.2rem;
        background: rgba(255, 255, 255, 0.18);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.22);
      }

      .booking-modal-title {
        font-size: 1.5rem;
        font-weight: 800;
        margin-bottom: 0.25rem;
      }

      .booking-modal-subtitle {
        font-size: 0.95rem;
        opacity: 0.85;
      }

      .booking-modal-header button {
        width: 2.75rem;
        height: 2.75rem;
        border-radius: 9999px;
        background: rgba(255, 255, 255, 0.16);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease, background 0.2s ease;
        min-height: 44px;
      }

      .booking-modal-header button:hover {
        transform: scale(1.04);
        background: rgba(255, 255, 255, 0.28);
      }

      .booking-modal-header button:focus-visible,
      .booking-modal-footer button:focus-visible,
      .booking-modal-body button:focus-visible,
      .booking-modal-body a:focus-visible {
        outline: 3px solid rgba(14, 165, 233, 0.4);
        outline-offset: 3px;
      }

      .booking-modal-body {
        padding: 1.9rem 2rem 2.4rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
        scroll-behavior: smooth;
        max-height: calc(100vh - 228px);
      }

      .booking-modal-body::-webkit-scrollbar {
        width: 7px;
      }

      .booking-modal-body::-webkit-scrollbar-track {
        background: transparent;
      }

      .booking-modal-body::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.45);
        border-radius: 9999px;
      }

      .booking-modal-body:hover::-webkit-scrollbar-thumb {
        background: rgba(79, 70, 229, 0.55);
      }

      .modal-section {
        position: relative;
        background: rgba(255, 255, 255, 0.92);
        border-radius: 22px;
        padding: 1.4rem 1.4rem 1.35rem 1.25rem;
        border: 1px solid rgba(226, 232, 240, 0.9);
        box-shadow: 0 16px 32px rgba(15, 23, 42, 0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .modal-section::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 8px;
        height: 100%;
        border-radius: 0 22px 22px 0;
        background: linear-gradient(180deg, #38bdf8, #0ea5e9);
        opacity: 0.8;
      }

      .modal-section:hover {
        transform: translateY(-3px);
        box-shadow: 0 28px 44px rgba(15, 23, 42, 0.08);
      }

      .modal-section-header {
        display: flex;
        align-items: center;
        gap: 0.85rem;
        margin-bottom: 0.85rem;
      }

      .modal-section-icon {
        width: 2.75rem;
        height: 2.75rem;
        border-radius: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        background: linear-gradient(145deg, rgba(14, 165, 233, 0.18), rgba(79, 70, 229, 0.18));
        color: #1e293b;
      }

      .modal-section h3 {
        font-size: 1.05rem;
        font-weight: 800;
        color: #1f2937;
        margin-bottom: 0.2rem;
      }

      .modal-section p {
        color: #475569;
        line-height: 1.65;
      }

      .modal-field {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        margin-bottom: 0.65rem;
      }

      .modal-field:last-child {
        margin-bottom: 0;
      }

      .modal-field-label {
        font-weight: 700;
        color: #1e293b;
        font-size: 0.95rem;
      }

      .modal-field-value {
        font-size: 0.97rem;
        color: #334155;
        word-break: break-word;
      }

      .modal-field-value strong {
        font-weight: 800;
        color: #0f172a;
      }

      .booking-id-wrap {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        flex-wrap: wrap;
      }

      .booking-id-value {
        font-family: 'Poppins', 'Vazirmatn', sans-serif;
        font-weight: 700;
        background: #0ea5e90d;
        border: 1px dashed rgba(14, 165, 233, 0.4);
        color: #0f172a;
        border-radius: 14px;
        padding: 0.55rem 1.1rem;
        font-size: 0.95rem;
        letter-spacing: 0.03em;
        direction: ltr;
      }

      .booking-id-copy {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        min-height: 44px;
        padding: 0.55rem 1.1rem;
        border-radius: 14px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.16), rgba(59, 130, 246, 0.28));
        color: #1d4ed8;
        font-weight: 700;
        border: 1px solid rgba(59, 130, 246, 0.35);
        transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
      }

      .booking-id-copy:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 22px rgba(59, 130, 246, 0.18);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.28), rgba(14, 165, 233, 0.32));
      }

      .booking-id-copy svg {
        width: 1.1rem;
        height: 1.1rem;
      }

      .copy-feedback {
        font-size: 0.78rem;
        color: #0ea5e9;
        opacity: 0;
        transform: translateY(4px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .copy-feedback.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .modal-link {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        color: #2563eb;
        font-weight: 700;
        text-decoration: none;
        transition: color 0.2s ease, transform 0.2s ease;
      }

      .modal-link:hover {
        color: #0f172a;
        transform: translateY(-1px);
      }

      .modal-link svg {
        width: 0.95rem;
        height: 0.95rem;
      }

      .modal-status-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-height: 40px;
        padding: 0.4rem 1.1rem;
        border-radius: 9999px;
        font-size: 0.95rem;
        font-weight: 800;
        letter-spacing: 0.01em;
      }

      .booking-modal-footer {
        position: sticky;
        bottom: 0;
        padding: 1.4rem 2rem 1.8rem;
        background: linear-gradient(0deg, rgba(248, 250, 252, 0.92) 0%, rgba(248, 250, 252, 0.6) 100%);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        display: flex;
        justify-content: flex-end;
      }

      .booking-close-btn {
        min-height: 48px;
        padding: 0.75rem 2.6rem;
        border-radius: 9999px;
        background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 45%, #10b981 100%);
        color: #fff;
        font-weight: 800;
        font-size: 1rem;
        box-shadow: 0 18px 32px rgba(79, 70, 229, 0.25);
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
      }

      .booking-close-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 26px 38px rgba(99, 102, 241, 0.25);
        filter: brightness(1.05);
      }

      .booking-close-btn:active {
        transform: translateY(0);
      }

      .modal-section.accent-blue::before {
        background: linear-gradient(180deg, rgba(37, 99, 235, 0.95), rgba(14, 165, 233, 0.75));
      }

      .modal-section.accent-blue .modal-section-icon {
        background: linear-gradient(145deg, rgba(37, 99, 235, 0.15), rgba(14, 165, 233, 0.22));
      }

      .modal-section.accent-emerald::before {
        background: linear-gradient(180deg, rgba(16, 185, 129, 0.9), rgba(34, 197, 94, 0.8));
      }

      .modal-section.accent-emerald .modal-section-icon {
        background: linear-gradient(145deg, rgba(16, 185, 129, 0.18), rgba(45, 212, 191, 0.2));
      }

      .modal-section.accent-purple::before {
        background: linear-gradient(180deg, rgba(139, 92, 246, 0.9), rgba(168, 85, 247, 0.75));
      }

      .modal-section.accent-purple .modal-section-icon {
        background: linear-gradient(145deg, rgba(139, 92, 246, 0.18), rgba(168, 85, 247, 0.2));
      }

      .modal-section.accent-amber::before {
        background: linear-gradient(180deg, rgba(251, 191, 36, 0.9), rgba(249, 115, 22, 0.85));
      }

      .modal-section.accent-amber .modal-section-icon {
        background: linear-gradient(145deg, rgba(251, 191, 36, 0.2), rgba(249, 115, 22, 0.18));
      }

      .modal-section.accent-slate::before {
        background: linear-gradient(180deg, rgba(100, 116, 139, 0.88), rgba(15, 23, 42, 0.75));
      }

      .modal-section.accent-slate .modal-section-icon {
        background: linear-gradient(145deg, rgba(100, 116, 139, 0.22), rgba(148, 163, 184, 0.18));
      }

      .modal-section.accent-rose::before {
        background: linear-gradient(180deg, rgba(244, 63, 94, 0.9), rgba(236, 72, 153, 0.8));
      }

      .modal-section.accent-rose .modal-section-icon {
        background: linear-gradient(145deg, rgba(244, 63, 94, 0.22), rgba(236, 72, 153, 0.18));
      }

      .modal-section-note {
        font-size: 0.9rem;
        color: #475569;
        margin-top: 0.4rem;
      }

      .booking-meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.9rem;
      }

      .booking-meta-grid .modal-field {
        background: rgba(248, 250, 252, 0.9);
        border-radius: 16px;
        padding: 0.8rem 1rem;
        border: 1px solid rgba(226, 232, 240, 0.7);
      }

      @keyframes booking-modal-backdrop-fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes booking-modal-backdrop-fade-out {
        from { opacity: 1; }
        to { opacity: 0; }
      }

      @keyframes booking-modal-scale-in {
        from { opacity: 0; transform: scale(0.94); }
        to { opacity: 1; transform: scale(1); }
      }

      @keyframes booking-modal-scale-out {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.92); }
      }

      @keyframes booking-modal-slide-up {
        from { opacity: 0; transform: translateY(64px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes booking-modal-slide-down {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(72px); }
      }

      @media (max-width: 1023px) {
        .booking-modal-header {
          padding: 1.5rem 1.6rem 1.3rem;
        }

        .booking-modal-body {
          padding: 1.4rem 1.35rem 2rem;
          max-height: calc(100vh - 210px);
        }

        .booking-modal-footer {
          padding: 1.2rem 1.4rem 1.6rem;
        }
      }

      @media (max-width: 767px) {
        .booking-modal-backdrop {
          padding: 0;
          align-items: flex-end;
        }

        .booking-modal-content {
          width: 100%;
          max-height: calc(100vh - 110px);
          border-radius: 26px 26px 0 0;
          margin: 0;
          animation: booking-modal-slide-up 0.3s cubic-bezier(0.24, 0.82, 0.25, 1) forwards;
          box-shadow: 0 -8px 34px rgba(15, 23, 42, 0.2);
        }

        .booking-modal-content.closing {
          animation: booking-modal-slide-down 0.28s cubic-bezier(0.42, 0, 0.58, 1) forwards;
        }

        .booking-modal-body {
          max-height: calc(100vh - 220px);
          padding: 1.4rem 1.1rem 2.6rem;
        }

        .booking-modal-footer {
          padding: 1.1rem 1.2rem calc(1.1rem + env(safe-area-inset-bottom, 1.4rem));
          justify-content: center;
        }

        .booking-modal-footer .booking-close-btn {
          width: 100%;
          border-radius: 18px;
        }

        .booking-modal-header {
          padding: 1.4rem 1.4rem 1.2rem;
        }

        .booking-modal-header .booking-modal-title {
          font-size: 1.35rem;
        }

        .booking-modal-header .header-icon {
          width: 3rem;
          height: 3rem;
        }

        .modal-section {
          padding: 1.25rem 1.1rem 1.15rem 1rem;
        }

        .modal-section::before {
          width: 6px;
        }

        .booking-modal-backdrop.is-mobile .booking-modal-content {
          margin-bottom: calc(88px + env(safe-area-inset-bottom, 28px));
        }
      }

      @media (max-width: 480px) {
        .booking-modal-body {
          max-height: calc(100vh - 230px);
        }

        .booking-id-wrap {
          flex-direction: column;
          align-items: stretch;
        }

        .booking-id-copy {
          justify-content: center;
        }

        .booking-id-value {
          width: 100%;
          text-align: center;
        }
      }
    </style>
    <script src="/nav-active.js" defer></script>

<!-- TODO: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø³Øªâ€ŒÙ‡Ø§Ú¯ Ø±Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø§Ù†ØªØ´Ø§Ø± ÙØ±Ø§Ù…ÙˆØ´ Ù†Ú©Ù†ÛŒØ¯ | TODO: Enable PostHog analytics when going live -->
<!--
<script>
  (function () {
    var config = window.POSTHOG_CONFIG || { enabled: false, apiKey: 'phc_YOUR_KEY_HERE', apiHost: 'https://analytics.vitreenet.ir' };
    if (!config.enabled) {
      return; // ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª | Not enabled yet
    }
    try {
      (function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")),p.type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js";(r=t.getElementsByTagName("script")[0]),r.parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:u=e,u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==u._i&&(e+="."+u._i),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"};n="capture identify alias people.set people.set_once people.unset people.increment people.append people.union people.remove people.clear_opt_out_outcome register register_once unregister opt_out_capturing opt_in_capturing has_opted_out_capturing reset isFeatureEnabled onFeatureFlags reloadFeatureFlags group".split(" ");for(o=0;o<n.length;o++)g(u,n[o]);e._i.push([i,s,a])},e.__SV=1.1)})(document, window.posthog || []);
      window.posthog.init(config.apiKey, { api_host: config.apiHost, capture_pageview: true, advanced_disable_decide: true });
    } catch (error) {
      console.warn('PostHog init failed (preview mode):', error);
    }
  })();
</script>
-->

</head>
  <body class="text-gray-800 overflow-x-hidden">

    <!-- Header -->
    <header class="fixed top-0 inset-x-0 z-20 glass border-b shadow flex items-center justify-between px-6 py-3">
      <a href="index.html" class="flex items-center gap-2 select-none shrink-0">
        <img src="assets/images/logo.svg" alt="ÙˆÛŒØªØ±ÛŒÙ†Øª" class="w-9 h-9 sm:w-10 sm:h-10 hidden sm:block" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"/>
        <span class="font-extrabold text-lg md:text-2xl primary-text" style="display:none; font-family:'Poppins',sans-serif;">Vitrinet</span>
        <span class="font-extrabold text-lg md:text-2xl primary-text sm:hidden block" style="font-family:'Vazirmatn',sans-serif;">ÙˆÛŒØªØ±ÛŒÙ†Øª</span>
      </a>
      <nav class="flex items-center gap-4 text-base flex-shrink-0">
    <!-- Ù‡Ù…Ø¨Ø±Ú¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ + Ø¨ÙØ¬ -->
<button id="hamBtn"
        class="ham lg:hidden mr-1 relative"   
        title="Ù…Ù†Ùˆ">
  <!-- Ø¢ÛŒÚ©ÙˆÙ† Ø³Ù‡â€ŒØ®Ø· -->
  <svg width="24" height="24" fill="none" viewBox="0 0 24 24">
    <rect x="5" y="7" width="14" height="2" rx="1" fill="#10b981"/>
    <rect x="5" y="11" width="14" height="2" rx="1" fill="#10b981"/>
    <rect x="5" y="15" width="14" height="2" rx="1" fill="#10b981"/>
  </svg>

  <!-- ğŸ·ï¸   Ù†Ø´Ø§Ù† ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ø®Ø§Ù„ÛŒ Ùˆ Ù¾Ù†Ù‡Ø§Ù†) -->
  <span id="hamBadge"
        class="absolute -top-1.5 -left-1.5     
               bg-red-500 text-white text-[10px]
               w-4 h-4 rounded-full font-extrabold
               flex items-center justify-center
               hidden">0</span>
</button>

        <a href="index.html" class="text-gray-700 hover:text-[#10b981] font-bold">Ø®Ø§Ù†Ù‡</a>
        <button id="profileBtn" type="button" class="ml-2 flex items-center gap-2 px-3 py-1.5 rounded-2xl avatar-bg text-white font-bold text-base shadow-lg focus:outline-none hover:scale-105 transition-all" style="font-family:'Vazirmatn',sans-serif;">
          <span class="w-9 h-9 flex items-center justify-center rounded-full bg-white/10 text-2xl font-extrabold">Ú©â€ŒÙˆ</span>
          <span class="hidden sm:inline-block font-bold">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</span>
        </button>
      </nav>
    </header>

    <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <aside id="mobileSidebar" class="mobile-sidebar fadein">
      <button id="closeSidebar" class="absolute left-3 top-3 text-gray-400 hover:text-[#10b981] rounded-full p-1 transition" title="Ø¨Ø³ØªÙ†">
        <svg width="28" height="28" fill="none" viewBox="0 0 28 28"><circle cx="14" cy="14" r="14" fill="#f3f4f6"/><path d="M10.8 17.2l6.4-6.4M17.2 17.2l-6.4-6.4" stroke="#64748b" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
      <div class="w-20 h-20 rounded-full avatar-bg flex items-center justify-center text-white text-4xl font-extrabold mb-2 select-none shadow-lg mx-auto">
        VN
      </div>
  <div class="text-lg font-bold primary-text mt-2 mb-0.5 text-center sidebar-user-name">Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª</div>
  <div class="text-gray-400 text-sm mb-3 text-center sidebar-user-mobile" dir="ltr">0912***2345</div>

      <div class="flex flex-col gap-2 w-full mt-4 text-[15px]">
        <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition tab-active" data-section="dashboard"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#10b981"/><path d="M6 9l3 3 3-3" stroke="#fff" stroke-width="1.6"/></svg> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
        <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="profile"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#dbeafe"/><path d="M6 7a3 3 0 0 1 6 0c0 1.656-1.343 3-3 3s-3-1.344-3-3Zm6 6H6c0-1.656 2.343-3 3-3s3 1.344 3 3Z" fill="#3b82f6"/></svg> Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</button>
        <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="favorites"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fce7f3"/><path d="M6.5 8A2.5 2.5 0 0 1 9 5.5 2.5 2.5 0 0 1 11.5 8C11.5 9.33 9 12 9 12S6.5 9.33 6.5 8Z" fill="#ec4899"/></svg> Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</button>
        <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="favshops"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#ffe4e6"/><path d="M6.5 8A2.5 2.5 0 0 1 9 5.5 2.5 2.5 0 0 1 11.5 8C11.5 9.33 9 12 9 12S6.5 9.33 6.5 8Z" fill="#f43f5e"/></svg> Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø¨ÙˆØ¨ Ù…Ù†</button>
        <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="bookings">
          ğŸ“… Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒ Ù…Ù†
          <span id="bookings-badge" class="inline-block mr-2 px-2 py-1 text-xs bg-red-500 text-white rounded-full hidden">0</span>
        </button>

  <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
  <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition"
          data-section="messages">
    <svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fef2f2"/><path d="M6 6h6v6H6z" fill="#ef4444"/></svg>
    Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    <span id="msgBadge" class="ml-1 text-xs font-extrabold text-red-500"></span>
  </button>

        
      </div>
  
    </aside>

    <main class="max-w-6xl mx-auto mt-32 mb-14 px-2 sm:px-4">
      <div class="grid main-grid grid-cols-3 gap-7">
        <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¯Ø³Ú©ØªØ§Ù¾ -->
        <aside class="glass sidebar flex-col items-center py-7 px-4 sm:px-8 mb-3 fadein hidden lg:flex">
          <div class="w-20 h-20 rounded-full avatar-bg flex items-center justify-center text-white text-4xl font-extrabold mb-2 select-none shadow-lg">
            VN
          </div>
        <div class="text-lg font-bold primary-text mt-2 mb-0.5 text-center sidebar-user-name">Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª</div>
  <div class="text-gray-400 text-sm mb-3 text-center sidebar-user-mobile" dir="ltr">0912***2345</div>

          <div class="flex flex-col gap-2 w-full mt-4 text-[15px]">
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition tab-active" data-section="dashboard"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#10b981"/><path d="M6 9l3 3 3-3" stroke="#fff" stroke-width="1.6"/></svg> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="profile"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#dbeafe"/><path d="M6 7a3 3 0 0 1 6 0c0 1.656-1.343 3-3 3s-3-1.344-3-3Zm6 6H6c0-1.656 2.343-3 3-3s3 1.344 3 3Z" fill="#3b82f6"/></svg> Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="favorites"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fce7f3"/><path d="M6.5 8A2.5 2.5 0 0 1 9 5.5 2.5 2.5 0 0 1 11.5 8C11.5 9.33 9 12 9 12S6.5 9.33 6.5 8Z" fill="#ec4899"/></svg> Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="favshops"><svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#ffe4e6"/><path d="M6.5 8A2.5 2.5 0 0 1 9 5.5 2.5 2.5 0 0 1 11.5 8C11.5 9.33 9 12 9 12S6.5 9.33 6.5 8Z" fill="#f43f5e"/></svg> Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø¨ÙˆØ¨ Ù…Ù†</button>
            <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition" data-section="bookings">
              ğŸ“… Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒ Ù…Ù†
              <span id="bookings-badge" class="inline-block mr-2 px-2 py-1 text-xs bg-red-500 text-white rounded-full hidden">0</span>
            </button>
            
  <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
  <button class="menu-btn text-gray-700 flex items-center gap-2 px-3 py-2 rounded-xl font-bold transition"
          data-section="messages">
    <svg width="18" height="18" fill="none"><circle cx="9" cy="9" r="9" fill="#fef2f2"/><path d="M6 6h6v6H6z" fill="#ef4444"/></svg>
    Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    <span id="msgBadge" class="ml-1 text-xs font-extrabold text-red-500"></span>
  </button>




          </div>
        
        </aside>
        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø³Ù…Øª Ú†Ù¾ -->
        <section id="mainContent" class="col-span-2 flex flex-col gap-7 fadein">
          <!-- Ø§ÛŒÙ†Ø¬Ø§ Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ù„ÙˆØ¯ Ù…ÛŒØ´Ù‡ -->
        </section>
      </div>
    </main>
    <footer class="mt-14 bg-white border-t text-center text-xs sm:text-sm text-gray-400 py-5 rounded-t-3xl">
      Â© 2025 <span class="text-[#10b981] font-bold">Vitrinet</span> - Ù‡Ù…Ù‡ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.
    </footer>
    <script>

      // Bookings state
      let currentBookingFilter = 'all';
      let allBookings = [];

      let pollHandle = null;
      let bookingsData = [];
      let bookingModalCleanup = null;
      let bookingsLoaded = false;
      // Ø¯Ø§Ø¯Ù‡â€ŒÛŒ Ø¯Ù…ÙˆÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
  async function loadProfileSection() {
    let html = `
      <div class="glass px-6 py-7 fadein">
        <div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</div>
      </div>`;
    document.getElementById('mainContent').innerHTML = html;

    try {
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',          // Ú©ÙˆÚ©ÛŒ JWT
        headers: { 'Content-Type': 'application/json' }
      });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403)
          throw new Error('Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.');
        throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯!');
      }

      const user  = await res.json();
      const phone = user.phone || user.mobile || '';   // âœ³ï¸ ÙÛŒÚ©Ø³: ÙÛŒÙ„Ø¯ mobile Ù‡Ù… Ù¾ÙˆØ´Ø´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯
      const masked =
        phone ? phone.toString().slice(0, 4) + '***' + phone.toString().slice(-3) : '-';

      html = `
        <div class="glass px-6 py-7 fadein">
          <div class="flex flex-col sm:flex-row items-center gap-5 sm:gap-12 mb-6">
            <div class="w-24 h-24 rounded-full avatar-bg flex items-center justify-center text-white text-5xl font-extrabold shadow-xl">
              VN
            </div>
            <div>
              <div class="text-xl font-black primary-text mb-2">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-1 gap-x-7 text-[16px]">
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ù†Ø§Ù…:</span>
                  <span class="font-bold text-gray-800">${user.firstname || '-'}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</span>
                  <span class="font-bold text-gray-800">${user.lastname || '-'}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ø´Ù‡Ø±:</span>
                  <span class="font-bold text-gray-800">${user.city || '-'}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-gray-500">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</span>
                  <span class="font-bold text-gray-800" dir="ltr">${masked}</span>
                </div>
              </div>
            </div>
          </div>
        </div>`;
    } catch (e) {
      html = `
        <div class="glass px-6 py-7 fadein">
          <div class="text-center text-red-400 py-12">
            Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø¨ØªØ¯Ø§
            <a href="/login.html"
              class="inline-block px-3 py-1.5 mx-1 rounded-xl brand-btn text-white font-bold text-base transition hover:scale-105"
              style="text-decoration:none;">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a>
            .
          </div>
        </div>`;
    }

    document.getElementById('mainContent').innerHTML = html;
  }








      async function ensureUserPhone() {
        if (window.currentUserPhone) return window.currentUserPhone;

        try {
          const res = await fetch('/api/user/profile', {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!res.ok) return '';

          const user = await res.json();
          const phone = user.phone || user.mobile || '';
          window.currentUserPhone = phone;
          return phone;
        } catch (_) {
          return '';
        }
      }

      async function fetchBookings(phone) {
        const res = await fetch(`/api/bookings?phone=${encodeURIComponent(phone)}`, {
          method: 'GET',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          let message = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ø±ÙˆÙ‡Ø§';
          try {
            const data = await res.json();
            if (data && data.message) message = data.message;
          } catch (_) {}
          throw new Error(message);
        }

        const data = await res.json();
        return Array.isArray(data.items) ? data.items : [];
      }

      async function getBookings(force = false) {
        if (!force && bookingsLoaded) {
          return { data: bookingsData, hasPhone: true };
        }

        const phone = await ensureUserPhone();
        if (!phone) {
          bookingsData = [];
          bookingsLoaded = false;
          return { data: [], hasPhone: false };
        }

        try {
          bookingsData = await fetchBookings(phone);
          bookingsLoaded = true;
          return { data: bookingsData, hasPhone: true };
        } catch (err) {
          bookingsData = [];
          bookingsLoaded = false;
          throw err;
        }
      }

      function updateBookingsBadge() {
        const dataset = (Array.isArray(allBookings) && allBookings.length)
          ? allBookings
          : (Array.isArray(bookingsData) ? bookingsData : []);

        const pendingCount = dataset
          .filter(b => (b.status || '').toLowerCase() === 'pending')
          .length;

        const badges = document.querySelectorAll('#bookings-badge');
        if (!badges.length) return;

        badges.forEach(badge => {
          if (pendingCount > 0) {
            badge.textContent = pendingCount.toLocaleString('fa-IR');
            badge.classList.remove('hidden');
          } else {
            badge.textContent = '';
            badge.classList.add('hidden');
          }
        });
      }

      function updateBookingsBadgeDisplay() {
        updateBookingsBadge();
      }

      async function refreshBookingsBadge(force = false) {
        const badges = document.querySelectorAll('#bookings-badge');
        if (!badges.length) return;

        try {
          const result = await getBookings(force);
          if (!result.hasPhone) {
            badges.forEach(b => {
              b.textContent = '';
              b.classList.add('hidden');
            });
            allBookings = [];
            return;
          }
          allBookings = Array.isArray(result.data) ? result.data : [];
          updateBookingsBadge();
        } catch (err) {
          console.error('refreshBookingsBadge error:', err);
          badges.forEach(b => {
            b.textContent = '';
            b.classList.add('hidden');
          });
          allBookings = [];
        }
      }

      // Load user's bookings
      async function loadBookings() {
        try {
          const token = localStorage.getItem('token');

          // Check if user is actually logged in
          if (!token) {
            console.log('No auth token found, skipping bookings');
            bookingsLoaded = false;
            allBookings = [];
            bookingsData = [];
            renderBookings([]);
            updateBookingsBadge();
            return;
          }

          const response = await fetch('/api/user/bookings', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const payload = await response.json();
            const bookings = Array.isArray(payload)
              ? payload
              : (Array.isArray(payload?.items) ? payload.items : []);

            allBookings = bookings;
            bookingsData = bookings;
            bookingsLoaded = true;
            renderBookings(allBookings);
            updateBookingsBadge();
          } else if (response.status === 401) {
            // User not authenticated - this is OK, just don't show bookings
            console.log('User not authenticated for bookings');
            allBookings = [];
            bookingsData = [];
            bookingsLoaded = false;
            renderBookings([]);
            updateBookingsBadge();
          } else {
            console.error('Failed to load bookings:', response.status);
          }
        } catch (error) {
          console.error('Error loading bookings:', error);
        }
      }

      // Cancel a booking
      async function cancelBooking(bookingId) {
        // Confirm with user
        if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø±Ø²Ø±Ùˆ Ø±Ø§ Ù„ØºÙˆ Ú©Ù†ÛŒØ¯ØŸ')) {
          return;
        }

        try {
          const token = localStorage.getItem('token');

          const response = await fetch(`/api/bookings/${bookingId}/cancel`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            alert('Ø±Ø²Ø±Ùˆ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ØºÙˆ Ø´Ø¯');

            // Reload bookings to show updated status
            await loadBookings();
          } else {
            const error = await response.json();
            alert(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ø±Ø²Ø±Ùˆ');
          }
        } catch (error) {
          console.error('Error cancelling booking:', error);
          alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
        }
      }

      async function loadBookingsSection() {
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
    <!-- Bookings Section -->
    <div id="bookings-section" class="section hidden">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Ø±Ø²Ø±ÙˆÙ‡Ø§ÛŒ Ù…Ù†</h2>
        
        <!-- Status Filter Buttons -->
        <div class="flex flex-wrap gap-3 mb-6">
          <button data-status="all" class="filter-btn active px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-all duration-200 ease-out">
            Ù‡Ù…Ù‡
          </button>
          <button data-status="pending" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯
          </button>
          <button data-status="confirmed" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡
          </button>
          <button data-status="completed" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡
          </button>
          <button data-status="cancelled" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200 ease-out">
            Ù„ØºÙˆ Ø´Ø¯Ù‡
          </button>
        </div>
        
        <!-- Bookings Container -->
        <div id="bookings-container" class="space-y-4">
          <div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ø±ÙˆÙ‡Ø§...</div>
        </div>
        
        <!-- Empty State -->
        <div id="no-bookings" class="text-center py-12 hidden">
          <div class="text-6xl mb-4">ğŸ“…</div>
          <p class="text-gray-500 text-lg mb-2">Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø±Ø²Ø±ÙˆÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>
          <p class="text-gray-400 mb-6">Ø¨Ø±Ø§ÛŒ Ø±Ø²Ø±Ùˆ Ø®Ø¯Ù…Ø§ØªØŒ Ø§Ø² ØµÙØ­Ù‡ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ú©Ù†ÛŒØ¯</p>
          <a href="/service-directory.html" class="inline-block px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
            Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø®Ø¯Ù…Ø§Øª
          </a>
        </div>
      </div>
    </div>
  `;

        const section = document.getElementById('bookings-section');
        if (section) section.classList.remove('hidden');

        // Add event listeners for filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const status = btn.dataset.status;
            filterBookings(status, e);
          });
        });

        const container = document.getElementById('bookings-container');
        const emptyState = document.getElementById('no-bookings');
        if (container) container.innerHTML = `<div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ø±ÙˆÙ‡Ø§...</div>`;
        if (emptyState) emptyState.classList.add('hidden');

        try {
          const result = await getBookings(true);
          if (!result.hasPhone) {
            if (container) {
              container.innerHTML = `<div class="text-center text-red-400 py-12">Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ø²Ø±ÙˆÙ‡Ø§ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.</div>`;
            }
            allBookings = [];
            updateBookingsBadge();
            return;
          }

          allBookings = Array.isArray(result.data) ? result.data : [];
          bookingsData = allBookings;
          updateBookingsBadge();
          filterBookings('all');
        } catch (err) {
          console.error('loadBookingsSection error:', err);
          if (container) {
            container.innerHTML = `<div class="text-center text-red-400 py-12">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ø±ÙˆÙ‡Ø§. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</div>`;
          }
          allBookings = [];
          updateBookingsBadge();
        }
      }

      function filterBookings(status, evt) {
        const normalized = (status || 'all').toLowerCase();
        currentBookingFilter = normalized;

        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active', 'bg-blue-500', 'text-white');
          btn.classList.add('border', 'border-gray-300');
        });

        const target = evt?.currentTarget || evt?.target || document.querySelector(`.filter-btn[data-status="${normalized}"]`);
        if (target) {
          target.classList.add('active', 'bg-blue-500', 'text-white');
          target.classList.remove('border', 'border-gray-300');
        }

        if (!Array.isArray(allBookings) || allBookings.length === 0) {
          renderBookings([]);
          return;
        }

        const filtered = normalized === 'all'
          ? allBookings
          : allBookings.filter(item => (item.status || '').toLowerCase() === normalized);

        if (!filtered.length) {
          const container = document.getElementById('bookings-container');
          const noBookings = document.getElementById('no-bookings');
          if (container && noBookings) {
            container.classList.remove('hidden');
            container.innerHTML = `<div class="text-center text-gray-400 py-10 transition-opacity duration-300 ease-out">Ø±Ø²Ø±ÙˆÛŒ Ø¨Ø§ Ø§ÛŒÙ† ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</div>`;
            noBookings.classList.add('hidden');
          }
          return;
        }

        renderBookings(filtered);
      }

      // Render bookings to the page
      function renderBookings(bookings) {
        const container = document.getElementById('bookings-container');
        const noBookings = document.getElementById('no-bookings');

        if (!container || !noBookings) {
          return;
        }

        if (!bookings || bookings.length === 0) {
          container.classList.add('hidden');
          container.innerHTML = '';
          noBookings.classList.remove('hidden');
          return;
        }

        container.classList.remove('hidden');
        noBookings.classList.add('hidden');

        container.innerHTML = bookings.map(booking => `
    <div class="booking-card border rounded-lg p-5 transition-all duration-300 ease-out transform hover:shadow-xl hover:-translate-y-1 ${getBookingStatusClass(booking.status)}">
      <div class="flex justify-between items-start flex-wrap gap-4">
        <div class="flex-1 min-w-0">
          <h3 class="font-bold text-lg mb-3 text-gray-800">${escapeHtml(booking.service)}</h3>

          <div class="space-y-2 text-sm">
            <p class="text-gray-700 flex items-center gap-2">
              <span class="text-lg">ğŸ“</span>
              ${booking.sellerUrl ?
                `<a href="/shop.html?shopurl=${encodeURIComponent(booking.sellerUrl)}"
                   class="text-blue-600 hover:text-blue-800 hover:underline transition-all duration-200 cursor-pointer font-medium"
                   target="_blank">
                  ${escapeHtml(booking.sellerName || 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}
                </a>` :
                `<span class="missing-seller-link text-blue-600 hover:text-blue-800 hover:underline cursor-pointer">
                  ${escapeHtml(booking.sellerName || 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡')}
                </span>`
              }
            </p>
            <p class="text-gray-700 flex items-center gap-2">
              <span class="text-lg">ğŸ“…</span>
              <span>${escapeHtml(booking.bookingDate)}</span>
            </p>
            <p class="text-gray-700 flex items-center gap-2">
              <span class="text-lg">â°</span>
              <span>${escapeHtml(booking.startTime)}</span>
            </p>
          </div>

          <div class="mt-3">
            <span class="inline-block px-3 py-1 rounded-full text-sm font-medium ${getStatusBadgeClass(booking.status)}">
              ${getStatusLabel(booking.status)}
            </span>
          </div>
        </div>

        <div class="flex gap-2 flex-wrap">
          <button
            data-booking-id="${booking._id}"
            class="show-booking-details px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm font-medium shadow-sm hover:shadow-md">
            Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ø²Ø±Ùˆ
          </button>
          ${(booking.status === 'pending' || booking.status === 'confirmed') ? `
            <button
              data-booking-id="${booking._id}"
              class="cancel-booking px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm font-medium shadow-sm hover:shadow-md">
              Ù„ØºÙˆ Ø±Ø²Ø±Ùˆ
            </button>
          ` : ''}
        </div>
      </div>
    </div>
  `).join('');

        // Add event listeners for booking action buttons
        container.querySelectorAll('.show-booking-details').forEach(btn => {
          btn.addEventListener('click', () => {
            const bookingId = btn.dataset.bookingId;
            showBookingDetails(bookingId);
          });
        });

        container.querySelectorAll('.cancel-booking').forEach(btn => {
          btn.addEventListener('click', () => {
            const bookingId = btn.dataset.bookingId;
            cancelBooking(bookingId);
          });
        });

        container.querySelectorAll('.missing-seller-link').forEach(span => {
          span.addEventListener('click', () => {
            alert('Ù„ÛŒÙ†Ú© ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª');
          });
        });
      }

      function getBookingStatusClass(status) {
        const classes = {
          'pending': 'border-yellow-400/70 bg-yellow-50/80 backdrop-blur-sm shadow-sm',
          'confirmed': 'border-green-400/70 bg-green-50/80 backdrop-blur-sm shadow-sm',
          'completed': 'border-slate-300 bg-slate-50/90 backdrop-blur-sm shadow-sm',
          'cancelled': 'border-red-400/70 bg-red-50/80 backdrop-blur-sm shadow-sm'
        };
        const key = (status || '').toLowerCase();
        return classes[key] || 'border-gray-300 bg-white/90 backdrop-blur-sm';
      }

      function getStatusBadgeClass(status) {
        const classes = {
          'pending': 'bg-yellow-200 text-yellow-800 border border-yellow-400 shadow-sm',
          'confirmed': 'bg-green-200 text-green-800 border border-green-400 shadow-sm',
          'completed': 'bg-gray-200 text-gray-800 border border-gray-400 shadow-sm',
          'cancelled': 'bg-red-200 text-red-800 border border-red-400 shadow-sm'
        };
        const key = (status || '').toLowerCase();
        return classes[key] || 'bg-gray-100 text-gray-600';
      }

      function getStatusAccentClass(status) {
        const accents = {
          'pending': 'accent-amber',
          'confirmed': 'accent-emerald',
          'completed': 'accent-slate',
          'cancelled': 'accent-rose'
        };
        const key = (status || '').toLowerCase();
        return accents[key] || 'accent-slate';
      }

      function getStatusLabel(status) {
        const labels = {
          'pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯',
          'confirmed': 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡',
          'completed': 'Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡',
          'cancelled': 'Ù„ØºÙˆ Ø´Ø¯Ù‡'
        };
        const key = (status || '').toLowerCase();
        return labels[key] || (status || 'Ù†Ø§Ù…Ø´Ø®Øµ');
      }

      async function cancelBooking(id) {
        if (!id) return;

        const confirmed = window.confirm('Ø¢ÛŒØ§ Ø§Ø² Ù„ØºÙˆ Ø§ÛŒÙ† Ø±Ø²Ø±Ùˆ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ');
        if (!confirmed) return;

        const token = localStorage.getItem('token');
        if (!token) {
          alert('Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø±Ø²Ø±Ùˆ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.');
          return;
        }

        try {
          const response = await fetch(`/api/bookings/${encodeURIComponent(id)}/cancel`, {
            method: 'PUT',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const message = errorData.message || 'Ù„ØºÙˆ Ø±Ø²Ø±Ùˆ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.';
            alert(message);
            return;
          }

          bookingsData = Array.isArray(bookingsData)
            ? bookingsData.map(booking => booking._id === id ? { ...booking, status: 'cancelled' } : booking)
            : [];
          allBookings = bookingsData;

          filterBookings(currentBookingFilter || 'all');
          updateBookingsBadge();

          alert('Ø±Ø²Ø±Ùˆ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ØºÙˆ Ø´Ø¯.');
        } catch (error) {
          console.error('cancelBooking error:', error);
          alert('Ù„ØºÙˆ Ø±Ø²Ø±Ùˆ Ø¨Ø§ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.');
        }
      }

      // Show booking details modal
      function showBookingDetails(bookingId) {
        if (!bookingId) return;

        // Find the booking in our data
        const booking = allBookings.find(b => b._id === bookingId);
        if (!booking) {
          alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø²Ø±Ùˆ ÛŒØ§ÙØª Ù†Ø´Ø¯');
          return;
        }

        // Format created date in Persian if available
        let createdDate = 'Ù†Ø§Ù…Ø´Ø®Øµ';
        if (booking.createdAt) {
          try {
            const date = new Date(booking.createdAt);
            createdDate = date.toLocaleDateString('fa-IR', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch (e) {
            createdDate = booking.createdAt;
          }
        }

        if (typeof bookingModalCleanup === 'function') {
          bookingModalCleanup();
        }

        const isMobile = window.matchMedia('(max-width: 767px)').matches;
        const bookingIdRaw = booking._id == null ? '' : String(booking._id);
        const bookingIdSafe = escapeHtml(bookingIdRaw || 'Ù†Ø§Ù…Ø´Ø®Øµ');
        const bookingIdAttr = escapeHtml(bookingIdRaw);
        const serviceName = escapeHtml(booking.service || 'Ù†Ø§Ù…Ø´Ø®Øµ');
        const sellerName = escapeHtml(booking.sellerName || 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡');
        const bookingDateSafe = escapeHtml(booking.bookingDate || 'Ù†Ø§Ù…Ø´Ø®Øµ');
        const bookingTimeSafe = escapeHtml(booking.startTime || 'Ù†Ø§Ù…Ø´Ø®Øµ');
        const createdDateSafe = escapeHtml(createdDate);
        const customerNameSafe = booking.customerName ? escapeHtml(booking.customerName) : '';
        const customerPhoneSafe = booking.customerPhone ? escapeHtml(booking.customerPhone) : '';
        const statusLabelSafe = escapeHtml(getStatusLabel(booking.status));
        const statusBadgeClass = `modal-status-badge ${getStatusBadgeClass(booking.status)}`;
        const statusAccentClass = getStatusAccentClass(booking.status);
        const sellerUrl = booking.sellerUrl ? `/shop.html?shopurl=${encodeURIComponent(booking.sellerUrl)}` : '';
        const sellerLinkHtml = sellerUrl
          ? `<a href="${sellerUrl}" class="modal-link" target="_blank" rel="noopener noreferrer">${sellerName}<svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M5.5 5.5a.75.75 0 0 1 .75-.75h8a.75.75 0 0 1 .75.75v8a.75.75 0 0 1-1.5 0V7.56l-8.22 8.22a.75.75 0 0 1-1.06-1.06l8.22-8.22H6.25a.75.75 0 0 1-.75-.75Z"></path></svg></a>`
          : `<span class="modal-field-value">${sellerName}</span>`;

        const subtitleParts = [];
        if (booking.service) subtitleParts.push(`Ø±Ø²Ø±Ùˆ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ ${serviceName}`);
        if (booking.sellerName) subtitleParts.push(`Ø¯Ø± ${sellerName}`);
        const subtitleText = subtitleParts.length ? subtitleParts.join(' ') : 'Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ Ø±Ø²Ø±Ùˆ Ø´Ù…Ø§';

        const customerSection = (customerNameSafe || customerPhoneSafe) ? `
              <section class="modal-section accent-purple">
                <div class="modal-section-header">
                  <div class="modal-section-icon">ğŸ‘¤</div>
                  <div>
                    <h3>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ</h3>
                    <p class="modal-section-note">Ø±Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø´Ù…Ø§</p>
                  </div>
                </div>
                <div class="booking-meta-grid">
                  ${customerNameSafe ? `
                    <div class="modal-field">
                      <span class="modal-field-label">Ù†Ø§Ù…</span>
                      <span class="modal-field-value">${customerNameSafe}</span>
                    </div>
                  ` : ''}
                  ${customerPhoneSafe ? `
                    <div class="modal-field">
                      <span class="modal-field-label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</span>
                      <span class="modal-field-value" dir="ltr">${customerPhoneSafe}</span>
                    </div>
                  ` : ''}
                </div>
              </section>
        ` : '';

        const modalClasses = `booking-modal-backdrop${isMobile ? ' is-mobile' : ''}`;
        const modalHtml = `
          <div id="bookingDetailsModal" class="${modalClasses}" role="dialog" aria-modal="true" aria-labelledby="bookingModalTitle">
            <div class="booking-modal-content" tabindex="-1">
              <header class="booking-modal-header">
                <div class="header-info">
                  <div class="header-icon">ğŸ—“ï¸</div>
                  <div>
                    <h2 id="bookingModalTitle" class="booking-modal-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ø²Ø±Ùˆ</h2>
                    <p class="booking-modal-subtitle">${subtitleText}</p>
                  </div>
                </div>
                <button type="button" class="close-booking-modal" aria-label="Ø¨Ø³ØªÙ† Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ø²Ø±Ùˆ">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l12 12M6 18L18 6" />
                  </svg>
                </button>
              </header>

              <div class="booking-modal-body" id="bookingModalBody">
                <section class="modal-section accent-slate">
                  <div class="modal-section-header">
                    <div class="modal-section-icon">ğŸ“‹</div>
                    <div>
                      <h3>Ø´Ù†Ø§Ø³Ù‡ Ø±Ø²Ø±Ùˆ</h3>
                      <p class="modal-section-note">Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ Ø¯Ø± ÙˆÛŒØªØ±ÛŒÙ†Øª</p>
                    </div>
                  </div>
                  <div class="booking-id-wrap">
                    <code class="booking-id-value" dir="ltr">${bookingIdSafe}</code>
                    <button type="button" class="booking-id-copy" data-booking-id="${bookingIdAttr}" aria-label="Ú©Ù¾ÛŒ Ø´Ù†Ø§Ø³Ù‡ Ø±Ø²Ø±Ùˆ">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 9.75A2.25 2.25 0 0 1 11.25 7.5h7.5A2.25 2.25 0 0 1 21 9.75v7.5A2.25 2.25 0 0 1 18.75 19.5h-7.5A2.25 2.25 0 0 1 9 17.25v-7.5Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 14.25H5.25A2.25 2.25 0 0 1 3 12V5.25A2.25 2.25 0 0 1 5.25 3h6.75a2.25 2.25 0 0 1 2.25 2.25V6" />
                      </svg>
                      <span>Ú©Ù¾ÛŒ</span>
                    </button>
                  </div>
                  <span class="copy-feedback" role="status" aria-live="polite"></span>
                </section>

                <section class="modal-section accent-blue">
                  <div class="modal-section-header">
                    <div class="modal-section-icon">ğŸª</div>
                    <div>
                      <h3>Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø¯Ù…Øª Ùˆ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</h3>
                      <p class="modal-section-note">Ù†Ø§Ù… Ø®Ø¯Ù…Øª Ùˆ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</p>
                    </div>
                  </div>
                  <div class="modal-field">
                    <span class="modal-field-label">Ø®Ø¯Ù…Øª</span>
                    <span class="modal-field-value">${serviceName}</span>
                  </div>
                  <div class="modal-field">
                    <span class="modal-field-label">ÙØ±ÙˆØ´Ú¯Ø§Ù‡</span>
                    ${sellerLinkHtml}
                  </div>
                </section>

                <section class="modal-section accent-emerald">
                  <div class="modal-section-header">
                    <div class="modal-section-icon">ğŸ“…</div>
                    <div>
                      <h3>Ø²Ù…Ø§Ù† Ø±Ø²Ø±Ùˆ</h3>
                      <p class="modal-section-note">ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø­Ø¶ÙˆØ± Ø´Ù…Ø§</p>
                    </div>
                  </div>
                  <div class="booking-meta-grid">
                    <div class="modal-field">
                      <span class="modal-field-label">ØªØ§Ø±ÛŒØ®</span>
                      <span class="modal-field-value">${bookingDateSafe}</span>
                    </div>
                    <div class="modal-field">
                      <span class="modal-field-label">Ø³Ø§Ø¹Øª</span>
                      <span class="modal-field-value" dir="ltr">${bookingTimeSafe}</span>
                    </div>
                  </div>
                </section>

                <section class="modal-section ${statusAccentClass}">
                  <div class="modal-section-header">
                    <div class="modal-section-icon">ğŸ“Š</div>
                    <div>
                      <h3>ÙˆØ¶Ø¹ÛŒØª Ø±Ø²Ø±Ùˆ</h3>
                      <p class="modal-section-note">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª</p>
                    </div>
                  </div>
                  <div class="modal-field">
                    <span class="${statusBadgeClass}">${statusLabelSafe}</span>
                  </div>
                </section>

                <section class="modal-section accent-slate">
                  <div class="modal-section-header">
                    <div class="modal-section-icon">ğŸ•</div>
                    <div>
                      <h3>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª Ø±Ø²Ø±Ùˆ</h3>
                      <p class="modal-section-note">Ø²Ù…Ø§Ù† Ø«Ø¨Øª Ø¯Ø± Ø³ÛŒØ³ØªÙ… ÙˆÛŒØªØ±ÛŒÙ†Øª</p>
                    </div>
                  </div>
                  <div class="modal-field">
                    <span class="modal-field-label">Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¯Ø±</span>
                    <span class="modal-field-value">${createdDateSafe}</span>
                  </div>
                </section>

                ${customerSection}
              </div>

              <footer class="booking-modal-footer">
                <button type="button" class="booking-close-btn close-booking-modal">Ø¨Ø³ØªÙ†</button>
              </footer>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const modal = document.getElementById('bookingDetailsModal');
        if (!modal) {
          return;
        }

        const content = modal.querySelector('.booking-modal-content');
        const closeButtons = modal.querySelectorAll('.close-booking-modal');
        closeButtons.forEach(btn => btn.addEventListener('click', closeBookingDetails));

        const onBackdropClick = (event) => {
          if (event.target === modal) {
            closeBookingDetails();
          }
        };
        modal.addEventListener('click', onBackdropClick);

        const focusableSelectors = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
        const focusableElements = content ? Array.from(content.querySelectorAll(focusableSelectors)) : [];
        const firstFocusable = focusableElements[0] || content;
        const lastFocusable = focusableElements[focusableElements.length - 1] || content;

        setTimeout(() => {
          if (firstFocusable) {
            firstFocusable.focus();
          } else if (content) {
            content.focus();
          }
        }, 30);

        const trapListener = (event) => {
          if (event.key !== 'Tab') {
            return;
          }
          if (!focusableElements.length) {
            event.preventDefault();
            content?.focus();
            return;
          }
          if (event.shiftKey) {
            if (document.activeElement === firstFocusable) {
              event.preventDefault();
              (lastFocusable || firstFocusable).focus();
            }
          } else if (document.activeElement === lastFocusable) {
            event.preventDefault();
            (firstFocusable || lastFocusable).focus();
          }
        };

        const escListener = (event) => {
          if (event.key === 'Escape') {
            event.preventDefault();
            closeBookingDetails();
          }
        };

        modal.addEventListener('keydown', trapListener);
        document.addEventListener('keydown', escListener);

        const copyButton = modal.querySelector('.booking-id-copy');
        const copyFeedback = modal.querySelector('.copy-feedback');
        let copyFeedbackTimeout = null;

        if (copyButton) {
          copyButton.addEventListener('click', async () => {
            const value = copyButton.dataset.bookingId || '';
            if (!value) {
              return;
            }

            const showFeedback = (message, color = '#0ea5e9') => {
              if (!copyFeedback) return;
              copyFeedback.textContent = message;
              copyFeedback.style.color = color;
              copyFeedback.classList.add('visible');
              if (copyFeedbackTimeout) {
                clearTimeout(copyFeedbackTimeout);
              }
              copyFeedbackTimeout = setTimeout(() => {
                copyFeedback?.classList.remove('visible');
              }, 2200);
            };

            try {
              if (navigator.clipboard?.writeText) {
                await navigator.clipboard.writeText(value);
              } else {
                throw new Error('clipboard unavailable');
              }
              showFeedback('Ø´Ù†Ø§Ø³Ù‡ Ø±Ø²Ø±Ùˆ Ú©Ù¾ÛŒ Ø´Ø¯ âœ…');
            } catch (error) {
              try {
                const tempInput = document.createElement('textarea');
                tempInput.value = value;
                tempInput.setAttribute('readonly', '');
                tempInput.style.position = 'absolute';
                tempInput.style.left = '-9999px';
                document.body.appendChild(tempInput);
                tempInput.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(tempInput);
                if (successful) {
                  showFeedback('Ø´Ù†Ø§Ø³Ù‡ Ø±Ø²Ø±Ùˆ Ú©Ù¾ÛŒ Ø´Ø¯ âœ…');
                } else {
                  showFeedback('Ø§Ù…Ú©Ø§Ù† Ú©Ù¾ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', '#ef4444');
                }
              } catch (fallbackError) {
                console.error('Copy booking id failed:', fallbackError);
                showFeedback('Ø§Ù…Ú©Ø§Ù† Ú©Ù¾ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', '#ef4444');
              }
            }
          });
        }

        let touchStartY = null;
        let currentTranslateY = 0;

        const resetTranslate = () => {
          if (content) {
            content.style.transition = '';
            content.style.transform = '';
          }
        };

        const handleTouchStart = (event) => {
          if (!content || !isMobile) return;
          if (event.touches.length !== 1) return;
          if (content.scrollTop > 0) return;
          touchStartY = event.touches[0].clientY;
          currentTranslateY = 0;
          content.style.transition = 'none';
        };

        const handleTouchMove = (event) => {
          if (!content || !isMobile) return;
          if (touchStartY === null) return;
          const diff = event.touches[0].clientY - touchStartY;
          if (diff > 0 && content.scrollTop <= 0) {
            event.preventDefault();
            currentTranslateY = Math.min(diff, 180);
            content.style.transform = `translateY(${currentTranslateY}px)`;
          }
        };

        const handleTouchEnd = () => {
          if (!content || !isMobile) return;
          content.style.transition = '';
          if (currentTranslateY > 130) {
            resetTranslate();
            closeBookingDetails();
          } else {
            resetTranslate();
          }
          touchStartY = null;
          currentTranslateY = 0;
        };

        if (content && isMobile) {
          content.addEventListener('touchstart', handleTouchStart, { passive: true });
          content.addEventListener('touchmove', handleTouchMove, { passive: false });
          content.addEventListener('touchend', handleTouchEnd);
          content.addEventListener('touchcancel', handleTouchEnd);
        }

        document.body.classList.add('booking-modal-open');

        const cleanup = (removeNode = true) => {
          modal.removeEventListener('click', onBackdropClick);
          modal.removeEventListener('keydown', trapListener);
          document.removeEventListener('keydown', escListener);
          if (content && isMobile) {
            content.removeEventListener('touchstart', handleTouchStart);
            content.removeEventListener('touchmove', handleTouchMove);
            content.removeEventListener('touchend', handleTouchEnd);
            content.removeEventListener('touchcancel', handleTouchEnd);
          }
          if (copyFeedbackTimeout) {
            clearTimeout(copyFeedbackTimeout);
            copyFeedbackTimeout = null;
          }
          document.body.classList.remove('booking-modal-open');
          if (removeNode && modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
          bookingModalCleanup = null;
        };

        bookingModalCleanup = cleanup;
      }

      // Close booking details modal
      function closeBookingDetails() {
        const modal = document.getElementById('bookingDetailsModal');
        if (!modal) {
          if (typeof bookingModalCleanup === 'function') {
            bookingModalCleanup();
          }
          return;
        }

        if (modal.classList.contains('closing')) {
          return;
        }

        const content = modal.querySelector('.booking-modal-content');
        if (content) {
          content.style.transform = '';
          content.style.transition = '';
          content.classList.add('closing');
        }
        modal.classList.add('closing');

        const handleAnimationEnd = (event) => {
          if (event.target !== modal) return;
          modal.removeEventListener('animationend', handleAnimationEnd);
          if (typeof bookingModalCleanup === 'function') {
            bookingModalCleanup();
          }
        };

        modal.addEventListener('animationend', handleAnimationEnd);

        setTimeout(() => {
          if (document.getElementById('bookingDetailsModal')) {
            if (typeof bookingModalCleanup === 'function') {
              bookingModalCleanup();
            }
          }
        }, 400);
      }

      // Helper to escape HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text == null ? '' : String(text);
        return div.innerHTML;
      }

      // Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
  const dashboardSection = `
  <div class="glass flex flex-col md:flex-row items-center justify-between px-5 md:px-8 py-5 md:py-7 fadein gap-3 md:gap-0">
    <div>
      <div class="text-xl md:text-2xl font-black primary-text mb-1">ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ Ú©Ø§Ø±Ø¨Ø± Ø¹Ø²ÛŒØ²!</div>
      <div class="text-gray-500 text-sm md:text-base">Ø§Ù…ÛŒØ¯ÙˆØ§Ø±ÛŒÙ… ØªØ¬Ø±Ø¨Ù‡â€ŒÛŒ Ø®ÙˆØ¨ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.</div>
    </div>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-5 fadein">
    <div id="favBoxClick" class="glass p-6 flex flex-col items-center text-center min-h-[135px] justify-center cursor-pointer hover:shadow-lg transition">
      <div class="text-[#0ea5e9] font-bold text-base mb-1">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</div>
      <div class="text-4xl font-black primary-text mb-1" id="favCountDashboard">-</div>
    <a href="#" class="text-xs font-bold text-[#0ea5e9] hover:underline menu-btn mt-2" data-section="favorites">Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª</a>
    </div>
    <div id="recentFavsContainerWrapper" class="flex flex-col">
      <div id="recentFavsContainer"></div>
    </div>
  </div>
  `;





  async function renderRecentFavorites() {
    const container = document.getElementById('recentFavsContainer');
    container.innerHTML = `
      <div class="glass px-6 py-5 fadein">
        <div class="flex items-center justify-between mb-4">
          <span id="recentFavsTitle" class="text-lg font-bold primary-text cursor-pointer">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± Ø´Ù…Ø§</span>
          <a href="#" id="recentFavsShowAll" class="text-[#0ea5e9] hover:underline font-bold text-sm menu-btn">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡</a>
        </div>
        <div class="flex flex-wrap gap-3 scrollbar-hide overflow-x-auto" id="recentFavsList">
          <div class="text-gray-400 text-center w-full py-3">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ...</div>
        </div>
      </div>
    `;

    try {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ú©ÙˆÚ©ÛŒ Ùˆ Ø¨Ø¯ÙˆÙ† Ù‡Ø¯Ø± Authorization
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include', // Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ (ØªÙˆÚ©Ù†) Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!res.ok) throw new Error();

      const user = await res.json();
      const favs = Array.isArray(user.favorites) ? user.favorites : [];

      const favsList = container.querySelector("#recentFavsList");
      if (favs.length === 0) {
        favsList.innerHTML = `<div class="text-gray-400 text-center w-full py-3">Ù‡Ù†ÙˆØ² Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯ÛŒ!</div>`;
      } else {
        favsList.innerHTML = favs.slice(-3).reverse().map(p => {
          const shop = (p.sellerId && typeof p.sellerId === 'object') ? p.sellerId : {};
          return `
            <div class="min-w-[170px] max-w-xs bg-[#e0fdfa] rounded-xl p-3 flex flex-col items-center text-center">
              <img src="${(p.images && p.images[0]) ? p.images[0] : '/assets/images/noimage.png'}" class="w-20 h-20 object-cover rounded-xl mb-2 shadow" alt="${p.title || ''}"/>
              <span class="text-[#10b981] text-base font-bold mb-1">${p.title || '-'}</span>
              <span class="text-xs text-gray-500 mb-1">${shop.storename ? `ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ${shop.storename}` : ''}</span>
              <span class="text-xs text-gray-600 mb-1">Ù‚ÛŒÙ…Øª: ${p.price ? p.price.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†' : '-'}</span>
              <a href="http://localhost:5000/product.html?id=${p._id}" class="mt-2 px-4 py-1.5 rounded-lg brand-btn text-xs font-bold inline-block" target="_blank" rel="noopener noreferrer">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø­ØµÙˆÙ„</a>
            </div>
          `;
        }).join('');
      }
    } catch (e) {
      const favsList = container.querySelector("#recentFavsList");
      favsList.innerHTML = `<div class="text-red-400 text-center w-full py-3">Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.</div>`;
    }
  }






      // Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† SPA Ùˆ Ø±Ø³Ù¾Ø§Ù†Ø³ÛŒÙˆ
  function showSection(section) {
    const mainContent = document.getElementById('mainContent');
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ù…Ù†ÙˆÙ‡Ø§
    document.querySelectorAll('.menu-btn').forEach(btn=>btn.classList.remove('tab-active'));
    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù…Ù†ÙˆÛŒ ÙØ¹Ù„ÛŒ
  document.querySelectorAll(`.menu-btn[data-section="${section}"]`).forEach(btn => btn.classList.add('tab-active'));
    // Ù…Ø­ØªÙˆØ§
    if(section === 'dashboard') {
      mainContent.innerHTML = dashboardSection;
      renderRecentFavorites(); // Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù†Ø¯Ø± Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø±Ùˆ ØµØ¯Ø§ Ø¨Ø²Ù†
      updateDashboardFavCount(); // Ø§ÛŒÙ†Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† ØªØ§ ØªØ¹Ø¯Ø§Ø¯ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ø¯Ø±Ø³Øª Ø¨Ø´Ù‡
    }
    else if(section === 'profile') loadProfileSection();
    else if(section === 'favorites') loadFavoritesSection();
    else if(section === 'favshops') loadFavShopsSection();
    else if(section === 'bookings') loadBookingsSection();
    else if(section === 'messages') loadMessagesSection();

    if(section === 'messages') startMsgPolling(); else stopMsgPolling();

    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¨Ø§Ù„Ø§
    mainContent.scrollIntoView({behavior:'smooth',block:'start'});
  }


  async function updateDashboardFavCount() {
    try {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ú©ÙˆÚ©ÛŒ (credentials: 'include')
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      if (!res.ok) {
        document.getElementById('favCountDashboard').textContent = '-';
        return;
      }
      const user = await res.json();
      document.getElementById('favCountDashboard').textContent =
        Array.isArray(user.favorites) ? user.favorites.length : '0';
    } catch (e) {
      document.getElementById('favCountDashboard').textContent = '-';
    }
  }


      // Ù…Ù†ÙˆÙ‡Ø§ÛŒ Ø¯Ø³Ú©ØªØ§Ù¾ Ùˆ Ù…ÙˆØ¨Ø§ÛŒÙ„

  /* â€”â€”â€” Ù‡Ù†Ø¯Ù„ Ù…Ù†ÙˆÙ‡Ø§ÛŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± (Ù…Ø³ØªÙ‚ÛŒÙ…) â€”â€”â€” */
  document.addEventListener('click', e => {
    const btn = e.target.closest('.menu-btn');
    if (!btn) return;
    e.preventDefault();
    showSection(btn.dataset.section);
    if (window.innerWidth < 1024) closeSidebar();
  });




      // Ø³ÙˆÛŒÛŒÚ† Ú©Ø±Ø¯Ù† Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
      document.getElementById('profileBtn').onclick=function(){
        showSection('profile');
        if(window.innerWidth<1024){
          openSidebar();
        }
      };

      // Ù‡Ù…Ø¨Ø±Ú¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
      function openSidebar(){
        document.getElementById('mobileSidebar').classList.add('open');
        document.getElementById('sidebarOverlay').classList.add('open');
        document.body.style.overflow='hidden';
      }
      function closeSidebar(){
        document.getElementById('mobileSidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('open');
        document.body.style.overflow='';
      }
      document.getElementById('hamBtn').onclick = openSidebar;
      document.getElementById('closeSidebar').onclick = closeSidebar;
      document.getElementById('sidebarOverlay').onclick = closeSidebar;
      document.addEventListener('keydown', function(e){
        if(e.key === "Escape"){
          closeSidebar();
        }
      });





  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± (Ù…ÙˆØ¨Ø§ÛŒÙ„ + Ø¯Ø³Ú©ØªØ§Ù¾)
  async function updateSidebarUser() {
    try {
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',          // Ø§Ø±Ø³Ø§Ù„ ØªÙˆÚ©Ù† Ø§Ø² Ø·Ø±ÛŒÙ‚ Ú©ÙˆÚ©ÛŒ
        headers: { 'Content-Type': 'application/json' }
      });
      if (!res.ok) throw new Error();

      const user   = await res.json();

      /* â†™ï¸ Ø¢ÛŒâ€ŒØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ú†Øªâ€ŒÙ‡Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ… */
      window.currentUserId = user._id;     

      const first  = user.firstname || user.firstName || 'Ú©Ø§Ø±Ø¨Ø±';
      const last   = user.lastname  || user.lastName  || 'ÙˆÛŒØªØ±ÛŒÙ†Øª';
      const phone  = user.phone     || user.mobile    || '';
      const masked = phone
        ? phone.toString().slice(0, 4) + '***' + phone.toString().slice(-3)
        : '---';

      document.querySelectorAll('.sidebar-user-name')
              .forEach(el => (el.textContent = `${first} ${last}`));

      document.querySelectorAll('.sidebar-user-mobile')
              .forEach(el => (el.textContent = masked));

      window.currentUserPhone = phone;
      refreshBookingsBadge();
    } catch (_) {
      /* Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¨ÙˆØ¯ØŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø±Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø±Ù‡Ø§ Ú©Ù† */
    }
  }








  async function loadFavoritesSection() {
    let html = `<div class="glass px-6 py-7 fadein"><div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div></div>`;
    document.getElementById('mainContent').innerHTML = html;

    try {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ú©ÙˆÚ©ÛŒ (credentials: 'include')
      const res = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include', // Ù…Ù‡Ù…!
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });

      if (!res.ok) throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
      const user = await res.json();
      const favs = user.favorites;

      if (!Array.isArray(favs) || favs.length === 0) {
        html = `<div class="glass px-6 py-7 fadein text-center text-gray-400">Ù‡ÛŒÚ† Ù…Ø­ØµÙˆÙ„ÛŒ Ø¯Ø± Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ù†ÛŒØ³Øª.</div>`;
      } else {
        html = `
        <div class="glass px-6 py-7 fadein">
          <div class="text-xl font-black primary-text mb-5">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</div>
          <div class="flex flex-wrap gap-4">
            ${favs.map(p => {
              const shop = (p.sellerId && typeof p.sellerId === 'object') ? p.sellerId : {};
              return `
                <div class="min-w-[170px] max-w-xs bg-[#e0fdfa] rounded-xl p-3 flex flex-col items-center text-center">
                  <img src="${(p.images && p.images[0]) ? p.images[0] : '/assets/images/noimage.png'}" class="w-24 h-24 object-cover rounded-xl mb-2 shadow" alt="${p.title || ''}"/>
                  <span class="text-[#10b981] text-lg font-bold mb-1">${p.title || '-'}</span>
                  <span class="text-xs text-gray-500 mb-1">${shop.storename ? `ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ${shop.storename}` : ''}</span>
                  <span class="text-xs text-gray-600 mb-1">Ù‚ÛŒÙ…Øª: ${p.price ? p.price.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†' : '-'}</span>
                  <a href="http://localhost:5000/product.html?id=${p._id}" class="mt-2 px-4 py-1.5 rounded-lg brand-btn text-xs font-bold inline-block" target="_blank" rel="noopener noreferrer">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø­ØµÙˆÙ„</a>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        `;
      }
    } catch (e) {
      html = `<div class="glass px-6 py-7 fadein text-center text-red-400">${e.message}</div>`;
    }

    document.getElementById('mainContent').innerHTML = html;
  }

  async function loadFavShopsSection() {
    let html = `<div class="glass px-6 py-7 fadein"><div class="text-center text-gray-400 py-12">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div></div>`;
    document.getElementById('mainContent').innerHTML = html;

    try {
      const res = await fetch('/api/favorite-shops', {
        method: 'GET',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-cache' }
      });
      if (!res.ok) throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
      const shops = await res.json();

      if (!Array.isArray(shops) || shops.length === 0) {
        html = `<div class="glass px-6 py-7 fadein text-center text-gray-400">Ù‡ÛŒÚ† Ù…ØºØ§Ø²Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ù„ÛŒØ³Øª Ù…Ø­Ø¨ÙˆØ¨â€ŒÙ‡Ø§ Ù†ÛŒØ³Øª.</div>`;
      } else {
        html = `
        <div class="glass px-6 py-7 fadein">
          <div class="text-xl font-black primary-text mb-5">Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø¨ÙˆØ¨ Ù…Ù†</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            ${shops.map(s => `
              <div class="bg-white rounded-xl shadow border border-gray-100 p-4 flex flex-col gap-2 text-center">
                <span class="text-lg font-bold text-[#10b981]">${s.storename || '-'}</span>
                <span class="text-xs text-gray-500">${s.category || ''}</span>
                <button data-id="${s._id}" class="removeFavShop mt-2 px-3 py-1.5 rounded-lg bg-red-50 text-red-600 border border-red-100 text-sm">Ø­Ø°Ù Ø§Ø² Ù…Ø­Ø¨ÙˆØ¨â€ŒÙ‡Ø§</button>
              </div>
            `).join('')}
          </div>
        </div>`;
      }
    } catch (e) {
      html = `<div class="glass px-6 py-7 fadein text-center text-red-400">${e.message}</div>`;
    }

    document.getElementById('mainContent').innerHTML = html;

    document.querySelectorAll('.removeFavShop').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        btn.disabled = true;
        try {
          await fetch(`/api/favorite-shops/${id}`, { method: 'DELETE', credentials: 'include' });
          loadFavShopsSection();
        } catch { btn.disabled = false; }
      });
    });
  }




  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€  Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±  â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ø¨Ø®Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ú©Ø§Ø±Ø¨Ø± â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const API_BASE  = '/api';           // Ø·Ø¨Ù‚ Ø³Ø±ÙˆØ±Øª
  let chatsList   = [];               // Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§
  let currentCid  = null;             // Ø¢ÛŒâ€ŒØ¯ÛŒ Ú†Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
  let blockedSellers = [];            // ÙØ±ÙˆØ´Ù†Ø¯Ú¯Ø§Ù† Ù…Ø³Ø¯ÙˆØ¯Ø´Ø¯Ù‡

async function loadMessagesSection() {
  const box = document.getElementById('mainContent');
  box.innerHTML = `
    <div id="messages-section" class="glass px-4 py-7 fadein">
      <div class="flex items-center justify-between mb-4">
        <span class="text-xl font-black primary-text">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ù†</span>
        <button class="open-admin-msg brand-btn text-sm px-3 py-1.5 rounded-xl">Ú†Øª Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª</button>
      </div>
      <div id="userChatsList" class="w-full min-h-[180px]"></div>
    </div>
  `;

  // Add event listener for admin message button
  const adminMsgBtn = document.querySelector('.open-admin-msg');
  if (adminMsgBtn) {
    adminMsgBtn.addEventListener('click', openAdminMsgModal);
  }

  await fetchBlockedSellers(); // ÙØ±ÙˆØ´Ù†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø³Ø¯ÙˆØ¯Ø´Ø¯Ù‡ Ø±Ø§ Ø¨Ú¯ÛŒØ±
  await fetchUserChats();  // Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ Ø±Ùˆ Ø¨Ú¯ÛŒØ±
  renderMessagesList();    // Ø±Ù†Ø¯Ø± Ú©Ù†
  startMsgPolling();       // polling Ø´Ø±ÙˆØ¹ Ú©Ù†
}

  /* Ú¯Ø±ÙØªÙ† Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ */
  /*  Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ÛŒ *Ø®ÙˆØ¯Ù Ú©Ø§Ø±Ø¨Ø±*  */
/* Ú¯Ø±ÙØªÙ† Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (ÙÙ‚Ø· Ù„ÛŒØ³ØªØŒ Ø¨Ø¯ÙˆÙ† Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */
async function fetchUserChats() {
  try {
    const res = await fetch(`${API_BASE}/chats/my`, {
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();

    const allChats = Array.isArray(data) ? data : (data.chats || []);
    const uid = window.currentUserId;

    chatsList = allChats.filter(c => {
      if (!uid) return false;
      if (c.type === 'admin' || c.type === 'user-admin' || c.type === 'admin-user') return true;
      if (c.userId && c.userId === uid) return true;
      if (Array.isArray(c.participants) && c.participants.some(p => {
        if (!p) return false;
        return (typeof p === 'string' && p === uid) ||
               (typeof p === 'object' && p._id === uid);
      })) return true;
      if (Array.isArray(c.users) && c.users.some(u => u._id === uid)) return true;
      return false;
    });


  } catch (e) {
    chatsList = [];
  }
}

async function loadMessages() {
  try {
    await fetchUserChats();
    updateBadge();
  } catch (error) {
    console.error('Error loading messages:', error);
  }
}


  /* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
/* Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ø´Ø®Øµ/Ù…Ø¯ÛŒØ±/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø·) */
function renderMessagesList() {
  const box = document.getElementById('userChatsList');
  console.log("Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§:", chatsList);

  if (!chatsList.length) {
    box.innerHTML = `<div class="text-gray-400 text-center py-8">Ù‡ÛŒÚ† Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒ! Ø§Ø² Ø¯Ú©Ù…Ù‡ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.</div>`;
    return;
  }

  // Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ
  const myId = window.currentUserId;

  box.innerHTML = chatsList.map(c => {
    console.log('Ø³Ø§Ø®ØªØ§Ø± Ú†Øª Ø¯Ø± Ù„ÛŒØ³Øª:', c._id, c);

    let whom = 'Ù…Ø®Ø§Ø·Ø¨'; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    let role = '';
    let sellerId = null;
    let storeName = '';
    let shopUrl = '';
    let isBlocked = false;

    if (Array.isArray(c.participants)) {
      const participant = c.participants.find(p => p && p._id !== myId);
      if (participant) {
        role = participant.role;
        sellerId = participant._id;
        storeName = participant.storename || '';
        shopUrl = participant.shopurl || '';
        whom = role === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : (role === 'admin' ? 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª' : (role === 'user' ? 'Ù…Ø´ØªØ±ÛŒ' : 'Ù…Ø®Ø§Ø·Ø¨'));
      }
    }

    if (role === 'seller' && sellerId) {
      isBlocked = blockedSellers.includes(sellerId);
    }

    if (!role && Array.isArray(c.participantsModel)) {
      if (c.participantsModel.includes('Admin')) {
        role = 'admin';
        whom = 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
      } else if (c.participantsModel.includes('Seller')) {
        role = 'seller';
        whom = 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
      }
    }

    // fallback Ø§Ø² type
    if (!role && c.type) {
      if (c.type === 'user-seller' || c.type === 'seller-admin') {
        whom = 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
        role = 'seller';
        sellerId = c.sellerId;
    } else if (c.type === 'user-admin' || c.type === 'admin-user' || c.type === 'admin') {
      whom = 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
      role = 'admin';
    }
    }

    let whomDisplay = whom;
    if (role === 'seller' && sellerId) {
      const linkUrl = shopUrl ? `/store/${shopUrl}` : `/store.html?id=${sellerId}`;
      const linkText = storeName ? `ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (${storeName})` : 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
      whomDisplay = `<a href="${linkUrl}" class="text-[#10b981] hover:text-blue-700 hover:underline font-semibold" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
    }

let prodBlock = '';
if (c.productId && c.productId.title) {
  const productUrl = `/product.html?id=${c.productId._id}`;
  prodBlock = `
    <div class="flex items-center gap-2 mt-2">
      <!-- ÙÙ‚Ø· Ø¹Ú©Ø³ Ù„ÛŒÙ†Ú©â€ŒØ¯Ø§Ø± -->
      <a href="${productUrl}" target="_blank" rel="noopener noreferrer">
        <img src="${c.productId.images?.[0] || '/assets/images/noimage.png'}" 
             class="w-10 h-10 object-cover rounded-lg border" alt="">
      </a>
      <!-- Ø§Ø³Ù… Ù…Ø­ØµÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ù„ÛŒÙ†Ú© -->
      <span class="text-xs text-gray-600">${c.productId.title}</span>
    </div>
  `;
}


    const last = c.messages?.[c.messages.length - 1] || {};
    const txt = (last.text || '-').slice(0, 45) + (last.text?.length > 45 ? 'â€¦' : '');
    const date = last.createdAt
      ? new Date(last.createdAt).toLocaleDateString('fa-IR', { year: '2-digit', month: '2-digit', day: '2-digit' })
      : 'â€”';
    const unread = (c.messages || []).filter(m => !m.read && m.from !== 'user').length;

    let avatarText = 'ØŸ';
    if (whom && typeof whom === 'string') {
      avatarText = whom.slice(0, 2);
    }

return `
  <div class="chat-card flex items-start gap-3 p-3 mb-2 bg-[#f9fafb] rounded-xl shadow-sm hover:bg-[#e6fcf7] cursor-pointer transition ${isBlocked ? 'opacity-50' : ''}"
       data-chat-id="${c._id}">

    <!-- Ø¢ÙˆØ§ØªØ§Ø± -->
    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#0ea5e9] to-[#10b981]
                flex items-center justify-center text-white font-bold text-lg shrink-0">
      ${avatarText}
    </div>

    <!-- Ø¨Ø¯Ù†Ù‡ -->
    <div class="flex-1 min-w-0">

      <!-- â¶ Ù‡ÙØ¯ÙØ± Ú©Ø§Ø±Øª: Ø§Ø³Ù… + Ù†Ø´Ø§Ù† unread Ø³Ù…Øª Ø±Ø§Ø³ØªØŒ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ø³Ù…Øª Ú†Ù¾  -->
      <div class="flex items-center justify-between flex-wrap gap-2">

        <!-- Ú¯Ø±ÙˆÙ‡Ù Ø§Ø³Ù… Ùˆ Ù†Ø´Ø§Ù† -->
        <div class="flex items-center gap-2">
          <span class="font-bold primary-text">${whomDisplay}</span>
          ${
            unread
              ? `<span class="inline-flex items-center justify-center
                         bg-red-500 text-white rounded-full w-5 h-5 text-xs">
                     ${unread}
                 </span>`
              : ""
          }
        </div>

        <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
        <div class="flex items-center gap-1">
          <button
            class="delete-chat px-2 py-0.5 text-xs rounded-xl bg-red-50 text-red-600 border border-red-100
                   hover:bg-red-200 hover:text-red-900 transition"
            data-chat-id="${c._id}">
            Ø­Ø°Ù
          </button>
          ${role === 'seller' && !isBlocked ? `<button class="block-seller px-2 py-0.5 text-xs rounded-xl bg-gray-100 text-gray-600 border border-gray-200 hover:bg-gray-200 transition" data-seller-id="${sellerId}">Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</button>` : ''}
          ${role === 'seller' && isBlocked ? `<span class="text-xs text-red-500">Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡</span>` : ''}
        </div>
      </div>

      ${prodBlock}
      <div class="text-sm text-gray-700 mt-2">${txt}</div>
      <div class="text-xs text-gray-400 mt-1">${date}</div>
    </div>
  </div>
`;

  }).join('');

  // Add event listeners for chat cards and buttons
  setTimeout(() => {
    // Chat card click listeners
    document.querySelectorAll('.chat-card').forEach(card => {
      card.addEventListener('click', (e) => {
        // Don't open chat if clicking on buttons
        if (e.target.closest('.delete-chat') || e.target.closest('.block-seller')) {
          return;
        }
        const chatId = card.dataset.chatId;
        openChat(chatId);
      });
    });

    // Delete chat button listeners
    document.querySelectorAll('.delete-chat').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const chatId = btn.dataset.chatId;
        deleteChat(chatId);
      });
    });

    // Block seller button listeners
    document.querySelectorAll('.block-seller').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const sellerId = btn.dataset.sellerId;
        blockSeller(sellerId);
      });
    });
  }, 0);
}




  /* Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
  /* Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ú†Øª (Ø¨Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„) */
async function openChat(cid) {
  currentCid = cid;
  await showChatModal();
}

  /* Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù…Ø¯ÛŒØ± (Ø§ÛŒØ¬Ø§Ø¯ Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§ Ù†Ø¯Ø§Ø±Ù‡) */
  // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ú¯ÙØªÚ¯ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…Ø¯ÛŒØ± (Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡)
async function openAdminMsgModal() {
  const uid = window.currentUserId;
  if (!uid) return alert('Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!');

  // Ø§ÙˆÙ„ Ú†Øª Ø¨Ø§ admin Ø±Ùˆ ensure Ú©Ù† (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Ø¨Ø³Ø§Ø²)
  try {
    const res = await fetch(`${API_BASE}/chats/ensure`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recipientRole: 'admin' })  // Ø¨Ø¯ÙˆÙ† recipientIdØŒ Ú†ÙˆÙ† admin Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    });
    if (!res.ok) throw new Error('Ø¯Ø±ÛŒØ§ÙØª/Ø§ÛŒØ¬Ø§Ø¯ Ú†Øª Ø¨Ø§ Ù…Ø¯ÛŒØ± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
    const chat = await res.json();
    currentCid = chat._id;  // chatId Ø±Ùˆ Ø³Øª Ú©Ù†
    showChatModal();        // Ù…ÙˆØ¯Ø§Ù„ Ø±Ùˆ Ø¨Ø§Ø² Ú©Ù† (Ú©Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ùˆ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù‡)
  } catch (err) {
    alert('Ø®Ø·Ø§: ' + err.message);
  }
}

  function closeAdminMsg() {
    document.getElementById('adminMsgModal')?.remove();
  }

  async function showAdminMsgModal(uid) {
    document.getElementById('adminMsgModal')?.remove();
    document.body.insertAdjacentHTML('beforeend', `
      <div id="adminMsgModal" class="fixed inset-0 z-50 flex items-center justify-center" style="backdrop-filter:blur(4px);background:#0003;animation:fadein .25s">
        <div class="bg-white rounded-2xl w-[98vw] max-w-md max-h-[93vh] flex flex-col shadow-xl border">
          <div class="px-4 py-3 border-b flex justify-between items-center">
            <span class="font-bold primary-text">Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª</span>
            <button class="close-admin-msg text-2xl font-black text-gray-400 hover:text-red-500 rounded-full w-8 h-8 flex items-center justify-center">Ã—</button>
          </div>
          <div id="adminMsgBody" class="flex-1 overflow-y-auto p-4 space-y-4 text-[15px] scrollbar-hide bg-[#f9fafb]"></div>
          <div class="border-t p-3 flex gap-2 bg-white">
            <textarea id="adminMsgInput" rows="2" class="flex-1 border rounded-xl p-2 resize-none focus:outline-none" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"></textarea>
            <button class="send-admin-msg brand-btn px-5 py-2 rounded-xl font-bold shrink-0">Ø§Ø±Ø³Ø§Ù„</button>
          </div>
        </div>
      </div>
    `);

    // Add event listeners for admin modal buttons
    const closeBtn = document.querySelector('.close-admin-msg');
    if (closeBtn) {
      closeBtn.addEventListener('click', closeAdminMsg);
    }

    const sendBtn = document.querySelector('.send-admin-msg');
    if (sendBtn) {
      sendBtn.addEventListener('click', sendAdminMsg);
    }

    // Also allow sending message with Enter key
    const msgInput = document.getElementById('adminMsgInput');
    if (msgInput) {
      msgInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendAdminMsg();
        }
      });
    }

    renderAdminMsgs(uid);
  }

  async function renderAdminMsgs(uid) {
    const box = document.getElementById('adminMsgBody');
    if (!box) return;
    box.innerHTML = '<div class="text-center text-gray-400 py-6">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div>';
    try {
      const token = document.cookie.split('; ').find(r => r.startsWith('user_token='))?.split('=')[1];
      const res = await fetch(`${API_BASE}/messages/${uid}`, {
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { Authorization: 'Bearer ' + token })
        }
      });
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) throw new Error('Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²');
        throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙØªÚ¯Ùˆ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
      }
      let data = await res.json();
      if (!Array.isArray(data)) data = [];
      data.sort((a,b)=> new Date(a.timestamp || a.createdAt) - new Date(b.timestamp || b.createdAt));
      box.innerHTML = data.map(m => {
        const rawRole =
          m.senderRole ||
          m.senderId?.role ||
          (typeof m.senderModel === 'string' ? m.senderModel.toLowerCase() : '') ||
          (typeof m.from === 'string' ? m.from.toLowerCase() : '');
        const role = (rawRole || '').toLowerCase();
        const isMe = m.senderId?._id === window.currentUserId || role === 'user';
        const label = isMe ? 'Ø´Ù…Ø§' : role === 'admin' ? 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª' : role === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : 'Ù…Ø´ØªØ±ÛŒ';
        const cls = isMe ? 'bg-[#e0fdfa] self-end' : 'bg-[#f3f4f6]';
        const time = new Date(m.timestamp || m.createdAt).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
        const align = isMe ? 'items-end' : 'items-start';
        const msgText = m.message || m.text || '';
        return `
          <div class="flex flex-col ${align}">
            <div class="${cls} rounded-xl px-3 py-2 max-w-[78%]">
              <span class="text-xs font-bold text-[#10b981]">${label}</span>
              <div>${msgText}</div>
              <div class="text-xs text-gray-400 mt-1 text-left">${time}</div>
            </div>
          </div>`;
      }).join('');
      box.scrollTop = box.scrollHeight;
    } catch (err) {
      box.innerHTML = '<div class="text-center text-red-500 py-6">Ø§Ù…Ú©Ø§Ù† Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙØªÚ¯Ùˆ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>';
    }
  }

  async function sendAdminMsg() {
    const ta = document.getElementById('adminMsgInput');
    const text = ta.value.trim();
    if (!text) return;
    try {
      const token = document.cookie.split('; ').find(r => r.startsWith('user_token='))?.split('=')[1];
      const res = await fetch(`${API_BASE}/messages/send`, {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { Authorization: 'Bearer ' + token })
        },
        body: JSON.stringify({ message: text })
      });
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) throw new Error('Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²');
        throw new Error('Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
      }
      ta.value = '';
      renderAdminMsgs(window.currentUserId);
    } catch (err) {
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: ' + err.message);
    }
  }





  /* Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ ÛŒÚ© Ú†Øª (Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */











  /* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª */
async function ensureShopUrl(sid, existing) {
  if (existing) return existing;
  if (!sid) return '';
  try {
    const res = await fetch(`${API_BASE}/shopAppearance/${sid}`);
    if (!res.ok) return '';
    const data = await res.json();
    return data.customUrl || '';
  } catch {
    return '';
  }
}

/* Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ú†Øª (async Ø¨Ø±Ø§ÛŒ fetch Ø¬Ø²Ø¦ÛŒØ§Øª) */
async function showChatModal() {
  console.log("Ø¯Ø± Ø­Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ú†Øª...");

  // Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ Ú†Øª Ø§Ø² Ø³Ø±ÙˆØ±
  const chat = await fetchChatDetails(currentCid);
  if (!chat) {
    alert('Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙØªÚ¯Ùˆ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
    return;
  }

  // Ù¾Ø³ Ø§Ø² Ø¯Ø±ÛŒØ§ÙØªØŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ø±Ø§ Ø®ÙˆØ§Ù†Ø¯Ù‡â€ŒØ´Ø¯Ù‡ Ø¹Ù„Ø§Ù…Øª Ø¨Ø²Ù†
  chat.messages.forEach(m => {
    if (m.from !== 'user') m.read = true;
  });

  console.log('messages:', chat.messages); // Ø¯ÛŒØ¨Ø§Ú¯

  // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ù…Ø­Ù„ÛŒ
  const idx = chatsList.findIndex(c => c._id === currentCid);
  if (idx !== -1) chatsList[idx] = chat;
  updateBadge();

  console.log('Ø³Ø§Ø®ØªØ§Ø± Ú†Øª Ú©Ø§Ù…Ù„:', chat);

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„
  let whom = 'Ù…Ø®Ø§Ø·Ø¨';
  let role = '';
  let sellerId = null;
  let storeName = '';
  let shopUrl = '';

  if (Array.isArray(chat.participants)) {
    const participant = chat.participants.find(p => p && p._id !== window.currentUserId);
    if (participant) {
      role = participant.role;
      sellerId = participant._id;
      storeName = participant.storename || '';
      shopUrl = participant.shopurl || '';
      whom = role === 'seller' ? 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡' : (role === 'admin' ? 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª' : (role === 'user' ? 'Ù…Ø´ØªØ±ÛŒ' : 'Ù…Ø®Ø§Ø·Ø¨'));
    }
  }

  if (!role && Array.isArray(chat.participantsModel)) {
    if (chat.participantsModel.includes('Admin')) {
      role = 'admin';
      whom = 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
    } else if (chat.participantsModel.includes('Seller')) {
      role = 'seller';
      whom = 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
    }
  }

  // fallback Ø§Ø² type
  if (!role && chat.type) {
    if (chat.type === 'user-seller' || chat.type === 'seller-admin') {
      whom = 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
      role = 'seller';
      sellerId = chat.sellerId;
    } else if (chat.type === 'user-admin' || chat.type === 'admin-user' || chat.type === 'admin') {
      whom = 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
      role = 'admin';
    }
  }

  let whomDisplay = whom;
  let sellerLink = '';
  if (role === 'seller' && sellerId) {
    shopUrl = await ensureShopUrl(sellerId, shopUrl);
    const linkUrl = shopUrl ? `/shop.html?shopurl=${shopUrl}` : '';
    const linkText = storeName ? `Ù…ØºØ§Ø²Ù‡ ${storeName}` : `Ù…ØºØ§Ø²Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡`;
    sellerLink = linkUrl
      ? `<a href="${linkUrl}" target="_blank" rel="noopener noreferrer" class="text-[#0ea5e9] hover:text-blue-700 hover:underline ml-3 text-sm font-semibold">${linkText}</a>`
      : '';
  }

  let prodBlock = '';
  if (chat.productId && chat.productId.title) {
    const productUrl = `/product.html?id=${chat.productId._id}`;
    prodBlock = `
      <a href="${productUrl}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 bg-[#e0fdfa] px-2 py-1 rounded-lg my-2 hover:bg-[#d1f8f5] transition">
        <img src="${chat.productId.images?.[0] || '/assets/images/noimage.png'}" class="w-9 h-9 object-cover rounded-md border" alt="">
        <span class="text-xs text-gray-700">${chat.productId.title}</span>
      </a>
    `;
  }

  // Ù…ÙˆØ¯Ø§Ù„ HTML
  document.body.insertAdjacentHTML('beforeend', `
    <div id="chatModal" class="fixed inset-0 z-50 flex items-center justify-center" style="backdrop-filter:blur(4px);background:#0003;animation:fadein .25s">
      <div class="bg-white rounded-2xl w-[98vw] max-w-md max-h-[93vh] flex flex-col shadow-xl border">
        <div class="px-4 py-3 border-b flex justify-between items-center gap-3">
          <div>
            <div class="flex items-center">
              <span class="font-bold primary-text">${whomDisplay}</span>
              ${sellerLink}
            </div>
            ${prodBlock}
          </div>
          <button class="close-chat-modal text-2xl font-black text-gray-400 hover:text-red-500 rounded-full w-8 h-8 flex items-center justify-center">Ã—</button>
        </div>
        <div id="chatBody" class="flex-1 overflow-y-auto p-4 space-y-4 text-[15px] scrollbar-hide bg-[#f9fafb]"></div>
        <div class="border-t p-3 flex gap-2 bg-white">
          <textarea id="msgBox" rows="2" class="flex-1 border rounded-xl p-2 resize-none focus:outline-none" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"></textarea>
          <button class="send-msg brand-btn px-5 py-2 rounded-xl font-bold shrink-0">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
      </div>
    </div>
  `);

  // Add event listeners for chat modal buttons
  const closeBtn = document.querySelector('.close-chat-modal');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeChat);
  }

  const sendBtn = document.querySelector('.send-msg');
  if (sendBtn) {
    sendBtn.addEventListener('click', sendMsg);
  }

  // Also allow sending message with Enter key
  const msgBox = document.getElementById('msgBox');
  if (msgBox) {
    msgBox.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMsg();
      }
    });
  }

  renderChat();
  setTimeout(() => document.getElementById('msgBox').focus(), 120);
}
  // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ú†Øª
  function closeChat() {
    document.getElementById('chatModal')?.remove();
    currentCid = null;
  }

  async function fetchBlockedSellers() {
    try {
      const res = await fetch(`${API_BASE}/blocked-sellers`, { credentials: 'include' });
      const data = await res.json();
      blockedSellers = Array.isArray(data) ? data : [];
    } catch (e) {
      blockedSellers = [];
    }
  }

  async function blockSeller(sid) {
    if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø±Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ù†ÛŒØ¯ØŸ')) return;
    try {
      const res = await fetch(`${API_BASE}/blocked-sellers/${sid}`, {
        method: 'POST',
        credentials: 'include'
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ');
      if (!blockedSellers.includes(sid)) blockedSellers.push(sid);
      renderMessagesList();
    } catch (err) {
      alert('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø³Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ: ' + err.message);
    }
  }

  /* Ø±Ù†Ø¯Ø± Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ */
/* Ø±Ù†Ø¯Ø± Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ */
function renderChat() {
  const chat = chatsList.find(c => c._id === currentCid);
  const target = document.getElementById('chatBody');
  if (!target) return;

  function getSenderRoleText(msg, isMe) {
    if (isMe) return 'Ø´Ù…Ø§';
    const raw =
      msg.senderRole ||
      msg?.sender?.role ||
      msg?.senderId?.role ||
      (typeof msg.senderModel === 'string' ? msg.senderModel.toLowerCase() : '') ||
      (typeof msg.from === 'string' ? msg.from.toLowerCase() : '');
    const role = (raw || '').toLowerCase();
    if (role === 'admin')  return 'Ù…Ø¯ÛŒØ± Ø³Ø§ÛŒØª';
    if (role === 'seller') return 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡';
    if (role === 'user')   return 'Ù…Ø´ØªØ±ÛŒ';
    return 'Ù…Ø®Ø§Ø·Ø¨';
  }

  target.innerHTML = (chat.messages || []).map(m => {
    const roleHint = (m.senderRole || m?.senderId?.role || '').toLowerCase();
    const isMe =
      m.senderId?._id === window.currentUserId ||
      m.senderId === window.currentUserId ||
      roleHint === 'user' ||
      m.from === 'user' ||
      m.from === window.currentUserId;
    const cls = isMe ? 'bg-[#e0fdfa] self-end' : 'bg-[#f3f4f6]';
    const name = `<span class="text-xs font-bold text-[#10b981]">${getSenderRoleText(m, isMe)}</span>`;
    return `
      <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
        <div class="${cls} rounded-xl px-3 py-2 max-w-[78%]">
          ${name}
          <div>${m.text || ''}</div>
          <div class="text-xs text-gray-400 mt-1 text-left">${new Date(m.date || m.createdAt).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
      </div>
    `;
  }).join('');
  target.scrollTop = target.scrollHeight;
}



  /* Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… */
/**
 * Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø² Ø·Ø±Ù Ú©Ø§Ø±Ø¨Ø±
 */
async function sendMsg() {
  const ta   = document.getElementById('msgBox');
  const text = ta.value.trim();
  if (!text) {
    alert('Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }

  // ØªÙˆÚ©Ù†Ù Ú©Ø§Ø±Ø¨Ø± (Ù…Ø´ØªØ±ÛŒ) Ø±Ø§ Ø§Ø² Ú©ÙˆÚ©ÛŒ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
  const token = document.cookie
    .split('; ')
    .find(row => row.startsWith('user_token='))
    ?.split('=')[1];

  try {
    // Ø¨Ù‡ Ù…Ø³ÛŒØ± Ù…Ø®ØµÙˆØµ reply Ú©Ø§Ø±Ø¨Ø± Ø¨ÙØ±Ø³ØªÛŒÙ…
    const res = await fetch(`${API_BASE}/chats/${currentCid}/user-reply`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        ...(token && { Authorization: 'Bearer ' + token })
      },
      body: JSON.stringify({ text })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…');

    // Ù¾Ø³ Ø§Ø² Ù…ÙˆÙÙ‚ÛŒØªØŒ textarea Ø±Ø§ Ù¾Ø§Ú© Ùˆ Ù„ÛŒØ³Øª Ú†Øª Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    ta.value = '';
    chatsList = chatsList.map(c => c._id === currentCid ? data : c);
    renderChat();
    updateBadge();

  } catch (err) {
    console.error('âŒ sendMsg error:', err);
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…:\n' + err.message);
  }
}





async function deleteChat(cid) {
  if(!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú†Øª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

  try {
    const res = await fetch(`${API_BASE}/chats/${cid}`, {
      method: 'DELETE',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'Ø­Ø°Ù Ú†Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
    // Ø­Ø°Ù Ú†Øª Ø§Ø² Ù„ÛŒØ³Øª Ùˆ Ø±ÙØ±Ø´
    chatsList = chatsList.filter(c => c._id !== cid);
    renderMessagesList();
    updateBadge();
    closeChat();
  } catch (err) {
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú†Øª: ' + err.message);
  }
}




  /* badge Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡ */
function updateBadge() {
  const total = chatsList.reduce(
      (n, c) => n + (c.messages || []).filter(m => !m.read && m.from !== 'user').length,
      0);

  /* ğŸ”¸ Ù†Ø´Ø§Ù† Ú©Ù†Ø§Ø± Ú¯Ø²ÛŒÙ†Ù‡Ù” Â«Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§Â» Ø¯Ø± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± (Ù‡Ù…Ø§Ù† Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ) */
  document.getElementById('msgBadge').textContent = total > 0 ? total : '';

  /* ğŸ”¸ Ù†Ø´Ø§Ù† Ø±ÙˆÛŒ Ù‡Ù…Ø¨Ø±Ú¯Ø± â€“ Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯Ù‡ */
  const hamBadge = document.getElementById('hamBadge');
  if (hamBadge) {
    if (total > 0) {
      hamBadge.textContent = total;
      hamBadge.classList.remove('hidden');   // Ù†Ù…Ø§ÛŒØ´
    } else {
      hamBadge.classList.add('hidden');      // Ù¾Ù†Ù‡Ø§Ù†â€ŒØ³Ø§Ø²ÛŒ
    }
  }
}


  /* Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù„ÛŒØ³Øª Ùˆ Ú†Øª */
/* Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù„ÛŒØ³Øª Ùˆ Ú†Øª */
function startMsgPolling(){
  if(pollHandle) clearInterval(pollHandle);
  pollHandle = setInterval(async()=>{
    await fetchUserChats();
    updateBadge();
    if(currentCid) {
      // Ø§Ú¯Ø± Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ú†Øª Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ fetch Ùˆ Ø±Ù†Ø¯Ø± Ú©Ù†
      const chat = await fetchChatDetails(currentCid);
      if (chat) {
        const idx = chatsList.findIndex(c => c._id === currentCid);
        if (idx !== -1) chatsList[idx] = chat;
        renderChat();
      }
    } else {
      renderMessagesList();
    }
  },10000);
}
  function stopMsgPolling(){ if(pollHandle){clearInterval(pollHandle);pollHandle=null;} }
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ù¾Ø§ÛŒØ§Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */








/* Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ ÛŒÚ© Ú†Øª (Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */
/* Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ ÛŒÚ© Ú†Øª (Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§) */
async function fetchChatDetails(cid) {
  const token = document.cookie.split('; ').find(row => row.startsWith('user_token='))?.split('=')[1];
  try {
    const res = await fetch(`${API_BASE}/chats/${cid}`, {
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        ...(token && { Authorization: 'Bearer ' + token })
      }
    });
    if (!res.ok) throw new Error('Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ú†Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
    const data = await res.json();
    return data;  // Ú†Øª Ú©Ø§Ù…Ù„ Ø¨Ø§ messages
  } catch (e) {
    console.error('âŒ fetchChatDetails error:', e);
    return null;
  }
}

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      showSection('dashboard');
      updateSidebarUser();
      await loadMessages();
      await loadBookings();
    } catch (error) {
      console.error('Initialization error:', error);
    }
  });









  // --- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯: Ú©Ù„ÛŒÚ© Ø¨Ø§Ú©Ø³ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ùˆ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± --- 




    </script>
  
<!-- TODO: Ø§ÙØ²ÙˆØ¯Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ PostHog Ù¾Ø³ Ø§Ø² ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ | TODO: Enable PostHog events after activation -->
<!--
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const safeCapture = window.safePosthogCapture || function () {};
    // ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø±ÛŒ | User dashboard accessed
    // safeCapture('user_dashboard_accessed', { section: 'modern-dashboard' });
  });
</script>
-->

</body>
  </html>
