<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ | ÙˆÛŒØªØ±ÛŒÙ†Øª</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style-index.css" />
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;600;700;900&family=Poppins:wght@800;900&display=swap" rel="stylesheet"/>

  <style>
    /* --- Base Settings --- */
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(115deg, #e0fdfa 0%, #f8fafc 60%, #d4fbe8 100%);
      color: #064e3b;
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* Smooth Scrolling */
    html { scroll-behavior: smooth; }

    /* --- Header --- */
    #mainHeader {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(16, 185, 129, 0.1);
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.05);
    }
    .nav-link {
      font-weight: 700; color: #334155; transition: color 0.2s; position: relative;
    }
    .nav-link:hover { color: #10b981; }

    /* --- Hero Glass Panel --- */
    .category-hero {
      background: #ffffff;
      border-radius: 2rem;
      border: 1px solid #ffffff;
      box-shadow: 0 20px 40px -10px rgba(6, 78, 59, 0.06);
    }

    .category-pill {
      background: linear-gradient(90deg, #d1fae5 0%, #a7f3d0 100%);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #059669;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
    }

    /* --- Inputs --- */
    .vitrine-input {
      width: 100%;
      padding: 0.9rem 1.2rem;
      border-radius: 1rem;
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      color: #334155;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .vitrine-input:focus {
      background: #fff;
      border-color: #10b981;
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
      outline: none;
    }

    /* --- Category Chips --- */
    .category-chip {
      padding: 0.6rem 1.2rem;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 700;
      background: #fff;
      border: 1px solid #e2e8f0;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }
    .category-chip:hover {
      border-color: #10b981; color: #10b981; transform: translateY(-2px);
    }
    .category-chip.active {
      background: linear-gradient(90deg, #10b981 10%, #0ea5e9 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 8px 20px -4px rgba(16, 185, 129, 0.4);
    }

    /* --- CARD STYLES (FIXED) --- */
    .shop-card {
      background: #ffffff;
      border-radius: 1.5rem;
      overflow: hidden;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
      height: 100%;
      display: flex; flex-direction: column;
    }
    
    .shop-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 30px -10px rgba(16, 185, 129, 0.15);
      border-color: #10b981;
    }

    .card-image-box {
      width: 100%;
      aspect-ratio: 4 / 3;
      background: #f1f5f9;
      position: relative;
      overflow: hidden;
    }
    
    .card-image-box img {
      width: 100%; height: 100%; object-fit: cover;
      transition: transform 0.5s ease;
    }
    .shop-card:hover .card-image-box img { transform: scale(1.1); }

    .card-badge {
      position: absolute; top: 12px; right: 12px;
      background: linear-gradient(90deg, #d1fae5 0%, #a7f3d0 100%);
      color: #059669;
      font-size: 0.75rem; font-weight: 800;
      padding: 6px 12px;
      border-radius: 99px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.15);
      z-index: 10;
    }

    .card-body { padding: 1.25rem; flex: 1; display: flex; flex-direction: column; }

    .card-btn {
      margin-top: auto;
      width: 100%;
      padding: 0.8rem;
      border-radius: 1rem;
      font-weight: 800;
      font-size: 0.95rem;
      text-align: center;
      background: linear-gradient(90deg, #10b981 10%, #0ea5e9 100%);
      color: white;
      transition: all 0.2s;
      display: block;
      box-shadow: 0 2px 12px rgba(16, 185, 129, 0.2);
    }
    .shop-card:hover .card-btn {
      background: linear-gradient(90deg, #0ea5e9 10%, #10b981 100%);
      box-shadow: 0 8px 15px -3px rgba(16, 185, 129, 0.3);
      filter: brightness(1.05);
    }

    /* --- Portfolio --- */
    .portfolio-item {
      border-radius: 1.2rem; overflow: hidden; aspect-ratio: 1;
      position: relative; cursor: pointer;
      box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05);
    }
    .portfolio-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
    .portfolio-item:hover img { transform: scale(1.1); }
    .portfolio-overlay {
      position: absolute; inset: 0;
      background: linear-gradient(to top, rgba(6, 78, 59, 0.8), transparent);
      display: flex; align-items: flex-end; padding: 1rem;
      opacity: 0; transition: 0.3s;
    }
    .portfolio-item:hover .portfolio-overlay { opacity: 1; }

    /* Loader */
    .loader {
      border: 3px solid #e2e8f0;
      border-top: 3px solid #10b981;
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="text-gray-800">

<header id="mainHeader" class="w-full bg-white/95 shadow-md backdrop-blur-md sticky top-0 z-50">
  <div id="headerInner" class="max-w-7xl mx-auto flex flex-row items-center justify-between px-4 sm:px-6 py-3 md:py-3.5 gap-3">

    <!-- Ù„ÙˆÚ¯Ùˆ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø± -->
    <div id="logoCityWrap" class="flex items-center gap-2 md:gap-3 flex-shrink-0">
      <!-- Ù„ÙˆÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯ ÙˆÛŒØªØ±ÛŒÙ†Øª -->
      <a href="index.html" class="vitreenet-brand header-item" aria-label="ÙˆÛŒØªØ±ÛŒÙ†Øª">
        <span class="vitreenet-brand__mark" aria-hidden="true">
          <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" role="presentation">
            <defs>
              <linearGradient id="vtMarkGradient" x1="0%" y1="100%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#0ea5e9" />
                <stop offset="55%" stop-color="#10b981" />
                <stop offset="100%" stop-color="#0fb67f" />
              </linearGradient>
              <linearGradient id="vtMarkInner" x1="15%" y1="85%" x2="85%" y2="15%">
                <stop offset="0%" stop-color="#ffffff" stop-opacity="0.9" />
                <stop offset="100%" stop-color="#dcfce7" stop-opacity="0.25" />
              </linearGradient>
            </defs>
            <circle cx="24" cy="24" r="22" fill="url(#vtMarkGradient)" />
            <circle cx="24" cy="24" r="18" fill="url(#vtMarkInner)" />
            <path d="M15.5 16h4.7l4.3 10.6L28.8 16h4.7L26 33h-4.2L15.5 16Z" fill="#0f172a" fill-opacity="0.9" />
            <path d="M18.2 17.6 24 31.1l5.8-13.5" fill="none" stroke="#22c55e" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </span>
        <span class="vitreenet-brand__text">
          <span class="vitreenet-brand__title">Vitreenet</span>
          <span class="vitreenet-brand__subtitle">ÙˆÛŒØªØ±ÛŒÙ†Øª</span>
        </span>
      </a>

      <!-- Ø¨Ø¬ Ø´Ù‡Ø± - ÙÙ‚Ø· Ø¯Ø± Ø¯Ø³Ú©ØªØ§Ù¾ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯ -->
      <div class="hidden md:flex items-center gap-1 px-3 py-1.5 rounded-full shadow-lg header-item"
           style="background:linear-gradient(90deg,#10b981E6 70%,#0ea5e9E6); border: 1.5px solid #fff6; backdrop-filter: blur(5px);">
        <svg width="18" height="18" fill="none" viewBox="0 0 22 22" class="ml-1 drop-shadow" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="city-icon" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#ffffff" stop-opacity="1" />
              <stop offset="100%" stop-color="#e0f2fe" stop-opacity="0.9" />
            </linearGradient>
          </defs>
          <path d="M11 2.5C7.13 2.5 4 5.61 4 9.45c0 3.52 4.1 7.93 6.2 10.01.46.47 1.2.47 1.66 0 2.1-2.08 6.14-6.49 6.14-10.01C18 5.61 14.87 2.5 11 2.5Zm0 10.25a2.75 2.75 0 1 1 0-5.5 2.75 2.75 0 0 1 0 5.5Z"
            fill="url(#city-icon)"/>
        </svg>
        <span id="headerCity" class="font-bold text-white text-[14px] drop-shadow-sm" style="letter-spacing:.3px;">Ø³Ù†Ù†Ø¯Ø¬</span>
      </div>
    </div>

    <!-- Ù…Ù†Ùˆ - ÙÙ‚Ø· Ø¯Ø± Ø¯Ø³Ú©ØªØ§Ù¾ -->
    <nav id="desktopNav" class="hidden md:flex items-center gap-1 text-base flex-1 justify-end">
      <a href="index.html" class="main-nav-link text-gray-700 hover:text-[#10b981] font-bold px-4 py-2 rounded-lg transition-all hover:bg-emerald-50">
        Ø®Ø§Ù†Ù‡
      </a>
      <a href="categories.html" class="main-nav-link text-gray-700 hover:text-[#0ea5e9] font-bold px-4 py-2 rounded-lg transition-all hover:bg-sky-50">
        Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
      </a>
      <a href="login.html" id="loginNavLink" class="main-nav-link text-gray-700 hover:text-[#0ea5e9] font-bold px-4 py-2 rounded-lg transition-all hover:bg-sky-50">
        <span class="login-link-label">ÙˆØ±ÙˆØ¯</span>
      </a>
    </nav>

    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ú©Ø´Ù† Ù‡Ø¯Ø± -->
    <div class="flex items-center gap-2 header-item">
      <a href="post.html" id="registerShopBtn" class="btn-grad px-4 py-2 md:px-5 md:py-2.5 rounded-full font-extrabold shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-200 whitespace-nowrap text-white text-sm md:text-base header-item">
        Ø«Ø¨Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡
      </a>
    </div>
  </div>
</header>

  <main class="px-4 sm:px-6 lg:px-8 pt-12 pb-16">
    <section class="max-w-7xl mx-auto flex flex-col gap-10">
      
      <div class="category-hero w-full mx-auto px-6 sm:px-10 py-8 sm:py-12">
        <div class="flex flex-col lg:flex-row items-center lg:items-start justify-between gap-6">
          
          <div class="text-center lg:text-right max-w-2xl">
            <span class="category-pill inline-flex items-center gap-2 px-4 py-1 rounded-full text-xs font-black uppercase tracking-wider">
              <span id="categoryPill">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</span>
            </span>
            <h1 id="categoryTitle" class="text-3xl md:text-4xl font-black mt-4 mb-3 leading-tight text-slate-800">ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§</h1>
            <p id="categorySubtitle" class="text-emerald-600 text-base md:text-lg font-bold">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</p>
          </div>
          
          <div class="flex flex-col items-center lg:items-end gap-2">
             <div class="px-6 py-3 rounded-2xl flex items-center gap-3" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(14, 165, 233, 0.12)); border: 1px solid rgba(16, 185, 129, 0.2); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);">
                <div class="text-3xl font-black bg-gradient-to-l from-[#10b981] to-[#0ea5e9] bg-clip-text text-transparent" id="resultsMeta">0</div>
                <div class="text-sm font-bold text-emerald-800">ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ÙØ¹Ø§Ù„</div>
             </div>
          </div>

        </div>

        <div class="mt-8 grid grid-cols-1 lg:grid-cols-12 gap-4">
          <div class="lg:col-span-8 relative w-full">
            <input type="text" id="searchInput" class="vitrine-input pl-12" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù†Ø§Ù… Ù…ØºØ§Ø²Ù‡ØŒ Ù…Ø­Ù„Ù‡ ÛŒØ§ Ø¢Ø¯Ø±Ø³..."/>
            <span class="absolute left-4 top-3.5 text-slate-400">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </span>
          </div>
          <div class="lg:col-span-4">
            <select id="sortSelect" class="vitrine-input cursor-pointer">
              <option value="popular">ğŸ”¥ Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ†</option>
              <option value="newest">ğŸ“… Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</option>
              <option value="rating_desc">â­ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²</option>
            </select>
          </div>
        </div>

        <!-- Professional Service Filters -->
        <div id="serviceFilters" class="mt-6 hidden">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">ğŸ’° Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù‚ÛŒÙ…Øª</label>
              <select id="priceRangeFilter" class="vitrine-input cursor-pointer">
                <option value="all">Ù‡Ù…Ù‡</option>
                <option value="budget">Ø§Ù‚ØªØµØ§Ø¯ÛŒ</option>
                <option value="mid">Ù…ØªÙˆØ³Ø·</option>
                <option value="premium">Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ…</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">â­ Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´ØªØ±ÛŒØ§Ù†</label>
              <select id="ratingFilter" class="vitrine-input cursor-pointer">
                <option value="all">Ù‡Ù…Ù‡</option>
                <option value="5">â­â­â­â­â­ Ø¹Ø§Ù„ÛŒ</option>
                <option value="4">â­â­â­â­ Ø®ÙˆØ¨</option>
                <option value="3">â­â­â­ Ù…ØªÙˆØ³Ø·</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">ğŸ”” ÙˆØ¶Ø¹ÛŒØª</label>
              <select id="availabilityFilter" class="vitrine-input cursor-pointer">
                <option value="all">Ù‡Ù…Ù‡</option>
                <option value="available">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø§Ø¦Ù‡ Ø®Ø¯Ù…Ø§Øª</option>
                <option value="busy">Ù¾Ø±Ù…Ø´ØºÙ„Ù‡</option>
              </select>
            </div>
          </div>
        </div>

        <div id="subcatContainer" class="mt-6 hidden flex-wrap gap-2 justify-center lg:justify-start">
          <button class="category-chip active" data-sub="all">Ù‡Ù…Ù‡</button>
          </div>
      </div>

      <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <div class="col-span-full flex flex-col items-center justify-center py-16 text-slate-400">
          <div class="loader mb-4"></div>
          <p class="font-bold text-lg text-slate-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§...</p>
        </div>
      </div>

      <div id="portfolioSection" class="hidden mt-12">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-2 h-8 rounded-full bg-emerald-500"></div>
          <h2 class="text-2xl font-black text-slate-800">Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¨Ø±ØªØ±</h2>
        </div>
        <div id="portfolioGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
      </div>

    </section>
  </main>

  <script>
    (function () {
      const categoryParam = new URLSearchParams(window.location.search).get('cat') || 'general';
      
      const state = {
        category: categoryParam,
        isServiceCategory: false,
        search: '',
        sort: 'popular',
        activeSubcategory: 'all',
        priceRange: 'all',
        rating: 'all',
        availability: 'all',
        shops: [],
      };

      document.addEventListener('DOMContentLoaded', async () => {
        hydrateHero();
        attachFilterEvents();
        await fetchRealShops();
      });

      function hydrateHero() {
        const title = document.getElementById('categoryTitle');
        if(state.category === 'general') {
             title.textContent = "ÙˆÛŒØªØ±ÛŒÙ† Ø§ÛŒÙ†ØªØ±Ù†ØªÛŒ Ø´Ù‡Ø±";
        } else {
             title.textContent = `ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ ${state.category.replace(/-/g, ' ')}`;
        }
      }

      async function fetchRealShops() {
        try {
          // --- API CONFIG ---
          let apiUrl = `/api/shops`; 
          if(state.category && state.category !== 'general') {
              apiUrl += `?category=${encodeURIComponent(state.category)}`;
          }

          const response = await fetch(apiUrl);
          if (!response.ok) throw new Error('Server Error');

          const data = await response.json();
          const shopList = Array.isArray(data) ? data : (data.shops || []);
          state.shops = shopList;

          // Detect Service Category
          const hasService = shopList.some(s => s.category && s.category.includes('Ø®Ø¯Ù…Ø§Øª'));
          if (hasService || state.category.includes('service') || state.category === 'Ø®Ø¯Ù…Ø§Øª') {
             state.isServiceCategory = true;
             setupServiceView(shopList);
          }

          document.getElementById('categorySubtitle').textContent = `Ù„ÛŒØ³Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø·Ø±Ø§Ù Ø´Ù…Ø§`;
          applyFiltersAndRender();

        } catch (error) {
          console.error(error);
          const grid = document.getElementById('results-grid');
          grid.innerHTML = `
            <div class="col-span-full text-center py-16 bg-white rounded-3xl shadow-sm border border-red-100">
               <p class="font-black text-xl text-slate-800 mb-2">Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡!</p>
               <p class="text-slate-500">Ù†ØªÙˆØ§Ù†Ø³ØªÛŒÙ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒÙ….</p>
            </div>
          `;
        }
      }

      function setupServiceView(allShops) {
         // Show professional service filters
         const serviceFilters = document.getElementById('serviceFilters');
         serviceFilters.classList.remove('hidden');

         const subcats = [...new Set(allShops.map(s => s.subcategory).filter(Boolean))];

         if (subcats.length > 0) {
             const container = document.getElementById('subcatContainer');
             container.classList.remove('hidden');
             container.classList.add('flex');

             subcats.forEach(sub => {
                 const btn = document.createElement('button');
                 btn.className = 'category-chip';
                 btn.textContent = sub;
                 btn.onclick = () => {
                     container.querySelectorAll('.category-chip').forEach(b => b.classList.remove('active'));
                     btn.classList.add('active');
                     state.activeSubcategory = sub;
                     applyFiltersAndRender();
                 };
                 container.appendChild(btn);
             });

             container.firstElementChild.onclick = () => {
                 container.querySelectorAll('.category-chip').forEach(b => b.classList.remove('active'));
                 container.firstElementChild.classList.add('active');
                 state.activeSubcategory = 'all';
                 applyFiltersAndRender();
             }
         }

         // Portfolio
         const portfolioSec = document.getElementById('portfolioSection');
         const portfolioGrid = document.getElementById('portfolioGrid');
         const sampleShops = allShops.slice(0, 5);

         if(sampleShops.length > 0) {
             portfolioSec.classList.remove('hidden');
             portfolioGrid.innerHTML = sampleShops.map(shop => `
                <div class="portfolio-item group">
                    <img src="${resolveShopImage(shop)}" alt="${shop.storename}" onerror="this.src='https://placehold.co/300?text=Portfolio'">
                    <div class="portfolio-overlay">
                        <div>
                           <h4 class="text-white font-bold text-sm">${shop.storename}</h4>
                           <span class="text-emerald-300 text-xs font-bold">Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±</span>
                        </div>
                    </div>
                </div>
             `).join('');
         }
      }

      function attachFilterEvents() {
        document.getElementById('searchInput').addEventListener('input', (e) => {
            state.search = e.target.value;
            applyFiltersAndRender();
        });
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            state.sort = e.target.value;
            applyFiltersAndRender();
        });

        // Service filters
        const priceFilter = document.getElementById('priceRangeFilter');
        const ratingFilter = document.getElementById('ratingFilter');
        const availabilityFilter = document.getElementById('availabilityFilter');

        if (priceFilter) {
            priceFilter.addEventListener('change', (e) => {
                state.priceRange = e.target.value;
                applyFiltersAndRender();
            });
        }

        if (ratingFilter) {
            ratingFilter.addEventListener('change', (e) => {
                state.rating = e.target.value;
                applyFiltersAndRender();
            });
        }

        if (availabilityFilter) {
            availabilityFilter.addEventListener('change', (e) => {
                state.availability = e.target.value;
                applyFiltersAndRender();
            });
        }
      }

      function applyFiltersAndRender() {
        let collection = [...state.shops];

        if (state.activeSubcategory !== 'all') {
            collection = collection.filter(s => s.subcategory === state.activeSubcategory);
        }

        if (state.search) {
          const term = state.search.toLowerCase();
          collection = collection.filter(shop => {
             return (shop.storename && shop.storename.toString().toLowerCase().includes(term)) ||
                    (shop.address && shop.address.toString().toLowerCase().includes(term));
          });
        }

        // Price range filter
        if (state.priceRange !== 'all') {
            collection = collection.filter(shop => {
                const priceTag = shop.priceRange || 'mid';
                return priceTag === state.priceRange;
            });
        }

        // Rating filter
        if (state.rating !== 'all') {
            const minRating = parseInt(state.rating);
            collection = collection.filter(shop => {
                const shopRating = shop.rating || 3;
                return shopRating >= minRating;
            });
        }

        // Availability filter
        if (state.availability !== 'all') {
            collection = collection.filter(shop => {
                const status = shop.availability || 'available';
                return status === state.availability;
            });
        }

        if (state.sort === 'newest') {
             collection.reverse();
        }

        document.getElementById('resultsMeta').textContent = collection.length;
        renderCards(collection);
      }

      function renderCards(shops) {
        const grid = document.getElementById('results-grid');
        
        if (shops.length === 0) {
          grid.innerHTML = `
            <div class="col-span-full text-center py-16">
               <p class="text-slate-500 font-bold">Ù‡ÛŒÚ† ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø´Ø®ØµØ§Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</p>
            </div>`;
          return;
        }
        
        grid.innerHTML = shops.map(shop => createCard(shop)).join('');
      }

      function createCard(shop) {
        const imageSrc = resolveShopImage(shop);
        const shopName = shop.storename || 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡';
        const address = shop.address || 'Ø¢Ø¯Ø±Ø³ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡';
        const badge = shop.subcategory || shop.category || 'Ø¹Ù…ÙˆÙ…ÛŒ';
        const profileLink = `shop.html?id=${shop.id}`;

        return `
          <article class="shop-card group">
            <div class="card-image-box">
              <img src="${imageSrc}" loading="lazy" alt="${shopName}" />
              <div class="card-badge">${badge}</div>
            </div>
            
            <div class="card-body">
              <div class="flex justify-between items-start mb-1">
                 <h3 class="font-black text-lg text-slate-800 group-hover:text-emerald-600 transition-colors line-clamp-1">${shopName}</h3>
              </div>
              
              <div class="flex items-center gap-1 mb-4">
                  <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                  <p class="text-xs font-bold text-slate-500 line-clamp-1">${address}</p>
              </div>

              <a href="${profileLink}" class="card-btn">
                Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
              </a>
            </div>
          </article>
        `;
      }

      function resolveShopImage(shop) {
        let candidate = shop.image;
        if (!candidate || candidate.trim() === "") {
           const text = encodeURIComponent(shop.storename || 'Shop');
           return `https://placehold.co/600x400/f1f5f9/10b981?text=${text}`;
        }
        if (/^(https?:\/\/|\/|data:image\/)/.test(candidate)) {
          return candidate;
        }
        return `/${candidate.replace(/^\/+/, '')}`;
      }
    })();
  </script>
</body>
</html>